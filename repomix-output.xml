This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
docs/
  ag1_transcriptor/
    flujo_completo_ejemplo.md
    insert_supabase.md
    output_analisispreliminar.json
    output_transcriptor.json
    paso3_transcripcion_whisper.md
    paso3b_transformacion_whisper_llm.md
    paso4_emociones_config.md
    paso5_6_prompt_llm.md
    prompt_gemini_transcripcion.md
    README.md
  ag2_analista/
    flujo_completo.md
    input_ejemplo.json
    insert_supabase.md
    output_ejemplo.json
    plan_implementacion.md
    prompt_modulos.md
    prompt_prediccion.md
    README.md
    reglas_alertas.md
  ag3_detector/
    config_umbrales.json
    flujo_completo.md
    input_ejemplo.json
    insert_supabase.md
    notificaciones.md
    output_ejemplo.json
    plan_implementacion.md
    README.md
    reglas_deteccion.md
  ag4_coach/
    flujo_completo.md
    input_ejemplo.json
    insert_supabase.md
    output_ejemplo.json
    plan_implementacion.md
    prompt_analisis_agente.md
    README.md
    templates_mensajes.md
  ag6_conversacional/
    flujo_saturn.md
    payload_estructura.md
    plan_implementacion.md
    prompt_completo.md
    README.md
    tool_config_saturn.md
  arquitectura-agentes.md
  flujo-datos-e2e.md
  implementacion_modulos_dashboard.md
public/
  favicon.svg
src/
  components/
    charts/
      index.ts
      MiniBar.tsx
      ScoreGauge.tsx
      TrendChart.tsx
    dashboard/
      ActividadReciente.tsx
      AlertasActivas.tsx
      index.ts
      KPICard.tsx
      TopPerformers.tsx
    layout/
      Header.tsx
      index.ts
      MainLayout.tsx
      Sidebar.tsx
    llamadas/
      AudioPlayer.tsx
      gestorLlamadas.tsx
      index.ts
      LlamadaCard.tsx
      ModuloScore.tsx
      PrediccionCard.tsx
      TranscripcionViewer.tsx
    modulos/
      CumplimientoBar.tsx
      DonutMetric.tsx
      ImpactoElementosChart.tsx
      index.ts
      ModuloHeader.tsx
      PilarCard.tsx
      ProbabilidadFlow.tsx
    ui/
      avatar.tsx
      badge.tsx
      button.tsx
      card.tsx
      index.ts
      input.tsx
      progress.tsx
      scroll-area.tsx
      separator.tsx
      skeleton.tsx
      tabs.tsx
      tooltip.tsx
  data/
    mockData.ts
  hooks/
    index.ts
    useDashboard.ts
    useModulos.ts
    useRealtime.ts
    useSupabase.ts
  lib/
    supabase.ts
    utils.ts
  pages/
    modulos/
      AbandonoLlamadas.tsx
      CompromisoPago.tsx
      ContactoDirecto.tsx
      index.ts
      ModulosOverview.tsx
    Agentes.tsx
    Alertas.tsx
    Chat.tsx
    Dashboard.tsx
    detalleLlamada.tsx
    index.ts
    Llamadas.tsx
  services/
    chatService.ts
    llamadasService.ts
  stores/
    chatStore.ts
    dashboardStore.ts
  types/
    database.ts
    index.ts
  App.tsx
  index.css
  main.tsx
  vite-env.d.ts
supabase/
  functions/
    coach_functions.sql
    detector_functions.sql
  migrations/
    001_ajuste_transcripciones.sql
    002_simplificar_registro_llamadas.sql
  seeds/
    seed_coach_test.sql
    seed_detector_test.sql
    seed_modulos_test.sql
  views/
    modulos_dashboard.sql
  functions.sql
  README.md
  schema.sql
  seeds.sql
.gitignore
components.json
index.html
package.json
postcss.config.js
README.md
tailwind.config.js
tsconfig.json
vite.config.ts
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="src/pages/detalleLlamada.tsx">
import React, { useEffect, useState } from 'react';
import { useParams, Link } from 'react-router-dom';
import { llamadasService, Llamada } from '../services/llamadasService';
import { Brain, Lock, CheckCircle, XCircle, Play, Pause, ChevronLeft } from 'lucide-react'; // Aseg√∫rate de tener lucide-react o usa iconos normales

export default function DetalleLlamada() {
  const { id } = useParams<{ id: string }>();
  const [llamada, setLlamada] = useState<Llamada | null>(null);
  const [loading, setLoading] = useState(true);
  
  // Estado fake para el reproductor de audio
  const [isPlaying, setIsPlaying] = useState(false);

  useEffect(() => {
    if (!id) return;
    // Aqu√≠ traemos la data real de supabase
    llamadasService.getById(id)
      .then(setLlamada)
      .catch(console.error)
      .finally(() => setLoading(false));
  }, [id]);

  if (loading) return <div className="p-20 text-center text-gray-500">Cargando la magia de Saturn... ü™ê</div>;
  if (!llamada) return <div className="p-20 text-center">No pillamos la llamada, hermano üòî</div>;

  // DATA HARDCODEADA PARA LA DEMO (Esto es lo que el agente "generar√≠a")
  // Si la llamada tiene data real en analisis_json, la usamos, si no, usamos este fallback bonito
  const coachingData = llamada.analisis_json?.hitos ? {
    tips: llamada.analisis_json.tips,
    score_empatia: 75,
    score_cierre: 40
  } : {
    // Fallback por si la IA no corri√≥
    tips: [
      "El cliente mostr√≥ inter√©s en el minuto 2:14, debiste insistir ah√≠.",
      "Evita usar la palabra 'quiz√°s', denota inseguridad.",
      "Muy buena despedida, gener√≥ confianza para una futura llamada."
    ],
    score_empatia: 88,
    score_cierre: 65
  };

  return (
    <div className="max-w-6xl mx-auto p-6 space-y-8 bg-gray-50 min-h-screen">
      
      {/* HEADER DE NAVEGACI√ìN */}
      <div className="flex items-center space-x-4">
        <Link to="/llamadas" className="p-2 bg-white rounded-full hover:bg-gray-100 border">
          <ChevronLeft size={20} />
        </Link>
        <div>
          <h1 className="text-2xl font-bold text-gray-800">An√°lisis de Llamada #3492</h1>
          <p className="text-gray-500 text-sm">Ejecutivo: {llamada.agente?.nombre || 'Fernando Chacana'} ‚Ä¢ {new Date(llamada.created_at).toLocaleDateString()}</p>
        </div>
        <div className="ml-auto">
          <span className="px-4 py-1 bg-green-100 text-green-700 rounded-full font-bold text-sm border border-green-200">
            {llamada.estado.toUpperCase()}
          </span>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        {/* COLUMNA IZQUIERDA: TRANSCRIPCI√ìN (Chat Style) */}
        <div className="lg:col-span-2 space-y-6">
          
          {/* Reproductor Fake (Solo visual) */}
          <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex items-center space-x-4">
            <button 
              onClick={() => setIsPlaying(!isPlaying)}
              className="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center text-white hover:bg-blue-700 transition"
            >
              {isPlaying ? <Pause size={20} /> : <Play size={20} fill="currentColor" />}
            </button>
            <div className="flex-1">
              <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                <div className="h-full bg-blue-500 w-1/3"></div>
              </div>
              <div className="flex justify-between text-xs text-gray-400 mt-1">
                <span>01:12</span>
                <span>04:35</span>
              </div>
            </div>
          </div>

          {/* Transcripci√≥n Real */}
          <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-[600px] overflow-y-auto">
            <h3 className="text-lg font-bold mb-4 text-gray-800">Transcripci√≥n</h3>
            <div className="space-y-4">
              {llamada.transcripcion_texto ? (
                // Si hay texto real, lo mostramos (puedes hacer split por saltos de linea si quieres)
                <p className="whitespace-pre-wrap text-gray-700 leading-relaxed">{llamada.transcripcion_texto}</p>
              ) : (
                // Fallback visual
                <div className="text-center text-gray-400 italic mt-20">
                  Esperando a que el agente Saturn termine de escribir... ‚úçÔ∏è
                </div>
              )}
            </div>
          </div>
        </div>

        {/* COLUMNA DERECHA: COACHING IA (La Venta) */}
        <div className="space-y-6">
          
          {/* TARJETA 1: COACHING GRATUITO (Demo) */}
          <div className="bg-gradient-to-br from-indigo-600 to-purple-700 text-white p-6 rounded-2xl shadow-lg relative overflow-hidden">
            <div className="absolute top-0 right-0 p-4 opacity-20">
              <Brain size={100} />
            </div>
            <h2 className="text-xl font-bold flex items-center gap-2 mb-4">
              <Brain size={24} />
              AI Coach Feedback
            </h2>
            
            <div className="space-y-4 relative z-10">
              <div className="bg-white/10 p-4 rounded-xl backdrop-blur-sm">
                <p className="text-xs text-purple-200 uppercase font-bold mb-2">Sugerencia Principal</p>
                <p className="font-medium">"{coachingData.tips[0]}"</p>
              </div>

              <div className="space-y-2">
                {coachingData.tips.slice(1).map((tip, i) => (
                  <div key={i} className="flex items-start gap-2 text-sm text-indigo-100">
                    <CheckCircle size={16} className="mt-0.5 text-green-400 shrink-0" />
                    <span>{tip}</span>
                  </div>
                ))}
              </div>
            </div>
          </div>

          {/* TARJETA 2: PAYWALL (Lo que Nodus quiere vender) */}
          <div className="bg-white border border-gray-200 rounded-2xl shadow-sm p-6 relative overflow-hidden group">
            
            {/* Contenido Borroso */}
            <div className="filter blur-sm select-none opacity-50 transition duration-500 group-hover:blur-md">
              <h3 className="font-bold text-gray-800 mb-4">An√°lisis Emocional Profundo</h3>
              <div className="space-y-3">
                <div className="h-4 bg-gray-200 rounded w-3/4"></div>
                <div className="h-4 bg-gray-200 rounded w-1/2"></div>
                <div className="h-32 bg-gray-100 rounded w-full mt-4"></div>
                <div className="flex gap-2 mt-4">
                  <span className="px-2 py-1 bg-red-100 text-red-600 rounded text-xs">Ira detectada</span>
                  <span className="px-2 py-1 bg-yellow-100 text-yellow-600 rounded text-xs">Sarcasmo</span>
                </div>
              </div>
            </div>

            {/* El Candado / Call to Action */}
            <div className="absolute inset-0 flex flex-col items-center justify-center bg-white/30 z-10">
              <div className="bg-gray-900 text-white p-4 rounded-full mb-3 shadow-xl transform group-hover:scale-110 transition">
                <Lock size={24} />
              </div>
              <h4 className="font-bold text-gray-900">Funci√≥n Premium</h4>
              <p className="text-sm text-gray-600 mb-4 text-center px-6">
                Desbloquea el an√°lisis de sentimientos micro-gestuales y predicci√≥n de fuga.
              </p>
              <button className="px-6 py-2 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold rounded-lg shadow-md hover:shadow-lg transition transform active:scale-95">
                Mejorar Plan üöÄ
              </button>
            </div>

          </div>

          {/* TARJETA 3: DATOS DUROS (Lo que ya tienes) */}
          <div className="bg-white border border-gray-200 rounded-2xl p-4 text-sm text-gray-600">
             <h4 className="font-bold text-gray-800 mb-2">Metadatos del Archivo</h4>
             <ul className="space-y-2">
               <li className="flex justify-between">
                 <span>Duraci√≥n:</span> <span className="font-mono">04:35</span>
               </li>
               <li className="flex justify-between">
                 <span>Formato:</span> <span className="font-mono">.WAV (HQ)</span>
               </li>
               <li className="flex justify-between">
                 <span>Tama√±o:</span> <span className="font-mono">6.2 MB</span>
               </li>
             </ul>
          </div>

        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/services/llamadasService.ts">
import { supabase } from '../lib/supabase';

// 1. Definimos la estructura del JSON "Exquisito" del Agente
export interface AnalisisAgent {
  score_final: number;
  error_critico: boolean;
  detalle_error: string;
  transcripcion: string;
  resumen_ejecutivo: string;
  tips: string[];
  hitos: {
    presentacion: { cumple: boolean; note: string };
    comunicacion: { cumple: boolean; note: string };
    negociacion:  { cumple: boolean; note: string };
    cierre:       { cumple: boolean; note: string };
  };
  compromiso_pago?: {
    monto: number;
    fecha: string;
    metodo: string;
  };
}

// 2. Actualizamos la interfaz principal de la Llamada
export interface Llamada {
  registro_id: string;
  audio_url: string;
  nombre_archivo: string;
  estado: 'pendiente' | 'transcribiendo' | 'analizando' | 'finalizado' | 'error';
  created_at: string;
  puntaje_calidad?: number;
  resumen_ejecutivo?: string;
  transcripcion_texto?: string;
  analisis_json?: AnalisisAgent; 
  agente?: { nombre: string };
  cliente_ref?: string;
  tips?: string[];
}

export const llamadasService = {
  // ... (tus m√©todos uploadAndCreate y delete se quedan igual) ...

  async getAll() {
    const { data, error } = await supabase
      .from('registro_llamadas')
      .select('*, agentes(nombre)')
      .order('created_at', { ascending: false });
    
    if (error) throw error;
    return data;
  },

  // üëá NUEVO M√âTODO: Obtener una sola llamada por ID para el detalle
  async getById(id: string) {
    const { data, error } = await supabase
      .from('registro_llamadas')
      .select('*, agentes(nombre)')
      .eq('registro_id', id)
      .single();

    if (error) throw error;
    return data as Llamada;
  }
};
</file>

<file path="docs/ag1_transcriptor/flujo_completo_ejemplo.md">
# Flujo Completo del Agente Transcriptor - Ejemplo E2E

## Input Inicial (desde Google Drive)

```json
{
  "audio_url": "https://drive.google.com/uc?export=download&id=1abc123def456",
  "audio_id_externo": "1abc123def456",
  "agente_id": "a0000000-0000-0000-0000-000000000002",
  "cliente_ref": "CL-45632",
  "timestamp_inicio": "2026-01-30T14:23:15-05:00",
  "timestamp_fin": "2026-01-30T14:27:30-05:00",
  "campana": "Recuperaci√≥n Q1",
  "tipo_deuda": "tarjeta_credito",
  "monto_deuda": 1450.00,
  "moneda": "PEN",
  "dias_mora": 45,
  "metadata_externa": {
    "ivr_session_id": "IVR-12345",
    "origen": "outbound"
  }
}
```

---

## PASO 3: Transcripci√≥n con Whisper

### Request a AI Studio

```json
{
  "audio_url": "https://drive.google.com/uc?export=download&id=1abc123def456",
  "config": {
    "model": "whisper-large-v3",
    "language": "es",
    "task": "transcribe",
    "diarization": {
      "enabled": true,
      "min_speakers": 2,
      "max_speakers": 2
    },
    "timestamps": {
      "granularity": "word",
      "include_confidence": true
    },
    "output_format": "verbose_json"
  }
}
```

### Response de Whisper

```json
{
  "text": "Buenos d√≠as, ¬øhablo con el se√±or Garc√≠a? S√≠, soy yo. ¬øDe d√≥nde me llama? Buenos d√≠as se√±or Garc√≠a, le habla Mar√≠a Gonz√°lez del banco Central. Le llamo por un tema importante sobre su cuenta. ¬øMe permite unos minutos? S√≠, d√≠game. Se√±or Garc√≠a, tenemos registrado un saldo vencido de 1,450 soles que venci√≥ el 15 de diciembre. Actualmente tiene 45 d√≠as de mora y se est√°n generando intereses adicionales. ¬øEst√° al tanto de esta situaci√≥n? S√≠, lo s√©, pero es que ahorita no tengo plata, estoy sin trabajo desde hace dos meses. Entiendo su situaci√≥n se√±or Garc√≠a, lamento escuchar eso. Perm√≠tame ofrecerle algunas alternativas. Podemos establecer un plan de pago o quiz√°s un pago parcial inicial. ¬øTiene alguna fecha en la que podr√≠a hacer un primer abono? Mire, lo que puedo hacer es pagar todo junto el 15 de febrero, cuando me paguen mi liquidaci√≥n. Perfecto, entonces quedamos que va a realizar el pago completo de 1,450 soles el 15 de febrero. ¬øEst√° de acuerdo? S√≠, eso es lo que voy a hacer. Excelente se√±or Garc√≠a. Le recuerdo que puede pagar por nuestra p√°gina web, la app m√≥vil, o en cualquier agencia. ¬øTiene alguna pregunta? No, est√° claro. Gracias. Muy bien. Muchas gracias por su tiempo se√±or Garc√≠a. Que tenga buen d√≠a. Igualmente, hasta luego.",
  "language": "es",
  "duration": 255.4,
  "segments": [
    {
      "id": 0,
      "start": 0.0,
      "end": 3.2,
      "text": "Buenos d√≠as, ¬øhablo con el se√±or Garc√≠a?",
      "speaker": "SPEAKER_00"
    },
    {
      "id": 1,
      "start": 3.2,
      "end": 5.8,
      "text": "S√≠, soy yo. ¬øDe d√≥nde me llama?",
      "speaker": "SPEAKER_01"
    },
    {
      "id": 2,
      "start": 5.8,
      "end": 15.5,
      "text": "Buenos d√≠as se√±or Garc√≠a, le habla Mar√≠a Gonz√°lez del banco Central. Le llamo por un tema importante sobre su cuenta. ¬øMe permite unos minutos?",
      "speaker": "SPEAKER_00"
    },
    {
      "id": 3,
      "start": 15.5,
      "end": 17.2,
      "text": "S√≠, d√≠game.",
      "speaker": "SPEAKER_01"
    },
    {
      "id": 4,
      "start": 17.2,
      "end": 35.8,
      "text": "Se√±or Garc√≠a, tenemos registrado un saldo vencido de 1,450 soles que venci√≥ el 15 de diciembre. Actualmente tiene 45 d√≠as de mora y se est√°n generando intereses adicionales. ¬øEst√° al tanto de esta situaci√≥n?",
      "speaker": "SPEAKER_00"
    },
    {
      "id": 5,
      "start": 35.8,
      "end": 45.2,
      "text": "S√≠, lo s√©, pero es que ahorita no tengo plata, estoy sin trabajo desde hace dos meses.",
      "speaker": "SPEAKER_01"
    },
    {
      "id": 6,
      "start": 45.2,
      "end": 65.5,
      "text": "Entiendo su situaci√≥n se√±or Garc√≠a, lamento escuchar eso. Perm√≠tame ofrecerle algunas alternativas. Podemos establecer un plan de pago o quiz√°s un pago parcial inicial. ¬øTiene alguna fecha en la que podr√≠a hacer un primer abono?",
      "speaker": "SPEAKER_00"
    },
    {
      "id": 7,
      "start": 65.5,
      "end": 78.3,
      "text": "Mire, lo que puedo hacer es pagar todo junto el 15 de febrero, cuando me paguen mi liquidaci√≥n.",
      "speaker": "SPEAKER_01"
    },
    {
      "id": 8,
      "start": 78.3,
      "end": 92.5,
      "text": "Perfecto, entonces quedamos que va a realizar el pago completo de 1,450 soles el 15 de febrero. ¬øEst√° de acuerdo?",
      "speaker": "SPEAKER_00"
    },
    {
      "id": 9,
      "start": 92.5,
      "end": 95.8,
      "text": "S√≠, eso es lo que voy a hacer.",
      "speaker": "SPEAKER_01"
    },
    {
      "id": 10,
      "start": 95.8,
      "end": 115.2,
      "text": "Excelente se√±or Garc√≠a. Le recuerdo que puede pagar por nuestra p√°gina web, la app m√≥vil, o en cualquier agencia. ¬øTiene alguna pregunta?",
      "speaker": "SPEAKER_00"
    },
    {
      "id": 11,
      "start": 115.2,
      "end": 118.5,
      "text": "No, est√° claro. Gracias.",
      "speaker": "SPEAKER_01"
    },
    {
      "id": 12,
      "start": 118.5,
      "end": 125.8,
      "text": "Muy bien. Muchas gracias por su tiempo se√±or Garc√≠a. Que tenga buen d√≠a.",
      "speaker": "SPEAKER_00"
    },
    {
      "id": 13,
      "start": 125.8,
      "end": 128.2,
      "text": "Igualmente, hasta luego.",
      "speaker": "SPEAKER_01"
    }
  ]
}
```

### Post-proceso: Mapeo de Speakers

```json
{
  "speaker_mapping": {
    "SPEAKER_00": "agente",
    "SPEAKER_01": "cliente"
  },
  "method": "first_speaker_identifies_company",
  "confidence": 0.98
}
```

---

## PASO 4: An√°lisis de Emociones

### Request a AI Studio

```json
{
  "audio_url": "https://drive.google.com/uc?export=download&id=1abc123def456",
  "segments": [
    {"id": 0, "start": 0.0, "end": 3.2, "speaker": "agente"},
    {"id": 1, "start": 3.2, "end": 5.8, "speaker": "cliente"},
    {"id": 2, "start": 5.8, "end": 15.5, "speaker": "agente"},
    {"id": 3, "start": 15.5, "end": 17.2, "speaker": "cliente"},
    {"id": 4, "start": 17.2, "end": 35.8, "speaker": "agente"},
    {"id": 5, "start": 35.8, "end": 45.2, "speaker": "cliente"},
    {"id": 6, "start": 45.2, "end": 65.5, "speaker": "agente"},
    {"id": 7, "start": 65.5, "end": 78.3, "speaker": "cliente"},
    {"id": 8, "start": 78.3, "end": 92.5, "speaker": "agente"},
    {"id": 9, "start": 92.5, "end": 95.8, "speaker": "cliente"},
    {"id": 10, "start": 95.8, "end": 115.2, "speaker": "agente"},
    {"id": 11, "start": 115.2, "end": 118.5, "speaker": "cliente"},
    {"id": 12, "start": 118.5, "end": 125.8, "speaker": "agente"},
    {"id": 13, "start": 125.8, "end": 128.2, "speaker": "cliente"}
  ],
  "config": {
    "model": "emotion-recognition-v2",
    "emotions": ["neutral", "positive", "negative", "frustrated", "confused", "interested"]
  }
}
```

### Response de Emociones

```json
{
  "segments": [
    {"id": 0, "emotion": "neutral", "confidence": 0.92, "intensity": 0.3, "speech_rate": 145},
    {"id": 1, "emotion": "neutral", "confidence": 0.88, "intensity": 0.35, "speech_rate": 140},
    {"id": 2, "emotion": "positive", "confidence": 0.85, "intensity": 0.45, "speech_rate": 148},
    {"id": 3, "emotion": "neutral", "confidence": 0.90, "intensity": 0.25, "speech_rate": 130},
    {"id": 4, "emotion": "neutral", "confidence": 0.88, "intensity": 0.40, "speech_rate": 152},
    {"id": 5, "emotion": "negative", "confidence": 0.82, "intensity": 0.65, "speech_rate": 125},
    {"id": 6, "emotion": "positive", "confidence": 0.86, "intensity": 0.50, "speech_rate": 145},
    {"id": 7, "emotion": "neutral", "confidence": 0.80, "intensity": 0.45, "speech_rate": 138},
    {"id": 8, "emotion": "positive", "confidence": 0.88, "intensity": 0.55, "speech_rate": 150},
    {"id": 9, "emotion": "positive", "confidence": 0.85, "intensity": 0.50, "speech_rate": 142},
    {"id": 10, "emotion": "positive", "confidence": 0.90, "intensity": 0.48, "speech_rate": 148},
    {"id": 11, "emotion": "positive", "confidence": 0.87, "intensity": 0.40, "speech_rate": 135},
    {"id": 12, "emotion": "positive", "confidence": 0.92, "intensity": 0.52, "speech_rate": 145},
    {"id": 13, "emotion": "positive", "confidence": 0.88, "intensity": 0.45, "speech_rate": 140}
  ]
}
```

---

## PASO 5-6: Prompt LLM (Claude Sonnet)

### Request al LLM

**System Prompt:**
```
Eres un experto analizador de llamadas de cobranzas. Tu tarea es extraer informaci√≥n estructurada de transcripciones de llamadas entre agentes de cobranza y clientes deudores.

CONTEXTO DEL NEGOCIO:
- Las llamadas son de gesti√≥n de cobranza de deudas (tarjetas de cr√©dito, pr√©stamos, etc.)
- El objetivo del agente es lograr un compromiso de pago del cliente
- Un "compromiso v√°lido" requiere: monto espec√≠fico + fecha espec√≠fica + VALIDACI√ìN EXPL√çCITA del cliente

REGLAS DE AN√ÅLISIS:
1. S√© objetivo y basa todo en evidencia textual exacta
2. Si algo no est√° claro, indica "no_detectado" en lugar de inferir
3. Los montos deben estar en la moneda mencionada (PEN, USD, etc.)
4. Las fechas deben convertirse a formato ISO (YYYY-MM-DD)
5. Una validaci√≥n es EXPL√çCITA solo si el cliente dice claramente "s√≠ voy a pagar", "confirmo", "de acuerdo, pagar√©", etc.
6. "ok", "entiendo", "lo voy a revisar" NO son validaciones expl√≠citas

Responde √öNICAMENTE con el JSON solicitado, sin texto adicional.
```

**User Prompt:**
```
Analiza la siguiente transcripci√≥n de una llamada de cobranza y extrae la informaci√≥n en el formato JSON especificado.

## DATOS DE LA LLAMADA
- Fecha de la llamada: 2026-01-30
- Agente: Mar√≠a Gonz√°lez
- Cliente (referencia): CL-45632
- Tipo de deuda: tarjeta_credito
- Monto de deuda registrado: 1450.00 PEN
- D√≠as de mora: 45

## TRANSCRIPCI√ìN COMPLETA
Buenos d√≠as, ¬øhablo con el se√±or Garc√≠a? S√≠, soy yo. ¬øDe d√≥nde me llama? Buenos d√≠as se√±or Garc√≠a, le habla Mar√≠a Gonz√°lez del banco Central. Le llamo por un tema importante sobre su cuenta. ¬øMe permite unos minutos? S√≠, d√≠game. Se√±or Garc√≠a, tenemos registrado un saldo vencido de 1,450 soles que venci√≥ el 15 de diciembre. Actualmente tiene 45 d√≠as de mora y se est√°n generando intereses adicionales. ¬øEst√° al tanto de esta situaci√≥n? S√≠, lo s√©, pero es que ahorita no tengo plata, estoy sin trabajo desde hace dos meses. Entiendo su situaci√≥n se√±or Garc√≠a, lamento escuchar eso. Perm√≠tame ofrecerle algunas alternativas. Podemos establecer un plan de pago o quiz√°s un pago parcial inicial. ¬øTiene alguna fecha en la que podr√≠a hacer un primer abono? Mire, lo que puedo hacer es pagar todo junto el 15 de febrero, cuando me paguen mi liquidaci√≥n. Perfecto, entonces quedamos que va a realizar el pago completo de 1,450 soles el 15 de febrero. ¬øEst√° de acuerdo? S√≠, eso es lo que voy a hacer. Excelente se√±or Garc√≠a. Le recuerdo que puede pagar por nuestra p√°gina web, la app m√≥vil, o en cualquier agencia. ¬øTiene alguna pregunta? No, est√° claro. Gracias. Muy bien. Muchas gracias por su tiempo se√±or Garc√≠a. Que tenga buen d√≠a. Igualmente, hasta luego.

## SEGMENTOS CON TIMESTAMPS Y EMOCIONES
[
  {"id": 0, "speaker": "agente", "start": 0.0, "end": 3.2, "text": "Buenos d√≠as, ¬øhablo con el se√±or Garc√≠a?", "emotion": "neutral", "speech_rate": 145},
  {"id": 1, "speaker": "cliente", "start": 3.2, "end": 5.8, "text": "S√≠, soy yo. ¬øDe d√≥nde me llama?", "emotion": "neutral", "speech_rate": 140},
  {"id": 2, "speaker": "agente", "start": 5.8, "end": 15.5, "text": "Buenos d√≠as se√±or Garc√≠a, le habla Mar√≠a Gonz√°lez del banco Central. Le llamo por un tema importante sobre su cuenta. ¬øMe permite unos minutos?", "emotion": "positive", "speech_rate": 148},
  {"id": 3, "speaker": "cliente", "start": 15.5, "end": 17.2, "text": "S√≠, d√≠game.", "emotion": "neutral", "speech_rate": 130},
  {"id": 4, "speaker": "agente", "start": 17.2, "end": 35.8, "text": "Se√±or Garc√≠a, tenemos registrado un saldo vencido de 1,450 soles que venci√≥ el 15 de diciembre. Actualmente tiene 45 d√≠as de mora y se est√°n generando intereses adicionales. ¬øEst√° al tanto de esta situaci√≥n?", "emotion": "neutral", "speech_rate": 152},
  {"id": 5, "speaker": "cliente", "start": 35.8, "end": 45.2, "text": "S√≠, lo s√©, pero es que ahorita no tengo plata, estoy sin trabajo desde hace dos meses.", "emotion": "negative", "speech_rate": 125},
  {"id": 6, "speaker": "agente", "start": 45.2, "end": 65.5, "text": "Entiendo su situaci√≥n se√±or Garc√≠a, lamento escuchar eso. Perm√≠tame ofrecerle algunas alternativas. Podemos establecer un plan de pago o quiz√°s un pago parcial inicial. ¬øTiene alguna fecha en la que podr√≠a hacer un primer abono?", "emotion": "positive", "speech_rate": 145},
  {"id": 7, "speaker": "cliente", "start": 65.5, "end": 78.3, "text": "Mire, lo que puedo hacer es pagar todo junto el 15 de febrero, cuando me paguen mi liquidaci√≥n.", "emotion": "neutral", "speech_rate": 138},
  {"id": 8, "speaker": "agente", "start": 78.3, "end": 92.5, "text": "Perfecto, entonces quedamos que va a realizar el pago completo de 1,450 soles el 15 de febrero. ¬øEst√° de acuerdo?", "emotion": "positive", "speech_rate": 150},
  {"id": 9, "speaker": "cliente", "start": 92.5, "end": 95.8, "text": "S√≠, eso es lo que voy a hacer.", "emotion": "positive", "speech_rate": 142},
  {"id": 10, "speaker": "agente", "start": 95.8, "end": 115.2, "text": "Excelente se√±or Garc√≠a. Le recuerdo que puede pagar por nuestra p√°gina web, la app m√≥vil, o en cualquier agencia. ¬øTiene alguna pregunta?", "emotion": "positive", "speech_rate": 148},
  {"id": 11, "speaker": "cliente", "start": 115.2, "end": 118.5, "text": "No, est√° claro. Gracias.", "emotion": "positive", "speech_rate": 135},
  {"id": 12, "speaker": "agente", "start": 118.5, "end": 125.8, "text": "Muy bien. Muchas gracias por su tiempo se√±or Garc√≠a. Que tenga buen d√≠a.", "emotion": "positive", "speech_rate": 145},
  {"id": 13, "speaker": "cliente", "start": 125.8, "end": 128.2, "text": "Igualmente, hasta luego.", "emotion": "positive", "speech_rate": 140}
]

## INSTRUCCIONES
Extrae: entidades (montos, fechas, m√©todos pago, objeciones, compromisos), m√©tricas conversacionales, an√°lisis emocional, y patrones detectados.

Responde con el JSON seg√∫n el schema proporcionado.
```

### Response del LLM

```json
{
  "entidades": {
    "montos": [
      {
        "valor": 1450.00,
        "moneda": "PEN",
        "contexto": "deuda_principal",
        "timestamp_mencion": 17.2,
        "frase_exacta": "un saldo vencido de 1,450 soles"
      },
      {
        "valor": 1450.00,
        "moneda": "PEN",
        "contexto": "total_a_pagar",
        "timestamp_mencion": 78.3,
        "frase_exacta": "el pago completo de 1,450 soles"
      }
    ],
    "fechas": [
      {
        "fecha": "2025-12-15",
        "contexto": "vencimiento_original",
        "timestamp_mencion": 17.2,
        "frase_exacta": "venci√≥ el 15 de diciembre"
      },
      {
        "fecha": "2026-02-15",
        "contexto": "compromiso_pago",
        "timestamp_mencion": 65.5,
        "frase_exacta": "el 15 de febrero, cuando me paguen mi liquidaci√≥n"
      }
    ],
    "metodos_pago": [
      {
        "metodo": "web",
        "mencionado_por": "agente",
        "frase_exacta": "puede pagar por nuestra p√°gina web"
      },
      {
        "metodo": "app_movil",
        "mencionado_por": "agente",
        "frase_exacta": "la app m√≥vil"
      },
      {
        "metodo": "agencia",
        "mencionado_por": "agente",
        "frase_exacta": "en cualquier agencia"
      }
    ],
    "objeciones": [
      {
        "tipo": "economica",
        "descripcion": "Cliente indica que no tiene liquidez y est√° sin empleo",
        "timestamp_inicio": 35.8,
        "frase_exacta": "ahorita no tengo plata, estoy sin trabajo desde hace dos meses",
        "fue_manejada": true,
        "resultado_manejo": "resuelta"
      }
    ],
    "compromisos": [
      {
        "tipo": "pago_total",
        "monto": 1450.00,
        "fecha": "2026-02-15",
        "validacion": "explicita",
        "frase_validacion": "S√≠, eso es lo que voy a hacer",
        "confianza": 0.85
      }
    ]
  },
  "metricas_conversacion": {
    "palabras_totales": 285,
    "palabras_agente": 195,
    "palabras_cliente": 90,
    "ratio_habla_agente": 0.68,
    "turnos_conversacion": 14,
    "duracion_turno_promedio_agente": 7.8,
    "duracion_turno_promedio_cliente": 4.5,
    "interrupciones": [],
    "silencios_prolongados": [],
    "palabras_clave": {
      "positivas": ["perfecto", "excelente", "gracias", "de acuerdo"],
      "negativas": ["no tengo plata", "sin trabajo"],
      "cobranza": ["saldo vencido", "mora", "intereses", "pago", "compromiso", "liquidaci√≥n"]
    },
    "preguntas_agente": 5,
    "preguntas_cliente": 1
  },
  "analisis_emocional": {
    "tono_general_agente": "profesional",
    "tono_general_cliente": "colaborador",
    "evolucion_cliente": "mejoro",
    "momentos_tension": [
      {
        "timestamp": 35.8,
        "descripcion": "Cliente revela situaci√≥n econ√≥mica dif√≠cil y desempleo",
        "desencadenante": "Pregunta sobre conocimiento de la deuda",
        "resolucion": "Agente muestra empat√≠a y ofrece alternativas"
      }
    ],
    "senales_receptividad": [
      "Cliente propone √©l mismo una fecha de pago",
      "Responde afirmativamente a la validaci√≥n",
      "Agradece al final de la llamada"
    ],
    "senales_rechazo": []
  },
  "patrones_detectados": {
    "saludo_correcto": true,
    "identificacion_empresa": true,
    "verificacion_identidad": true,
    "explicacion_motivo": true,
    "mencion_monto_deuda": true,
    "mencion_consecuencias": true,
    "oferta_alternativas": true,
    "intento_cierre": true,
    "despedida_correcta": true,
    "hubo_abandono": false,
    "abandono_info": null,
    "tipo_cierre": "compromiso_explicito"
  },
  "resumen": {
    "duracion_efectiva_segundos": 128,
    "resultado_llamada": "compromiso_logrado",
    "monto_comprometido": 1450.00,
    "fecha_compromiso": "2026-02-15",
    "requiere_seguimiento": true,
    "notas_importantes": [
      "Cliente sin empleo - situaci√≥n econ√≥mica sensible",
      "Compromiso depende de recibir su liquidaci√≥n",
      "VALIDACI√ìN EXPL√çCITA obtenida: 'S√≠, eso es lo que voy a hacer'",
      "Recomendado: llamada de confirmaci√≥n 1 semana antes (08-Feb)"
    ]
  }
}
```

---

## OUTPUT FINAL: INSERT en Supabase

### Tabla: `registro_llamadas`

```json
{
  "registro_id": "r0000000-0000-0000-0000-000000000099",
  "audio_url": "https://drive.google.com/uc?export=download&id=1abc123def456",
  "audio_id_externo": "1abc123def456",
  "timestamp_inicio": "2026-01-30T14:23:15-05:00",
  "timestamp_fin": "2026-01-30T14:27:30-05:00",
  "duracion_segundos": 255,
  "timestamp_fecha": "2026-01-30",
  "agente_id": "a0000000-0000-0000-0000-000000000002",
  "cliente_ref": "CL-45632",
  "campana": "Recuperaci√≥n Q1",
  "tipo_deuda": "tarjeta_credito",
  "monto_deuda": 1450.00,
  "dias_mora": 45,
  "estado": "transcrito",
  "transcripcion_id": "t0000000-0000-0000-0000-000000000099",
  "metadata_externa": {
    "ivr_session_id": "IVR-12345",
    "origen": "outbound"
  }
}
```

### Tabla: `transcripciones`

```json
{
  "transcripcion_id": "t0000000-0000-0000-0000-000000000099",
  "registro_id": "r0000000-0000-0000-0000-000000000099",
  
  "transcripcion_completa": "Buenos d√≠as, ¬øhablo con el se√±or Garc√≠a? S√≠, soy yo. ¬øDe d√≥nde me llama? Buenos d√≠as se√±or Garc√≠a, le habla Mar√≠a Gonz√°lez del banco Central...[texto completo]",
  
  "segmentos": [
    {
      "id": 0,
      "speaker": "agente",
      "timestamp_inicio": 0.0,
      "timestamp_fin": 3.2,
      "texto": "Buenos d√≠as, ¬øhablo con el se√±or Garc√≠a?",
      "emocion": "neutral",
      "emocion_confianza": 0.92,
      "velocidad_habla": 145
    },
    {
      "id": 1,
      "speaker": "cliente",
      "timestamp_inicio": 3.2,
      "timestamp_fin": 5.8,
      "texto": "S√≠, soy yo. ¬øDe d√≥nde me llama?",
      "emocion": "neutral",
      "emocion_confianza": 0.88,
      "velocidad_habla": 140
    }
  ],
  
  "entidades": {
    "montos": [
      {"valor": 1450.00, "moneda": "PEN", "contexto": "deuda_principal", "frase_exacta": "un saldo vencido de 1,450 soles"}
    ],
    "fechas": [
      {"fecha": "2025-12-15", "contexto": "vencimiento_original"},
      {"fecha": "2026-02-15", "contexto": "compromiso_pago"}
    ],
    "metodos_pago": ["web", "app_movil", "agencia"],
    "objeciones": [
      {"tipo": "economica", "descripcion": "Sin liquidez por desempleo", "manejada": true}
    ],
    "compromisos": [
      {"tipo": "pago_total", "monto": 1450.00, "fecha": "2026-02-15", "validacion": "explicita", "confianza": 0.85}
    ]
  },
  
  "metricas_conversacion": {
    "palabras_totales": 285,
    "palabras_agente": 195,
    "palabras_cliente": 90,
    "ratio_habla_agente": 0.68,
    "turnos_conversacion": 14,
    "interrupciones": 0,
    "silencios_prolongados": 0,
    "preguntas_agente": 5,
    "preguntas_cliente": 1
  },
  
  "analisis_emocional": {
    "tono_agente": "profesional",
    "tono_cliente": "colaborador",
    "evolucion_cliente": "mejoro",
    "momentos_tension": [
      {"timestamp": 35.8, "descripcion": "Revelaci√≥n de desempleo", "resolucion": "Empat√≠a y alternativas"}
    ]
  },
  
  "patrones_detectados": {
    "saludo_correcto": true,
    "identificacion_empresa": true,
    "verificacion_identidad": true,
    "mencion_monto": true,
    "mencion_consecuencias": true,
    "oferta_alternativas": true,
    "intento_cierre": true,
    "despedida_correcta": true,
    "hubo_abandono": false,
    "tipo_cierre": "compromiso_explicito"
  },
  
  "calidad_audio": {
    "score": 95,
    "ruido_fondo": false,
    "inaudibles": 0
  },
  
  "modelo_transcripcion": "whisper-large-v3",
  "modelo_emociones": "emotion-recognition-v2",
  "modelo_extraccion": "claude-sonnet-4-5-20250514",
  "tiempo_procesamiento_ms": 48500
}
```

---

## Trigger Webhook ‚Üí Agente Analista

```json
POST https://saturn.rocketbot.com/webhooks/nodus-analista

{
  "registro_id": "r0000000-0000-0000-0000-000000000099",
  "transcripcion_id": "t0000000-0000-0000-0000-000000000099",
  "agente_id": "a0000000-0000-0000-0000-000000000002",
  "timestamp": "2026-01-30T14:28:45Z",
  "resumen_rapido": {
    "duracion": 255,
    "compromiso_logrado": true,
    "validacion_explicita": true,
    "monto_comprometido": 1450.00,
    "fecha_compromiso": "2026-02-15"
  }
}
```

---

## Tiempos de Procesamiento (Este Ejemplo)

| Paso | Tiempo | Acumulado |
|------|--------|-----------|
| Paso 3: Whisper | 32s | 32s |
| Paso 4: Emociones | 8s | 40s |
| Paso 5-6: LLM | 8.5s | 48.5s |
| Total | **48.5s** | - |

‚úÖ Dentro del objetivo de < 95 segundos para el agente transcriptor.
</file>

<file path="docs/ag1_transcriptor/insert_supabase.md">
# INSERT en Supabase - Agente Transcriptor

## Flujo de Datos

```
Gemini Output (output_transcriptor.json)
           +
Claude Output (output_analisispreliminar.json)
           ‚Üì
    Combinar datos
           ‚Üì
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚Üì                 ‚Üì
registro_llamadas  transcripciones
```

---

## 1. INSERT en `registro_llamadas`

### Datos del Webhook Inicial + Gemini

```javascript
// Datos que vienen del webhook/Drive
const webhookData = {
  audio_url: "https://drive.google.com/...",
  audio_id_externo: "1abc123def456",
  campana: "Cobranza Q1 2026",  // Hardcodeado o del nombre del archivo
  // timestamp_inicio y timestamp_fin pueden ser null o generados
};

// Datos extra√≠dos de Gemini
const geminiOutput = { /* output_transcriptor.json */ };

// INSERT
const registroLlamada = {
  // Referencia al audio
  audio_url: webhookData.audio_url,
  audio_id_externo: webhookData.audio_id_externo,
  
  // Timestamps (pueden ser null si no los tenemos)
  timestamp_inicio: webhookData.timestamp_inicio || null,
  timestamp_fin: webhookData.timestamp_fin || null,
  duracion_segundos: geminiOutput.duracion_segundos, // 268
  
  // Participantes extra√≠dos de Gemini
  cliente_nombre: geminiOutput.participantes?.cliente?.nombre_completo, // "Yessenia Andrea Gonz√°lez D√≠az"
  cliente_ref: geminiOutput.participantes?.cliente?.nombre_corto || null, // "Yessenia"
  agente_nombre: geminiOutput.participantes?.agente?.nombre_completo, // "Silvano Machado"
  agente_id: null, // Se puede buscar despu√©s por nombre
  
  // Empresas
  empresa_acreedora: geminiOutput.participantes?.empresa_acreedora, // "Caja Los Andes"
  empresa_cobranza: geminiOutput.participantes?.empresa_cobranza, // "Redsap"
  
  // Contexto
  campana: webhookData.campana || "Sin campa√±a",
  tipo_deuda: null, // Se puede inferir o dejar null
  monto_deuda: null, // Se puede tomar del an√°lisis
  dias_mora: null,
  
  // Estado
  estado: 'transcrito', // Se actualizar√° a 'analizado' despu√©s
  
  // Metadata
  metadata_externa: {
    source: "google_drive",
    file_name: webhookData.file_name || null,
    processed_at: new Date().toISOString()
  }
};
```

### SQL de INSERT

```sql
INSERT INTO registro_llamadas (
  audio_url,
  audio_id_externo,
  timestamp_inicio,
  timestamp_fin,
  duracion_segundos,
  cliente_nombre,
  cliente_ref,
  agente_nombre,
  agente_id,
  empresa_acreedora,
  empresa_cobranza,
  campana,
  estado,
  metadata_externa
) VALUES (
  $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, 'transcrito', $13
)
RETURNING registro_id;
```

---

## 2. INSERT en `transcripciones`

### Combinar Outputs de Gemini y Claude

```javascript
const geminiOutput = { /* output_transcriptor.json */ };
const claudeOutput = { /* output_analisispreliminar.json */ };

const transcripcion = {
  registro_id: registroId, // Del INSERT anterior
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // DATOS DE GEMINI
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  transcripcion_completa: geminiOutput.transcripcion_completa,
  
  segmentos: geminiOutput.segmentos_raw,
  
  metricas_conversacion: {
    // De estadisticas_basicas
    palabras_totales: geminiOutput.estadisticas_basicas.palabras_totales,
    palabras_agente: geminiOutput.estadisticas_basicas.palabras_agente,
    palabras_cliente: geminiOutput.estadisticas_basicas.palabras_cliente,
    total_segmentos: geminiOutput.estadisticas_basicas.total_segmentos,
    confianza_promedio: geminiOutput.estadisticas_basicas.confianza_promedio,
    
    // De metricas_conversacion (si existe)
    ratio_habla: geminiOutput.metricas_conversacion?.ratio_habla_agente 
      || (geminiOutput.estadisticas_basicas.palabras_agente / geminiOutput.estadisticas_basicas.palabras_totales),
    interrupciones: geminiOutput.metricas_conversacion?.interrupciones?.length || 0,
    silencios_largos: geminiOutput.metricas_conversacion?.silencios_prolongados?.length || 0,
    
    // Velocidades (si no las tenemos, dejar 0)
    velocidad_promedio_agente: 0,
    velocidad_promedio_cliente: 0
  },
  
  analisis_emocional: geminiOutput.analisis_emocional,
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // DATOS DE CLAUDE
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  entidades: claudeOutput.entidades,
  
  patrones_script: claudeOutput.patrones_script,
  
  resultado_preliminar: claudeOutput.resultado_llamada,
  
  resumen_ejecutivo: claudeOutput.resumen_ejecutivo,
  
  referencias_creditos: claudeOutput.entidades.referencias_creditos,
  
  seguimiento: claudeOutput.seguimiento,
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // METADATA
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  calidad_audio: {
    score: geminiOutput.estadisticas_basicas.confianza_promedio * 100,
    ruido_fondo: false,
    cortes: 0,
    inaudibles: 0
  },
  
  modelo_transcripcion: "gemini-2.0-flash",
  modelo_emociones: "gemini-2.0-flash",
  modelo_entidades: "claude-sonnet-4.5",
  tiempo_procesamiento_ms: null // Medir si es necesario
};
```

### SQL de INSERT

```sql
INSERT INTO transcripciones (
  registro_id,
  transcripcion_completa,
  segmentos,
  metricas_conversacion,
  analisis_emocional,
  entidades,
  patrones_script,
  resultado_preliminar,
  resumen_ejecutivo,
  referencias_creditos,
  seguimiento,
  calidad_audio,
  modelo_transcripcion,
  modelo_emociones,
  modelo_entidades,
  tiempo_procesamiento_ms
) VALUES (
  $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16
)
RETURNING transcripcion_id;
```

---

## 3. UPDATE `registro_llamadas` con transcripcion_id

```sql
UPDATE registro_llamadas 
SET 
  transcripcion_id = $1,
  estado = 'transcrito',
  updated_at = NOW()
WHERE registro_id = $2;
```

---

## 4. C√≥digo Completo (JavaScript/TypeScript)

```typescript
import { createClient } from '@supabase/supabase-js';

const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);

async function insertTranscripcion(
  webhookData: WebhookInput,
  geminiOutput: GeminiOutput,
  claudeOutput: ClaudeOutput
) {
  // 1. INSERT registro_llamadas
  const { data: registro, error: registroError } = await supabase
    .from('registro_llamadas')
    .insert({
      audio_url: webhookData.audio_url,
      audio_id_externo: webhookData.audio_id_externo,
      timestamp_inicio: webhookData.timestamp_inicio || null,
      timestamp_fin: webhookData.timestamp_fin || null,
      duracion_segundos: geminiOutput.duracion_segundos,
      cliente_nombre: geminiOutput.participantes?.cliente?.nombre_completo,
      cliente_ref: geminiOutput.participantes?.cliente?.nombre_corto,
      agente_nombre: geminiOutput.participantes?.agente?.nombre_completo,
      empresa_acreedora: geminiOutput.participantes?.empresa_acreedora,
      empresa_cobranza: geminiOutput.participantes?.empresa_cobranza,
      campana: webhookData.campana || 'Sin campa√±a',
      estado: 'procesando',
      metadata_externa: {
        source: 'google_drive',
        file_name: webhookData.file_name,
        processed_at: new Date().toISOString()
      }
    })
    .select('registro_id')
    .single();

  if (registroError) throw registroError;
  const registroId = registro.registro_id;

  // 2. INSERT transcripciones
  const { data: transcripcion, error: transcripcionError } = await supabase
    .from('transcripciones')
    .insert({
      registro_id: registroId,
      transcripcion_completa: geminiOutput.transcripcion_completa,
      segmentos: geminiOutput.segmentos_raw,
      metricas_conversacion: buildMetricasConversacion(geminiOutput),
      analisis_emocional: geminiOutput.analisis_emocional,
      entidades: claudeOutput.entidades,
      patrones_script: claudeOutput.patrones_script,
      resultado_preliminar: claudeOutput.resultado_llamada,
      resumen_ejecutivo: claudeOutput.resumen_ejecutivo,
      referencias_creditos: claudeOutput.entidades.referencias_creditos,
      seguimiento: claudeOutput.seguimiento,
      calidad_audio: {
        score: Math.round(geminiOutput.estadisticas_basicas.confianza_promedio * 100),
        ruido_fondo: false,
        cortes: 0,
        inaudibles: 0
      },
      modelo_transcripcion: 'gemini-2.0-flash',
      modelo_emociones: 'gemini-2.0-flash',
      modelo_entidades: 'claude-sonnet-4.5'
    })
    .select('transcripcion_id')
    .single();

  if (transcripcionError) throw transcripcionError;
  const transcripcionId = transcripcion.transcripcion_id;

  // 3. UPDATE registro_llamadas con transcripcion_id
  await supabase
    .from('registro_llamadas')
    .update({
      transcripcion_id: transcripcionId,
      estado: 'transcrito',
      updated_at: new Date().toISOString()
    })
    .eq('registro_id', registroId);

  // 4. Retornar IDs para el webhook al Agente Analista
  return {
    registro_id: registroId,
    transcripcion_id: transcripcionId,
    resultado_preliminar: claudeOutput.resultado_llamada
  };
}

function buildMetricasConversacion(gemini: GeminiOutput) {
  const stats = gemini.estadisticas_basicas;
  const metricas = gemini.metricas_conversacion || {};
  
  return {
    palabras_totales: stats.palabras_totales,
    palabras_agente: stats.palabras_agente,
    palabras_cliente: stats.palabras_cliente,
    ratio_habla: metricas.ratio_habla_agente || (stats.palabras_agente / stats.palabras_totales),
    interrupciones: metricas.interrupciones?.length || 0,
    silencios_largos: metricas.silencios_prolongados?.length || 0,
    velocidad_promedio_agente: 0,
    velocidad_promedio_cliente: 0
  };
}
```

---

## 5. Webhook al Agente Analista

Despu√©s de insertar, trigger al siguiente agente:

```javascript
// POST https://saturn.rocketbot.com/webhooks/nodus-analista
const webhookPayload = {
  registro_id: registroId,
  transcripcion_id: transcripcionId,
  agente_id: null, // Se buscar√° por nombre
  agente_nombre: geminiOutput.participantes?.agente?.nombre_completo,
  timestamp: new Date().toISOString(),
  resultado_preliminar: claudeOutput.resultado_llamada
};
```

---

## Resumen de Flujo

```
1. Webhook recibe audio de Drive
2. Gemini transcribe + emociones + participantes
3. Claude extrae entidades + an√°lisis
4. INSERT registro_llamadas
5. INSERT transcripciones
6. UPDATE registro_llamadas.transcripcion_id
7. Webhook ‚Üí Agente Analista
```
</file>

<file path="docs/ag1_transcriptor/output_analisispreliminar.json">
{
    "entidades": {
        "montos": [
            {
                "valor": 405302,
                "moneda": "CLP",
                "contexto": "deuda_principal",
                "segmento_id": 8,
                "frase_exacta": "deuda de 405,302 pesos"
            },
            {
                "valor": 128888,
                "moneda": "CLP",
                "contexto": "oferta_descuento",
                "segmento_id": 9,
                "frase_exacta": "pague solamente 128,888 pesos"
            },
            {
                "valor": 16809,
                "moneda": "CLP",
                "contexto": "deuda_secundaria",
                "segmento_id": 13,
                "frase_exacta": "deuda total de 16,809 pesos"
            },
            {
                "valor": 10607,
                "moneda": "CLP",
                "contexto": "oferta_descuento_secundaria",
                "segmento_id": 13,
                "frase_exacta": "paga solamente 10,607 pesos"
            }
        ],
        "fechas": [
            {
                "fecha_relativa": "ma√±ana",
                "fecha_iso": "no_detectado",
                "contexto": "compromiso_pago_menor",
                "segmento_id": 25,
                "frase_exacta": "ma√±ana pago el otro de 16"
            },
            {
                "fecha_relativa": "antes del viernes",
                "fecha_iso": "no_detectado",
                "contexto": "limite_oferta",
                "segmento_id": 32,
                "frase_exacta": "tendr√≠a que ser antes del viernes"
            },
            {
                "fecha_relativa": "el s√°bado",
                "fecha_iso": "no_detectado",
                "contexto": "compromiso_pago_principal",
                "segmento_id": 41,
                "frase_exacta": "el s√°bado cancelo ese de 128"
            }
        ],
        "metodos_pago": [
            {
                "metodo": "app_movil",
                "mencionado_por": "cliente",
                "segmento_id": 22,
                "frase_exacta": "Por la APP"
            },
            {
                "metodo": "web",
                "mencionado_por": "cliente",
                "segmento_id": 39,
                "frase_exacta": "por la p√°gina"
            }
        ],
        "referencias_creditos": [
            {
                "identificador": "8569",
                "tipo": "terminacion_cuenta",
                "monto_deuda": 405302,
                "monto_oferta": 128888,
                "segmento_id": 8
            },
            {
                "identificador": "6564",
                "tipo": "terminacion_cuenta",
                "monto_deuda": 16809,
                "monto_oferta": 10607,
                "segmento_id": 13
            },
            {
                "identificador": "8512",
                "tipo": "terminacion_cuenta",
                "monto_deuda": 16000,
                "monto_oferta": null,
                "segmento_id": 17
            }
        ],
        "objeciones": [
            {
                "tipo": "ninguna",
                "descripcion": "La cliente muestra disposici√≥n al pago y ya est√° realizando gestiones por su cuenta.",
                "segmento_id": null,
                "frase_exacta": null,
                "fue_manejada": null,
                "resultado_manejo": null
            }
        ],
        "compromisos": [
            {
                "tipo": "pago_total_con_descuento",
                "credito_referencia": "8569",
                "monto": 128888,
                "moneda": "CLP",
                "fecha_relativa": "el s√°bado",
                "fecha_iso": "no_detectado",
                "validacion": "explicita",
                "segmento_id": 41,
                "frase_validacion": "S√≠ yo creo que el s√°bado cancelo ese de 128",
                "confianza": 0.95
            },
            {
                "tipo": "pago_total_con_descuento",
                "credito_referencia": "6564",
                "monto": 10607,
                "moneda": "CLP",
                "fecha_relativa": "ma√±ana",
                "fecha_iso": "no_detectado",
                "validacion": "explicita",
                "segmento_id": 25,
                "frase_validacion": "Bueno, yo creo que ma√±ana pago el otro de 16",
                "confianza": 0.9
            }
        ]
    },
    "patrones_script": {
        "saludo_correcto": true,
        "identificacion_empresa": true,
        "identificacion_agente": true,
        "verificacion_identidad_cliente": true,
        "explicacion_motivo": true,
        "mencion_monto_deuda": true,
        "presentacion_ofertas": true,
        "mencion_consecuencias": false,
        "intento_cierre": true,
        "despedida_correcta": true,
        "score_script": 90,
        "notas_script": "El agente cumpli√≥ con casi todo el protocolo; no mencion√≥ consecuencias de no pago, pero dado el perfil pagador de la cliente, prioriz√≥ la oferta y el cierre positivo."
    },
    "resultado_llamada": {
        "tipo_cierre": "compromiso_explicito",
        "hubo_abandono": false,
        "abandono_info": null,
        "compromiso_logrado": true,
        "monto_total_comprometido": 139495,
        "moneda": "CLP",
        "fecha_compromiso": "proximo_sabado",
        "metodo_pago_acordado": "app_movil",
        "riesgo_incumplimiento": "bajo",
        "razon_riesgo": "La cliente ya realiz√≥ un pago el d√≠a anterior y tiene una actitud proactiva y aliviada al recibir los descuentos."
    },
    "seguimiento": {
        "requiere_seguimiento": true,
        "tipo_seguimiento": "confirmacion_pago",
        "fecha_sugerida": "no_detectado",
        "prioridad": "media",
        "notas": "Verificar el pago de 10,607 CLP ma√±ana y el de 128,888 CLP el lunes. La cliente consult√≥ por repactaci√≥n de deudas grandes, derivar a sucursal si cumple con estos pagos."
    },
    "resumen_ejecutivo": {
        "duracion_segundos": 321,
        "resultado": "exitoso",
        "descripcion": "Llamada de cobranza altamente efectiva donde la cliente Yessenia Gonz√°lez confirm√≥ dos compromisos de pago tras recibir ofertas de descuento significativas. La cliente ya es pagadora activa (pag√≥ un cr√©dito ayer).",
        "puntos_clave": [
            "Compromiso de pago de 128,888 CLP (cr√©dito 8569) para el s√°bado.",
            "Compromiso de pago de 10,607 CLP (cr√©dito 6564) para ma√±ana.",
            "Cliente ya pag√≥ un tercer cr√©dito (8512) el d√≠a anterior v√≠a APP.",
            "Inter√©s de la cliente en consolidar/repactar deudas restantes en sucursal.",
            "Evoluci√≥n emocional positiva: de neutral a aliviada/agradecida."
        ],
        "alertas": [],
        "recommendaciones": [
            "Bloquear la oferta en el sistema para asegurar que el monto no cambie el s√°bado como prometi√≥ el agente.",
            "Contactar el lunes para confirmar la liquidaci√≥n de ambos cr√©ditos.",
            "Proveer direcci√≥n de sucursal cercana si la cliente solicita la repactaci√≥n mencionada."
        ]
    }
}
</file>

<file path="docs/ag1_transcriptor/output_transcriptor.json">
{
    "transcripcion_completa": "Agente: Buenas tardes. Cliente: Buenas tardes. Agente: ¬øS√≠ buenas tardes? Hablo con la se√±ora Yessenia Andrea Gonz√°lez D√≠az. Cliente: S√≠. Agente: Un gusto, mi nombre es Silvano Machado, le estamos hablando de Redsap por encargo de Caja Los Andes. Cliente: S√≠. Agente: Se√±ora Yessenia la estamos llamando referente a sus cr√©ditos que actualmente est√°n presentando una deuda. Pero nosotros por aqu√≠ lo que queremos es disminuirle el monto de esa deuda y por eso le tenemos unas ofertas que de repente se puedan ajustar a su situaci√≥n actual, ¬øs√≠? Cliente: S√≠. Agente: Okay, por aqu√≠ yo tengo un cr√©dito que termina en 8569 que actualmente est√° presentando una deuda de 405,302 pesos. Por ac√° le ofrecemos que en lugar de pagar esos 405,000 pague solamente 128,888 pesos y ya con eso quedar√≠a saldado el cr√©dito. ¬øS√≠? Cliente: S√≠. Agente: Tambi√©n tengo un cr√©dito... s√≠ diga. Cliente: Ya, no, siga, siga. Agente: Vale, tambi√©n tengo un cr√©dito que termina en 6564 que tiene una deuda total de 16,809 pesos, pero si paga solamente 10,607 pesos quedar√≠a saldado el cr√©dito. ¬øQu√© le parece esta oferta, se√±ora Yessenia? Cliente: Ayer pagu√© uno de 16, quedan 10 mil y algo. Agente: El de 16,000 pagar√≠a 10,607 y saldar√≠a... Cliente: S√≠, eso fue lo que pagu√© ayer y me queda uno de 16 creo, porque eran dos. Agente: Vale, tiene... yo veo aqu√≠ que tiene, ah okay, el que termina en 8512. Cliente: S√≠. Agente: Aj√°, s√≠, ese. ¬øY ese c√≥mo hizo el pago, se√±ora Yessenia? Cliente: ¬øPerd√≥n? Agente: ¬øC√≥mo hizo el pago de ese cr√©dito? Cliente: Por la APP. Agente: Por la aplicaci√≥n. Cliente: S√≠, me sali√≥ en oferta y... Agente: Pero entonces le quedar√≠an tres cr√©ditos, se√±ora Yessenia. Cliente: S√≠, tres solamente. Bueno, yo creo que ma√±ana pago el otro de 16 y me quedar√≠an los dos grandes. Agente: Exacto, se quedar√≠a con los dos grandes. Vale, igual lo estar√≠a pagando por la aplicaci√≥n se√±ora Yessenia. Cliente: S√≠, porque igual son cuotas. Agente: Vale, entonces yo voy a colocar que estar√≠a pagando eso y quedar√≠an entonces los m√°s grandes que bueno, poco a poco los va a ir pagando se√±ora Yessenia, ¬øs√≠? Cliente: S√≠, s√≠, s√≠. Incluso ayer hab√≠a hablado por WhatsApp para ver si pod√≠a hacer como juntar esas dos deudas y hacer una sola. Agente: Eso tendr√≠a que ir directamente en la oficina. Ser√≠a una repactaci√≥n de los cr√©ditos, pero s√≠ tiene que ir directamente a la sucursal para poder hacerlo. Cliente: Ah, ya, okay. Agente: Si quiere puede aprovechar la oferta, pero tendr√≠a que ser antes del viernes para que aproveche la oferta que tenemos ac√°, ¬øs√≠? Cliente: Ya. Agente: ¬øS√≠ tendr√≠a disponibilidad se√±ora Yessenia? Cliente: Yo creo que s√≠, eso del 120 y ¬øcu√°nto me dijo? ¬ø128? Agente: 128,888. Uno es por 128. Cliente: ¬øEse est√° para el d√≠a s√°bado o no? Agente: S√≠, s√≠, para el d√≠a s√°bado s√≠. Cliente: Ese es el mismo que me sale por la p√°gina, ¬øverdad? Agente: Por la p√°gina, s√≠. Lo que yo voy a hacer es bloquearlo para que ya para el s√°bado tenga ese mismo monto y no se lo cambien. Cliente: Ya. Okay, okay. S√≠ yo creo que el s√°bado cancelo ese de 128 y ya me quedar√≠a el otro nom√°s. Agente: Exacto, con el favor de Dios, poco a poco, se√±ora Yessenia. Cliente: Poco a poco. Gracias. Agente: Dale, ya coloco esa informaci√≥n por aqu√≠ y cualquier cosa estamos a la orden se√±ora Yessenia. Cliente: Ya, muchas gracias. Agente: Much√≠simas gracias, feliz d√≠a. Cliente: Igual. Agente: Dale, hasta luego.",
    "duracion_segundos": 261,
    "participantes": {
        "cliente": {
            "nombre_completo": "Yessenia Andrea Gonz√°lez D√≠az",
            "nombre_corto": "Yessenia"
        },
        "agente": {
            "nombre_completo": "Silvano Machado",
            "nombre_corto": "Silvano"
        },
        "empresa_cobranza": "Redsap",
        "empresa_acreedora": "Caja Los Andes"
    },
    "segmentos_raw": [
        {
            "id": 0,
            "speaker": "agente",
            "timestamp_inicio": 0,
            "timestamp_fin": 1.5,
            "texto": "Buenas tardes.",
            "palabras": 2,
            "confianza": 0.99,
            "emocion": "neutral",
            "emocion_intensidad": 0.4
        },
        {
            "id": 1,
            "speaker": "cliente",
            "timestamp_inicio": 2,
            "timestamp_fin": 3,
            "texto": "Buenas tardes.",
            "palabras": 2,
            "confianza": 0.99,
            "emocion": "neutral",
            "emocion_intensidad": 0.3
        },
        {
            "id": 2,
            "speaker": "agente",
            "timestamp_inicio": 4,
            "timestamp_fin": 10,
            "texto": "¬øS√≠ buenas tardes? Hablo con la se√±ora Yessenia Andrea Gonz√°lez D√≠az.",
            "palabras": 10,
            "confianza": 0.98,
            "emocion": "neutral",
            "emocion_intensidad": 0.5
        },
        {
            "id": 3,
            "speaker": "cliente",
            "timestamp_inicio": 10.1,
            "timestamp_fin": 10.8,
            "texto": "S√≠.",
            "palabras": 1,
            "confianza": 0.99,
            "emocion": "neutral",
            "emocion_intensidad": 0.3
        },
        {
            "id": 4,
            "speaker": "agente",
            "timestamp_inicio": 11,
            "timestamp_fin": 16.5,
            "texto": "Un gusto, mi nombre es Silvano Machado, le estamos hablando de Redsap por encargo de Caja Los Andes.",
            "palabras": 17,
            "confianza": 0.99,
            "emocion": "positivo",
            "emocion_intensidad": 0.6
        },
        {
            "id": 5,
            "speaker": "cliente",
            "timestamp_inicio": 16.6,
            "timestamp_fin": 17.2,
            "texto": "S√≠.",
            "palabras": 1,
            "confianza": 0.99,
            "emocion": "neutral",
            "emocion_intensidad": 0.3
        },
        {
            "id": 6,
            "speaker": "agente",
            "timestamp_inicio": 18,
            "timestamp_fin": 31,
            "texto": "Se√±ora Yessenia la estamos llamando referente a sus cr√©ditos que actualmente est√°n presentando una deuda. Pero nosotros por aqu√≠ lo que queremos es disminuirle el monto de esa deuda y por eso le tenemos unas ofertas que de repente se puedan ajustar a su situaci√≥n actual, ¬øs√≠?",
            "palabras": 47,
            "confianza": 0.97,
            "emocion": "interesado",
            "emocion_intensidad": 0.5
        },
        {
            "id": 7,
            "speaker": "cliente",
            "timestamp_inicio": 32,
            "timestamp_fin": 33,
            "texto": "S√≠.",
            "palabras": 1,
            "confianza": 0.99,
            "emocion": "neutral",
            "emocion_intensidad": 0.3
        },
        {
            "id": 8,
            "speaker": "agente",
            "timestamp_inicio": 35,
            "timestamp_fin": 46,
            "texto": "Okay, por aqu√≠ yo tengo un cr√©dito que termina en 8569 que actualmente est√° presentando una deuda de 405,302 pesos.",
            "palabras": 19,
            "confianza": 0.98,
            "emocion": "neutral",
            "emocion_intensidad": 0.4
        },
        {
            "id": 9,
            "speaker": "agente",
            "timestamp_inicio": 47,
            "timestamp_fin": 58,
            "texto": "Por ac√° le ofrecemos que en lugar de pagar esos 405,000 pague solamente 128,888 pesos y ya con eso quedar√≠a saldado el cr√©dito. ¬øS√≠?",
            "palabras": 23,
            "confianza": 0.98,
            "emocion": "positivo",
            "emocion_intensidad": 0.7
        },
        {
            "id": 10,
            "speaker": "cliente",
            "timestamp_inicio": 59,
            "timestamp_fin": 60,
            "texto": "S√≠.",
            "palabras": 1,
            "confianza": 0.99,
            "emocion": "neutral",
            "emocion_intensidad": 0.3
        },
        {
            "id": 11,
            "speaker": "agente",
            "timestamp_inicio": 61,
            "timestamp_fin": 63.5,
            "texto": "Tambi√©n tengo un cr√©dito... s√≠ diga.",
            "palabras": 6,
            "confianza": 0.99,
            "emocion": "neutral",
            "emocion_intensidad": 0.4
        },
        {
            "id": 12,
            "speaker": "cliente",
            "timestamp_inicio": 64,
            "timestamp_fin": 66,
            "texto": "Ya, no, siga, siga.",
            "palabras": 4,
            "confianza": 0.99,
            "emocion": "positivo",
            "emocion_intensidad": 0.5
        },
        {
            "id": 13,
            "speaker": "agente",
            "timestamp_inicio": 107,
            "timestamp_fin": 120,
            "texto": "Vale, tambi√©n tengo un cr√©dito que termina en 6564 que tiene una deuda total de 16,809 pesos, pero si paga solamente 10,607 pesos quedar√≠a saldado el cr√©dito.",
            "palabras": 27,
            "confianza": 0.98,
            "emocion": "neutral",
            "emocion_intensidad": 0.4
        },
        {
            "id": 14,
            "speaker": "cliente",
            "timestamp_inicio": 145,
            "timestamp_fin": 148.5,
            "texto": "Ayer pagu√© uno de 16, quedan 10 mil y algo.",
            "palabras": 9,
            "confianza": 0.99,
            "emocion": "interesado",
            "emocion_intensidad": 0.6
        },
        {
            "id": 15,
            "speaker": "agente",
            "timestamp_inicio": 151,
            "timestamp_fin": 161,
            "texto": "El de 16,000 pagar√≠a 10,607 y saldar√≠a...",
            "palabras": 7,
            "confianza": 0.99,
            "emocion": "neutral",
            "emocion_intensidad": 0.4
        },
        {
            "id": 16,
            "speaker": "cliente",
            "timestamp_inicio": 162,
            "timestamp_fin": 168,
            "texto": "S√≠, eso fue lo que pagu√© ayer y me queda uno de 16 creo, porque eran dos.",
            "palabras": 15,
            "confianza": 0.99,
            "emocion": "neutral",
            "emocion_intensidad": 0.5
        },
        {
            "id": 17,
            "speaker": "agente",
            "timestamp_inicio": 171,
            "timestamp_fin": 175,
            "texto": "Vale, tiene... yo veo aqu√≠ que tiene, ah okay, el que termina en 8512.",
            "palabras": 14,
            "confianza": 0.95,
            "emocion": "neutral",
            "emocion_intensidad": 0.4
        },
        {
            "id": 18,
            "speaker": "cliente",
            "timestamp_inicio": 175.5,
            "timestamp_fin": 176.5,
            "texto": "S√≠.",
            "palabras": 1,
            "confianza": 0.99,
            "emocion": "neutral",
            "emocion_intensidad": 0.3
        },
        {
            "id": 19,
            "speaker": "agente",
            "timestamp_inicio": 177,
            "timestamp_fin": 181,
            "texto": "Aj√°, s√≠, ese. ¬øY ese c√≥mo hizo el pago, se√±ora Yessenia?",
            "palabras": 10,
            "confianza": 0.99,
            "emocion": "interesado",
            "emocion_intensidad": 0.5
        },
        {
            "id": 20,
            "speaker": "cliente",
            "timestamp_inicio": 182,
            "timestamp_fin": 183,
            "texto": "¬øPerd√≥n?",
            "palabras": 1,
            "confianza": 0.99,
            "emocion": "confundido",
            "emocion_intensidad": 0.4
        },
        {
            "id": 21,
            "speaker": "agente",
            "timestamp_inicio": 184,
            "timestamp_fin": 186,
            "texto": "¬øC√≥mo hizo el pago de ese cr√©dito?",
            "palabras": 7,
            "confianza": 0.99,
            "emocion": "neutral",
            "emocion_intensidad": 0.4
        },
        {
            "id": 22,
            "speaker": "cliente",
            "timestamp_inicio": 187,
            "timestamp_fin": 188,
            "texto": "Por la APP.",
            "palabras": 3,
            "confianza": 0.99,
            "emocion": "neutral",
            "emocion_intensidad": 0.5
        },
        {
            "id": 23,
            "speaker": "cliente",
            "timestamp_inicio": 190,
            "timestamp_fin": 195,
            "texto": "S√≠, me sali√≥ en oferta y...",
            "palabras": 6,
            "confianza": 0.98,
            "emocion": "positivo",
            "emocion_intensidad": 0.5
        },
        {
            "id": 24,
            "speaker": "agente",
            "timestamp_inicio": 196,
            "timestamp_fin": 201,
            "texto": "Pero entonces le quedar√≠an tres cr√©ditos, se√±ora Yessenia.",
            "palabras": 8,
            "confianza": 0.99,
            "emocion": "neutral",
            "emocion_intensidad": 0.4
        },
        {
            "id": 25,
            "speaker": "cliente",
            "timestamp_inicio": 202,
            "timestamp_fin": 208,
            "texto": "S√≠, tres solamente. Bueno, yo creo que ma√±ana pago el otro de 16 y me quedar√≠an los dos grandes.",
            "palabras": 18,
            "confianza": 0.98,
            "emocion": "positivo",
            "emocion_intensidad": 0.6
        },
        {
            "id": 26,
            "speaker": "agente",
            "timestamp_inicio": 209,
            "timestamp_fin": 215,
            "texto": "Exacto, se quedar√≠a con los dos grandes. Vale, igual lo estar√≠a pagando por la aplicaci√≥n se√±ora Yessenia.",
            "palabras": 17,
            "confianza": 0.99,
            "emocion": "positivo",
            "emocion_intensidad": 0.5
        },
        {
            "id": 27,
            "speaker": "cliente",
            "timestamp_inicio": 216,
            "timestamp_fin": 218,
            "texto": "S√≠, porque igual son cuotas.",
            "palabras": 5,
            "confianza": 0.99,
            "emocion": "neutral",
            "emocion_intensidad": 0.4
        },
        {
            "id": 28,
            "speaker": "agente",
            "timestamp_inicio": 219,
            "timestamp_fin": 224,
            "texto": "Vale, entonces yo voy a colocar que estar√≠a pagando eso y quedar√≠an entonces los m√°s grandes que bueno, poco a poco los va a ir pagando se√±ora Yessenia, ¬øs√≠?",
            "palabras": 28,
            "confianza": 0.97,
            "emocion": "positivo",
            "emocion_intensidad": 0.6
        },
        {
            "id": 29,
            "speaker": "cliente",
            "timestamp_inicio": 225,
            "timestamp_fin": 235,
            "texto": "S√≠, s√≠, s√≠. Incluso ayer hab√≠a hablado por WhatsApp para ver si pod√≠a hacer como juntar esas dos deudas y hacer una sola.",
            "palabras": 23,
            "confianza": 0.98,
            "emocion": "interesado",
            "emocion_intensidad": 0.6
        },
        {
            "id": 30,
            "speaker": "agente",
            "timestamp_inicio": 236,
            "timestamp_fin": 250,
            "texto": "Eso tendr√≠a que ir directamente en la oficina. Ser√≠a una repactaci√≥n de los cr√©ditos, pero s√≠ tiene que ir directamente a la sucursal para poder hacerlo.",
            "palabras": 25,
            "confianza": 0.98,
            "emocion": "neutral",
            "emocion_intensidad": 0.5
        },
        {
            "id": 31,
            "speaker": "cliente",
            "timestamp_inicio": 251,
            "timestamp_fin": 252.5,
            "texto": "Ah, ya, okay.",
            "palabras": 3,
            "confianza": 0.99,
            "emocion": "aliviado",
            "emocion_intensidad": 0.5
        },
        {
            "id": 32,
            "speaker": "agente",
            "timestamp_inicio": 253,
            "timestamp_fin": 257,
            "texto": "Si quiere puede aprovechar la oferta, pero tendr√≠a que ser antes del viernes para que aproveche la oferta que tenemos ac√°, ¬øs√≠?",
            "palabras": 22,
            "confianza": 0.98,
            "emocion": "interesado",
            "emocion_intensidad": 0.6
        },
        {
            "id": 33,
            "speaker": "cliente",
            "timestamp_inicio": 257.5,
            "timestamp_fin": 258.5,
            "texto": "Ya.",
            "palabras": 1,
            "confianza": 0.99,
            "emocion": "neutral",
            "emocion_intensidad": 0.3
        },
        {
            "id": 34,
            "speaker": "agente",
            "timestamp_inicio": 260,
            "timestamp_fin": 262,
            "texto": "¬øS√≠ tendr√≠a disponibilidad se√±ora Yessenia?",
            "palabras": 5,
            "confianza": 0.99,
            "emocion": "interesado",
            "emocion_intensidad": 0.5
        },
        {
            "id": 35,
            "speaker": "cliente",
            "timestamp_inicio": 263,
            "timestamp_fin": 266.5,
            "texto": "Yo creo que s√≠, eso del 120 y ¬øcu√°nto me dijo? ¬ø128?",
            "palabras": 11,
            "confianza": 0.99,
            "emocion": "interesado",
            "emocion_intensidad": 0.6
        },
        {
            "id": 36,
            "speaker": "agente",
            "timestamp_inicio": 267,
            "timestamp_fin": 271,
            "texto": "128,888. Uno es por 128.",
            "palabras": 5,
            "confianza": 0.99,
            "emocion": "neutral",
            "emocion_intensidad": 0.4
        },
        {
            "id": 37,
            "speaker": "cliente",
            "timestamp_inicio": 272,
            "timestamp_fin": 275,
            "texto": "¬øEse est√° para el d√≠a s√°bado o no?",
            "palabras": 8,
            "confianza": 0.99,
            "emocion": "interesado",
            "emocion_intensidad": 0.6
        },
        {
            "id": 38,
            "speaker": "agente",
            "timestamp_inicio": 280,
            "timestamp_fin": 281,
            "texto": "S√≠, s√≠, para el d√≠a s√°bado s√≠.",
            "palabras": 7,
            "confianza": 0.99,
            "emocion": "positivo",
            "emocion_intensidad": 0.6
        },
        {
            "id": 39,
            "speaker": "cliente",
            "timestamp_inicio": 281.5,
            "timestamp_fin": 284,
            "texto": "Ese es el mismo que me sale por la p√°gina, ¬øverdad?",
            "palabras": 10,
            "confianza": 0.99,
            "emocion": "neutral",
            "emocion_intensidad": 0.4
        },
        {
            "id": 40,
            "speaker": "agente",
            "timestamp_inicio": 285,
            "timestamp_fin": 291,
            "texto": "Por la p√°gina, s√≠. Lo que yo voy a hacer es bloquearlo para que ya para el s√°bado tenga ese mismo monto y no se lo cambien.",
            "palabras": 25,
            "confianza": 0.98,
            "emocion": "positivo",
            "emocion_intensidad": 0.7
        },
        {
            "id": 41,
            "speaker": "cliente",
            "timestamp_inicio": 292,
            "timestamp_fin": 302,
            "texto": "Ya. Okay, okay. S√≠ yo creo que el s√°bado cancelo ese de 128 y ya me quedar√≠a el otro nom√°s.",
            "palabras": 19,
            "confianza": 0.98,
            "emocion": "aliviado",
            "emocion_intensidad": 0.7
        },
        {
            "id": 42,
            "speaker": "agente",
            "timestamp_inicio": 302.5,
            "timestamp_fin": 305,
            "texto": "Exacto, con el favor de Dios, poco a poco, se√±ora Yessenia.",
            "palabras": 10,
            "confianza": 0.99,
            "emocion": "positivo",
            "emocion_intensidad": 0.7
        },
        {
            "id": 43,
            "speaker": "cliente",
            "timestamp_inicio": 305.5,
            "timestamp_fin": 306.5,
            "texto": "Poco a poco. Gracias.",
            "palabras": 4,
            "confianza": 0.99,
            "emocion": "positivo",
            "emocion_intensidad": 0.6
        },
        {
            "id": 44,
            "speaker": "agente",
            "timestamp_inicio": 307,
            "timestamp_fin": 312,
            "texto": "Dale, ya coloco esa informaci√≥n por aqu√≠ y cualquier cosa estamos a la orden se√±ora Yessenia.",
            "palabras": 16,
            "confianza": 0.99,
            "emocion": "positivo",
            "emocion_intensidad": 0.6
        },
        {
            "id": 45,
            "speaker": "cliente",
            "timestamp_inicio": 313,
            "timestamp_fin": 315,
            "texto": "Ya, muchas gracias.",
            "palabras": 3,
            "confianza": 0.99,
            "emocion": "positivo",
            "emocion_intensidad": 0.6
        },
        {
            "id": 46,
            "speaker": "agente",
            "timestamp_inicio": 316,
            "timestamp_fin": 317.5,
            "texto": "Much√≠simas gracias, feliz d√≠a.",
            "palabras": 4,
            "confianza": 0.99,
            "emocion": "positivo",
            "emocion_intensidad": 0.7
        },
        {
            "id": 47,
            "speaker": "cliente",
            "timestamp_inicio": 318,
            "timestamp_fin": 319,
            "texto": "Igual.",
            "palabras": 1,
            "confianza": 0.99,
            "emocion": "positivo",
            "emocion_intensidad": 0.5
        },
        {
            "id": 48,
            "speaker": "agente",
            "timestamp_inicio": 320,
            "timestamp_fin": 321,
            "texto": "Dale, hasta luego.",
            "palabras": 3,
            "confianza": 0.99,
            "emocion": "neutral",
            "emocion_intensidad": 0.4
        }
    ],
    "estadisticas_basicas": {
        "total_segmentos": 49,
        "segmentos_agente": 25,
        "segmentos_cliente": 24,
        "palabras_totales": 526,
        "palabras_agente": 366,
        "palabras_cliente": 160,
        "confianza_promedio": 0.98
    },
    "metricas_conversacion": {
        "ratio_habla_agente": 0.69,
        "turnos_conversacion": 49,
        "duracion_promedio_turno_agente": 5.4,
        "duracion_promedio_turno_cliente": 2.9,
        "interrupciones": [
            {
                "timestamp": 61,
                "descripcion": "El agente contin√∫a hablando mientras el cliente intenta intervenir."
            }
        ],
        "silencios_prolongados": [
            {
                "timestamp_inicio": 66,
                "duracion_segundos": 41,
                "contexto": "Gap significativo en la grabaci√≥n/transcripci√≥n de audio entre ofertas."
            }
        ]
    },
    "analisis_emocional": {
        "agente": {
            "emocion_dominante": "positivo",
            "distribucion": {
                "neutral": 0.48,
                "positivo": 0.4,
                "interesado": 0.12
            },
            "intensidad_promedio": 0.52
        },
        "cliente": {
            "emocion_dominante": "neutral",
            "distribucion": {
                "neutral": 0.46,
                "positivo": 0.25,
                "interesado": 0.21,
                "aliviado": 0.08
            },
            "intensidad_promedio": 0.48
        },
        "evolucion_cliente": "mejoro",
        "momentos_criticos": [
            {
                "timestamp": 145,
                "tipo": "revelacion_situacion",
                "descripcion": "Cliente revela que ya est√° pagando activamente sus deudas por cuenta propia.",
                "emocion_antes": "neutral",
                "emocion_despues": "interesado",
                "impacto": "medio"
            },
            {
                "timestamp": 302,
                "tipo": "aceptacion",
                "descripcion": "Cliente confirma compromiso de pago para el s√°bado por el monto de 128k.",
                "emocion_antes": "interesado",
                "emocion_despues": "aliviado",
                "impacto": "alto"
            }
        ]
    },
    "speaker_mapping": {
        "SPEAKER_00": "agente",
        "SPEAKER_01": "cliente",
        "confidence": 0.99,
        "method": "first_speaker_identifies_company"
    }
}
</file>

<file path="docs/ag1_transcriptor/paso3_transcripcion_whisper.md">
# Paso 3: Transcripci√≥n con Whisper

## Configuraci√≥n de AI Studio / Whisper

### Request a AI Studio

```json
{
  "audio_url": "https://drive.google.com/uc?export=download&id=FILE_ID",
  "config": {
    "model": "whisper-large-v3",
    "language": "es",
    "task": "transcribe",
    "diarization": {
      "enabled": true,
      "min_speakers": 2,
      "max_speakers": 2
    },
    "timestamps": {
      "granularity": "word",
      "include_confidence": true
    },
    "output_format": "verbose_json"
  },
  "prompt": "Ver secci√≥n PROMPT DE CONTEXTO abajo"
}
```

---

## Prompt de Contexto para Transcripci√≥n

Whisper y servicios similares aceptan un **prompt de contexto** que mejora significativamente la precisi√≥n de la transcripci√≥n, especialmente para:
- Vocabulario t√©cnico del dominio
- Nombres propios y de empresas
- Formatos espec√≠ficos (montos, fechas)
- Estilo de puntuaci√≥n deseado

### Prompt de Contexto (Espa√±ol - Cobranzas)

```
CONTEXTO: Llamada telef√≥nica de gesti√≥n de cobranza entre un agente de call center y un cliente deudor en Per√∫/Latinoam√©rica.

VOCABULARIO DEL DOMINIO:
- T√©rminos financieros: saldo vencido, mora, intereses moratorios, capital, cuota, refinanciamiento, reestructuraci√≥n, pago parcial, pago total, abono, liquidaci√≥n
- Documentos: estado de cuenta, carta de cobranza, notificaci√≥n, acuerdo de pago
- Consecuencias: central de riesgo, infocorp, reporte negativo, acci√≥n legal, embargo
- M√©todos de pago: transferencia, dep√≥sito, agencia, app m√≥vil, banca por internet, Yape, Plin
- Moneda: soles, PEN, d√≥lares, USD

NOMBRES COMUNES:
- Banco Central, Banco de Cr√©dito, Interbank, BBVA, Scotiabank
- Se√±or/Se√±ora + apellidos peruanos comunes

FORMATO DE TRANSCRIPCI√ìN:
- Usar signos de interrogaci√≥n (¬ø?) y exclamaci√≥n (¬°!) correctamente en espa√±ol
- Escribir n√∫meros en palabras cuando se mencionan montos: "mil cuatrocientos cincuenta soles" ‚Üí "1,450 soles"
- Mantener muletillas naturales del habla: "este...", "eh...", "mire..."
- Separar claramente turnos de conversaci√≥n

CONTEXTO DE LA LLAMADA:
Esta es una llamada de cobranza donde el agente intenta obtener un compromiso de pago del cliente. El agente sigue un script que incluye: saludo, identificaci√≥n, verificaci√≥n de identidad, explicaci√≥n de la deuda, manejo de objeciones, negociaci√≥n y cierre.
```

### Prompt Corto (Si hay l√≠mite de caracteres)

```
Llamada de cobranza en espa√±ol (Per√∫). Vocabulario: saldo vencido, mora, intereses, cuota, refinanciamiento, central de riesgo, Infocorp. Montos en soles (PEN). Usar puntuaci√≥n espa√±ola correcta (¬ø?¬°!). Dos speakers: agente de cobranza y cliente deudor.
```

### Variables Din√°micas en el Prompt

Si el servicio permite, incluir datos espec√≠ficos de la llamada:

```
DATOS DE ESTA LLAMADA:
- Agente: {nombre_agente}
- Empresa: {nombre_empresa}
- Cliente: {nombre_cliente} (si se conoce)
- Tipo de deuda: {tipo_deuda}
- Monto aproximado: {monto_deuda} {moneda}
```

---

## Request Completo con Prompt

```json
{
  "audio_url": "https://drive.google.com/uc?export=download&id=FILE_ID",
  "config": {
    "model": "whisper-large-v3",
    "language": "es",
    "task": "transcribe",
    "diarization": {
      "enabled": true,
      "min_speakers": 2,
      "max_speakers": 2
    },
    "timestamps": {
      "granularity": "word",
      "include_confidence": true
    },
    "output_format": "verbose_json"
  },
  "prompt": "Llamada de cobranza en espa√±ol (Per√∫). Vocabulario: saldo vencido, mora, intereses moratorios, cuota, refinanciamiento, central de riesgo, Infocorp, acuerdo de pago. M√©todos: Yape, Plin, transferencia, agencia. Montos en soles (PEN). Usar puntuaci√≥n espa√±ola (¬ø?¬°!). Dos speakers: agente de call center y cliente deudor. Agente: Mar√≠a Gonz√°lez, Banco Central. Monto: 1,450 soles."
}
```

### Par√°metros Importantes

| Par√°metro | Valor | Raz√≥n |
|-----------|-------|-------|
| `model` | `whisper-large-v3` | Mejor precisi√≥n en espa√±ol |
| `language` | `es` | Forzar espa√±ol (no auto-detect) |
| `diarization.enabled` | `true` | Separar agente de cliente |
| `diarization.min_speakers` | `2` | Siempre hay 2 speakers |
| `timestamps.granularity` | `word` | Precisi√≥n para emociones |
| `prompt` | Ver arriba | Mejora precisi√≥n con vocabulario del dominio |

---

## (Opcional) Post-Procesamiento con LLM

Si la transcripci√≥n de Whisper tiene errores o necesita correcci√≥n, se puede usar un LLM para limpiarla:

### Prompt de Correcci√≥n de Transcripci√≥n

**System Prompt:**
```
Eres un corrector de transcripciones de llamadas de cobranza en espa√±ol latinoamericano (Per√∫).

Tu tarea es corregir errores de transcripci√≥n autom√°tica SIN cambiar el significado ni las palabras dichas. Solo debes:

1. Corregir errores ortogr√°ficos obvios causados por la transcripci√≥n autom√°tica
2. Corregir puntuaci√≥n (agregar ¬ø? y ¬°! donde corresponda)
3. Corregir capitalizaci√≥n (nombres propios, inicio de oraci√≥n)
4. Corregir n√∫meros mal transcritos (ej: "mil cuatrocientos" ‚Üí "1,400")
5. Mantener muletillas y expresiones naturales del habla
6. NO agregar ni quitar palabras
7. NO cambiar el orden de las palabras
8. NO "mejorar" el estilo

VOCABULARIO CORRECTO DEL DOMINIO:
- Infocorp (no "info corp", "infocorps")
- soles (moneda peruana)
- mora (no "demora" si se refiere a estado de deuda)
- refinanciamiento (no "refinanciaci√≥n")
- Yape, Plin (apps de pago)
```

**User Prompt:**
```
Corrige la siguiente transcripci√≥n de una llamada de cobranza. Mant√©n el formato de segmentos.

TRANSCRIPCI√ìN ORIGINAL:
{transcripcion_whisper}

CONTEXTO:
- Agente: {nombre_agente}
- Empresa: {nombre_empresa}
- Monto de deuda: {monto_deuda} soles

Devuelve la transcripci√≥n corregida en el mismo formato JSON, indicando qu√© correcciones hiciste.
```

**Formato de Respuesta:**
```json
{
  "transcripcion_corregida": {
    "text": "...",
    "segments": [...]
  },
  "correcciones_realizadas": [
    {
      "original": "infocorps",
      "corregido": "Infocorp",
      "tipo": "ortografia_dominio"
    },
    {
      "original": "mil cuatrocientos soles",
      "corregido": "1,400 soles",
      "tipo": "formato_numero"
    }
  ],
  "confianza_correccion": 0.95
}
```

### Cu√°ndo Usar Post-Procesamiento

| Condici√≥n | Acci√≥n |
|-----------|--------|
| Confianza Whisper > 0.9 | No necesita correcci√≥n |
| Confianza Whisper 0.7-0.9 | Correcci√≥n opcional |
| Confianza Whisper < 0.7 | Correcci√≥n recomendada |
| Audio con ruido | Correcci√≥n recomendada |
| T√©rminos t√©cnicos detectados | Verificar vocabulario |

---

## Formato de Salida Esperado (Whisper)

```json
{
  "text": "Buenos d√≠as, ¬øhablo con el se√±or Garc√≠a? S√≠, soy yo. ¬øDe d√≥nde me llama?...",
  "language": "es",
  "duration": 255.4,
  "segments": [
    {
      "id": 0,
      "start": 0.0,
      "end": 3.2,
      "text": "Buenos d√≠as, ¬øhablo con el se√±or Garc√≠a?",
      "speaker": "SPEAKER_00",
      "words": [
        {"word": "Buenos", "start": 0.0, "end": 0.4, "confidence": 0.98},
        {"word": "d√≠as", "start": 0.4, "end": 0.8, "confidence": 0.99},
        {"word": "¬øhablo", "start": 0.9, "end": 1.3, "confidence": 0.97},
        {"word": "con", "start": 1.3, "end": 1.5, "confidence": 0.99},
        {"word": "el", "start": 1.5, "end": 1.6, "confidence": 0.99},
        {"word": "se√±or", "start": 1.6, "end": 2.1, "confidence": 0.98},
        {"word": "Garc√≠a?", "start": 2.1, "end": 3.2, "confidence": 0.96}
      ],
      "avg_confidence": 0.98
    },
    {
      "id": 1,
      "start": 3.2,
      "end": 5.8,
      "text": "S√≠, soy yo. ¬øDe d√≥nde me llama?",
      "speaker": "SPEAKER_01",
      "words": [
        {"word": "S√≠,", "start": 3.2, "end": 3.5, "confidence": 0.99},
        {"word": "soy", "start": 3.5, "end": 3.8, "confidence": 0.99},
        {"word": "yo.", "start": 3.8, "end": 4.2, "confidence": 0.99},
        {"word": "¬øDe", "start": 4.4, "end": 4.7, "confidence": 0.98},
        {"word": "d√≥nde", "start": 4.7, "end": 5.1, "confidence": 0.97},
        {"word": "me", "start": 5.1, "end": 5.3, "confidence": 0.99},
        {"word": "llama?", "start": 5.3, "end": 5.8, "confidence": 0.98}
      ],
      "avg_confidence": 0.98
    }
  ]
}
```

---

## Post-Procesamiento: Mapear Speakers

Despu√©s de recibir la transcripci√≥n, debemos identificar qui√©n es el agente y qui√©n es el cliente.

### L√≥gica de Identificaci√≥n

```
REGLA 1: El que habla primero generalmente es el AGENTE (llamadas outbound)
REGLA 2: El que menciona el nombre de la empresa es el AGENTE
REGLA 3: El que pregunta "¬øhablo con...?" es el AGENTE
REGLA 4: El que confirma su identidad es el CLIENTE
```

### Mapeo Final

```json
{
  "speaker_mapping": {
    "SPEAKER_00": "agente",
    "SPEAKER_01": "cliente"
  },
  "confidence": 0.95,
  "method": "first_speaker_rule"
}
```

---

## Formato Transformado (Para Paso 5-6)

Despu√©s del mapeo de speakers, transformar a este formato:

```json
{
  "transcripcion_completa": "Buenos d√≠as, ¬øhablo con el se√±or Garc√≠a? S√≠, soy yo. ¬øDe d√≥nde me llama?...",
  "duracion_segundos": 255,
  "segmentos_raw": [
    {
      "id": 0,
      "speaker": "agente",
      "timestamp_inicio": 0.0,
      "timestamp_fin": 3.2,
      "texto": "Buenos d√≠as, ¬øhablo con el se√±or Garc√≠a?",
      "palabras": 7,
      "confianza": 0.98
    },
    {
      "id": 1,
      "speaker": "cliente",
      "timestamp_inicio": 3.2,
      "timestamp_fin": 5.8,
      "texto": "S√≠, soy yo. ¬øDe d√≥nde me llama?",
      "palabras": 7,
      "confianza": 0.98
    }
  ],
  "estadisticas_basicas": {
    "total_segmentos": 45,
    "segmentos_agente": 24,
    "segmentos_cliente": 21,
    "palabras_totales": 320,
    "confianza_promedio": 0.96
  }
}
```

---

## Manejo de Errores

| Error | Causa | Acci√≥n |
|-------|-------|--------|
| `audio_too_short` | Audio < 10 segundos | Rechazar, posible error de grabaci√≥n |
| `audio_too_long` | Audio > 30 minutos | Dividir en chunks de 10 min |
| `low_confidence` | Confianza < 0.7 | Marcar para revisi√≥n manual |
| `single_speaker` | Solo 1 speaker detectado | Forzar an√°lisis mono, alertar |
| `language_mismatch` | Audio no es espa√±ol | Intentar con auto-detect |

---

## Notas de Implementaci√≥n

1. **Timeout**: Configurar timeout de 5 minutos para audios largos
2. **Retry**: Si falla, reintentar 1 vez con modelo `whisper-medium`
3. **Cache**: No cachear transcripciones (cada audio es √∫nico)
4. **Cleanup**: Eliminar archivo temporal despu√©s de procesar
</file>

<file path="docs/ag1_transcriptor/paso3b_transformacion_whisper_llm.md">
# Paso 3b: Transformaci√≥n de Whisper a Formato Estructurado

## Problema

Whisper devuelve:
- Texto plano
- Timestamps por segmento
- Speakers gen√©ricos (SPEAKER_00, SPEAKER_01)

Necesitamos:
- JSON estructurado con segmentos
- Speakers mapeados (agente/cliente)
- Formato consistente para el siguiente paso

## Soluci√≥n: LLM de Transformaci√≥n

Usar **Claude Sonnet 4.5** para transformar la salida de Whisper al formato esperado.

---

## Prompt de Transformaci√≥n

### System Prompt

```
Eres un transformador de transcripciones de llamadas de cobranza. Tu tarea es convertir la salida cruda de Whisper (texto + timestamps + speakers gen√©ricos) en un JSON estructurado con speakers identificados (agente/cliente) y formato consistente.

REGLAS DE IDENTIFICACI√ìN DE SPEAKERS:
1. El primer speaker que habla generalmente es el AGENTE (llamadas outbound)
2. El speaker que menciona el nombre de la empresa es el AGENTE
3. El speaker que pregunta "¬øhablo con...?" o "¬øes usted...?" es el AGENTE
4. El speaker que confirma su identidad ("S√≠, soy yo") es el CLIENTE
5. El speaker que menciona t√©rminos de cobranza (mora, deuda, saldo) es el AGENTE
6. El speaker que menciona su situaci√≥n personal o econ√≥mica es el CLIENTE

FORMATO DE SALIDA:
Debes devolver un JSON con la estructura exacta especificada, sin texto adicional.
```

---

## User Prompt Template

```
Transforma la siguiente transcripci√≥n de Whisper al formato JSON estructurado requerido.

## DATOS DE CONTEXTO
- Agente esperado: {nombre_agente}
- Empresa: {nombre_empresa}
- Cliente: {cliente_ref}

## SALIDA DE WHISPER
{whisper_output_json}

## INSTRUCCIONES

1. **Identificar Speakers:**
   - Analiza qui√©n es el agente y qui√©n es el cliente bas√°ndote en:
     * Contenido del mensaje (t√©rminos de cobranza, identificaci√≥n de empresa)
     * Orden de aparici√≥n
     * Tipo de preguntas/respuestas
   - Mapea SPEAKER_00 y SPEAKER_01 a "agente" o "cliente"

2. **Estructurar Segmentos:**
   - Cada segmento debe tener:
     * id (secuencial, empezando en 0)
     * speaker ("agente" o "cliente")
     * timestamp_inicio (n√∫mero decimal en segundos)
     * timestamp_fin (n√∫mero decimal en segundos)
     * texto (texto limpio del segmento)
     * palabras (conteo de palabras en el texto)
     * confianza (si Whisper la proporcion√≥, sino null)

3. **Calcular Estad√≠sticas:**
   - Total de segmentos
   - Segmentos por speaker
   - Palabras totales
   - Confianza promedio

4. **Validar:**
   - Todos los segmentos deben tener speaker v√°lido ("agente" o "cliente")
   - Timestamps deben ser crecientes
   - No debe haber gaps mayores a 30 segundos sin explicaci√≥n

## FORMATO DE RESPUESTA (JSON)

```json
{
  "transcripcion_completa": "texto completo de la llamada...",
  "duracion_segundos": 255.4,
  "segmentos_raw": [
    {
      "id": 0,
      "speaker": "agente",
      "timestamp_inicio": 0.0,
      "timestamp_fin": 3.2,
      "texto": "Buenos d√≠as, ¬øhablo con el se√±or Garc√≠a?",
      "palabras": 7,
      "confianza": 0.98
    },
    {
      "id": 1,
      "speaker": "cliente",
      "timestamp_inicio": 3.2,
      "timestamp_fin": 5.8,
      "texto": "S√≠, soy yo. ¬øDe d√≥nde me llama?",
      "palabras": 7,
      "confianza": 0.97
    }
  ],
  "estadisticas_basicas": {
    "total_segmentos": 45,
    "segmentos_agente": 24,
    "segmentos_cliente": 21,
    "palabras_totales": 320,
    "palabras_agente": 215,
    "palabras_cliente": 105,
    "confianza_promedio": 0.96
  },
  "speaker_mapping": {
    "SPEAKER_00": "agente",
    "SPEAKER_01": "cliente",
    "confidence": 0.95,
    "method": "first_speaker_identifies_company"
  }
}
```

Responde √öNICAMENTE con el JSON, sin texto adicional.
```

---

## Ejemplo Completo

### Input: Salida de Whisper

```json
{
  "text": "Buenos d√≠as, ¬øhablo con el se√±or Garc√≠a? S√≠, soy yo. ¬øDe d√≥nde me llama? Buenos d√≠as se√±or Garc√≠a, le habla Mar√≠a Gonz√°lez del banco Central...",
  "language": "es",
  "duration": 255.4,
  "segments": [
    {
      "id": 0,
      "start": 0.0,
      "end": 3.2,
      "text": "Buenos d√≠as, ¬øhablo con el se√±or Garc√≠a?",
      "speaker": "SPEAKER_00",
      "words": [
        {"word": "Buenos", "start": 0.0, "end": 0.4, "confidence": 0.98},
        {"word": "d√≠as", "start": 0.4, "end": 0.8, "confidence": 0.99}
      ]
    },
    {
      "id": 1,
      "start": 3.2,
      "end": 5.8,
      "text": "S√≠, soy yo. ¬øDe d√≥nde me llama?",
      "speaker": "SPEAKER_01",
      "words": [
        {"word": "S√≠,", "start": 3.2, "end": 3.5, "confidence": 0.99},
        {"word": "soy", "start": 3.5, "end": 3.8, "confidence": 0.99}
      ]
    },
    {
      "id": 2,
      "start": 5.8,
      "end": 15.5,
      "text": "Buenos d√≠as se√±or Garc√≠a, le habla Mar√≠a Gonz√°lez del banco Central. Le llamo por un tema importante sobre su cuenta.",
      "speaker": "SPEAKER_00",
      "words": [...]
    }
  ]
}
```

### Prompt Enviado al LLM

```
Transforma la siguiente transcripci√≥n de Whisper al formato JSON estructurado requerido.

## DATOS DE CONTEXTO
- Agente esperado: Mar√≠a Gonz√°lez
- Empresa: Banco Central
- Cliente: CL-45632

## SALIDA DE WHISPER
{
  "text": "Buenos d√≠as, ¬øhablo con el se√±or Garc√≠a? S√≠, soy yo...",
  "duration": 255.4,
  "segments": [
    {"id": 0, "start": 0.0, "end": 3.2, "text": "Buenos d√≠as, ¬øhablo con el se√±or Garc√≠a?", "speaker": "SPEAKER_00"},
    {"id": 1, "start": 3.2, "end": 5.8, "text": "S√≠, soy yo. ¬øDe d√≥nde me llama?", "speaker": "SPEAKER_01"},
    {"id": 2, "start": 5.8, "end": 15.5, "text": "Buenos d√≠as se√±or Garc√≠a, le habla Mar√≠a Gonz√°lez del banco Central...", "speaker": "SPEAKER_00"}
  ]
}

## INSTRUCCIONES
[Ver prompt completo arriba]
```

### Output del LLM

```json
{
  "transcripcion_completa": "Buenos d√≠as, ¬øhablo con el se√±or Garc√≠a? S√≠, soy yo. ¬øDe d√≥nde me llama? Buenos d√≠as se√±or Garc√≠a, le habla Mar√≠a Gonz√°lez del banco Central. Le llamo por un tema importante sobre su cuenta. ¬øMe permite unos minutos? S√≠, d√≠game. Se√±or Garc√≠a, tenemos registrado un saldo vencido de 1,450 soles que venci√≥ el 15 de diciembre...",
  "duracion_segundos": 255.4,
  "segmentos_raw": [
    {
      "id": 0,
      "speaker": "agente",
      "timestamp_inicio": 0.0,
      "timestamp_fin": 3.2,
      "texto": "Buenos d√≠as, ¬øhablo con el se√±or Garc√≠a?",
      "palabras": 7,
      "confianza": 0.98
    },
    {
      "id": 1,
      "speaker": "cliente",
      "timestamp_inicio": 3.2,
      "timestamp_fin": 5.8,
      "texto": "S√≠, soy yo. ¬øDe d√≥nde me llama?",
      "palabras": 7,
      "confianza": 0.99
    },
    {
      "id": 2,
      "speaker": "agente",
      "timestamp_inicio": 5.8,
      "timestamp_fin": 15.5,
      "texto": "Buenos d√≠as se√±or Garc√≠a, le habla Mar√≠a Gonz√°lez del banco Central. Le llamo por un tema importante sobre su cuenta.",
      "palabras": 18,
      "confianza": 0.97
    }
  ],
  "estadisticas_basicas": {
    "total_segmentos": 14,
    "segmentos_agente": 8,
    "segmentos_cliente": 6,
    "palabras_totales": 285,
    "palabras_agente": 195,
    "palabras_cliente": 90,
    "confianza_promedio": 0.96
  },
  "speaker_mapping": {
    "SPEAKER_00": "agente",
    "SPEAKER_01": "cliente",
    "confidence": 0.98,
    "method": "first_speaker_identifies_company",
    "evidencia": [
      "SPEAKER_00 pregunta '¬øhablo con el se√±or Garc√≠a?' (patr√≥n de agente)",
      "SPEAKER_00 menciona 'Mar√≠a Gonz√°lez del banco Central' (identificaci√≥n de agente)",
      "SPEAKER_01 confirma identidad 'S√≠, soy yo' (patr√≥n de cliente)"
    ]
  }
}
```

---

## Implementaci√≥n en Saturn Studio

### Nodo: Transform Whisper Output

```yaml
node_type: llm_request
name: transform_whisper_output
config:
  provider: anthropic
  model: claude-sonnet-4-5-20250514
  temperature: 0.1
  max_tokens: 2000
  timeout: 30000
  
input:
  system_prompt: |
    Eres un transformador de transcripciones de llamadas de cobranza...
    [system prompt completo]
  
  user_prompt: |
    Transforma la siguiente transcripci√≥n de Whisper al formato JSON estructurado requerido.
    
    ## DATOS DE CONTEXTO
    - Agente esperado: {{input.metadata.nombre_agente}}
    - Empresa: {{input.metadata.nombre_empresa}}
    - Cliente: {{input.cliente_ref}}
    
    ## SALIDA DE WHISPER
    {{whisper_output | json}}
    
    ## INSTRUCCIONES
    [instrucciones completas]
  
  variables:
    whisper_output: "{{previous_node.output}}"
    nombre_agente: "{{agente.nombre}}"
    nombre_empresa: "Banco Central"
    cliente_ref: "{{input.cliente_ref}}"

output:
  parse_json: true
  validate_schema: true
  on_error:
    action: retry
    max_attempts: 2
    fallback: use_whisper_raw_with_default_mapping
```

---

## Validaci√≥n Post-Transformaci√≥n

```python
def validate_transformed_output(output):
    """Validar que la transformaci√≥n sea correcta"""
    
    errors = []
    
    # 1. Verificar que todos los segmentos tengan speaker v√°lido
    for seg in output.get('segmentos_raw', []):
        if seg.get('speaker') not in ['agente', 'cliente']:
            errors.append(f"Segmento {seg.get('id')} tiene speaker inv√°lido: {seg.get('speaker')}")
    
    # 2. Verificar que timestamps sean crecientes
    prev_end = 0
    for seg in sorted(output.get('segmentos_raw', []), key=lambda x: x.get('timestamp_inicio', 0)):
        if seg.get('timestamp_inicio', 0) < prev_end:
            errors.append(f"Segmento {seg.get('id')} tiene timestamp_inicio antes del anterior")
        prev_end = seg.get('timestamp_fin', 0)
    
    # 3. Verificar que estad√≠sticas sean consistentes
    stats = output.get('estadisticas_basicas', {})
    total_seg = stats.get('segmentos_agente', 0) + stats.get('segmentos_cliente', 0)
    if total_seg != stats.get('total_segmentos', 0):
        errors.append("Total de segmentos no coincide con suma de agente + cliente")
    
    # 4. Verificar que speaker_mapping tenga ambos speakers
    mapping = output.get('speaker_mapping', {})
    if 'SPEAKER_00' not in mapping or 'SPEAKER_01' not in mapping:
        errors.append("Speaker mapping incompleto")
    
    return {
        "valid": len(errors) == 0,
        "errors": errors
    }
```

---

## Flujo Completo Actualizado

```
1. Whisper ‚Üí Texto + Timestamps + SPEAKER_00/SPEAKER_01
2. LLM Transform ‚Üí JSON estructurado con agente/cliente identificados
3. AI Studio Emociones ‚Üí Emociones por segmento
4. LLM Extracci√≥n ‚Üí Entidades + M√©tricas
```

---

## Alternativa: Reglas Simples (Si LLM es muy costoso)

Si el volumen es muy alto y necesitas reducir costos, puedes usar reglas heur√≠sticas:

```python
def map_speakers_simple(whisper_output, agente_nombre, empresa_nombre):
    """Mapeo simple basado en reglas"""
    
    mapping = {}
    segments = whisper_output.get('segments', [])
    
    # Regla 1: El que habla primero es agente (outbound)
    first_speaker = segments[0].get('speaker') if segments else None
    
    # Regla 2: El que menciona el nombre de la empresa
    for seg in segments:
        text = seg.get('text', '').lower()
        if empresa_nombre.lower() in text or agente_nombre.lower() in text:
            mapping[seg.get('speaker')] = 'agente'
            break
    
    # Regla 3: El que pregunta "¬øhablo con...?"
    for seg in segments:
        if '¬øhablo con' in seg.get('text', '').lower() or '¬øes usted' in seg.get('text', '').lower():
            mapping[seg.get('speaker')] = 'agente'
            break
    
    # Si no se identific√≥, usar regla del primer speaker
    if first_speaker and first_speaker not in mapping:
        mapping[first_speaker] = 'agente'
    
    # El otro speaker es cliente
    all_speakers = set(seg.get('speaker') for seg in segments)
    for speaker in all_speakers:
        if speaker not in mapping:
            mapping[speaker] = 'cliente'
    
    return mapping
```

**Recomendaci√≥n:** Usar LLM para mayor precisi√≥n, especialmente cuando:
- Hay m√∫ltiples speakers que cambian
- El audio tiene ruido
- Los patrones no son claros

---

## Costo Estimado

| Modelo | Tokens Input | Tokens Output | Costo por Llamada |
|--------|-------------|---------------|-------------------|
| Claude Sonnet 4.5 | ~500 | ~300 | ~$0.001 |
| Claude Haiku | ~500 | ~300 | ~$0.0003 |

Para 1000 llamadas/d√≠a: ~$1/d√≠a con Sonnet, ~$0.30/d√≠a con Haiku.
</file>

<file path="docs/ag1_transcriptor/paso4_emociones_config.md">
# Paso 4: An√°lisis de Emociones

## Configuraci√≥n de AI Studio - Emotion Analysis

### Request a AI Studio

```json
{
  "audio_url": "https://drive.google.com/uc?export=download&id=FILE_ID",
  "segments": [
    {"start": 0.0, "end": 3.2, "speaker": "agente"},
    {"start": 3.2, "end": 5.8, "speaker": "cliente"},
    {"start": 5.8, "end": 12.4, "speaker": "agente"}
  ],
  "config": {
    "model": "emotion-recognition-v2",
    "granularity": "segment",
    "emotions": ["neutral", "positive", "negative", "frustrated", "confused", "interested"],
    "include_confidence": true,
    "include_intensity": true
  }
}
```

### Categor√≠as de Emociones

| Emoci√≥n | C√≥digo | Descripci√≥n | Indicador en Cobranzas |
|---------|--------|-------------|------------------------|
| `neutral` | üòê | Sin carga emocional | Estado base, normal |
| `positive` | üòä | Tono positivo, amable | Buena receptividad |
| `negative` | üò† | Molestia, enojo | Riesgo de abandono |
| `frustrated` | üò§ | Frustraci√≥n evidente | Alta probabilidad de conflicto |
| `confused` | üòï | Confusi√≥n, duda | Necesita m√°s explicaci√≥n |
| `interested` | ü§î | Inter√©s, atenci√≥n | Oportunidad de cierre |

---

## Formato de Salida Esperado

```json
{
  "analysis_id": "emo-12345",
  "segments": [
    {
      "segment_id": 0,
      "start": 0.0,
      "end": 3.2,
      "speaker": "agente",
      "emotion": {
        "primary": "neutral",
        "confidence": 0.92,
        "intensity": 0.3,
        "secondary": null
      },
      "voice_features": {
        "pitch_mean": 145.2,
        "pitch_variance": 12.5,
        "energy": 0.65,
        "speech_rate": 148
      }
    },
    {
      "segment_id": 1,
      "start": 3.2,
      "end": 5.8,
      "speaker": "cliente",
      "emotion": {
        "primary": "neutral",
        "confidence": 0.88,
        "intensity": 0.25,
        "secondary": "confused"
      },
      "voice_features": {
        "pitch_mean": 165.8,
        "pitch_variance": 18.2,
        "energy": 0.58,
        "speech_rate": 135
      }
    },
    {
      "segment_id": 15,
      "start": 120.5,
      "end": 135.2,
      "speaker": "cliente",
      "emotion": {
        "primary": "frustrated",
        "confidence": 0.85,
        "intensity": 0.72,
        "secondary": "negative"
      },
      "voice_features": {
        "pitch_mean": 195.3,
        "pitch_variance": 45.8,
        "energy": 0.85,
        "speech_rate": 168
      }
    }
  ],
  "summary": {
    "agente": {
      "dominant_emotion": "neutral",
      "emotion_distribution": {
        "neutral": 0.75,
        "positive": 0.20,
        "negative": 0.05
      },
      "avg_intensity": 0.35,
      "speech_rate_avg": 148
    },
    "cliente": {
      "dominant_emotion": "neutral",
      "emotion_distribution": {
        "neutral": 0.55,
        "negative": 0.20,
        "frustrated": 0.15,
        "interested": 0.10
      },
      "avg_intensity": 0.45,
      "speech_rate_avg": 142
    }
  }
}
```

---

## M√©tricas de Voz Importantes

### Speech Rate (Palabras por Minuto)

| Rango | Interpretaci√≥n |
|-------|----------------|
| < 100 | Muy lento, posible desinter√©s |
| 100-140 | Normal, relajado |
| 140-160 | Activo, comprometido |
| 160-180 | R√°pido, posible ansiedad |
| > 180 | Muy r√°pido, agitaci√≥n o molestia |

### Pitch Variance (Variaci√≥n de Tono)

| Valor | Interpretaci√≥n |
|-------|----------------|
| < 10 | Mon√≥tono, aburrido/desinteresado |
| 10-25 | Normal, conversaci√≥n est√°ndar |
| 25-40 | Expresivo, engaged |
| > 40 | Alta variaci√≥n, posible emoci√≥n fuerte |

### Energy (Intensidad de Voz)

| Valor | Interpretaci√≥n |
|-------|----------------|
| < 0.3 | Muy bajo, susurrando o desganado |
| 0.3-0.5 | Normal bajo |
| 0.5-0.7 | Normal, conversaci√≥n activa |
| 0.7-0.85 | Alto, √©nfasis |
| > 0.85 | Muy alto, posible enojo o frustraci√≥n |

---

## Post-Procesamiento: Detecci√≥n de Momentos Cr√≠ticos

### Patrones a Detectar

```python
# Pseudoc√≥digo para detecci√≥n de momentos cr√≠ticos

momentos_criticos = []

for i, seg in enumerate(segments):
    # 1. Cambio emocional brusco del cliente
    if seg.speaker == "cliente" and i > 0:
        prev = segments[i-1]
        if prev.speaker == "cliente":
            if prev.emotion.primary == "neutral" and seg.emotion.primary in ["negative", "frustrated"]:
                momentos_criticos.append({
                    "tipo": "cambio_emocional_negativo",
                    "timestamp": seg.start,
                    "descripcion": f"Cliente pas√≥ de neutral a {seg.emotion.primary}",
                    "severidad": "alta"
                })
    
    # 2. Frustraci√≥n alta
    if seg.emotion.primary == "frustrated" and seg.emotion.intensity > 0.7:
        momentos_criticos.append({
            "tipo": "frustracion_alta",
            "timestamp": seg.start,
            "speaker": seg.speaker,
            "severidad": "critica"
        })
    
    # 3. Silencio prolongado despu√©s de pregunta del agente
    if seg.speaker == "agente" and "?" in seg.texto:
        next_seg = segments[i+1] if i+1 < len(segments) else None
        if next_seg and (next_seg.start - seg.end) > 3.0:  # m√°s de 3 segundos
            momentos_criticos.append({
                "tipo": "silencio_prolongado",
                "timestamp": seg.end,
                "duracion": next_seg.start - seg.end,
                "severidad": "media"
            })
```

---

## Formato Final Combinado con Transcripci√≥n

Despu√©s de pasos 3 y 4, combinar en:

```json
{
  "segmentos": [
    {
      "id": 0,
      "speaker": "agente",
      "timestamp_inicio": 0.0,
      "timestamp_fin": 3.2,
      "texto": "Buenos d√≠as, ¬øhablo con el se√±or Garc√≠a?",
      "palabras": 7,
      "confianza_transcripcion": 0.98,
      "emocion": "neutral",
      "emocion_confianza": 0.92,
      "emocion_intensidad": 0.3,
      "velocidad_habla": 148
    },
    {
      "id": 1,
      "speaker": "cliente",
      "timestamp_inicio": 3.2,
      "timestamp_fin": 5.8,
      "texto": "S√≠, soy yo. ¬øDe d√≥nde me llama?",
      "palabras": 7,
      "confianza_transcripcion": 0.98,
      "emocion": "neutral",
      "emocion_confianza": 0.88,
      "emocion_intensidad": 0.25,
      "velocidad_habla": 135
    }
  ],
  "momentos_criticos": [
    {
      "tipo": "cambio_emocional_negativo",
      "timestamp": 120.5,
      "descripcion": "Cliente pas√≥ de neutral a frustrated",
      "severidad": "alta"
    }
  ],
  "resumen_emocional": {
    "agente": {
      "emocion_dominante": "neutral",
      "distribucion": {"neutral": 0.75, "positive": 0.20, "negative": 0.05},
      "velocidad_promedio": 148
    },
    "cliente": {
      "emocion_dominante": "neutral",
      "distribucion": {"neutral": 0.55, "negative": 0.20, "frustrated": 0.15, "interested": 0.10},
      "velocidad_promedio": 142
    }
  }
}
```

---

## Alternativa: An√°lisis con LLM

Si AI Studio no tiene an√°lisis de emociones, se puede usar el LLM en el paso 5-6 para inferir emociones bas√°ndose en:
- Texto de la transcripci√≥n
- Puntuaci√≥n y signos (¬ø!, ...)
- Palabras clave emocionales
- Contexto de la conversaci√≥n

Ver `paso5_6_prompt_llm.md` para el prompt que incluye an√°lisis emocional basado en texto.
</file>

<file path="docs/ag1_transcriptor/paso5_6_prompt_llm.md">
# Paso 5-6: Prompt LLM para Extracci√≥n de Entidades y An√°lisis

## Modelo Recomendado

- **Modelo**: `claude-sonnet-4-5-20250514`
- **Temperature**: 0.1 (queremos consistencia, no creatividad)
- **Max Tokens**: 4000
- **Timeout**: 60 segundos

---

## Input del Paso Anterior

El input viene del paso 3-4 (Gemini) y ya incluye:
- ‚úÖ Transcripci√≥n completa
- ‚úÖ Segmentos con timestamps
- ‚úÖ Speakers identificados (agente/cliente)
- ‚úÖ Emociones por segmento
- ‚úÖ An√°lisis emocional general
- ‚úÖ Momentos cr√≠ticos detectados
- ‚úÖ Estad√≠sticas b√°sicas

**El LLM NO debe recalcular estos datos**, sino usarlos para extraer entidades y analizar patrones.

---

## System Prompt

```
Eres un experto analizador de llamadas de cobranzas. Tu tarea es extraer informaci√≥n estructurada de transcripciones de llamadas entre agentes de cobranza y clientes deudores.

CONTEXTO DEL NEGOCIO:
- Las llamadas son de gesti√≥n de cobranza de deudas (tarjetas de cr√©dito, pr√©stamos, etc.)
- El objetivo del agente es lograr un compromiso de pago del cliente
- Un "compromiso v√°lido" requiere: monto espec√≠fico + fecha espec√≠fica + VALIDACI√ìN EXPL√çCITA del cliente

REGLAS DE AN√ÅLISIS:
1. S√© objetivo y basa todo en evidencia textual exacta
2. Si algo no est√° claro, indica "no_detectado" en lugar de inferir
3. Los montos deben estar en la moneda mencionada (CLP, PEN, USD, MXN, COP, ARS)
4. Las fechas deben convertirse a formato ISO (YYYY-MM-DD) o descriptivo si no es espec√≠fica ("el s√°bado" ‚Üí "proximo_sabado")
5. Una validaci√≥n es EXPL√çCITA solo si el cliente dice claramente "s√≠ voy a pagar", "confirmo", "de acuerdo, pagar√©", "yo creo que el s√°bado cancelo", etc.
6. "ok", "entiendo", "lo voy a revisar", "ya" NO son validaciones expl√≠citas
7. USA el an√°lisis emocional proporcionado para enriquecer tu an√°lisis, no lo recalcules

Responde √öNICAMENTE con el JSON solicitado, sin texto adicional.
```

---

## User Prompt Template

```
Analiza la siguiente transcripci√≥n de una llamada de cobranza y extrae la informaci√≥n en el formato JSON especificado.

## DATOS DE CONTEXTO (si disponibles)
- Fecha de la llamada: {fecha_llamada}
- Agente: {nombre_agente}
- Cliente (referencia): {cliente_ref}
- Empresa de cobranza: {empresa_cobranza}
- Empresa acreedora: {empresa_acreedora}

## DATOS DE LA TRANSCRIPCI√ìN (del paso anterior)

### Transcripci√≥n Completa:
{transcripcion_completa}

### Segmentos con Emociones:
{segmentos_json}

### Estad√≠sticas B√°sicas (ya calculadas):
{estadisticas_basicas}

### An√°lisis Emocional (ya calculado):
{analisis_emocional}

## INSTRUCCIONES DE EXTRACCI√ìN

Extrae y estructura la siguiente informaci√≥n:

### 1. ENTIDADES
- **Montos mencionados**: deudas, ofertas de descuento, pagos parciales, totales a pagar
- **Fechas mencionadas**: vencimientos, compromisos de pago, plazos l√≠mite
- **M√©todos de pago**: app, web, sucursal, transferencia, etc.
- **Referencias de cr√©ditos**: n√∫meros de cuenta, IDs de cr√©dito
- **Objeciones del cliente**: razones para no pagar o postergar
- **Compromisos de pago**: expl√≠citos o impl√≠citos, con monto y fecha

### 2. DETECCI√ìN DE PATRONES DEL SCRIPT
Eval√∫a si el agente sigui√≥ el script est√°ndar de cobranza:
- Saludo correcto
- Identificaci√≥n de empresa y agente
- Verificaci√≥n de identidad del cliente
- Explicaci√≥n del motivo de la llamada
- Menci√≥n del monto de deuda
- Presentaci√≥n de ofertas/alternativas
- Menci√≥n de consecuencias (si aplica)
- Intento de cierre/compromiso
- Despedida correcta

### 3. AN√ÅLISIS DEL RESULTADO
- ¬øSe logr√≥ compromiso? ¬øDe qu√© tipo?
- ¬øHubo abandono de llamada?
- ¬øRequiere seguimiento?
- Nivel de riesgo de incumplimiento

### 4. NOTAS Y RECOMENDACIONES
- Observaciones importantes sobre la llamada
- Acciones de seguimiento recomendadas

## FORMATO DE RESPUESTA (JSON)

Responde con el siguiente formato JSON:

{
  "entidades": {
    "montos": [
      {
        "valor": 405302,
        "moneda": "CLP",
        "contexto": "deuda_principal",
        "segmento_id": 8,
        "frase_exacta": "deuda de 405.302 pesos"
      },
      {
        "valor": 128888,
        "moneda": "CLP",
        "contexto": "oferta_descuento",
        "segmento_id": 8,
        "frase_exacta": "pague solamente 128.888 pesos"
      }
    ],
    "fechas": [
      {
        "fecha_relativa": "el s√°bado",
        "fecha_iso": null,
        "contexto": "compromiso_pago",
        "segmento_id": 36,
        "frase_exacta": "S√≠, para el d√≠a s√°bado"
      }
    ],
    "metodos_pago": [
      {
        "metodo": "app_movil",
        "mencionado_por": "cliente",
        "segmento_id": 18,
        "frase_exacta": "Por la app"
      },
      {
        "metodo": "web",
        "mencionado_por": "agente",
        "segmento_id": 37,
        "frase_exacta": "por la p√°gina"
      }
    ],
    "referencias_creditos": [
      {
        "identificador": "8569",
        "tipo": "terminacion_cuenta",
        "monto_deuda": 405302,
        "monto_oferta": 128888,
        "segmento_id": 8
      },
      {
        "identificador": "6564",
        "tipo": "terminacion_cuenta",
        "monto_deuda": 16809,
        "monto_oferta": 10607,
        "segmento_id": 9
      }
    ],
    "objeciones": [
      {
        "tipo": "ninguna",
        "descripcion": null,
        "segmento_id": null,
        "frase_exacta": null,
        "fue_manejada": null,
        "resultado_manejo": null
      }
    ],
    "compromisos": [
      {
        "tipo": "pago_parcial",
        "credito_referencia": "8569",
        "monto": 128888,
        "moneda": "CLP",
        "fecha_relativa": "el s√°bado",
        "fecha_iso": null,
        "validacion": "explicita",
        "segmento_id": 39,
        "frase_validacion": "yo creo que el s√°bado cancelo ese de 128",
        "confianza": 0.85
      }
    ]
  },
  "patrones_script": {
    "saludo_correcto": true,
    "identificacion_empresa": true,
    "identificacion_agente": true,
    "verificacion_identidad_cliente": true,
    "explicacion_motivo": true,
    "mencion_monto_deuda": true,
    "presentacion_ofertas": true,
    "mencion_consecuencias": false,
    "intento_cierre": true,
    "despedida_correcta": true,
    "score_script": 90,
    "notas_script": "Agente sigui√≥ el script correctamente, solo falt√≥ mencionar consecuencias de no pago"
  },
  "resultado_llamada": {
    "tipo_cierre": "compromiso_explicito",
    "hubo_abandono": false,
    "abandono_info": null,
    "compromiso_logrado": true,
    "monto_total_comprometido": 128888,
    "moneda": "CLP",
    "fecha_compromiso": "proximo_sabado",
    "metodo_pago_acordado": "app_movil",
    "riesgo_incumplimiento": "bajo",
    "razon_riesgo": "Cliente mostr√≥ disposici√≥n activa, ya realiz√≥ un pago previo, emociones positivas al final"
  },
  "seguimiento": {
    "requiere_seguimiento": true,
    "tipo_seguimiento": "confirmacion_pago",
    "fecha_sugerida": "lunes_siguiente",
    "prioridad": "media",
    "notas": "Verificar que el pago se realiz√≥ el s√°bado. Cliente tiene otros 2 cr√©ditos pendientes que podr√≠an abordarse despu√©s."
  },
  "resumen_ejecutivo": {
    "duracion_segundos": 268,
    "resultado": "exitoso",
    "descripcion": "Llamada exitosa. Cliente Yessenia Gonz√°lez se comprometi√≥ a pagar 128,888 CLP el s√°bado por el cr√©dito terminado en 8569. Ya hab√≠a pagado un cr√©dito de ~10,000 CLP el d√≠a anterior. Le quedan 2 cr√©ditos grandes pendientes.",
    "puntos_clave": [
      "Cliente ya pag√≥ un cr√©dito el d√≠a anterior (buena se√±al)",
      "Acept√≥ oferta de descuento: pagar 128,888 en lugar de 405,302 (68% descuento)",
      "Compromiso expl√≠cito para pagar el s√°bado",
      "Interesada en consolidar las deudas grandes (repactaci√≥n en sucursal)",
      "Evoluci√≥n emocional positiva durante la llamada"
    ],
    "alertas": [],
    "recomendaciones": [
      "Confirmar el pago el lunes",
      "Si paga, ofrecer repactaci√≥n de los 2 cr√©ditos restantes",
      "Considerar bloquear la oferta de descuento como se indic√≥ en la llamada"
    ]
  }
}

Responde √öNICAMENTE con el JSON, sin texto adicional.
```

---

## Ejemplo de Input Real (del paso anterior)

```json
{
  "transcripcion_completa": "Agente: Buenas tardes. Cliente: Buenas tardes...",
  "duracion_segundos": 268,
  "segmentos_raw": [
    {
      "id": 0,
      "speaker": "agente",
      "timestamp_inicio": 0,
      "timestamp_fin": 1.5,
      "texto": "Buenas tardes.",
      "palabras": 2,
      "confianza": 0.99,
      "emocion": "neutral",
      "emocion_intensidad": 0.3
    }
  ],
  "estadisticas_basicas": {
    "total_segmentos": 46,
    "segmentos_agente": 24,
    "segmentos_cliente": 22,
    "palabras_totales": 489,
    "palabras_agente": 375,
    "palabras_cliente": 114,
    "confianza_promedio": 0.98
  },
  "analisis_emocional": {
    "agente": {
      "emocion_dominante": "neutral",
      "distribucion": {"neutral": 0.55, "positivo": 0.3, "interesado": 0.15},
      "intensidad_promedio": 0.42
    },
    "cliente": {
      "emocion_dominante": "neutral",
      "distribucion": {"neutral": 0.4, "interesado": 0.25, "positivo": 0.2, "aliviado": 0.1, "confundido": 0.05},
      "intensidad_promedio": 0.45
    },
    "evolucion_cliente": "mejor√≥ significativamente...",
    "momentos_criticos": [
      {
        "timestamp": 228,
        "tipo": "compromiso",
        "descripcion": "Cliente confirma que realizar√° el pago del cr√©dito mayor el d√≠a s√°bado.",
        "emocion_antes": "interesado",
        "emocion_despues": "positivo",
        "impacto": "alto"
      }
    ]
  }
}
```

---

## Implementaci√≥n en Saturn Studio

### Nodo: LLM Extracci√≥n

```yaml
node_type: llm_request
name: extraccion_entidades_analisis
config:
  provider: anthropic
  model: claude-sonnet-4-5-20250514
  temperature: 0.1
  max_tokens: 4000
  timeout: 60000
  retry:
    max_attempts: 2
    backoff: exponential
  
input:
  system_prompt: "{{system_prompt}}"
  user_prompt: "{{user_prompt_template}}"
  variables:
    # Datos de contexto (si disponibles del webhook inicial)
    fecha_llamada: "{{input.metadata.fecha | default('no_disponible')}}"
    nombre_agente: "{{input.metadata.nombre_agente | default('no_disponible')}}"
    cliente_ref: "{{input.cliente_ref | default('no_disponible')}}"
    empresa_cobranza: "{{input.metadata.empresa_cobranza | default('no_disponible')}}"
    empresa_acreedora: "{{input.metadata.empresa_acreedora | default('no_disponible')}}"
    
    # Datos del paso anterior (Gemini)
    transcripcion_completa: "{{gemini_output.transcripcion_completa}}"
    segmentos_json: "{{gemini_output.segmentos_raw | json}}"
    estadisticas_basicas: "{{gemini_output.estadisticas_basicas | json}}"
    analisis_emocional: "{{gemini_output.analisis_emocional | json}}"

output:
  parse_json: true
  validate_schema: true
  on_error:
    action: retry
    max_attempts: 2
    fallback: mark_for_review
```

---

## Validaci√≥n Post-LLM

```python
def validate_extraction_response(response):
    """Validar respuesta del LLM antes de guardar"""
    
    errors = []
    warnings = []
    
    # 1. Verificar estructura b√°sica
    required_keys = ['entidades', 'patrones_script', 'resultado_llamada', 'seguimiento', 'resumen_ejecutivo']
    for key in required_keys:
        if key not in response:
            errors.append(f"Falta campo requerido: {key}")
    
    # 2. Verificar que hay al menos un monto detectado
    montos = response.get('entidades', {}).get('montos', [])
    if len(montos) == 0:
        warnings.append("No se detectaron montos en la llamada")
    
    # 3. Verificar formato de montos
    for monto in montos:
        if monto.get('valor', 0) <= 0:
            errors.append(f"Monto inv√°lido: {monto.get('valor')}")
        if monto.get('moneda') not in ['CLP', 'PEN', 'USD', 'MXN', 'COP', 'ARS']:
            errors.append(f"Moneda no reconocida: {monto.get('moneda')}")
    
    # 4. Verificar compromisos tienen confianza
    for compromiso in response.get('entidades', {}).get('compromisos', []):
        if 'confianza' not in compromiso:
            errors.append("Compromiso sin campo 'confianza'")
        elif not (0 <= compromiso.get('confianza', 0) <= 1):
            errors.append(f"Confianza fuera de rango: {compromiso.get('confianza')}")
    
    # 5. Verificar score_script est√° en rango
    score = response.get('patrones_script', {}).get('score_script', 0)
    if not (0 <= score <= 100):
        errors.append(f"Score de script fuera de rango: {score}")
    
    # 6. Verificar resultado tiene tipo v√°lido
    tipo_cierre = response.get('resultado_llamada', {}).get('tipo_cierre')
    tipos_validos = ['compromiso_explicito', 'compromiso_implicito', 'sin_compromiso', 'rechazo', 'abandono', 'escalacion']
    if tipo_cierre not in tipos_validos:
        errors.append(f"Tipo de cierre inv√°lido: {tipo_cierre}")
    
    return {
        "valid": len(errors) == 0,
        "errors": errors,
        "warnings": warnings
    }
```

---

## Output Final para Supabase

El output de este paso se guarda en la tabla `analisis_llamadas`:

```json
{
  "analisis_id": "an-uuid-generado",
  "registro_id": "registro-de-la-llamada",
  "transcripcion_id": "transcripcion-uuid",
  "agente_id": "agente-uuid",
  "fecha_llamada": "2026-01-30",
  
  // Scores principales (calculados del an√°lisis)
  "score_total": 85,
  "score_compromiso": 90,
  "score_script": 90,
  
  // Datos extra√≠dos
  "entidades": { ... },
  "patrones_script": { ... },
  "resultado_llamada": { ... },
  "seguimiento": { ... },
  "resumen_ejecutivo": { ... },
  
  // Del paso anterior (copiados para referencia r√°pida)
  "analisis_emocional": { ... },
  
  // Metadata
  "modelo_usado": "claude-sonnet-4-5-20250514",
  "version_prompt": "v2.0",
  "tiempo_procesamiento_ms": 3500
}
```

---

## Diferencias vs Versi√≥n Anterior

| Aspecto | Antes | Ahora |
|---------|-------|-------|
| An√°lisis emocional | LLM lo calculaba | Ya viene del paso anterior, LLM lo usa |
| Estad√≠sticas b√°sicas | LLM las calculaba | Ya vienen calculadas |
| Input | Solo texto | JSON estructurado con emociones |
| Referencias de cr√©dito | No se extra√≠an | Se extraen como entidades |
| Score del script | No exist√≠a | Se calcula (0-100) |
| Riesgo de incumplimiento | No exist√≠a | Se eval√∫a con raz√≥n |
| Seguimiento | B√°sico | M√°s detallado con tipo y prioridad |
</file>

<file path="docs/ag1_transcriptor/prompt_gemini_transcripcion.md">
# Prompt para Gemini 2.0 Flash - Transcripci√≥n + Emociones

## System Prompt (Contexto)

```
Eres un experto transcriptor y analizador de llamadas de cobranza en espa√±ol latinoamericano.

Tu tarea es:
1. Transcribir el audio con precisi√≥n
2. Identificar qui√©n habla (agente vs cliente)
3. Segmentar la conversaci√≥n con timestamps
4. Analizar las emociones de cada segmento bas√°ndote en el tono de voz y contenido
5. Extraer informaci√≥n clave de los participantes (nombres, empresa)
6. Calcular m√©tricas conversacionales

CONTEXTO DEL NEGOCIO:
- Llamadas de gesti√≥n de cobranza de deudas
- Siempre hay 2 participantes: agente (call center) y cliente (deudor)
- El agente busca obtener un compromiso de pago

CATEGOR√çAS DE EMOCIONES:
- neutral: Sin carga emocional evidente, tono normal
- positivo: Tono amable, colaborador, receptivo
- negativo: Molestia, enojo, rechazo
- frustrado: Frustraci√≥n evidente, exasperaci√≥n
- confundido: Duda, no entiende, pide repetir
- interesado: Atento, hace preguntas, muestra disposici√≥n
- ansioso: Nervioso, preocupado por la situaci√≥n
- aliviado: Alivio al escuchar opciones o soluciones
```

---

## User Prompt

```
Transcribe y analiza el siguiente audio de una llamada de cobranza.

## INSTRUCCIONES

### 1. Identificar Speakers y Extraer Informaci√≥n de Participantes
- Analiza qui√©n es el agente y qui√©n es el cliente bas√°ndote en:
  * Contenido del mensaje (t√©rminos de cobranza, identificaci√≥n de empresa)
  * Orden de aparici√≥n (generalmente el agente habla primero en outbound)
  * Tipo de preguntas/respuestas
- Mapea los speakers a "agente" o "cliente"
- **EXTRAE** los siguientes datos si se mencionan:
  * Nombre completo del cliente
  * Nombre del agente
  * Empresa de cobranza (la que llama)
  * Empresa acreedora (a quien se le debe)

### 2. Estructurar Segmentos con Emociones
Cada segmento debe incluir:
- id (secuencial, empezando en 0)
- speaker ("agente" o "cliente")
- timestamp_inicio (n√∫mero decimal en segundos)
- timestamp_fin (n√∫mero decimal en segundos)
- texto (texto limpio del segmento)
- palabras (conteo de palabras)
- confianza (nivel de confianza de la transcripci√≥n, 0-1)
- emocion (emoci√≥n detectada: neutral, positivo, negativo, frustrado, confundido, interesado, ansioso, aliviado)
- emocion_intensidad (intensidad de la emoci√≥n, 0.0 a 1.0)

### 3. Analizar Emociones
Para cada segmento, eval√∫a:
- **Tono de voz**: velocidad, volumen, variaci√≥n de tono
- **Contenido textual**: palabras usadas, signos de exclamaci√≥n/interrogaci√≥n
- **Contexto**: qu√© se dijo antes, reacci√≥n a informaci√≥n previa

Indicadores por emoci√≥n:
- **neutral**: Tono plano, respuestas cortas como "s√≠", "ok", "aj√°"
- **positivo**: Tono animado, palabras como "perfecto", "gracias", "excelente"
- **negativo**: Tono cortante, palabras como "no puedo", "no quiero", suspiros
- **frustrado**: Voz elevada, repeticiones, "ya le dije", "no entiendo por qu√©"
- **confundido**: Preguntas, "¬øc√≥mo?", "¬øperd√≥n?", pausas largas
- **interesado**: Preguntas sobre opciones, "¬øy si...?", "cu√©nteme m√°s"
- **ansioso**: Voz temblorosa, preguntas sobre consecuencias
- **aliviado**: Suspiro de alivio, "ah, ok", "qu√© bueno", tono relajado

### 4. Detectar Momentos Cr√≠ticos
Identifica cambios emocionales importantes:
- Transiciones de negativo a positivo (o viceversa)
- Momentos de alta tensi√≥n
- Momentos de aceptaci√≥n/apertura

### 5. Calcular M√©tricas Conversacionales
- Total de segmentos y por speaker
- Palabras totales y por speaker
- **Ratio de habla** (palabras_agente / palabras_totales)
- **Interrupciones detectadas** (cuando un speaker corta al otro)
- **Silencios prolongados** (gaps > 3 segundos entre segmentos)
- Confianza promedio
- Distribuci√≥n emocional por speaker

### 6. Validar
- Todos los segmentos deben tener speaker v√°lido
- Timestamps deben ser crecientes
- Cada segmento debe tener emoci√≥n asignada

## FORMATO DE RESPUESTA (JSON)

{
  "transcripcion_completa": "texto completo de toda la llamada...",
  "duracion_segundos": 273.8,
  
  "participantes": {
    "cliente": {
      "nombre_completo": "Yessenia Andrea Gonz√°lez D√≠az",
      "nombre_corto": "Yessenia"
    },
    "agente": {
      "nombre_completo": "Silvano Machado",
      "nombre_corto": "Silvano"
    },
    "empresa_cobranza": "Redsap",
    "empresa_acreedora": "Caja Los Andes"
  },
  
  "segmentos_raw": [
    {
      "id": 0,
      "speaker": "agente",
      "timestamp_inicio": 0.0,
      "timestamp_fin": 1.5,
      "texto": "Buenas tardes.",
      "palabras": 2,
      "confianza": 0.99,
      "emocion": "neutral",
      "emocion_intensidad": 0.3
    },
    {
      "id": 1,
      "speaker": "cliente",
      "timestamp_inicio": 2.0,
      "timestamp_fin": 3.5,
      "texto": "Buenas tardes.",
      "palabras": 2,
      "confianza": 0.99,
      "emocion": "neutral",
      "emocion_intensidad": 0.25
    }
  ],
  
  "estadisticas_basicas": {
    "total_segmentos": 55,
    "segmentos_agente": 29,
    "segmentos_cliente": 26,
    "palabras_totales": 552,
    "palabras_agente": 415,
    "palabras_cliente": 137,
    "confianza_promedio": 0.97
  },
  
  "metricas_conversacion": {
    "ratio_habla_agente": 0.75,
    "turnos_conversacion": 55,
    "duracion_promedio_turno_agente": 6.2,
    "duracion_promedio_turno_cliente": 2.8,
    "interrupciones": [],
    "silencios_prolongados": [
      {
        "timestamp_inicio": 58.0,
        "duracion_segundos": 4.5,
        "contexto": "Despu√©s de presentar oferta, cliente procesa informaci√≥n"
      }
    ]
  },
  
  "analisis_emocional": {
    "agente": {
      "emocion_dominante": "neutral",
      "distribucion": {
        "neutral": 0.60,
        "positivo": 0.35,
        "negativo": 0.05
      },
      "intensidad_promedio": 0.35
    },
    "cliente": {
      "emocion_dominante": "neutral",
      "distribucion": {
        "neutral": 0.45,
        "positivo": 0.25,
        "interesado": 0.15,
        "ansioso": 0.10,
        "confundido": 0.05
      },
      "intensidad_promedio": 0.40
    },
    "evolucion_cliente": "mejoro",
    "momentos_criticos": [
      {
        "timestamp": 35.8,
        "tipo": "revelacion_situacion",
        "descripcion": "Cliente revela que est√° sin trabajo",
        "emocion_antes": "neutral",
        "emocion_despues": "ansioso",
        "impacto": "alto"
      },
      {
        "timestamp": 249.0,
        "tipo": "aceptacion",
        "descripcion": "Cliente acepta la oferta y confirma pago",
        "emocion_antes": "interesado",
        "emocion_despues": "positivo",
        "impacto": "alto"
      }
    ]
  },
  
  "speaker_mapping": {
    "SPEAKER_00": "agente",
    "SPEAKER_01": "cliente",
    "confidence": 0.99,
    "method": "first_speaker_identifies_company"
  }
}

Responde √öNICAMENTE con el JSON, sin texto adicional.
```

---

## Ejemplo de Output Esperado

Para el audio de ejemplo (Silvana - Caja Los Andes), el output deber√≠a verse as√≠:

```json
{
  "transcripcion_completa": "Buenas tardes. Buenas tardes. ¬øS√≠, buenas tardes? Hablo con la se√±ora Yesenia Andrea Gonz√°lez D√≠az...",
  "duracion_segundos": 313.5,
  
  "segmentos_raw": [
    {
      "id": 0,
      "speaker": "agente",
      "timestamp_inicio": 0,
      "timestamp_fin": 1.5,
      "texto": "Buenas tardes.",
      "palabras": 2,
      "confianza": 0.99,
      "emocion": "neutral",
      "emocion_intensidad": 0.3
    },
    {
      "id": 1,
      "speaker": "cliente",
      "timestamp_inicio": 2,
      "timestamp_fin": 3.5,
      "texto": "Buenas tardes.",
      "palabras": 2,
      "confianza": 0.99,
      "emocion": "neutral",
      "emocion_intensidad": 0.25
    },
    {
      "id": 12,
      "speaker": "cliente",
      "timestamp_inicio": 125,
      "timestamp_fin": 129.5,
      "texto": "Ayer pagu√© uno de 16 que eran 10 mil y algo.",
      "palabras": 10,
      "confianza": 0.97,
      "emocion": "positivo",
      "emocion_intensidad": 0.5
    },
    {
      "id": 39,
      "speaker": "cliente",
      "timestamp_inicio": 249,
      "timestamp_fin": 254.5,
      "texto": "Yo creo que s√≠. Ese de 120... ¬øcu√°nto me dijo? ¬ø128?",
      "palabras": 10,
      "confianza": 0.97,
      "emocion": "interesado",
      "emocion_intensidad": 0.6
    },
    {
      "id": 47,
      "speaker": "cliente",
      "timestamp_inicio": 291,
      "timestamp_fin": 296,
      "texto": "S√≠, yo creo que el s√°bado cancelo esos 128 y ya me quedar√≠a el otro nom√°s.",
      "palabras": 15,
      "confianza": 0.98,
      "emocion": "positivo",
      "emocion_intensidad": 0.65
    },
    {
      "id": 49,
      "speaker": "cliente",
      "timestamp_inicio": 299.6,
      "timestamp_fin": 302.5,
      "texto": "Poco a poco. Gracias.",
      "palabras": 4,
      "confianza": 0.99,
      "emocion": "aliviado",
      "emocion_intensidad": 0.55
    }
  ],
  
  "analisis_emocional": {
    "agente": {
      "emocion_dominante": "positivo",
      "distribucion": {
        "neutral": 0.40,
        "positivo": 0.55,
        "negativo": 0.05
      },
      "intensidad_promedio": 0.42
    },
    "cliente": {
      "emocion_dominante": "neutral",
      "distribucion": {
        "neutral": 0.50,
        "positivo": 0.30,
        "interesado": 0.12,
        "confundido": 0.05,
        "aliviado": 0.03
      },
      "intensidad_promedio": 0.38
    },
    "evolucion_cliente": "mejoro",
    "momentos_criticos": [
      {
        "timestamp": 125,
        "tipo": "informacion_positiva",
        "descripcion": "Cliente informa que ya pag√≥ un cr√©dito ayer",
        "emocion_antes": "neutral",
        "emocion_despues": "positivo",
        "impacto": "medio"
      },
      {
        "timestamp": 291,
        "tipo": "compromiso",
        "descripcion": "Cliente confirma que pagar√° el s√°bado",
        "emocion_antes": "interesado",
        "emocion_despues": "positivo",
        "impacto": "alto"
      }
    ]
  }
}
```

---

## Notas de Implementaci√≥n

### Par√°metros para Gemini

```json
{
  "model": "gemini-2.0-flash",
  "temperature": 0.1,
  "max_output_tokens": 8000,
  "response_mime_type": "application/json"
}
```

### Validaci√≥n Post-Respuesta

```python
def validate_gemini_output(output):
    errors = []
    
    # 1. Verificar estructura b√°sica
    required_keys = ['transcripcion_completa', 'duracion_segundos', 'segmentos_raw', 
                     'estadisticas_basicas', 'analisis_emocional', 'speaker_mapping']
    for key in required_keys:
        if key not in output:
            errors.append(f"Falta campo requerido: {key}")
    
    # 2. Verificar que cada segmento tiene emoci√≥n
    for seg in output.get('segmentos_raw', []):
        if 'emocion' not in seg:
            errors.append(f"Segmento {seg.get('id')} sin emoci√≥n")
        if seg.get('emocion') not in ['neutral', 'positivo', 'negativo', 'frustrado', 
                                       'confundido', 'interesado', 'ansioso', 'aliviado']:
            errors.append(f"Segmento {seg.get('id')} con emoci√≥n inv√°lida: {seg.get('emocion')}")
    
    # 3. Verificar timestamps crecientes
    prev_end = 0
    for seg in output.get('segmentos_raw', []):
        if seg.get('timestamp_inicio', 0) < prev_end - 0.5:  # tolerancia de 0.5s
            errors.append(f"Segmento {seg.get('id')} con timestamp fuera de orden")
        prev_end = seg.get('timestamp_fin', 0)
    
    return {"valid": len(errors) == 0, "errors": errors}
```

---

## Diferencias vs Prompt Anterior

| Campo | Antes | Ahora |
|-------|-------|-------|
| `segmentos_raw[].emocion` | ‚ùå No incluido | ‚úÖ Incluido |
| `segmentos_raw[].emocion_intensidad` | ‚ùå No incluido | ‚úÖ Incluido |
| `analisis_emocional` | ‚ùå No incluido | ‚úÖ Nuevo objeto completo |
| `analisis_emocional.momentos_criticos` | ‚ùå No incluido | ‚úÖ Detecta cambios importantes |
| `analisis_emocional.evolucion_cliente` | ‚ùå No incluido | ‚úÖ mejoro/empeoro/estable |
</file>

<file path="docs/ag1_transcriptor/README.md">
# Agente 1: Transcriptor

## Visi√≥n General

El Agente Transcriptor convierte audio de llamadas en datos estructurados listos para an√°lisis.

## Pipeline de Procesamiento

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        AGENTE TRANSCRIPTOR                                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                              ‚îÇ
‚îÇ  INPUT: Audio (MP3/WAV) desde Google Drive + Metadata b√°sica                ‚îÇ
‚îÇ                                                                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ PASO 1: Transcripci√≥n + Emociones (Gemini 2.0 Flash)                 ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - Transcripci√≥n con diarizaci√≥n                                      ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - Identificaci√≥n de speakers (agente/cliente)                        ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - Extracci√≥n de participantes (nombres, empresas)                    ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - An√°lisis de emociones por segmento                                 ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - M√©tricas conversacionales (ratio habla, interrupciones, silencios) ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - Output: JSON estructurado                                          ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                              ‚îÇ                                               ‚îÇ
‚îÇ                              ‚ñº                                               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ PASO 2: Extracci√≥n de Entidades (Claude Sonnet 4.5)                  ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - Montos mencionados (deudas, ofertas, pagos)                        ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - Fechas (compromisos, plazos)                                       ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - M√©todos de pago                                                    ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - Referencias de cr√©ditos                                            ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - Objeciones y compromisos                                           ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - Patrones de script                                                 ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - Resultado preliminar y seguimiento                                 ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                              ‚îÇ                                               ‚îÇ
‚îÇ                              ‚ñº                                               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ PASO 3: INSERT en Supabase                                           ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - registro_llamadas (metadata de la llamada)                         ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - transcripciones (toda la informaci√≥n extra√≠da)                     ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                              ‚îÇ                                               ‚îÇ
‚îÇ                              ‚ñº                                               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ PASO 4: Trigger Webhook ‚Üí Agente Analista                            ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## Archivos de Prompts

| Archivo | Descripci√≥n | Tecnolog√≠a |
|---------|-------------|------------|
| `prompt_gemini_transcripcion.md` | Transcripci√≥n + emociones + participantes | Gemini 2.0 Flash |
| `paso5_6_prompt_llm.md` | Extracci√≥n de entidades y an√°lisis preliminar | Claude Sonnet 4.5 |

## Outputs del Agente

### Output de Gemini (Paso 1)
```json
{
  "transcripcion_completa": "...",
  "duracion_segundos": 268,
  "participantes": {
    "cliente": {"nombre_completo": "Yessenia Gonz√°lez", ...},
    "agente": {"nombre_completo": "Silvano Machado", ...},
    "empresa_cobranza": "Redsap",
    "empresa_acreedora": "Caja Los Andes"
  },
  "segmentos_raw": [...],
  "estadisticas_basicas": {...},
  "metricas_conversacion": {...},
  "analisis_emocional": {...}
}
```

### Output de Claude (Paso 2)
```json
{
  "entidades": {
    "montos": [...],
    "fechas": [...],
    "metodos_pago": [...],
    "referencias_creditos": [...],
    "objeciones": [...],
    "compromisos": [...]
  },
  "patrones_script": {...},
  "resultado_llamada": {...},
  "seguimiento": {...},
  "resumen_ejecutivo": {...}
}
```

## Tablas de Supabase Afectadas

### `registro_llamadas`
| Campo | Fuente | Notas |
|-------|--------|-------|
| `audio_url` | Webhook/Drive | URL del audio |
| `duracion_segundos` | Gemini | Calculado |
| `agente_nombre` | Gemini `participantes.agente.nombre_completo` | Extra√≠do |
| `cliente_nombre` | Gemini `participantes.cliente.nombre_completo` | Extra√≠do |
| `empresa_acreedora` | Gemini `participantes.empresa_acreedora` | Extra√≠do |
| `empresa_cobranza` | Gemini `participantes.empresa_cobranza` | Extra√≠do |
| `estado` | Calculado | "transcrito" ‚Üí "analizado" |

### `transcripciones`
| Campo | Fuente |
|-------|--------|
| `transcripcion_completa` | Gemini |
| `segmentos` | Gemini `segmentos_raw` |
| `entidades` | Claude |
| `metricas_conversacion` | Gemini `metricas_conversacion` + `estadisticas_basicas` |
| `analisis_emocional` | Gemini |
| `patrones_script` | Claude |
| `resultado_preliminar` | Claude `resultado_llamada` |
| `resumen_ejecutivo` | Claude |
| `referencias_creditos` | Claude |
| `seguimiento` | Claude |

## Tiempo de Procesamiento Esperado

| Paso | Tiempo | Notas |
|------|--------|-------|
| Gemini (transcripci√≥n + emociones) | 15-30s | Depende de duraci√≥n del audio |
| Claude (extracci√≥n) | 5-10s | Un request |
| INSERT Supabase | <1s | - |
| **Total** | **20-40s** | Para llamada de ~5 min |

## Siguiente Agente

El **Agente Analista** (ag2) recibe el webhook con:
```json
{
  "registro_id": "uuid",
  "transcripcion_id": "uuid",
  "agente_id": "uuid",
  "resultado_preliminar": {...}
}
```

Y se encarga de:
- Calcular scores de m√≥dulos (contacto directo, compromiso, abandono)
- Calcular probabilidad de cumplimiento
- Generar alertas si es necesario
- Trigger al Agente Detector si hay alertas cr√≠ticas
</file>

<file path="docs/ag2_analista/flujo_completo.md">
# Agente Analista - Flujo Completo End-to-End

## üìã Resumen del Flujo

```
Webhook Transcriptor ‚Üí Obtener Contexto ‚Üí Evaluar M√≥dulos ‚Üí Calcular Probabilidad ‚Üí 
Generar Alertas ‚Üí INSERT Supabase ‚Üí [Webhook Detector si alertas]
```

---

## üîÑ Flujo Detallado

### PASO 1: Recibir Webhook del Transcriptor

**Endpoint**: `POST /webhooks/analizar-llamada`

**Payload recibido**:
```json
{
  "registro_id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "transcripcion_id": "f1e2d3c4-b5a6-7890-1234-567890abcdef"
}
```

**Validaci√≥n**:
```javascript
// Saturn Studio - Nodo de validaci√≥n
if (!payload.registro_id || !payload.transcripcion_id) {
  throw new Error('Missing required fields');
}
```

---

### PASO 2: Obtener Contexto desde Supabase

**Query 1: Transcripci√≥n completa**
```sql
SELECT 
  transcripcion_id,
  registro_id,
  transcripcion_completa,
  segmentos,
  entidades,
  metricas_conversacion,
  analisis_emocional,
  patrones_script,
  resultado_preliminar,
  resumen_ejecutivo,
  referencias_creditos,
  seguimiento
FROM transcripciones 
WHERE transcripcion_id = $1;
```

**Query 2: Info del registro y agente**
```sql
SELECT 
  rl.registro_id,
  rl.agente_id,
  rl.agente_nombre,
  rl.cliente_nombre,
  rl.empresa_acreedora,
  rl.empresa_cobranza,
  rl.campana,
  rl.timestamp_inicio,
  rl.duracion_segundos,
  a.nombre as agente_nombre_oficial,
  a.equipo,
  a.estado as agente_estado
FROM registro_llamadas rl
LEFT JOIN agentes a ON rl.agente_id = a.agente_id
WHERE rl.registro_id = $1;
```

**Query 3: Historial del cliente (si existe)**
```sql
SELECT 
  al.analisis_id,
  al.score_total,
  al.probabilidad_cumplimiento,
  al.modulo_compromiso_pago->'desglose'->'validacion_cliente'->>'tipo' as tipo_validacion,
  al.fecha_llamada,
  al.alertas
FROM analisis_llamadas al
JOIN registro_llamadas rl ON al.registro_id = rl.registro_id
WHERE rl.cliente_nombre = $1
  AND al.created_at < NOW()
ORDER BY al.created_at DESC
LIMIT 5;
```

**Resultado combinado**:
```javascript
const contexto = {
  transcripcion: resultQuery1[0],
  registro: resultQuery2[0],
  historial: resultQuery3  // puede ser []
};
```

---

### PASO 3: Evaluar M√≥dulos con Claude

**Preparar prompt**:
```javascript
const promptModulos = construirPromptModulos({
  transcripcion_completa: contexto.transcripcion.transcripcion_completa,
  segmentos_json: JSON.stringify(contexto.transcripcion.segmentos),
  entidades_json: JSON.stringify(contexto.transcripcion.entidades),
  patrones_script_json: JSON.stringify(contexto.transcripcion.patrones_script),
  resultado_preliminar_json: JSON.stringify(contexto.transcripcion.resultado_preliminar)
});
```

**Llamada a Claude**:
```javascript
const responseModulos = await claude.messages.create({
  model: 'claude-opus-4-5-20250514',
  max_tokens: 4000,
  temperature: 0.2,
  messages: [{ role: 'user', content: promptModulos }]
});

const analisisModulos = JSON.parse(responseModulos.content[0].text);
```

**Output esperado**:
```json
{
  "modulo_contacto_directo": {
    "score": 80,
    "desglose": {...}
  },
  "modulo_compromiso_pago": {
    "score": 80,
    "desglose": {...}
  },
  "modulo_abandono": {
    "hubo_abandono": false,
    ...
  },
  "score_total": 80,
  "notas_evaluacion": "..."
}
```

---

### PASO 4: Calcular Probabilidad de Cumplimiento

**Preparar prompt**:
```javascript
const promptPrediccion = construirPromptPrediccion({
  analisis_modulos_json: JSON.stringify(analisisModulos),
  resultado_preliminar_json: JSON.stringify(contexto.transcripcion.resultado_preliminar),
  historial_cliente_json: JSON.stringify(contexto.historial),
  info_deuda_json: JSON.stringify({
    campana: contexto.registro.campana,
    monto_deuda: calcularMontoTotal(contexto.transcripcion.entidades.montos)
  })
});
```

**Llamada a Claude**:
```javascript
const responsePrediccion = await claude.messages.create({
  model: 'claude-opus-4-5-20250514',
  max_tokens: 2000,
  temperature: 0.3,
  messages: [{ role: 'user', content: promptPrediccion }]
});

const prediccion = JSON.parse(responsePrediccion.content[0].text);
```

**Output esperado**:
```json
{
  "probabilidad_cumplimiento": 78,
  "nivel_cumplimiento": "alta",
  "calculo": {...},
  "factores_prediccion": {...}
}
```

---

### PASO 5: Generar Alertas

**L√≥gica de alertas**:
```javascript
function generarAlertas(analisisModulos, prediccion) {
  const alertas = [];
  
  // Score cr√≠tico
  if (analisisModulos.score_total < 30) {
    alertas.push({
      tipo: 'critical',
      codigo: 'SCORE_CRITICO',
      mensaje: `Score cr√≠ticamente bajo (${analisisModulos.score_total})`,
      severidad: 'critica'
    });
  } else if (analisisModulos.score_total < 50) {
    alertas.push({
      tipo: 'warning',
      codigo: 'SCORE_BAJO',
      mensaje: `Score bajo (${analisisModulos.score_total})`,
      severidad: 'alta'
    });
  }
  
  // Validaci√≥n
  const validacion = analisisModulos.modulo_compromiso_pago.desglose.validacion_cliente;
  if (validacion.tipo === 'ninguna') {
    alertas.push({
      tipo: 'warning',
      codigo: 'FALTA_VALIDACION',
      mensaje: 'Cliente no valid√≥ compromiso',
      severidad: 'alta'
    });
  }
  
  // Abandono
  if (analisisModulos.modulo_abandono.hubo_abandono) {
    alertas.push({
      tipo: 'error',
      codigo: 'ABANDONO_LLAMADA',
      mensaje: `Abandono por ${analisisModulos.modulo_abandono.iniciado_por}`,
      severidad: 'alta'
    });
  }
  
  // Probabilidad baja
  if (prediccion.probabilidad_cumplimiento < 30) {
    alertas.push({
      tipo: 'warning',
      codigo: 'PROBABILIDAD_BAJA',
      mensaje: `Probabilidad muy baja (${prediccion.probabilidad_cumplimiento}%)`,
      severidad: 'media'
    });
  }
  
  return alertas;
}
```

---

### PASO 6: Generar Recomendaciones

**L√≥gica de recomendaciones**:
```javascript
function generarRecomendaciones(contexto, analisisModulos, prediccion) {
  const recomendaciones = [];
  const resultado = contexto.transcripcion.resultado_preliminar;
  
  // Si hay compromiso, programar seguimiento
  if (resultado.compromiso_logrado) {
    recomendaciones.push({
      prioridad: 'media',
      destinatario: 'sistema',
      accion: `Programar recordatorio de pago`,
      cuando: '24h antes de fecha compromiso'
    });
    
    recomendaciones.push({
      prioridad: 'media',
      destinatario: 'agente',
      accion: 'Llamar para confirmar pago realizado',
      cuando: 'd√≠a siguiente al compromiso'
    });
  }
  
  // Si validaci√≥n d√©bil
  const validacion = analisisModulos.modulo_compromiso_pago.desglose.validacion_cliente;
  if (validacion.tipo === 'implicita') {
    recomendaciones.push({
      prioridad: 'alta',
      destinatario: 'supervisor',
      accion: 'Llamar para reforzar compromiso con validaci√≥n expl√≠cita',
      cuando: '24-48 horas'
    });
  }
  
  // Si score bajo
  if (analisisModulos.score_total < 60) {
    recomendaciones.push({
      prioridad: 'media',
      destinatario: 'coaching',
      accion: 'Incluir llamada en revisi√≥n de coaching',
      cuando: 'pr√≥ximo reporte'
    });
  }
  
  return recomendaciones;
}
```

---

### PASO 7: INSERT en Supabase

**Construir objeto final**:
```javascript
const analisisCompleto = {
  registro_id: contexto.registro.registro_id,
  transcripcion_id: contexto.transcripcion.transcripcion_id,
  agente_id: contexto.registro.agente_id,
  
  score_total: analisisModulos.score_total,
  score_contacto_directo: analisisModulos.modulo_contacto_directo.score,
  score_compromiso_pago: analisisModulos.modulo_compromiso_pago.score,
  
  modulo_contacto_directo: analisisModulos.modulo_contacto_directo,
  modulo_compromiso_pago: analisisModulos.modulo_compromiso_pago,
  modulo_abandono: analisisModulos.modulo_abandono,
  
  probabilidad_cumplimiento: prediccion.probabilidad_cumplimiento,
  nivel_cumplimiento: prediccion.nivel_cumplimiento,
  factores_prediccion: prediccion.factores_prediccion,
  
  alertas: alertas,
  recomendaciones: recomendaciones,
  
  modelo_usado: 'claude-opus-4-5-20250514',
  version_prompt: 'v1.0',
  confianza_analisis: prediccion.factores_prediccion.confianza_prediccion,
  tiempo_procesamiento_ms: Date.now() - startTime,
  fecha_llamada: contexto.registro.timestamp_inicio?.toISOString().split('T')[0] || new Date().toISOString().split('T')[0]
};
```

**INSERT**:
```sql
INSERT INTO analisis_llamadas (
  registro_id, transcripcion_id, agente_id,
  score_total, score_contacto_directo, score_compromiso_pago,
  modulo_contacto_directo, modulo_compromiso_pago, modulo_abandono,
  probabilidad_cumplimiento, nivel_cumplimiento, factores_prediccion,
  alertas, recomendaciones,
  modelo_usado, version_prompt, confianza_analisis, tiempo_procesamiento_ms, fecha_llamada
) VALUES (
  $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19
) RETURNING analisis_id;
```

**UPDATE registro_llamadas**:
```sql
UPDATE registro_llamadas 
SET 
  estado = 'analizado',
  analisis_id = $1,
  updated_at = NOW()
WHERE registro_id = $2;
```

---

### PASO 8: Trigger Condicional al Detector

**Evaluar si disparar**:
```javascript
function debeDispararDetector(alertas) {
  return alertas.some(a => 
    a.severidad === 'critica' || 
    (a.severidad === 'alta' && ['SCORE_BAJO', 'ABANDONO_LLAMADA', 'FALTA_VALIDACION'].includes(a.codigo))
  );
}
```

**Webhook al Detector**:
```javascript
if (debeDispararDetector(alertas)) {
  await fetch(process.env.WEBHOOK_DETECTOR_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      trigger: 'analisis_individual',
      analisis_id: analisisId,
      registro_id: contexto.registro.registro_id,
      agente_id: contexto.registro.agente_id,
      alertas: alertas,
      timestamp: new Date().toISOString()
    })
  });
}
```

---

## ‚è±Ô∏è Tiempos Esperados

| Paso | Tiempo | Acumulado |
|------|--------|-----------|
| 1. Recibir webhook | <50ms | 50ms |
| 2. Queries Supabase (paralelo) | ~300ms | 350ms |
| 3. Claude - M√≥dulos | 2-3s | 3.5s |
| 4. Claude - Predicci√≥n | 1-2s | 5s |
| 5-6. Alertas + Recomendaciones | <50ms | 5s |
| 7. INSERT/UPDATE Supabase | ~200ms | 5.2s |
| 8. Webhook Detector | ~100ms | 5.3s |
| **Total** | **~5s** | |

---

## üî¥ Manejo de Errores

```javascript
try {
  // ... flujo completo ...
} catch (error) {
  // Registrar error
  await supabase.from('registro_llamadas').update({
    estado: 'error',
    error_mensaje: error.message,
    updated_at: new Date()
  }).eq('registro_id', registro_id);
  
  // Notificar
  await notificarError({
    agente: 'analista',
    registro_id: registro_id,
    error: error.message,
    stack: error.stack
  });
  
  throw error;
}
```

---

## üìä M√©tricas a Monitorear

| M√©trica | Target | Alerta |
|---------|--------|--------|
| Tiempo total | < 10s | > 15s |
| Tasa √©xito | > 99% | < 95% |
| Errores Claude | < 1% | > 5% |
| Errores Supabase | < 0.1% | > 1% |
</file>

<file path="docs/ag2_analista/input_ejemplo.json">
{
  "_comentario": "Este es el input que recibe el Agente Analista desde el Transcriptor",
  
  "webhook_payload": {
    "registro_id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
    "transcripcion_id": "f1e2d3c4-b5a6-7890-1234-567890abcdef"
  },
  
  "datos_transcripcion": {
    "transcripcion_completa": "Agente: Buenas tardes. Cliente: Buenas tardes. Agente: ¬øS√≠ buenas tardes? Hablo con la se√±ora Yessenia Andrea Gonz√°lez D√≠az. Cliente: S√≠. Agente: Un gusto, mi nombre es Silvano Machado, le estamos hablando de Redsap por encargo de Caja Los Andes. Cliente: S√≠. Agente: Se√±ora Yessenia la estamos llamando referente a sus cr√©ditos que actualmente est√°n presentando una deuda. Pero nosotros por aqu√≠ lo que queremos es disminuirle el monto de esa deuda y por eso le tenemos unas ofertas que de repente se puedan ajustar a su situaci√≥n actual, ¬øs√≠? Cliente: S√≠. Agente: Okay, por aqu√≠ yo tengo un cr√©dito que termina en 8569 que actualmente est√° presentando una deuda de 405,302 pesos. Por ac√° le ofrecemos que en lugar de pagar esos 405,000 pague solamente 128,888 pesos y ya con eso quedar√≠a saldado el cr√©dito. ¬øS√≠? Cliente: S√≠. Agente: Tambi√©n tengo un cr√©dito... s√≠ diga. Cliente: Ya, no, siga, siga. Agente: Vale, tambi√©n tengo un cr√©dito que termina en 6564 que tiene una deuda total de 16,809 pesos, pero si paga solamente 10,607 pesos quedar√≠a saldado el cr√©dito. ¬øQu√© le parece esta oferta, se√±ora Yessenia? Cliente: Ayer pagu√© uno de 16, quedan 10 mil y algo. Agente: El de 16,000 pagar√≠a 10,607 y saldar√≠a... Cliente: S√≠, eso fue lo que pagu√© ayer y me queda uno de 16 creo, porque eran dos. Agente: Vale, tiene... yo veo aqu√≠ que tiene, ah okay, el que termina en 8512. Cliente: S√≠. Agente: Aj√°, s√≠, ese. ¬øY ese c√≥mo hizo el pago, se√±ora Yessenia? Cliente: ¬øPerd√≥n? Agente: ¬øC√≥mo hizo el pago de ese cr√©dito? Cliente: Por la APP. Agente: Por la aplicaci√≥n. Cliente: S√≠, me sali√≥ en oferta y... Agente: Pero entonces le quedar√≠an tres cr√©ditos, se√±ora Yessenia. Cliente: S√≠, tres solamente. Bueno, yo creo que ma√±ana pago el otro de 16 y me quedar√≠an los dos grandes. Agente: Exacto, se quedar√≠a con los dos grandes. Vale, igual lo estar√≠a pagando por la aplicaci√≥n se√±ora Yessenia. Cliente: S√≠, porque igual son cuotas. Agente: Vale, entonces yo voy a colocar que estar√≠a pagando eso y quedar√≠an entonces los m√°s grandes que bueno, poco a poco los va a ir pagando se√±ora Yessenia, ¬øs√≠? Cliente: S√≠, s√≠, s√≠. Incluso ayer hab√≠a hablado por WhatsApp para ver si pod√≠a hacer como juntar esas dos deudas y hacer una sola. Agente: Eso tendr√≠a que ir directamente en la oficina. Ser√≠a una repactaci√≥n de los cr√©ditos, pero s√≠ tiene que ir directamente a la sucursal para poder hacerlo. Cliente: Ah, ya, okay. Agente: Si quiere puede aprovechar la oferta, pero tendr√≠a que ser antes del viernes para que aproveche la oferta que tenemos ac√°, ¬øs√≠? Cliente: Ya. Agente: ¬øS√≠ tendr√≠a disponibilidad se√±ora Yessenia? Cliente: Yo creo que s√≠, eso del 120 y ¬øcu√°nto me dijo? ¬ø128? Agente: 128,888. Uno es por 128. Cliente: ¬øEse est√° para el d√≠a s√°bado o no? Agente: S√≠, s√≠, para el d√≠a s√°bado s√≠. Cliente: Ese es el mismo que me sale por la p√°gina, ¬øverdad? Agente: Por la p√°gina, s√≠. Lo que yo voy a hacer es bloquearlo para que ya para el s√°bado tenga ese mismo monto y no se lo cambien. Cliente: Ya. Okay, okay. S√≠ yo creo que el s√°bado cancelo ese de 128 y ya me quedar√≠a el otro nom√°s. Agente: Exacto, con el favor de Dios, poco a poco, se√±ora Yessenia. Cliente: Poco a poco. Gracias. Agente: Dale, ya coloco esa informaci√≥n por aqu√≠ y cualquier cosa estamos a la orden se√±ora Yessenia. Cliente: Ya, muchas gracias. Agente: Much√≠simas gracias, feliz d√≠a. Cliente: Igual. Agente: Dale, hasta luego.",
    "duracion_segundos": 261,
    "segmentos": [
      {"id": 0, "speaker": "agente", "texto": "Buenas tardes.", "emocion": "neutral", "emocion_intensidad": 0.4},
      {"id": 1, "speaker": "cliente", "texto": "Buenas tardes.", "emocion": "neutral", "emocion_intensidad": 0.3},
      {"id": 41, "speaker": "cliente", "texto": "Ya. Okay, okay. S√≠ yo creo que el s√°bado cancelo ese de 128 y ya me quedar√≠a el otro nom√°s.", "emocion": "aliviado", "emocion_intensidad": 0.7}
    ],
    "entidades": {
      "montos": [
        {"valor": 405302, "moneda": "CLP", "contexto": "deuda_principal", "frase_exacta": "deuda de 405,302 pesos"},
        {"valor": 128888, "moneda": "CLP", "contexto": "oferta_descuento", "frase_exacta": "pague solamente 128,888 pesos"},
        {"valor": 16809, "moneda": "CLP", "contexto": "deuda_secundaria", "frase_exacta": "deuda total de 16,809 pesos"},
        {"valor": 10607, "moneda": "CLP", "contexto": "oferta_descuento_secundaria", "frase_exacta": "paga solamente 10,607 pesos"}
      ],
      "fechas": [
        {"fecha_relativa": "ma√±ana", "contexto": "compromiso_pago_menor", "frase_exacta": "ma√±ana pago el otro de 16"},
        {"fecha_relativa": "antes del viernes", "contexto": "limite_oferta", "frase_exacta": "tendr√≠a que ser antes del viernes"},
        {"fecha_relativa": "el s√°bado", "contexto": "compromiso_pago_principal", "frase_exacta": "el s√°bado cancelo ese de 128"}
      ],
      "metodos_pago": [
        {"metodo": "app_movil", "mencionado_por": "cliente", "frase_exacta": "Por la APP"},
        {"metodo": "web", "mencionado_por": "cliente", "frase_exacta": "por la p√°gina"}
      ],
      "objeciones": [
        {"tipo": "ninguna", "descripcion": "La cliente muestra disposici√≥n al pago y ya est√° realizando gestiones por su cuenta."}
      ],
      "compromisos": [
        {"tipo": "pago_total_con_descuento", "credito_referencia": "8569", "monto": 128888, "fecha_relativa": "el s√°bado", "validacion": "explicita", "frase_validacion": "S√≠ yo creo que el s√°bado cancelo ese de 128", "confianza": 0.95},
        {"tipo": "pago_total_con_descuento", "credito_referencia": "6564", "monto": 10607, "fecha_relativa": "ma√±ana", "validacion": "explicita", "frase_validacion": "Bueno, yo creo que ma√±ana pago el otro de 16", "confianza": 0.9}
      ]
    },
    "analisis_emocional": {
      "agente": {"emocion_dominante": "positivo", "distribucion": {"neutral": 0.48, "positivo": 0.4, "interesado": 0.12}, "intensidad_promedio": 0.52},
      "cliente": {"emocion_dominante": "neutral", "distribucion": {"neutral": 0.46, "positivo": 0.25, "interesado": 0.21, "aliviado": 0.08}, "intensidad_promedio": 0.48},
      "evolucion_cliente": "mejoro",
      "momentos_criticos": [
        {"timestamp": 145, "tipo": "revelacion_situacion", "descripcion": "Cliente revela que ya est√° pagando activamente.", "impacto": "medio"},
        {"timestamp": 302, "tipo": "aceptacion", "descripcion": "Cliente confirma compromiso de pago para el s√°bado.", "impacto": "alto"}
      ]
    },
    "patrones_script": {
      "saludo_correcto": true,
      "identificacion_empresa": true,
      "identificacion_agente": true,
      "verificacion_identidad_cliente": true,
      "explicacion_motivo": true,
      "mencion_monto_deuda": true,
      "presentacion_ofertas": true,
      "mencion_consecuencias": false,
      "intento_cierre": true,
      "despedida_correcta": true,
      "score_script": 90
    },
    "resultado_preliminar": {
      "tipo_cierre": "compromiso_explicito",
      "hubo_abandono": false,
      "compromiso_logrado": true,
      "monto_total_comprometido": 139495,
      "moneda": "CLP",
      "fecha_compromiso": "proximo_sabado",
      "metodo_pago_acordado": "app_movil",
      "riesgo_incumplimiento": "bajo"
    },
    "metricas_conversacion": {
      "ratio_habla_agente": 0.69,
      "turnos_conversacion": 49,
      "palabras_agente": 366,
      "palabras_cliente": 160
    }
  },
  
  "datos_agente": {
    "agente_id": "11111111-2222-3333-4444-555555555555",
    "nombre": "Silvano Machado",
    "equipo": "Equipo A",
    "fecha_ingreso": "2025-06-15",
    "estado": "activo"
  },
  
  "historial_cliente": {
    "_nota": "√öltimas 5 llamadas del mismo cliente (si existen)",
    "llamadas_previas": [],
    "compromisos_anteriores": [],
    "cumplimiento_historico": null
  },
  
  "info_deuda": {
    "campana": "Recuperaci√≥n Q1 2026",
    "monto_total_deuda": 438920,
    "dias_mora": null,
    "tipo_deuda": null
  }
}
</file>

<file path="docs/ag2_analista/insert_supabase.md">
# Agente Analista - INSERT en Supabase

## Tabla Destino: `analisis_llamadas`

---

## SQL de INSERT Completo

```sql
INSERT INTO analisis_llamadas (
    registro_id,
    transcripcion_id,
    agente_id,
    score_total,
    score_contacto_directo,
    score_compromiso_pago,
    modulo_contacto_directo,
    modulo_compromiso_pago,
    modulo_abandono,
    probabilidad_cumplimiento,
    nivel_cumplimiento,
    factores_prediccion,
    alertas,
    recomendaciones,
    modelo_usado,
    version_prompt,
    confianza_analisis,
    tiempo_procesamiento_ms,
    fecha_llamada
) VALUES (
    $1,   -- registro_id UUID
    $2,   -- transcripcion_id UUID
    $3,   -- agente_id UUID
    $4,   -- score_total INTEGER
    $5,   -- score_contacto_directo INTEGER
    $6,   -- score_compromiso_pago INTEGER
    $7,   -- modulo_contacto_directo JSONB
    $8,   -- modulo_compromiso_pago JSONB
    $9,   -- modulo_abandono JSONB
    $10,  -- probabilidad_cumplimiento INTEGER
    $11,  -- nivel_cumplimiento ENUM
    $12,  -- factores_prediccion JSONB
    $13,  -- alertas JSONB
    $14,  -- recomendaciones JSONB
    $15,  -- modelo_usado VARCHAR
    $16,  -- version_prompt VARCHAR
    $17,  -- confianza_analisis DECIMAL
    $18,  -- tiempo_procesamiento_ms INTEGER
    $19   -- fecha_llamada DATE
) RETURNING analisis_id;
```

---

## Ejemplo con Datos Reales (una l√≠nea)

```sql
INSERT INTO analisis_llamadas (registro_id, transcripcion_id, agente_id, score_total, score_contacto_directo, score_compromiso_pago, modulo_contacto_directo, modulo_compromiso_pago, modulo_abandono, probabilidad_cumplimiento, nivel_cumplimiento, factores_prediccion, alertas, recomendaciones, modelo_usado, version_prompt, confianza_analisis, tiempo_procesamiento_ms, fecha_llamada) VALUES ('f9725fdd-20db-43cf-a9fa-231ecbcbe3d5', 'e9066fbe-7c7c-4ec0-9bf0-8c1e68511ca9', '58e5acda-193c-4bd2-ad34-ddbb0130a9c0', 80, 80, 80, '{"score":80,"desglose":{"monto_mencionado":{"presente":true,"puntos":25,"max":25,"evidencia":"deuda de 405,302 pesos"},"fecha_vencimiento":{"presente":true,"puntos":15,"max":15,"evidencia":"antes del viernes"},"consecuencias_impago":{"presente":false,"puntos":15,"max":20,"evidencia":"No mencionadas pero cliente pagando"},"alternativas_pago":{"presente":true,"puntos":15,"max":15,"evidencia":"APP, web, sucursal"},"manejo_objeciones":{"calidad":0.4,"puntos":10,"max":25,"objeciones_detectadas":0,"detalle":"Sin objeciones"}}}'::JSONB, '{"score":80,"desglose":{"oferta_clara":{"presente":true,"puntos":20,"max":20,"evidencia":"128,888 CLP por 405,302 CLP"},"alternativas_pago":{"presente":true,"puntos":10,"max":10,"evidencia":"APP, web"},"fecha_especifica":{"presente":true,"puntos":20,"max":20,"fecha":"el s√°bado"},"validacion_cliente":{"presente":true,"tipo":"explicita","puntos":30,"max":50,"frase_exacta":"S√≠ yo creo que el s√°bado cancelo ese de 128"}}}'::JSONB, '{"hubo_abandono":false,"momento_segundos":null,"iniciado_por":null,"razon":null,"senales_previas":[]}'::JSONB, 78, 'alta', '{"factores_positivos":["Cliente ya pag√≥ ayer","Validaci√≥n expl√≠cita","Fecha espec√≠fica acordada","Actitud colaborativa"],"factores_negativos":["M√∫ltiples cr√©ditos pendientes"],"razonamiento":"La cliente demuestra patr√≥n activo de pago...","historial_cliente_considerado":false,"confianza_prediccion":0.85}'::JSONB, '[]'::JSONB, '[{"prioridad":"alta","destinatario":"sistema","accion":"Bloquear oferta hasta s√°bado","cuando":"inmediato"},{"prioridad":"media","destinatario":"agente","accion":"Confirmar pagos el lunes","cuando":"lunes"}]'::JSONB, 'claude-opus-4-5-20250514', 'v1.0', 0.92, 3200, '2026-01-31') RETURNING analisis_id;
```

---

## UPDATE de registro_llamadas

Despu√©s del INSERT, actualizar el registro:

```sql
UPDATE registro_llamadas 
SET 
    estado = 'analizado',
    analisis_id = 'UUID_DEL_ANALISIS_INSERTADO',
    updated_at = NOW()
WHERE registro_id = 'a1b2c3d4-e5f6-7890-abcd-ef1234567890';
```

**Una l√≠nea**:
```sql
UPDATE registro_llamadas SET estado = 'analizado', analisis_id = 'UUID_DEL_ANALISIS', updated_at = NOW() WHERE registro_id = 'a1b2c3d4-e5f6-7890-abcd-ef1234567890';
```

---

## Mapeo de Campos

| Campo SQL | Tipo | Fuente | Notas |
|-----------|------|--------|-------|
| `registro_id` | UUID | Webhook | FK a registro_llamadas |
| `transcripcion_id` | UUID | Webhook | FK a transcripciones |
| `agente_id` | UUID | Query registro | FK a agentes |
| `score_total` | INTEGER | Claude m√≥dulos | 0-100 |
| `score_contacto_directo` | INTEGER | Claude m√≥dulos | 0-100 |
| `score_compromiso_pago` | INTEGER | Claude m√≥dulos | 0-100 |
| `modulo_contacto_directo` | JSONB | Claude m√≥dulos | Desglose completo |
| `modulo_compromiso_pago` | JSONB | Claude m√≥dulos | Desglose completo |
| `modulo_abandono` | JSONB | Claude m√≥dulos | Info abandono |
| `probabilidad_cumplimiento` | INTEGER | Claude predicci√≥n | 0-100 |
| `nivel_cumplimiento` | ENUM | Calculado | 'baja'/'media'/'alta' |
| `factores_prediccion` | JSONB | Claude predicci√≥n | Factores +/- |
| `alertas` | JSONB | Generado | Array de alertas |
| `recomendaciones` | JSONB | Generado | Array de acciones |
| `modelo_usado` | VARCHAR | Config | claude-opus-4-5 |
| `version_prompt` | VARCHAR | Config | v1.0 |
| `confianza_analisis` | DECIMAL | Claude | 0.00-1.00 |
| `tiempo_procesamiento_ms` | INTEGER | Medido | Tiempo total |
| `fecha_llamada` | DATE | Registro | Fecha de llamada |

---

## Validaciones Pre-INSERT

```javascript
function validarAnalisis(analisis) {
  // Scores en rango
  if (analisis.score_total < 0 || analisis.score_total > 100) {
    throw new Error('score_total fuera de rango');
  }
  
  // Nivel cumplimiento v√°lido
  if (!['baja', 'media', 'alta'].includes(analisis.nivel_cumplimiento)) {
    throw new Error('nivel_cumplimiento inv√°lido');
  }
  
  // Probabilidad en rango
  if (analisis.probabilidad_cumplimiento < 0 || analisis.probabilidad_cumplimiento > 100) {
    throw new Error('probabilidad_cumplimiento fuera de rango');
  }
  
  // Confianza en rango
  if (analisis.confianza_analisis < 0 || analisis.confianza_analisis > 1) {
    throw new Error('confianza_analisis fuera de rango');
  }
  
  // JSONs no nulos
  if (!analisis.modulo_contacto_directo || !analisis.modulo_compromiso_pago) {
    throw new Error('M√≥dulos de an√°lisis incompletos');
  }
  
  return true;
}
```

---

## Supabase JS SDK

```javascript
const { data, error } = await supabase
  .from('analisis_llamadas')
  .insert({
    registro_id: 'a1b2c3d4-e5f6-7890-abcd-ef1234567890',
    transcripcion_id: 'f1e2d3c4-b5a6-7890-1234-567890abcdef',
    agente_id: '11111111-2222-3333-4444-555555555555',
    score_total: 80,
    score_contacto_directo: 80,
    score_compromiso_pago: 80,
    modulo_contacto_directo: { score: 80, desglose: {...} },
    modulo_compromiso_pago: { score: 80, desglose: {...} },
    modulo_abandono: { hubo_abandono: false },
    probabilidad_cumplimiento: 78,
    nivel_cumplimiento: 'alta',
    factores_prediccion: { factores_positivos: [...], factores_negativos: [...] },
    alertas: [],
    recomendaciones: [...],
    modelo_usado: 'claude-opus-4-5-20250514',
    version_prompt: 'v1.0',
    confianza_analisis: 0.92,
    tiempo_procesamiento_ms: 3200,
    fecha_llamada: '2026-01-31'
  })
  .select('analisis_id')
  .single();

if (error) throw error;

// Update registro
await supabase
  .from('registro_llamadas')
  .update({ 
    estado: 'analizado', 
    analisis_id: data.analisis_id 
  })
  .eq('registro_id', 'a1b2c3d4-e5f6-7890-abcd-ef1234567890');
```
</file>

<file path="docs/ag2_analista/output_ejemplo.json">
{
  "_comentario": "Este es el output que genera el Agente Analista para INSERT en analisis_llamadas",
  
  "registro_id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "transcripcion_id": "f1e2d3c4-b5a6-7890-1234-567890abcdef",
  "agente_id": "11111111-2222-3333-4444-555555555555",
  
  "score_total": 80,
  "score_contacto_directo": 80,
  "score_compromiso_pago": 80,
  
  "modulo_contacto_directo": {
    "score": 80,
    "desglose": {
      "monto_mencionado": {
        "presente": true,
        "puntos": 25,
        "max": 25,
        "evidencia": "deuda de 405,302 pesos"
      },
      "fecha_vencimiento": {
        "presente": true,
        "puntos": 15,
        "max": 15,
        "evidencia": "antes del viernes para que aproveche la oferta"
      },
      "consecuencias_impago": {
        "presente": false,
        "puntos": 15,
        "max": 20,
        "evidencia": "No mencionadas, pero cliente ya activamente pagando (se otorgan 15 pts)"
      },
      "alternativas_pago": {
        "presente": true,
        "puntos": 15,
        "max": 15,
        "evidencia": "APP m√≥vil, p√°gina web, sucursal (para repactaci√≥n)"
      },
      "manejo_objeciones": {
        "calidad": 0.4,
        "puntos": 10,
        "max": 25,
        "objeciones_detectadas": 0,
        "detalle": "No hubo objeciones del cliente. Se otorgan puntos parciales porque el agente no profundiz√≥ en la situaci√≥n financiera actual."
      }
    }
  },
  
  "modulo_compromiso_pago": {
    "score": 80,
    "desglose": {
      "oferta_clara": {
        "presente": true,
        "puntos": 20,
        "max": 20,
        "evidencia": "Oferta de 128,888 CLP para saldar deuda de 405,302 CLP (descuento del 68%)"
      },
      "alternativas_pago": {
        "presente": true,
        "puntos": 10,
        "max": 10,
        "evidencia": "APP, web, sucursal"
      },
      "fecha_especifica": {
        "presente": true,
        "puntos": 20,
        "max": 20,
        "fecha": "el s√°bado"
      },
      "validacion_cliente": {
        "presente": true,
        "tipo": "explicita",
        "puntos": 30,
        "max": 50,
        "frase_exacta": "S√≠ yo creo que el s√°bado cancelo ese de 128 y ya me quedar√≠a el otro nom√°s"
      }
    }
  },
  
  "modulo_abandono": {
    "hubo_abandono": false,
    "momento_segundos": null,
    "iniciado_por": null,
    "razon": null,
    "senales_previas": []
  },
  
  "probabilidad_cumplimiento": 78,
  "nivel_cumplimiento": "alta",
  
  "factores_prediccion": {
    "factores_positivos": [
      "Cliente ya pag√≥ un cr√©dito el d√≠a anterior v√≠a APP",
      "Validaci√≥n expl√≠cita del compromiso de pago",
      "Fecha espec√≠fica acordada (s√°bado)",
      "Actitud colaborativa y aliviada del cliente",
      "Cliente pregunta activamente sobre fechas y montos",
      "Evoluci√≥n emocional positiva durante la llamada",
      "Cliente tiene inter√©s en regularizar todas sus deudas (pregunt√≥ por repactaci√≥n)"
    ],
    "factores_negativos": [
      "M√∫ltiples cr√©ditos pendientes (3 activos)",
      "No se mencionaron consecuencias de impago",
      "Validaci√≥n usa 'yo creo' (ligera incertidumbre)"
    ],
    "razonamiento": "La cliente Yessenia Gonz√°lez demuestra un patr√≥n muy activo de pago: ya liquid√≥ un cr√©dito el d√≠a anterior y expresa compromiso de pagar otros dos en los pr√≥ximos d√≠as. Su evoluci√≥n emocional durante la llamada fue de neutral a aliviada, lo que indica satisfacci√≥n con las ofertas recibidas. El uso de 'yo creo que' introduce una ligera incertidumbre, pero el contexto general (cliente iniciativa propia de preguntar fechas, bloqueo de oferta por el agente, conocimiento de la plataforma de pago) sugiere alta probabilidad de cumplimiento. El principal riesgo es la acumulaci√≥n de compromisos (ma√±ana + s√°bado), pero el monto del viernes es peque√±o (10,607 CLP).",
    "historial_cliente_considerado": false,
    "confianza_prediccion": 0.85
  },
  
  "alertas": [],
  
  "recomendaciones": [
    {
      "prioridad": "alta",
      "destinatario": "sistema",
      "accion": "Bloquear oferta de 128,888 CLP en el sistema hasta el s√°bado",
      "cuando": "inmediato"
    },
    {
      "prioridad": "media",
      "destinatario": "sistema",
      "accion": "Programar recordatorio de pago para el viernes (cr√©dito 6564)",
      "cuando": "jueves"
    },
    {
      "prioridad": "media",
      "destinatario": "agente",
      "accion": "Llamar el lunes para confirmar ambos pagos realizados",
      "cuando": "lunes"
    },
    {
      "prioridad": "baja",
      "destinatario": "sucursal",
      "accion": "Preparar informaci√≥n de repactaci√≥n por si la cliente visita",
      "cuando": "pr√≥xima semana"
    }
  ],
  
  "modelo_usado": "claude-opus-4-5-20250514",
  "version_prompt": "v1.0",
  "confianza_analisis": 0.92,
  "tiempo_procesamiento_ms": 3200,
  "fecha_llamada": "2026-01-31"
}
</file>

<file path="docs/ag2_analista/plan_implementacion.md">
# Plan de Implementaci√≥n - Agente Analista

## üìã Resumen

| Aspecto | Detalle |
|---------|---------|
| **Tiempo estimado** | 3-5 d√≠as |
| **Complejidad** | Media-Alta |
| **Dependencias** | Agente Transcriptor funcionando, Supabase configurado |
| **Tecnolog√≠as** | Saturn Studio, Claude Opus 4.5, Supabase |

---

## üéØ Objetivos del Sprint

1. ‚úÖ Implementar webhook receptor desde Transcriptor
2. ‚úÖ Crear flujo de obtenci√≥n de contexto
3. ‚úÖ Integrar Claude para evaluaci√≥n de m√≥dulos
4. ‚úÖ Integrar Claude para predicci√≥n de cumplimiento
5. ‚úÖ Implementar l√≥gica de alertas y recomendaciones
6. ‚úÖ Configurar INSERT en Supabase
7. ‚úÖ Configurar webhook condicional al Detector
8. ‚úÖ Testing end-to-end

---

## üìù Checklist Detallado

### Fase 1: Preparaci√≥n (D√≠a 1 - Ma√±ana)

#### 1.1 Configuraci√≥n de Entorno
- [ ] Verificar acceso a Saturn Studio
- [ ] Verificar API key de Anthropic (Claude)
- [ ] Verificar conexi√≥n a Supabase
- [ ] Crear variables de entorno:
  ```
  CLAUDE_API_KEY=sk-ant-xxx
  CLAUDE_MODEL=claude-opus-4-5-20250514
  SUPABASE_URL=https://xxx.supabase.co
  SUPABASE_KEY=xxx
  WEBHOOK_DETECTOR_URL=https://xxx
  ```

#### 1.2 Verificar Schema de Supabase
- [ ] Confirmar tabla `analisis_llamadas` existe con todos los campos
- [ ] Verificar constraints (0-100 en scores, ENUM en nivel_cumplimiento)
- [ ] Verificar √≠ndices est√°n creados
- [ ] Probar INSERT manual con datos de ejemplo

#### 1.3 Verificar Agente Transcriptor
- [ ] Confirmar que Transcriptor est√° funcionando
- [ ] Verificar que el webhook de salida tiene el formato correcto
- [ ] Obtener URL del webhook del Analista para configurar en Transcriptor

---

### Fase 2: Desarrollo del Flujo (D√≠a 1 - Tarde a D√≠a 2)

#### 2.1 Crear Webhook Receptor en Saturn Studio
- [ ] Crear nuevo flujo "Agente Analista"
- [ ] Configurar trigger: HTTP Webhook POST
- [ ] Endpoint: `/webhooks/analizar-llamada`
- [ ] Validar payload de entrada:
  ```json
  {
    "registro_id": "required|uuid",
    "transcripcion_id": "required|uuid"
  }
  ```
- [ ] Configurar timeout: 2 minutos
- [ ] Configurar retry: 2 intentos

#### 2.2 Nodo: Obtener Contexto
- [ ] Crear nodo de Supabase Query
- [ ] Query 1: Obtener transcripci√≥n completa
  ```sql
  SELECT * FROM transcripciones 
  WHERE transcripcion_id = {{transcripcion_id}}
  ```
- [ ] Query 2: Obtener registro y agente
  ```sql
  SELECT rl.*, a.nombre, a.equipo 
  FROM registro_llamadas rl
  LEFT JOIN agentes a ON rl.agente_id = a.agente_id
  WHERE rl.registro_id = {{registro_id}}
  ```
- [ ] Query 3: Obtener historial cliente
  ```sql
  SELECT al.* FROM analisis_llamadas al
  JOIN registro_llamadas rl ON al.registro_id = rl.registro_id
  WHERE rl.cliente_nombre = {{cliente_nombre}}
  ORDER BY al.created_at DESC LIMIT 5
  ```
- [ ] Configurar queries en paralelo para optimizar tiempo

#### 2.3 Nodo: Preparar Prompt M√≥dulos
- [ ] Crear nodo de transformaci√≥n JavaScript
- [ ] Cargar template de `prompt_modulos.md`
- [ ] Inyectar variables:
  - `{{transcripcion_completa}}`
  - `{{segmentos_json}}`
  - `{{entidades_json}}`
  - `{{patrones_script_json}}`
  - `{{resultado_preliminar_json}}`
- [ ] Validar que el prompt no exceda l√≠mites de tokens

#### 2.4 Nodo: Llamar Claude - M√≥dulos
- [ ] Crear nodo de API Call a Anthropic
- [ ] Configurar:
  - Model: `claude-opus-4-5-20250514`
  - Temperature: 0.2
  - Max tokens: 4000
- [ ] Parsear respuesta JSON
- [ ] Validar estructura de respuesta:
  - `modulo_contacto_directo.score` existe
  - `modulo_compromiso_pago.score` existe
  - `modulo_abandono.hubo_abandono` existe
- [ ] Manejar errores de parsing

#### 2.5 Nodo: Preparar Prompt Predicci√≥n
- [ ] Crear nodo de transformaci√≥n
- [ ] Cargar template de `prompt_prediccion.md`
- [ ] Inyectar variables:
  - `{{analisis_modulos_json}}`
  - `{{resultado_preliminar_json}}`
  - `{{historial_cliente_json}}`
  - `{{info_deuda_json}}`

#### 2.6 Nodo: Llamar Claude - Predicci√≥n
- [ ] Crear nodo de API Call a Anthropic
- [ ] Configurar:
  - Model: `claude-opus-4-5-20250514`
  - Temperature: 0.3
  - Max tokens: 2000
- [ ] Parsear respuesta JSON
- [ ] Validar:
  - `probabilidad_cumplimiento` en rango 0-100
  - `nivel_cumplimiento` es 'baja', 'media' o 'alta'

---

### Fase 3: L√≥gica de Negocio (D√≠a 2 - Tarde)

#### 3.1 Nodo: Generar Alertas
- [ ] Crear nodo JavaScript
- [ ] Implementar funci√≥n `generarAlertas()` seg√∫n `reglas_alertas.md`
- [ ] Reglas a implementar:
  - [ ] SCORE_CRITICO (< 30)
  - [ ] SCORE_BAJO (30-50)
  - [ ] FALTA_VALIDACION
  - [ ] VALIDACION_DEBIL
  - [ ] ABANDONO_LLAMADA
  - [ ] PROBABILIDAD_BAJA
- [ ] Retornar array de alertas con estructura correcta

#### 3.2 Nodo: Generar Recomendaciones
- [ ] Crear nodo JavaScript
- [ ] Implementar funci√≥n `generarRecomendaciones()`
- [ ] Tipos de recomendaciones:
  - [ ] Seguimiento de pago
  - [ ] Refuerzo de compromiso
  - [ ] Revisi√≥n de coaching
  - [ ] Acciones del sistema
- [ ] Asignar prioridades correctamente

#### 3.3 Nodo: Construir Objeto Final
- [ ] Crear nodo de transformaci√≥n
- [ ] Combinar todos los datos:
  ```javascript
  {
    registro_id,
    transcripcion_id,
    agente_id,
    score_total,
    score_contacto_directo,
    score_compromiso_pago,
    modulo_contacto_directo,
    modulo_compromiso_pago,
    modulo_abandono,
    probabilidad_cumplimiento,
    nivel_cumplimiento,
    factores_prediccion,
    alertas,
    recomendaciones,
    modelo_usado,
    version_prompt,
    confianza_analisis,
    tiempo_procesamiento_ms,
    fecha_llamada
  }
  ```
- [ ] Calcular `tiempo_procesamiento_ms`
- [ ] Validar objeto completo antes de INSERT

---

### Fase 4: Persistencia (D√≠a 3 - Ma√±ana)

#### 4.1 Nodo: INSERT analisis_llamadas
- [ ] Crear nodo Supabase Insert
- [ ] Mapear todos los campos
- [ ] Configurar RETURNING para obtener `analisis_id`
- [ ] Manejar errores de constraint
- [ ] Manejar errores de duplicado

#### 4.2 Nodo: UPDATE registro_llamadas
- [ ] Crear nodo Supabase Update
- [ ] Actualizar:
  - `estado = 'analizado'`
  - `analisis_id = {{analisis_id}}`
  - `updated_at = NOW()`
- [ ] Verificar que el UPDATE fue exitoso

---

### Fase 5: Integraci√≥n con Detector (D√≠a 3 - Tarde)

#### 5.1 Nodo: Evaluar Trigger Detector
- [ ] Crear nodo condicional
- [ ] Implementar funci√≥n `debeDispararDetector()`
- [ ] Condiciones:
  - Severidad cr√≠tica: siempre disparar
  - Severidad alta + c√≥digos espec√≠ficos: disparar
  - Resto: no disparar

#### 5.2 Nodo: Webhook al Detector
- [ ] Crear nodo HTTP Request (condicional)
- [ ] Endpoint: `{{WEBHOOK_DETECTOR_URL}}`
- [ ] Method: POST
- [ ] Payload:
  ```json
  {
    "trigger": "analisis_individual",
    "analisis_id": "{{analisis_id}}",
    "registro_id": "{{registro_id}}",
    "agente_id": "{{agente_id}}",
    "alertas": [...],
    "timestamp": "{{now}}"
  }
  ```
- [ ] No esperar respuesta (async)

---

### Fase 6: Testing (D√≠a 4)

#### 6.1 Tests Unitarios
- [ ] Test: Validaci√≥n de payload de entrada
- [ ] Test: Queries de contexto retornan datos correctos
- [ ] Test: Prompt de m√≥dulos se construye correctamente
- [ ] Test: Respuesta de Claude se parsea correctamente
- [ ] Test: Alertas se generan seg√∫n reglas
- [ ] Test: Recomendaciones se generan correctamente
- [ ] Test: INSERT en Supabase funciona

#### 6.2 Tests de Integraci√≥n
- [ ] Test E2E: Llamada exitosa con score alto
  - Input: Transcripci√≥n con validaci√≥n expl√≠cita
  - Expected: score > 70, probabilidad > 70, sin alertas
- [ ] Test E2E: Llamada con score bajo
  - Input: Transcripci√≥n sin validaci√≥n
  - Expected: score < 50, alertas generadas, webhook a Detector
- [ ] Test E2E: Llamada con abandono
  - Input: Transcripci√≥n con abandono
  - Expected: alerta ABANDONO_LLAMADA, webhook a Detector
- [ ] Test E2E: Cliente con historial
  - Input: Cliente que ya tiene llamadas previas
  - Expected: historial_cliente_considerado = true

#### 6.3 Tests de Performance
- [ ] Medir tiempo total del flujo (target: < 10s)
- [ ] Medir tiempo de cada nodo
- [ ] Identificar cuellos de botella
- [ ] Optimizar si es necesario

---

### Fase 7: Despliegue y Monitoreo (D√≠a 5)

#### 7.1 Configurar Transcriptor
- [ ] Actualizar Agente Transcriptor con URL del Analista
- [ ] Verificar que el webhook se dispara correctamente
- [ ] Probar flujo completo: Audio ‚Üí Transcriptor ‚Üí Analista

#### 7.2 Configurar Logging
- [ ] Logs de inicio/fin de cada ejecuci√≥n
- [ ] Logs de errores con stack trace
- [ ] Logs de m√©tricas (tiempo, scores)

#### 7.3 Configurar Alertas de Monitoreo
- [ ] Alerta si tiempo > 15s
- [ ] Alerta si tasa de error > 5%
- [ ] Alerta si errores de Claude
- [ ] Dashboard de m√©tricas

#### 7.4 Documentaci√≥n Final
- [ ] Actualizar README del agente
- [ ] Documentar troubleshooting com√∫n
- [ ] Crear runbook de operaciones

---

## üö® Riesgos y Mitigaciones

| Riesgo | Probabilidad | Impacto | Mitigaci√≥n |
|--------|--------------|---------|------------|
| Claude no retorna JSON v√°lido | Media | Alto | Retry con instrucci√≥n m√°s expl√≠cita |
| Timeout en llamadas a Claude | Baja | Alto | Configurar timeout de 60s, retry |
| Historial de cliente vac√≠o | Alta | Bajo | Manejar caso null correctamente |
| Score fuera de rango | Baja | Medio | Validar y recortar a 0-100 |
| Supabase no disponible | Muy baja | Alto | Retry, notificar error |

---

## üìä M√©tricas de √âxito

| M√©trica | Target | Cr√≠tico |
|---------|--------|---------|
| Tiempo promedio | < 5s | > 15s |
| Tasa de √©xito | > 99% | < 95% |
| Errores de Claude | < 1% | > 5% |
| Cobertura de alertas | 100% | < 90% |
| Precisi√≥n de scores | N/A | Validar con muestras manuales |

---

## üìÖ Cronograma

```
D√≠a 1 (Ma√±ana):  Preparaci√≥n + Configuraci√≥n
D√≠a 1 (Tarde):   Webhook + Contexto
D√≠a 2 (Ma√±ana):  Nodos Claude (M√≥dulos + Predicci√≥n)
D√≠a 2 (Tarde):   L√≥gica de Alertas + Recomendaciones
D√≠a 3 (Ma√±ana):  Persistencia Supabase
D√≠a 3 (Tarde):   Integraci√≥n con Detector
D√≠a 4:           Testing completo
D√≠a 5:           Despliegue + Monitoreo
```

---

## ‚úÖ Criterios de Aceptaci√≥n

1. El Analista procesa correctamente webhooks del Transcriptor
2. Los scores se calculan seg√∫n las reglas definidas
3. La probabilidad de cumplimiento considera todos los factores
4. Las alertas se generan autom√°ticamente seg√∫n severidad
5. El INSERT en Supabase es exitoso y completo
6. El webhook al Detector se dispara condicionalmente
7. El tiempo total de procesamiento es < 10s
8. La tasa de √©xito es > 99%
</file>

<file path="docs/ag2_analista/prompt_modulos.md">
# Prompt: Evaluaci√≥n de M√≥dulos de Scoring

## Modelo
- **LLM**: Claude Opus 4.5 (`claude-opus-4-5-20250514`)
- **Temperature**: 0.2 (determin√≠stico)
- **Max Tokens**: 4000

---

## PROMPT

```
Eres un experto analista de calidad en cobranzas telef√≥nicas. Tu trabajo es evaluar llamadas de cobranza seg√∫n criterios objetivos y medibles.

## CONTEXTO
Se te proporciona la transcripci√≥n completa de una llamada de cobranza, junto con las entidades extra√≠das y an√°lisis emocional previo.

## TAREA
Eval√∫a la llamada seg√∫n 3 m√≥dulos y genera un an√°lisis estructurado.

---

## M√ìDULO 1: CONTACTO DIRECTO (0-100 puntos)

Eval√∫a si el agente comunic√≥ correctamente la informaci√≥n de la deuda.

### Criterios de Evaluaci√≥n:

1. **MONTO MENCIONADO (25 pts m√°ximo)**
   - 25 pts: El agente menciona el monto exacto de la deuda de forma clara
   - 15 pts: El agente menciona un rango o aproximaci√≥n
   - 0 pts: No se menciona el monto
   - EVIDENCIA: Cita la frase exacta donde se menciona

2. **FECHA VENCIMIENTO (15 pts m√°ximo)**
   - 15 pts: Se explica claramente cu√°ndo vence/venci√≥ la deuda o plazo de oferta
   - 8 pts: Se menciona de forma vaga ("hace tiempo", "ya pas√≥")
   - 0 pts: No se menciona
   - EVIDENCIA: Cita la frase exacta

3. **CONSECUENCIAS DE IMPAGO (20 pts m√°ximo)**
   - 20 pts: Se explican consecuencias claramente (reporte crediticio, intereses, acciones legales)
   - 10 pts: Se mencionan de forma vaga o incompleta
   - 0 pts: No se mencionan consecuencias
   - NOTA: Si el cliente ya est√° pagando activamente, este criterio puede obviarse (dar 15 pts)
   - EVIDENCIA: Cita la frase o indica "no mencionado"

4. **ALTERNATIVAS DE PAGO (15 pts m√°ximo)**
   - 15 pts: Se ofrecen 2+ alternativas claras (app, web, sucursal, transferencia)
   - 8 pts: Se ofrece 1 alternativa
   - 0 pts: No se ofrecen alternativas
   - EVIDENCIA: Lista los m√©todos mencionados

5. **MANEJO DE OBJECIONES (25 pts m√°ximo)**
   - Eval√∫a c√≥mo el agente responde a dudas, resistencia o preguntas del cliente
   - Si no hay objeciones, dar 25 pts (no hubo nada que manejar)
   - Si hay objeciones:
     * 25 pts: Todas manejadas de forma efectiva y emp√°tica
     * 15-20 pts: Mayor√≠a manejadas bien
     * 5-15 pts: Manejo parcial o inadecuado
     * 0 pts: Objeciones ignoradas o mal manejadas
   - EVIDENCIA: Describe cada objeci√≥n y c√≥mo se manej√≥

---

## M√ìDULO 2: COMPROMISO DE PAGO (0-100 puntos)

Eval√∫a si se logr√≥ un compromiso concreto de pago.

### Criterios de Evaluaci√≥n:

1. **OFERTA CLARA (20 pts m√°ximo)**
   - 20 pts: Se presenta una oferta concreta (descuento, monto espec√≠fico, plan de pagos)
   - 10 pts: Oferta mencionada pero no clara
   - 0 pts: No hay oferta
   - EVIDENCIA: Detalla la oferta presentada

2. **ALTERNATIVAS DE PAGO (10 pts m√°ximo)**
   - 10 pts: Se mencionan formas de realizar el pago
   - 5 pts: Solo una forma mencionada
   - 0 pts: No se menciona c√≥mo pagar
   - EVIDENCIA: Lista las alternativas

3. **FECHA ESPEC√çFICA (20 pts m√°ximo)**
   - 20 pts: Se acuerda una fecha espec√≠fica ("el viernes", "ma√±ana", "el 15 de febrero")
   - 10 pts: Fecha vaga ("pronto", "esta semana")
   - 0 pts: No se menciona fecha
   - EVIDENCIA: Cita la fecha acordada

4. **VALIDACI√ìN DEL CLIENTE (50 pts m√°ximo) ‚Üê CR√çTICO**
   Este es el criterio M√ÅS IMPORTANTE. Sin validaci√≥n expl√≠cita, el compromiso no tiene valor.
   
   - 50 pts (EXPL√çCITA): El cliente confirma claramente con frases como:
     * "S√≠, confirmo que pagar√© el [fecha]"
     * "Correcto, har√© el pago de [monto]"
     * "De acuerdo, me comprometo a pagar"
     * "S√≠, el s√°bado pago los 128 mil"
   
   - 8-15 pts (IMPL√çCITA): El cliente asiente pero no confirma claramente:
     * "ok", "ya", "aj√°", "entiendo"
     * "bueno", "est√° bien"
     * Silencio o respuesta ambigua
   
   - 0 pts (NINGUNA): El cliente no confirma nada o rechaza
   
   - EVIDENCIA: Cita la frase EXACTA del cliente

---

## M√ìDULO 3: ABANDONO

Eval√∫a si la llamada termin√≥ prematuramente.

### Criterios:

1. **¬øHubo abandono?** (true/false)
   - true: La llamada termin√≥ antes de un cierre natural
   - false: La llamada termin√≥ con despedida apropiada

2. **Si hubo abandono:**
   - **momento_segundos**: ¬øEn qu√© segundo aproximado ocurri√≥?
   - **iniciado_por**: "cliente" | "agente" | "tecnico"
   - **razon**: Describe la raz√≥n probable
   - **senales_previas**: Lista se√±ales de que el abandono era inminente

---

## DATOS DE ENTRADA

### Transcripci√≥n:
{transcripcion_completa}

### Segmentos con emociones:
{segmentos_json}

### Entidades extra√≠das:
{entidades_json}

### Patrones de script detectados:
{patrones_script_json}

### Resultado preliminar:
{resultado_preliminar_json}

---

## FORMATO DE RESPUESTA (JSON)

Responde √öNICAMENTE con el siguiente JSON, sin texto adicional:

{
  "modulo_contacto_directo": {
    "score": 0-100,
    "desglose": {
      "monto_mencionado": {
        "presente": true/false,
        "puntos": 0-25,
        "max": 25,
        "evidencia": "frase exacta o 'no mencionado'"
      },
      "fecha_vencimiento": {
        "presente": true/false,
        "puntos": 0-15,
        "max": 15,
        "evidencia": "frase exacta o 'no mencionado'"
      },
      "consecuencias_impago": {
        "presente": true/false,
        "puntos": 0-20,
        "max": 20,
        "evidencia": "frase exacta o 'no mencionado'"
      },
      "alternativas_pago": {
        "presente": true/false,
        "puntos": 0-15,
        "max": 15,
        "evidencia": "lista de m√©todos"
      },
      "manejo_objeciones": {
        "calidad": 0.0-1.0,
        "puntos": 0-25,
        "max": 25,
        "objeciones_detectadas": 0-N,
        "detalle": "descripci√≥n del manejo"
      }
    }
  },
  "modulo_compromiso_pago": {
    "score": 0-100,
    "desglose": {
      "oferta_clara": {
        "presente": true/false,
        "puntos": 0-20,
        "max": 20,
        "evidencia": "detalle de la oferta"
      },
      "alternativas_pago": {
        "presente": true/false,
        "puntos": 0-10,
        "max": 10,
        "evidencia": "lista de alternativas"
      },
      "fecha_especifica": {
        "presente": true/false,
        "puntos": 0-20,
        "max": 20,
        "fecha": "fecha acordada o null"
      },
      "validacion_cliente": {
        "presente": true/false,
        "tipo": "explicita" | "implicita" | "ninguna",
        "puntos": 0-50,
        "max": 50,
        "frase_exacta": "frase del cliente"
      }
    }
  },
  "modulo_abandono": {
    "hubo_abandono": true/false,
    "momento_segundos": null o n√∫mero,
    "iniciado_por": null | "cliente" | "agente" | "tecnico",
    "razon": null o "descripci√≥n",
    "senales_previas": []
  },
  "score_total": 0-100,
  "notas_evaluacion": "Resumen breve de la evaluaci√≥n"
}
```

---

## Notas de Implementaci√≥n

### Variables a inyectar:
- `{transcripcion_completa}`: String con toda la transcripci√≥n
- `{segmentos_json}`: JSON de segmentos con emociones
- `{entidades_json}`: JSON de entidades extra√≠das
- `{patrones_script_json}`: JSON con patrones de script
- `{resultado_preliminar_json}`: JSON con resultado preliminar

### C√°lculo del score_total:
```
score_total = (modulo_contacto_directo.score + modulo_compromiso_pago.score) / 2
```

Si hay abandono, se aplica penalizaci√≥n:
- Abandono por cliente: -10 puntos
- Abandono por agente: -20 puntos
- Abandono t√©cnico: sin penalizaci√≥n

### Validaci√≥n del Output:
1. Verificar que todos los scores est√©n en rango 0-100
2. Verificar que la suma de puntos por m√≥dulo no exceda el m√°ximo
3. Verificar que las evidencias no est√©n vac√≠as
4. Verificar que validacion_cliente.tipo sea uno de los valores permitidos
</file>

<file path="docs/ag2_analista/prompt_prediccion.md">
# Prompt: Predicci√≥n de Probabilidad de Cumplimiento

## Modelo
- **LLM**: Claude Opus 4.5 (`claude-opus-4-5-20250514`)
- **Temperature**: 0.3
- **Max Tokens**: 2000

---

## PROMPT

```
Eres un experto en an√°lisis predictivo de cobranzas. Tu trabajo es estimar la probabilidad de que un cliente cumpla con el compromiso de pago realizado en una llamada.

## CONTEXTO

Tienes acceso a:
1. El an√°lisis de la llamada actual (scores, validaci√≥n, resultado)
2. El historial del cliente (si existe)
3. Informaci√≥n contextual de la deuda

## TAREA

Calcula la probabilidad de cumplimiento (0-100%) bas√°ndote en m√∫ltiples factores.

---

## MODELO DE PREDICCI√ìN

### Base seg√∫n tipo de validaci√≥n:
- Validaci√≥n EXPL√çCITA: Base = 60%
- Validaci√≥n IMPL√çCITA: Base = 35%
- Sin validaci√≥n: Base = 15%

### Ajustes positivos (sumar):
| Factor | Ajuste | Condici√≥n |
|--------|--------|-----------|
| Historial positivo | +15% | Cliente pag√≥ en llamadas anteriores |
| Fecha espec√≠fica | +10% | Se acord√≥ fecha concreta |
| Monto accesible | +5% | Monto < 50% del promedio campa√±a |
| M√∫ltiples alternativas | +5% | Se ofrecieron 2+ formas de pago |
| Tono positivo cliente | +5% | Emoci√≥n dominante positiva |
| Pago reciente | +10% | Cliente ya hizo un pago recientemente |
| Compromiso verbal fuerte | +5% | Frases como "definitivamente", "seguro" |

### Ajustes negativos (restar):
| Factor | Ajuste | Condici√≥n |
|--------|--------|-----------|
| Historial negativo | -20% | Cliente incumpli√≥ compromisos anteriores |
| Objeciones sin resolver | -15% | Hay objeciones no manejadas |
| Mora > 90 d√≠as | -10% | D√≠as de mora elevados |
| Abandono previo | -10% | Historial de abandonos |
| Tono negativo cliente | -10% | Emoci√≥n dominante negativa/frustrada |
| Sin fecha espec√≠fica | -10% | No se acord√≥ fecha |
| Monto muy alto | -5% | Monto > 150% del promedio |
| Excusas recurrentes | -15% | Cliente da m√∫ltiples excusas |

### Ajuste por calidad del agente:
- Score total > 80: +5%
- Score total < 40: -10%

### L√≠mites:
- M√≠nimo: 5%
- M√°ximo: 95%

---

## DATOS DE ENTRADA

### An√°lisis de la llamada actual:
{analisis_modulos_json}

### Resultado preliminar:
{resultado_preliminar_json}

### Historial del cliente (√∫ltimas 5 llamadas):
{historial_cliente_json}
// null si no hay historial

### Informaci√≥n de la deuda:
{info_deuda_json}

---

## FORMATO DE RESPUESTA (JSON)

{
  "probabilidad_cumplimiento": 0-100,
  "nivel_cumplimiento": "baja" | "media" | "alta",
  "calculo": {
    "base": 60,
    "ajustes_positivos": [
      {"factor": "pago_reciente", "ajuste": 10, "razon": "Cliente pag√≥ ayer"},
      {"factor": "fecha_especifica", "ajuste": 10, "razon": "Acord√≥ pagar el s√°bado"}
    ],
    "ajustes_negativos": [
      {"factor": "multiples_deudas", "ajuste": -5, "razon": "Tiene 3 cr√©ditos pendientes"}
    ],
    "subtotal": 75,
    "ajuste_calidad_agente": 3,
    "total_antes_limites": 78,
    "total_final": 78
  },
  "factores_prediccion": {
    "factores_positivos": [
      "Cliente ya pag√≥ un cr√©dito ayer",
      "Validaci√≥n expl√≠cita del compromiso",
      "Fecha espec√≠fica acordada (s√°bado)",
      "Actitud colaborativa del cliente",
      "Agente ofreci√≥ m√∫ltiples alternativas"
    ],
    "factores_negativos": [
      "M√∫ltiples cr√©ditos pendientes",
      "No se mencionaron consecuencias de impago"
    ],
    "razonamiento": "La cliente demuestra un patr√≥n activo de pago (pag√≥ ayer) y confirm√≥ expl√≠citamente el compromiso para el s√°bado. Su actitud emocional evolucion√≥ positivamente durante la llamada, pasando de neutral a aliviada. Aunque tiene m√∫ltiples cr√©ditos, est√° abord√°ndolos proactivamente. El riesgo principal es la acumulaci√≥n de compromisos.",
    "historial_cliente_considerado": true,
    "confianza_prediccion": 0.85
  },
  "clasificacion_nivel": {
    "baja": "0-40%",
    "media": "41-70%",
    "alta": "71-100%"
  }
}

---

## REGLAS ADICIONALES

1. **Prioridad de la validaci√≥n**: 
   - Sin validaci√≥n expl√≠cita, la probabilidad NUNCA debe superar 50%
   - Con validaci√≥n expl√≠cita, la base ya es 60% (muy significativo)

2. **Historial es crucial**:
   - Si el cliente tiene historial de incumplimiento, ser muy conservador
   - Si es cliente nuevo (sin historial), usar base +/- 5%

3. **Coherencia emocional**:
   - Si el cliente termin√≥ con emoci√≥n negativa, reducir 10% adicional
   - Si el cliente termin√≥ aliviado/positivo, mantener o aumentar

4. **Red flags**:
   - "No tengo dinero" + "s√≠ pagar√©" = -20%
   - M√∫ltiples excusas = -15%
   - Silencio prolongado despu√©s de propuesta = -10%

5. **Green flags**:
   - Cliente pregunta c√≥mo pagar = +5%
   - Cliente menciona fecha por iniciativa propia = +10%
   - Cliente agradece la oferta = +5%
```

---

## Notas de Implementaci√≥n

### Variables a inyectar:
- `{analisis_modulos_json}`: Output del prompt_modulos
- `{resultado_preliminar_json}`: Del Transcriptor
- `{historial_cliente_json}`: Query a analisis_llamadas
- `{info_deuda_json}`: De registro_llamadas

### Clasificaci√≥n de nivel:
```javascript
function clasificarNivel(probabilidad) {
  if (probabilidad <= 40) return 'baja';
  if (probabilidad <= 70) return 'media';
  return 'alta';
}
```

### Validaci√≥n del Output:
1. probabilidad_cumplimiento debe estar entre 5 y 95
2. nivel_cumplimiento debe ser consistente con la probabilidad
3. Debe haber al menos 1 factor positivo o negativo
4. razonamiento debe tener m√≠nimo 50 caracteres
</file>

<file path="docs/ag2_analista/README.md">
# Agente 2: Analista

## Visi√≥n General

El Agente Analista eval√∫a la calidad de cada llamada usando 3 m√≥dulos de scoring, calcula la probabilidad de cumplimiento del compromiso de pago y genera alertas/recomendaciones.

## Pipeline de Procesamiento

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                          AGENTE ANALISTA                                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                              ‚îÇ
‚îÇ  INPUT: Webhook desde Agente Transcriptor                                   ‚îÇ
‚îÇ  {registro_id, transcripcion_id}                                            ‚îÇ
‚îÇ                                                                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ PASO 1: Obtener Contexto (Supabase)                                  ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - SELECT transcripcion completa desde transcripciones                ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - SELECT info del agente desde agentes                               ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - SELECT historial del cliente (llamadas previas)                    ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                              ‚îÇ                                               ‚îÇ
‚îÇ                              ‚ñº                                               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ PASO 2: Evaluar M√≥dulos (Claude Opus 4.5)                            ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ                                                                       ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ M√ìDULO 1: CONTACTO DIRECTO (0-100 pts)                               ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ ‚îú‚îÄ Monto mencionado claramente (25 pts)                              ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ ‚îú‚îÄ Fecha vencimiento explicada (15 pts)                              ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ ‚îú‚îÄ Consecuencias impago mencionadas (20 pts)                         ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ ‚îú‚îÄ Alternativas de pago ofrecidas (15 pts)                           ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ ‚îî‚îÄ Manejo de objeciones (25 pts)                                     ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ                                                                       ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ M√ìDULO 2: COMPROMISO DE PAGO (0-100 pts)                             ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ ‚îú‚îÄ Oferta clara (20 pts)                                             ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ ‚îú‚îÄ Alternativas de pago (10 pts)                                     ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ ‚îú‚îÄ Fecha espec√≠fica (20 pts)                                         ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ ‚îî‚îÄ VALIDACI√ìN EXPL√çCITA del cliente (50 pts) ‚Üê CR√çTICO               ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ                                                                       ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ M√ìDULO 3: ABANDONO                                                   ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ ‚îú‚îÄ ¬øHubo abandono?                                                   ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ ‚îú‚îÄ ¬øQui√©n lo inici√≥?                                                 ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ ‚îî‚îÄ ¬øRaz√≥n probable?                                                  ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                              ‚îÇ                                               ‚îÇ
‚îÇ                              ‚ñº                                               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ PASO 3: Calcular Probabilidad de Cumplimiento (Claude Opus 4.5)      ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - Peso de la validaci√≥n expl√≠cita                                    ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - Historial del cliente                                              ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - Calidad de la gesti√≥n del agente                                   ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - Factores contextuales (monto, d√≠as mora, tipo deuda)               ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - Output: 0-100% con nivel (baja/media/alta)                         ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                              ‚îÇ                                               ‚îÇ
‚îÇ                              ‚ñº                                               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ PASO 4: Generar Alertas y Recomendaciones                            ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - Alertas si score < 40 o sin validaci√≥n                             ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - Recomendaciones accionables por prioridad                          ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                              ‚îÇ                                               ‚îÇ
‚îÇ                              ‚ñº                                               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ PASO 5: INSERT en Supabase                                           ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - INSERT INTO analisis_llamadas                                      ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - UPDATE registro_llamadas SET estado = 'analizado'                  ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                              ‚îÇ                                               ‚îÇ
‚îÇ                              ‚ñº                                               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ PASO 6: Trigger Condicional                                          ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - Si alertas cr√≠ticas ‚Üí Webhook ‚Üí Agente Detector                    ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ - Si todo OK ‚Üí Fin del flujo                                         ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## Archivos de Prompts

| Archivo | Descripci√≥n | Tecnolog√≠a |
|---------|-------------|------------|
| `prompt_modulos.md` | Evaluaci√≥n de los 3 m√≥dulos de scoring | Claude Opus 4.5 |
| `prompt_prediccion.md` | C√°lculo de probabilidad de cumplimiento | Claude Opus 4.5 |
| `reglas_alertas.md` | Reglas para generaci√≥n de alertas | L√≥gica |

## Input del Agente

### Webhook desde Transcriptor
```json
{
  "registro_id": "uuid-del-registro",
  "transcripcion_id": "uuid-de-transcripcion"
}
```

### Datos que obtiene de Supabase

```sql
-- Transcripci√≥n completa
SELECT * FROM transcripciones WHERE transcripcion_id = $1;

-- Info del agente
SELECT * FROM agentes WHERE agente_id = $1;

-- Historial del cliente (√∫ltimas 5 llamadas)
SELECT al.* FROM analisis_llamadas al
JOIN registro_llamadas rl ON al.registro_id = rl.registro_id
WHERE rl.cliente_nombre = $1
ORDER BY al.created_at DESC
LIMIT 5;
```

## Output del Agente

### Estructura de `analisis_llamadas`
```json
{
  "registro_id": "uuid",
  "transcripcion_id": "uuid",
  "agente_id": "uuid",
  
  "score_total": 72,
  "score_contacto_directo": 85,
  "score_compromiso_pago": 58,
  
  "modulo_contacto_directo": {
    "score": 85,
    "desglose": {
      "monto_mencionado": {"presente": true, "puntos": 25, "max": 25, "evidencia": "deuda de 405,302 pesos"},
      "fecha_vencimiento": {"presente": true, "puntos": 15, "max": 15, "evidencia": "antes del viernes"},
      "consecuencias_impago": {"presente": false, "puntos": 0, "max": 20, "evidencia": ""},
      "alternativas_pago": {"presente": true, "puntos": 15, "max": 15, "evidencia": "por la APP, web"},
      "manejo_objeciones": {"calidad": 1.0, "puntos": 25, "max": 25, "objeciones_detectadas": 0}
    }
  },
  
  "modulo_compromiso_pago": {
    "score": 58,
    "desglose": {
      "oferta_clara": {"presente": true, "puntos": 20, "max": 20},
      "alternativas_pago": {"presente": true, "puntos": 10, "max": 10},
      "fecha_especifica": {"presente": true, "puntos": 20, "max": 20, "fecha": "el s√°bado"},
      "validacion_cliente": {
        "presente": true,
        "tipo": "implicita",
        "puntos": 8,
        "max": 50,
        "frase_exacta": "yo creo que el s√°bado cancelo"
      }
    }
  },
  
  "modulo_abandono": {
    "hubo_abandono": false,
    "momento_segundos": null,
    "iniciado_por": null,
    "razon": null,
    "senales_previas": []
  },
  
  "probabilidad_cumplimiento": 78,
  "nivel_cumplimiento": "alta",
  
  "factores_prediccion": {
    "factores_positivos": [
      "Cliente ya pag√≥ un cr√©dito ayer",
      "Validaci√≥n expl√≠cita del compromiso",
      "Fecha espec√≠fica acordada",
      "Actitud colaborativa del cliente"
    ],
    "factores_negativos": [
      "M√∫ltiples cr√©ditos pendientes"
    ],
    "razonamiento": "La cliente demuestra compromiso activo de pago...",
    "historial_cliente_considerado": true
  },
  
  "alertas": [],
  
  "recomendaciones": [
    {
      "prioridad": "media",
      "destinatario": "sistema",
      "accion": "Programar recordatorio para el viernes",
      "cuando": "48 horas antes"
    },
    {
      "prioridad": "media",
      "destinatario": "agente",
      "accion": "Contactar lunes para confirmar pagos",
      "cuando": "post-s√°bado"
    }
  ],
  
  "modelo_usado": "claude-opus-4-5-20250514",
  "version_prompt": "v1.0",
  "confianza_analisis": 0.92,
  "tiempo_procesamiento_ms": 2500,
  "fecha_llamada": "2026-01-31"
}
```

## Reglas de Scoring

### M√≥dulo 1: Contacto Directo (100 pts m√°ximo)

| Criterio | Puntos | Descripci√≥n |
|----------|--------|-------------|
| Monto mencionado | 25 | El agente menciona claramente el monto de la deuda |
| Fecha vencimiento | 15 | Se explica cu√°ndo vence o venci√≥ la deuda |
| Consecuencias impago | 20 | Se mencionan consecuencias de no pagar (reportes, intereses) |
| Alternativas pago | 15 | Se ofrecen m√∫ltiples formas de pago |
| Manejo objeciones | 25 | Calidad en responder dudas/resistencia del cliente |

### M√≥dulo 2: Compromiso de Pago (100 pts m√°ximo)

| Criterio | Puntos | Descripci√≥n |
|----------|--------|-------------|
| Oferta clara | 20 | Se presenta una oferta concreta (descuento, plan) |
| Alternativas pago | 10 | Se ofrecen opciones de pago |
| Fecha espec√≠fica | 20 | Se acuerda una fecha concreta de pago |
| **Validaci√≥n cliente** | **50** | **El cliente confirma EXPL√çCITAMENTE el compromiso** |

#### Tipos de Validaci√≥n

| Tipo | Puntos | Ejemplo |
|------|--------|---------|
| **Expl√≠cita** | 50 | "S√≠, confirmo que pagar√© el viernes" |
| **Impl√≠cita** | 8-15 | "ok", "ya", "entiendo" |
| **Ninguna** | 0 | Cliente no confirma nada |

### M√≥dulo 3: Abandono

- **Sin abandono**: Llamada completada normalmente
- **Abandono por cliente**: Cliente cuelga antes de finalizar
- **Abandono por agente**: Agente termina sin cierre apropiado
- **Abandono t√©cnico**: Corte de llamada, problemas de audio

## C√°lculo de Probabilidad de Cumplimiento

```
Probabilidad = Base + Ajustes

Base (seg√∫n validaci√≥n):
- Validaci√≥n expl√≠cita: 60%
- Validaci√≥n impl√≠cita: 35%
- Sin validaci√≥n: 15%

Ajustes positivos:
- Historial cliente positivo: +15%
- Fecha espec√≠fica: +10%
- Monto menor a promedio: +5%
- M√∫ltiples alternativas ofrecidas: +5%
- Tono emocional positivo: +5%

Ajustes negativos:
- Historial cliente negativo: -20%
- Objeciones no resueltas: -15%
- D√≠as mora > 90: -10%
- Abandono previo: -10%
- Tono emocional negativo: -10%
```

## Tablas de Supabase Afectadas

### Lee de:
| Tabla | Campos | Prop√≥sito |
|-------|--------|-----------|
| `transcripciones` | Todos | Datos completos de la llamada |
| `agentes` | `agente_id`, `nombre`, `equipo` | Info del agente |
| `analisis_llamadas` | Historial por cliente | Contexto hist√≥rico |

### Escribe en:
| Tabla | Campos | Prop√≥sito |
|-------|--------|-----------|
| `analisis_llamadas` | Todos los campos del output | An√°lisis completo |
| `registro_llamadas` | `estado`, `analisis_id` | Actualizar estado |

## Tiempo de Procesamiento Esperado

| Paso | Tiempo | Notas |
|------|--------|-------|
| Obtener contexto (Supabase) | <500ms | 3 queries paralelas |
| Claude (evaluaci√≥n m√≥dulos) | 2-4s | Un request con todo |
| INSERT/UPDATE Supabase | <200ms | 2 operaciones |
| Webhook a Detector (si aplica) | <100ms | Async |
| **Total** | **3-5s** | Para una llamada |

## Triggers de Alerta

El agente dispara webhook al **Agente Detector** si:

| Condici√≥n | Severidad |
|-----------|-----------|
| `score_total < 30` | CR√çTICA |
| `score_total < 50` | ALTA |
| `hubo_abandono = true` | ALTA |
| `validacion_cliente.tipo = 'ninguna'` y monto > $100k | ALTA |
| `probabilidad_cumplimiento < 30` | MEDIA |

## Siguiente Agente

El **Agente Detector** (ag3) recibe (si hay alertas):
```json
{
  "analisis_id": "uuid",
  "registro_id": "uuid",
  "alertas": [...],
  "trigger_reason": "score_bajo"
}
```

## M√©tricas de Monitoreo

| M√©trica | Target | Alerta si |
|---------|--------|-----------|
| Tiempo procesamiento | < 5s | > 10s |
| Tasa de √©xito | > 99% | < 95% |
| Errores/d√≠a | < 5 | > 10 |
| Llamadas analizadas/hora | ~50 | < 20 |
</file>

<file path="docs/ag2_analista/reglas_alertas.md">
# Reglas de Generaci√≥n de Alertas

## Visi√≥n General

El Agente Analista genera alertas bas√°ndose en los resultados del an√°lisis. Estas alertas se incluyen en el registro de `analisis_llamadas` y pueden disparar el Agente Detector.

---

## Estructura de una Alerta

```json
{
  "tipo": "warning" | "error" | "critical",
  "codigo": "CODIGO_ALERTA",
  "mensaje": "Descripci√≥n legible de la alerta",
  "severidad": "baja" | "media" | "alta" | "critica",
  "datos": {
    // Datos adicionales seg√∫n el tipo
  }
}
```

---

## Reglas de Alertas

### 1. SCORE_CRITICO
**Condici√≥n**: `score_total < 30`

```json
{
  "tipo": "critical",
  "codigo": "SCORE_CRITICO",
  "mensaje": "Score de llamada cr√≠ticamente bajo ({score})",
  "severidad": "critica",
  "datos": {
    "score_total": 28,
    "score_contacto": 35,
    "score_compromiso": 20
  }
}
```

**Acci√≥n**: Dispara webhook al Agente Detector inmediatamente.

---

### 2. SCORE_BAJO
**Condici√≥n**: `score_total >= 30 AND score_total < 50`

```json
{
  "tipo": "warning",
  "codigo": "SCORE_BAJO",
  "mensaje": "Score de llamada por debajo del umbral ({score})",
  "severidad": "alta",
  "datos": {
    "score_total": 42,
    "umbral": 50
  }
}
```

---

### 3. FALTA_VALIDACION
**Condici√≥n**: `validacion_cliente.tipo = 'ninguna'`

```json
{
  "tipo": "warning",
  "codigo": "FALTA_VALIDACION",
  "mensaje": "Cliente NO valid√≥ el compromiso de pago",
  "severidad": "alta",
  "datos": {
    "tipo_validacion": "ninguna",
    "monto_comprometido": 128888,
    "impacto_estimado": "Probabilidad de cumplimiento reducida a <35%"
  }
}
```

---

### 4. VALIDACION_DEBIL
**Condici√≥n**: `validacion_cliente.tipo = 'implicita' AND monto_comprometido > 100000`

```json
{
  "tipo": "warning",
  "codigo": "VALIDACION_DEBIL",
  "mensaje": "Validaci√≥n impl√≠cita para monto alto",
  "severidad": "media",
  "datos": {
    "tipo_validacion": "implicita",
    "monto_comprometido": 150000,
    "frase_cliente": "ok, entiendo"
  }
}
```

---

### 5. ABANDONO_LLAMADA
**Condici√≥n**: `hubo_abandono = true`

```json
{
  "tipo": "error",
  "codigo": "ABANDONO_LLAMADA",
  "mensaje": "Llamada abandonada por {iniciado_por}",
  "severidad": "alta",
  "datos": {
    "momento_segundos": 145,
    "iniciado_por": "cliente",
    "razon": "Cliente frustrado por tiempo de espera"
  }
}
```

---

### 6. PROBABILIDAD_BAJA
**Condici√≥n**: `probabilidad_cumplimiento < 30`

```json
{
  "tipo": "warning",
  "codigo": "PROBABILIDAD_BAJA",
  "mensaje": "Probabilidad de cumplimiento muy baja ({prob}%)",
  "severidad": "media",
  "datos": {
    "probabilidad": 25,
    "factores_principales": ["sin validaci√≥n", "historial negativo"]
  }
}
```

---

### 7. OBJECIONES_NO_MANEJADAS
**Condici√≥n**: `manejo_objeciones.calidad < 0.5 AND objeciones_detectadas > 0`

```json
{
  "tipo": "warning",
  "codigo": "OBJECIONES_NO_MANEJADAS",
  "mensaje": "{N} objeciones detectadas con manejo deficiente",
  "severidad": "media",
  "datos": {
    "objeciones_detectadas": 2,
    "calidad_manejo": 0.3,
    "detalle": "Cliente mencion√≥ no tener dinero, agente no ofreci√≥ alternativas"
  }
}
```

---

### 8. CONSECUENCIAS_NO_MENCIONADAS
**Condici√≥n**: `consecuencias_impago.presente = false AND dias_mora > 60`

```json
{
  "tipo": "warning",
  "codigo": "CONSECUENCIAS_OMITIDAS",
  "mensaje": "No se mencionaron consecuencias (cliente con {dias} d√≠as de mora)",
  "severidad": "baja",
  "datos": {
    "dias_mora": 75,
    "monto_deuda": 250000
  }
}
```

---

### 9. INCONSISTENCIA_EMOCIONAL
**Condici√≥n**: `evolucion_cliente = 'empeoro' AND compromiso_logrado = true`

```json
{
  "tipo": "warning",
  "codigo": "INCONSISTENCIA_EMOCIONAL",
  "mensaje": "Compromiso logrado pero cliente termin√≥ con emoci√≥n negativa",
  "severidad": "media",
  "datos": {
    "emocion_inicio": "neutral",
    "emocion_fin": "frustrado",
    "compromiso_monto": 50000
  }
}
```

---

### 10. EXCESO_DURACION
**Condici√≥n**: `duracion_segundos > 600 AND score_total < 60`

```json
{
  "tipo": "warning",
  "codigo": "EXCESO_DURACION",
  "mensaje": "Llamada muy larga ({min} min) con score bajo",
  "severidad": "baja",
  "datos": {
    "duracion_segundos": 720,
    "score_total": 45
  }
}
```

---

## Matriz de Severidad y Acciones

| Severidad | Dispara Detector | Notificaci√≥n Inmediata | Incluir en Coaching |
|-----------|------------------|------------------------|---------------------|
| Cr√≠tica | ‚úÖ S√≠ (inmediato) | ‚úÖ Slack + Email | ‚úÖ Prioridad alta |
| Alta | ‚úÖ S√≠ (batch) | ‚úÖ Slack | ‚úÖ S√≠ |
| Media | ‚ùå No | ‚ùå No | ‚úÖ S√≠ |
| Baja | ‚ùå No | ‚ùå No | ‚ö†Ô∏è Opcional |

---

## C√≥digo de Implementaci√≥n (Pseudoc√≥digo)

```javascript
function generarAlertas(analisis) {
  const alertas = [];
  
  // 1. Score cr√≠tico
  if (analisis.score_total < 30) {
    alertas.push({
      tipo: 'critical',
      codigo: 'SCORE_CRITICO',
      mensaje: `Score de llamada cr√≠ticamente bajo (${analisis.score_total})`,
      severidad: 'critica',
      datos: { score_total: analisis.score_total }
    });
  }
  // 2. Score bajo
  else if (analisis.score_total < 50) {
    alertas.push({
      tipo: 'warning',
      codigo: 'SCORE_BAJO',
      mensaje: `Score de llamada por debajo del umbral (${analisis.score_total})`,
      severidad: 'alta',
      datos: { score_total: analisis.score_total, umbral: 50 }
    });
  }
  
  // 3. Falta validaci√≥n
  const validacion = analisis.modulo_compromiso_pago.desglose.validacion_cliente;
  if (validacion.tipo === 'ninguna') {
    alertas.push({
      tipo: 'warning',
      codigo: 'FALTA_VALIDACION',
      mensaje: 'Cliente NO valid√≥ el compromiso de pago',
      severidad: 'alta',
      datos: { tipo_validacion: 'ninguna' }
    });
  }
  
  // 4. Abandono
  if (analisis.modulo_abandono.hubo_abandono) {
    alertas.push({
      tipo: 'error',
      codigo: 'ABANDONO_LLAMADA',
      mensaje: `Llamada abandonada por ${analisis.modulo_abandono.iniciado_por}`,
      severidad: 'alta',
      datos: analisis.modulo_abandono
    });
  }
  
  // 5. Probabilidad baja
  if (analisis.probabilidad_cumplimiento < 30) {
    alertas.push({
      tipo: 'warning',
      codigo: 'PROBABILIDAD_BAJA',
      mensaje: `Probabilidad de cumplimiento muy baja (${analisis.probabilidad_cumplimiento}%)`,
      severidad: 'media',
      datos: { probabilidad: analisis.probabilidad_cumplimiento }
    });
  }
  
  return alertas;
}

function debeDispararDetector(alertas) {
  return alertas.some(a => 
    a.severidad === 'critica' || 
    (a.severidad === 'alta' && ['SCORE_BAJO', 'ABANDONO_LLAMADA'].includes(a.codigo))
  );
}
```

---

## Webhook al Detector

Si `debeDispararDetector(alertas)` es `true`, enviar:

```json
{
  "trigger": "analisis_individual",
  "analisis_id": "uuid",
  "registro_id": "uuid",
  "agente_id": "uuid",
  "alertas": [...],
  "timestamp": "2026-01-31T15:30:00Z"
}
```
</file>

<file path="docs/ag3_detector/config_umbrales.json">
{
  "_descripcion": "Configuracion de umbrales para el Agente Detector (Modo Periodico 24h)",
  "_version": "2.0",
  "_ultima_actualizacion": "2026-02-04",
  
  "ejecucion": {
    "cron": "0 7 * * *",
    "descripcion": "Todos los dias a las 07:00 AM",
    "timezone": "America/Santiago",
    "periodo_analisis_horas": 24
  },
  
  "minimos": {
    "llamadas_por_agente": {
      "valor": 3,
      "descripcion": "Minimo de llamadas para evaluar un agente"
    },
    "llamadas_sistema": {
      "valor": 50,
      "descripcion": "Minimo de llamadas para evaluar metricas sistemicas"
    },
    "llamadas_para_validacion": {
      "valor": 5,
      "descripcion": "Minimo de llamadas para evaluar tasa de validacion/abandono"
    }
  },
  
  "umbrales_agente": {
    "score_critico": {
      "valor": 40,
      "severidad": "critica",
      "descripcion": "Score promedio por debajo genera alerta critica"
    },
    "score_bajo": {
      "valor": 55,
      "severidad": "alta",
      "descripcion": "Score promedio por debajo genera alerta alta"
    },
    "abandono_alto": {
      "valor": 0.20,
      "severidad": "alta",
      "descripcion": "Tasa de abandono por encima genera alerta"
    },
    "validacion_minima": {
      "valor": 0.15,
      "severidad": "alta",
      "descripcion": "Tasa de validacion explicita por debajo genera alerta"
    },
    "caida_score": {
      "valor": 0.15,
      "severidad": "media",
      "descripcion": "Caida porcentual vs dia anterior que genera alerta"
    },
    "probabilidad_baja": {
      "valor": 30,
      "severidad": "media",
      "descripcion": "Probabilidad de cumplimiento promedio baja"
    }
  },
  
  "umbrales_patron": {
    "llamadas_criticas": {
      "valor": 5,
      "severidad": "alta",
      "descripcion": "Numero de llamadas con score < 40 que genera alerta"
    },
    "abandonos_consecutivos": {
      "valor": 3,
      "severidad": "alta",
      "descripcion": "Numero de abandonos en secuencia que genera alerta"
    }
  },
  
  "umbrales_sistema": {
    "abandono_critico": {
      "valor": 0.25,
      "severidad": "critica",
      "descripcion": "Tasa de abandono global que genera alerta critica"
    },
    "caida_score": {
      "valor": 0.10,
      "severidad": "alta",
      "descripcion": "Caida porcentual global vs dia anterior"
    },
    "validacion_minima": {
      "valor": 0.25,
      "severidad": "alta",
      "descripcion": "Tasa de validacion global minima"
    },
    "volumen_minimo": {
      "valor": 0.70,
      "severidad": "media",
      "descripcion": "Porcentaje minimo de volumen vs dia anterior"
    }
  },
  
  "deduplicacion": {
    "ventana_dias": 3,
    "descripcion": "No crear alerta si existe una igual en los ultimos N dias"
  },
  
  "notificaciones": {
    "critica": {
      "canales": ["slack", "email", "in-app"],
      "destinatarios": ["director", "supervisor"]
    },
    "alta": {
      "canales": ["slack", "email", "in-app"],
      "destinatarios": ["supervisor"]
    },
    "media": {
      "canales": ["email", "in-app"],
      "destinatarios": ["supervisor"]
    },
    "baja": {
      "canales": ["in-app"],
      "destinatarios": ["supervisor"]
    }
  }
}
</file>

<file path="docs/ag3_detector/flujo_completo.md">
# Agente Detector - Flujo Completo (Modo Periodico 24h)

## Resumen del Flujo

```
Cron 07:00 AM 
    -> CALL ejecutar_detector() [Supabase Function]
    -> Filtrar alertas nuevas (es_nueva = true)
    -> INSERT INTO alertas_anomalias [SQL directo]
    -> SELECT obtener_metricas_periodo() [Supabase Function]
    -> Generar resumen
    -> Notificar (Slack/Email)
```

---

## Configuracion del Cron

```javascript
// Saturn Studio - Trigger Cron
{
  "trigger": "cron",
  "schedule": "0 7 * * *",  // Todos los dias a las 07:00 AM
  "timezone": "America/Santiago"
}
```

---

## Funciones de Supabase Disponibles

Las funciones estan en `supabase/functions/detector_functions.sql`

| Funcion | Descripcion | Uso |
|---------|-------------|-----|
| `evaluar_alertas_agente(nombre, horas)` | Evalua alertas de un agente | Por agente |
| `evaluar_alertas_todos_agentes(horas)` | Evalua todos los agentes | Batch |
| `evaluar_alertas_sistemicas(horas)` | Evalua alertas globales | Sistema |
| `ejecutar_detector(horas, dias_dedup)` | Completo con deduplicacion | Principal |
| `obtener_metricas_periodo(horas)` | Metricas para resumen | Resumen |

---

## PASO 1: Ejecutar Detector (Supabase Function)

**Query SQL en Saturn Studio:**

```sql
-- Obtener todas las alertas nuevas (no duplicadas)
SELECT 
    tipo,
    severidad,
    codigo,
    descripcion,
    agente_id,
    agente_nombre,
    equipo,
    datos,
    accion_requerida
FROM ejecutar_detector(24, 3)
WHERE es_nueva = true;
```

**Resultado esperado:**
```json
[
  {
    "tipo": "agente",
    "severidad": "critica",
    "codigo": "AGENTE_SCORE_CRITICO",
    "descripcion": "Score promedio critico (36) en ultimas 24 horas",
    "agente_id": "uuid",
    "agente_nombre": "Pedro Ruiz",
    "equipo": "Equipo Sur",
    "datos": {"score_promedio": 36, "total_llamadas": 20},
    "accion_requerida": "Intervencion inmediata - coaching urgente"
  }
]
```

---

## PASO 2: Persistir Alertas (SQL Directo)

**Query SQL en Saturn Studio:**

```sql
-- Insertar alertas detectadas
INSERT INTO alertas_anomalias (
    tipo,
    severidad,
    codigo,
    descripcion,
    datos_soporte,
    accion_recomendada,
    agentes_relacionados,
    estado,
    notificacion_enviada
)
SELECT 
    tipo::tipo_alerta,
    severidad::severidad_alerta,
    codigo,
    descripcion,
    datos,
    jsonb_build_object(
        'accion', accion_requerida,
        'urgencia', CASE severidad WHEN 'critica' THEN 'inmediato' WHEN 'alta' THEN 'hoy' ELSE 'esta_semana' END,
        'destinatario', COALESCE(agente_nombre, 'supervisor'),
        'deadline', NULL
    ),
    CASE WHEN agente_id IS NOT NULL THEN ARRAY[agente_id] ELSE NULL END,
    'nueva'::estado_alerta,
    false
FROM ejecutar_detector(24, 3)
WHERE es_nueva = true
RETURNING alerta_id, tipo, severidad, codigo, descripcion;
```

**Alternativa - INSERT con valores especificos:**

```sql
-- Si prefieres insertar los valores desde Saturn Studio despues de procesarlos
INSERT INTO alertas_anomalias (
    tipo, severidad, codigo, descripcion, 
    datos_soporte, accion_recomendada, agentes_relacionados,
    estado, notificacion_enviada
) VALUES 
    ('individual'::tipo_alerta, 'critica'::severidad_alerta, 'AGENTE_SCORE_CRITICO', 
     'Score promedio critico (36) en ultimas 24 horas',
     '{"score_promedio": 36, "total_llamadas": 20}'::JSONB,
     '{"accion": "Intervencion inmediata - coaching urgente", "urgencia": "inmediato", "destinatario": "Pedro Ruiz"}'::JSONB,
     ARRAY['44444444-4444-4444-4444-444444444444'::UUID],
     'nueva'::estado_alerta, false),
    ('individual'::tipo_alerta, 'alta'::severidad_alerta, 'AGENTE_ABANDONO_ALTO',
     'Tasa de abandono alta (30%) en ultimas 24 horas',
     '{"tasa_abandono": 0.30, "abandonos": 6}'::JSONB,
     '{"accion": "Revisar grabaciones y dar feedback", "urgencia": "hoy", "destinatario": "Pedro Ruiz"}'::JSONB,
     ARRAY['44444444-4444-4444-4444-444444444444'::UUID],
     'nueva'::estado_alerta, false)
RETURNING alerta_id;
```

---

## PASO 3: Obtener Metricas para Resumen (Supabase Function)

**Query SQL en Saturn Studio:**

```sql
SELECT * FROM obtener_metricas_periodo(24);
```

**Resultado esperado:**
```json
{
  "total_llamadas": 450,
  "score_promedio": 72.5,
  "tasa_abandono": 0.08,
  "tasa_validacion": 0.39,
  "prob_cumplimiento_promedio": 58.3,
  "llamadas_anterior": 420,
  "score_anterior": 74.2,
  "cambio_llamadas_porcentaje": 7.1,
  "cambio_score": -1.7
}
```

---

## PASO 4: Contar Alertas por Severidad

**Query SQL en Saturn Studio:**

```sql
-- Contar alertas insertadas hoy por severidad
SELECT 
    severidad,
    COUNT(*) as cantidad
FROM alertas_anomalias
WHERE DATE(created_at) = CURRENT_DATE
GROUP BY severidad
ORDER BY 
    CASE severidad 
        WHEN 'critica' THEN 1 
        WHEN 'alta' THEN 2 
        WHEN 'media' THEN 3 
        ELSE 4 
    END;
```

---

## PASO 5: Obtener Lista de Agentes con Alertas

**Query SQL en Saturn Studio:**

```sql
-- Agentes con alertas de hoy
SELECT 
    a.nombre as agente_nombre,
    a.equipo,
    ARRAY_AGG(aa.codigo ORDER BY 
        CASE aa.severidad 
            WHEN 'critica' THEN 1 
            WHEN 'alta' THEN 2 
            ELSE 3 
        END
    ) as alertas,
    COUNT(*) as cantidad_alertas
FROM alertas_anomalias aa
JOIN agentes a ON a.agente_id = aa.agentes_relacionados[1]
WHERE DATE(aa.created_at) = CURRENT_DATE
  AND aa.agentes_relacionados IS NOT NULL
GROUP BY a.nombre, a.equipo
ORDER BY cantidad_alertas DESC;
```

---

## Flujo Completo en Saturn Studio

### Nodo 1: Ejecutar Detector y Persistir

```sql
-- Un solo query que ejecuta el detector e inserta las alertas nuevas
INSERT INTO alertas_anomalias (
    tipo, severidad, codigo, descripcion, 
    datos_soporte, accion_recomendada, agentes_relacionados,
    estado, notificacion_enviada
)
SELECT 
    tipo::tipo_alerta,
    severidad::severidad_alerta,
    codigo,
    descripcion,
    datos,
    jsonb_build_object(
        'accion', accion_requerida,
        'urgencia', CASE severidad WHEN 'critica' THEN 'inmediato' WHEN 'alta' THEN 'hoy' ELSE 'esta_semana' END,
        'destinatario', COALESCE(agente_nombre, 'supervisor'),
        'deadline', NULL
    ),
    CASE WHEN agente_id IS NOT NULL THEN ARRAY[agente_id] ELSE NULL END,
    'nueva'::estado_alerta,
    false
FROM ejecutar_detector(24, 3)
WHERE es_nueva = true
RETURNING 
    alerta_id, tipo, severidad, codigo, descripcion;
```

### Nodo 2: Obtener Resumen

```sql
-- Obtener metricas y conteos para el resumen
WITH metricas AS (
    SELECT * FROM obtener_metricas_periodo(24)
),
conteo_alertas AS (
    SELECT 
        COUNT(*) FILTER (WHERE severidad = 'critica') as criticas,
        COUNT(*) FILTER (WHERE severidad = 'alta') as altas,
        COUNT(*) FILTER (WHERE severidad = 'media') as medias,
        COUNT(*) FILTER (WHERE severidad = 'baja') as bajas,
        COUNT(*) as total
    FROM alertas_anomalias
    WHERE DATE(created_at) = CURRENT_DATE
),
agentes_alertas AS (
    SELECT 
        a.nombre as agente_nombre,
        ARRAY_AGG(aa.codigo) as alertas
    FROM alertas_anomalias aa
    JOIN agentes a ON a.agente_id = aa.agentes_relacionados[1]
    WHERE DATE(aa.created_at) = CURRENT_DATE
      AND aa.agentes_relacionados IS NOT NULL
    GROUP BY a.nombre
)
SELECT 
    m.*,
    c.criticas,
    c.altas,
    c.medias,
    c.bajas,
    c.total as total_alertas,
    (SELECT JSONB_AGG(jsonb_build_object(
        'nombre', agente_nombre,
        'alertas', alertas
    )) FROM agentes_alertas) as agentes_con_alertas
FROM metricas m, conteo_alertas c;
```

### Nodo 3: Preparar Datos para Notificacion (Opcional)

```sql
-- Este paso es opcional si no tienes tabla de notificaciones
-- Prepara los datos para enviar a Slack/Email
SELECT 
    (SELECT COUNT(*) FROM alertas_anomalias WHERE DATE(created_at) = CURRENT_DATE) as total_alertas,
    (SELECT COUNT(*) FROM alertas_anomalias WHERE DATE(created_at) = CURRENT_DATE AND severidad = 'critica') as criticas,
    (SELECT COUNT(*) FROM alertas_anomalias WHERE DATE(created_at) = CURRENT_DATE AND severidad = 'alta') as altas,
    TO_CHAR(CURRENT_DATE, 'YYYY-MM-DD') as fecha;
```

### Nodo 4: Notificar Slack (Condicional)

Solo si hay alertas criticas o altas:

```javascript
// Saturn Studio - Nodo HTTP Request
const alertas = resultadoNodo1;
const resumen = resultadoNodo2;

// Verificar si hay alertas criticas o altas
const tieneCriticas = resumen.criticas > 0;
const tieneAltas = resumen.altas > 0;

if (tieneCriticas || tieneAltas) {
    const emoji = tieneCriticas ? ':rotating_light:' : ':warning:';
    
    const mensaje = {
        blocks: [
            {
                type: 'header',
                text: {
                    type: 'plain_text',
                    text: `${emoji} Reporte de Alertas - ${resumen.fecha}`,
                    emoji: true
                }
            },
            {
                type: 'section',
                fields: [
                    { type: 'mrkdwn', text: `*Llamadas:* ${resumen.total_llamadas}` },
                    { type: 'mrkdwn', text: `*Score:* ${resumen.score_promedio} (${resumen.cambio_score > 0 ? '+' : ''}${resumen.cambio_score})` }
                ]
            },
            {
                type: 'section',
                text: {
                    type: 'mrkdwn',
                    text: `*Alertas:* :red_circle: ${resumen.criticas} criticas | :orange_circle: ${resumen.altas} altas | :yellow_circle: ${resumen.medias} medias`
                }
            }
        ]
    };
    
    // Agregar agentes con alertas
    if (resumen.agentes_con_alertas && resumen.agentes_con_alertas.length > 0) {
        const listaAgentes = resumen.agentes_con_alertas
            .map(a => `- ${a.nombre}: ${a.alertas.join(', ')}`)
            .join('\n');
        
        mensaje.blocks.push({
            type: 'section',
            text: { type: 'mrkdwn', text: `*Agentes:*\n${listaAgentes}` }
        });
    }
    
    // Enviar a Slack
    await fetch(process.env.SLACK_WEBHOOK_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(mensaje)
    });
}
```

---

## Uso de Funciones Individuales

### Evaluar un agente especifico

```sql
-- Evaluar alertas solo de Pedro Ruiz
SELECT * FROM evaluar_alertas_agente('Pedro Ruiz', 24);
```

### Usar las vistas predefinidas

```sql
-- Ver alertas de agentes (ultimas 24h)
SELECT * FROM v_alertas_agentes_24h;

-- Ver alertas sistemicas (ultimas 24h)
SELECT * FROM v_alertas_sistemicas_24h;
```

### Evaluar con periodo personalizado

```sql
-- Evaluar ultimas 48 horas con deduplicacion de 7 dias
SELECT * FROM ejecutar_detector(48, 7) WHERE es_nueva = true;
```

---

## Tiempos Esperados

| Paso | Tiempo |
|------|--------|
| ejecutar_detector() | ~2-3s |
| INSERT alertas | ~200ms |
| obtener_metricas_periodo() | ~500ms |
| Queries de resumen | ~300ms |
| Notificaciones | ~2s |
| **Total** | **~5-6s** |

---

## Diagrama de Flujo Saturn Studio

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    CRON 07:00 AM                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  NODO 1: SQL Query                                          ‚îÇ
‚îÇ  INSERT INTO alertas_anomalias                              ‚îÇ
‚îÇ  SELECT FROM ejecutar_detector(24, 3) WHERE es_nueva        ‚îÇ
‚îÇ  RETURNING alerta_id, tipo, severidad, codigo...            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  NODO 2: SQL Query                                          ‚îÇ
‚îÇ  SELECT metricas + conteos + agentes_con_alertas            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  NODO 3: Condicional                                        ‚îÇ
‚îÇ  IF criticas > 0 OR altas > 0                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ SI                             ‚îÇ NO
         ‚ñº                                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  NODO 4: HTTP       ‚îÇ          ‚îÇ  FIN                ‚îÇ
‚îÇ  POST Slack         ‚îÇ          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ
          ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  NODO 5: HTTP       ‚îÇ
‚îÇ  POST Email (opc)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ
          ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  FIN                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```
</file>

<file path="docs/ag3_detector/input_ejemplo.json">
{
  "_descripcion": "Input del Agente Detector - Datos obtenidos de Supabase para las ultimas 24 horas",
  
  "metricas_globales": {
    "periodo": {
      "inicio": "2026-02-03T07:00:00Z",
      "fin": "2026-02-04T07:00:00Z"
    },
    "total_llamadas": 450,
    "score_promedio": 72.5,
    "abandonos": 38,
    "validaciones_explicitas": 175,
    "prob_cumplimiento_promedio": 58.3,
    "llamadas_anterior": 420,
    "score_anterior": 74.2,
    "abandonos_anterior": 35,
    "validaciones_anterior": 180
  },
  
  "metricas_por_agente": [
    {
      "agente_id": "11111111-2222-3333-4444-555555555555",
      "agente_nombre": "Maria Garcia",
      "equipo": "Equipo Norte",
      "total_llamadas": 25,
      "score_promedio": 78.5,
      "abandonos": 2,
      "validaciones_explicitas": 12,
      "llamadas_criticas": 1,
      "prob_promedio": 65.2
    },
    {
      "agente_id": "22222222-3333-4444-5555-666666666666",
      "agente_nombre": "Pedro Ruiz",
      "equipo": "Equipo Sur",
      "total_llamadas": 20,
      "score_promedio": 35.8,
      "abandonos": 6,
      "validaciones_explicitas": 1,
      "llamadas_criticas": 12,
      "prob_promedio": 22.5
    },
    {
      "agente_id": "33333333-4444-5555-6666-777777777777",
      "agente_nombre": "Juan Lopez",
      "equipo": "Equipo Norte",
      "total_llamadas": 18,
      "score_promedio": 52.3,
      "abandonos": 5,
      "validaciones_explicitas": 2,
      "llamadas_criticas": 4,
      "prob_promedio": 38.1
    },
    {
      "agente_id": "44444444-5555-6666-7777-888888888888",
      "agente_nombre": "Ana Martinez",
      "equipo": "Equipo Sur",
      "total_llamadas": 22,
      "score_promedio": 82.1,
      "abandonos": 1,
      "validaciones_explicitas": 14,
      "llamadas_criticas": 0,
      "prob_promedio": 72.8
    }
  ],
  
  "comparativas_agentes": [
    {
      "agente_id": "11111111-2222-3333-4444-555555555555",
      "score_hoy": 78.5,
      "score_ayer": 76.2
    },
    {
      "agente_id": "22222222-3333-4444-5555-666666666666",
      "score_hoy": 35.8,
      "score_ayer": 58.5
    },
    {
      "agente_id": "33333333-4444-5555-6666-777777777777",
      "score_hoy": 52.3,
      "score_ayer": 68.9
    },
    {
      "agente_id": "44444444-5555-6666-7777-888888888888",
      "score_hoy": 82.1,
      "score_ayer": 80.5
    }
  ],
  
  "alertas_existentes_ultimos_3_dias": [
    {
      "alerta_id": "old-alert-001",
      "codigo": "AGENTE_SCORE_BAJO",
      "agente_id": "55555555-6666-7777-8888-999999999999",
      "created_at": "2026-02-02T07:15:00Z"
    }
  ]
}
</file>

<file path="docs/ag3_detector/insert_supabase.md">
# Agente Detector - INSERT en Supabase

## Tabla Destino: `alertas_anomalias`

---

## SQL de INSERT Completo

```sql
INSERT INTO alertas_anomalias (
    tipo,
    severidad,
    codigo,
    descripcion,
    agente_id,
    agente_nombre,
    equipo,
    registro_id,
    analisis_id,
    datos,
    contexto,
    analisis_llm,
    accion_requerida,
    destinatarios,
    estado,
    leida,
    resuelta
) VALUES (
    $1,   -- tipo: 'individual' | 'patron' | 'sistemica'
    $2,   -- severidad: 'critica' | 'alta' | 'media' | 'baja'
    $3,   -- codigo: VARCHAR (ej: 'SCORE_CRITICO')
    $4,   -- descripcion: TEXT
    $5,   -- agente_id: UUID (null para sistemicas)
    $6,   -- agente_nombre: VARCHAR
    $7,   -- equipo: VARCHAR
    $8,   -- registro_id: UUID (null para sistemicas/patron)
    $9,   -- analisis_id: UUID (null para sistemicas/patron)
    $10,  -- datos: JSONB
    $11,  -- contexto: JSONB
    $12,  -- analisis_llm: JSONB (null si no aplica)
    $13,  -- accion_requerida: TEXT
    $14,  -- destinatarios: JSONB (array de strings)
    $15,  -- estado: 'activa' | 'en_revision' | 'resuelta'
    $16,  -- leida: BOOLEAN
    $17   -- resuelta: BOOLEAN
) RETURNING alerta_id;
```

---

## Ejemplos de INSERT (una linea)

### Alerta Individual

```sql
INSERT INTO alertas_anomalias (tipo, severidad, codigo, descripcion, agente_id, agente_nombre, equipo, registro_id, analisis_id, datos, contexto, analisis_llm, accion_requerida, destinatarios, estado, leida, resuelta) VALUES ('individual', 'alta', 'SCORE_BAJO', 'Score de llamada por debajo del umbral (42)', '11111111-2222-3333-4444-555555555555', 'Juan Perez', 'Equipo Norte', 'a1b2c3d4-e5f6-7890-abcd-ef1234567890', 'b2c3d4e5-f6a7-8901-bcde-f23456789012', '{"score_total":42,"score_contacto":55,"score_compromiso":28,"umbral":50}'::JSONB, '{"es_patron":false,"score_promedio_agente":72}'::JSONB, NULL, 'Incluir en revision de coaching', '["supervisor"]'::JSONB, 'activa', false, false) RETURNING alerta_id;
```

### Alerta de Patron

```sql
INSERT INTO alertas_anomalias (tipo, severidad, codigo, descripcion, agente_id, agente_nombre, equipo, registro_id, analisis_id, datos, contexto, analisis_llm, accion_requerida, destinatarios, estado, leida, resuelta) VALUES ('patron', 'alta', 'PATRON_SCORES_BAJOS', '5 llamadas consecutivas con score bajo (promedio: 37)', '22222222-3333-4444-5555-666666666666', 'Pedro Ruiz', 'Equipo Sur', NULL, NULL, '{"scores":[38,42,35,40,32],"promedio":37.4,"umbral":50,"llamadas_evaluadas":5}'::JSONB, '{"es_patron":true,"score_promedio_historico":68}'::JSONB, '{"causa_probable":"Presion excesiva hacia el cierre","severidad_ajustada":"alta","intervencion_recomendada":"Supervisor escuchar proxima llamada"}'::JSONB, 'Intervencion inmediata - coaching urgente', '["supervisor","coach"]'::JSONB, 'activa', false, false) RETURNING alerta_id;
```

### Alerta Sistemica

```sql
INSERT INTO alertas_anomalias (tipo, severidad, codigo, descripcion, agente_id, agente_nombre, equipo, registro_id, analisis_id, datos, contexto, analisis_llm, accion_requerida, destinatarios, estado, leida, resuelta) VALUES ('sistemica', 'critica', 'SISTEMA_TASA_ABANDONO', 'Tasa de abandono del 32% en la ultima hora (umbral: 30%)', NULL, NULL, NULL, NULL, NULL, '{"tasa_abandono":0.32,"umbral":0.30,"total_llamadas":45,"abandonos":14}'::JSONB, '{"afecta_equipos":["Equipo Norte","Equipo Sur"],"hora_pico":true}'::JSONB, '{"posibles_causas":["Cartera dificil","Problema en script"]}'::JSONB, 'Revision inmediata de operaciones', '["director","supervisor","operaciones"]'::JSONB, 'activa', false, false) RETURNING alerta_id;
```

---

## Mapeo de Campos

| Campo | Tipo | Individual | Patron | Sistemica |
|-------|------|------------|--------|-----------|
| `tipo` | ENUM | 'individual' | 'patron' | 'sistemica' |
| `severidad` | ENUM | Segun regla | Segun regla | Segun regla |
| `codigo` | VARCHAR | SCORE_*, ABANDONO_* | PATRON_* | SISTEMA_* |
| `agente_id` | UUID | Requerido | Requerido | NULL |
| `registro_id` | UUID | Requerido | NULL | NULL |
| `analisis_id` | UUID | Requerido | NULL | NULL |
| `analisis_llm` | JSONB | Opcional | Frecuente | Opcional |

---

## Queries de Consulta Frecuentes

### Alertas activas por agente
```sql
SELECT * FROM alertas_anomalias
WHERE agente_id = $1
  AND estado = 'activa'
ORDER BY created_at DESC;
```

### Alertas criticas ultima hora
```sql
SELECT * FROM alertas_anomalias
WHERE severidad = 'critica'
  AND created_at > NOW() - INTERVAL '1 hour'
ORDER BY created_at DESC;
```

### Alertas no leidas para supervisor
```sql
SELECT aa.* 
FROM alertas_anomalias aa
WHERE aa.leida = false
  AND aa.destinatarios ? 'supervisor'
ORDER BY 
  CASE aa.severidad 
    WHEN 'critica' THEN 1 
    WHEN 'alta' THEN 2 
    WHEN 'media' THEN 3 
    ELSE 4 
  END,
  aa.created_at DESC;
```

---

## Supabase JS SDK

```javascript
// INSERT alerta individual
const { data, error } = await supabase
  .from('alertas_anomalias')
  .insert({
    tipo: 'individual',
    severidad: 'alta',
    codigo: 'SCORE_BAJO',
    descripcion: 'Score de llamada por debajo del umbral (42)',
    agente_id: '11111111-2222-3333-4444-555555555555',
    agente_nombre: 'Juan Perez',
    equipo: 'Equipo Norte',
    registro_id: 'a1b2c3d4-e5f6-7890-abcd-ef1234567890',
    analisis_id: 'b2c3d4e5-f6a7-8901-bcde-f23456789012',
    datos: { score_total: 42, umbral: 50 },
    contexto: { es_patron: false },
    accion_requerida: 'Incluir en revision de coaching',
    destinatarios: ['supervisor'],
    estado: 'activa',
    leida: false,
    resuelta: false
  })
  .select('alerta_id')
  .single();

// Marcar como leida
await supabase
  .from('alertas_anomalias')
  .update({ leida: true })
  .eq('alerta_id', alertaId);

// Resolver alerta
await supabase
  .from('alertas_anomalias')
  .update({ 
    estado: 'resuelta', 
    resuelta: true,
    resolucion: {
      fecha: new Date(),
      usuario: userId,
      notas: 'Se hablo con el agente'
    }
  })
  .eq('alerta_id', alertaId);
```

---

## Notificaciones In-App

Despues del INSERT de alerta, crear notificaciones:

```javascript
async function crearNotificacionesInApp(alerta) {
  const usuarios = await obtenerUsuariosPorRol(alerta.destinatarios);
  
  const notificaciones = usuarios.map(usuario => ({
    usuario_id: usuario.usuario_id,
    tipo: `alerta_${alerta.severidad}`,
    titulo: `Alerta: ${alerta.codigo}`,
    mensaje: alerta.descripcion,
    datos: {
      alerta_id: alerta.alerta_id,
      agente_id: alerta.agente_id,
      severidad: alerta.severidad
    },
    leida: false
  }));
  
  await supabase
    .from('notificaciones_usuarios')
    .insert(notificaciones);
}
```
</file>

<file path="docs/ag3_detector/notificaciones.md">
# Configuracion de Notificaciones - Agente Detector (Modo Periodico 24h)

## Vision General

El Detector envia un **resumen diario** con todas las alertas detectadas en las ultimas 24 horas. Las notificaciones se envian despues de la ejecucion del cron (07:00 AM).

---

## Canales de Notificacion

### 1. Slack

**Webhook**: Configurar en Saturn Studio como variable de entorno

```javascript
const slackConfig = {
  webhook_url: process.env.SLACK_WEBHOOK_URL,
  channel: '#alertas-cobranza',
  username: 'NODUS Detector',
  icon_emoji: ':chart_with_upwards_trend:'
};
```

**Template de Mensaje (Resumen Diario)**:
```json
{
  "blocks": [
    {
      "type": "header",
      "text": {
        "type": "plain_text",
        "text": "{{emoji}} Reporte de Alertas - {{fecha}}",
        "emoji": true
      }
    },
    {
      "type": "section",
      "fields": [
        {"type": "mrkdwn", "text": "*Llamadas:* {{total_llamadas}}"},
        {"type": "mrkdwn", "text": "*Score:* {{score_promedio}} {{vs_ayer_score}}"},
        {"type": "mrkdwn", "text": "*Abandono:* {{tasa_abandono}}%"},
        {"type": "mrkdwn", "text": "*Validacion:* {{tasa_validacion}}%"}
      ]
    },
    {
      "type": "divider"
    },
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "*Alertas Detectadas:*\n:red_circle: {{criticas}} criticas | :orange_circle: {{altas}} altas | :yellow_circle: {{medias}} medias"
      }
    },
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "*Agentes con alertas:*\n{{lista_agentes}}"
      }
    },
    {
      "type": "actions",
      "elements": [
        {
          "type": "button",
          "text": {"type": "plain_text", "text": "Ver en NODUS"},
          "url": "{{url_dashboard}}/alertas"
        }
      ]
    }
  ]
}
```

**Cuando enviar Slack**:
- Si hay al menos 1 alerta critica
- Si hay al menos 1 alerta alta
- NO enviar si solo hay alertas medias/bajas

---

### 2. Email

**Servicio**: SendGrid / SMTP

**Template HTML (Resumen Diario)**:
```html
<!DOCTYPE html>
<html>
<head>
  <style>
    body { font-family: Arial, sans-serif; }
    .header { background: {{color_header}}; color: white; padding: 20px; text-align: center; }
    .metricas { display: flex; justify-content: space-around; padding: 20px; background: #f3f4f6; }
    .metrica { text-align: center; }
    .metrica-valor { font-size: 24px; font-weight: bold; }
    .alertas { padding: 20px; }
    .alerta-critica { border-left: 4px solid #dc2626; padding: 10px; margin: 10px 0; background: #fef2f2; }
    .alerta-alta { border-left: 4px solid #f59e0b; padding: 10px; margin: 10px 0; background: #fffbeb; }
    .alerta-media { border-left: 4px solid #3b82f6; padding: 10px; margin: 10px 0; background: #eff6ff; }
    .btn { background: #2563eb; color: white; padding: 10px 20px; text-decoration: none; display: inline-block; margin-top: 20px; }
  </style>
</head>
<body>
  <div class="header">
    <h1>Reporte de Alertas - {{fecha}}</h1>
    <p>Periodo: {{periodo_inicio}} a {{periodo_fin}}</p>
  </div>
  
  <div class="metricas">
    <div class="metrica">
      <div class="metrica-valor">{{total_llamadas}}</div>
      <div>Llamadas</div>
    </div>
    <div class="metrica">
      <div class="metrica-valor">{{score_promedio}}</div>
      <div>Score Promedio</div>
    </div>
    <div class="metrica">
      <div class="metrica-valor">{{tasa_abandono}}%</div>
      <div>Abandono</div>
    </div>
    <div class="metrica">
      <div class="metrica-valor">{{tasa_validacion}}%</div>
      <div>Validacion</div>
    </div>
  </div>
  
  <div class="alertas">
    <h2>Alertas Detectadas ({{total_alertas}})</h2>
    
    {{#if alertas_criticas}}
    <h3>Criticas ({{count_criticas}})</h3>
    {{#each alertas_criticas}}
    <div class="alerta-critica">
      <strong>{{codigo}}</strong> - {{agente_nombre}}<br>
      {{descripcion}}<br>
      <em>Accion: {{accion_requerida}}</em>
    </div>
    {{/each}}
    {{/if}}
    
    {{#if alertas_altas}}
    <h3>Altas ({{count_altas}})</h3>
    {{#each alertas_altas}}
    <div class="alerta-alta">
      <strong>{{codigo}}</strong> - {{agente_nombre}}<br>
      {{descripcion}}
    </div>
    {{/each}}
    {{/if}}
    
    {{#if alertas_medias}}
    <h3>Medias ({{count_medias}})</h3>
    {{#each alertas_medias}}
    <div class="alerta-media">
      <strong>{{codigo}}</strong> - {{agente_nombre}}<br>
      {{descripcion}}
    </div>
    {{/each}}
    {{/if}}
  </div>
  
  <center>
    <a href="{{url_dashboard}}/alertas" class="btn">Ver Detalles en NODUS</a>
  </center>
</body>
</html>
```

**Destinatarios por Severidad**:
```javascript
const destinatariosEmail = {
  critica: ['director@empresa.com', 'supervisor@empresa.com'],
  alta: ['supervisor@empresa.com'],
  media: ['supervisor@empresa.com'],
  baja: []  // No se envia email para bajas
};
```

---

### 3. In-App (Supabase Realtime)

**Tabla**: `notificaciones_usuarios`

```sql
-- Crear notificacion por cada alerta
INSERT INTO notificaciones_usuarios (
  usuario_id,
  tipo,
  titulo,
  mensaje,
  datos,
  leida
) VALUES (
  $1,  -- usuario_id del supervisor
  'alerta_detector',
  'Alerta: {{codigo}}',
  '{{descripcion}}',
  '{"alerta_id": "{{alerta_id}}", "severidad": "{{severidad}}", "agente_id": "{{agente_id}}"}'::JSONB,
  false
);
```

**Notificacion de Resumen**:
```sql
-- Notificacion resumen para supervisores
INSERT INTO notificaciones_usuarios (
  usuario_id,
  tipo,
  titulo,
  mensaje,
  datos,
  leida
) VALUES (
  $1,
  'resumen_alertas',
  'Resumen de Alertas - {{fecha}}',
  '{{total_alertas}} alertas: {{criticas}} criticas, {{altas}} altas',
  '{"fecha": "{{fecha}}", "total": {{total_alertas}}}'::JSONB,
  false
);
```

---

## Logica de Envio

```javascript
async function notificarResumen(resumen, alertas) {
  const tareas = [];
  
  // Determinar severidad maxima
  const tieneCriticas = alertas.some(a => a.severidad === 'critica');
  const tieneAltas = alertas.some(a => a.severidad === 'alta');
  const tieneMedias = alertas.some(a => a.severidad === 'media');
  
  // Slack: solo si hay criticas o altas
  if (tieneCriticas || tieneAltas) {
    const emoji = tieneCriticas ? ':rotating_light:' : ':warning:';
    tareas.push(enviarSlack(resumen, emoji));
  }
  
  // Email: segun severidad maxima
  if (tieneCriticas) {
    tareas.push(enviarEmail(resumen, alertas, destinatariosEmail.critica));
  } else if (tieneAltas) {
    tareas.push(enviarEmail(resumen, alertas, destinatariosEmail.alta));
  } else if (tieneMedias) {
    tareas.push(enviarEmail(resumen, alertas, destinatariosEmail.media));
  }
  
  // In-App: siempre (si hay alertas)
  if (alertas.length > 0) {
    tareas.push(crearNotificacionesInApp(resumen, alertas));
  }
  
  // Ejecutar en paralelo
  await Promise.all(tareas);
}
```

---

## Resumen de Notificaciones

| Severidad | Slack | Email | In-App |
|-----------|-------|-------|--------|
| Critica | Si (resumen) | Si (director + supervisor) | Si |
| Alta | Si (resumen) | Si (supervisor) | Si |
| Media | No | Si (supervisor) | Si |
| Baja | No | No | Si |

---

## Variables de Entorno Requeridas

```bash
# Slack
SLACK_WEBHOOK_URL=https://hooks.slack.com/services/xxx
SLACK_CHANNEL=#alertas-cobranza

# Email
SENDGRID_API_KEY=SG.xxx
EMAIL_FROM=alertas@nodus.com
EMAIL_SUPERVISOR=supervisor@empresa.com
EMAIL_DIRECTOR=director@empresa.com

# Dashboard
NODUS_DASHBOARD_URL=https://app.nodus.com
```

---

## Ejemplo de Resumen Enviado

### Slack
```
:rotating_light: Reporte de Alertas - 2026-02-04

*Llamadas:* 450        *Score:* 72 (-2)
*Abandono:* 8%         *Validacion:* 38%

---

*Alertas Detectadas:*
:red_circle: 1 criticas | :orange_circle: 3 altas | :yellow_circle: 5 medias

*Agentes con alertas:*
- Pedro Ruiz: AGENTE_SCORE_CRITICO, PATRON_LLAMADAS_CRITICAS
- Maria Lopez: AGENTE_ABANDONO_ALTO
- Juan Garcia: AGENTE_SIN_VALIDACION

[Ver en NODUS]
```

### Email (Asunto)
```
URGENTE: 1 Alerta Critica + 3 Altas - Reporte 2026-02-04
```
</file>

<file path="docs/ag3_detector/output_ejemplo.json">
{
  "_descripcion": "Output del Agente Detector - Alertas generadas y resumen diario",
  
  "alertas_generadas": [
    {
      "alerta_id": "alert-001-2026-02-04",
      "tipo": "agente",
      "severidad": "critica",
      "codigo": "AGENTE_SCORE_CRITICO",
      "descripcion": "Score promedio critico (36) en ultimas 24h",
      "agente_id": "22222222-3333-4444-5555-666666666666",
      "agente_nombre": "Pedro Ruiz",
      "equipo": "Equipo Sur",
      "datos": {
        "score_promedio": 36,
        "total_llamadas": 20,
        "llamadas_criticas": 12,
        "umbral": 40
      },
      "accion_requerida": "Intervencion inmediata - coaching urgente",
      "fecha_periodo": "2026-02-04",
      "estado": "activa",
      "leida": false,
      "resuelta": false,
      "created_at": "2026-02-04T07:05:00Z"
    },
    {
      "alerta_id": "alert-002-2026-02-04",
      "tipo": "patron",
      "severidad": "alta",
      "codigo": "PATRON_LLAMADAS_CRITICAS",
      "descripcion": "12 llamadas con score critico (<40) en 24h",
      "agente_id": "22222222-3333-4444-5555-666666666666",
      "agente_nombre": "Pedro Ruiz",
      "equipo": "Equipo Sur",
      "datos": {
        "llamadas_criticas": 12,
        "total_llamadas": 20,
        "porcentaje": 60
      },
      "accion_requerida": "Revision urgente de casos criticos",
      "fecha_periodo": "2026-02-04",
      "estado": "activa",
      "leida": false,
      "resuelta": false,
      "created_at": "2026-02-04T07:05:00Z"
    },
    {
      "alerta_id": "alert-003-2026-02-04",
      "tipo": "agente",
      "severidad": "alta",
      "codigo": "AGENTE_ABANDONO_ALTO",
      "descripcion": "Tasa de abandono alta (30%) en ultimas 24h",
      "agente_id": "22222222-3333-4444-5555-666666666666",
      "agente_nombre": "Pedro Ruiz",
      "equipo": "Equipo Sur",
      "datos": {
        "tasa_abandono": 0.30,
        "abandonos": 6,
        "total_llamadas": 20,
        "umbral": 0.20
      },
      "accion_requerida": "Revisar grabaciones y dar feedback sobre rapport",
      "fecha_periodo": "2026-02-04",
      "estado": "activa",
      "leida": false,
      "resuelta": false,
      "created_at": "2026-02-04T07:05:00Z"
    },
    {
      "alerta_id": "alert-004-2026-02-04",
      "tipo": "agente",
      "severidad": "alta",
      "codigo": "AGENTE_SIN_VALIDACION",
      "descripcion": "Tasa de validacion explicita muy baja (5%) en ultimas 24h",
      "agente_id": "22222222-3333-4444-5555-666666666666",
      "agente_nombre": "Pedro Ruiz",
      "equipo": "Equipo Sur",
      "datos": {
        "tasa_validacion": 0.05,
        "validaciones": 1,
        "total_llamadas": 20,
        "umbral": 0.15
      },
      "accion_requerida": "Reforzar tecnicas de cierre y validacion",
      "fecha_periodo": "2026-02-04",
      "estado": "activa",
      "leida": false,
      "resuelta": false,
      "created_at": "2026-02-04T07:05:00Z"
    },
    {
      "alerta_id": "alert-005-2026-02-04",
      "tipo": "agente",
      "severidad": "media",
      "codigo": "AGENTE_CAIDA_SCORE",
      "descripcion": "Caida de score del 39% vs dia anterior",
      "agente_id": "22222222-3333-4444-5555-666666666666",
      "agente_nombre": "Pedro Ruiz",
      "equipo": "Equipo Sur",
      "datos": {
        "score_hoy": 36,
        "score_ayer": 59,
        "caida_porcentaje": 39
      },
      "accion_requerida": "Investigar causa de la caida",
      "fecha_periodo": "2026-02-04",
      "estado": "activa",
      "leida": false,
      "resuelta": false,
      "created_at": "2026-02-04T07:05:00Z"
    },
    {
      "alerta_id": "alert-006-2026-02-04",
      "tipo": "agente",
      "severidad": "alta",
      "codigo": "AGENTE_SCORE_BAJO",
      "descripcion": "Score promedio bajo (52) en ultimas 24h",
      "agente_id": "33333333-4444-5555-6666-777777777777",
      "agente_nombre": "Juan Lopez",
      "equipo": "Equipo Norte",
      "datos": {
        "score_promedio": 52,
        "total_llamadas": 18,
        "umbral": 55
      },
      "accion_requerida": "Incluir en revision de coaching prioritaria",
      "fecha_periodo": "2026-02-04",
      "estado": "activa",
      "leida": false,
      "resuelta": false,
      "created_at": "2026-02-04T07:05:00Z"
    },
    {
      "alerta_id": "alert-007-2026-02-04",
      "tipo": "agente",
      "severidad": "media",
      "codigo": "AGENTE_CAIDA_SCORE",
      "descripcion": "Caida de score del 24% vs dia anterior",
      "agente_id": "33333333-4444-5555-6666-777777777777",
      "agente_nombre": "Juan Lopez",
      "equipo": "Equipo Norte",
      "datos": {
        "score_hoy": 52,
        "score_ayer": 69,
        "caida_porcentaje": 24
      },
      "accion_requerida": "Investigar causa de la caida",
      "fecha_periodo": "2026-02-04",
      "estado": "activa",
      "leida": false,
      "resuelta": false,
      "created_at": "2026-02-04T07:05:00Z"
    }
  ],
  
  "resumen_diario": {
    "fecha": "2026-02-04",
    "periodo": {
      "inicio": "2026-02-03T07:00:00Z",
      "fin": "2026-02-04T07:00:00Z"
    },
    "metricas": {
      "total_llamadas": 450,
      "score_promedio": 72,
      "tasa_abandono": 8,
      "tasa_validacion": 39,
      "vs_ayer": {
        "llamadas": "+7%",
        "score": "-2",
        "abandono": "+1%"
      }
    },
    "alertas": {
      "total": 7,
      "criticas": 1,
      "altas": 4,
      "medias": 2,
      "bajas": 0
    },
    "agentes_con_alertas": [
      {
        "agente_id": "22222222-3333-4444-5555-666666666666",
        "nombre": "Pedro Ruiz",
        "equipo": "Equipo Sur",
        "cantidad_alertas": 5,
        "alertas": [
          "AGENTE_SCORE_CRITICO",
          "PATRON_LLAMADAS_CRITICAS",
          "AGENTE_ABANDONO_ALTO",
          "AGENTE_SIN_VALIDACION",
          "AGENTE_CAIDA_SCORE"
        ]
      },
      {
        "agente_id": "33333333-4444-5555-6666-777777777777",
        "nombre": "Juan Lopez",
        "equipo": "Equipo Norte",
        "cantidad_alertas": 2,
        "alertas": [
          "AGENTE_SCORE_BAJO",
          "AGENTE_CAIDA_SCORE"
        ]
      }
    ],
    "alertas_sistemicas": [],
    "agentes_destacados": [
      {
        "nombre": "Ana Martinez",
        "score": 82,
        "validacion": "64%"
      },
      {
        "nombre": "Maria Garcia",
        "score": 78,
        "validacion": "48%"
      }
    ]
  },
  
  "notificaciones_enviadas": {
    "slack": {
      "enviado": true,
      "canal": "#alertas-cobranza",
      "razon": "1 alerta critica detectada",
      "timestamp": "2026-02-04T07:05:15Z"
    },
    "email": {
      "enviado": true,
      "destinatarios": ["director@empresa.com", "supervisor@empresa.com"],
      "asunto": "URGENTE: 1 Alerta Critica + 4 Altas - Reporte 2026-02-04",
      "timestamp": "2026-02-04T07:05:18Z"
    },
    "in_app": {
      "enviado": true,
      "notificaciones_creadas": 8,
      "timestamp": "2026-02-04T07:05:12Z"
    }
  },
  
  "metadata": {
    "tiempo_ejecucion_ms": 4850,
    "alertas_filtradas_duplicados": 0,
    "version": "2.0"
  }
}
</file>

<file path="docs/ag3_detector/plan_implementacion.md">
# Plan de Implementacion - Agente Detector (Modo Periodico 24h)

## Resumen

| Aspecto | Detalle |
|---------|---------|
| **Tiempo estimado** | 1-1.5 dias |
| **Complejidad** | Baja |
| **Dependencias** | Agente Analista funcionando, datos en analisis_llamadas |
| **Tecnologias** | Saturn Studio (SQL), Supabase Functions, Slack, Email |

---

## Arquitectura Simplificada

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      SUPABASE                                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  FUNCIONES:                                                  ‚îÇ
‚îÇ  - evaluar_alertas_agente(nombre, horas)                    ‚îÇ
‚îÇ  - evaluar_alertas_todos_agentes(horas)                     ‚îÇ
‚îÇ  - evaluar_alertas_sistemicas(horas)                        ‚îÇ
‚îÇ  - ejecutar_detector(horas, dias_dedup)                     ‚îÇ
‚îÇ  - obtener_metricas_periodo(horas)                          ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  VISTAS:                                                     ‚îÇ
‚îÇ  - v_alertas_agentes_24h                                    ‚îÇ
‚îÇ  - v_alertas_sistemicas_24h                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
                           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    SATURN STUDIO                             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  CRON 07:00 AM                                               ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ Nodo 1: SQL ‚Üí ejecutar_detector() + INSERT             ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ Nodo 2: SQL ‚Üí obtener_metricas_periodo()               ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ Nodo 3: SQL ‚Üí INSERT notificaciones_usuarios           ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ Nodo 4: Condicional ‚Üí hay alertas criticas/altas?      ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ Nodo 5: HTTP ‚Üí Slack (si aplica)                       ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ Nodo 6: HTTP ‚Üí Email (si aplica)                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Checklist Detallado

### Fase 1: Crear Funciones en Supabase (2-3 horas)

#### 1.1 Preparar Archivo SQL
- [ ] Revisar `supabase/functions/detector_functions.sql`
- [ ] Ajustar umbrales si es necesario:
  - Score critico: < 40
  - Score bajo: < 55
  - Abandono alto: > 20%
  - Validacion minima: < 15%

#### 1.2 Ejecutar en Supabase
- [ ] Conectar a Supabase SQL Editor
- [ ] Ejecutar el script completo
- [ ] Verificar que las funciones se crearon:
  ```sql
  SELECT routine_name 
  FROM information_schema.routines 
  WHERE routine_schema = 'public' 
    AND routine_name LIKE 'evaluar%' OR routine_name LIKE 'ejecutar%';
  ```

#### 1.3 Probar Funciones Manualmente
- [ ] Test: `SELECT * FROM evaluar_alertas_agente('NombreAgente', 24);`
- [ ] Test: `SELECT * FROM evaluar_alertas_todos_agentes(24);`
- [ ] Test: `SELECT * FROM evaluar_alertas_sistemicas(24);`
- [ ] Test: `SELECT * FROM ejecutar_detector(24, 3);`
- [ ] Test: `SELECT * FROM obtener_metricas_periodo(24);`

---

### Fase 2: Configurar Saturn Studio (2-3 horas)

#### 2.1 Crear Flujo Principal
- [ ] Crear nuevo flujo "Agente Detector"
- [ ] Configurar trigger: Cron `0 7 * * *`
- [ ] Timezone: America/Santiago
- [ ] Timeout: 2 minutos

#### 2.2 Nodo 1: Ejecutar Detector e Insertar
- [ ] Tipo: SQL Query
- [ ] Query:
  ```sql
  INSERT INTO alertas_anomalias (
      tipo, severidad, codigo, descripcion, agente_id, 
      agente_nombre, equipo, datos, accion_requerida, 
      estado, leida, resuelta
  )
  SELECT 
      tipo, severidad, codigo, descripcion, agente_id,
      agente_nombre, equipo, datos, accion_requerida,
      'activa', false, false
  FROM ejecutar_detector(24, 3)
  WHERE es_nueva = true
  RETURNING alerta_id, tipo, severidad, codigo, agente_nombre, descripcion;
  ```
- [ ] Guardar resultado en variable `alertas_insertadas`

#### 2.3 Nodo 2: Obtener Resumen
- [ ] Tipo: SQL Query
- [ ] Query:
  ```sql
  WITH metricas AS (SELECT * FROM obtener_metricas_periodo(24)),
  conteo AS (
      SELECT 
          COUNT(*) FILTER (WHERE severidad = 'critica') as criticas,
          COUNT(*) FILTER (WHERE severidad = 'alta') as altas,
          COUNT(*) FILTER (WHERE severidad = 'media') as medias,
          COUNT(*) as total
      FROM alertas_anomalias WHERE DATE(created_at) = CURRENT_DATE
  ),
  agentes AS (
      SELECT agente_nombre, ARRAY_AGG(codigo) as alertas
      FROM alertas_anomalias 
      WHERE DATE(created_at) = CURRENT_DATE AND agente_id IS NOT NULL
      GROUP BY agente_nombre
  )
  SELECT m.*, c.*, 
         (SELECT JSONB_AGG(jsonb_build_object('nombre', agente_nombre, 'alertas', alertas)) FROM agentes) as agentes_con_alertas
  FROM metricas m, conteo c;
  ```
- [ ] Guardar resultado en variable `resumen`

#### 2.4 Nodo 3: Crear Notificaciones In-App
- [ ] Tipo: SQL Query
- [ ] Query:
  ```sql
  INSERT INTO notificaciones_usuarios (usuario_id, tipo, titulo, mensaje, datos, leida)
  SELECT u.usuario_id, 'resumen_alertas',
         'Reporte de Alertas - ' || TO_CHAR(CURRENT_DATE, 'YYYY-MM-DD'),
         format('%s alertas: %s criticas, %s altas', 
                {{resumen.total}}, {{resumen.criticas}}, {{resumen.altas}}),
         jsonb_build_object('fecha', CURRENT_DATE, 'total', {{resumen.total}}),
         false
  FROM usuarios u WHERE u.rol IN ('supervisor', 'director');
  ```

#### 2.5 Nodo 4: Condicional
- [ ] Tipo: Conditional
- [ ] Condicion: `resumen.criticas > 0 OR resumen.altas > 0`
- [ ] Si true: continuar a Nodo 5
- [ ] Si false: terminar

#### 2.6 Nodo 5: Enviar Slack
- [ ] Tipo: HTTP Request
- [ ] Method: POST
- [ ] URL: `{{SLACK_WEBHOOK_URL}}`
- [ ] Body: Template de mensaje con datos del resumen

#### 2.7 Nodo 6: Enviar Email
- [ ] Tipo: HTTP Request (SendGrid API)
- [ ] Method: POST
- [ ] URL: `https://api.sendgrid.com/v3/mail/send`
- [ ] Headers: `Authorization: Bearer {{SENDGRID_API_KEY}}`
- [ ] Body: Template de email con resumen

---

### Fase 3: Configurar Notificaciones (1-2 horas)

#### 3.1 Slack
- [ ] Crear canal #alertas-cobranza (si no existe)
- [ ] Crear Incoming Webhook en Slack
- [ ] Agregar URL a variables de Saturn Studio
- [ ] Probar envio manual

#### 3.2 Email
- [ ] Configurar cuenta SendGrid (si no existe)
- [ ] Obtener API Key
- [ ] Crear template de email en SendGrid
- [ ] Agregar credenciales a Saturn Studio
- [ ] Probar envio manual

---

### Fase 4: Testing (2-3 horas)

#### 4.1 Test de Funciones SQL
- [ ] Ejecutar cada funcion con datos reales
- [ ] Verificar que retorna alertas correctas
- [ ] Verificar deduplicacion funciona

#### 4.2 Test del Flujo Completo
- [ ] Ejecutar flujo manualmente en Saturn Studio
- [ ] Verificar alertas insertadas en tabla
- [ ] Verificar notificaciones in-app creadas
- [ ] Verificar mensaje de Slack recibido
- [ ] Verificar email recibido

#### 4.3 Test de Casos Borde
- [ ] Sin datos en las ultimas 24h: no debe fallar
- [ ] Sin alertas: no enviar Slack/Email
- [ ] Todas las alertas son duplicadas: no insertar nada

---

## Riesgos y Mitigaciones

| Riesgo | Probabilidad | Impacto | Mitigacion |
|--------|--------------|---------|------------|
| Sin datos suficientes | Media | Bajo | Funciones retornan vacio |
| Funcion SQL falla | Baja | Alto | Probar exhaustivamente |
| Timeout en cron | Baja | Medio | Timeout de 2 min |
| Slack no disponible | Baja | Bajo | No es critico |

---

## Metricas de Exito

| Metrica | Target | Critico |
|---------|--------|---------|
| Tiempo total | < 10s | > 30s |
| Alertas detectadas | 100% | < 90% |
| Deduplicacion | > 99% | < 90% |
| Entrega Slack | > 99% | < 95% |

---

## Cronograma

```
Dia 1 (Manana):  Crear funciones en Supabase + Probar
Dia 1 (Tarde):   Configurar Saturn Studio (Nodos 1-4)
Dia 2 (Manana):  Configurar notificaciones (Nodos 5-6)
Dia 2 (Tarde):   Testing completo
```

---

## Criterios de Aceptacion

1. Las funciones SQL se ejecutan sin errores
2. El cron se ejecuta todos los dias a las 07:00
3. Las alertas se insertan correctamente en la tabla
4. No hay alertas duplicadas (ventana 3 dias)
5. Las notificaciones llegan segun severidad
6. El tiempo total es < 10 segundos

---

## Queries de Verificacion

### Ver alertas de hoy
```sql
SELECT * FROM alertas_anomalias 
WHERE DATE(created_at) = CURRENT_DATE
ORDER BY severidad, created_at;
```

### Ver historial de ejecuciones
```sql
SELECT 
    DATE(created_at) as fecha,
    COUNT(*) as alertas,
    COUNT(*) FILTER (WHERE severidad = 'critica') as criticas
FROM alertas_anomalias
GROUP BY DATE(created_at)
ORDER BY fecha DESC
LIMIT 7;
```

### Verificar deduplicacion
```sql
-- Alertas que serian duplicadas si se ejecutara ahora
SELECT codigo, agente_nombre, COUNT(*)
FROM alertas_anomalias
WHERE created_at >= NOW() - INTERVAL '3 days'
GROUP BY codigo, agente_nombre
HAVING COUNT(*) > 1;
```
</file>

<file path="docs/ag3_detector/README.md">
# Agente #3: Detector

## Vision General

El Agente Detector identifica anomalias y patrones problematicos a nivel de agentes y del sistema en general. Opera en modo periodico, ejecutandose diariamente a las 07:00 AM para analizar las ultimas 24 horas.

**Enfoque:** La logica de deteccion esta encapsulada en **funciones SQL de Supabase**, y la persistencia/notificacion se maneja via **queries SQL directos en Saturn Studio**.

---

## Arquitectura

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      SUPABASE                                ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ evaluar_alertas_agente(nombre, horas)                ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ evaluar_alertas_todos_agentes(horas)                 ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ evaluar_alertas_sistemicas(horas)                    ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ ejecutar_detector(horas, dias_dedup)                 ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ obtener_metricas_periodo(horas)                      ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
        Cron 07:00 AM ‚îÇ Queries SQL
                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    SATURN STUDIO                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ INSERT FROM ejecutar_detector() ‚Üí alertas_anomalias  ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ SELECT obtener_metricas_periodo() ‚Üí resumen          ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ Notificaciones: Slack, Email, In-app                 ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Funciones SQL de Supabase

| Funcion | Parametros | Descripcion |
|---------|------------|-------------|
| `evaluar_alertas_agente` | nombre, horas | Evalua reglas para un agente especifico |
| `evaluar_alertas_todos_agentes` | horas | Evalua todos los agentes activos |
| `evaluar_alertas_sistemicas` | horas | Evalua reglas a nivel sistema |
| `ejecutar_detector` | horas, dias_dedup | Combina todo + deduplicacion |
| `obtener_metricas_periodo` | horas | Metricas para el resumen diario |

**Archivo:** `supabase/functions/detector_functions.sql`

---

## Tipos de Alertas

### Por Agente
| Codigo | Severidad | Condicion |
|--------|-----------|-----------|
| `AGENTE_SCORE_CRITICO` | Critica | Score < 40 |
| `AGENTE_SCORE_BAJO` | Alta | Score 40-55 |
| `AGENTE_ABANDONO_ALTO` | Alta | Tasa > 20% |
| `AGENTE_SIN_VALIDACION` | Alta | Tasa < 15% |
| `AGENTE_CAIDA_SCORE` | Media | Caida > 15% |
| `PATRON_LLAMADAS_CRITICAS` | Alta | >= 5 criticas |
| `AGENTE_PROBABILIDAD_BAJA` | Media | Prob < 30% |

### Sistemicas
| Codigo | Severidad | Condicion |
|--------|-----------|-----------|
| `SISTEMA_TASA_ABANDONO` | Critica | > 25% global |
| `SISTEMA_CAIDA_SCORES` | Alta | Caida > 10% |
| `SISTEMA_VALIDACION_BAJA` | Alta | < 25% global |
| `SISTEMA_VOLUMEN_BAJO` | Media | < 70% esperado |

---

## Uso Rapido

### Evaluar un agente
```sql
SELECT * FROM evaluar_alertas_agente('Pedro Ruiz', 24);
```

### Evaluar todos
```sql
SELECT * FROM evaluar_alertas_todos_agentes(24);
```

### Ejecutar detector completo (con deduplicacion)
```sql
SELECT * FROM ejecutar_detector(24, 3) WHERE es_nueva = true;
```

### Persistir alertas
```sql
INSERT INTO alertas_anomalias (tipo, severidad, codigo, descripcion, agente_id, agente_nombre, equipo, datos, accion_requerida, estado, leida, resuelta)
SELECT tipo, severidad, codigo, descripcion, agente_id, agente_nombre, equipo, datos, accion_requerida, 'activa', false, false
FROM ejecutar_detector(24, 3)
WHERE es_nueva = true;
```

### Obtener metricas
```sql
SELECT * FROM obtener_metricas_periodo(24);
```

---

## Output de ejecutar_detector()

```json
{
  "tipo": "agente",
  "severidad": "critica",
  "codigo": "AGENTE_SCORE_CRITICO",
  "descripcion": "Score promedio critico (36) en ultimas 24 horas",
  "agente_id": "uuid-aqui",
  "agente_nombre": "Pedro Ruiz",
  "equipo": "Equipo Sur",
  "datos": {
    "score_promedio": 36,
    "total_llamadas": 20,
    "llamadas_criticas": 12,
    "umbral": 40
  },
  "accion_requerida": "Intervencion inmediata - coaching urgente",
  "es_nueva": true
}
```

---

## Tabla de Destino

**alertas_anomalias**
| Campo | Tipo | Fuente |
|-------|------|--------|
| tipo | TEXT | funcion |
| severidad | TEXT | funcion |
| codigo | TEXT | funcion |
| descripcion | TEXT | funcion |
| agente_id | UUID | funcion |
| agente_nombre | TEXT | funcion |
| equipo | TEXT | funcion |
| datos | JSONB | funcion |
| accion_requerida | TEXT | funcion |
| estado | TEXT | 'activa' |
| leida | BOOLEAN | false |
| resuelta | BOOLEAN | false |

---

## Estructura de Archivos

```
docs/ag3_detector/
‚îú‚îÄ‚îÄ README.md                    # Este archivo
‚îú‚îÄ‚îÄ reglas_deteccion.md          # Detalle de cada regla
‚îú‚îÄ‚îÄ config_umbrales.json         # Umbrales configurables
‚îú‚îÄ‚îÄ notificaciones.md            # Config Slack/Email
‚îú‚îÄ‚îÄ input_ejemplo.json           # Ejemplo de datos
‚îú‚îÄ‚îÄ output_ejemplo.json          # Ejemplo de alertas
‚îú‚îÄ‚îÄ flujo_completo.md            # E2E con queries
‚îú‚îÄ‚îÄ insert_supabase.md           # SQL de insercion
‚îî‚îÄ‚îÄ plan_implementacion.md       # Checklist

supabase/functions/
‚îî‚îÄ‚îÄ detector_functions.sql       # Funciones SQL completas
```

---

## Ventajas de este Enfoque

1. **Logica en Supabase:** Las reglas estan en funciones SQL, faciles de modificar sin tocar Saturn Studio
2. **Queries directos:** Saturn Studio solo ejecuta queries, sin logica compleja
3. **Deduplicacion automatica:** La funcion `ejecutar_detector()` incluye deduplicacion
4. **Testeable:** Puedes ejecutar las funciones manualmente para probar
5. **Performante:** Todo se ejecuta en la base de datos, sin transferencia de datos

---

## Tiempo de Implementacion

| Fase | Tiempo |
|------|--------|
| Crear funciones SQL | 2-3h |
| Configurar Saturn Studio | 2-3h |
| Configurar notificaciones | 1-2h |
| Testing | 2-3h |
| **Total** | **1-1.5 dias** |
</file>

<file path="docs/ag3_detector/reglas_deteccion.md">
# Reglas de Deteccion - Agente Detector (Modo Periodico 24h)

## Vision General

El Detector se ejecuta diariamente y analiza las ultimas 24 horas de datos para generar alertas. No requiere LLM, opera con reglas predefinidas y queries SQL.

---

## 1. Queries de Obtencion de Datos

### 1.1 Metricas Globales del Periodo

```sql
-- Metricas de las ultimas 24 horas
WITH periodo_actual AS (
  SELECT 
    COUNT(*) as total_llamadas,
    AVG(score_total) as score_promedio,
    COUNT(*) FILTER (WHERE modulo_abandono->>'hubo_abandono' = 'true') as abandonos,
    COUNT(*) FILTER (
      WHERE modulo_compromiso_pago->'desglose'->'validacion_cliente'->>'tipo' = 'explicita'
    ) as validaciones_explicitas,
    AVG(probabilidad_cumplimiento) as prob_cumplimiento_promedio
  FROM analisis_llamadas
  WHERE created_at >= NOW() - INTERVAL '24 hours'
),
periodo_anterior AS (
  SELECT 
    COUNT(*) as total_llamadas,
    AVG(score_total) as score_promedio,
    COUNT(*) FILTER (WHERE modulo_abandono->>'hubo_abandono' = 'true') as abandonos,
    COUNT(*) FILTER (
      WHERE modulo_compromiso_pago->'desglose'->'validacion_cliente'->>'tipo' = 'explicita'
    ) as validaciones_explicitas
  FROM analisis_llamadas
  WHERE created_at >= NOW() - INTERVAL '48 hours'
    AND created_at < NOW() - INTERVAL '24 hours'
)
SELECT 
  pa.*,
  pan.total_llamadas as llamadas_anterior,
  pan.score_promedio as score_anterior,
  pan.abandonos as abandonos_anterior,
  pan.validaciones_explicitas as validaciones_anterior
FROM periodo_actual pa, periodo_anterior pan;
```

### 1.2 Metricas por Agente

```sql
SELECT 
  al.agente_id,
  rl.agente_nombre,
  a.equipo,
  COUNT(*) as total_llamadas,
  AVG(al.score_total) as score_promedio,
  COUNT(*) FILTER (WHERE al.modulo_abandono->>'hubo_abandono' = 'true') as abandonos,
  COUNT(*) FILTER (
    WHERE al.modulo_compromiso_pago->'desglose'->'validacion_cliente'->>'tipo' = 'explicita'
  ) as validaciones_explicitas,
  COUNT(*) FILTER (WHERE al.score_total < 40) as llamadas_criticas,
  AVG(al.probabilidad_cumplimiento) as prob_promedio,
  ARRAY_AGG(al.score_total ORDER BY al.created_at) as scores_ordenados
FROM analisis_llamadas al
JOIN registro_llamadas rl ON al.registro_id = rl.registro_id
LEFT JOIN agentes a ON al.agente_id = a.agente_id
WHERE al.created_at >= NOW() - INTERVAL '24 hours'
GROUP BY al.agente_id, rl.agente_nombre, a.equipo
HAVING COUNT(*) >= 3;  -- Minimo 3 llamadas para evaluar
```

### 1.3 Comparativa de Agente vs Dia Anterior

```sql
SELECT 
  agente_id,
  AVG(score_total) FILTER (WHERE created_at >= NOW() - INTERVAL '24 hours') as score_hoy,
  AVG(score_total) FILTER (
    WHERE created_at >= NOW() - INTERVAL '48 hours' 
    AND created_at < NOW() - INTERVAL '24 hours'
  ) as score_ayer
FROM analisis_llamadas
WHERE created_at >= NOW() - INTERVAL '48 hours'
GROUP BY agente_id
HAVING 
  COUNT(*) FILTER (WHERE created_at >= NOW() - INTERVAL '24 hours') >= 3
  AND COUNT(*) FILTER (WHERE created_at < NOW() - INTERVAL '24 hours') >= 3;
```

---

## 2. Reglas de Alerta por Agente

### 2.1 AGENTE_SCORE_CRITICO

```javascript
const regla = {
  codigo: 'AGENTE_SCORE_CRITICO',
  tipo: 'agente',
  severidad: 'critica',
  condicion: (agente) => agente.score_promedio < 40,
  descripcion: (agente) => 
    `Score promedio critico (${Math.round(agente.score_promedio)}) en ultimas 24h`,
  datos: (agente) => ({
    score_promedio: Math.round(agente.score_promedio),
    total_llamadas: agente.total_llamadas,
    llamadas_criticas: agente.llamadas_criticas,
    umbral: 40
  }),
  accion_requerida: 'Intervencion inmediata - coaching urgente'
};
```

### 2.2 AGENTE_SCORE_BAJO

```javascript
const regla = {
  codigo: 'AGENTE_SCORE_BAJO',
  tipo: 'agente',
  severidad: 'alta',
  condicion: (agente) => agente.score_promedio >= 40 && agente.score_promedio < 55,
  descripcion: (agente) => 
    `Score promedio bajo (${Math.round(agente.score_promedio)}) en ultimas 24h`,
  datos: (agente) => ({
    score_promedio: Math.round(agente.score_promedio),
    total_llamadas: agente.total_llamadas,
    umbral: 55
  }),
  accion_requerida: 'Incluir en revision de coaching prioritaria'
};
```

### 2.3 AGENTE_ABANDONO_ALTO

```javascript
const regla = {
  codigo: 'AGENTE_ABANDONO_ALTO',
  tipo: 'agente',
  severidad: 'alta',
  condicion: (agente) => {
    const tasaAbandono = agente.abandonos / agente.total_llamadas;
    return tasaAbandono > 0.20 && agente.total_llamadas >= 5;
  },
  descripcion: (agente) => {
    const tasa = Math.round((agente.abandonos / agente.total_llamadas) * 100);
    return `Tasa de abandono alta (${tasa}%) en ultimas 24h`;
  },
  datos: (agente) => ({
    tasa_abandono: agente.abandonos / agente.total_llamadas,
    abandonos: agente.abandonos,
    total_llamadas: agente.total_llamadas,
    umbral: 0.20
  }),
  accion_requerida: 'Revisar grabaciones y dar feedback sobre rapport'
};
```

### 2.4 AGENTE_SIN_VALIDACION

```javascript
const regla = {
  codigo: 'AGENTE_SIN_VALIDACION',
  tipo: 'agente',
  severidad: 'alta',
  condicion: (agente) => {
    const tasaValidacion = agente.validaciones_explicitas / agente.total_llamadas;
    return tasaValidacion < 0.15 && agente.total_llamadas >= 5;
  },
  descripcion: (agente) => {
    const tasa = Math.round((agente.validaciones_explicitas / agente.total_llamadas) * 100);
    return `Tasa de validacion explicita muy baja (${tasa}%) en ultimas 24h`;
  },
  datos: (agente) => ({
    tasa_validacion: agente.validaciones_explicitas / agente.total_llamadas,
    validaciones: agente.validaciones_explicitas,
    total_llamadas: agente.total_llamadas,
    umbral: 0.15
  }),
  accion_requerida: 'Reforzar tecnicas de cierre y validacion'
};
```

### 2.5 AGENTE_CAIDA_SCORE

```javascript
const regla = {
  codigo: 'AGENTE_CAIDA_SCORE',
  tipo: 'agente',
  severidad: 'media',
  condicion: (agente, comparativa) => {
    if (!comparativa || !comparativa.score_ayer) return false;
    const caida = ((comparativa.score_ayer - agente.score_promedio) / comparativa.score_ayer) * 100;
    return caida > 15;
  },
  descripcion: (agente, comparativa) => {
    const caida = Math.round(((comparativa.score_ayer - agente.score_promedio) / comparativa.score_ayer) * 100);
    return `Caida de score del ${caida}% vs dia anterior`;
  },
  datos: (agente, comparativa) => ({
    score_hoy: Math.round(agente.score_promedio),
    score_ayer: Math.round(comparativa.score_ayer),
    caida_porcentaje: ((comparativa.score_ayer - agente.score_promedio) / comparativa.score_ayer) * 100
  }),
  accion_requerida: 'Investigar causa de la caida'
};
```

### 2.6 AGENTE_PROBABILIDAD_BAJA

```javascript
const regla = {
  codigo: 'AGENTE_PROBABILIDAD_BAJA',
  tipo: 'agente',
  severidad: 'media',
  condicion: (agente) => agente.prob_promedio < 30 && agente.total_llamadas >= 5,
  descripcion: (agente) => 
    `Probabilidad de cumplimiento promedio muy baja (${Math.round(agente.prob_promedio)}%)`,
  datos: (agente) => ({
    probabilidad_promedio: Math.round(agente.prob_promedio),
    total_llamadas: agente.total_llamadas,
    umbral: 30
  }),
  accion_requerida: 'Evaluar calidad de compromisos obtenidos'
};
```

---

## 3. Reglas de Patron

### 3.1 PATRON_LLAMADAS_CRITICAS

```javascript
const regla = {
  codigo: 'PATRON_LLAMADAS_CRITICAS',
  tipo: 'patron',
  severidad: 'alta',
  condicion: (agente) => agente.llamadas_criticas >= 5,
  descripcion: (agente) => 
    `${agente.llamadas_criticas} llamadas con score critico (<40) en 24h`,
  datos: (agente) => ({
    llamadas_criticas: agente.llamadas_criticas,
    total_llamadas: agente.total_llamadas,
    porcentaje: (agente.llamadas_criticas / agente.total_llamadas) * 100
  }),
  accion_requerida: 'Revision urgente de casos criticos'
};
```

### 3.2 PATRON_ABANDONOS_CONSECUTIVOS

```javascript
// Esta regla requiere analizar la secuencia de llamadas
const regla = {
  codigo: 'PATRON_ABANDONOS_CONSECUTIVOS',
  tipo: 'patron',
  severidad: 'alta',
  condicion: (agente) => {
    // Analizar scores_ordenados para encontrar abandonos consecutivos
    const llamadas = agente.llamadas_detalle; // Necesita query adicional
    let maxConsecutivos = 0;
    let consecutivos = 0;
    
    for (const llamada of llamadas) {
      if (llamada.hubo_abandono) {
        consecutivos++;
        maxConsecutivos = Math.max(maxConsecutivos, consecutivos);
      } else {
        consecutivos = 0;
      }
    }
    
    return maxConsecutivos >= 3;
  },
  descripcion: (agente, consecutivos) => 
    `${consecutivos} abandonos consecutivos detectados`,
  datos: (agente, consecutivos) => ({
    abandonos_consecutivos: consecutivos,
    total_abandonos: agente.abandonos
  }),
  accion_requerida: 'Intervencion inmediata - posible problema sistematico'
};
```

---

## 4. Reglas Sistemicas

### 4.1 SISTEMA_TASA_ABANDONO

```javascript
const regla = {
  codigo: 'SISTEMA_TASA_ABANDONO',
  tipo: 'sistemica',
  severidad: 'critica',
  condicion: (metricas) => {
    const tasaAbandono = metricas.abandonos / metricas.total_llamadas;
    return tasaAbandono > 0.25 && metricas.total_llamadas >= 50;
  },
  descripcion: (metricas) => {
    const tasa = Math.round((metricas.abandonos / metricas.total_llamadas) * 100);
    return `Tasa de abandono global del ${tasa}% en ultimas 24h`;
  },
  datos: (metricas) => ({
    tasa_abandono: metricas.abandonos / metricas.total_llamadas,
    abandonos: metricas.abandonos,
    total_llamadas: metricas.total_llamadas,
    umbral: 0.25
  }),
  accion_requerida: 'Revision de operaciones - posible problema sistemico'
};
```

### 4.2 SISTEMA_CAIDA_SCORES

```javascript
const regla = {
  codigo: 'SISTEMA_CAIDA_SCORES',
  tipo: 'sistemica',
  severidad: 'alta',
  condicion: (metricas) => {
    if (!metricas.score_anterior) return false;
    const caida = ((metricas.score_anterior - metricas.score_promedio) / metricas.score_anterior) * 100;
    return caida > 10;
  },
  descripcion: (metricas) => {
    const caida = Math.round(((metricas.score_anterior - metricas.score_promedio) / metricas.score_anterior) * 100);
    return `Score promedio global cayo ${caida}% vs dia anterior`;
  },
  datos: (metricas) => ({
    score_hoy: Math.round(metricas.score_promedio),
    score_ayer: Math.round(metricas.score_anterior),
    caida_porcentaje: ((metricas.score_anterior - metricas.score_promedio) / metricas.score_anterior) * 100
  }),
  accion_requerida: 'Investigar causa de la caida global'
};
```

### 4.3 SISTEMA_VALIDACION_BAJA

```javascript
const regla = {
  codigo: 'SISTEMA_VALIDACION_BAJA',
  tipo: 'sistemica',
  severidad: 'alta',
  condicion: (metricas) => {
    const tasaValidacion = metricas.validaciones_explicitas / metricas.total_llamadas;
    return tasaValidacion < 0.25 && metricas.total_llamadas >= 50;
  },
  descripcion: (metricas) => {
    const tasa = Math.round((metricas.validaciones_explicitas / metricas.total_llamadas) * 100);
    return `Tasa de validacion explicita global del ${tasa}%`;
  },
  datos: (metricas) => ({
    tasa_validacion: metricas.validaciones_explicitas / metricas.total_llamadas,
    validaciones: metricas.validaciones_explicitas,
    total_llamadas: metricas.total_llamadas,
    umbral: 0.25
  }),
  accion_requerida: 'Refuerzo de script de cierre a todos los agentes'
};
```

### 4.4 SISTEMA_VOLUMEN_BAJO

```javascript
const regla = {
  codigo: 'SISTEMA_VOLUMEN_BAJO',
  tipo: 'sistemica',
  severidad: 'media',
  condicion: (metricas) => {
    if (!metricas.llamadas_anterior) return false;
    const porcentaje = (metricas.total_llamadas / metricas.llamadas_anterior) * 100;
    return porcentaje < 70;
  },
  descripcion: (metricas) => {
    const porcentaje = Math.round((metricas.total_llamadas / metricas.llamadas_anterior) * 100);
    return `Volumen de llamadas al ${porcentaje}% vs dia anterior`;
  },
  datos: (metricas) => ({
    llamadas_hoy: metricas.total_llamadas,
    llamadas_ayer: metricas.llamadas_anterior,
    porcentaje: (metricas.total_llamadas / metricas.llamadas_anterior) * 100
  }),
  accion_requerida: 'Verificar problemas de personal o tecnicos'
};
```

---

## 5. Flujo de Evaluacion

```javascript
async function ejecutarDetector() {
  const alertas = [];
  const fecha = new Date().toISOString().split('T')[0];
  
  // 1. Obtener metricas globales
  const metricasGlobales = await obtenerMetricasGlobales();
  
  // 2. Obtener metricas por agente
  const metricasAgentes = await obtenerMetricasPorAgente();
  const comparativasAgentes = await obtenerComparativasAgentes();
  
  // 3. Evaluar reglas por agente
  for (const agente of metricasAgentes) {
    const comparativa = comparativasAgentes.find(c => c.agente_id === agente.agente_id);
    
    for (const regla of reglasAgente) {
      if (regla.condicion(agente, comparativa)) {
        alertas.push({
          tipo: regla.tipo,
          severidad: regla.severidad,
          codigo: regla.codigo,
          descripcion: regla.descripcion(agente, comparativa),
          agente_id: agente.agente_id,
          agente_nombre: agente.agente_nombre,
          equipo: agente.equipo,
          datos: regla.datos(agente, comparativa),
          accion_requerida: regla.accion_requerida,
          fecha_periodo: fecha
        });
      }
    }
    
    // Evaluar reglas de patron
    for (const regla of reglasPatron) {
      if (regla.condicion(agente)) {
        alertas.push({
          tipo: regla.tipo,
          severidad: regla.severidad,
          codigo: regla.codigo,
          descripcion: regla.descripcion(agente),
          agente_id: agente.agente_id,
          agente_nombre: agente.agente_nombre,
          datos: regla.datos(agente),
          accion_requerida: regla.accion_requerida,
          fecha_periodo: fecha
        });
      }
    }
  }
  
  // 4. Evaluar reglas sistemicas
  for (const regla of reglasSistemicas) {
    if (regla.condicion(metricasGlobales)) {
      alertas.push({
        tipo: regla.tipo,
        severidad: regla.severidad,
        codigo: regla.codigo,
        descripcion: regla.descripcion(metricasGlobales),
        agente_id: null,
        agente_nombre: null,
        datos: regla.datos(metricasGlobales),
        accion_requerida: regla.accion_requerida,
        fecha_periodo: fecha
      });
    }
  }
  
  // 5. Filtrar duplicados (alertas similares en ultimos 3 dias)
  const alertasFiltradas = await filtrarDuplicados(alertas);
  
  // 6. Persistir y notificar
  await persistirAlertas(alertasFiltradas);
  await generarResumenYNotificar(alertasFiltradas, metricasGlobales);
  
  return alertasFiltradas;
}
```

---

## 6. Configuracion de Umbrales

```json
{
  "periodo_analisis_horas": 24,
  "minimo_llamadas_agente": 3,
  "minimo_llamadas_sistema": 50,
  
  "umbrales_agente": {
    "score_critico": 40,
    "score_bajo": 55,
    "abandono_alto": 0.20,
    "validacion_minima": 0.15,
    "caida_score": 0.15,
    "probabilidad_baja": 30
  },
  
  "umbrales_patron": {
    "llamadas_criticas_minimo": 5,
    "abandonos_consecutivos_minimo": 3
  },
  
  "umbrales_sistema": {
    "abandono_critico": 0.25,
    "caida_score": 0.10,
    "validacion_minima": 0.25,
    "volumen_minimo": 0.70
  },
  
  "deduplicacion": {
    "ventana_dias": 3
  }
}
```
</file>

<file path="docs/ag4_coach/flujo_completo.md">
# Agente Coach - Flujo Completo E2E (SQL + LLM)

## Resumen del Flujo

```
Cron 08:00 AM
    -> SELECT obtener_agentes_para_coaching() [Supabase Function]
    -> Para cada agente:
       -> SELECT obtener_datos_coaching(agente_id) [Supabase Function]
       -> Enviar a LLM (Claude Opus)
       -> INSERT coaching_reports [SQL directo]
    -> Notificar (Slack/Email)
```

---

## Configuracion del Cron

```javascript
// Saturn Studio - Trigger Cron
{
  "trigger": "cron",
  "schedule": "0 8 * * *",  // Todos los dias a las 08:00
  "timezone": "America/Santiago"
}
```

---

## Funciones de Supabase Disponibles

Las funciones estan en `supabase/functions/coach_functions.sql`

| Funcion | Descripcion | Uso |
|---------|-------------|-----|
| `obtener_agentes_para_coaching(dias, min)` | Lista agentes listos | Paso 1 |
| `obtener_metricas_agente(id, dias)` | Metricas del periodo | Individual |
| `obtener_benchmark_equipo(equipo, dias)` | Promedio del equipo | Comparativa |
| `obtener_ranking_agente(id, equipo, dias)` | Posicion en equipo | Comparativa |
| `obtener_reporte_anterior(id)` | Ultimo reporte | Tendencia |
| `obtener_alertas_agente(id, dias)` | Alertas recientes | Contexto |
| `obtener_muestra_llamadas(id, dias, n)` | Mejores/peores | LLM |
| `obtener_datos_coaching(id, dias)` | **TODO en JSON** | **Principal** |

---

## PASO 1: Obtener Agentes para Coaching

**Query SQL en Saturn Studio:**

```sql
-- Obtener lista de agentes listos para coaching
SELECT * FROM obtener_agentes_para_coaching(7, 5);
```

**Resultado esperado:**
```json
[
  {
    "agente_id": "11111111-1111-1111-1111-111111111111",
    "nombre": "Maria Lopez",
    "equipo": "Equipo Norte",
    "total_llamadas": 12,
    "score_promedio": 82.3,
    "tiene_reporte_anterior": true
  },
  {
    "agente_id": "22222222-2222-2222-2222-222222222222",
    "nombre": "Carlos Mendez",
    "equipo": "Equipo Norte",
    "total_llamadas": 10,
    "score_promedio": 65.5,
    "tiene_reporte_anterior": true
  }
]
```

---

## PASO 2: Para Cada Agente - Obtener Datos Completos

**Query SQL en Saturn Studio:**

```sql
-- Obtener TODOS los datos necesarios para el LLM en un solo JSON
SELECT obtener_datos_coaching('11111111-1111-1111-1111-111111111111', 7);
```

**Resultado esperado:**
```json
{
  "agente": {
    "agente_id": "11111111-1111-1111-1111-111111111111",
    "nombre": "Maria Lopez",
    "email": "maria.lopez@empresa.com",
    "equipo": "Equipo Norte",
    "fecha_ingreso": "2023-01-15",
    "dias_activo": 1116
  },
  "metricas": {
    "periodo_dias": 7,
    "fecha_inicio": "2026-02-02",
    "fecha_fin": "2026-02-03",
    "total_llamadas": 12,
    "score_promedio": 82.3,
    "score_min": 76,
    "score_max": 90,
    "score_contacto_promedio": 80.2,
    "score_compromiso_promedio": 84.4,
    "tasa_validacion_explicita": 1.0,
    "tasa_abandono": 0.0,
    "prob_cumplimiento_promedio": 75.6,
    "distribucion": {
      "excelente_80_100": 8,
      "bueno_60_79": 4,
      "regular_40_59": 0,
      "bajo_0_39": 0
    }
  },
  "benchmark_equipo": {
    "equipo": "Equipo Norte",
    "total_agentes": 2,
    "total_llamadas": 22,
    "score_promedio": 73.9,
    "score_top": 82.3,
    "tasa_validacion_promedio": 0.59,
    "prob_cumplimiento_promedio": 63.1,
    "tasa_abandono_promedio": 0.05
  },
  "ranking": {
    "posicion": 1,
    "total_agentes": 2,
    "percentil": 50,
    "score_agente": 82.3,
    "score_mejor": 82.3,
    "score_promedio_equipo": 73.9,
    "diferencia_vs_mejor": 0,
    "diferencia_vs_promedio": 8.4
  },
  "reporte_anterior": {
    "reporte_id": "d0000001-0000-0000-0000-000000000001",
    "fecha": "2026-01-28",
    "score_anterior": 78,
    "tasa_validacion_anterior": 0.85,
    "objetivo_cumplido": true,
    "objetivo_semana": "Mantener score sobre 80 y mejorar mencion de consecuencias",
    "gap_area": "Consecuencias del impago"
  },
  "tendencia": {
    "score_cambio": 4.3,
    "direccion": "mejorando"
  },
  "alertas": [],
  "muestra_llamadas": [
    {"tipo": "mejor", "score_total": 90, "validacion_tipo": "explicita"},
    {"tipo": "mejor", "score_total": 88, "validacion_tipo": "explicita"},
    {"tipo": "mejor", "score_total": 86, "validacion_tipo": "explicita"},
    {"tipo": "peor", "score_total": 76, "validacion_tipo": "explicita"},
    {"tipo": "peor", "score_total": 78, "validacion_tipo": "explicita"},
    {"tipo": "peor", "score_total": 79, "validacion_tipo": "explicita"}
  ]
}
```

---

## PASO 3: Enviar al LLM (Claude Opus) - Genera JSON con Query

El LLM recibe los datos y genera un **JSON con la query SQL** dentro.

**Prompt completo:**

```
# GENERADOR DE SQL - COACHING REPORT

## TU TAREA
Analiza los datos del agente y genera un JSON con una propiedad "query" que contenga la query SQL completa para insertar en coaching_reports.

## DATOS DEL AGENTE
{DATOS_COACHING_JSON}

## FECHA DE HOY
{FECHA_HOY}

## FORMATO DE RESPUESTA
Responde UNICAMENTE con un JSON valido en este formato exacto:
{"query":"INSERT INTO coaching_reports (...) VALUES (...) RETURNING reporte_id;"}

## REGLAS CRITICAS
1. Responde SOLO con el JSON - nada mas (sin explicaciones, sin markdown, sin ```)
2. La query debe ser una sola linea dentro del valor "query"
3. Todos los campos JSONB en el SQL deben terminar con ::JSONB
4. Las fechas en el SQL usan comillas simples: '2026-02-04'
5. Los UUIDs en el SQL usan comillas simples: 'uuid-aqui'
6. Los JSONB dentro del SQL usan comilla simple afuera, dobles adentro: '{"key":"value"}'::JSONB
7. Para que el JSON de respuesta sea valido, escapa las comillas dobles internas con \"
8. El JSON de respuesta debe ser parseable por JSON.parse()

## ESTRUCTURA DE LA QUERY SQL (dentro del JSON)
INSERT INTO coaching_reports (agente_id, fecha_reporte, periodo_inicio, periodo_fin, total_llamadas_analizadas, metricas_periodo, comparativa_equipo, fortalezas, gap_critico, plan_mejora, progreso_vs_anterior, generado_por, modelo_usado) VALUES (
    agente_id,           -- UUID del agente (viene en datos.agente.agente_id)
    fecha_reporte,       -- Usa FECHA_HOY
    periodo_inicio,      -- Viene en datos.metricas.fecha_inicio
    periodo_fin,         -- Viene en datos.metricas.fecha_fin
    total_llamadas,      -- Viene en datos.metricas.total_llamadas (INTEGER)
    metricas_periodo,    -- JSONB con: score_promedio, score_min, score_max, tasa_validacion, tasa_abandono, probabilidad_cumplimiento_promedio
    comparativa_equipo,  -- JSONB con: score_equipo, validacion_equipo, ranking, total_agentes, percentil, diferencia_vs_promedio
    fortalezas,          -- JSONB array: TU ANALISIS
    gap_critico,         -- JSONB objeto: TU ANALISIS
    plan_mejora,         -- JSONB objeto: TU ANALISIS
    progreso_vs_anterior,-- JSONB objeto: TU ANALISIS
    generado_por,        -- Siempre: ''agente_coach''
    modelo_usado         -- Siempre: ''claude-opus-4-5-20250514''
) RETURNING reporte_id;

## CAMPOS QUE DEBES ANALIZAR Y GENERAR

### fortalezas (array JSONB)
Identifica 1-3 fortalezas basandote en:
- Score alto (>= 75)
- Tasa validacion alta (>= 0.5)
- Bajo abandono (<= 0.1)
- Mejora vs periodo anterior
- Posicion en ranking
Formato: [{"area": "string", "descripcion": "string", "evidencia": "dato concreto", "impacto": "alto|medio|bajo"}]

### gap_critico (objeto JSONB)
Identifica EL gap mas importante basandote en:
- Score bajo (< 60)
- Tasa validacion baja (< 0.3)
- Alto abandono (> 0.15)
- Empeoramiento vs anterior
- Alertas recientes
Si no hay gap critico, usa: {"area": "Ninguno critico", "descripcion": "Mantener nivel actual", "impacto": "bajo", "frecuencia": "ocasional"}
Formato: {"area": "string", "descripcion": "string", "impacto": "critico|alto|medio|bajo", "frecuencia": "constante|frecuente|ocasional"}

### plan_mejora (objeto JSONB)
Genera un plan ESPECIFICO y MEDIBLE:
- objetivo_semana: Que debe lograr esta semana (especifico)
- meta_cuantitativa: Numero concreto (ej: "Score >= 70", "Validacion >= 40%")
- acciones: 2-4 acciones concretas
- recursos_sugeridos: 0-2 recursos (videos, scripts, sesiones)
Formato: {"objetivo_semana": "string", "meta_cuantitativa": "string", "acciones": ["string"], "recursos_sugeridos": ["string"]}

### progreso_vs_anterior (objeto JSONB)
Compara con reporte_anterior si existe:
- score_cambio: diferencia numerica (puede ser negativo)
- validacion_cambio: diferencia numerica
- objetivo_anterior_cumplido: true/false basado en datos
- notas: explicacion breve
Formato: {"score_cambio": number, "validacion_cambio": number, "objetivo_anterior_cumplido": true|false, "notas": "string"}

## EJEMPLO DE OUTPUT CORRECTO

(Nota: las \" son comillas dobles escapadas para que el JSON sea valido)

```json
{
  "query": "INSERT INTO coaching_reports (agente_id, fecha_reporte, periodo_inicio, periodo_fin, total_llamadas_analizadas, metricas_periodo, comparativa_equipo, fortalezas, gap_critico, plan_mejora, progreso_vs_anterior, generado_por, modelo_usado) VALUES ('11111111-1111-1111-1111-111111111111', '2026-02-04', '2026-02-02', '2026-02-03', 12, '{\"score_promedio\":82.3,\"tasa_validacion\":1.0}'::JSONB, '{\"score_equipo\":73.9,\"ranking\":1}'::JSONB, '[{\"area\":\"Validacion\",\"impacto\":\"alto\"}]'::JSONB, '{\"area\":\"Ninguno critico\"}'::JSONB, '{\"objetivo_semana\":\"Mantener score\"}'::JSONB, '{\"score_cambio\":4.3}'::JSONB, 'agente_coach', 'claude-opus-4-5-20250514') RETURNING reporte_id;"
}
```

Cuando Saturn parsea ese JSON y accede a `.query`, obtiene el SQL limpio:

```sql
INSERT INTO coaching_reports (...) VALUES ('...', '{"score_promedio":82.3}'::JSONB, ...) RETURNING reporte_id;
```

## IMPORTANTE
- Responde SOLO con el JSON {"query":"..."}
- Las comillas dobles dentro del SQL se escapan automaticamente con \"
- NO incluyas explicaciones, comentarios ni markdown fuera del JSON
- El JSON debe ser parseable con JSON.parse()
```

**En Saturn Studio:**

```javascript
// Nodo: HTTP Request a Claude
const datosCoaching = resultadoPaso2;
const fechaHoy = new Date().toISOString().split('T')[0]; // '2026-02-04'

const prompt = `# GENERADOR DE SQL - COACHING REPORT
... (usar el prompt completo de arriba, reemplazando {DATOS_COACHING_JSON} y {FECHA_HOY})
`;

const response = await claudeAPI(prompt);
const jsonResponse = JSON.parse(response.content[0].text.trim());
// jsonResponse = { "query": "INSERT INTO coaching_reports ..." }
```

---

## PASO 4: Ejecutar SQL desde el JSON

El LLM devuelve `{"query": "INSERT..."}`, accedes a `.query` y ejecutas:

**En Saturn Studio (Nodo SQL):**

```sql
{var_aiagent_analisis.query}
```

**O en un nodo de codigo:**

```javascript
// El LLM devolvio JSON con la query
const resultado = var_aiagent_analisis;  // {"query": "INSERT..."}
const sql = resultado.query;

// Ejecutar
const result = await ejecutarSQL(sql);
```

**Ventaja:** Saturn puede parsear el JSON sin problemas, y accedes a `.query` para obtener el SQL limpio.

---

## Ejemplo Completo

**Input al LLM (datos de Maria Lopez):**
```json
{
  "agente": {"agente_id": "11111111-1111-1111-1111-111111111111", "nombre": "Maria Lopez"},
  "metricas": {"fecha_inicio": "2026-02-02", "fecha_fin": "2026-02-03", "total_llamadas": 12, "score_promedio": 82.3},
  "ranking": {"posicion": 1, "percentil": 50, "diferencia_vs_promedio": 8.4},
  "reporte_anterior": {"score_anterior": 78, "objetivo_cumplido": true},
  "tendencia": {"score_cambio": 4.3, "direccion": "mejorando"}
}
```

**Output del LLM (JSON con query):**
```json
{"query":"INSERT INTO coaching_reports (agente_id, fecha_reporte, periodo_inicio, periodo_fin, total_llamadas_analizadas, metricas_periodo, comparativa_equipo, fortalezas, gap_critico, plan_mejora, progreso_vs_anterior, generado_por, modelo_usado) VALUES ('11111111-1111-1111-1111-111111111111', '2026-02-04', '2026-02-02', '2026-02-03', 12, '{\"score_promedio\":82.3,\"tasa_validacion\":1.0}'::JSONB, '{\"score_equipo\":73.9,\"ranking\":1}'::JSONB, '[{\"area\":\"Validacion\",\"impacto\":\"alto\"}]'::JSONB, '{\"area\":\"Ninguno critico\"}'::JSONB, '{\"objetivo_semana\":\"Mantener score\"}'::JSONB, '{\"score_cambio\":4.3}'::JSONB, 'agente_coach', 'claude-opus-4-5-20250514') RETURNING reporte_id;"}
```

**En Saturn:**
```
{var_aiagent_analisis.query}
```

**Resultado:** Saturn parsea el JSON, extrae `.query`, y ejecuta el SQL.

---

## Flujo Completo en Saturn Studio

### Nodo 1: Obtener Agentes

```sql
SELECT * FROM obtener_agentes_para_coaching(7, 5);
```

### Nodo 2: Loop - Para cada agente

```javascript
// Configurar loop sobre resultado del Nodo 1
for (const agente of agentes) {
    // Ejecutar Nodos 3-5 para cada agente
}
```

### Nodo 3: Obtener Datos Coaching (dentro del loop)

```sql
SELECT obtener_datos_coaching($agente_id, 7);
```

### Nodo 4: Llamar Claude (dentro del loop)

```javascript
// HTTP Request a Claude API con el JSON del Nodo 3
// Ver PASO 3 arriba
```

### Nodo 5: Insertar Reporte (dentro del loop)

```sql
-- INSERT usando datos del Nodo 3 (metricas) + Nodo 4 (analisis LLM)
INSERT INTO coaching_reports (...) VALUES (...) RETURNING reporte_id;
```

### Nodo 6: Preparar Resumen

```sql
-- Obtener resumen de reportes generados hoy
SELECT 
    a.equipo,
    COUNT(*) as reportes_generados,
    AVG((cr.metricas_periodo->>'score_promedio')::NUMERIC) as score_promedio,
    COUNT(*) FILTER (WHERE (cr.metricas_periodo->>'score_promedio')::NUMERIC < 50) as requieren_atencion
FROM coaching_reports cr
JOIN agentes a ON cr.agente_id = a.agente_id
WHERE cr.fecha_reporte = CURRENT_DATE
GROUP BY a.equipo;
```

### Nodo 7: Notificar Slack (si hay agentes criticos)

```javascript
// Enviar resumen a Slack si hay agentes que requieren atencion
```

---

## Tiempos Esperados

| Paso | Por Agente | Total (20 agentes) |
|------|------------|-------------------|
| obtener_datos_coaching() | ~300ms | 6s |
| Claude API | ~3-5s | 60-100s (secuencial) |
| INSERT reporte | ~100ms | 2s |
| **Total** | ~4-6s | **~2-3 min** |

---

## Diagrama de Flujo Saturn Studio

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    CRON 08:00 AM                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  NODO 1: SQL Query                                          ‚îÇ
‚îÇ  SELECT * FROM obtener_agentes_para_coaching(7, 5)          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  NODO 2: Loop sobre agentes                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ  NODO 3: SQL                                           ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  SELECT obtener_datos_coaching(agente_id, 7)           ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                       ‚ñº                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ  NODO 4: HTTP Request                                  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  POST Claude API con datos + prompt                    ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                       ‚ñº                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ  NODO 5: SQL                                           ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  INSERT INTO coaching_reports                          ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  NODO 6: SQL Query                                          ‚îÇ
‚îÇ  Obtener resumen de reportes generados                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  NODO 7: Condicional                                        ‚îÇ
‚îÇ  IF requieren_atencion > 0                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ SI                             ‚îÇ NO
         ‚ñº                                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  NODO 8: HTTP       ‚îÇ          ‚îÇ  FIN                ‚îÇ
‚îÇ  POST Slack         ‚îÇ          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ
          ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  FIN                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Queries de Verificacion

### Ver reportes de hoy
```sql
SELECT 
    a.nombre,
    a.equipo,
    cr.metricas_periodo->>'score_promedio' as score,
    cr.plan_mejora->>'objetivo_semana' as objetivo
FROM coaching_reports cr
JOIN agentes a ON cr.agente_id = a.agente_id
WHERE cr.fecha_reporte = CURRENT_DATE
ORDER BY a.equipo, a.nombre;
```

### Ver tendencia de un agente
```sql
SELECT 
    fecha_reporte,
    metricas_periodo->>'score_promedio' as score,
    progreso_vs_anterior->>'score_cambio' as cambio
FROM coaching_reports
WHERE agente_id = '11111111-1111-1111-1111-111111111111'
ORDER BY fecha_reporte DESC
LIMIT 5;
```

### Agentes que necesitan atencion
```sql
SELECT 
    a.nombre,
    a.equipo,
    (cr.metricas_periodo->>'score_promedio')::NUMERIC as score,
    cr.gap_critico->>'area' as gap
FROM coaching_reports cr
JOIN agentes a ON cr.agente_id = a.agente_id
WHERE cr.fecha_reporte = CURRENT_DATE
  AND (cr.metricas_periodo->>'score_promedio')::NUMERIC < 50
ORDER BY (cr.metricas_periodo->>'score_promedio')::NUMERIC;
```
</file>

<file path="docs/ag4_coach/input_ejemplo.json">
{
  "_descripcion": "Input completo que recibe el Agente Coach para generar un reporte",
  
  "agente": {
    "agente_id": "11111111-2222-3333-4444-555555555555",
    "nombre": "Maria Garcia",
    "email": "maria.garcia@empresa.com",
    "equipo": "Equipo Norte",
    "supervisor_id": "99999999-8888-7777-6666-555555555555",
    "fecha_ingreso": "2025-10-15",
    "estado": "activo",
    "dias_activo": 112
  },
  
  "ultimos_25_analisis": [
    {
      "analisis_id": "anal-001",
      "fecha": "2026-02-03",
      "score_total": 85,
      "score_contacto_directo": 90,
      "score_compromiso_pago": 80,
      "validacion_tipo": "explicita",
      "hubo_abandono": false,
      "probabilidad_cumplimiento": 78,
      "monto_comprometido": 150000
    },
    {
      "analisis_id": "anal-002",
      "fecha": "2026-02-03",
      "score_total": 72,
      "score_contacto_directo": 80,
      "score_compromiso_pago": 64,
      "validacion_tipo": "implicita",
      "hubo_abandono": false,
      "probabilidad_cumplimiento": 52,
      "monto_comprometido": 80000
    },
    {
      "analisis_id": "anal-003",
      "fecha": "2026-02-02",
      "score_total": 45,
      "score_contacto_directo": 60,
      "score_compromiso_pago": 30,
      "validacion_tipo": "ninguna",
      "hubo_abandono": true,
      "probabilidad_cumplimiento": 15,
      "monto_comprometido": 0
    },
    {
      "analisis_id": "anal-004",
      "fecha": "2026-02-02",
      "score_total": 78,
      "score_contacto_directo": 85,
      "score_compromiso_pago": 71,
      "validacion_tipo": "explicita",
      "hubo_abandono": false,
      "probabilidad_cumplimiento": 72,
      "monto_comprometido": 200000
    },
    {
      "analisis_id": "anal-005",
      "fecha": "2026-02-01",
      "score_total": 68,
      "score_contacto_directo": 75,
      "score_compromiso_pago": 61,
      "validacion_tipo": "implicita",
      "hubo_abandono": false,
      "probabilidad_cumplimiento": 48,
      "monto_comprometido": 95000
    }
  ],
  
  "metricas_calculadas": {
    "periodo": {
      "inicio": "2026-01-28",
      "fin": "2026-02-03",
      "dias": 7
    },
    "score_promedio": 72,
    "score_contacto_promedio": 78,
    "score_compromiso_promedio": 66,
    "total_llamadas": 25,
    "llamadas_con_compromiso": 18,
    "validaciones_explicitas": 5,
    "validaciones_implicitas": 10,
    "sin_validacion": 10,
    "tasa_validacion_explicita": 0.20,
    "tasa_validacion_total": 0.60,
    "abandonos": 2,
    "tasa_abandono": 0.08,
    "probabilidad_cumplimiento_promedio": 58,
    "monto_total_comprometido": 2450000,
    "distribucion_scores": {
      "excelente_80_100": 6,
      "bueno_60_79": 12,
      "regular_40_59": 5,
      "bajo_0_39": 2
    }
  },
  
  "comparativa_equipo": {
    "equipo": "Equipo Norte",
    "total_agentes": 12,
    "score_promedio_equipo": 78,
    "tasa_validacion_equipo": 0.42,
    "tasa_abandono_equipo": 0.06,
    "ranking_agente": 8,
    "percentil": 65,
    "top_performer": {
      "nombre": "Carlos Mendez",
      "score": 92
    },
    "promedio_equipo_detalle": {
      "score_contacto": 82,
      "score_compromiso": 74,
      "probabilidad_cumplimiento": 68
    }
  },
  
  "reporte_anterior": {
    "fecha_reporte": "2026-01-28",
    "metricas_periodo": {
      "score_promedio": 67,
      "tasa_validacion_explicita": 0.15,
      "tasa_abandono": 0.12
    },
    "gap_critico": {
      "area": "tasa_abandono",
      "objetivo": "Reducir abandono a menos del 10%"
    },
    "plan_mejora": {
      "objetivo_semanal": "Reducir tasa de abandono a <10%",
      "acciones": [
        "Establecer rapport en primeros 30 segundos",
        "No presionar cierre antes de 2 minutos"
      ]
    }
  },
  
  "alertas_periodo": [
    {
      "alerta_id": "alert-001",
      "fecha": "2026-02-02",
      "codigo": "ABANDONO_CLIENTE",
      "severidad": "alta",
      "descripcion": "Cliente abandono la llamada"
    },
    {
      "alerta_id": "alert-002",
      "fecha": "2026-02-01",
      "codigo": "SCORE_BAJO",
      "severidad": "alta",
      "descripcion": "Score 42 en llamada"
    }
  ],
  
  "muestra_llamadas": {
    "mejores": [
      {
        "analisis_id": "anal-001",
        "fecha": "2026-02-03",
        "score_total": 85,
        "validacion": "explicita",
        "monto_comprometido": 150000,
        "duracion_segundos": 245,
        "resumen": "Excelente manejo de objeciones, cierre efectivo"
      },
      {
        "analisis_id": "anal-004",
        "fecha": "2026-02-02",
        "score_total": 78,
        "validacion": "explicita",
        "monto_comprometido": 200000,
        "duracion_segundos": 312,
        "resumen": "Cliente dificil manejado con paciencia"
      }
    ],
    "peores": [
      {
        "analisis_id": "anal-003",
        "fecha": "2026-02-02",
        "score_total": 45,
        "validacion": "ninguna",
        "monto_comprometido": 0,
        "duracion_segundos": 98,
        "razon_bajo_score": "Abandono por cliente, sin establecer rapport"
      }
    ]
  }
}
</file>

<file path="docs/ag4_coach/insert_supabase.md">
# Agente Coach - INSERT en Supabase

## Tabla Destino: `coaching_reports`

---

## SQL de INSERT Completo

```sql
INSERT INTO coaching_reports (
    agente_id,
    fecha_reporte,
    periodo_evaluado,
    metricas_periodo,
    distribucion_scores,
    tendencia,
    comparativa_equipo,
    fortalezas,
    gap_critico,
    plan_mejora,
    progreso_objetivo_anterior,
    mensaje_motivacional,
    metricas_destacadas,
    recomendacion_supervisor,
    alertas_periodo,
    metadata
) VALUES (
    $1,   -- agente_id UUID
    $2,   -- fecha_reporte DATE
    $3,   -- periodo_evaluado JSONB
    $4,   -- metricas_periodo JSONB
    $5,   -- distribucion_scores JSONB
    $6,   -- tendencia JSONB
    $7,   -- comparativa_equipo JSONB
    $8,   -- fortalezas JSONB
    $9,   -- gap_critico JSONB
    $10,  -- plan_mejora JSONB
    $11,  -- progreso_objetivo_anterior JSONB
    $12,  -- mensaje_motivacional TEXT
    $13,  -- metricas_destacadas JSONB
    $14,  -- recomendacion_supervisor TEXT
    $15,  -- alertas_periodo JSONB
    $16   -- metadata JSONB
) RETURNING reporte_id;
```

---

## Ejemplo con Datos Reales (una linea)

```sql
INSERT INTO coaching_reports (agente_id, fecha_reporte, periodo_evaluado, metricas_periodo, distribucion_scores, tendencia, comparativa_equipo, fortalezas, gap_critico, plan_mejora, progreso_objetivo_anterior, mensaje_motivacional, metricas_destacadas, recomendacion_supervisor, alertas_periodo, metadata) VALUES ('11111111-2222-3333-4444-555555555555', '2026-02-04', '{"inicio":"2026-01-28","fin":"2026-02-03","dias":7,"llamadas_analizadas":25}'::JSONB, '{"score_promedio":72,"score_contacto_promedio":78,"score_compromiso_promedio":66,"tasa_validacion_explicita":0.20,"tasa_abandono":0.08,"probabilidad_cumplimiento_promedio":58,"total_llamadas":25}'::JSONB, '{"excelente_80_100":6,"bueno_60_79":12,"regular_40_59":5,"bajo_0_39":2}'::JSONB, '{"vs_semana_anterior":5,"direccion":"mejorando","racha":2}'::JSONB, '{"score_promedio_equipo":78,"ranking":8,"total_agentes_equipo":12,"percentil":65,"distancia_al_mejor":-20,"distancia_al_promedio":-6}'::JSONB, '[{"area":"manejo_objeciones","descripcion":"Excelente capacidad para responder dudas","evidencia":"Solo 2 objeciones no resueltas en 25 llamadas"},{"area":"identificacion_cliente","descripcion":"Verificacion consistente","evidencia":"100% de llamadas con verificacion correcta"},{"area":"tono_positivo","descripcion":"Mantiene tono profesional","evidencia":"Emocion positivo en 68% de segmentos"}]'::JSONB, '{"area":"validacion_compromiso","descripcion":"Solo 20% de validacion explicita","impacto":"Reduce probabilidad de cumplimiento en 35%","benchmark_equipo":"Equipo: 42%","ejemplo_llamada":"anal-005"}'::JSONB, '{"objetivo_semanal":"Lograr 40% validacion explicita","acciones":[{"accion":"Usar frase de confirmacion","cuando":"Cada cierre","prioridad":"alta"},{"accion":"No aceptar ok como validacion","cuando":"Respuestas ambiguas","prioridad":"alta"}],"recursos_sugeridos":["Video: Tecnicas de cierre","Script: Frases de validacion"]}'::JSONB, '{"objetivo_anterior":"Reducir abandono a <10%","resultado":"cumplido","valor_logrado":"8%","nota":"Excelente mejora"}'::JSONB, 'Maria, tu progreso es notable: subiste 5 puntos esta semana. Tu fortaleza en manejo de objeciones es un activo valioso. Esta semana, enfocate en cerrar con fuerza!', '{"mejor_metrica":{"nombre":"Tasa abandono","valor":"8%","vs_equipo":"-25%"},"metrica_mejorar":{"nombre":"Validacion explicita","valor":"20%","vs_equipo":"-52%"}}'::JSONB, 'Maria ha demostrado mejora sostenida. Recomiendo escuchar grabaciones con ella para identificar patron de validacion.', '[{"fecha":"2026-02-02","tipo":"ABANDONO_CLIENTE","descripcion":"Cliente abandono la llamada"}]'::JSONB, '{"modelo_usado":"claude-opus-4-5-20250514","version_prompt":"v1.0","tiempo_generacion_ms":4500}'::JSONB) RETURNING reporte_id;
```

---

## Mapeo de Campos

| Campo | Tipo | Fuente | Notas |
|-------|------|--------|-------|
| `agente_id` | UUID | Input | FK a agentes |
| `fecha_reporte` | DATE | Calculado | Fecha de generacion |
| `periodo_evaluado` | JSONB | Calculado | inicio, fin, dias |
| `metricas_periodo` | JSONB | Calculado | Todas las metricas |
| `distribucion_scores` | JSONB | Calculado | Histograma |
| `tendencia` | JSONB | Calculado | vs semana anterior |
| `comparativa_equipo` | JSONB | Calculado | Ranking, percentil |
| `fortalezas` | JSONB | LLM | Array de 3 fortalezas |
| `gap_critico` | JSONB | LLM | Area prioritaria |
| `plan_mejora` | JSONB | LLM | Objetivo + acciones |
| `progreso_objetivo_anterior` | JSONB | LLM | Seguimiento |
| `mensaje_motivacional` | TEXT | LLM | 2-3 oraciones |
| `metricas_destacadas` | JSONB | LLM | Mejor/peor metrica |
| `recomendacion_supervisor` | TEXT | LLM | Nota para supervisor |
| `alertas_periodo` | JSONB | Query | Alertas de la semana |
| `metadata` | JSONB | Sistema | Modelo, version, tiempo |

---

## Queries de Consulta Frecuentes

### Ultimo reporte de un agente
```sql
SELECT * FROM coaching_reports
WHERE agente_id = $1
ORDER BY fecha_reporte DESC
LIMIT 1;
```

### Reportes de hoy por equipo
```sql
SELECT cr.*, a.nombre as agente_nombre
FROM coaching_reports cr
JOIN agentes a ON cr.agente_id = a.agente_id
WHERE a.equipo = $1
  AND cr.fecha_reporte = CURRENT_DATE
ORDER BY cr.metricas_periodo->>'score_promedio' DESC;
```

### Agentes con mejora sostenida
```sql
SELECT 
  cr.agente_id,
  a.nombre,
  cr.tendencia->>'racha' as racha_mejora
FROM coaching_reports cr
JOIN agentes a ON cr.agente_id = a.agente_id
WHERE cr.fecha_reporte = CURRENT_DATE
  AND cr.tendencia->>'direccion' = 'mejorando'
  AND (cr.tendencia->>'racha')::int >= 2
ORDER BY (cr.tendencia->>'racha')::int DESC;
```

### Agentes que necesitan atencion
```sql
SELECT 
  cr.agente_id,
  a.nombre,
  cr.metricas_periodo->>'score_promedio' as score,
  cr.gap_critico->>'area' as area_critica
FROM coaching_reports cr
JOIN agentes a ON cr.agente_id = a.agente_id
WHERE cr.fecha_reporte = CURRENT_DATE
  AND (cr.metricas_periodo->>'score_promedio')::int < 50
ORDER BY (cr.metricas_periodo->>'score_promedio')::int ASC;
```

---

## Supabase JS SDK

```javascript
// INSERT reporte
const { data, error } = await supabase
  .from('coaching_reports')
  .insert({
    agente_id: '11111111-2222-3333-4444-555555555555',
    fecha_reporte: '2026-02-04',
    periodo_evaluado: { inicio: '2026-01-28', fin: '2026-02-03', dias: 7 },
    metricas_periodo: { score_promedio: 72, tasa_validacion_explicita: 0.20 },
    distribucion_scores: { excelente_80_100: 6, bueno_60_79: 12 },
    tendencia: { vs_semana_anterior: 5, direccion: 'mejorando', racha: 2 },
    comparativa_equipo: { ranking: 8, total_agentes_equipo: 12 },
    fortalezas: [{ area: 'manejo_objeciones', descripcion: '...' }],
    gap_critico: { area: 'validacion_compromiso', descripcion: '...' },
    plan_mejora: { objetivo_semanal: '40% validacion', acciones: [...] },
    progreso_objetivo_anterior: { resultado: 'cumplido' },
    mensaje_motivacional: 'Excelente trabajo...',
    metricas_destacadas: { mejor_metrica: {...}, metrica_mejorar: {...} },
    recomendacion_supervisor: 'Escuchar grabaciones con agente...',
    alertas_periodo: [...],
    metadata: { modelo_usado: 'claude-opus-4-5' }
  })
  .select('reporte_id')
  .single();

// Obtener historico de reportes
const { data: historico } = await supabase
  .from('coaching_reports')
  .select('fecha_reporte, metricas_periodo, tendencia')
  .eq('agente_id', agenteId)
  .order('fecha_reporte', { ascending: false })
  .limit(12);  // Ultimos 3 meses

// Obtener reportes del equipo hoy
const { data: equipoHoy } = await supabase
  .from('coaching_reports')
  .select(`
    *,
    agentes!inner(nombre, email)
  `)
  .eq('agentes.equipo', 'Equipo Norte')
  .eq('fecha_reporte', new Date().toISOString().split('T')[0]);
```

---

## Crear Notificacion para Agente

```javascript
async function notificarReporteCoaching(agente, reporte) {
  // 1. Crear notificacion in-app
  await supabase.from('notificaciones_usuarios').insert({
    usuario_id: agente.usuario_id,
    tipo: 'coaching_report',
    titulo: 'Tu reporte de coaching esta listo!',
    mensaje: `Score: ${reporte.metricas_periodo.score_promedio} | Ranking: ${reporte.comparativa_equipo.ranking}/${reporte.comparativa_equipo.total_agentes_equipo}`,
    datos: {
      reporte_id: reporte.reporte_id,
      fecha: reporte.fecha_reporte,
      tendencia: reporte.tendencia.direccion
    },
    leida: false
  });
  
  // 2. Opcional: Email si es agente nuevo o bajo rendimiento
  if (agente.dias_activo < 30 || reporte.metricas_periodo.score_promedio < 50) {
    await enviarEmailCoaching(agente.email, reporte);
  }
}
```
</file>

<file path="docs/ag4_coach/output_ejemplo.json">
{
  "_descripcion": "Output completo del Agente Coach para INSERT en coaching_reports",
  
  "agente_id": "11111111-2222-3333-4444-555555555555",
  "fecha_reporte": "2026-02-04",
  
  "periodo_evaluado": {
    "inicio": "2026-01-28",
    "fin": "2026-02-03",
    "dias": 7,
    "llamadas_analizadas": 25
  },
  
  "metricas_periodo": {
    "score_promedio": 72,
    "score_contacto_promedio": 78,
    "score_compromiso_promedio": 66,
    "tasa_validacion_explicita": 0.20,
    "tasa_validacion_total": 0.60,
    "tasa_abandono": 0.08,
    "probabilidad_cumplimiento_promedio": 58,
    "total_llamadas": 25,
    "llamadas_con_compromiso": 18,
    "monto_total_comprometido": 2450000
  },
  
  "distribucion_scores": {
    "excelente_80_100": 6,
    "bueno_60_79": 12,
    "regular_40_59": 5,
    "bajo_0_39": 2
  },
  
  "tendencia": {
    "vs_semana_anterior": 5,
    "direccion": "mejorando",
    "racha": 2
  },
  
  "comparativa_equipo": {
    "score_promedio_equipo": 78,
    "ranking": 8,
    "total_agentes_equipo": 12,
    "percentil": 65,
    "distancia_al_mejor": -20,
    "distancia_al_promedio": -6
  },
  
  "fortalezas": [
    {
      "area": "manejo_objeciones",
      "descripcion": "Excelente capacidad para responder dudas y manejar resistencia del cliente de forma empatica",
      "evidencia": "Solo 2 objeciones no resueltas en 25 llamadas. Score promedio en manejo: 22/25 pts"
    },
    {
      "area": "identificacion_cliente",
      "descripcion": "Verificacion de identidad consistente y profesional en todas las llamadas",
      "evidencia": "100% de llamadas con verificacion correcta. Score promedio: 15/15 pts"
    },
    {
      "area": "tono_positivo",
      "descripcion": "Mantiene un tono profesional, amable y empatico incluso en llamadas dificiles",
      "evidencia": "Emocion dominante 'positivo' en 68% de sus segmentos. Evolucion cliente: mejoro en 72% de llamadas"
    }
  ],
  
  "gap_critico": {
    "area": "validacion_compromiso",
    "descripcion": "Solo el 20% de los compromisos tienen validacion explicita del cliente",
    "impacto": "Reduce la probabilidad de cumplimiento en aproximadamente 35%. Los compromisos con validacion implicita tienen 40% menos probabilidad de cumplirse",
    "benchmark_equipo": "El promedio del equipo es 42% de validacion explicita, Maria esta 22 puntos por debajo",
    "ejemplo_llamada": "anal-005 - Cliente dijo 'ok, entiendo' pero no confirmo monto ni fecha especifica"
  },
  
  "plan_mejora": {
    "objetivo_semanal": "Lograr validacion explicita en al menos 40% de los compromisos (subir de 20% a 40%)",
    "acciones": [
      {
        "accion": "Antes de cerrar, usar la frase: 'Entonces confirmo, usted pagara [MONTO] el [FECHA] por [METODO], es correcto?'",
        "cuando": "En cada llamada donde hay un compromiso de pago",
        "prioridad": "alta"
      },
      {
        "accion": "No aceptar respuestas como 'ok', 'ya', 'entiendo' como validacion. Pedir confirmacion explicita",
        "cuando": "Cuando el cliente responde de forma ambigua",
        "prioridad": "alta"
      },
      {
        "accion": "Repetir el compromiso completo (monto, fecha, metodo) al menos 2 veces durante el cierre",
        "cuando": "En los ultimos 60 segundos de cada llamada con compromiso",
        "prioridad": "media"
      }
    ],
    "recursos_sugeridos": [
      "Video: Tecnicas de cierre efectivo en cobranzas (15 min)",
      "Script: Frases de validacion explicita",
      "Ejercicio: Role-play de cierres con supervisor"
    ]
  },
  
  "progreso_objetivo_anterior": {
    "objetivo_anterior": "Reducir tasa de abandono a menos del 10%",
    "resultado": "cumplido",
    "valor_logrado": "8%",
    "nota": "Excelente mejora! Bajo de 12% a 8% de abandono. Las tecnicas de rapport estan funcionando"
  },
  
  "mensaje_motivacional": "Maria, tu progreso es notable: subiste 5 puntos esta semana y cumpliste tu objetivo de reducir abandonos. Tu fortaleza en manejo de objeciones es un activo valioso. Esta semana, el siguiente paso es cerrar con fuerza: una validacion explicita puede ser la diferencia entre un compromiso cumplido y uno olvidado. Estas a 6 puntos del promedio del equipo, y se que puedes alcanzarlo!",
  
  "metricas_destacadas": {
    "mejor_metrica": {
      "nombre": "Tasa de abandono",
      "valor": "8%",
      "vs_equipo": "-25% mejor que equipo (6% equipo)"
    },
    "metrica_mejorar": {
      "nombre": "Validacion explicita",
      "valor": "20%",
      "vs_equipo": "-52% peor que equipo (42% equipo)"
    }
  },
  
  "recomendacion_supervisor": "Maria ha demostrado mejora sostenida las ultimas 2 semanas. Recomiendo escuchar con ella 2-3 grabaciones donde logro validacion explicita vs donde no, para que identifique el patron. Tiene el talento para estar en el top 5.",
  
  "alertas_periodo": [
    {
      "fecha": "2026-02-02",
      "tipo": "ABANDONO_CLIENTE",
      "descripcion": "Cliente abandono la llamada",
      "impacto_score": "Afecto score de esa llamada (-15 pts)"
    },
    {
      "fecha": "2026-02-01",
      "tipo": "SCORE_BAJO",
      "descripcion": "Score 42 en llamada",
      "impacto_score": "Bajo el promedio semanal"
    }
  ],
  
  "metadata": {
    "modelo_usado": "claude-opus-4-5-20250514",
    "version_prompt": "v1.0",
    "tiempo_generacion_ms": 4500,
    "confianza_analisis": 0.88
  }
}
</file>

<file path="docs/ag4_coach/plan_implementacion.md">
# Plan de Implementacion - Agente Coach

## Resumen

| Aspecto | Detalle |
|---------|---------|
| **Tiempo estimado** | 3-4 dias |
| **Complejidad** | Alta |
| **Dependencias** | Agente Analista funcionando, datos historicos |
| **Tecnologias** | Saturn Studio, Claude Opus 4.5, Supabase, Email |

---

## Objetivos del Sprint

1. Implementar cron diario a las 08:00 AM
2. Calcular metricas por agente
3. Implementar comparativa con equipo
4. Integrar Claude Opus para analisis y recomendaciones
5. Generar reportes personalizados
6. Configurar notificaciones a agentes y supervisores
7. Testing end-to-end

---

## Checklist Detallado

### Fase 1: Preparacion (Dia 1 - Manana)

#### 1.1 Configuracion de Entorno
- [ ] Verificar acceso a Saturn Studio
- [ ] Verificar API key de Anthropic (Claude Opus)
- [ ] Configurar variables de entorno:
  ```
  CLAUDE_API_KEY=sk-ant-xxx
  CLAUDE_MODEL_COACH=claude-opus-4-5-20250514
  SUPABASE_URL=https://xxx.supabase.co
  SUPABASE_KEY=xxx
  SENDGRID_API_KEY=SG.xxx
  EMAIL_FROM=coaching@nodus.com
  ```

#### 1.2 Verificar Schema de Supabase
- [ ] Confirmar tabla `coaching_reports` existe con todos los campos
- [ ] Verificar tabla `agentes` tiene campo `equipo` y `supervisor_id`
- [ ] Crear indices para queries frecuentes:
  ```sql
  CREATE INDEX idx_coaching_agente_fecha ON coaching_reports(agente_id, fecha_reporte DESC);
  CREATE INDEX idx_analisis_agente_fecha ON analisis_llamadas(agente_id, created_at DESC);
  ```

#### 1.3 Verificar Datos Historicos
- [ ] Confirmar que hay al menos 1 semana de datos en analisis_llamadas
- [ ] Verificar que hay agentes activos con llamadas
- [ ] Identificar agentes de prueba para testing

---

### Fase 2: Obtencion de Datos (Dia 1 - Tarde)

#### 2.1 Crear Flujo Principal
- [ ] Crear nuevo flujo "Agente Coach"
- [ ] Configurar trigger: Cron `0 8 * * *` (08:00 diario)
- [ ] Timezone: America/Santiago
- [ ] Configurar timeout: 15 minutos

#### 2.2 Nodo: Obtener Agentes Activos
- [ ] Query agentes WHERE estado = 'activo'
- [ ] Filtrar por antiguedad > 7 dias
- [ ] Agrupar por equipo
- [ ] Obtener supervisor de cada equipo

#### 2.3 Nodo: Obtener Datos por Agente (Paralelo)
- [ ] Query: Ultimos 25 analisis del agente
- [ ] Query: Reporte de coaching anterior
- [ ] Query: Alertas de la semana
- [ ] Query: Benchmark del equipo
- [ ] Configurar paralelismo max 5 agentes

#### 2.4 Validacion de Datos
- [ ] Verificar minimo 5 llamadas para generar reporte
- [ ] Manejar agentes sin historial
- [ ] Logging de agentes saltados

---

### Fase 3: Calculo de Metricas (Dia 2 - Manana)

#### 3.1 Nodo: Calcular Metricas del Periodo
- [ ] Implementar funcion calcularMetricas()
- [ ] Calcular scores promedio
- [ ] Calcular tasa de validacion
- [ ] Calcular tasa de abandono
- [ ] Calcular distribucion de scores
- [ ] Calcular probabilidad cumplimiento promedio

#### 3.2 Nodo: Calcular Comparativa con Equipo
- [ ] Implementar funcion calcularComparativa()
- [ ] Calcular ranking en el equipo
- [ ] Calcular percentil
- [ ] Calcular distancia al mejor/promedio

#### 3.3 Nodo: Calcular Tendencia
- [ ] Comparar con reporte anterior
- [ ] Determinar direccion (mejorando/estable/empeorando)
- [ ] Calcular racha de mejora/caida

#### 3.4 Nodo: Preparar Muestra de Llamadas
- [ ] Seleccionar 3 mejores llamadas
- [ ] Seleccionar 3 peores llamadas
- [ ] Incluir razones de bajo score

---

### Fase 4: Analisis con LLM (Dia 2 - Tarde)

#### 4.1 Nodo: Construir Prompt
- [ ] Cargar template de prompt_analisis_agente.md
- [ ] Inyectar todas las variables:
  - Datos del agente
  - Metricas del periodo
  - Comparativa equipo
  - Reporte anterior
  - Alertas
  - Muestra de llamadas
- [ ] Validar que el prompt no exceda limites

#### 4.2 Nodo: Llamar Claude Opus
- [ ] Configurar:
  - Model: claude-opus-4-5-20250514
  - Temperature: 0.4
  - Max tokens: 3000
- [ ] Implementar retry con backoff
- [ ] Timeout: 60 segundos por agente

#### 4.3 Nodo: Parsear y Validar Respuesta
- [ ] Parsear JSON de respuesta
- [ ] Validar estructura esperada:
  - fortalezas: array de 3
  - gap_critico: objeto completo
  - plan_mejora: con objetivo y acciones
  - mensaje_motivacional: 50-300 chars
- [ ] Manejar errores de parsing

---

### Fase 5: Persistencia (Dia 3 - Manana)

#### 5.1 Nodo: Construir Reporte Completo
- [ ] Combinar metricas calculadas + output LLM
- [ ] Agregar metadata (modelo, tiempo, version)
- [ ] Validar objeto completo antes de INSERT

#### 5.2 Nodo: INSERT en coaching_reports
- [ ] INSERT con RETURNING reporte_id
- [ ] Manejar errores de constraint
- [ ] Logging de reportes creados

#### 5.3 Nodo: Agrupar Reportes por Equipo
- [ ] Agrupar para resumen de supervisor
- [ ] Calcular metricas agregadas del equipo
- [ ] Identificar top performers
- [ ] Identificar agentes que requieren atencion

---

### Fase 6: Notificaciones (Dia 3 - Tarde)

#### 6.1 Notificacion a Agentes (In-app)
- [ ] INSERT en notificaciones_usuarios
- [ ] Incluir:
  - Score y tendencia
  - Ranking en equipo
  - Link al reporte completo
- [ ] Configurar badge en dashboard

#### 6.2 Notificacion a Supervisores (Email)
- [ ] Crear template HTML de resumen
- [ ] Incluir:
  - Score promedio del equipo
  - Top 3 performers
  - Agentes que requieren atencion
  - Link al dashboard
- [ ] Enviar a las 08:15 (despues de procesar)

#### 6.3 Casos Especiales
- [ ] Email a agente nuevo (< 30 dias)
- [ ] Email a agente en bottom 10%
- [ ] Alerta a supervisor si agente con racha negativa > 3

---

### Fase 7: Testing (Dia 4)

#### 7.1 Tests de Calculo de Metricas
- [ ] Test: Calcular score promedio correcto
- [ ] Test: Calcular tasa validacion correcta
- [ ] Test: Ranking se calcula bien con empates
- [ ] Test: Tendencia detecta mejora/caida

#### 7.2 Tests de Analisis LLM
- [ ] Test: Prompt se construye correctamente
- [ ] Test: Respuesta se parsea correctamente
- [ ] Test: Validacion rechaza fortalezas < 3
- [ ] Test: Mensaje motivacional cumple limites

#### 7.3 Tests de Integracion
- [ ] Test E2E: Agente mejorando
  - Input: Agente con score subiendo
  - Expected: Tendencia "mejorando", mensaje celebratorio
- [ ] Test E2E: Agente empeorando
  - Input: Agente con score bajando
  - Expected: Tendencia "empeorando", mensaje de apoyo
- [ ] Test E2E: Agente nuevo
  - Input: Agente con 10 dias
  - Expected: Mensaje de bienvenida, objetivos basicos

#### 7.4 Tests de Notificaciones
- [ ] Test: Agente recibe notificacion in-app
- [ ] Test: Supervisor recibe email con resumen
- [ ] Test: Email contiene datos correctos del equipo

#### 7.5 Tests de Performance
- [ ] Procesar 10 agentes en < 2 min
- [ ] Procesar 50 agentes en < 5 min
- [ ] LLM no excede timeout de 60s

---

## Procesamiento en Paralelo

```javascript
// Configuracion de paralelismo
const CONFIG = {
  max_concurrent_agents: 5,      // Max agentes procesando LLM simultaneo
  batch_size: 5,                 // Agentes por batch
  delay_between_batches: 1000,   // 1s entre batches
  llm_timeout: 60000,            // 60s timeout por agente
  total_timeout: 900000          // 15 min timeout total
};
```

---

## Riesgos y Mitigaciones

| Riesgo | Probabilidad | Impacto | Mitigacion |
|--------|--------------|---------|------------|
| Claude timeout | Media | Alto | Retry + skip si falla |
| Agente sin datos | Alta | Bajo | Validar minimo 5 llamadas |
| Reporte duplicado | Baja | Medio | Verificar fecha antes de INSERT |
| LLM genera JSON invalido | Media | Medio | Validacion estricta + retry |
| Cron no ejecuta | Baja | Alto | Alerta si no hay reportes a 09:00 |

---

## Metricas de Exito

| Metrica | Target | Critico |
|---------|--------|---------|
| Tiempo total (50 agentes) | < 5 min | > 15 min |
| Tiempo por agente | < 10s | > 30s |
| Tasa de exito | > 98% | < 90% |
| Errores LLM | < 5% | > 15% |
| Reportes generados | 100% agentes activos | < 90% |

---

## Cronograma

```
Dia 1 (Manana):  Preparacion + Schema
Dia 1 (Tarde):   Obtencion de datos
Dia 2 (Manana):  Calculo de metricas
Dia 2 (Tarde):   Analisis con LLM
Dia 3 (Manana):  Persistencia
Dia 3 (Tarde):   Notificaciones
Dia 4:           Testing completo
```

---

## Criterios de Aceptacion

1. El cron se ejecuta todos los dias a las 08:00 sin fallos
2. Cada agente activo (> 7 dias, > 5 llamadas) recibe un reporte
3. El reporte contiene exactamente 3 fortalezas
4. El gap critico es relevante y accionable
5. El plan de mejora tiene maximo 3 acciones especificas
6. El mensaje motivacional es personalizado segun tendencia
7. Los supervisores reciben resumen del equipo por email
8. Los agentes ven notificacion in-app con su reporte
9. El tiempo total de procesamiento es < 5 minutos para 50 agentes
10. La tasa de exito es > 98%

---

## Dependencias con Otros Agentes

| Agente | Dependencia | Tipo |
|--------|-------------|------|
| Analista | Datos de analisis_llamadas | Requerido |
| Detector | Alertas en alertas_anomalias | Opcional |
| Estratega | Consume reportes de coaching | Downstream |
| Conversacional | Consulta reportes | Downstream |
</file>

<file path="docs/ag4_coach/prompt_analisis_agente.md">
# Prompt: Analisis de Desempeno del Agente

## Modelo
- **LLM**: Claude Opus 4.5 (`claude-opus-4-5-20250514`)
- **Temperature**: 0.4
- **Max Tokens**: 3000

---

## PROMPT

```
Eres un coach experto en cobranzas telefonicas con mas de 15 anos de experiencia. Tu trabajo es analizar el desempeno de un agente y generar un reporte de coaching personalizado, constructivo y accionable.

## PRINCIPIOS DE COACHING
1. Enfocate primero en las fortalezas (refuerzo positivo)
2. Identifica UN solo gap critico (enfoque)
3. Las acciones deben ser especificas y medibles
4. El tono debe ser motivador pero honesto
5. Considera el contexto (antig√ºedad, equipo, tendencia)

## DATOS DEL AGENTE

### Informacion Basica
- Nombre: {{agente_nombre}}
- Equipo: {{equipo}}
- Dias activo: {{dias_activo}}
- Estado: {{estado}}

### Metricas del Periodo (ultimos {{dias_periodo}} dias)
{{metricas_json}}

### Comparativa con Equipo
{{comparativa_json}}

### Reporte de Coaching Anterior
{{reporte_anterior_json}}
// null si es el primer reporte

### Alertas Recientes
{{alertas_json}}

### Muestra de Llamadas (3 mejores, 3 peores)
{{muestra_llamadas_json}}

## TAREA

Genera un reporte de coaching completo en formato JSON.

## REGLAS DE NEGOCIO

### Seleccion de GAP Critico (prioridad)
1. Validacion explicita < 30% -> "validacion_compromiso"
2. Tasa abandono > 15% -> "retencion_cliente"
3. Score compromiso < 50 -> "tecnicas_cierre"
4. Score contacto < 60 -> "presentacion_deuda"
5. Probabilidad cumplimiento < 40% -> "efectividad_general"

### Generacion de Mensaje Motivacional
- Mejorando + Top 25%: Celebracion + Desafio ambicioso
- Mejorando + Bottom 50%: Reconocimiento del esfuerzo + Animo
- Estable: Mantenimiento + Nuevo objetivo
- Empeorando: Empatia + Plan concreto + Apoyo

### Fortalezas
- Identifica EXACTAMENTE 3 fortalezas
- Cada fortaleza debe tener evidencia concreta de los datos
- Prioriza areas donde el agente supera al equipo

### Plan de Mejora
- Maximo 3 acciones
- Cada accion debe ser especifica (que, cuando, como)
- Incluir al menos un recurso sugerido

## FORMATO DE RESPUESTA (JSON)

{
  "fortalezas": [
    {
      "area": "nombre_del_area",
      "descripcion": "Descripcion clara de la fortaleza",
      "evidencia": "Dato concreto que la respalda"
    }
  ],
  
  "gap_critico": {
    "area": "nombre_del_area",
    "descripcion": "Descripcion del problema",
    "impacto": "Como afecta los resultados",
    "benchmark_equipo": "Comparacion con el equipo",
    "ejemplo_llamada": "analisis_id de una llamada que ejemplifica el problema"
  },
  
  "plan_mejora": {
    "objetivo_semanal": "Objetivo SMART para la semana",
    "acciones": [
      {
        "accion": "Descripcion detallada de la accion",
        "cuando": "Momento especifico para aplicarla",
        "prioridad": "alta" | "media" | "baja"
      }
    ],
    "recursos_sugeridos": [
      "Recurso 1",
      "Recurso 2"
    ]
  },
  
  "progreso_objetivo_anterior": {
    "objetivo_anterior": "El objetivo del reporte pasado",
    "resultado": "cumplido" | "parcial" | "no_cumplido" | "sin_objetivo_previo",
    "valor_logrado": "Valor alcanzado",
    "nota": "Comentario sobre el progreso"
  },
  
  "mensaje_motivacional": "Mensaje personalizado de 2-3 oraciones",
  
  "metricas_destacadas": {
    "mejor_metrica": {
      "nombre": "nombre",
      "valor": "valor",
      "vs_equipo": "+X%"
    },
    "metrica_mejorar": {
      "nombre": "nombre",
      "valor": "valor",
      "vs_equipo": "-X%"
    }
  },
  
  "recomendacion_supervisor": "Nota breve para el supervisor sobre como apoyar a este agente"
}
```

---

## Variables a Inyectar

| Variable | Fuente | Ejemplo |
|----------|--------|---------|
| `{{agente_nombre}}` | agentes.nombre | "Maria Garcia" |
| `{{equipo}}` | agentes.equipo | "Equipo Norte" |
| `{{dias_activo}}` | Calculado | 120 |
| `{{estado}}` | agentes.estado | "activo" |
| `{{dias_periodo}}` | Configuracion | 7 |
| `{{metricas_json}}` | Calculado | Ver abajo |
| `{{comparativa_json}}` | Calculado | Ver abajo |
| `{{reporte_anterior_json}}` | coaching_reports | null o JSON |
| `{{alertas_json}}` | alertas_anomalias | [...] |
| `{{muestra_llamadas_json}}` | analisis_llamadas | [...] |

---

## Ejemplo de metricas_json

```json
{
  "score_promedio": 72,
  "score_contacto_promedio": 78,
  "score_compromiso_promedio": 66,
  "tasa_validacion_explicita": 0.18,
  "tasa_validacion_total": 0.45,
  "tasa_abandono": 0.08,
  "probabilidad_cumplimiento_promedio": 58,
  "total_llamadas": 25,
  "llamadas_con_compromiso": 18,
  "monto_total_comprometido": 2450000,
  "distribucion_scores": {
    "excelente_80_100": 6,
    "bueno_60_79": 12,
    "regular_40_59": 5,
    "bajo_0_39": 2
  },
  "tendencia_vs_semana_anterior": "+5"
}
```

---

## Ejemplo de comparativa_json

```json
{
  "score_promedio_equipo": 78,
  "tasa_validacion_equipo": 0.42,
  "ranking": 8,
  "total_agentes": 12,
  "percentil": 65,
  "top_performer_score": 92,
  "bottom_performer_score": 45
}
```

---

## Ejemplo de muestra_llamadas_json

```json
{
  "mejores": [
    {
      "analisis_id": "uuid1",
      "fecha": "2026-02-02",
      "score_total": 92,
      "validacion": "explicita",
      "monto_comprometido": 150000
    }
  ],
  "peores": [
    {
      "analisis_id": "uuid4",
      "fecha": "2026-02-01",
      "score_total": 35,
      "validacion": "ninguna",
      "razon_bajo_score": "Abandono por cliente, sin oferta"
    }
  ]
}
```

---

## Validaciones del Output

1. `fortalezas` debe tener exactamente 3 elementos
2. `gap_critico.area` debe ser uno de los valores permitidos
3. `plan_mejora.acciones` debe tener maximo 3 elementos
4. `mensaje_motivacional` debe tener entre 50 y 300 caracteres
5. Si `reporte_anterior_json` es null, `progreso_objetivo_anterior.resultado` debe ser "sin_objetivo_previo"
</file>

<file path="docs/ag4_coach/README.md">
# Agente #4: Coach

## Vision General

El Agente Coach genera reportes de coaching personalizados para cada agente de cobranza. Analiza metricas, compara con el equipo, identifica gaps y crea planes de mejora accionables.

**Enfoque:** La logica de obtencion de datos esta en **funciones SQL de Supabase**, y el analisis cualitativo se hace con **Claude Opus**.

---

## Arquitectura

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      SUPABASE                                ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ obtener_agentes_para_coaching(dias, min)             ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ obtener_datos_coaching(agente_id, dias) -> JSONB     ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ obtener_metricas_agente(id, dias)                    ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ obtener_benchmark_equipo(equipo, dias)               ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ obtener_ranking_agente(id, equipo, dias)             ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ obtener_reporte_anterior(id)                         ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ obtener_alertas_agente(id, dias)                     ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ obtener_muestra_llamadas(id, dias, n)                ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
        Cron 08:00 AM ‚îÇ 
                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    SATURN STUDIO                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ 1. SELECT obtener_agentes_para_coaching()            ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ 2. Loop: SELECT obtener_datos_coaching(id)           ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ 3. HTTP: POST Claude API (analisis cualitativo)      ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ 4. INSERT INTO coaching_reports                      ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ 5. Notificar (Slack si hay criticos)                 ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Funciones SQL de Supabase

| Funcion | Input | Output | Uso |
|---------|-------|--------|-----|
| `obtener_agentes_para_coaching` | dias, min_llamadas | Lista de agentes | Paso 1 |
| `obtener_datos_coaching` | agente_id, dias | **JSONB completo** | **Principal** |
| `obtener_metricas_agente` | agente_id, dias | Metricas periodo | Interno |
| `obtener_benchmark_equipo` | equipo, dias | Promedios equipo | Interno |
| `obtener_ranking_agente` | id, equipo, dias | Posicion/percentil | Interno |
| `obtener_reporte_anterior` | agente_id | Ultimo reporte | Tendencia |
| `obtener_alertas_agente` | agente_id, dias | Alertas periodo | Contexto |
| `obtener_muestra_llamadas` | id, dias, n | Mejores/peores | LLM |

**Archivo:** `supabase/functions/coach_functions.sql`

---

## Uso Rapido

### Obtener agentes listos para coaching

```sql
SELECT * FROM obtener_agentes_para_coaching(7, 5);
```

### Obtener todos los datos para el LLM

```sql
SELECT obtener_datos_coaching('11111111-1111-1111-1111-111111111111', 7);
```

Retorna un **JSONB completo** con:
- Datos del agente
- Metricas del periodo (score, validacion, abandono, etc.)
- Benchmark del equipo
- Ranking y percentil
- Reporte anterior (si existe)
- Tendencia (mejorando/empeorando/estable)
- Alertas recientes
- Muestra de mejores/peores llamadas

---

## Output de obtener_datos_coaching()

```json
{
  "agente": {
    "agente_id": "uuid",
    "nombre": "Maria Lopez",
    "equipo": "Equipo Norte",
    "dias_activo": 1116
  },
  "metricas": {
    "total_llamadas": 12,
    "score_promedio": 82.3,
    "tasa_validacion_explicita": 1.0,
    "tasa_abandono": 0.0,
    "distribucion": {
      "excelente_80_100": 8,
      "bueno_60_79": 4
    }
  },
  "benchmark_equipo": {
    "score_promedio": 73.9,
    "score_top": 82.3,
    "total_agentes": 2
  },
  "ranking": {
    "posicion": 1,
    "percentil": 50,
    "diferencia_vs_promedio": 8.4
  },
  "reporte_anterior": {
    "score_anterior": 78,
    "objetivo_cumplido": true
  },
  "tendencia": {
    "score_cambio": 4.3,
    "direccion": "mejorando"
  },
  "alertas": [],
  "muestra_llamadas": [...]
}
```

---

## Pipeline

```
1. obtener_agentes_para_coaching(7, 5)
   -> Lista de agentes con >= 5 llamadas en 7 dias

2. Para cada agente:
   obtener_datos_coaching(agente_id, 7)
   -> JSON con todas las metricas

3. Enviar JSON a Claude Opus
   -> Analisis cualitativo (fortalezas, gaps, plan)

4. INSERT INTO coaching_reports
   -> Metricas + Analisis LLM

5. Notificar si hay agentes criticos
```

---

## Tabla de Destino

**coaching_reports**
| Campo | Tipo | Fuente |
|-------|------|--------|
| agente_id | UUID | SQL |
| fecha_reporte | DATE | CURRENT_DATE |
| periodo_inicio/fin | DATE | obtener_datos_coaching |
| total_llamadas_analizadas | INT | obtener_datos_coaching |
| metricas_periodo | JSONB | obtener_datos_coaching |
| comparativa_equipo | JSONB | obtener_datos_coaching |
| fortalezas | JSONB | LLM |
| gap_critico | JSONB | LLM |
| plan_mejora | JSONB | LLM |
| progreso_vs_anterior | JSONB | LLM |

---

## Estructura de Archivos

```
docs/ag4_coach/
‚îú‚îÄ‚îÄ README.md                    # Este archivo
‚îú‚îÄ‚îÄ prompt_analisis_agente.md    # Prompt para Claude
‚îú‚îÄ‚îÄ templates_mensajes.md        # Mensajes motivacionales
‚îú‚îÄ‚îÄ input_ejemplo.json           # Ejemplo de datos
‚îú‚îÄ‚îÄ output_ejemplo.json          # Ejemplo de reporte
‚îú‚îÄ‚îÄ flujo_completo.md            # E2E con queries
‚îú‚îÄ‚îÄ insert_supabase.md           # SQL de insercion
‚îî‚îÄ‚îÄ plan_implementacion.md       # Checklist

supabase/functions/
‚îî‚îÄ‚îÄ coach_functions.sql          # Funciones SQL completas
```

---

## Ventajas de este Enfoque

1. **Una sola funcion obtiene todo:** `obtener_datos_coaching()` retorna un JSONB completo listo para el LLM
2. **Logica en SQL:** Calculos de metricas, rankings y comparativas se hacen en la base de datos
3. **LLM solo para analisis cualitativo:** Claude recibe datos estructurados y genera insights
4. **Testeable:** Puedes ejecutar las funciones manualmente para verificar datos
5. **Eficiente:** Reduce round-trips a la base de datos

---

## Tiempo de Implementacion

| Fase | Tiempo |
|------|--------|
| Crear funciones SQL | 2-3h |
| Configurar Saturn Studio | 2-3h |
| Crear prompt LLM | 1-2h |
| Testing | 2-3h |
| **Total** | **1-1.5 dias** |
</file>

<file path="docs/ag4_coach/templates_mensajes.md">
# Templates de Mensajes Motivacionales

## Categorias de Mensajes

Los mensajes motivacionales se seleccionan basandose en:
1. **Tendencia**: mejorando / estable / empeorando
2. **Posicion en equipo**: top25 / medio / bottom25
3. **Antig√ºedad**: nuevo (<30 dias) / establecido

---

## 1. Mejorando + Top 25%

**Contexto**: Agente de alto rendimiento que sigue mejorando

```
¬°Excelente trabajo, {{nombre}}! Tu dedicacion esta dando frutos: pasaste del puesto {{ranking_anterior}} al {{ranking_actual}} en el equipo. Tu score de {{score}} te pone entre los mejores. Esta semana, el desafio es alcanzar el 90: ¬°sabemos que puedes!
```

```
{{nombre}}, eres un ejemplo para el equipo. Tu mejora del {{porcentaje_mejora}}% demuestra que el esfuerzo constante funciona. Ahora que dominas lo basico, enfocate en {{gap_critico}} para llegar al siguiente nivel. ¬°El top 3 esta a tu alcance!
```

```
Felicitaciones {{nombre}}: {{total_llamadas}} llamadas esta semana con un score promedio de {{score}}. Tu consistencia es admirable. El siguiente paso es convertir esas validaciones implicitas en explicitas. ¬°Un pequeno ajuste para resultados grandes!
```

---

## 2. Mejorando + Medio (26-75%)

**Contexto**: Agente en progreso, necesita mantenimiento

```
{{nombre}}, tu progreso es notable: +{{puntos_mejora}} puntos vs la semana pasada. Estas en el camino correcto. Esta semana, enfocate en {{gap_critico}} y veras como subes mas posiciones. ¬°Sigue asi!
```

```
Buen trabajo {{nombre}}. Pasaste de {{score_anterior}} a {{score_actual}}, eso es mejora real. Tu fortaleza en {{fortaleza_principal}} es clara. Ahora, si trabajas en {{gap_critico}}, podras alcanzar el top 5. ¬°Animo!
```

```
{{nombre}}, estas mejorando y se nota. Esta semana lograste {{logro_especifico}}. Mant√©n el foco en {{gap_critico}} y la proxima semana hablaremos de tus nuevos exitos. ¬°T√∫ puedes!
```

---

## 3. Mejorando + Bottom 25%

**Contexto**: Agente que estaba bajo pero esta subiendo

```
{{nombre}}, lo importante no es donde empezaste sino hacia donde vas. Tu mejora del {{porcentaje_mejora}}% esta semana demuestra que tienes lo que se necesita. Sigue enfocado en {{gap_critico}} y pronto dejaras de ser parte del bottom. ¬°Estamos contigo!
```

```
¬°Vamos {{nombre}}! Subiste {{puntos_mejora}} puntos esta semana. Cada llamada es una oportunidad de mejorar y la estas aprovechando. Tu {{fortaleza_principal}} es solida, ahora trabaja en {{gap_critico}}. ¬°No te rindas!
```

```
{{nombre}}, reconocemos tu esfuerzo. Pasar de {{score_anterior}} a {{score_actual}} no es facil, pero lo lograste. Esta semana enfocate SOLO en {{accion_principal}}. Un paso a la vez. ¬°Vamos que se puede!
```

---

## 4. Estable + Cualquier Posicion

**Contexto**: Agente sin cambios significativos

```
{{nombre}}, tu consistencia es valiosa: mantuviste tu score en {{score}} esta semana. Ahora es momento de dar el siguiente paso. Tu nuevo objetivo: {{objetivo_semanal}}. ¬°Es hora de crecer!
```

```
Semana estable {{nombre}}, y eso esta bien. Pero estable no significa estancado. Esta semana, te propongo un desafio: mejorar tu {{gap_critico}} en un 10%. ¬øAceptas?
```

```
{{nombre}}, mantienes un buen ritmo con {{score}} de promedio. Para subir al siguiente nivel, enfocate esta semana en {{gap_critico}}. A veces un pequeno cambio hace una gran diferencia.
```

---

## 5. Empeorando + Top 50%

**Contexto**: Agente bueno que tuvo una mala semana

```
{{nombre}}, sabemos que esta semana fue dificil. Tu score bajo de {{score_anterior}} a {{score_actual}}, pero tu historial demuestra que esto es solo un bache. Revisemos juntos que paso y recuperemos el ritmo. ¬°Confio en ti!
```

```
Una semana complicada {{nombre}}, pero no te defines por una mala semana. Tu promedio historico es {{score_historico}}, muy superior al actual. Identifiquemos que cambio y volvamos a la normalidad. ¬øEstres? ¬øCartera dificil? Hablemos.
```

```
{{nombre}}, todos tenemos semanas dificiles. Lo importante es no quedarnos ahi. Esta semana enfocate en lo basico: {{accion_basica}}. Volveras a tu nivel, estoy seguro.
```

---

## 6. Empeorando + Bottom 50%

**Contexto**: Agente que necesita apoyo urgente

```
{{nombre}}, veo que las cosas no estan siendo faciles. Quiero que sepas que estamos aqui para ayudarte. Esta semana, olvidemos los numeros y enfoquemonos en UNA cosa: {{accion_principal}}. Paso a paso.
```

```
{{nombre}}, se que puede ser frustrante ver los numeros bajar. Pero cada dia es una nueva oportunidad. Esta semana tu unico objetivo es: {{objetivo_simple}}. Solo eso. Cuentas con nuestro apoyo.
```

```
{{nombre}}, hablemos claro: necesitas apoyo y lo vas a tener. Tu supervisor esta al tanto y te acompanara de cerca esta semana. Enfocate en {{accion_principal}} y no te preocupes por el resto. Juntos salimos de esto.
```

---

## 7. Agente Nuevo (<30 dias)

**Contexto**: Agente en curva de aprendizaje

```
{{nombre}}, llevas {{dias_activo}} dias y ya muestras potencial. Tu score de {{score}} esta dentro de lo esperado para un agente nuevo. Esta semana, enfocate en dominar {{habilidad_basica}}. ¬°El crecimiento viene con la practica!
```

```
¬°Bienvenido al equipo {{nombre}}! {{dias_activo}} dias y ya tienes {{llamadas}} llamadas completadas. Tu fortaleza en {{fortaleza_principal}} es prometedora. Esta semana, trabaja en {{gap_critico}} con calma. Estamos para guiarte.
```

```
{{nombre}}, ser nuevo puede ser abrumador, pero lo estas haciendo bien. No te compares con agentes de 6 meses. Tu progreso es lo que importa. Esta semana: {{objetivo_simple}}. ¬°Vamos!
```

---

## Funcion de Seleccion

```javascript
function seleccionarTemplate(agente, metricas, reporteAnterior) {
  const tendencia = calcularTendencia(metricas, reporteAnterior);
  const posicion = calcularPosicion(metricas.ranking, metricas.total_agentes);
  const esNuevo = agente.dias_activo < 30;
  
  if (esNuevo) {
    return templates.agente_nuevo;
  }
  
  if (tendencia === 'mejorando') {
    if (posicion === 'top25') return templates.mejorando_top;
    if (posicion === 'medio') return templates.mejorando_medio;
    return templates.mejorando_bottom;
  }
  
  if (tendencia === 'estable') {
    return templates.estable;
  }
  
  if (tendencia === 'empeorando') {
    if (posicion === 'top50') return templates.empeorando_top;
    return templates.empeorando_bottom;
  }
}

function calcularTendencia(metricas, reporteAnterior) {
  if (!reporteAnterior) return 'estable';
  
  const diff = metricas.score_promedio - reporteAnterior.metricas_periodo.score_promedio;
  
  if (diff > 3) return 'mejorando';
  if (diff < -3) return 'empeorando';
  return 'estable';
}

function calcularPosicion(ranking, total) {
  const percentil = (1 - (ranking / total)) * 100;
  
  if (percentil >= 75) return 'top25';
  if (percentil >= 50) return 'medio';
  if (percentil >= 25) return 'medio';
  return 'bottom25';
}
```

---

## Variables Disponibles para Templates

| Variable | Descripcion | Ejemplo |
|----------|-------------|---------|
| `{{nombre}}` | Nombre del agente | "Maria" |
| `{{score}}` | Score promedio actual | 72 |
| `{{score_anterior}}` | Score semana pasada | 68 |
| `{{ranking_actual}}` | Posicion en equipo | 5 |
| `{{ranking_anterior}}` | Posicion anterior | 7 |
| `{{total_llamadas}}` | Llamadas del periodo | 25 |
| `{{dias_activo}}` | Dias desde ingreso | 45 |
| `{{porcentaje_mejora}}` | % de mejora | 15 |
| `{{puntos_mejora}}` | Puntos ganados | 4 |
| `{{gap_critico}}` | Area a mejorar | "validacion" |
| `{{fortaleza_principal}}` | Mejor area | "rapport" |
| `{{objetivo_semanal}}` | Objetivo propuesto | "40% validacion" |
| `{{accion_principal}}` | Accion prioritaria | "cerrar con pregunta" |
</file>

<file path="docs/ag6_conversacional/flujo_saturn.md">
# Flujo Saturn Studio - Agente Conversacional

## Diagrama del Flujo

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  START  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   Receive   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ    Q&A      ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  Response   ‚îÇ
‚îÇ         ‚îÇ     ‚îÇ   Webhook   ‚îÇ     ‚îÇ   Agent     ‚îÇ     ‚îÇ  Webhook    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                           ‚îÇ
                                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                    ‚îÇ    Tool:    ‚îÇ
                                    ‚îÇ filterTable ‚îÇ
                                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## Configuracion de Nodos

### Nodo 1: Receive Webhook

**Tipo**: webhooks > getWebhook

**Configuracion**:
```json
{
  "module_name": "webhooks",
  "module": "getWebhook",
  "var_": "wh_in",
  "method": "POST",
  "mode": 2
}
```

**Variable de salida**: `wh_in`

**Contenido de wh_in**:
```json
{
  "id": "task-id-para-response",
  "message": "Como esta Maria Lopez?",
  "conversation_id": "conv-123",
  "history": [...],
  "context": {...}
}
```

---

### Nodo 2: Q&A Agent

**Tipo**: AI > questionAnswerAgent

**Configuracion**:
```json
{
  "tools": "[herramientas con filterTable]",
  "credential_ai": "tu-credential-id",
  "model": "gpt-4o-mini",
  "result": "var_agent_res",
  "temperature": "0.2",
  "max_tokens": "400",
  "top_p": "0.9",
  "frequency_penalty": "0.3"
}
```

**IMPORTANTE - Configuracion del Modelo:**
- **Temperature:** 0.2 (CRITICO - evita tool calls multiples)
- **Max Tokens:** 400 (respuestas concisas)
- **Frequency Penalty:** 0.3 (evita repeticion)

**System Prompt** (copiar exactamente desde `prompt_completo.md`):
```
# AGENTE CONVERSACIONAL NODUS

Eres el asistente del sistema NODUS (analisis de llamadas de cobranza).

**Mensaje del usuario:** {var_message}

---

## REGLA #1: MAXIMO 1 TOOL CALL

**CRITICO:** Haz **MAXIMO 1 llamada** a filterTable por respuesta.

[... resto del prompt desde prompt_completo.md ...]
```

**User Message Variable** (reemplazar en el prompt):
- Variable: `var_message` 
- Valor: `{wh_in.message}`

**NOTA:** El prompt completo se pasa en el System Message. El User Message solo contiene el mensaje del usuario actual.

**Variable de salida**: `var_agent_res`

---

### Nodo 3: Tool - Filter Table (Supabase)

**Tipo**: supabase > filterTable

**Configuracion**:
```json
{
  "module_name": "supabase",
  "module": "filterTable",
  "result": "tbl",
  "credential": "tu-supabase-credential",
  "table_name": "${{$ai_tool_params}.table_name}",
  "filter_column": "${{$ai_tool_params}.filter_column}",
  "filter_value": "${{$ai_tool_params}.filter_value}"
}
```

**Variable de salida**: `tbl`

Este nodo se ejecuta cuando el Q&A Agent decide usar la herramienta.

---

### Nodo 4: Response Webhook

**Tipo**: webhooks > responseWebhook

**Configuracion**:
```json
{
  "module_name": "webhooks",
  "module": "responseWebhook",
  "result": "wh_out",
  "task_id": "${{wh_in}.id}"
}
```

**Body del Response** (configurar en Saturn):
```json
{
  "success": true,
  "response": {
    "message": "{var_agent_res.message}",
    "type": "{var_agent_res.type}",
    "data": "{var_agent_res.data}",
    "suggestions": "{var_agent_res.suggestions}"
  },
  "conversation_id": "{wh_in.conversation_id}",
  "timestamp": "{now}"
}
```

---

## Definicion de la Tool (filterTable)

**IMPORTANTE:** Esta descripcion es CRITICA para que el LLM no haga multiples llamadas.

### JSON Schema para Saturn Studio

```json
{
  "name": "filterTable",
  "description": "Consulta una tabla de Supabase con filtros opcionales. Devuelve array de objetos JSON. REGLA CRITICA: Solo llamar UNA VEZ por consulta del usuario - NO reintentar si el array esta vacio.",
  "parameters": {
    "type": "object",
    "properties": {
      "table_name": {
        "type": "string",
        "description": "Tabla a consultar",
        "enum": [
          "vista_resumen_agentes",
          "alertas_anomalias",
          "analisis_llamadas",
          "coaching_reports"
        ]
      },
      "filter_column": {
        "type": "string",
        "description": "Columna para filtrar. Dejar vacio ('') para obtener todos los registros.",
        "default": ""
      },
      "filter_value": {
        "type": "string",
        "description": "Valor del filtro. Dejar vacio ('') si filter_column esta vacio.",
        "default": ""
      }
    },
    "required": ["table_name"]
  }
}
```

### Puntos Clave de la Tool

1. **Description incluye "REGLA CRITICA"** - Esto ayuda al LLM a no reintentar
2. **enum en table_name** - Limita las opciones validas
3. **default en filter_column y filter_value** - Permite llamadas sin filtros
4. **Solo table_name es required** - Simplifica el uso

### Formato de Retorno Esperado

La tool **DEBE** devolver este formato:

```json
{
  "data": [
    { "nombre": "Maria Lopez", "score_semana": 78.5, ... }
  ],
  "count": 1
}
```

O si no hay datos:

```json
{
  "data": [],
  "count": 0
}
```

**NUNCA** devolver `null`, `undefined`, o lanzar error cuando no hay resultados.

---

## Conexiones del Flujo

```
START 
  ‚îî‚îÄ‚îÄ‚ñ∂ Receive Webhook (output_1)
         ‚îî‚îÄ‚îÄ‚ñ∂ Q&A Agent (input_1)
               ‚îú‚îÄ‚îÄ‚ñ∂ Response Webhook (output_1) [respuesta final]
               ‚îî‚îÄ‚îÄ‚ñ∂ Filter Table (output_2) [cuando usa tool]
```

---

## Variables del Flujo

| Variable | Descripcion | Ejemplo |
|----------|-------------|---------|
| `wh_in` | Payload del webhook entrante | `{message, history, ...}` |
| `wh_in.id` | Task ID para response | `"task-abc123"` |
| `var_agent_res` | Respuesta del Q&A Agent | `{message, data, ...}` |
| `ai_tool_params` | Parametros de la tool | `{table_name, filter_column, filter_value}` |
| `ai_tool_result` | Resultado de la tool | `{table: [...]}` |
| `tbl` | Alias del resultado | `{table: [...]}` |
| `wh_out` | Confirmacion del response | `{success: true}` |

---

## Webhook URL

Una vez desplegado el flujo en Saturn, obtendras una URL como:

```
https://saturn.rocketbot.com/webhook/AG006_livechat/abc123xyz
```

Esta URL se configura en el frontend para enviar los mensajes.
</file>

<file path="docs/ag6_conversacional/payload_estructura.md">
# Estructura de Payloads - Agente Conversacional

## 1. Request: Frontend ‚Üí Saturn (Webhook POST)

```json
{
  "message": "Como esta Maria Lopez esta semana?",
  "conversation_id": "conv-123456",
  "user_id": "supervisor-001",
  "timestamp": "2026-02-04T10:30:00Z",
  "history": [
    {
      "role": "user",
      "content": "Hola",
      "timestamp": "2026-02-04T10:28:00Z"
    },
    {
      "role": "assistant", 
      "content": "Hola! Soy el asistente de NODUS. En que puedo ayudarte?",
      "timestamp": "2026-02-04T10:28:05Z"
    }
  ],
  "context": {
    "current_page": "dashboard",
    "selected_agent_id": null,
    "date_range": {
      "from": "2026-01-28",
      "to": "2026-02-04"
    }
  }
}
```

### Campos del Request

| Campo | Tipo | Requerido | Descripcion |
|-------|------|-----------|-------------|
| `message` | string | Si | Mensaje actual del usuario |
| `conversation_id` | string | Si | ID unico de la conversacion |
| `user_id` | string | No | ID del usuario (supervisor/agente) |
| `timestamp` | string | Si | Timestamp ISO del mensaje |
| `history` | array | No | Historial de mensajes previos |
| `context` | object | No | Contexto adicional del frontend |

### Estructura del History

```json
{
  "role": "user" | "assistant",
  "content": "Texto del mensaje",
  "timestamp": "2026-02-04T10:28:00Z",
  "data": {} // Opcional: datos adjuntos de respuestas anteriores
}
```

---

## 2. Response: Saturn ‚Üí Frontend (Webhook Response)

### Respuesta Simple (solo texto)

```json
{
  "success": true,
  "response": {
    "message": "Maria Lopez tiene un score promedio de 82 esta semana, con 12 llamadas analizadas. Esta en el puesto #1 de su equipo con una tasa de validacion del 100%.",
    "type": "text"
  },
  "conversation_id": "conv-123456",
  "timestamp": "2026-02-04T10:30:02Z"
}
```

### Respuesta con Datos (tabla/metricas)

```json
{
  "success": true,
  "response": {
    "message": "Aqui estan las alertas criticas activas:",
    "type": "data",
    "data": {
      "type": "table",
      "title": "Alertas Criticas",
      "columns": ["ID", "Descripcion", "Agente", "Creada"],
      "rows": [
        ["ALT-001", "Score bajo en llamada", "Jose Perez", "Hace 2 horas"],
        ["ALT-002", "Abandono de llamada", "Ana Martinez", "Hace 4 horas"]
      ]
    },
    "suggestions": [
      "Ver detalle de la primera alerta",
      "Filtrar por agente",
      "Mostrar alertas de las ultimas 24 horas"
    ]
  },
  "conversation_id": "conv-123456",
  "timestamp": "2026-02-04T10:30:02Z"
}
```

### Respuesta con Metricas

```json
{
  "success": true,
  "response": {
    "message": "Estas son las metricas del equipo hoy:",
    "type": "metrics",
    "data": {
      "type": "metrics",
      "items": [
        { "label": "Score Promedio", "value": "72", "change": "+5", "trend": "up" },
        { "label": "Llamadas", "value": "127", "change": "+12", "trend": "up" },
        { "label": "Validacion", "value": "52%", "change": "-3", "trend": "down" },
        { "label": "Alertas", "value": "3", "change": "0", "trend": "stable" }
      ]
    }
  },
  "conversation_id": "conv-123456",
  "timestamp": "2026-02-04T10:30:02Z"
}
```

### Respuesta con Grafico

```json
{
  "success": true,
  "response": {
    "message": "Tendencia del score en los ultimos 7 dias:",
    "type": "chart",
    "data": {
      "type": "line",
      "title": "Score Semanal",
      "labels": ["Lun", "Mar", "Mie", "Jue", "Vie", "Sab", "Dom"],
      "datasets": [
        {
          "label": "Score",
          "data": [68, 71, 75, 73, 72, 74, 72]
        }
      ]
    }
  },
  "conversation_id": "conv-123456",
  "timestamp": "2026-02-04T10:30:02Z"
}
```

### Respuesta de Error

```json
{
  "success": false,
  "error": {
    "code": "QUERY_FAILED",
    "message": "No se pudo consultar la base de datos"
  },
  "response": {
    "message": "Lo siento, hubo un problema al consultar los datos. Por favor intenta de nuevo.",
    "type": "error"
  },
  "conversation_id": "conv-123456",
  "timestamp": "2026-02-04T10:30:02Z"
}
```

---

## 3. Tipos de Respuesta

| Type | Descripcion | Renderizado Frontend |
|------|-------------|---------------------|
| `text` | Solo texto | Mensaje simple |
| `data` | Datos estructurados | Tabla con columnas |
| `metrics` | KPIs | Tarjetas de metricas |
| `chart` | Grafico | Chart (linea, barra) |
| `agent_card` | Info de agente | Tarjeta de perfil |
| `error` | Error | Mensaje de error |

---

## 4. Variables en Saturn

### Variables de Entrada (wh_in)
```
{wh_in} = payload completo del webhook
{wh_in.message} = mensaje del usuario
{wh_in.history} = historial de conversacion
{wh_in.conversation_id} = ID de conversacion
```

### Variables de Salida (var_agent_res)
```
{var_agent_res} = respuesta del Q&A Agent
{var_agent_res.message} = texto de respuesta
{var_agent_res.data} = datos estructurados (si hay)
```

### Variable de Tool Result
```
{ai_tool_result} = resultado de filterTable
{ai_tool_result.table} = array de filas
```
</file>

<file path="docs/ag6_conversacional/plan_implementacion.md">
# Plan de Implementacion - Agente Conversacional

## Resumen

| Componente | Tecnologia | Tiempo Estimado |
|------------|------------|-----------------|
| Flujo Saturn | Saturn Studio | 1-2 horas |
| Prompt Q&A Agent | Texto | 30 min |
| Frontend Chat | React + TypeScript | 2-3 horas |
| Integracion Webhook | Fetch API | 1 hora |
| **Total** | | **5-6 horas** |

---

## Fase 1: Configurar Flujo en Saturn Studio

### Paso 1.1: Crear nuevo flujo
- [ ] Crear flujo "AG006_livechat"
- [ ] Agregar nodo: Receive Webhook (POST)
- [ ] Configurar variable de salida: `wh_in`

### Paso 1.2: Configurar Q&A Agent
- [ ] Agregar nodo: Q&A Agent
- [ ] Seleccionar modelo: `gpt-4o-mini` o `gpt-4o`
- [ ] Configurar temperatura: `0.7`
- [ ] Pegar System Prompt completo (de prompt_completo.md)
- [ ] Configurar User Message con variables: `{wh_in.message}`, `{wh_in.history}`
- [ ] Variable de salida: `var_agent_res`

### Paso 1.3: Agregar Tool (filterTable)
- [ ] Agregar nodo: supabase > filterTable
- [ ] Conectar credencial de Supabase
- [ ] Configurar parametros dinamicos:
  - table_name: `${{$ai_tool_params}.table_name}`
  - filter_column: `${{$ai_tool_params}.filter_column}`
  - filter_value: `${{$ai_tool_params}.filter_value}`
- [ ] Conectar output_2 del Q&A Agent a este nodo

### Paso 1.4: Response Webhook
- [ ] Agregar nodo: Response Webhook
- [ ] Configurar task_id: `${{wh_in}.id}`
- [ ] Configurar body de respuesta con `{var_agent_res}`

### Paso 1.5: Conectar y probar
- [ ] Conectar todos los nodos
- [ ] Publicar flujo
- [ ] Obtener URL del webhook
- [ ] Probar con Postman/curl

---

## Fase 2: Actualizar Frontend

### Paso 2.1: Crear servicio de chat
- [ ] Crear `src/services/chatService.ts`
- [ ] Implementar funcion `sendMessage()`
- [ ] Manejar timeout y reintentos

### Paso 2.2: Crear store de chat
- [ ] Crear `src/stores/chatStore.ts`
- [ ] Estado: messages, loading, error
- [ ] Acciones: sendMessage, clearChat

### Paso 2.3: Actualizar Chat.tsx
- [ ] Integrar chatStore
- [ ] Implementar indicador de typing
- [ ] Renderizar diferentes tipos de respuesta
- [ ] Agregar sugerencias clickeables

### Paso 2.4: Componentes auxiliares
- [ ] ChatMessage (texto, data, error)
- [ ] ChatMetrics (tarjetas de KPIs)
- [ ] ChatTable (tabla de datos)
- [ ] TypingIndicator (dots animados)

---

## Fase 3: Testing

### Paso 3.1: Pruebas del flujo
- [ ] Pregunta simple: "Hola"
- [ ] Consulta de agente: "Como esta Maria Lopez?"
- [ ] Consulta de alertas: "Hay alertas criticas?"
- [ ] Consulta de metricas: "Cual es el score promedio?"
- [ ] Pregunta fuera de scope: "Cual es la capital de Francia?"

### Paso 3.2: Pruebas de frontend
- [ ] Envio de mensaje
- [ ] Indicador de typing visible
- [ ] Respuesta renderizada correctamente
- [ ] Historial persistido
- [ ] Manejo de errores

---

## Archivos a Crear/Modificar

### Nuevos Archivos

```
src/
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ chatService.ts       # Servicio para webhook
‚îú‚îÄ‚îÄ stores/
‚îÇ   ‚îî‚îÄ‚îÄ chatStore.ts         # Estado del chat
‚îî‚îÄ‚îÄ components/
    ‚îî‚îÄ‚îÄ chat/
        ‚îú‚îÄ‚îÄ ChatMessage.tsx  # Componente de mensaje
        ‚îú‚îÄ‚îÄ ChatInput.tsx    # Input con boton
        ‚îú‚îÄ‚îÄ TypingIndicator.tsx
        ‚îî‚îÄ‚îÄ ChatDataCard.tsx # Renderizado de datos
```

### Archivos a Modificar

```
src/
‚îî‚îÄ‚îÄ pages/
    ‚îî‚îÄ‚îÄ Chat.tsx             # Integracion completa
```

---

## Configuracion de Variables de Entorno

Agregar al `.env`:

```env
VITE_SATURN_WEBHOOK_URL=https://saturn.rocketbot.com/webhook/AG006_livechat/xxx
```

---

## Codigo de Referencia

### chatService.ts

```typescript
const WEBHOOK_URL = import.meta.env.VITE_SATURN_WEBHOOK_URL

interface ChatRequest {
  message: string
  conversation_id: string
  history: ChatMessage[]
  context?: Record<string, unknown>
}

interface ChatResponse {
  success: boolean
  response: {
    message: string
    type: 'text' | 'data' | 'metrics' | 'chart' | 'error'
    data?: unknown
    suggestions?: string[]
  }
  conversation_id: string
  timestamp: string
}

export async function sendChatMessage(request: ChatRequest): Promise<ChatResponse> {
  const response = await fetch(WEBHOOK_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      ...request,
      timestamp: new Date().toISOString()
    })
  })

  if (!response.ok) {
    throw new Error('Error al enviar mensaje')
  }

  return response.json()
}
```

### TypingIndicator.tsx

```typescript
export function TypingIndicator() {
  return (
    <div className="flex items-center gap-1 p-3">
      <div className="w-2 h-2 bg-primary/60 rounded-full animate-bounce" style={{ animationDelay: '0ms' }} />
      <div className="w-2 h-2 bg-primary/60 rounded-full animate-bounce" style={{ animationDelay: '150ms' }} />
      <div className="w-2 h-2 bg-primary/60 rounded-full animate-bounce" style={{ animationDelay: '300ms' }} />
    </div>
  )
}
```

---

## Checklist Final

- [ ] Flujo Saturn publicado y URL obtenida
- [ ] Variable de entorno configurada en frontend
- [ ] Chat.tsx integrado con webhook
- [ ] Typing indicator funcionando
- [ ] Respuestas renderizadas correctamente
- [ ] Historial de conversacion persistido
- [ ] Manejo de errores implementado
- [ ] Pruebas completas realizadas
</file>

<file path="docs/ag6_conversacional/prompt_completo.md">
# Prompt Completo - Agente Conversacional NODUS

## Prompt para Q&A Agent en Saturn Studio

Copia esto exactamente en el System Prompt del Q&A Agent:

---

# AGENTE CONVERSACIONAL NODUS

Eres el asistente del sistema NODUS (analisis de llamadas de cobranza).

**Mensaje del usuario:** ${{wh_in}.body.message}

---

## REGLA #1: MAXIMO 1 TOOL CALL

**CRITICO:** Haz **MAXIMO 1 llamada** a filterTable por respuesta.

- Llama a filterTable una vez
- Espera el resultado
- Responde con ese resultado
- **NUNCA** reintentes la misma llamada
- **NUNCA** hagas llamadas multiples

Si no hay datos, di "No encontre datos" y sugiere alternativas.

---

## REGLA #2: CUANDO USAR filterTable

**USA filterTable solo si el usuario pide datos especificos:**

| Pregunta | Usar Tool? | Razon |
|----------|-----------|-------|
| "Hola" | **NO** | Es saludo |
| "Que puedes hacer?" | **NO** | Pregunta general |
| "Gracias" | **NO** | Cortesia |
| "Como esta Maria Lopez?" | **SI** | Pide datos de agente |
| "Hay alertas?" | **SI** | Pide datos de alertas |
| "Score del equipo?" | **SI** | Pide metrica |

**Si dudas:** NO uses filterTable.

---

## COMO RESPONDER

### PASO 1: Analiza el mensaje
- Es saludo/cortesia? Responde directamente (NO tool)
- Pide datos especificos? Usa filterTable (1 sola vez)

### PASO 2: Si usas filterTable
1. Haz **1 llamada** con los parametros correctos
2. **ESPERA** el resultado
3. Si devuelve datos, presenta los datos al usuario
4. Si NO devuelve datos, di "No encontre datos para [lo que pidio]"
5. **DETENTE** - No hagas mas llamadas

### PASO 3: Formato de respuesta

Responde SIEMPRE en este formato JSON exacto:

{"message": "Tu respuesta clara y concisa", "suggestions": ["Sugerencia 1", "Sugerencia 2", "Sugerencia 3"]}

---

## HERRAMIENTA: filterTable

**Descripcion:** Consulta una tabla de Supabase con filtros opcionales.

**Parametros:**
- table_name (string, REQUERIDO): Nombre de la tabla
- filter_column (string, OPCIONAL): Columna para filtrar (vacio = sin filtro)
- filter_value (string, OPCIONAL): Valor del filtro

**Tablas disponibles:**

1. **vista_resumen_agentes** - Usa esta para consultas de agentes
   Columnas: nombre, equipo, llamadas_semana, score_semana, prob_cumplimiento_semana

2. **alertas_anomalias** - Usa esta para alertas
   Columnas: tipo, severidad, codigo, descripcion, estado, created_at

3. **analisis_llamadas** - Usa esta para analisis
   Columnas: score_total, probabilidad_cumplimiento, fecha_llamada

4. **coaching_reports** - Usa esta para coaching
   Columnas: fecha_reporte, metricas_periodo, gap_critico, plan_mejora

**IMPORTANTE:** Llama a filterTable **SOLO UNA VEZ** por respuesta.

---

## EJEMPLOS COMPLETOS

### Ejemplo 1: Saludo (SIN TOOL)

Usuario: "Hola"

Respuesta (SIN llamar a filterTable):
{"message": "Hola! Soy el asistente de NODUS. Puedo consultar datos de agentes, alertas, metricas y reportes. Que necesitas?", "suggestions": ["Ver alertas activas", "Como esta Maria Lopez?", "Mostrar metricas del equipo"]}

### Ejemplo 2: Consulta de agente (CON TOOL)

Usuario: "Como esta Maria Lopez?"

Paso 1: Llamar a filterTable con table_name="vista_resumen_agentes", filter_column="nombre", filter_value="Maria Lopez"

Paso 2: Recibir resultado con los datos de Maria

Paso 3: Responder con los datos:
{"message": "Maria Lopez del Equipo Norte tiene 15 llamadas esta semana con un score de 78.5 y probabilidad de cumplimiento del 82%.", "suggestions": ["Ver su reporte de coaching", "Comparar con el equipo", "Ver sus alertas"]}

### Ejemplo 3: No hay datos (CON TOOL)

Usuario: "Como esta Juan Perez?"

Paso 1: Llamar a filterTable con table_name="vista_resumen_agentes", filter_column="nombre", filter_value="Juan Perez"

Paso 2: Resultado vacio (array vacio)

Paso 3: Responder honestamente (NO reintentar):
{"message": "No encontre datos para Juan Perez. Puede que el nombre este escrito diferente o no este activo.", "suggestions": ["Ver lista de todos los agentes", "Buscar por equipo", "Ver alertas del sistema"]}

---

## QUE NO HACER (CRITICO)

- NO hagas multiples llamadas a filterTable en una respuesta
- NO reintentes la misma llamada si no devuelve datos
- NO uses filterTable para saludos o preguntas generales
- NO inventes datos - usa solo lo que devuelve la tool
- NO des respuestas largas - maximo 2-3 oraciones

---

## QUE SI HACER

- Haz 1 llamada si necesitas datos
- Espera el resultado
- Responde con ese resultado
- Detente

---

## Notas de Implementacion

### Configuracion Saturn Studio

- **Model:** gpt-4o-mini o claude-sonnet-4
- **Temperature:** 0.2 (bajo para comportamiento consistente)
- **Max Tokens:** 400 (respuestas concisas)

### Tool Description para filterTable

Consulta una tabla de Supabase con filtros opcionales. Devuelve array de objetos JSON. REGLA CRITICA: Solo llamar UNA VEZ por consulta del usuario - NO reintentar si el array esta vacio.

### Testing Checklist

- [ ] "Hola" -> Responde sin tool calls
- [ ] "Que puedes hacer?" -> Responde sin tool calls
- [ ] "Como esta Maria Lopez?" -> 1 tool call a vista_resumen_agentes
- [ ] "Hay alertas?" -> 1 tool call a alertas_anomalias
- [ ] "Como esta Juan Perez?" (no existe) -> 1 tool call, responde "No encontre datos"
- [ ] Todas las respuestas en formato JSON valido
</file>

<file path="docs/ag6_conversacional/README.md">
# Agente #6: Conversacional (LiveChat)

## Descripcion General

El Agente Conversacional es la interfaz de chat inteligente que permite a supervisores y agentes hacer preguntas en lenguaje natural sobre el sistema NODUS. Utiliza un Q&A Agent con acceso a las tablas de Supabase para responder consultas sobre metricas, agentes, llamadas, alertas y reportes.

## Arquitectura

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         FRONTEND                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ                    Chat Component                        ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  - Input de mensaje                                      ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  - Historia de conversacion                              ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  - Indicador de typing                                   ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  - Visualizaciones dinamicas                             ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚îÇ POST /webhook
                          ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      SATURN STUDIO                               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îÇ
‚îÇ  ‚îÇ  Receive    ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   Q&A       ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  Response   ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ  Webhook    ‚îÇ    ‚îÇ   Agent     ‚îÇ    ‚îÇ  Webhook    ‚îÇ         ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ
‚îÇ                            ‚îÇ                                     ‚îÇ
‚îÇ                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                            ‚îÇ
‚îÇ                    ‚îÇ  Tool: Filter ‚îÇ                            ‚îÇ
‚îÇ                    ‚îÇ  Table        ‚îÇ                            ‚îÇ
‚îÇ                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                            ‚îÇ
‚îÇ                            ‚îÇ                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        SUPABASE                                  ‚îÇ
‚îÇ  agentes | registro_llamadas | analisis_llamadas | alertas ...  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## Flujo de Datos

1. **Usuario escribe mensaje** en el chat del frontend
2. **Frontend envia** mensaje + historia via webhook POST
3. **Saturn recibe** el payload con el contexto completo
4. **Q&A Agent** procesa la pregunta:
   - Analiza la intencion del usuario
   - Decide si necesita consultar Supabase
   - Ejecuta queries via Tool (filterTable)
   - Genera respuesta en lenguaje natural
5. **Response webhook** devuelve la respuesta
6. **Frontend muestra** la respuesta con formato rico

## Componentes

### 1. Saturn Studio Flow
- **Nodo 1**: Receive Webhook (POST)
- **Nodo 2**: Q&A Agent con prompt y tools
- **Nodo 3**: Tool - Filter Table (Supabase)
- **Nodo 4**: Response Webhook

### 2. Frontend (Chat.tsx)
- Componente de chat con historial
- Indicador de "typing" mientras espera
- Renderizado de respuestas con markdown
- Visualizaciones embebidas (tablas, metricas)

### 3. Prompt del Agente
- Conocimiento completo del esquema de BD
- Instrucciones para interpretar preguntas
- Formato de respuesta estructurado

## Capacidades del Agente

| Categoria | Ejemplos de Preguntas |
|-----------|----------------------|
| **Metricas** | "Cual es el score promedio de hoy?" |
| **Agentes** | "Como esta rindiendo Maria Lopez?" |
| **Llamadas** | "Muestrame las ultimas 5 llamadas con score bajo" |
| **Alertas** | "Hay alertas criticas activas?" |
| **Coaching** | "Cual es el gap critico de Carlos?" |
| **Tendencias** | "Como ha evolucionado la tasa de validacion?" |
| **Comparativas** | "Quien es el mejor agente del Equipo Norte?" |

## Archivos del Agente

```
docs/ag6_conversacional/
‚îú‚îÄ‚îÄ README.md                 # Este archivo
‚îú‚îÄ‚îÄ prompt_completo.md        # Prompt detallado para Q&A Agent
‚îú‚îÄ‚îÄ payload_estructura.md     # Estructura del webhook
‚îú‚îÄ‚îÄ flujo_saturn.md           # Configuracion del flujo
‚îî‚îÄ‚îÄ plan_implementacion.md    # Plan paso a paso
```

## Integracion con Frontend

El componente `Chat.tsx` se conectara al webhook de Saturn y mostrara:
- Mensajes del usuario (alineados a la derecha)
- Respuestas del agente (alineados a la izquierda)
- Indicador de carga mientras procesa
- Tarjetas de datos cuando corresponda
</file>

<file path="docs/ag6_conversacional/tool_config_saturn.md">
# Configuracion de Tool: filterTable

## Para Saturn Studio Q&A Agent

---

## 1. Tool Definition (JSON Schema)

Copia y pega esto en Saturn Studio cuando configures la tool `filterTable`:

```json
{
  "name": "filterTable",
  "description": "Consulta una tabla de Supabase con filtros opcionales. Devuelve array de objetos JSON. REGLA CRITICA: Solo llamar UNA VEZ por consulta del usuario - NO reintentar si el array esta vacio.",
  "parameters": {
    "type": "object",
    "properties": {
      "table_name": {
        "type": "string",
        "description": "Tabla a consultar",
        "enum": [
          "vista_resumen_agentes",
          "alertas_anomalias",
          "analisis_llamadas",
          "coaching_reports"
        ]
      },
      "filter_column": {
        "type": "string",
        "description": "Columna para filtrar. Dejar vacio ('') para obtener todos los registros.",
        "default": ""
      },
      "filter_value": {
        "type": "string",
        "description": "Valor del filtro. Dejar vacio ('') si filter_column esta vacio.",
        "default": ""
      }
    },
    "required": ["table_name"]
  }
}
```

---

## 2. Implementacion de la Tool en Saturn

La tool debe ejecutar una query de Supabase siguiendo esta logica:

### Pseudocodigo

```javascript
async function filterTable({ table_name, filter_column = '', filter_value = '' }) {
  // Conectar a Supabase
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
  
  // Query base
  let query = supabase.from(table_name).select('*')
  
  // Aplicar filtro si existe
  if (filter_column && filter_value) {
    query = query.eq(filter_column, filter_value)
  }
  
  // Ejecutar
  const { data, error } = await query
  
  if (error) {
    return { error: error.message, data: [] }
  }
  
  // Devolver datos (puede ser array vacio)
  return { data: data || [], count: data?.length || 0 }
}
```

### Importante

- **Devuelve array vacio `[]` si no hay resultados** (NO error)
- **NO lanzar excepciones** por queries sin resultados
- **Log** las queries para debugging

---

## 3. Valores de Retorno Esperados

### Caso 1: Datos encontrados

```json
{
  "data": [
    {
      "nombre": "Maria Lopez",
      "equipo": "Equipo Norte",
      "llamadas_semana": 15,
      "score_semana": 78.5
    }
  ],
  "count": 1
}
```

### Caso 2: Sin datos (NO ES ERROR)

```json
{
  "data": [],
  "count": 0
}
```

### Caso 3: Error de base de datos

```json
{
  "error": "relation 'tabla_inexistente' does not exist",
  "data": []
}
```

---

## 4. Configuracion del Model en Saturn

### Settings Recomendados

| Parametro | Valor | Razon |
|-----------|-------|-------|
| **Model** | `gpt-4o-mini` o `claude-sonnet-4` | Balance costo/calidad |
| **Temperature** | `0.2` | Comportamiento consistente |
| **Max Tokens** | `400` | Respuestas concisas |
| **Top P** | `0.9` | Default |
| **Frequency Penalty** | `0.3` | Evita repeticion |
| **Presence Penalty** | `0.0` | Default |

### Por que Temperature 0.2?

- Temperatura baja = respuestas mas deterministicas
- Reduce la probabilidad de tool calls innecesarios
- Hace que el modelo siga las instrucciones del prompt mas fielmente

---

## 5. Testing de la Tool

### Test 1: Query con filtro

**Input:**
```json
{
  "table_name": "vista_resumen_agentes",
  "filter_column": "nombre",
  "filter_value": "Maria Lopez"
}
```

**Output esperado:**
```json
{
  "data": [{ "nombre": "Maria Lopez", "equipo": "...", ... }],
  "count": 1
}
```

### Test 2: Query sin filtro (todos)

**Input:**
```json
{
  "table_name": "alertas_anomalias",
  "filter_column": "",
  "filter_value": ""
}
```

**Output esperado:**
```json
{
  "data": [{ "alerta_id": "...", ... }, { ... }],
  "count": 5
}
```

### Test 3: Sin resultados

**Input:**
```json
{
  "table_name": "vista_resumen_agentes",
  "filter_column": "nombre",
  "filter_value": "Agente Inexistente"
}
```

**Output esperado:**
```json
{
  "data": [],
  "count": 0
}
```

### Test 4: Error (tabla incorrecta)

**Input:**
```json
{
  "table_name": "tabla_que_no_existe",
  "filter_column": "",
  "filter_value": ""
}
```

**Output esperado:**
```json
{
  "error": "relation 'tabla_que_no_existe' does not exist",
  "data": []
}
```

---

## 6. Debugging: Como Detectar Problemas

### Problema: Multiple tool calls

**Sintomas:** El LLM llama a filterTable 2+ veces seguidas con los mismos parametros

**Causas:**
- Temperature muy alta (>0.5)
- Prompt no tiene la regla "MAXIMO 1 TOOL CALL" clara
- La tool no devuelve resultados en el formato esperado

**Solucion:**
1. Bajar temperature a 0.2
2. Verificar que el prompt tenga "REGLA #1: MAXIMO 1 TOOL CALL" al inicio
3. Loggear el output de la tool para verificar formato

### Problema: Tool calls en saludos

**Sintomas:** El LLM llama a filterTable cuando el usuario dice "hola"

**Causas:**
- Prompt no tiene ejemplos claros de cuando NO usar tools
- Temperature alta

**Solucion:**
1. Agregar tabla de decision al prompt
2. Bajar temperature a 0.2
3. Agregar ejemplos de saludos en el prompt

### Problema: Reintenta cuando no hay datos

**Sintomas:** El LLM llama a filterTable, recibe `[]`, y vuelve a llamar

**Causas:**
- La tool devuelve null en vez de `[]`
- Prompt no tiene instruccion "NO reintentes"

**Solucion:**
1. Asegurarse que la tool devuelve `{"data": [], "count": 0}` cuando no hay resultados
2. Agregar instruccion "Si no hay datos, responde honestamente y NO reintentes"

---

## 7. Checklist de Implementacion

### En Saturn Studio

- [ ] Tool `filterTable` creada con el JSON schema de arriba
- [ ] Tool conectada a Supabase correctamente
- [ ] Tool devuelve `{"data": [], "count": 0}` cuando no hay resultados (NO null, NO error)
- [ ] Model configurado con temperature 0.2
- [ ] Max tokens = 400
- [ ] System prompt cargado desde `prompt_completo.md`

### Testing

- [ ] Test: "Hola" ‚Üí Sin tool calls, responde JSON
- [ ] Test: "Como esta Maria Lopez?" ‚Üí 1 tool call, responde con datos
- [ ] Test: "Como esta Juan Perez?" (inexistente) ‚Üí 1 tool call, responde "No encontre"
- [ ] Test: "Hay alertas?" ‚Üí 1 tool call a alertas_anomalias
- [ ] Test: Enviar 5 mensajes seguidos ‚Üí Cada mensaje tiene max 1 tool call

### Monitoring

- [ ] Log cada tool call con timestamp y parametros
- [ ] Log cada respuesta del LLM
- [ ] Alertar si >1 tool call en una sola respuesta
- [ ] Medir latencia (deberia ser <3s por respuesta)

---

## 8. Formato de Logs Recomendado

```
[2026-02-04 05:30:15] USER: "Como esta Maria Lopez?"
[2026-02-04 05:30:15] TOOL_CALL: filterTable(vista_resumen_agentes, nombre, Maria Lopez)
[2026-02-04 05:30:16] TOOL_RESULT: {"data": [...], "count": 1}
[2026-02-04 05:30:17] ASSISTANT: {"message": "Maria Lopez...", "suggestions": [...]}
[2026-02-04 05:30:17] METRICS: tool_calls=1, latency=2.1s, tokens=245
```

Esto te permite detectar rapidamente si el LLM esta haciendo multiples llamadas o comportamientos anomalos.
</file>

<file path="docs/arquitectura-agentes.md">
# NODUS - Arquitectura de Agentes y Flujo de Datos

## üéØ Visi√≥n General

El sistema NODUS est√° centrado en **6 agentes inteligentes** que procesan, analizan y generan insights sobre llamadas de cobranza. Las llamadas **no se almacenan** en el sistema - solo se guardan las transcripciones, an√°lisis y m√©tricas derivadas.

---

## üîÑ Flujo Principal

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                           SISTEMA EXTERNO                                    ‚îÇ
‚îÇ                    (CRM, IVR, Grabador de llamadas)                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
                  ‚îÇ POST /webhooks/nueva-llamada
                  ‚îÇ {audio_url, metadata}
                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        AGENTE TRANSCRIPTOR                                   ‚îÇ
‚îÇ  Trigger: Webhook | Tiempo: 1-3 min | Tech: Saturn Studio + AI Studio       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  INPUT:  audio_url, agente_id, cliente_ref, timestamp                       ‚îÇ
‚îÇ  PROCESO: Transcripci√≥n ‚Üí Diarizaci√≥n ‚Üí Emociones ‚Üí Extracci√≥n entidades   ‚îÇ
‚îÇ  OUTPUT: INSERT INTO transcripciones + UPDATE registro_llamadas             ‚îÇ
‚îÇ  DISPARA: Webhook ‚Üí Agente Analista                                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         AGENTE ANALISTA                                      ‚îÇ
‚îÇ  Trigger: Webhook (post-transcripci√≥n) | Tiempo: 30-60s | Tech: Claude Opus ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  INPUT:  transcripcion_id, datos_transcripcion, contexto_historico          ‚îÇ
‚îÇ  PROCESO: Evaluar 3 m√≥dulos ‚Üí Calcular scores ‚Üí Predecir cumplimiento       ‚îÇ
‚îÇ  OUTPUT: INSERT INTO analisis_llamadas                                       ‚îÇ
‚îÇ  DISPARA: Webhook ‚Üí Agente Detector (si hay alertas)                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         AGENTE DETECTOR                                      ‚îÇ
‚îÇ  Trigger: Post-an√°lisis + Cron (cada 30 min) | Tiempo: <10s                 ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  INPUT (individual): analisis_id con alertas                                ‚îÇ
‚îÇ  INPUT (sist√©mico): M√©tricas √∫ltimas horas vs hist√≥rico                     ‚îÇ
‚îÇ  PROCESO: Evaluar reglas ‚Üí Detectar anomal√≠as ‚Üí Clasificar severidad        ‚îÇ
‚îÇ  OUTPUT: INSERT INTO alertas_anomalias                                       ‚îÇ
‚îÇ  DISPARA: Notificaciones (email, Slack, in-app)                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

                           [PROCESOS BATCH]

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                          AGENTE COACH                                        ‚îÇ
‚îÇ  Trigger: Cron diario 08:00 AM | Tiempo: 5-10 min | Tech: Claude Opus       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  INPUT:  Lista de agentes activos + sus √∫ltimos 25 an√°lisis                 ‚îÇ
‚îÇ  PROCESO: Agregar m√©tricas ‚Üí Comparar con benchmark ‚Üí Generar plan          ‚îÇ
‚îÇ  OUTPUT: INSERT INTO coaching_reports (1 por agente)                         ‚îÇ
‚îÇ  DISPARA: Notificaciones a supervisores                                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         AGENTE ESTRATEGA                                     ‚îÇ
‚îÇ  Trigger: Cron semanal (Domingos 22:00) | Tiempo: 15-30 min | Claude Opus   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  INPUT:  Todas las m√©tricas de la semana + comparativa hist√≥rica            ‚îÇ
‚îÇ  PROCESO: An√°lisis temporal ‚Üí Correlaciones ‚Üí Optimizaci√≥n scripts          ‚îÇ
‚îÇ  OUTPUT: INSERT INTO reportes_estrategia                                     ‚îÇ
‚îÇ  DISPARA: Email con resumen ejecutivo a direcci√≥n                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                       AGENTE CONVERSACIONAL                                  ‚îÇ
‚îÇ  Trigger: Webhook on-demand | Tiempo: 2-5s | Tech: Claude Sonnet + RAG      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  INPUT:  Pregunta del usuario en lenguaje natural                           ‚îÇ
‚îÇ  PROCESO: An√°lisis intenci√≥n ‚Üí RAG (buscar en DB) ‚Üí Generar respuesta       ‚îÇ
‚îÇ  OUTPUT: Respuesta JSON via webhook (no persiste en DB)                      ‚îÇ
‚îÇ  CONSULTA: SELECT FROM todas las tablas seg√∫n necesidad                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìä Mapa de Agentes ‚Üî Tablas

| Agente | Lee de | Escribe en | Periodicidad | Volumen |
|--------|--------|------------|--------------|---------|
| **Transcriptor** | - | `registro_llamadas`, `transcripciones` | Por llamada | ~100-500/d√≠a |
| **Analista** | `transcripciones`, `agentes`, `analisis_llamadas` (hist√≥rico) | `analisis_llamadas` | Por transcripci√≥n | ~100-500/d√≠a |
| **Detector** | `analisis_llamadas`, `alertas_anomalias`, `metricas_agregadas` | `alertas_anomalias` | Post-an√°lisis + 48x/d√≠a | ~10-50/d√≠a |
| **Coach** | `agentes`, `analisis_llamadas`, `coaching_reports` | `coaching_reports` | 1x/d√≠a (08:00) | ~10-50/d√≠a |
| **Estratega** | `analisis_llamadas`, `agentes`, `metricas_agregadas`, `alertas_anomalias` | `reportes_estrategia` | 1x/semana | 1/semana |
| **Conversacional** | **TODAS** (solo lectura) | - | On-demand | ~50-200/d√≠a |

---

## üóÑÔ∏è Detalle de Interacciones por Agente

### 1. AGENTE TRANSCRIPTOR

**Recibe via Webhook:**
```json
{
  "audio_url": "https://storage.externo.com/call_xyz.mp3",
  "agente_id": "uuid",
  "cliente_ref": "CL-12345",
  "campana": "Recuperaci√≥n Q1",
  "timestamp_inicio": "2026-01-30T14:23:15Z",
  "timestamp_fin": "2026-01-30T14:27:30Z",
  "metadata": {
    "tipo_deuda": "tarjeta_credito",
    "monto_deuda": 1450.00,
    "dias_mora": 45
  }
}
```

**Escribe en `registro_llamadas`:**
- Crea registro con referencia al audio externo
- Estado inicial: `procesando`

**Escribe en `transcripciones`:**
- Transcripci√≥n completa
- Segmentos con speaker/timestamp/emoci√≥n
- Entidades extra√≠das (montos, fechas, m√©todos pago)

**Actualiza `registro_llamadas`:**
- Estado: `transcrito`
- `transcripcion_id`: referencia

---

### 2. AGENTE ANALISTA

**Recibe via Webhook (desde Transcriptor):**
```json
{
  "registro_id": "uuid",
  "transcripcion_id": "uuid"
}
```

**Lee de:**
- `transcripciones`: datos completos de la transcripci√≥n
- `agentes`: informaci√≥n del agente
- `analisis_llamadas`: historial del cliente (si existe)

**Escribe en `analisis_llamadas`:**
- Score total (0-100)
- Score por m√≥dulo (contacto_directo, compromiso_pago)
- Desglose detallado en JSON
- Predicci√≥n de cumplimiento
- Alertas detectadas
- Recomendaciones

**Actualiza `registro_llamadas`:**
- Estado: `analizado`

**Dispara Webhook a Detector si:**
- Score < 40
- Hay alertas cr√≠ticas
- Abandono detectado

---

### 3. AGENTE DETECTOR

**Trigger Individual (post-an√°lisis):**
```json
{
  "analisis_id": "uuid",
  "alertas_detectadas": [...]
}
```

**Trigger Sist√©mico (Cron cada 30 min):**
Ejecuta autom√°ticamente.

**Lee de:**
- `analisis_llamadas`: m√©tricas recientes
- `metricas_agregadas`: comparativa hist√≥rica
- `alertas_anomalias`: alertas existentes (evitar duplicados)

**Escribe en `alertas_anomalias`:**
- Tipo: individual | sist√©mica | patr√≥n
- Severidad: cr√≠tica | alta | media | baja
- Descripci√≥n y causa probable
- Agentes/llamadas relacionados
- Acci√≥n recomendada

**Reglas de Detecci√≥n:**

| Condici√≥n | Severidad | Tipo |
|-----------|-----------|------|
| Score < 30 | CR√çTICA | Individual |
| Abandono + cliente VIP | ALTA | Individual |
| Tasa abandono > 50% (√∫ltima hora) | CR√çTICA | Sist√©mica |
| Ca√≠da score > 30% vs ayer | ALTA | Sist√©mica |
| Agente con > 5 abandonos seguidos | MEDIA | Patr√≥n |
| Validaci√≥n < 20% (agente, 10 llamadas) | ALTA | Patr√≥n |

---

### 4. AGENTE COACH

**Trigger:** Cron diario a las 08:00 AM

**Lee de:**
- `agentes`: lista de agentes activos
- `analisis_llamadas`: √∫ltimos 25 an√°lisis por agente
- `coaching_reports`: reportes anteriores (para tracking)

**Escribe en `coaching_reports` (1 por agente):**
```json
{
  "agente_id": "uuid",
  "fecha_reporte": "2026-01-30",
  "metricas_periodo": {
    "score_promedio": 72,
    "tasa_validacion": 0.32,
    "total_llamadas": 25
  },
  "comparativa_equipo": {
    "score_equipo": 78,
    "ranking": 8,
    "percentil": 65
  },
  "fortalezas": [...],
  "gap_critico": {
    "area": "validacion_cliente",
    "impacto": "Reduce cumplimiento en 35%"
  },
  "plan_mejora": {
    "objetivo_semana": "Lograr validaci√≥n en >75%",
    "acciones": [...]
  }
}
```

---

### 5. AGENTE ESTRATEGA

**Trigger:** Cron semanal (Domingos 22:00)

**Lee de:**
- `analisis_llamadas`: todos los an√°lisis de la semana
- `agentes`: informaci√≥n de agentes
- `metricas_agregadas`: tendencias hist√≥ricas
- `alertas_anomalias`: patrones de alertas

**Escribe en `reportes_estrategia`:**
```json
{
  "periodo": "2026-01-23 a 2026-01-30",
  "resumen_ejecutivo": {
    "total_llamadas": 2847,
    "score_promedio": 72,
    "cambio_vs_anterior": +5
  },
  "hallazgos_estrategicos": [
    {
      "titulo": "Horario √≥ptimo identificado",
      "recomendacion": "Redistribuir 40% llamadas a 18:00-20:00",
      "impacto_proyectado": "+8 puntos score"
    }
  ],
  "top_performers": [...],
  "recomendaciones_estrategicas": [...]
}
```

---

### 6. AGENTE CONVERSACIONAL

**Trigger:** Webhook on-demand (usuario escribe pregunta)

**Recibe:**
```json
{
  "user_id": "uuid",
  "pregunta": "¬øC√≥mo le fue a Mar√≠a esta semana?"
}
```

**Lee de (RAG - seg√∫n la pregunta):**
- `agentes`: informaci√≥n de agentes
- `analisis_llamadas`: an√°lisis individuales
- `coaching_reports`: reportes de coaching
- `alertas_anomalias`: alertas activas
- `reportes_estrategia`: insights estrat√©gicos
- `metricas_agregadas`: m√©tricas r√°pidas

**Responde via Webhook (no persiste):**
```json
{
  "respuesta": "Mar√≠a realiz√≥ 23 llamadas...",
  "visualizaciones": [...],
  "acciones_sugeridas": [...]
}
```

---

## ‚è∞ Cronograma de Ejecuci√≥n

| Hora | Agente | Acci√≥n |
|------|--------|--------|
| 24/7 | Transcriptor | Por cada llamada nueva |
| 24/7 | Analista | Por cada transcripci√≥n |
| 24/7 | Detector | Post-an√°lisis (si hay alertas) |
| XX:00, XX:30 | Detector | An√°lisis sist√©mico cada 30 min |
| 08:00 | Coach | Generar reportes diarios |
| DOM 22:00 | Estratega | Generar reporte semanal |
| On-demand | Conversacional | Responder preguntas |

---

## üìà M√©tricas de Monitoreo

### Por Agente

| M√©trica | Transcriptor | Analista | Detector | Coach | Estratega |
|---------|--------------|----------|----------|-------|-----------|
| Tiempo promedio | < 2 min | < 45s | < 10s | < 10 min | < 30 min |
| Tasa de √©xito | > 98% | > 99% | > 99.5% | 100% | 100% |
| Errores/d√≠a | < 5 | < 2 | < 1 | 0 | 0 |

### Volumen Esperado

| Agente | Llamadas/d√≠a | Pico horario |
|--------|--------------|--------------|
| Transcriptor | 100-500 | 10:00-12:00, 16:00-19:00 |
| Analista | 100-500 | +2min post-transcripci√≥n |
| Detector | 10-50 alertas | Variable |
| Coach | 10-50 reportes | 08:00-08:10 |
| Estratega | 1 | Domingo 22:00 |

---

## üîß Configuraci√≥n Recomendada en Saturn Studio

### Variables de Entorno

```
# AI Studio
AI_STUDIO_URL=https://api.aistudio.rocketbot.com
AI_STUDIO_KEY=xxx

# LLM
ANTHROPIC_API_KEY=sk-ant-xxx
CLAUDE_MODEL_ANALYSIS=claude-opus-4-5-20250514
CLAUDE_MODEL_CHAT=claude-sonnet-4-5-20250514

# Database
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_KEY=xxx

# Notificaciones
SLACK_WEBHOOK_URL=https://hooks.slack.com/xxx
EMAIL_SMTP_HOST=smtp.xxx.com
```

### Timeouts Recomendados

| Agente | Timeout | Retry |
|--------|---------|-------|
| Transcriptor | 5 min | 2 |
| Analista | 2 min | 2 |
| Detector | 30s | 1 |
| Coach | 15 min | 1 |
| Estratega | 45 min | 1 |
| Conversacional | 30s | 1 |

---

## üìã Checklist de Implementaci√≥n

- [ ] Configurar webhook `/webhooks/nueva-llamada`
- [ ] Implementar flujo Transcriptor en Saturn Studio
- [ ] Conectar AI Studio para transcripci√≥n/emociones
- [ ] Implementar flujo Analista con prompts
- [ ] Configurar reglas del Detector
- [ ] Crear cron para Coach (08:00 diario)
- [ ] Crear cron para Estratega (DOM 22:00)
- [ ] Implementar endpoint Conversacional con RAG
- [ ] Configurar notificaciones (Slack/Email)
- [ ] Dashboard para monitoreo de agentes
</file>

<file path="docs/flujo-datos-e2e.md">
# NODUS - Flujo de Datos End-to-End

## Especificaci√≥n T√©cnica de Integraci√≥n
**Versi√≥n**: 1.0  
**Fecha**: Enero 2026

---

## üìã √çndice

1. [Visi√≥n General del Flujo](#vision-general)
2. [Fuente de Datos: Google Drive](#fuente-datos)
3. [Agente Transcriptor](#agente-transcriptor)
4. [Agente Analista](#agente-analista)
5. [Agente Detector](#agente-detector)
6. [Agente Coach](#agente-coach)
7. [Agente Estratega](#agente-estratega)
8. [Agente Conversacional](#agente-conversacional)
9. [Integraci√≥n Supabase Realtime](#supabase-realtime)
10. [Webhooks de Saturn Studio](#webhooks-saturn)
11. [Diagrama de Secuencia Completo](#diagrama-secuencia)

---

<a name="vision-general"></a>
## 1. Visi√≥n General del Flujo

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                                    FLUJO E2E NODUS                                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

  GOOGLE DRIVE          SATURN STUDIO              SUPABASE                 WEB APP
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê          ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê             ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê                ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       ‚îÇ                     ‚îÇ                        ‚îÇ                        ‚îÇ
       ‚îÇ   1. Audio nuevo    ‚îÇ                        ‚îÇ                        ‚îÇ
       ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ                        ‚îÇ                        ‚îÇ
       ‚îÇ                     ‚îÇ                        ‚îÇ                        ‚îÇ
       ‚îÇ              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                 ‚îÇ                        ‚îÇ
       ‚îÇ              ‚îÇ TRANSCRIPTOR ‚îÇ                ‚îÇ                        ‚îÇ
       ‚îÇ              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                 ‚îÇ                        ‚îÇ
       ‚îÇ                     ‚îÇ                        ‚îÇ                        ‚îÇ
       ‚îÇ                     ‚îÇ  2. INSERT             ‚îÇ   Realtime             ‚îÇ
       ‚îÇ                     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ
       ‚îÇ                     ‚îÇ                        ‚îÇ   (registro_llamadas)  ‚îÇ
       ‚îÇ                     ‚îÇ                        ‚îÇ   (transcripciones)    ‚îÇ
       ‚îÇ                     ‚îÇ                        ‚îÇ                        ‚îÇ
       ‚îÇ              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                 ‚îÇ                        ‚îÇ
       ‚îÇ              ‚îÇ   ANALISTA  ‚îÇ                 ‚îÇ                        ‚îÇ
       ‚îÇ              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                 ‚îÇ                        ‚îÇ
       ‚îÇ                     ‚îÇ                        ‚îÇ                        ‚îÇ
       ‚îÇ                     ‚îÇ  3. INSERT             ‚îÇ   Realtime             ‚îÇ
       ‚îÇ                     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ
       ‚îÇ                     ‚îÇ                        ‚îÇ   (analisis_llamadas)  ‚îÇ
       ‚îÇ                     ‚îÇ                        ‚îÇ                        ‚îÇ
       ‚îÇ              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                 ‚îÇ                        ‚îÇ
       ‚îÇ              ‚îÇ   DETECTOR  ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                        ‚îÇ
       ‚îÇ              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   (si alertas)  ‚îÇ                        ‚îÇ
       ‚îÇ                     ‚îÇ                        ‚îÇ                        ‚îÇ
       ‚îÇ                     ‚îÇ  4. INSERT             ‚îÇ   Realtime             ‚îÇ
       ‚îÇ                     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ
       ‚îÇ                     ‚îÇ                        ‚îÇ   (alertas_anomalias)  ‚îÇ
       ‚îÇ                     ‚îÇ                        ‚îÇ                        ‚îÇ
       ‚îÇ              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                 ‚îÇ                        ‚îÇ
       ‚îÇ              ‚îÇ    COACH    ‚îÇ (08:00 diario)  ‚îÇ                        ‚îÇ
       ‚îÇ              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                 ‚îÇ                        ‚îÇ
       ‚îÇ                     ‚îÇ                        ‚îÇ                        ‚îÇ
       ‚îÇ                     ‚îÇ  5. INSERT             ‚îÇ   Realtime             ‚îÇ
       ‚îÇ                     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ
       ‚îÇ                     ‚îÇ                        ‚îÇ   (coaching_reports)   ‚îÇ
       ‚îÇ                     ‚îÇ                        ‚îÇ                        ‚îÇ
       ‚îÇ              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                 ‚îÇ                        ‚îÇ
       ‚îÇ              ‚îÇ  ESTRATEGA  ‚îÇ (DOM 22:00)     ‚îÇ                        ‚îÇ
       ‚îÇ              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                 ‚îÇ                        ‚îÇ
       ‚îÇ                     ‚îÇ                        ‚îÇ                        ‚îÇ
       ‚îÇ                     ‚îÇ  6. INSERT             ‚îÇ   Realtime             ‚îÇ
       ‚îÇ                     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ
       ‚îÇ                     ‚îÇ                        ‚îÇ  (reportes_estrategia) ‚îÇ
       ‚îÇ                     ‚îÇ                        ‚îÇ                        ‚îÇ
       ‚îÇ                     ‚îÇ                        ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
       ‚îÇ              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                 ‚îÇ   7. Pregunta usuario  ‚îÇ
       ‚îÇ              ‚îÇCONVERSACIONAL‚îÇ                ‚îÇ                        ‚îÇ
       ‚îÇ              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                 ‚îÇ                        ‚îÇ
       ‚îÇ                     ‚îÇ                        ‚îÇ   8. Respuesta         ‚îÇ
       ‚îÇ                     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ
       ‚îÇ                     ‚îÇ                        ‚îÇ                        ‚îÇ
```

---

<a name="fuente-datos"></a>
## 2. Fuente de Datos: Google Drive

### Configuraci√≥n del Trigger

El sistema externo (CRM/IVR) sube los audios a Google Drive y dispara el webhook.

**Opci√≥n A: Google Apps Script (Trigger en Drive)**
```javascript
// Trigger cuando se sube un archivo a la carpeta
function onFileUpload(e) {
  const file = e.file;
  const metadata = extractMetadata(file.getName()); // Parsear nombre del archivo
  
  const payload = {
    audio_url: file.getDownloadUrl(),
    audio_id_externo: file.getId(),
    agente_id: metadata.agente_id,
    cliente_ref: metadata.cliente_ref,
    timestamp_inicio: metadata.timestamp_inicio,
    timestamp_fin: metadata.timestamp_fin,
    campana: metadata.campana,
    tipo_deuda: metadata.tipo_deuda,
    monto_deuda: metadata.monto_deuda,
    dias_mora: metadata.dias_mora
  };
  
  UrlFetchApp.fetch('https://saturn.rocketbot.com/webhooks/nodus-transcriptor', {
    method: 'POST',
    contentType: 'application/json',
    payload: JSON.stringify(payload)
  });
}
```

**Opci√≥n B: Integraci√≥n directa desde CRM**
```
POST https://saturn.rocketbot.com/webhooks/nodus-transcriptor
```

### Formato del Archivo de Audio

| Propiedad | Valor |
|-----------|-------|
| Formato | MP3, WAV, M4A, OGG |
| Duraci√≥n m√°xima | 30 minutos |
| Calidad m√≠nima | 16kHz, mono |
| Naming convention | `{agente_id}_{cliente_ref}_{timestamp}.mp3` |

---

<a name="agente-transcriptor"></a>
## 3. Agente Transcriptor

### Informaci√≥n General

| Propiedad | Valor |
|-----------|-------|
| **Webhook URL** | `POST /webhooks/nodus-transcriptor` |
| **Trigger** | Webhook (cuando llega audio nuevo) |
| **Tiempo esperado** | 1-3 minutos |
| **Tecnolog√≠a** | Saturn Studio + AI Studio (Whisper) |
| **Timeout** | 5 minutos |
| **Retries** | 2 |

### Input Format

```json
{
  "audio_url": "https://drive.google.com/uc?export=download&id=FILE_ID",
  "audio_id_externo": "1abc123def456",
  "agente_id": "a0000000-0000-0000-0000-000000000001",
  "cliente_ref": "CL-45632",
  "timestamp_inicio": "2026-01-30T14:23:15-05:00",
  "timestamp_fin": "2026-01-30T14:27:30-05:00",
  "campana": "Recuperaci√≥n Q1",
  "tipo_deuda": "tarjeta_credito",
  "monto_deuda": 1450.00,
  "dias_mora": 45,
  "metadata_externa": {
    "ivr_session_id": "IVR-12345",
    "origen": "outbound"
  }
}
```

### Procesamiento Interno (Saturn Studio Flow)

```
1. Validar input (schema, URL accesible)
2. Descargar audio temporalmente
3. AI Studio: Transcribir (Whisper large-v3)
   - Diarizaci√≥n activa (separar speakers)
   - Idioma: espa√±ol
4. AI Studio: Analizar emociones por segmento
5. LLM (Claude Sonnet): Extraer entidades
   - Montos mencionados
   - Fechas mencionadas
   - M√©todos de pago
   - Objeciones del cliente
   - Compromisos verbales
6. Calcular m√©tricas conversacionales
7. INSERT en Supabase: registro_llamadas
8. INSERT en Supabase: transcripciones
9. UPDATE registro_llamadas con transcripcion_id
10. Trigger webhook ‚Üí Agente Analista
```

### Output Format (INSERT en Supabase)

**Tabla: `registro_llamadas`**
```json
{
  "registro_id": "r0000000-0000-0000-0000-000000000001",
  "audio_url": "https://drive.google.com/...",
  "audio_id_externo": "1abc123def456",
  "timestamp_inicio": "2026-01-30T14:23:15-05:00",
  "timestamp_fin": "2026-01-30T14:27:30-05:00",
  "duracion_segundos": 255,
  "timestamp_fecha": "2026-01-30",
  "agente_id": "a0000000-0000-0000-0000-000000000001",
  "cliente_ref": "CL-45632",
  "campana": "Recuperaci√≥n Q1",
  "tipo_deuda": "tarjeta_credito",
  "monto_deuda": 1450.00,
  "dias_mora": 45,
  "estado": "transcrito",
  "transcripcion_id": "t0000000-0000-0000-0000-000000000001",
  "metadata_externa": {"ivr_session_id": "IVR-12345", "origen": "outbound"}
}
```

**Tabla: `transcripciones`**
```json
{
  "transcripcion_id": "t0000000-0000-0000-0000-000000000001",
  "registro_id": "r0000000-0000-0000-0000-000000000001",
  "transcripcion_completa": "Buenos d√≠as, ¬øhablo con el se√±or Garc√≠a? S√≠, soy yo...",
  "segmentos": [
    {
      "speaker": "agente",
      "timestamp_inicio": 0.0,
      "timestamp_fin": 3.2,
      "texto": "Buenos d√≠as, ¬øhablo con el se√±or Garc√≠a?",
      "emocion": "neutral",
      "velocidad_habla": 145
    },
    {
      "speaker": "cliente",
      "timestamp_inicio": 3.2,
      "timestamp_fin": 5.8,
      "texto": "S√≠, soy yo. ¬øDe d√≥nde me llama?",
      "emocion": "neutral",
      "velocidad_habla": 140
    }
  ],
  "entidades": {
    "montos": [
      {"valor": 1450, "moneda": "PEN", "contexto": "deuda_principal"}
    ],
    "fechas": [
      {"fecha": "2025-12-15", "contexto": "vencimiento"},
      {"fecha": "2026-02-15", "contexto": "compromiso_sugerido"}
    ],
    "metodos_pago": ["web", "app", "agencia"],
    "objeciones": [],
    "compromisos": [
      {"tipo": "implicito", "fecha": "2026-02-15", "monto": 1450}
    ]
  },
  "metricas_conversacion": {
    "palabras_agente": 65,
    "palabras_cliente": 18,
    "ratio_habla": 0.78,
    "interrupciones": 0,
    "silencios_largos": 0,
    "velocidad_promedio_agente": 148,
    "velocidad_promedio_cliente": 135
  },
  "calidad_audio": {
    "score": 85,
    "ruido_fondo": false,
    "cortes": 0,
    "inaudibles": 0
  },
  "modelo_transcripcion": "whisper-large-v3",
  "modelo_emociones": "ai-studio-emotions-v1",
  "modelo_entidades": "claude-sonnet-4-5-20250514",
  "tiempo_procesamiento_ms": 45000
}
```

### Webhook de Salida (‚Üí Agente Analista)

```
POST https://saturn.rocketbot.com/webhooks/nodus-analista
Content-Type: application/json

{
  "registro_id": "r0000000-0000-0000-0000-000000000001",
  "transcripcion_id": "t0000000-0000-0000-0000-000000000001",
  "agente_id": "a0000000-0000-0000-0000-000000000001",
  "timestamp": "2026-01-30T14:28:45Z"
}
```

### Response al Caller

```json
{
  "status": "success",
  "registro_id": "r0000000-0000-0000-0000-000000000001",
  "transcripcion_id": "t0000000-0000-0000-0000-000000000001",
  "tiempo_procesamiento_ms": 45000,
  "siguiente_agente": "analista"
}
```

---

<a name="agente-analista"></a>
## 4. Agente Analista

### Informaci√≥n General

| Propiedad | Valor |
|-----------|-------|
| **Webhook URL** | `POST /webhooks/nodus-analista` |
| **Trigger** | Webhook (desde Transcriptor) |
| **Tiempo esperado** | 30-60 segundos |
| **Tecnolog√≠a** | Saturn Studio + Claude Opus 4.5 |
| **Timeout** | 2 minutos |
| **Retries** | 2 |

### Input Format

```json
{
  "registro_id": "r0000000-0000-0000-0000-000000000001",
  "transcripcion_id": "t0000000-0000-0000-0000-000000000001",
  "agente_id": "a0000000-0000-0000-0000-000000000001",
  "timestamp": "2026-01-30T14:28:45Z"
}
```

### Procesamiento Interno (Saturn Studio Flow)

```
1. Validar input
2. SELECT FROM transcripciones WHERE transcripcion_id = ?
3. SELECT FROM agentes WHERE agente_id = ?
4. SELECT FROM analisis_llamadas WHERE cliente_ref = ? (historial)
5. Preparar prompt con template + datos
6. LLM (Claude Opus 4.5): Analizar llamada
   - Evaluar M√≥dulo 1: Contacto Directo
   - Evaluar M√≥dulo 2: Compromiso de Pago
   - Evaluar M√≥dulo 3: Abandono
   - Calcular predicci√≥n de cumplimiento
   - Generar alertas si aplica
   - Generar recomendaciones
7. Validar output (schema JSON)
8. INSERT en Supabase: analisis_llamadas
9. UPDATE registro_llamadas SET analisis_id = ?, estado = 'analizado'
10. SI hay alertas cr√≠ticas ‚Üí Trigger webhook ‚Üí Agente Detector
```

### Prompt Template (Extracto)

```markdown
Eres un experto analista de cobranzas. Analiza esta llamada seg√∫n 3 m√≥dulos:

## M√ìDULO 1: CONTACTO DIRECTO (0-100 pts)
- Monto mencionado claramente (25 pts)
- Fecha vencimiento explicada (15 pts)
- Consecuencias impago mencionadas (20 pts)
- Alternativas de pago ofrecidas (15 pts)
- Manejo de objeciones (25 pts)

## M√ìDULO 2: COMPROMISO DE PAGO (0-100 pts)
- Oferta clara: 20%
- Alternativas pago: 10%
- Fecha espec√≠fica: 20%
- Validaci√≥n EXPL√çCITA del cliente: 50% ‚Üê CR√çTICO

## M√ìDULO 3: ABANDONO
- ¬øHubo abandono? ¬øCu√°ndo? ¬øPor qu√©? ¬øSe√±ales previas?

## DATOS DE LA LLAMADA:
Transcripci√≥n: {transcripcion_completa}
Segmentos: {segmentos}
Entidades detectadas: {entidades}
M√©tricas: {metricas_conversacion}

## TAREAS:
1. Eval√∫a cada m√≥dulo objetivamente con evidencia textual
2. Predice probabilidad de cumplimiento (0-100) bas√°ndote en:
   - Presencia de 4 pilares (especialmente validaci√≥n expl√≠cita)
   - Calidad de la gesti√≥n del agente
3. Genera alertas si: score < 40, abandono, falta validaci√≥n en cliente importante
4. Genera 2-3 recomendaciones accionables

Responde SOLO en JSON seg√∫n el schema adjunto.
```

### Output Format (INSERT en Supabase)

**Tabla: `analisis_llamadas`**
```json
{
  "analisis_id": "an000000-0000-0000-0000-000000000001",
  "registro_id": "r0000000-0000-0000-0000-000000000001",
  "transcripcion_id": "t0000000-0000-0000-0000-000000000001",
  "agente_id": "a0000000-0000-0000-0000-000000000001",
  "fecha_llamada": "2026-01-30",
  
  "score_total": 72,
  "score_contacto_directo": 85,
  "score_compromiso_pago": 58,
  
  "modulo_contacto_directo": {
    "score": 85,
    "desglose": {
      "monto_mencionado": {
        "presente": true,
        "puntos": 25,
        "max": 25,
        "evidencia": "su saldo vencido de 1,450 soles"
      },
      "fecha_vencimiento": {
        "presente": true,
        "puntos": 15,
        "max": 15,
        "evidencia": "vencimiento fue el 15 de diciembre"
      },
      "consecuencias_impago": {
        "presente": true,
        "puntos": 12,
        "max": 20,
        "evidencia": "evitar intereses adicionales"
      },
      "alternativas_pago": {
        "presente": true,
        "puntos": 15,
        "max": 15,
        "evidencia": "web, app m√≥vil o agencia"
      },
      "manejo_objeciones": {
        "calidad": 0.8,
        "puntos": 18,
        "max": 25,
        "objeciones_detectadas": 0
      }
    }
  },
  
  "modulo_compromiso_pago": {
    "score": 58,
    "desglose": {
      "oferta_clara": {"presente": true, "puntos": 20, "max": 20},
      "alternativas_pago": {"presente": true, "puntos": 10, "max": 10},
      "fecha_especifica": {"presente": true, "puntos": 20, "max": 20, "fecha": "2026-02-15"},
      "validacion_cliente": {
        "presente": false,
        "tipo": "implicita",
        "puntos": 8,
        "max": 50,
        "frase_exacta": "lo voy a revisar"
      }
    }
  },
  
  "modulo_abandono": {
    "hubo_abandono": false,
    "momento_segundos": null,
    "iniciado_por": null,
    "razon": null,
    "senales_previas": []
  },
  
  "probabilidad_cumplimiento": 58,
  "nivel_cumplimiento": "media",
  
  "factores_prediccion": {
    "factores_positivos": [
      "Fecha espec√≠fica acordada",
      "Buena explicaci√≥n de alternativas",
      "Monto claramente comunicado"
    ],
    "factores_negativos": [
      "Falta validaci√≥n expl√≠cita (-30pts)",
      "Cliente no confirm√≥ compromiso verbalmente"
    ],
    "razonamiento": "Aunque hay fecha clara y alternativas bien explicadas, la ausencia de validaci√≥n expl√≠cita reduce significativamente la probabilidad de cumplimiento basado en patrones hist√≥ricos.",
    "historial_cliente_considerado": false
  },
  
  "alertas": [
    {
      "tipo": "advertencia",
      "codigo": "FALTA_VALIDACION",
      "mensaje": "Cliente NO valid√≥ expl√≠citamente el compromiso de pago",
      "severidad": "alta"
    }
  ],
  
  "recomendaciones": [
    {
      "prioridad": "alta",
      "destinatario": "supervisor",
      "accion": "Llamar en 48hrs para reforzar compromiso con validaci√≥n expl√≠cita",
      "cuando": "antes de fecha compromiso"
    },
    {
      "prioridad": "media",
      "destinatario": "agente",
      "accion": "Revisar t√©cnica de cierre - usar frase de confirmaci√≥n",
      "cuando": "pr√≥xima llamada"
    }
  ],
  
  "modelo_usado": "claude-opus-4-5-20250514",
  "version_prompt": "v1.2",
  "confianza_analisis": 0.89,
  "tiempo_procesamiento_ms": 35000
}
```

### Webhook de Salida (‚Üí Agente Detector) - Condicional

Solo se dispara si hay alertas con severidad "critica" o "alta":

```
POST https://saturn.rocketbot.com/webhooks/nodus-detector
Content-Type: application/json

{
  "trigger_type": "post_analisis",
  "analisis_id": "an000000-0000-0000-0000-000000000001",
  "registro_id": "r0000000-0000-0000-0000-000000000001",
  "agente_id": "a0000000-0000-0000-0000-000000000001",
  "alertas": [
    {
      "tipo": "advertencia",
      "codigo": "FALTA_VALIDACION",
      "severidad": "alta"
    }
  ],
  "score_total": 72,
  "timestamp": "2026-01-30T14:29:30Z"
}
```

### Response al Caller

```json
{
  "status": "success",
  "analisis_id": "an000000-0000-0000-0000-000000000001",
  "score_total": 72,
  "probabilidad_cumplimiento": 58,
  "alertas_generadas": 1,
  "tiempo_procesamiento_ms": 35000,
  "detector_triggered": true
}
```

---

<a name="agente-detector"></a>
## 5. Agente Detector

### Informaci√≥n General

| Propiedad | Valor |
|-----------|-------|
| **Webhook URL** | `POST /webhooks/nodus-detector` |
| **Trigger 1** | Webhook (desde Analista, si hay alertas) |
| **Trigger 2** | Cron cada 30 minutos (an√°lisis sist√©mico) |
| **Tiempo esperado** | < 10 segundos |
| **Tecnolog√≠a** | Saturn Studio + Reglas + LLM opcional |
| **Timeout** | 30 segundos |
| **Retries** | 1 |

### Input Format - Trigger Individual (Post-An√°lisis)

```json
{
  "trigger_type": "post_analisis",
  "analisis_id": "an000000-0000-0000-0000-000000000001",
  "registro_id": "r0000000-0000-0000-0000-000000000001",
  "agente_id": "a0000000-0000-0000-0000-000000000001",
  "alertas": [
    {"tipo": "advertencia", "codigo": "FALTA_VALIDACION", "severidad": "alta"}
  ],
  "score_total": 72,
  "timestamp": "2026-01-30T14:29:30Z"
}
```

### Input Format - Trigger Sist√©mico (Cron)

```json
{
  "trigger_type": "cron_sistemico",
  "timestamp": "2026-01-30T15:00:00Z"
}
```

### Procesamiento Interno (Saturn Studio Flow)

**Para trigger individual:**
```
1. Evaluar alertas del an√°lisis
2. Verificar reglas de escalamiento:
   - Score < 30 ‚Üí Alerta CR√çTICA
   - Abandono + score bajo ‚Üí Alerta CR√çTICA
   - Falta validaci√≥n + monto > 5000 ‚Üí Alerta ALTA
3. Verificar si alerta similar ya existe (evitar duplicados)
4. INSERT en Supabase: alertas_anomalias
5. Disparar notificaci√≥n (Slack/Email)
```

**Para trigger sist√©mico (cron):**
```
1. SELECT m√©tricas √∫ltima hora vs promedio hist√≥rico
2. Evaluar reglas sist√©micas:
   - Tasa abandono > 50% √∫ltima hora ‚Üí CR√çTICA
   - Ca√≠da score > 30% vs ayer ‚Üí ALTA
   - Agente con > 5 abandonos seguidos ‚Üí MEDIA
   - Validaci√≥n < 20% equipo √∫ltima hora ‚Üí ALTA
3. SELECT patrones por agente (√∫ltimas 10 llamadas)
4. INSERT alertas detectadas
5. Disparar notificaciones seg√∫n severidad
```

### Reglas de Detecci√≥n

| Condici√≥n | Severidad | Tipo | Notifica a |
|-----------|-----------|------|------------|
| Score < 30 | CR√çTICA | individual | Supervisor + Slack |
| Abandono + cliente VIP | CR√çTICA | individual | Supervisor + Email |
| Tasa abandono > 50% (1h) | CR√çTICA | sist√©mica | Gerencia + Slack |
| Ca√≠da score > 30% vs ayer | ALTA | sist√©mica | Supervisor |
| Sin validaci√≥n + monto > 5000 | ALTA | individual | Supervisor |
| Agente > 5 abandonos seguidos | MEDIA | patr√≥n | Supervisor |
| Validaci√≥n < 20% (agente, 10 llamadas) | ALTA | patr√≥n | Coach |

### Output Format (INSERT en Supabase)

**Tabla: `alertas_anomalias`**
```json
{
  "alerta_id": "al000000-0000-0000-0000-000000000001",
  "tipo": "individual",
  "severidad": "alta",
  "categoria": "performance",
  "codigo": "FALTA_VALIDACION",
  
  "descripcion": "Llamada sin validaci√≥n expl√≠cita con monto de deuda de S/. 1,450. Cliente solo respondi√≥ 'lo voy a revisar'.",
  "causa_probable": "Agente no utiliz√≥ t√©cnica de cierre con pregunta de confirmaci√≥n",
  
  "datos_soporte": {
    "score_total": 72,
    "monto_deuda": 1450,
    "frase_cliente": "lo voy a revisar",
    "duracion_llamada": 255
  },
  
  "impacto_estimado": {
    "llamadas_afectadas": 1,
    "perdida_oportunidades": 1,
    "monto_en_riesgo": 1450
  },
  
  "accion_recomendada": {
    "urgencia": "48_horas",
    "destinatario": "supervisor",
    "accion": "Contactar nuevamente al cliente para obtener validaci√≥n expl√≠cita",
    "deadline": "2026-02-01T18:00:00Z"
  },
  
  "registro_id": "r0000000-0000-0000-0000-000000000001",
  "agentes_relacionados": ["a0000000-0000-0000-0000-000000000002"],
  
  "estado": "nueva",
  "notificacion_enviada": true
}
```

### Webhook de Notificaci√≥n (‚Üí Slack/Email)

```
POST https://hooks.slack.com/services/xxx/yyy/zzz
Content-Type: application/json

{
  "text": "üö® *ALERTA NODUS* - Severidad: ALTA",
  "blocks": [
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "*Tipo:* Falta Validaci√≥n\n*Agente:* Mar√≠a Gonz√°lez\n*Score:* 72/100\n*Monto en riesgo:* S/. 1,450"
      }
    },
    {
      "type": "actions",
      "elements": [
        {
          "type": "button",
          "text": {"type": "plain_text", "text": "Ver Llamada"},
          "url": "https://nodus.app/llamadas/r0000000-0000-0000-0000-000000000001"
        }
      ]
    }
  ]
}
```

### Response al Caller

```json
{
  "status": "success",
  "alertas_creadas": 1,
  "alertas_ids": ["al000000-0000-0000-0000-000000000001"],
  "notificaciones_enviadas": ["slack", "email"],
  "tiempo_procesamiento_ms": 850
}
```

---

<a name="agente-coach"></a>
## 6. Agente Coach

### Informaci√≥n General

| Propiedad | Valor |
|-----------|-------|
| **Webhook URL** | `POST /webhooks/nodus-coach` |
| **Trigger** | Cron diario a las 08:00 AM (hora local) |
| **Tiempo esperado** | 5-10 minutos |
| **Tecnolog√≠a** | Saturn Studio + Claude Opus 4.5 |
| **Timeout** | 15 minutos |
| **Retries** | 1 |

### Input Format (Cron Trigger)

```json
{
  "trigger_type": "cron_diario",
  "fecha_reporte": "2026-01-30",
  "periodo_dias": 5,
  "timestamp": "2026-01-30T08:00:00-05:00"
}
```

### Procesamiento Interno (Saturn Studio Flow)

```
1. SELECT FROM agentes WHERE estado = 'activo'
2. PARA CADA agente:
   a. SELECT √∫ltimos 25 an√°lisis del agente
   b. Calcular m√©tricas del per√≠odo
   c. SELECT benchmark del equipo
   d. SELECT reporte anterior (para tracking progreso)
   e. LLM (Claude Opus): Generar an√°lisis y plan
   f. INSERT en Supabase: coaching_reports
3. Calcular insights globales del equipo
4. Enviar notificaciones a supervisores
5. Enviar notificaciones individuales a agentes
```

### Prompt Template (Extracto)

```markdown
Eres un coach de cobranzas experto. Analiza el desempe√±o de {nombre}:

## DATOS DEL AGENTE (√∫ltimas 25 llamadas):
- Score promedio: {score_promedio}
- Score m√≠nimo: {score_min}
- Score m√°ximo: {score_max}
- Tasa de validaci√≥n: {tasa_validacion}%
- Probabilidad cumplimiento promedio: {prob_cumplimiento}%
- Llamadas con abandono: {abandonos}

## BENCHMARK DEL EQUIPO:
- Score promedio equipo: {score_equipo}
- Tasa validaci√≥n equipo: {validacion_equipo}%
- Ranking actual: {ranking}/{total_agentes}

## AN√ÅLISIS DETALLADO POR LLAMADA:
{lista_analisis}

## REPORTE ANTERIOR:
- Objetivo anterior: {objetivo_anterior}
- ¬øCumplido?: {cumplido}
- Gap cr√≠tico anterior: {gap_anterior}

## TAREAS:
1. Identifica 2-3 fortalezas principales con evidencia
2. Identifica el GAP M√ÅS CR√çTICO (mayor impacto en resultados)
3. Detecta patrones recurrentes (positivos y negativos)
4. Genera plan de mejora de 1 semana con:
   - Objetivo espec√≠fico y medible
   - 3 acciones concretas con prioridad
   - Llamadas propias para revisar como ejemplo
5. Compara con reporte anterior y eval√∫a progreso

Responde en JSON seg√∫n schema adjunto.
```

### Output Format (INSERT en Supabase)

**Tabla: `coaching_reports`**
```json
{
  "reporte_id": "cr000000-0000-0000-0000-000000000001",
  "agente_id": "a0000000-0000-0000-0000-000000000002",
  "fecha_reporte": "2026-01-30",
  "periodo_inicio": "2026-01-25",
  "periodo_fin": "2026-01-30",
  "total_llamadas_analizadas": 23,
  
  "metricas_periodo": {
    "score_promedio": 72,
    "score_min": 58,
    "score_max": 85,
    "tasa_validacion": 0.32,
    "probabilidad_cumplimiento_promedio": 48,
    "tasa_abandono": 0.04,
    "duracion_promedio": 245
  },
  
  "comparativa_equipo": {
    "score_equipo": 78,
    "validacion_equipo": 0.61,
    "ranking": 8,
    "total_agentes": 12,
    "percentil": 65,
    "diferencia_vs_promedio": -6
  },
  
  "fortalezas": [
    {
      "area": "manejo_objeciones",
      "descripcion": "Excelente t√©cnica de empat√≠a al escuchar problemas del cliente",
      "evidencia": "92% de objeciones bien manejadas en las 23 llamadas",
      "impacto": "Reduce abandono en aproximadamente 15%"
    },
    {
      "area": "comunicacion_alternativas",
      "descripcion": "Siempre presenta m√∫ltiples opciones de pago",
      "evidencia": "100% de llamadas incluyen al menos 2 alternativas",
      "impacto": "Aumenta flexibilidad percibida por el cliente"
    }
  ],
  
  "gap_critico": {
    "area": "validacion_cliente",
    "descripcion": "En 18 de 25 llamadas (72%) no logra validaci√≥n expl√≠cita del compromiso",
    "impacto": "Reduce cumplimiento real en aproximadamente 35%",
    "ejemplos_registros": [
      "r0000000-0000-0000-0000-000000000001",
      "r0000000-0000-0000-0000-000000000004"
    ],
    "frecuencia": "Casi todas las llamadas con compromiso"
  },
  
  "patrones": [
    {
      "tipo": "negativo",
      "descripcion": "Cierra llamadas diciendo 'lo esperamos' en lugar de pedir confirmaci√≥n",
      "frecuencia": "15 de 23 llamadas",
      "impacto": "Validaci√≥n impl√≠cita no genera compromiso real"
    }
  ],
  
  "plan_mejora": {
    "objetivo_semana": "Lograr validaci√≥n expl√≠cita en m√°s del 75% de los compromisos",
    "meta_cuantitativa": "Subir tasa de validaci√≥n de 32% a 75% (+43 puntos)",
    "acciones": [
      {
        "accion": "Role-play de t√©cnica de cierre",
        "como": "15 minutos diarios con supervisor usando el script: '¬øMe confirma que realizar√° el pago de X soles el d√≠a Y?'",
        "prioridad": "alta",
        "duracion": "15 min/d√≠a"
      },
      {
        "accion": "Revisar 3 llamadas exitosas de Carlos Ram√≠rez",
        "como": "Observar c√≥mo obtiene validaci√≥n de forma natural y fluida",
        "prioridad": "media",
        "duracion": "30 min total"
      },
      {
        "accion": "Usar checklist de cierre antes de colgar",
        "como": "Verificar: ¬øEl cliente DIJO que va a pagar? ¬øFecha espec√≠fica? ¬øMonto confirmado?",
        "prioridad": "alta",
        "duracion": "30 seg/llamada"
      }
    ],
    "registros_para_revisar": [
      {
        "registro_id": "r0000000-0000-0000-0000-000000000001",
        "razon": "ejemplo_negativo",
        "que_observar": "Minuto 3:45 - Cliente dice 'ok' pero no hay validaci√≥n expl√≠cita"
      },
      {
        "registro_id": "an000000-0000-0000-0000-000000000002",
        "razon": "ejemplo_positivo_otro_agente",
        "que_observar": "Minuto 2:30 - Carlos obtiene confirmaci√≥n clara del cliente"
      }
    ],
    "recursos_sugeridos": [
      "Video: T√©cnicas de cierre efectivas en cobranzas",
      "Documento: 10 frases de validaci√≥n que funcionan"
    ]
  },
  
  "progreso_vs_anterior": {
    "score_cambio": 3,
    "validacion_cambio": -5,
    "objetivo_anterior_cumplido": false,
    "notas": "Score mejor√≥ pero validaci√≥n empeor√≥. El foco de esta semana debe ser 100% en t√©cnica de cierre."
  },
  
  "generado_por": "agente_coach",
  "modelo_usado": "claude-opus-4-5-20250514"
}
```

### Notificaci√≥n al Agente (Email/In-App)

```json
{
  "to": "maria.gonzalez@360.com",
  "subject": "üìä Tu reporte de coaching - 30 Ene 2026",
  "template": "coaching_daily",
  "data": {
    "nombre": "Mar√≠a",
    "score_semana": 72,
    "ranking": "8/12",
    "fortaleza_principal": "Excelente manejo de objeciones",
    "gap_critico": "Validaci√≥n de compromisos",
    "objetivo_semana": "Lograr validaci√≥n en >75% de compromisos",
    "link_dashboard": "https://nodus.app/mi-coaching"
  }
}
```

### Response

```json
{
  "status": "success",
  "reportes_generados": 12,
  "agentes_procesados": ["a0000000-...", "a0000001-...", ...],
  "notificaciones_enviadas": {
    "supervisores": 2,
    "agentes": 12
  },
  "tiempo_procesamiento_ms": 485000
}
```

---

<a name="agente-estratega"></a>
## 7. Agente Estratega

### Informaci√≥n General

| Propiedad | Valor |
|-----------|-------|
| **Webhook URL** | `POST /webhooks/nodus-estratega` |
| **Trigger** | Cron semanal - Domingos 22:00 (hora local) |
| **Tiempo esperado** | 15-30 minutos |
| **Tecnolog√≠a** | Saturn Studio + Claude Opus 4.5 |
| **Timeout** | 45 minutos |
| **Retries** | 1 |

### Input Format (Cron Trigger)

```json
{
  "trigger_type": "cron_semanal",
  "fecha_reporte": "2026-01-26",
  "semana_numero": 4,
  "periodo_inicio": "2026-01-20",
  "periodo_fin": "2026-01-26",
  "timestamp": "2026-01-26T22:00:00-05:00"
}
```

### Procesamiento Interno (Saturn Studio Flow)

```
1. SELECT todos los an√°lisis de la semana
2. SELECT m√©tricas agregadas diarias
3. SELECT alertas de la semana
4. SELECT top/bottom performers
5. Calcular tendencias temporales (por d√≠a, por hora)
6. Calcular correlaciones (campa√±as, tipos de deuda)
7. LLM (Claude Opus): An√°lisis estrat√©gico profundo
8. INSERT en Supabase: reportes_estrategia
9. Enviar resumen ejecutivo a direcci√≥n
```

### Output Format (INSERT en Supabase)

**Tabla: `reportes_estrategia`**
```json
{
  "reporte_id": "rs000000-0000-0000-0000-000000000001",
  "fecha_reporte": "2026-01-26",
  "semana_numero": 4,
  "periodo_inicio": "2026-01-20",
  "periodo_fin": "2026-01-26",
  
  "resumen_ejecutivo": {
    "total_llamadas": 2847,
    "total_agentes_activos": 12,
    "score_promedio": 72,
    "cambio_vs_anterior": 5,
    "tasa_validacion": 0.52,
    "probabilidad_cumplimiento_promedio": 54,
    "monto_comprometido": 1250000,
    "logros": [
      "Score subi√≥ 5 puntos vs semana anterior",
      "3 agentes superaron el 80% de score"
    ],
    "preocupaciones": [
      "Validaci√≥n sigue en 52% (meta: 70%)",
      "Abandonos aumentaron 8% el viernes"
    ]
  },
  
  "hallazgos_estrategicos": [
    {
      "titulo": "Horario √≥ptimo identificado: 18:00-20:00",
      "categoria": "temporal",
      "descripcion": "Las llamadas entre 18:00 y 20:00 tienen +23% mejor performance que el promedio",
      "hipotesis": "Clientes m√°s receptivos fuera de horario laboral, menos distracciones",
      "recomendacion": "Redistribuir 40% de las llamadas actuales de 10:00-12:00 a 18:00-20:00",
      "impacto_proyectado": {
        "metrica": "score_promedio",
        "mejora_esperada": 8,
        "confianza": "alta"
      }
    },
    {
      "titulo": "Menci√≥n de 'consecuencias legales' aumenta abandono",
      "categoria": "script",
      "descripcion": "Llamadas donde se menciona 'consecuencias legales' tienen 45% m√°s abandono",
      "hipotesis": "Genera reacci√≥n defensiva en lugar de colaborativa",
      "recomendacion": "Reformular como 'opciones para regularizar su situaci√≥n'",
      "impacto_proyectado": {
        "metrica": "tasa_abandono",
        "mejora_esperada": -18,
        "confianza": "alta"
      }
    },
    {
      "titulo": "Campa√±a 'Gesti√≥n Temprana' supera a 'Recuperaci√≥n'",
      "categoria": "campana",
      "descripcion": "Score promedio 78 vs 68. Validaci√≥n 65% vs 45%",
      "hipotesis": "Clientes con menos mora son m√°s receptivos",
      "recomendacion": "Priorizar contacto temprano. Replicar scripts de Gesti√≥n Temprana en Recuperaci√≥n",
      "impacto_proyectado": {
        "metrica": "cumplimiento_real",
        "mejora_esperada": 15,
        "confianza": "media"
      }
    }
  ],
  
  "analisis_temporal": {
    "mejor_dia": "Mi√©rcoles",
    "mejor_dia_score": 75,
    "peor_dia": "Lunes",
    "peor_dia_score": 68,
    "mejor_hora": "18:00-20:00",
    "mejor_hora_score": 78,
    "tendencias_por_dia": [
      {"dia": "Lunes", "llamadas": 420, "score": 68},
      {"dia": "Martes", "llamadas": 445, "score": 71},
      {"dia": "Mi√©rcoles", "llamadas": 412, "score": 75},
      {"dia": "Jueves", "llamadas": 438, "score": 73},
      {"dia": "Viernes", "llamadas": 398, "score": 70},
      {"dia": "S√°bado", "llamadas": 380, "score": 74},
      {"dia": "Domingo", "llamadas": 354, "score": 72}
    ],
    "tendencias_por_hora": [
      {"hora": "09:00-10:00", "score": 67},
      {"hora": "10:00-12:00", "score": 70},
      {"hora": "12:00-14:00", "score": 68},
      {"hora": "14:00-16:00", "score": 71},
      {"hora": "16:00-18:00", "score": 73},
      {"hora": "18:00-20:00", "score": 78},
      {"hora": "20:00-21:00", "score": 74}
    ]
  },
  
  "top_performers": [
    {
      "agente_id": "a0000000-0000-0000-0000-000000000001",
      "nombre": "Carlos Ram√≠rez",
      "score": 89,
      "llamadas": 45,
      "tasa_validacion": 0.94,
      "patron_clave": "Cierre con pregunta directa + pausa para respuesta",
      "recomendacion": "Usar como mentor para t√©cnica de validaci√≥n"
    },
    {
      "agente_id": "a0000000-0000-0000-0000-000000000005",
      "nombre": "Luis Torres",
      "score": 85,
      "llamadas": 42,
      "tasa_validacion": 0.88,
      "patron_clave": "Excelente manejo de objeciones econ√≥micas",
      "recomendacion": "Crear material de capacitaci√≥n basado en sus llamadas"
    }
  ],
  
  "agentes_en_riesgo": [
    {
      "agente_id": "a0000000-0000-0000-0000-000000000003",
      "nombre": "Jos√© P√©rez",
      "score": 45,
      "llamadas": 38,
      "tasa_validacion": 0.15,
      "gap_principal": "Manejo de objeciones y t√©cnica de cierre",
      "accion_urgente": "Sesi√≥n de coaching intensivo esta semana"
    }
  ],
  
  "analisis_campanas": [
    {
      "campana": "Gesti√≥n Temprana",
      "llamadas": 1245,
      "score_promedio": 78,
      "tasa_validacion": 0.65,
      "insights": "Mejor rendimiento global. Clientes m√°s receptivos.",
      "recomendaciones": "Modelo a seguir para otras campa√±as"
    },
    {
      "campana": "Recuperaci√≥n Q1",
      "llamadas": 1602,
      "score_promedio": 68,
      "tasa_validacion": 0.45,
      "insights": "M√°s volumen pero menor efectividad. Alta tasa de abandono.",
      "recomendaciones": "Revisar script y considerar segmentaci√≥n por mora"
    }
  ],
  
  "recomendaciones_estrategicas": [
    {
      "prioridad": "alta",
      "area": "operaciones",
      "recomendacion": "Redistribuir 40% de llamadas al horario 18:00-20:00",
      "impacto_esperado": "+8 puntos en score promedio",
      "recursos_necesarios": "Ajuste de turnos, posible incentivo nocturno",
      "deadline": "2026-02-03"
    },
    {
      "prioridad": "alta",
      "area": "scripts",
      "recomendacion": "Eliminar menciones de 'consecuencias legales' del script",
      "impacto_esperado": "-18% en tasa de abandono",
      "recursos_necesarios": "Revisi√≥n y aprobaci√≥n de nuevo script",
      "deadline": "2026-01-31"
    },
    {
      "prioridad": "media",
      "area": "coaching",
      "recomendacion": "Programa de mentor√≠a: Carlos y Luis como mentores",
      "impacto_esperado": "+15% en validaci√≥n del equipo",
      "recursos_necesarios": "2 horas semanales de Carlos y Luis",
      "deadline": "2026-02-15"
    }
  ],
  
  "proyecciones": {
    "score_proyectado_siguiente_semana": 75,
    "cumplimiento_proyectado": 58,
    "riesgos_identificados": [
      "Jos√© P√©rez podr√≠a afectar m√©tricas del equipo si no mejora",
      "Fin de mes puede generar m√°s abandonos por presi√≥n"
    ],
    "oportunidades": [
      "Horario nocturno sin explotar completamente",
      "2 agentes cerca de superar 85 de score"
    ]
  },
  
  "generado_por": "agente_estratega",
  "modelo_usado": "claude-opus-4-5-20250514"
}
```

### Email Resumen Ejecutivo (‚Üí Direcci√≥n)

```json
{
  "to": ["direccion@360consultores.com", "fernando@360consultores.com"],
  "subject": "üìà NODUS - Resumen Semanal | Semana 4",
  "template": "estrategia_semanal",
  "data": {
    "semana": 4,
    "total_llamadas": 2847,
    "score_promedio": 72,
    "cambio": "+5",
    "monto_comprometido": "S/. 1,250,000",
    "top_hallazgo": "Horario 18:00-20:00 tiene +23% mejor performance",
    "top_recomendacion": "Redistribuir 40% de llamadas a horario nocturno",
    "top_performer": "Carlos Ram√≠rez (89/100)",
    "link_reporte": "https://nodus.app/estrategia/semana-4"
  }
}
```

---

<a name="agente-conversacional"></a>
## 8. Agente Conversacional

### Informaci√≥n General

| Propiedad | Valor |
|-----------|-------|
| **Webhook URL** | `POST /webhooks/nodus-chat` |
| **Trigger** | On-demand (usuario env√≠a pregunta) |
| **Tiempo esperado** | 2-5 segundos |
| **Tecnolog√≠a** | Saturn Studio + Claude Sonnet 4.5 + RAG |
| **Timeout** | 30 segundos |
| **Retries** | 1 |

### Input Format

```json
{
  "user_id": "a0000000-0000-0000-0000-000000000006",
  "session_id": "sess-123456",
  "pregunta": "¬øC√≥mo le fue a Mar√≠a esta semana?",
  "contexto_conversacion": [
    {
      "role": "user",
      "content": "Hola",
      "timestamp": "2026-01-30T10:00:00Z"
    },
    {
      "role": "assistant",
      "content": "¬°Hola! Soy el asistente de NODUS. ¬øEn qu√© puedo ayudarte?",
      "timestamp": "2026-01-30T10:00:02Z"
    }
  ]
}
```

### Procesamiento Interno (Saturn Studio Flow)

```
1. Analizar intenci√≥n de la pregunta
2. Identificar entidades (agentes, fechas, m√©tricas)
3. RAG: Buscar datos relevantes en Supabase
   - Si pregunta por agente ‚Üí SELECT agente + m√©tricas + coaching
   - Si pregunta por alertas ‚Üí SELECT alertas activas
   - Si pregunta por tendencias ‚Üí SELECT m√©tricas agregadas
   - Si pregunta estrat√©gica ‚Üí SELECT reporte_estrategia
4. LLM (Claude Sonnet): Generar respuesta natural
5. Enriquecer respuesta (sugerir visualizaciones, acciones)
6. Retornar respuesta
```

### Ejemplos de Preguntas y RAG

| Pregunta | Queries RAG |
|----------|-------------|
| "¬øC√≥mo le fue a Mar√≠a?" | `get_agente_metrics(maria_id)`, `SELECT FROM coaching_reports WHERE agente_id = ?` |
| "¬øHay alertas cr√≠ticas?" | `get_alertas_activas('critica')` |
| "¬øCu√°l es el mejor horario?" | `SELECT FROM reportes_estrategia ORDER BY fecha DESC LIMIT 1` |
| "Mu√©strame las √∫ltimas llamadas" | `search_registros(limit=10)` |
| "¬øPor qu√© baj√≥ el score ayer?" | `get_tendencias_diarias()`, `SELECT alertas WHERE fecha = ayer` |

### Output Format (Response)

```json
{
  "message_id": "msg-789012",
  "session_id": "sess-123456",
  
  "respuesta": {
    "texto": "Mar√≠a Gonz√°lez realiz√≥ **23 llamadas** en los √∫ltimos 5 d√≠as.\n\nüìä **M√©tricas:**\n- Score promedio: **72/100** (sobre el promedio del equipo de 78)\n- Tasa de validaci√≥n: **32%** (muy por debajo del equipo: 61%)\n- Probabilidad de cumplimiento: **48%**\n\n‚ö†Ô∏è **Gap identificado:** Validaci√≥n de compromisos\n\nSu plan de mejora esta semana se enfoca en lograr validaci√≥n expl√≠cita en m√°s del 75% de sus llamadas.",
    
    "visualizaciones": [
      {
        "tipo": "line_chart",
        "titulo": "Score de Mar√≠a - √öltimos 7 d√≠as",
        "data": {
          "labels": ["24 Ene", "25 Ene", "26 Ene", "27 Ene", "28 Ene", "29 Ene", "30 Ene"],
          "datasets": [
            {"label": "Mar√≠a", "data": [68, 70, 72, 75, 71, 73, 72]},
            {"label": "Equipo", "data": [76, 77, 78, 78, 79, 78, 78]}
          ]
        }
      },
      {
        "tipo": "progress_bar",
        "titulo": "Validaci√≥n vs Meta",
        "data": {"actual": 32, "meta": 75, "equipo": 61}
      }
    ],
    
    "acciones_sugeridas": [
      {
        "tipo": "ver_detalle",
        "label": "Ver perfil completo de Mar√≠a",
        "accion": "navigate",
        "url": "/agentes/a0000000-0000-0000-0000-000000000002"
      },
      {
        "tipo": "ver_coaching",
        "label": "Ver plan de coaching",
        "accion": "navigate",
        "url": "/coaching/a0000000-0000-0000-0000-000000000002"
      },
      {
        "tipo": "ver_llamadas",
        "label": "Ver sus llamadas",
        "accion": "filter",
        "params": {"agente_id": "a0000000-0000-0000-0000-000000000002"}
      }
    ],
    
    "preguntas_relacionadas": [
      "¬øQu√© llamadas deber√≠a revisar Mar√≠a?",
      "¬øC√≥mo se compara con el mes pasado?",
      "¬øQui√©n es el mejor agente del equipo?"
    ]
  },
  
  "metadata": {
    "queries_ejecutadas": 3,
    "tokens_usados": 450,
    "tiempo_procesamiento_ms": 2800
  }
}
```

---

<a name="supabase-realtime"></a>
## 9. Integraci√≥n Supabase Realtime

### Configuraci√≥n en la Web App

```typescript
// src/lib/supabase-realtime.ts
import { createClient } from '@supabase/supabase-js'

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
)

// ===== SUSCRIPCIONES REALTIME =====

// 1. Nuevos registros de llamadas (para dashboard)
export function subscribeToNewRegistros(callback: (payload: any) => void) {
  return supabase
    .channel('registro_llamadas_changes')
    .on(
      'postgres_changes',
      {
        event: 'INSERT',
        schema: 'public',
        table: 'registro_llamadas'
      },
      (payload) => callback(payload.new)
    )
    .subscribe()
}

// 2. Actualizaciones de an√°lisis (cuando se completa)
export function subscribeToAnalisisUpdates(callback: (payload: any) => void) {
  return supabase
    .channel('analisis_changes')
    .on(
      'postgres_changes',
      {
        event: 'INSERT',
        schema: 'public',
        table: 'analisis_llamadas'
      },
      (payload) => callback(payload.new)
    )
    .subscribe()
}

// 3. Nuevas alertas (para notificaciones en tiempo real)
export function subscribeToAlertas(callback: (payload: any) => void) {
  return supabase
    .channel('alertas_changes')
    .on(
      'postgres_changes',
      {
        event: 'INSERT',
        schema: 'public',
        table: 'alertas_anomalias',
        filter: 'estado=eq.nueva'
      },
      (payload) => callback(payload.new)
    )
    .subscribe()
}

// 4. Actualizaciones de coaching (para agentes)
export function subscribeToCoaching(agenteId: string, callback: (payload: any) => void) {
  return supabase
    .channel(`coaching_${agenteId}`)
    .on(
      'postgres_changes',
      {
        event: 'INSERT',
        schema: 'public',
        table: 'coaching_reports',
        filter: `agente_id=eq.${agenteId}`
      },
      (payload) => callback(payload.new)
    )
    .subscribe()
}

// 5. Reportes de estrategia (para direcci√≥n)
export function subscribeToEstrategia(callback: (payload: any) => void) {
  return supabase
    .channel('estrategia_changes')
    .on(
      'postgres_changes',
      {
        event: 'INSERT',
        schema: 'public',
        table: 'reportes_estrategia'
      },
      (payload) => callback(payload.new)
    )
    .subscribe()
}
```

### Uso en Componentes React

```typescript
// src/components/Dashboard.tsx
import { useEffect, useState } from 'react'
import { subscribeToNewRegistros, subscribeToAlertas } from '@/lib/supabase-realtime'

export function Dashboard() {
  const [llamadasHoy, setLlamadasHoy] = useState(0)
  const [alertasActivas, setAlertasActivas] = useState([])

  useEffect(() => {
    // Suscribirse a nuevos registros
    const registrosSub = subscribeToNewRegistros((nuevoRegistro) => {
      setLlamadasHoy(prev => prev + 1)
      // Mostrar toast de nueva llamada
      toast.info(`Nueva llamada de ${nuevoRegistro.cliente_ref}`)
    })

    // Suscribirse a alertas
    const alertasSub = subscribeToAlertas((nuevaAlerta) => {
      setAlertasActivas(prev => [nuevaAlerta, ...prev])
      // Notificaci√≥n seg√∫n severidad
      if (nuevaAlerta.severidad === 'critica') {
        toast.error(`üö® ALERTA CR√çTICA: ${nuevaAlerta.descripcion}`)
      }
    })

    return () => {
      registrosSub.unsubscribe()
      alertasSub.unsubscribe()
    }
  }, [])

  return (
    // ... UI del dashboard
  )
}
```

### Eventos Realtime por Tabla

| Tabla | Eventos | Uso en Web |
|-------|---------|------------|
| `registro_llamadas` | INSERT, UPDATE | Contador en dashboard, lista de llamadas |
| `transcripciones` | INSERT | Indicador de procesamiento |
| `analisis_llamadas` | INSERT | Actualizar scores, m√©tricas |
| `alertas_anomalias` | INSERT, UPDATE | Notificaciones, badge de alertas |
| `coaching_reports` | INSERT | Notificaci√≥n a agentes |
| `reportes_estrategia` | INSERT | Notificaci√≥n a direcci√≥n |
| `metricas_agregadas` | UPDATE | Refrescar gr√°ficos de tendencias |

---

<a name="webhooks-saturn"></a>
## 10. Webhooks de Saturn Studio

### Resumen de Endpoints

| Agente | M√©todo | URL | Trigger |
|--------|--------|-----|---------|
| Transcriptor | POST | `/webhooks/nodus-transcriptor` | Nuevo audio |
| Analista | POST | `/webhooks/nodus-analista` | Post-transcripci√≥n |
| Detector | POST | `/webhooks/nodus-detector` | Post-an√°lisis + Cron 30min |
| Coach | POST | `/webhooks/nodus-coach` | Cron diario 08:00 |
| Estratega | POST | `/webhooks/nodus-estratega` | Cron semanal DOM 22:00 |
| Conversacional | POST | `/webhooks/nodus-chat` | On-demand |

### Headers Comunes

```
Content-Type: application/json
X-Nodus-Version: 1.0
X-Nodus-Timestamp: 2026-01-30T14:30:00Z
X-Nodus-Signature: sha256=abc123... (opcional, para verificaci√≥n)
```

### Respuestas Est√°ndar

**Success (2xx)**
```json
{
  "status": "success",
  "data": { ... },
  "timestamp": "2026-01-30T14:30:05Z"
}
```

**Error (4xx/5xx)**
```json
{
  "status": "error",
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Campo audio_url es requerido",
    "details": { ... }
  },
  "timestamp": "2026-01-30T14:30:05Z"
}
```

### Configuraci√≥n de Cron en Saturn Studio

```yaml
# cron-config.yaml
schedules:
  - name: detector_sistemico
    webhook: /webhooks/nodus-detector
    cron: "*/30 * * * *"  # Cada 30 minutos
    payload:
      trigger_type: cron_sistemico
    
  - name: coach_diario
    webhook: /webhooks/nodus-coach
    cron: "0 8 * * *"  # 08:00 todos los d√≠as
    timezone: America/Lima
    payload:
      trigger_type: cron_diario
      periodo_dias: 5
    
  - name: estratega_semanal
    webhook: /webhooks/nodus-estratega
    cron: "0 22 * * 0"  # Domingos 22:00
    timezone: America/Lima
    payload:
      trigger_type: cron_semanal
```

---

<a name="diagrama-secuencia"></a>
## 11. Diagrama de Secuencia Completo

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  DRIVE   ‚îÇ ‚îÇ TRANSCRIPTOR ‚îÇ ‚îÇ  ANALISTA  ‚îÇ ‚îÇ DETECTOR ‚îÇ ‚îÇ  COACH   ‚îÇ ‚îÇESTRATEGA‚îÇ ‚îÇSUPABASE ‚îÇ ‚îÇ   WEB   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ              ‚îÇ               ‚îÇ             ‚îÇ            ‚îÇ            ‚îÇ           ‚îÇ           ‚îÇ
     ‚îÇ 1. Audio     ‚îÇ               ‚îÇ             ‚îÇ            ‚îÇ            ‚îÇ           ‚îÇ           ‚îÇ
     ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ               ‚îÇ             ‚îÇ            ‚îÇ            ‚îÇ           ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ             ‚îÇ            ‚îÇ            ‚îÇ           ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ 2. INSERT     ‚îÇ             ‚îÇ            ‚îÇ            ‚îÇ           ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ Realtime  ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ             ‚îÇ            ‚îÇ            ‚îÇ           ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
     ‚îÇ              ‚îÇ 3. Webhook    ‚îÇ             ‚îÇ            ‚îÇ            ‚îÇ           ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ             ‚îÇ            ‚îÇ            ‚îÇ           ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ             ‚îÇ            ‚îÇ            ‚îÇ           ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ 4. INSERT   ‚îÇ            ‚îÇ            ‚îÇ           ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ Realtime  ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ             ‚îÇ            ‚îÇ            ‚îÇ           ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ             ‚îÇ            ‚îÇ            ‚îÇ           ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ 5. Webhook  ‚îÇ            ‚îÇ            ‚îÇ           ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ (si alerta) ‚îÇ            ‚îÇ            ‚îÇ           ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ            ‚îÇ            ‚îÇ           ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ             ‚îÇ            ‚îÇ            ‚îÇ           ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ             ‚îÇ 6. INSERT  ‚îÇ            ‚îÇ           ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ             ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ Realtime  ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ             ‚îÇ            ‚îÇ            ‚îÇ           ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ             ‚îÇ            ‚îÇ            ‚îÇ           ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ             ‚îÇ            ‚îÇ            ‚îÇ           ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ      [CRON 08:00]       ‚îÇ            ‚îÇ           ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ             ‚îÇ            ‚îÇ            ‚îÇ           ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ             ‚îÇ 7. SELECT  ‚îÇ            ‚îÇ           ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ             ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ             ‚îÇ            ‚îÇ            ‚îÇ           ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ             ‚îÇ            ‚îÇ 8. INSERT  ‚îÇ           ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ             ‚îÇ            ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ Realtime  ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ             ‚îÇ            ‚îÇ            ‚îÇ           ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ             ‚îÇ            ‚îÇ            ‚îÇ           ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ      [CRON DOM 22:00]   ‚îÇ            ‚îÇ           ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ             ‚îÇ            ‚îÇ            ‚îÇ           ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ             ‚îÇ            ‚îÇ 9. SELECT  ‚îÇ           ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ             ‚îÇ            ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ             ‚îÇ            ‚îÇ            ‚îÇ           ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ             ‚îÇ            ‚îÇ 10. INSERT ‚îÇ           ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ             ‚îÇ            ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ Realtime  ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ             ‚îÇ            ‚îÇ            ‚îÇ           ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ             ‚îÇ            ‚îÇ            ‚îÇ           ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ             ‚îÇ            ‚îÇ            ‚îÇ           ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ             ‚îÇ            ‚îÇ            ‚îÇ           ‚îÇ  Usuario  ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ             ‚îÇ            ‚îÇ            ‚îÇ           ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ             ‚îÇ            ‚îÇ            ‚îÇ           ‚îÇ pregunta  ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ             ‚îÇ            ‚îÇ            ‚îÇ           ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ 11. CHAT    ‚îÇ            ‚îÇ            ‚îÇ           ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ             ‚îÇ            ‚îÇ            ‚îÇ           ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ 12. SELECT  ‚îÇ            ‚îÇ            ‚îÇ           ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ             ‚îÇ            ‚îÇ            ‚îÇ           ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ 13. Response‚îÇ            ‚îÇ            ‚îÇ           ‚îÇ           ‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
     ‚îÇ              ‚îÇ               ‚îÇ             ‚îÇ            ‚îÇ            ‚îÇ           ‚îÇ           ‚îÇ
     ‚ñº              ‚ñº               ‚ñº             ‚ñº            ‚ñº            ‚ñº           ‚ñº           ‚ñº
```

---

## üìã Checklist de Implementaci√≥n

### Saturn Studio
- [ ] Crear webhook `/webhooks/nodus-transcriptor`
- [ ] Crear webhook `/webhooks/nodus-analista`
- [ ] Crear webhook `/webhooks/nodus-detector`
- [ ] Crear webhook `/webhooks/nodus-coach`
- [ ] Crear webhook `/webhooks/nodus-estratega`
- [ ] Crear webhook `/webhooks/nodus-chat`
- [ ] Configurar crons (Detector 30min, Coach 08:00, Estratega DOM 22:00)
- [ ] Conectar AI Studio para transcripci√≥n/emociones
- [ ] Configurar LLM (Claude Opus/Sonnet)

### Supabase
- [ ] Ejecutar `schema.sql`
- [ ] Ejecutar `functions.sql`
- [ ] Configurar Realtime para tablas principales
- [ ] Crear service role key para Saturn Studio
- [ ] (Opcional) Configurar RLS

### Web App
- [ ] Implementar suscripciones Realtime
- [ ] Crear componentes de notificaci√≥n
- [ ] Integrar chat conversacional

### Integraciones Externas
- [ ] Configurar trigger de Google Drive
- [ ] Configurar Slack webhook para alertas
- [ ] Configurar email para notificaciones

---

**Documento creado**: Enero 2026  
**Versi√≥n**: 1.0  
**Autor**: Sistema NODUS
</file>

<file path="docs/implementacion_modulos_dashboard.md">
# Plan de Implementacion: Dashboard de Modulos de Analisis

## Vision General

Integrar los 3 pilares de Speech Analytics en el dashboard de NODUS:
1. **Contacto Directo** - Calidad de la comunicacion inicial
2. **Compromiso de Pago** - Efectividad en cerrar acuerdos
3. **Abandono de Llamadas** - Patrones de desconexion

---

## Mapeo: Presentacion vs Base de Datos

### La base de datos YA tiene la estructura correcta:

| Concepto Presentacion | Campo en `analisis_llamadas` |
|----------------------|------------------------------|
| Contacto Directo | `modulo_contacto_directo` JSONB |
| Compromiso de Pago | `modulo_compromiso_pago` JSONB |
| Abandono | `modulo_abandono` JSONB |
| Score Total | `score_total` INTEGER |
| Probabilidad | `probabilidad_cumplimiento` INTEGER |

### Estructura JSONB existente:

**modulo_contacto_directo:**
```json
{
  "score": 0,
  "desglose": {
    "monto_mencionado": {"presente": false, "puntos": 0, "max": 25},
    "fecha_vencimiento": {"presente": false, "puntos": 0, "max": 15},
    "consecuencias_impago": {"presente": false, "puntos": 0, "max": 20},
    "alternativas_pago": {"presente": false, "puntos": 0, "max": 15},
    "manejo_objeciones": {"calidad": 0, "puntos": 0, "max": 25}
  }
}
```

**modulo_compromiso_pago:**
```json
{
  "score": 0,
  "desglose": {
    "oferta_clara": {"presente": false, "puntos": 0, "max": 20},
    "alternativas_pago": {"presente": false, "puntos": 0, "max": 10},
    "fecha_especifica": {"presente": false, "puntos": 0, "max": 20},
    "validacion_cliente": {"presente": false, "tipo": "ninguna", "puntos": 0, "max": 50}
  }
}
```

**modulo_abandono:**
```json
{
  "hubo_abandono": false,
  "momento_segundos": null,
  "iniciado_por": null,
  "razon": null,
  "senales_previas": []
}
```

---

## Fase 1: Vistas SQL (Sin modificar tablas)

### Vista 1: Resumen Global de Modulos

```sql
CREATE OR REPLACE VIEW vista_modulos_global AS
SELECT
    -- Periodo
    DATE_TRUNC('day', fecha_llamada) as fecha,
    
    -- Totales
    COUNT(*) as total_llamadas,
    
    -- MODULO 1: Contacto Directo
    ROUND(AVG(score_contacto_directo), 1) as avg_contacto_directo,
    ROUND(AVG((modulo_contacto_directo->'desglose'->'monto_mencionado'->>'puntos')::numeric), 1) as avg_monto,
    ROUND(AVG((modulo_contacto_directo->'desglose'->'fecha_vencimiento'->>'puntos')::numeric), 1) as avg_fecha_venc,
    ROUND(AVG((modulo_contacto_directo->'desglose'->'consecuencias_impago'->>'puntos')::numeric), 1) as avg_consecuencias,
    ROUND(AVG((modulo_contacto_directo->'desglose'->'alternativas_pago'->>'puntos')::numeric), 1) as avg_alternativas_cd,
    ROUND(AVG((modulo_contacto_directo->'desglose'->'manejo_objeciones'->>'puntos')::numeric), 1) as avg_objeciones,
    
    -- Porcentaje de cumplimiento por variable
    ROUND(100.0 * COUNT(*) FILTER (WHERE (modulo_contacto_directo->'desglose'->'monto_mencionado'->>'presente')::boolean) / NULLIF(COUNT(*), 0), 1) as pct_menciona_monto,
    ROUND(100.0 * COUNT(*) FILTER (WHERE (modulo_contacto_directo->'desglose'->'fecha_vencimiento'->>'presente')::boolean) / NULLIF(COUNT(*), 0), 1) as pct_menciona_fecha,
    ROUND(100.0 * COUNT(*) FILTER (WHERE (modulo_contacto_directo->'desglose'->'consecuencias_impago'->>'presente')::boolean) / NULLIF(COUNT(*), 0), 1) as pct_menciona_consecuencias,
    
    -- MODULO 2: Compromiso de Pago
    ROUND(AVG(score_compromiso_pago), 1) as avg_compromiso_pago,
    ROUND(AVG((modulo_compromiso_pago->'desglose'->'oferta_clara'->>'puntos')::numeric), 1) as avg_oferta_clara,
    ROUND(AVG((modulo_compromiso_pago->'desglose'->'alternativas_pago'->>'puntos')::numeric), 1) as avg_alternativas_cp,
    ROUND(AVG((modulo_compromiso_pago->'desglose'->'fecha_especifica'->>'puntos')::numeric), 1) as avg_fecha_especifica,
    ROUND(AVG((modulo_compromiso_pago->'desglose'->'validacion_cliente'->>'puntos')::numeric), 1) as avg_validacion,
    
    -- Porcentaje con validacion
    ROUND(100.0 * COUNT(*) FILTER (WHERE (modulo_compromiso_pago->'desglose'->'validacion_cliente'->>'presente')::boolean) / NULLIF(COUNT(*), 0), 1) as pct_con_validacion,
    
    -- MODULO 3: Abandono
    COUNT(*) FILTER (WHERE (modulo_abandono->>'hubo_abandono')::boolean) as llamadas_con_abandono,
    ROUND(100.0 * COUNT(*) FILTER (WHERE (modulo_abandono->>'hubo_abandono')::boolean) / NULLIF(COUNT(*), 0), 1) as tasa_abandono,
    
    -- Probabilidad promedio
    ROUND(AVG(probabilidad_cumplimiento), 1) as avg_probabilidad_cumplimiento
    
FROM analisis_llamadas
WHERE fecha_llamada >= CURRENT_DATE - INTERVAL '30 days'
GROUP BY DATE_TRUNC('day', fecha_llamada)
ORDER BY fecha DESC;
```

### Vista 2: Detalle de Compromiso por Elementos

```sql
CREATE OR REPLACE VIEW vista_compromiso_elementos AS
WITH elementos AS (
    SELECT
        analisis_id,
        fecha_llamada,
        probabilidad_cumplimiento,
        (modulo_compromiso_pago->'desglose'->'oferta_clara'->>'presente')::boolean as tiene_oferta,
        (modulo_compromiso_pago->'desglose'->'alternativas_pago'->>'presente')::boolean as tiene_alternativas,
        (modulo_compromiso_pago->'desglose'->'fecha_especifica'->>'presente')::boolean as tiene_fecha,
        (modulo_compromiso_pago->'desglose'->'validacion_cliente'->>'presente')::boolean as tiene_validacion
    FROM analisis_llamadas
    WHERE fecha_llamada >= CURRENT_DATE - INTERVAL '30 days'
),
clasificacion AS (
    SELECT
        *,
        CASE
            WHEN NOT tiene_oferta AND NOT tiene_alternativas AND NOT tiene_fecha AND NOT tiene_validacion THEN 'sin_elementos'
            WHEN tiene_oferta AND NOT tiene_alternativas AND NOT tiene_fecha AND NOT tiene_validacion THEN 'solo_oferta'
            WHEN tiene_oferta AND tiene_alternativas AND NOT tiene_fecha AND NOT tiene_validacion THEN 'oferta_alternativas'
            WHEN tiene_oferta AND tiene_alternativas AND tiene_fecha AND NOT tiene_validacion THEN 'tres_elementos'
            WHEN tiene_oferta AND tiene_alternativas AND tiene_fecha AND tiene_validacion THEN 'acuerdo_completo'
            ELSE 'parcial'
        END as categoria
    FROM elementos
)
SELECT
    categoria,
    COUNT(*) as total_llamadas,
    ROUND(AVG(probabilidad_cumplimiento), 1) as prob_promedio,
    ROUND(100.0 * COUNT(*) / NULLIF(SUM(COUNT(*)) OVER (), 0), 1) as porcentaje
FROM clasificacion
GROUP BY categoria
ORDER BY 
    CASE categoria
        WHEN 'sin_elementos' THEN 1
        WHEN 'solo_oferta' THEN 2
        WHEN 'oferta_alternativas' THEN 3
        WHEN 'tres_elementos' THEN 4
        WHEN 'acuerdo_completo' THEN 5
        ELSE 6
    END;
```

### Vista 3: Analisis de Abandonos

```sql
CREATE OR REPLACE VIEW vista_abandonos_detalle AS
SELECT
    -- Momento del abandono (rangos)
    CASE 
        WHEN (modulo_abandono->>'momento_segundos')::int <= 30 THEN '0-30 seg'
        WHEN (modulo_abandono->>'momento_segundos')::int <= 60 THEN '31-60 seg'
        WHEN (modulo_abandono->>'momento_segundos')::int <= 120 THEN '1-2 min'
        ELSE '> 2 min'
    END as momento_rango,
    
    -- Razon
    modulo_abandono->>'razon' as razon,
    
    -- Iniciado por
    modulo_abandono->>'iniciado_por' as iniciado_por,
    
    -- Conteos
    COUNT(*) as total,
    ROUND(100.0 * COUNT(*) / NULLIF(SUM(COUNT(*)) OVER (), 0), 1) as porcentaje
    
FROM analisis_llamadas
WHERE 
    fecha_llamada >= CURRENT_DATE - INTERVAL '30 days'
    AND (modulo_abandono->>'hubo_abandono')::boolean = true
GROUP BY 
    momento_rango,
    modulo_abandono->>'razon',
    modulo_abandono->>'iniciado_por'
ORDER BY total DESC;
```

### Vista 4: Metricas por Agente (3 Modulos)

```sql
CREATE OR REPLACE VIEW vista_agente_modulos AS
SELECT
    a.agente_id,
    ag.nombre as agente_nombre,
    ag.equipo,
    
    -- Totales
    COUNT(*) as total_llamadas,
    
    -- Modulo 1: Contacto Directo
    ROUND(AVG(a.score_contacto_directo), 1) as score_contacto,
    ROUND(100.0 * COUNT(*) FILTER (WHERE (a.modulo_contacto_directo->'desglose'->'monto_mencionado'->>'presente')::boolean) / NULLIF(COUNT(*), 0), 1) as pct_monto,
    ROUND(100.0 * COUNT(*) FILTER (WHERE (a.modulo_contacto_directo->'desglose'->'manejo_objeciones'->>'calidad')::int >= 3) / NULLIF(COUNT(*), 0), 1) as pct_buen_manejo_objeciones,
    
    -- Modulo 2: Compromiso de Pago
    ROUND(AVG(a.score_compromiso_pago), 1) as score_compromiso,
    ROUND(100.0 * COUNT(*) FILTER (WHERE (a.modulo_compromiso_pago->'desglose'->'validacion_cliente'->>'presente')::boolean) / NULLIF(COUNT(*), 0), 1) as pct_validacion,
    
    -- Modulo 3: Abandono
    ROUND(100.0 * COUNT(*) FILTER (WHERE (a.modulo_abandono->>'hubo_abandono')::boolean) / NULLIF(COUNT(*), 0), 1) as tasa_abandono,
    
    -- Score Total y Probabilidad
    ROUND(AVG(a.score_total), 1) as score_total,
    ROUND(AVG(a.probabilidad_cumplimiento), 1) as prob_cumplimiento
    
FROM analisis_llamadas a
JOIN agentes ag ON a.agente_id = ag.agente_id
WHERE a.fecha_llamada >= CURRENT_DATE - INTERVAL '7 days'
GROUP BY a.agente_id, ag.nombre, ag.equipo
ORDER BY score_total DESC;
```

### Vista 5: Evolucion Semanal

```sql
CREATE OR REPLACE VIEW vista_evolucion_semanal AS
SELECT
    DATE_TRUNC('week', fecha_llamada) as semana,
    
    -- Scores promedio
    ROUND(AVG(score_total), 1) as score_total,
    ROUND(AVG(score_contacto_directo), 1) as score_contacto,
    ROUND(AVG(score_compromiso_pago), 1) as score_compromiso,
    
    -- Tasa de validacion (clave del modelo)
    ROUND(100.0 * COUNT(*) FILTER (WHERE (modulo_compromiso_pago->'desglose'->'validacion_cliente'->>'presente')::boolean) / NULLIF(COUNT(*), 0), 1) as tasa_validacion,
    
    -- Tasa de abandono
    ROUND(100.0 * COUNT(*) FILTER (WHERE (modulo_abandono->>'hubo_abandono')::boolean) / NULLIF(COUNT(*), 0), 1) as tasa_abandono,
    
    -- Probabilidad promedio
    ROUND(AVG(probabilidad_cumplimiento), 1) as prob_cumplimiento,
    
    -- Volumen
    COUNT(*) as total_llamadas
    
FROM analisis_llamadas
WHERE fecha_llamada >= CURRENT_DATE - INTERVAL '12 weeks'
GROUP BY DATE_TRUNC('week', fecha_llamada)
ORDER BY semana DESC;
```

---

## Fase 2: Nuevas Paginas del Dashboard

### Estructura de Navegacion Propuesta

```
Dashboard (Home)
|-- Vision General (nuevo)         <- Pagina 1
|-- Modulo 1: Contacto Directo    <- Pagina 2
|-- Modulo 2: Compromiso de Pago  <- Pagina 3
|-- Modulo 3: Abandono            <- Pagina 4
|-- Agentes
|-- Llamadas
|-- Alertas
|-- Chat
```

---

### Pagina 1: Vision General (`/modulos`)

**Contenido:**
- Header con titulo "Tres Pilares para la Excelencia en Cobranza"
- 3 cards grandes (Contacto, Compromiso, Abandono) con:
  - Score promedio del periodo
  - Tendencia vs semana anterior
  - KPI principal de cada modulo
- Grafico de evolucion semanal (line chart con 3 lineas)
- Tabla de agentes con los 3 scores

**Componentes:**
- `ModuloCard` - Card grande para cada pilar
- `EvolucionChart` - Grafico de lineas
- `TablaAgentesModulos` - Tabla comparativa

---

### Pagina 2: Contacto Directo (`/modulos/contacto`)

**Header:** "Analisis del Contacto Directo: La Primera Impresion es Definitiva"

**Seccion 1: Variables Analizadas**
- Cards para cada variable:
  - Claridad en entrega de informacion (monto, fechas, consecuencias)
  - Presentacion de alternativas de pago
  - Manejo de objeciones

**Seccion 2: Cumplimiento por Variable**
- Grafico de barras horizontales mostrando % de llamadas que cumplen cada variable
- Comparativo vs periodo anterior

**Seccion 3: Ranking de Agentes**
- Tabla ordenada por score de contacto directo
- Indicador de fortalezas/debilidades por variable

**Componentes:**
- `VariableCard` - Card con metrica y descripcion
- `CumplimientoBarChart` - Barras horizontales
- `TablaRankingContacto` - Tabla de agentes

---

### Pagina 3: Compromiso de Pago (`/modulos/compromiso`)

**Header:** "Calidad del Compromiso: Convirtiendo Conversaciones en Resultados"

**Seccion 1: Los 4 Pilares**
- 4 cards con las ponderaciones:
  - Oferta Clara (20%)
  - Alternativas de Pago (10%)
  - Fecha Especifica (20%)
  - Validacion del Cliente (50%)

**Seccion 2: Diagrama de Flujo de Probabilidad**
- Visualizacion tipo funnel/steps mostrando:
  - Inicio: 0%
  - +Oferta clara: 20%
  - +Alternativas: 30%
  - +Fecha especifica: 50%
  - +Validacion: 100%

**Seccion 3: Impacto por Elementos**
- Grafico de barras (como en la presentacion):
  - Sin elementos
  - Solo oferta
  - Oferta + alternativas
  - Tres elementos
  - Acuerdo completo

**Seccion 4: Detalle de Validaciones**
- % de llamadas con validacion explicita
- Tipos de validacion detectados
- Frases de cierre mas efectivas (si disponibles)

**Componentes:**
- `PilarCard` - Card con porcentaje de peso
- `ProbabilidadFlow` - Diagrama de flechas/steps
- `ImpactoElementosChart` - Grafico de barras
- `ValidacionMetrics` - Metricas de validacion

---

### Pagina 4: Abandono de Llamadas (`/modulos/abandono`)

**Header:** "Analisis del Abandono de Llamadas: Prevenir la Desconexion"

**Seccion 1: KPIs Principales**
- 3 donut charts grandes:
  - % Abandono en primeros 30 seg
  - % Abandono al mencionar monto
  - % Abandono durante objeciones

**Seccion 2: Recurrencia de Abandonos**
- Patrones detectados:
  - Por agente
  - Por horario
  - Por tipo de deuda
  - Por campana

**Seccion 3: Mapeo del Script**
- Visualizacion de en que parte del script ocurren mas abandonos
- Secciones problematicas identificadas

**Seccion 4: Comparativo por Agente**
- Tabla con tasa de abandono por agente
- Highlight de agentes con alta tasa

**Componentes:**
- `DonutChart` - Grafico circular con porcentaje
- `PatronesAbandono` - Lista de patrones
- `ScriptMapChart` - Heatmap del script
- `TablaAbandonoAgentes` - Tabla comparativa

---

## Fase 3: Componentes Reutilizables

### Nuevos Componentes a Crear

```
src/components/modulos/
|-- ModuloHeader.tsx        # Header con badge y titulo
|-- PilarCard.tsx           # Card para cada pilar/variable
|-- ScoreGauge.tsx          # Gauge circular para scores
|-- TrendIndicator.tsx      # Flecha con % cambio
|-- ProbabilidadFlow.tsx    # Diagrama de flujo
|-- CumplimientoBar.tsx     # Barra de progreso con %
|-- DonutMetric.tsx         # Donut chart con valor central
|-- ModuloTable.tsx         # Tabla generica para modulos
```

### Hooks Nuevos

```
src/hooks/
|-- useModulosGlobal.ts     # Datos de vista_modulos_global
|-- useCompromisoElementos.ts # Datos de vista_compromiso_elementos
|-- useAbandonos.ts          # Datos de vista_abandonos_detalle
|-- useAgentesModulos.ts     # Datos de vista_agente_modulos
|-- useEvolucionSemanal.ts   # Datos de vista_evolucion_semanal
```

---

## Fase 4: Checklist de Implementacion

### SQL (Supabase)

- [ ] Crear `vista_modulos_global`
- [ ] Crear `vista_compromiso_elementos`
- [ ] Crear `vista_abandonos_detalle`
- [ ] Crear `vista_agente_modulos`
- [ ] Crear `vista_evolucion_semanal`
- [ ] Insertar datos de prueba con modulos completos

### Frontend - Setup

- [ ] Crear carpeta `src/components/modulos/`
- [ ] Crear carpeta `src/pages/modulos/`
- [ ] Agregar rutas en `App.tsx`
- [ ] Actualizar navegacion en `Sidebar.tsx`

### Frontend - Pagina 1: Vision General

- [ ] Crear `ModulosOverview.tsx`
- [ ] Implementar `ModuloCard.tsx`
- [ ] Implementar grafico de evolucion
- [ ] Conectar con `useModulosGlobal`

### Frontend - Pagina 2: Contacto Directo

- [ ] Crear `ContactoDirecto.tsx`
- [ ] Implementar cards de variables
- [ ] Implementar grafico de cumplimiento
- [ ] Tabla de ranking

### Frontend - Pagina 3: Compromiso de Pago

- [ ] Crear `CompromisoPago.tsx`
- [ ] Implementar `PilarCard.tsx` con pesos
- [ ] Implementar `ProbabilidadFlow.tsx`
- [ ] Implementar grafico de impacto por elementos

### Frontend - Pagina 4: Abandono

- [ ] Crear `AbandonoLlamadas.tsx`
- [ ] Implementar donut charts
- [ ] Implementar seccion de patrones
- [ ] Tabla de agentes

### Integracion

- [ ] Conectar Realtime a las nuevas vistas
- [ ] Agregar a dashboardStore
- [ ] Testing con datos reales

---

## Cronograma Estimado

| Fase | Duracion | Dependencias |
|------|----------|--------------|
| Fase 1: SQL Views | 1 dia | Ninguna |
| Fase 2: Estructura paginas | 1 dia | Fase 1 |
| Fase 3: Componentes | 2 dias | Fase 2 |
| Fase 4: Integracion | 1 dia | Fase 3 |
| Testing | 1 dia | Fase 4 |

**Total estimado: 6 dias**

---

## Notas Importantes

1. **No se modifica el schema existente** - Solo se crean vistas
2. **Datos de prueba necesarios** - Las vistas necesitan datos en `analisis_llamadas` con los campos JSONB poblados
3. **Realtime** - Las vistas se pueden suscribir igual que las tablas
4. **Performance** - Considerar agregar `MATERIALIZED VIEW` si las queries son lentas
</file>

<file path="public/favicon.svg">
<svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
  <rect width="32" height="32" rx="8" fill="#0D9488"/>
  <circle cx="16" cy="16" r="6" fill="white"/>
  <circle cx="16" cy="16" r="3" fill="#0D9488"/>
</svg>
</file>

<file path="src/components/charts/index.ts">
export * from './ScoreGauge'
export * from './TrendChart'
export * from './MiniBar'
</file>

<file path="src/components/charts/MiniBar.tsx">
import { cn } from '@/lib/utils'
import { motion } from 'framer-motion'

interface MiniBarProps {
  value: number
  max?: number
  color?: 'primary' | 'success' | 'warning' | 'destructive' | 'secondary'
  showValue?: boolean
  size?: 'sm' | 'md'
  label?: string
}

export function MiniBar({ 
  value, 
  max = 100, 
  color = 'primary',
  showValue = true,
  size = 'md',
  label
}: MiniBarProps) {
  const percentage = Math.min((value / max) * 100, 100)

  const colors = {
    primary: 'bg-primary',
    success: 'bg-success',
    warning: 'bg-warning',
    destructive: 'bg-destructive',
    secondary: 'bg-secondary',
  }

  const heights = {
    sm: 'h-1.5',
    md: 'h-2',
  }

  return (
    <div className="w-full">
      {(label || showValue) && (
        <div className="flex items-center justify-between mb-1.5">
          {label && (
            <span className="text-xs text-muted-foreground">{label}</span>
          )}
          {showValue && (
            <span className="text-xs font-mono text-foreground">{value}%</span>
          )}
        </div>
      )}
      <div className={cn("w-full rounded-full bg-muted/50 overflow-hidden", heights[size])}>
        <motion.div 
          className={cn("h-full rounded-full", colors[color])}
          initial={{ width: 0 }}
          animate={{ width: `${percentage}%` }}
          transition={{ duration: 0.8, ease: "easeOut" }}
        />
      </div>
    </div>
  )
}

interface StackedBarProps {
  segments: Array<{
    value: number
    color: 'primary' | 'success' | 'warning' | 'destructive' | 'secondary'
    label?: string
  }>
  total?: number
}

export function StackedBar({ segments, total }: StackedBarProps) {
  const sum = total || segments.reduce((acc, s) => acc + s.value, 0)

  const colors = {
    primary: 'bg-primary',
    success: 'bg-success',
    warning: 'bg-warning',
    destructive: 'bg-destructive',
    secondary: 'bg-secondary',
  }

  return (
    <div className="w-full">
      <div className="h-2 rounded-full bg-muted/50 overflow-hidden flex">
        {segments.map((segment, i) => {
          const percentage = (segment.value / sum) * 100
          return (
            <motion.div
              key={i}
              className={cn("h-full first:rounded-l-full last:rounded-r-full", colors[segment.color])}
              initial={{ width: 0 }}
              animate={{ width: `${percentage}%` }}
              transition={{ duration: 0.8, ease: "easeOut", delay: i * 0.1 }}
            />
          )
        })}
      </div>
      {segments.some(s => s.label) && (
        <div className="flex items-center gap-4 mt-2">
          {segments.map((segment, i) => (
            <div key={i} className="flex items-center gap-1.5">
              <div className={cn("w-2 h-2 rounded-full", colors[segment.color])} />
              <span className="text-xs text-muted-foreground">{segment.label}</span>
            </div>
          ))}
        </div>
      )}
    </div>
  )
}
</file>

<file path="src/components/charts/ScoreGauge.tsx">
import { cn } from '@/lib/utils'

interface ScoreGaugeProps {
  value: number
  max?: number
  size?: 'sm' | 'md' | 'lg'
  label?: string
  showValue?: boolean
}

export function ScoreGauge({ 
  value, 
  max = 100, 
  size = 'md', 
  label,
  showValue = true,
}: ScoreGaugeProps) {
  const percentage = (value / max) * 100
  const circumference = 2 * Math.PI * 45
  const strokeDashoffset = circumference - (percentage / 100) * circumference

  const sizes = {
    sm: { wrapper: 'w-16 h-16', text: 'text-lg', label: 'text-[10px]' },
    md: { wrapper: 'w-24 h-24', text: 'text-2xl', label: 'text-xs' },
    lg: { wrapper: 'w-32 h-32', text: 'text-4xl', label: 'text-sm' },
  }

  const getColor = () => {
    if (percentage >= 70) return { stroke: 'stroke-success', text: 'text-success' }
    if (percentage >= 40) return { stroke: 'stroke-warning', text: 'text-warning' }
    return { stroke: 'stroke-destructive', text: 'text-destructive' }
  }

  const colors = getColor()

  return (
    <div className={cn("relative flex items-center justify-center", sizes[size].wrapper)}>
      <svg className="w-full h-full -rotate-90" viewBox="0 0 100 100">
        <circle
          cx="50"
          cy="50"
          r="45"
          fill="none"
          stroke="currentColor"
          strokeWidth="8"
          className="text-secondary"
        />
        <circle
          cx="50"
          cy="50"
          r="45"
          fill="none"
          strokeWidth="8"
          strokeLinecap="round"
          className={colors.stroke}
          style={{
            strokeDasharray: circumference,
            strokeDashoffset,
            transition: 'stroke-dashoffset 0.5s ease-out',
          }}
        />
      </svg>
      
      <div className="absolute inset-0 flex flex-col items-center justify-center">
        {showValue && (
          <span className={cn("font-semibold", sizes[size].text, colors.text)}>
            {value}
          </span>
        )}
        {label && (
          <span className={cn("text-muted-foreground", sizes[size].label)}>
            {label}
          </span>
        )}
      </div>
    </div>
  )
}
</file>

<file path="src/components/charts/TrendChart.tsx">
import { 
  ResponsiveContainer, 
  AreaChart, 
  Area, 
  XAxis, 
  YAxis, 
  CartesianGrid, 
  Tooltip,
  TooltipProps
} from 'recharts'

interface DataPoint {
  name: string
  value: number
  value2?: number
  [key: string]: string | number | undefined
}

interface TrendChartProps {
  data: DataPoint[]
  dataKey?: string
  dataKey2?: string
  color?: 'primary' | 'success' | 'warning' | 'destructive' | 'coral'
  color2?: 'primary' | 'success' | 'warning' | 'destructive' | 'coral'
  height?: number
  showGrid?: boolean
  showAxis?: boolean
}

const colorMap = {
  primary: { stroke: 'hsl(173, 80%, 40%)', fill: 'hsl(173, 80%, 40%)' },
  success: { stroke: 'hsl(160, 84%, 39%)', fill: 'hsl(160, 84%, 39%)' },
  warning: { stroke: 'hsl(38, 92%, 50%)', fill: 'hsl(38, 92%, 50%)' },
  destructive: { stroke: 'hsl(0, 84%, 60%)', fill: 'hsl(0, 84%, 60%)' },
  coral: { stroke: 'hsl(340, 75%, 55%)', fill: 'hsl(340, 75%, 55%)' },
}

function CustomTooltip({ active, payload, label }: TooltipProps<number, string>) {
  if (active && payload && payload.length) {
    return (
      <div className="bg-popover border border-border rounded-lg shadow-lg px-3 py-2">
        <p className="text-xs text-muted-foreground mb-1">{label}</p>
        {payload.map((entry, index) => (
          <p key={index} className="text-sm font-medium" style={{ color: entry.color }}>
            {entry.value}
          </p>
        ))}
      </div>
    )
  }
  return null
}

export function TrendChart({ 
  data, 
  dataKey = 'value',
  dataKey2,
  color = 'primary',
  color2 = 'coral',
  height = 200,
  showGrid = false,
  showAxis = true,
}: TrendChartProps) {
  const colors = colorMap[color]
  const colors2 = colorMap[color2]

  return (
    <ResponsiveContainer width="100%" height={height}>
      <AreaChart data={data} margin={{ top: 5, right: 5, left: 0, bottom: 5 }}>
        <defs>
          <linearGradient id={`gradient-${color}`} x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stopColor={colors.fill} stopOpacity={0.2} />
            <stop offset="100%" stopColor={colors.fill} stopOpacity={0} />
          </linearGradient>
          {dataKey2 && (
            <linearGradient id={`gradient-${color2}`} x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stopColor={colors2.fill} stopOpacity={0.2} />
              <stop offset="100%" stopColor={colors2.fill} stopOpacity={0} />
            </linearGradient>
          )}
        </defs>
        
        {showGrid && (
          <CartesianGrid 
            strokeDasharray="3 3" 
            stroke="hsl(var(--border))" 
            vertical={false}
          />
        )}
        
        {showAxis && (
          <>
            <XAxis 
              dataKey="name" 
              axisLine={false}
              tickLine={false}
              tick={{ fill: 'hsl(var(--muted-foreground))', fontSize: 11 }}
              dy={10}
            />
            <YAxis 
              axisLine={false}
              tickLine={false}
              tick={{ fill: 'hsl(var(--muted-foreground))', fontSize: 11 }}
              dx={-10}
              width={35}
            />
          </>
        )}
        
        <Tooltip content={<CustomTooltip />} />
        
        <Area
          type="monotone"
          dataKey={dataKey}
          stroke={colors.stroke}
          strokeWidth={2}
          fill={`url(#gradient-${color})`}
        />

        {dataKey2 && (
          <Area
            type="monotone"
            dataKey={dataKey2}
            stroke={colors2.stroke}
            strokeWidth={2}
            fill={`url(#gradient-${color2})`}
          />
        )}
      </AreaChart>
    </ResponsiveContainer>
  )
}
</file>

<file path="src/components/dashboard/index.ts">
export * from './KPICard'
export * from './AlertasActivas'
export * from './ActividadReciente'
export * from './TopPerformers'
</file>

<file path="src/components/dashboard/KPICard.tsx">
import { cn } from '@/lib/utils'
import { Card, CardContent } from '@/components/ui/card'
import { TrendingUp, TrendingDown, Info, LucideIcon } from 'lucide-react'
import {
  Tooltip,
  TooltipContent,
  TooltipTrigger,
} from '@/components/ui/tooltip'

interface KPICardProps {
  title: string
  value: string | number
  change?: number
  changeLabel?: string
  icon?: LucideIcon
  sparklineData?: number[]
}

function MiniSparkline({ data }: { data: number[] }) {
  const max = Math.max(...data)
  const min = Math.min(...data)
  const range = max - min || 1
  
  const points = data.map((value, index) => {
    const x = (index / (data.length - 1)) * 100
    const y = 100 - ((value - min) / range) * 100
    return `${x},${y}`
  }).join(' ')

  return (
    <svg className="w-20 h-8" viewBox="0 0 100 100" preserveAspectRatio="none">
      <polyline
        fill="none"
        stroke="currentColor"
        strokeWidth="3"
        strokeLinecap="round"
        strokeLinejoin="round"
        points={points}
        className="text-primary"
      />
    </svg>
  )
}

export function KPICard({ 
  title, 
  value, 
  change, 
  changeLabel = 'Since Last week',
  icon: Icon,
  sparklineData
}: KPICardProps) {
  const isPositive = change && change > 0
  const isNegative = change && change < 0

  return (
    <Card>
      <CardContent className="p-5">
        <div className="flex items-start justify-between mb-3">
          <div className="flex items-center gap-2 text-sm text-muted-foreground">
            {Icon && <Icon className="w-4 h-4" />}
            <span>{title}</span>
          </div>
          <Tooltip>
            <TooltipTrigger>
              <Info className="w-4 h-4 text-muted-foreground/50" />
            </TooltipTrigger>
            <TooltipContent>
              <p>More information about {title}</p>
            </TooltipContent>
          </Tooltip>
        </div>

        <div className="flex items-end justify-between">
          <div>
            <p className="text-3xl font-semibold tracking-tight">{value}</p>
            {changeLabel && (
              <p className="text-xs text-muted-foreground mt-1">{changeLabel}</p>
            )}
          </div>
          
          {sparklineData ? (
            <MiniSparkline data={sparklineData} />
          ) : null}
        </div>

        {change !== undefined && (
          <div className="flex items-center gap-2 mt-3 pt-3 border-t border-border">
            <span className="text-sm text-muted-foreground">Details</span>
            <div className={cn(
              "flex items-center gap-1 ml-auto text-sm font-medium",
              isPositive && "text-success",
              isNegative && "text-destructive"
            )}>
              {isPositive && <TrendingUp className="w-4 h-4" />}
              {isNegative && <TrendingDown className="w-4 h-4" />}
              {Math.abs(change)}%
            </div>
          </div>
        )}
      </CardContent>
    </Card>
  )
}

// Variante m√°s compacta para m√©tricas secundarias
interface MetricCardProps {
  title: string
  value: string | number
  change?: string
  sparklineData?: number[]
  className?: string
}

export function MetricCard({ title, value, change, sparklineData, className }: MetricCardProps) {
  return (
    <Card className={className}>
      <CardContent className="p-5">
        <p className="text-sm text-muted-foreground mb-1">{title}</p>
        <div className="flex items-end justify-between">
          <div>
            <p className="text-2xl font-semibold">{value}</p>
            {change && (
              <p className="text-xs text-muted-foreground mt-0.5">{change}</p>
            )}
          </div>
          {sparklineData && <MiniSparkline data={sparklineData} />}
        </div>
      </CardContent>
    </Card>
  )
}
</file>

<file path="src/components/layout/index.ts">
export * from './Header'
export * from './MainLayout'
export * from './Sidebar'
</file>

<file path="src/components/layout/MainLayout.tsx">
import { Outlet } from 'react-router-dom'
import { Sidebar } from './Sidebar'

export function MainLayout() {
  return (
    <div className="min-h-screen bg-secondary/30">
      <Sidebar />
      
      {/* Main content */}
      <main className="ml-64">
        <Outlet />
      </main>
    </div>
  )
}
</file>

<file path="src/components/llamadas/gestorLlamadas.tsx">
"use client";
import { useState, useEffect } from 'react';
import { supabase } from '../../lib/supabase';
import { useNavigate } from 'react-router-dom';
import { llamadasService, type Llamada } from '../../services/llamadasService';
import { Upload, FileAudio, CheckCircle, Clock, X, RefreshCw, AlertTriangle, Play, FileText, Activity, Trash2 } from 'lucide-react';

// --- 2. SUB-COMPONENTES ---

const UploadZone = ({ onUpload, isUploading }: { onUpload: (e: any) => void, isUploading: boolean }) => (
  <div className="bg-white p-8 rounded-2xl shadow-sm border border-gray-200 mb-8 text-center transition-all hover:shadow-md">
    <h2 className="text-2xl font-bold text-gray-800 mb-2">Nodus Audio Intelligence</h2>
    <p className="text-gray-500 mb-6">Sube una llamada para que los Agentes la analicen en tiempo real</p>
    
    <div className="relative inline-block">
        <input 
          type="file" 
          accept="audio/*" 
          onChange={onUpload} 
          className="hidden" 
          id="subir-audio" 
          disabled={isUploading}
        />
        <label 
          htmlFor="subir-audio" 
          className={`flex items-center gap-3 px-8 py-4 rounded-full font-medium cursor-pointer transition-all transform active:scale-95
            ${isUploading 
              ? 'bg-gray-100 text-gray-400 cursor-not-allowed' 
              : 'bg-black text-white hover:bg-gray-800 shadow-lg hover:shadow-xl'}`}
        >
          {isUploading ? <RefreshCw className="animate-spin" /> : <Upload size={20} />}
          {isUploading ? "Procesando..." : "Nueva Auditor√≠a"}
        </label>
    </div>
  </div>
);

const StatusBadge = ({ estado }: { estado: string }) => {
  const styles = {
    finalizado: 'bg-green-100 text-green-700 border-green-200',
    pendiente: 'bg-gray-100 text-gray-600 border-gray-200',
    error: 'bg-red-100 text-red-600 border-red-200',
    default: 'bg-blue-50 text-blue-600 border-blue-200 animate-pulse'
  };
  // @ts-ignore
  const currentStyle = styles[estado] || styles.default;
  
  return (
    <span className={`px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider flex items-center gap-2 border ${currentStyle}`}>
      {estado === 'finalizado' ? <CheckCircle size={14}/> : <Clock size={14}/>}
      {estado}
    </span>
  );
};

const LlamadaCard = ({ llamada, onClick, onDelete }: { 
  llamada: Llamada, 
  onClick: () => void, 
  onDelete: (id: string) => void 
}) => (
  <div 
    onClick={onClick}
    className="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex items-center justify-between hover:border-blue-400 cursor-pointer transition-all group relative"
  >
    <div className="flex items-center gap-4">
      <div className={`p-3 rounded-full transition-colors ${llamada.estado === 'finalizado' ? 'bg-green-50 text-green-600' : 'bg-gray-100 text-gray-500'}`}>
        <FileAudio size={24} />
      </div>
      <div>
        <h3 className="font-semibold text-gray-800 group-hover:text-blue-600 transition-colors">
          {llamada.nombre_archivo || 'Audio sin nombre'}
        </h3>
        <p className="text-xs text-gray-400 font-mono">
          {new Date(llamada.created_at).toLocaleString()}
        </p>
      </div>
    </div>

    <div className="flex items-center gap-6">
      <StatusBadge estado={llamada.estado} />
      
      <button 
        onClick={(e) => {
          e.stopPropagation();
          // USAMOS registro_id AQUI TAMBIEN
          if(confirm('¬øEliminar registro?')) onDelete(llamada.registro_id);
        }}
        className="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-full transition-all"
        title="Eliminar registro"
      >
        <Trash2 size={18} />
      </button>

      <div className="text-right min-w-[60px]">
        {llamada.puntaje_calidad && (
          <span className="text-xl font-bold text-gray-900">{llamada.puntaje_calidad}</span>
        )}
      </div>
    </div>
  </div>
);

const DetalleModal = ({ llamada, onClose }: { llamada: Llamada, onClose: () => void }) => {
  if (!llamada) return null;
  const isProcessing = llamada.estado !== 'finalizado' && llamada.estado !== 'error';

  return (
    <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 animate-in fade-in duration-200" onClick={onClose}>
      <div className="bg-white w-full max-w-3xl rounded-2xl shadow-2xl overflow-hidden max-h-[90vh] flex flex-col" onClick={e => e.stopPropagation()}>
        <div className="p-6 border-b border-gray-100 flex justify-between items-start bg-gray-50">
          <div>
            <h3 className="text-xl font-bold text-gray-900 line-clamp-1">{llamada.nombre_archivo}</h3>
            <div className="mt-2 flex gap-2">
               <StatusBadge estado={llamada.estado} />
               {/* USAMOS registro_id AQUI */}
               <span className="text-xs text-gray-400 flex items-center">ID: {llamada.registro_id.slice(0,8)}...</span>
            </div>
          </div>
          <button onClick={onClose} className="p-2 hover:bg-gray-200 text-gray-500 rounded-full transition">
            <X size={20} />
          </button>
        </div>

        <div className="p-0 overflow-y-auto flex-1">
          {isProcessing ? (
            <div className="flex flex-col items-center justify-center py-20 px-6 text-center space-y-6">
              <RefreshCw className="w-20 h-20 text-blue-600 animate-spin" />
              <h4 className="text-2xl font-bold text-gray-800">Analizando Llamada...</h4>
            </div>
          ) : (
            <div className="p-8 space-y-8">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                 {/* ... resto de tu UI ... */}
                 <div className="p-4 bg-gray-50 rounded border">
                    <p className="text-sm font-bold">Resumen</p>
                    <p>{llamada.resumen_ejecutivo || "Sin resumen"}</p>
                 </div>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

// --- 3. COMPONENTE PRINCIPAL ---

export default function GestorLlamadas() {
  const [llamadas, setLlamadas] = useState<Llamada[]>([]);
  const [subiendo, setSubiendo] = useState(false);
  
  // 1. INICIALIZAMOS EL HOOK DE NAVEGACI√ìN
  const navigate = useNavigate(); 

  useEffect(() => {
    cargarDatos();
    
    // Configuraci√≥n de Realtime (Mantener igual)
    const channel = supabase
      .channel('gestor-llamadas-realtime')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'registro_llamadas' }, () => {
        cargarDatos();
      })
      .subscribe();

    return () => { supabase.removeChannel(channel); };
  }, []);

  const cargarDatos = async () => {
    try {
      const data = await llamadasService.getAll();
      // @ts-ignore
      if (data) setLlamadas(data);
    } catch (error) {
      console.error("Error cargando llamadas:", error);
    }
  };

  const handleUpload = async (e: any) => {
    const archivo = e.target.files[0];
    if (!archivo) return;
    setSubiendo(true);
    try {
      await llamadasService.uploadAndCreate(archivo);
      await cargarDatos();
    } catch (error) {
      alert("Error al subir: " + error);
    } finally {
      setSubiendo(false);
    }
  };

  const handleDelete = async (id: string) => {
    if (!confirm('¬øEst√°s seguro de eliminar este registro?')) return;
    try {
      await llamadasService.deleteLlamada(id); // Aseg√∫rate de tener este m√©todo en el service, o usa supabase directo
      cargarDatos();
    } catch (error) {
      alert("Error al borrar");
    }
  };

  return (
    <div className="max-w-5xl mx-auto p-6 animate-in fade-in duration-500">
      
      {/* ZONA DE CARGA */}
      <UploadZone onUpload={handleUpload} isUploading={subiendo} />

      <div className="space-y-4">
        <div className="flex justify-between items-end mb-4 px-2">
          <h3 className="text-xl font-bold text-gray-800">Historial de Auditor√≠as</h3>
          <span className="text-sm text-gray-400">{llamadas.length} registros</span>
        </div>
        
        {/* LISTA DE LLAMADAS */}
        <div className="grid gap-3">
          {llamadas.map((llamada) => (
            <LlamadaCard 
              key={llamada.registro_id} 
              llamada={llamada} 
              
              // 2. CAMBIO CLAVE: AHORA NAVEGAMOS A LA P√ÅGINA DE DETALLE
              onClick={() => navigate(`/llamadas/${llamada.registro_id}`)}
              
              onDelete={handleDelete}
            />
          ))}
        </div>
      </div>

      {/* 3. ELIMINAMOS EL MODAL (Ya no se usa) */}
    </div>
  );
}
</file>

<file path="src/components/llamadas/index.ts">
export * from './LlamadaCard'
export * from './ModuloScore'
export * from './PrediccionCard'
export * from './TranscripcionViewer'
export * from './AudioPlayer'
</file>

<file path="src/components/llamadas/LlamadaCard.tsx">
import { Clock, AlertTriangle, ChevronRight } from 'lucide-react'
import { Card, CardContent } from '@/components/ui/card'
import { Avatar, AvatarFallback } from '@/components/ui/avatar'
import { Badge } from '@/components/ui/badge'
import { Progress } from '@/components/ui/progress'
import { cn, formatDuration, formatRelativeTime } from '@/lib/utils'
import type { Llamada, AnalisisLlamada } from '@/types'
import { Link } from 'react-router-dom'

interface LlamadaCardProps {
  llamada: Llamada
  analisis?: AnalisisLlamada
  index?: number
}

export function LlamadaCard({ llamada, analisis }: LlamadaCardProps) {
  const score = analisis?.score_total
  const probabilidad = analisis?.prediccion_cumplimiento.probabilidad
  const alertas = analisis?.alertas || []
  const tieneAlertaCritica = alertas.some(a => a.tipo === 'critica')

  return (
    <Link to={`/llamadas/${llamada.llamada_id}`}>
      <Card className={cn(
        "group cursor-pointer transition-all hover:shadow-md",
        tieneAlertaCritica && "border-destructive/50"
      )}>
        <CardContent className="p-4">
          <div className="flex items-center gap-4">
            <div className="relative">
              <Avatar className="h-10 w-10">
                <AvatarFallback className="text-xs bg-primary/10 text-primary">
                  {llamada.agente_nombre?.split(' ').map(n => n[0]).join('') || 'AG'}
                </AvatarFallback>
              </Avatar>
              {tieneAlertaCritica && (
                <div className="absolute -top-1 -right-1 w-4 h-4 bg-destructive rounded-full flex items-center justify-center">
                  <AlertTriangle className="w-2.5 h-2.5 text-white" />
                </div>
              )}
            </div>

            <div className="flex-1 min-w-0">
              <div className="flex items-center gap-2 mb-0.5">
                <span className="font-medium text-sm">{llamada.agente_nombre || 'Agente'}</span>
                <span className="text-muted-foreground text-sm">‚Üí</span>
                <span className="text-sm text-muted-foreground truncate">
                  {llamada.cliente_id}
                </span>
              </div>
              <div className="flex items-center gap-3 text-xs text-muted-foreground">
                <span className="flex items-center gap-1">
                  <Clock className="w-3 h-3" />
                  {formatDuration(llamada.duracion_segundos)}
                </span>
                <span>{formatRelativeTime(new Date(llamada.timestamp_inicio))}</span>
              </div>
            </div>

            {analisis ? (
              <div className="flex items-center gap-4">
                <div className="text-right">
                  <p className="text-xs text-muted-foreground">Score</p>
                  <p className={cn(
                    "text-lg font-semibold",
                    score && score >= 70 ? "text-success" : 
                    score && score >= 40 ? "text-warning" : "text-destructive"
                  )}>
                    {score}
                  </p>
                </div>

                <div className="w-20">
                  <p className="text-xs text-muted-foreground mb-1">Prob.</p>
                  <Progress 
                    value={probabilidad} 
                    variant={
                      probabilidad && probabilidad >= 60 ? 'success' : 
                      probabilidad && probabilidad >= 35 ? 'warning' : 'destructive'
                    }
                    className="h-1.5"
                  />
                  <p className="text-xs text-right mt-0.5">{probabilidad}%</p>
                </div>
              </div>
            ) : (
              <Badge variant="secondary">
                {llamada.estado === 'transcrito' ? 'Procesando' : 'Pendiente'}
              </Badge>
            )}

            <ChevronRight className="w-4 h-4 text-muted-foreground group-hover:text-foreground transition-colors" />
          </div>
        </CardContent>
      </Card>
    </Link>
  )
}
</file>

<file path="src/components/modulos/CumplimientoBar.tsx">
import { cn } from '@/lib/utils'

interface CumplimientoBarProps {
  variable: string
  porcentaje: number
  puntos?: number
  pesoMaximo?: number
  color?: 'primary' | 'coral' | 'amber' | 'emerald'
}

export function CumplimientoBar({ 
  variable, 
  porcentaje, 
  puntos,
  pesoMaximo,
  color = 'primary'
}: CumplimientoBarProps) {
  // Determinar color de fondo basado en prop
  const bgColor = {
    primary: 'bg-emerald-500',
    coral: 'bg-coral-500',
    amber: 'bg-amber-500',
    emerald: 'bg-emerald-500'
  }[color]

  return (
    <div className="space-y-1.5">
      <div className="flex items-center justify-between text-sm">
        <span className="font-medium">{variable}</span>
        <div className="flex items-center gap-2">
          {puntos !== undefined && pesoMaximo !== undefined && (
            <span className="text-xs text-muted-foreground">
              {puntos}/{pesoMaximo} pts
            </span>
          )}
          <span className="font-semibold">{porcentaje}%</span>
        </div>
      </div>
      
      <div className="h-2.5 bg-muted rounded-full overflow-hidden">
        <div 
          className={cn(
            "h-full rounded-full transition-all duration-500",
            bgColor
          )}
          style={{ width: `${Math.max(Math.min(100, porcentaje), 3)}%` }}
        />
      </div>
    </div>
  )
}
</file>

<file path="src/components/modulos/DonutMetric.tsx">
import { cn } from '@/lib/utils'

interface DonutMetricProps {
  value: number
  label: string
  sublabel?: string
  size?: 'sm' | 'md' | 'lg'
  color?: 'primary' | 'coral' | 'amber' | 'emerald' | 'red'
}

const sizeMap = {
  sm: { outer: 80, inner: 60, stroke: 10, text: 'text-lg' },
  md: { outer: 120, inner: 90, stroke: 15, text: 'text-2xl' },
  lg: { outer: 160, inner: 120, stroke: 20, text: 'text-3xl' }
}

const colorMap = {
  primary: '#0088FE',
  coral: '#FF6B6B',
  amber: '#F59E0B',
  emerald: '#10B981',
  red: '#EF4444'
}

export function DonutMetric({ 
  value, 
  label, 
  sublabel,
  size = 'md',
  color = 'primary'
}: DonutMetricProps) {
  const dims = sizeMap[size]
  const radius = (dims.outer - dims.stroke) / 2
  const circumference = 2 * Math.PI * radius
  const strokeDashoffset = circumference - (value / 100) * circumference
  
  return (
    <div className="flex flex-col items-center">
      <div className="relative" style={{ width: dims.outer, height: dims.outer }}>
        <svg 
          className="transform -rotate-90" 
          width={dims.outer} 
          height={dims.outer}
        >
          {/* Background circle */}
          <circle
            cx={dims.outer / 2}
            cy={dims.outer / 2}
            r={radius}
            fill="none"
            stroke="currentColor"
            strokeWidth={dims.stroke}
            className="text-muted/20"
          />
          {/* Progress circle */}
          <circle
            cx={dims.outer / 2}
            cy={dims.outer / 2}
            r={radius}
            fill="none"
            stroke={colorMap[color]}
            strokeWidth={dims.stroke}
            strokeDasharray={circumference}
            strokeDashoffset={strokeDashoffset}
            strokeLinecap="round"
            className="transition-all duration-500"
          />
        </svg>
        
        {/* Center value */}
        <div className="absolute inset-0 flex items-center justify-center">
          <span className={cn("font-bold", dims.text)}>
            {value}%
          </span>
        </div>
      </div>
      
      <p className="mt-2 text-sm font-medium text-center">{label}</p>
      {sublabel && (
        <p className="text-xs text-muted-foreground text-center">{sublabel}</p>
      )}
    </div>
  )
}
</file>

<file path="src/components/modulos/ImpactoElementosChart.tsx">
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { cn } from '@/lib/utils'

interface ElementoData {
  categoria: string
  total_llamadas: number
  prob_promedio: number | null
  porcentaje_del_total: number | null
}

interface ImpactoElementosChartProps {
  data: ElementoData[]
  titulo?: string
}

export function ImpactoElementosChart({ data, titulo = "Impacto por Elementos" }: ImpactoElementosChartProps) {
  // Encontrar el maximo para escalar las barras (minimo 100)
  const maxProb = Math.max(...data.map(d => d.prob_promedio || 0), 100)
  
  return (
    <Card>
      <CardHeader>
        <CardTitle className="text-base">{titulo}</CardTitle>
      </CardHeader>
      <CardContent>
        <div className="space-y-4">
          {data.map((item, index) => {
            const prob = item.prob_promedio || 0
            const barWidth = (prob / maxProb) * 100
            const isLast = index === data.length - 1
            
            return (
              <div key={item.categoria} className="space-y-1">
                {/* Labels row */}
                <div className="flex items-center justify-between">
                  <span className="text-xs text-muted-foreground">
                    {item.categoria}
                  </span>
                  <span className="text-xs font-medium text-muted-foreground">
                    {item.total_llamadas} llamadas
                  </span>
                </div>
                
                {/* Bar row with percentage always visible */}
                <div className="flex items-center gap-3">
                  <div className="flex-1 h-8 bg-muted rounded overflow-hidden">
                    <div 
                      className={cn(
                        "h-full rounded transition-all duration-500",
                        isLast ? "bg-emerald-500" : "bg-emerald-400"
                      )}
                      style={{ width: `${Math.max(barWidth, 8)}%` }}
                    />
                  </div>
                  {/* Percentage always outside and visible */}
                  <span className={cn(
                    "text-sm font-bold min-w-[50px] text-right",
                    isLast ? "text-emerald-600" : "text-emerald-500"
                  )}>
                    {prob.toFixed(1)}%
                  </span>
                </div>
              </div>
            )
          })}
        </div>
        
        {/* Legend */}
        <div className="mt-4 pt-4 border-t">
          <p className="text-xs text-muted-foreground">
            Probabilidad promedio de cumplimiento segun elementos de compromiso presentes
          </p>
        </div>
      </CardContent>
    </Card>
  )
}
</file>

<file path="src/components/modulos/index.ts">
export * from './PilarCard'
export * from './DonutMetric'
export * from './ProbabilidadFlow'
export * from './CumplimientoBar'
export * from './ModuloHeader'
export * from './ImpactoElementosChart'
</file>

<file path="src/components/modulos/ModuloHeader.tsx">
import { Badge } from '@/components/ui/badge'
import { cn } from '@/lib/utils'

interface ModuloHeaderProps {
  badge: string
  titulo: string
  subtitulo?: string
  color?: 'primary' | 'coral' | 'amber' | 'emerald'
}

export function ModuloHeader({ badge, titulo, subtitulo, color = 'primary' }: ModuloHeaderProps) {
  // Gradientes con colores hardcodeados para evitar problemas con Tailwind
  const gradientStyles = {
    primary: 'bg-gradient-to-r from-[#0088FE] to-[#0066CC]',
    coral: 'bg-gradient-to-r from-[#FF6B6B] to-[#FF4757]',
    amber: 'bg-gradient-to-r from-[#F59E0B] to-[#D97706]',
    emerald: 'bg-gradient-to-r from-[#10B981] to-[#059669]'
  }

  return (
    <div className={cn(
      "rounded-xl p-6 mb-6",
      gradientStyles[color]
    )}>
      <Badge variant="outline" className="bg-white/20 text-white border-white/30 mb-3">
        {badge}
      </Badge>
      <h1 className="text-2xl md:text-3xl font-bold text-white mb-2">
        {titulo}
      </h1>
      {subtitulo && (
        <p className="text-white/80 text-sm md:text-base max-w-3xl">
          {subtitulo}
        </p>
      )}
    </div>
  )
}
</file>

<file path="src/components/modulos/PilarCard.tsx">
import { Card, CardContent } from '@/components/ui/card'
import { cn } from '@/lib/utils'
import { TrendingUp, TrendingDown, Minus } from 'lucide-react'

interface PilarCardProps {
  titulo: string
  descripcion: string
  score: number
  peso?: string
  cambio?: number
  color?: 'primary' | 'coral' | 'amber' | 'emerald'
  size?: 'default' | 'large'
}

const colorMap = {
  primary: {
    bg: 'bg-blue-500/10',
    text: 'text-blue-600',
    border: 'border-blue-500/20'
  },
  coral: {
    bg: 'bg-red-500/10',
    text: 'text-red-500',
    border: 'border-red-500/20'
  },
  amber: {
    bg: 'bg-amber-500/10',
    text: 'text-amber-600',
    border: 'border-amber-500/20'
  },
  emerald: {
    bg: 'bg-emerald-500/10',
    text: 'text-emerald-600',
    border: 'border-emerald-500/20'
  }
}

export function PilarCard({ 
  titulo, 
  descripcion, 
  score, 
  peso,
  cambio,
  color = 'primary',
  size = 'default'
}: PilarCardProps) {
  const colors = colorMap[color]
  
  return (
    <Card className={cn(
      "relative overflow-hidden transition-all hover:shadow-md",
      size === 'large' && "p-2"
    )}>
      <CardContent className={cn("p-4", size === 'large' && "p-6")}>
        {peso && (
          <div className={cn(
            "absolute top-3 right-3 px-2 py-1 rounded-full text-xs font-semibold",
            colors.bg,
            colors.text
          )}>
            {peso}
          </div>
        )}
        
        <h3 className={cn(
          "font-semibold mb-1",
          colors.text,
          size === 'large' ? "text-lg" : "text-sm"
        )}>
          {titulo}
        </h3>
        
        <p className={cn(
          "text-muted-foreground mb-4 line-clamp-2",
          size === 'large' ? "text-sm" : "text-xs"
        )}>
          {descripcion}
        </p>
        
        <div className="flex items-end justify-between">
          <div>
            <p className={cn(
              "font-bold",
              size === 'large' ? "text-3xl" : "text-2xl"
            )}>
              {score}
              <span className="text-sm font-normal text-muted-foreground ml-1">pts</span>
            </p>
          </div>
          
          {cambio !== undefined && (
            <div className={cn(
              "flex items-center gap-1 text-xs",
              cambio > 0 ? "text-emerald-600" : cambio < 0 ? "text-red-500" : "text-muted-foreground"
            )}>
              {cambio > 0 ? (
                <TrendingUp className="w-3 h-3" />
              ) : cambio < 0 ? (
                <TrendingDown className="w-3 h-3" />
              ) : (
                <Minus className="w-3 h-3" />
              )}
              <span>{cambio > 0 ? '+' : ''}{cambio}%</span>
            </div>
          )}
        </div>
      </CardContent>
    </Card>
  )
}
</file>

<file path="src/components/ui/avatar.tsx">
import * as React from "react"
import * as AvatarPrimitive from "@radix-ui/react-avatar"
import { cn } from "@/lib/utils"

const Avatar = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Root
    ref={ref}
    className={cn(
      "relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",
      className
    )}
    {...props}
  />
))
Avatar.displayName = AvatarPrimitive.Root.displayName

const AvatarImage = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Image>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Image
    ref={ref}
    className={cn("aspect-square h-full w-full", className)}
    {...props}
  />
))
AvatarImage.displayName = AvatarPrimitive.Image.displayName

const AvatarFallback = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Fallback>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Fallback
    ref={ref}
    className={cn(
      "flex h-full w-full items-center justify-center rounded-full bg-muted",
      className
    )}
    {...props}
  />
))
AvatarFallback.displayName = AvatarPrimitive.Fallback.displayName

export { Avatar, AvatarImage, AvatarFallback }
</file>

<file path="src/components/ui/badge.tsx">
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"
import { cn } from "@/lib/utils"

const badgeVariants = cva(
  "inline-flex items-center rounded-md border px-2 py-0.5 text-xs font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary/10 text-primary",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground",
        destructive:
          "border-transparent bg-destructive/10 text-destructive",
        success:
          "border-transparent bg-success/10 text-success",
        warning:
          "border-transparent bg-warning/10 text-warning",
        outline:
          "border-border text-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

export interface BadgeProps
  extends React.HTMLAttributes<HTMLDivElement>,
    VariantProps<typeof badgeVariants> {}

function Badge({ className, variant, ...props }: BadgeProps) {
  return (
    <div className={cn(badgeVariants({ variant }), className)} {...props} />
  )
}

export { Badge, badgeVariants }
</file>

<file path="src/components/ui/button.tsx">
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"
import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-lg text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
  {
    variants: {
      variant: {
        default:
          "bg-primary text-primary-foreground hover:bg-primary/90",
        destructive:
          "bg-destructive text-destructive-foreground hover:bg-destructive/90",
        outline:
          "border border-input bg-background hover:bg-accent hover:text-accent-foreground",
        secondary:
          "bg-secondary text-secondary-foreground hover:bg-secondary/80",
        ghost:
          "hover:bg-accent hover:text-accent-foreground",
        link:
          "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-9 px-4 py-2",
        sm: "h-8 rounded-md px-3 text-xs",
        lg: "h-10 rounded-lg px-6",
        icon: "h-9 w-9",
        "icon-sm": "h-8 w-8",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  asChild?: boolean
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, asChild = false, ...props }, ref) => {
    const Comp = asChild ? Slot : "button"
    return (
      <Comp
        className={cn(buttonVariants({ variant, size, className }))}
        ref={ref}
        {...props}
      />
    )
  }
)
Button.displayName = "Button"

export { Button, buttonVariants }
</file>

<file path="src/components/ui/card.tsx">
import * as React from "react"
import { cn } from "@/lib/utils"

const Card = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "rounded-xl border border-border bg-card text-card-foreground shadow-sm",
      className
    )}
    {...props}
  />
))
Card.displayName = "Card"

const CardHeader = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex flex-col space-y-1.5 p-6", className)}
    {...props}
  />
))
CardHeader.displayName = "CardHeader"

const CardTitle = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "text-base font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
CardTitle.displayName = "CardTitle"

const CardDescription = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
CardDescription.displayName = "CardDescription"

const CardContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
))
CardContent.displayName = "CardContent"

const CardFooter = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex items-center p-6 pt-0", className)}
    {...props}
  />
))
CardFooter.displayName = "CardFooter"

export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }
</file>

<file path="src/components/ui/index.ts">
export * from './avatar'
export * from './badge'
export * from './button'
export * from './card'
export * from './input'
export * from './progress'
export * from './scroll-area'
export * from './separator'
export * from './skeleton'
export * from './tabs'
export * from './tooltip'
</file>

<file path="src/components/ui/input.tsx">
import * as React from "react"
import { cn } from "@/lib/utils"

const Input = React.forwardRef<HTMLInputElement, React.ComponentProps<"input">>(
  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        className={cn(
          "flex h-10 w-full rounded-lg border border-border bg-input px-4 py-2 text-sm text-foreground transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:border-primary disabled:cursor-not-allowed disabled:opacity-50",
          className
        )}
        ref={ref}
        {...props}
      />
    )
  }
)
Input.displayName = "Input"

export { Input }
</file>

<file path="src/components/ui/progress.tsx">
import * as React from "react"
import * as ProgressPrimitive from "@radix-ui/react-progress"
import { cn } from "@/lib/utils"

interface ProgressProps extends React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root> {
  variant?: 'default' | 'success' | 'warning' | 'destructive'
}

const Progress = React.forwardRef<
  React.ElementRef<typeof ProgressPrimitive.Root>,
  ProgressProps
>(({ className, value, variant = 'default', ...props }, ref) => {
  const indicatorVariants = {
    default: "bg-primary",
    success: "bg-success",
    warning: "bg-warning",
    destructive: "bg-destructive",
  }

  return (
    <ProgressPrimitive.Root
      ref={ref}
      className={cn(
        "relative h-2 w-full overflow-hidden rounded-full bg-secondary",
        className
      )}
      {...props}
    >
      <ProgressPrimitive.Indicator
        className={cn(
          "h-full w-full flex-1 transition-all duration-300",
          indicatorVariants[variant]
        )}
        style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
      />
    </ProgressPrimitive.Root>
  )
})
Progress.displayName = ProgressPrimitive.Root.displayName

export { Progress }
</file>

<file path="src/components/ui/scroll-area.tsx">
import * as React from "react"
import * as ScrollAreaPrimitive from "@radix-ui/react-scroll-area"
import { cn } from "@/lib/utils"

const ScrollArea = React.forwardRef<
  React.ElementRef<typeof ScrollAreaPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>
>(({ className, children, ...props }, ref) => (
  <ScrollAreaPrimitive.Root
    ref={ref}
    className={cn("relative overflow-hidden", className)}
    {...props}
  >
    <ScrollAreaPrimitive.Viewport className="h-full w-full rounded-[inherit]">
      {children}
    </ScrollAreaPrimitive.Viewport>
    <ScrollBar />
    <ScrollAreaPrimitive.Corner />
  </ScrollAreaPrimitive.Root>
))
ScrollArea.displayName = ScrollAreaPrimitive.Root.displayName

const ScrollBar = React.forwardRef<
  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,
  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>
>(({ className, orientation = "vertical", ...props }, ref) => (
  <ScrollAreaPrimitive.ScrollAreaScrollbar
    ref={ref}
    orientation={orientation}
    className={cn(
      "flex touch-none select-none transition-colors",
      orientation === "vertical" &&
        "h-full w-2 border-l border-l-transparent p-[1px]",
      orientation === "horizontal" &&
        "h-2 flex-col border-t border-t-transparent p-[1px]",
      className
    )}
    {...props}
  >
    <ScrollAreaPrimitive.ScrollAreaThumb className="relative flex-1 rounded-full bg-border hover:bg-muted-foreground/30" />
  </ScrollAreaPrimitive.ScrollAreaScrollbar>
))
ScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName

export { ScrollArea, ScrollBar }
</file>

<file path="src/components/ui/separator.tsx">
import * as React from "react"
import * as SeparatorPrimitive from "@radix-ui/react-separator"
import { cn } from "@/lib/utils"

const Separator = React.forwardRef<
  React.ElementRef<typeof SeparatorPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>
>(
  (
    { className, orientation = "horizontal", decorative = true, ...props },
    ref
  ) => (
    <SeparatorPrimitive.Root
      ref={ref}
      decorative={decorative}
      orientation={orientation}
      className={cn(
        "shrink-0 bg-border",
        orientation === "horizontal" ? "h-[1px] w-full" : "h-full w-[1px]",
        className
      )}
      {...props}
    />
  )
)
Separator.displayName = SeparatorPrimitive.Root.displayName

export { Separator }
</file>

<file path="src/components/ui/skeleton.tsx">
import { cn } from "@/lib/utils"

function Skeleton({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) {
  return (
    <div
      className={cn("shimmer rounded-md", className)}
      {...props}
    />
  )
}

export { Skeleton }
</file>

<file path="src/components/ui/tabs.tsx">
import * as React from "react"
import * as TabsPrimitive from "@radix-ui/react-tabs"
import { cn } from "@/lib/utils"

const Tabs = TabsPrimitive.Root

const TabsList = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.List
    ref={ref}
    className={cn(
      "inline-flex h-11 items-center justify-center rounded-lg bg-muted p-1 text-muted-foreground",
      className
    )}
    {...props}
  />
))
TabsList.displayName = TabsPrimitive.List.displayName

const TabsTrigger = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Trigger
    ref={ref}
    className={cn(
      "inline-flex items-center justify-center whitespace-nowrap rounded-md px-4 py-2 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-card data-[state=active]:text-foreground data-[state=active]:shadow-sm data-[state=active]:border data-[state=active]:border-border",
      className
    )}
    {...props}
  />
))
TabsTrigger.displayName = TabsPrimitive.Trigger.displayName

const TabsContent = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Content
    ref={ref}
    className={cn(
      "mt-4 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
      className
    )}
    {...props}
  />
))
TabsContent.displayName = TabsPrimitive.Content.displayName

export { Tabs, TabsList, TabsTrigger, TabsContent }
</file>

<file path="src/components/ui/tooltip.tsx">
import * as React from "react"
import * as TooltipPrimitive from "@radix-ui/react-tooltip"
import { cn } from "@/lib/utils"

const TooltipProvider = TooltipPrimitive.Provider

const Tooltip = TooltipPrimitive.Root

const TooltipTrigger = TooltipPrimitive.Trigger

const TooltipContent = React.forwardRef<
  React.ElementRef<typeof TooltipPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <TooltipPrimitive.Portal>
    <TooltipPrimitive.Content
      ref={ref}
      sideOffset={sideOffset}
      className={cn(
        "z-50 overflow-hidden rounded-lg bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-lg shadow-black/20 border border-border animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props}
    />
  </TooltipPrimitive.Portal>
))
TooltipContent.displayName = TooltipPrimitive.Content.displayName

export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }
</file>

<file path="src/hooks/index.ts">
// ============================================
// NODUS - Hooks Index
// ============================================

// Supabase Queries
export {
  useAgentes,
  useAgente,
  useResumenAgentes,
  useLlamadas,
  useLlamada,
  useLlamadasPorAgente,
  useAlertas as useAlertasQuery,
  useAlertasCount,
  useCoachingReports,
  useUltimoCoachingReport,
  useDashboardMetrics,
  useTendencias as useTendenciasQuery,
  useTopPerformers as useTopPerformersQuery
} from './useSupabase'

// Realtime
export {
  useRealtime,
  useAlertasRealtime,
  useAnalisisRealtime,
  usePresence
} from './useRealtime'

// Dashboard (combined)
export {
  useDashboard,
  useMetrics,
  useAlertas,
  useLlamadasRecientes,
  useTopPerformers,
  useTendencias,
  useNotifications,
  useUnreadNotificationsCount
} from './useDashboard'

// Modulos de Analisis
export {
  useKPIsPrincipales,
  useModulosGlobal,
  useCompromisoElementos,
  useAbandonosDetalle,
  useAbandonoKPIs,
  useAgentesModulos,
  useEvolucionSemanal,
  useFlujoProbabilidad,
  useContactoDetalle,
  useModulosOverview
} from './useModulos'
</file>

<file path="src/hooks/useDashboard.ts">
// ============================================
// NODUS - Dashboard Hook
// Combina datos + realtime + store
// ============================================

import { useEffect, useCallback } from 'react'
import { useDashboardStore } from '@/stores/dashboardStore'
import { useRealtime } from './useRealtime'
import type { AlertaAnomalia, AnalisisLlamada, CoachingReport, RegistroLlamada } from '@/types/database'

export function useDashboard() {
  const {
    metrics,
    alertas,
    llamadasRecientes,
    topPerformers,
    tendencias,
    notifications,
    loading,
    error,
    realtimeConnected,
    lastUpdate,
    fetchDashboardData,
    fetchAlertas,
    fetchLlamadas,
    addAlerta,
    updateAlerta,
    addAnalisis,
    updateLlamada,
    addNotification,
    setRealtimeConnected
  } = useDashboardStore()

  // Setup realtime callbacks
  const handleNuevaAlerta = useCallback((alerta: AlertaAnomalia) => {
    addAlerta(alerta)
  }, [addAlerta])

  const handleAlertaActualizada = useCallback((alerta: AlertaAnomalia) => {
    updateAlerta(alerta)
  }, [updateAlerta])

  const handleNuevoAnalisis = useCallback((analisis: AnalisisLlamada) => {
    addAnalisis(analisis)
    addNotification({
      type: 'analisis',
      title: 'Nueva llamada analizada',
      message: `Score: ${analisis.score_total}/100`,
      data: analisis
    })
  }, [addAnalisis, addNotification])

  const handleNuevoCoachingReport = useCallback((report: CoachingReport) => {
    addNotification({
      type: 'coaching',
      title: 'Nuevo reporte de coaching',
      message: `Reporte generado para el periodo ${report.periodo_inicio} - ${report.periodo_fin}`,
      data: report
    })
  }, [addNotification])

  const handleLlamadaActualizada = useCallback((llamada: RegistroLlamada) => {
    updateLlamada(llamada)
  }, [updateLlamada])

  // Setup realtime connection
  const { isConnected } = useRealtime({
    onNuevaAlerta: handleNuevaAlerta,
    onAlertaActualizada: handleAlertaActualizada,
    onNuevoAnalisis: handleNuevoAnalisis,
    onNuevoCoachingReport: handleNuevoCoachingReport,
    onLlamadaActualizada: handleLlamadaActualizada
  })

  // Update realtime status
  useEffect(() => {
    setRealtimeConnected(isConnected)
  }, [isConnected, setRealtimeConnected])

  // Initial data fetch
  useEffect(() => {
    fetchDashboardData()
    fetchAlertas()
    fetchLlamadas()
  }, [fetchDashboardData, fetchAlertas, fetchLlamadas])

  // Refresh data periodically (every 5 minutes as backup)
  useEffect(() => {
    const interval = setInterval(() => {
      fetchDashboardData()
    }, 5 * 60 * 1000)

    return () => clearInterval(interval)
  }, [fetchDashboardData])

  return {
    // Data
    metrics,
    alertas,
    llamadasRecientes,
    topPerformers,
    tendencias,
    notifications,
    
    // Status
    loading,
    error,
    realtimeConnected,
    lastUpdate,
    
    // Actions
    refresh: fetchDashboardData,
    refreshAlertas: fetchAlertas,
    refreshLlamadas: fetchLlamadas
  }
}

// Export individual selectors for optimization
export { 
  useMetrics, 
  useAlertas, 
  useLlamadasRecientes, 
  useTopPerformers, 
  useTendencias,
  useNotifications,
  useUnreadNotificationsCount 
} from '@/stores/dashboardStore'
</file>

<file path="src/hooks/useModulos.ts">
import { useState, useEffect, useCallback } from 'react'
import { supabase, isSupabaseConfigured } from '@/lib/supabase'

// ============================================
// Types para las vistas de modulos
// ============================================

export interface ModulosGlobal {
  fecha: string
  total_llamadas: number
  avg_contacto_directo: number | null
  avg_compromiso_pago: number | null
  tasa_abandono: number | null
  avg_score_total: number | null
  avg_probabilidad: number | null
  pct_validacion_cliente: number | null
}

export interface CompromisoElementos {
  categoria: string
  orden: number
  total_llamadas: number
  prob_promedio: number | null
  score_promedio: number | null
  porcentaje_del_total: number | null
}

export interface AbandonoDetalle {
  momento_rango: string
  razon: string
  iniciado_por: string
  total: number
  porcentaje: number | null
}

export interface AbandonoKPI {
  kpi: string
  valor: number
  porcentaje_abandonos: number | null
  porcentaje_total: number | null
}

export interface AgenteModulos {
  agente_id: string
  agente_nombre: string
  equipo: string | null
  estado: string
  total_llamadas: number
  score_contacto: number | null
  score_compromiso: number | null
  tasa_abandono: number | null
  pct_validacion: number | null
  score_total: number | null
  prob_cumplimiento: number | null
  ranking_score: number
  ranking_prob: number
}

export interface EvolucionSemanal {
  semana: string
  total_llamadas: number
  score_total: number | null
  score_contacto: number | null
  score_compromiso: number | null
  tasa_validacion: number | null
  tasa_abandono: number | null
  prob_cumplimiento: number | null
  score_total_anterior: number | null
  prob_anterior: number | null
}

export interface FlujoProbabilidad {
  paso: string
  orden: number
  prob_teorica: number
  prob_real: number | null
  n: number
}

export interface ContactoDetalle {
  variable: string
  peso_maximo: number
  puntos_promedio: number | null
  pct_cumplimiento: number | null
  total_llamadas: number
}

export interface KPIPrincipal {
  kpi: string
  valor: number | null
  valor_anterior: number | null
  cambio: number | null
}

// ============================================
// Hooks
// ============================================

function useQuery<T>(
  queryFn: () => Promise<T>,
  deps: unknown[] = []
): { data: T | null; loading: boolean; error: Error | null; refetch: () => void } {
  const [data, setData] = useState<T | null>(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<Error | null>(null)

  const fetch = useCallback(async () => {
    if (!isSupabaseConfigured()) {
      setLoading(false)
      return
    }
    
    try {
      setLoading(true)
      const result = await queryFn()
      setData(result)
      setError(null)
    } catch (e) {
      setError(e as Error)
      console.error('Query error:', e)
    } finally {
      setLoading(false)
    }
  }, deps)

  useEffect(() => {
    fetch()
  }, [fetch])

  return { data, loading, error, refetch: fetch }
}

// Hook: KPIs principales
export function useKPIsPrincipales() {
  return useQuery<KPIPrincipal[]>(async () => {
    const { data, error } = await supabase
      .from('vista_kpis_principales')
      .select('*')

    if (error) throw error
    return data || []
  }, [])
}

// Hook: Modulos global por dia
export function useModulosGlobal(dias = 30) {
  return useQuery<ModulosGlobal[]>(async () => {
    const { data, error } = await supabase
      .from('vista_modulos_global')
      .select('*')
      .order('fecha', { ascending: false })
      .limit(dias)

    if (error) throw error
    return data || []
  }, [dias])
}

// Hook: Compromiso por elementos
export function useCompromisoElementos() {
  return useQuery<CompromisoElementos[]>(async () => {
    const { data, error } = await supabase
      .from('vista_compromiso_elementos')
      .select('*')
      .order('orden', { ascending: true })

    if (error) throw error
    return data || []
  }, [])
}

// Hook: Detalle de abandonos
export function useAbandonosDetalle() {
  return useQuery<AbandonoDetalle[]>(async () => {
    const { data, error } = await supabase
      .from('vista_abandonos_detalle')
      .select('*')
      .order('total', { ascending: false })

    if (error) throw error
    return data || []
  }, [])
}

// Hook: KPIs de abandono
export function useAbandonoKPIs() {
  return useQuery<AbandonoKPI[]>(async () => {
    const { data, error } = await supabase
      .from('vista_abandono_kpis')
      .select('*')

    if (error) throw error
    return data || []
  }, [])
}

// Hook: Agentes con modulos
export function useAgentesModulos() {
  return useQuery<AgenteModulos[]>(async () => {
    const { data, error } = await supabase
      .from('vista_agente_modulos')
      .select('*')
      .order('score_total', { ascending: false })

    if (error) throw error
    return data || []
  }, [])
}

// Hook: Evolucion semanal
export function useEvolucionSemanal() {
  return useQuery<EvolucionSemanal[]>(async () => {
    const { data, error } = await supabase
      .from('vista_evolucion_semanal')
      .select('*')
      .order('semana', { ascending: true })

    if (error) throw error
    return data || []
  }, [])
}

// Hook: Flujo de probabilidad
export function useFlujoProbabilidad() {
  return useQuery<FlujoProbabilidad[]>(async () => {
    const { data, error } = await supabase
      .from('vista_flujo_probabilidad')
      .select('*')
      .order('orden', { ascending: true })

    if (error) throw error
    return data || []
  }, [])
}

// Hook: Detalle de contacto directo
export function useContactoDetalle() {
  return useQuery<ContactoDetalle[]>(async () => {
    const { data, error } = await supabase
      .from('vista_contacto_detalle')
      .select('*')

    if (error) throw error
    return data || []
  }, [])
}

// Hook combinado para la pagina Overview
export function useModulosOverview() {
  const kpis = useKPIsPrincipales()
  const evolucion = useEvolucionSemanal()
  const agentes = useAgentesModulos()
  const elementos = useCompromisoElementos()

  return {
    kpis: kpis.data,
    evolucion: evolucion.data,
    agentes: agentes.data,
    elementos: elementos.data,
    loading: kpis.loading || evolucion.loading || agentes.loading || elementos.loading,
    refetch: () => {
      kpis.refetch()
      evolucion.refetch()
      agentes.refetch()
      elementos.refetch()
    }
  }
}
</file>

<file path="src/lib/supabase.ts">
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
const supabaseKey = import.meta.env.VITE_SUPABASE_ANON_KEY;

const isConfigured = supabaseUrl && supabaseKey;

if(!isConfigured) {
  console.warn('Supabase no est√° configurado correctamente. Verifica las variables de entorno.');
};

export const isSupabaseConfigured = () => !!isConfigured;

export const supabase = createClient (
  supabaseUrl || 'https://placeholder.supabase.co',
  supabaseKey || 'placeholder'
);
</file>

<file path="src/lib/utils.ts">
import { type ClassValue, clsx } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}

export function formatNumber(num: number): string {
  return new Intl.NumberFormat('es-PE').format(num)
}

export function formatCurrency(amount: number, currency = 'PEN'): string {
  return new Intl.NumberFormat('es-PE', {
    style: 'currency',
    currency,
  }).format(amount)
}

export function formatPercentage(value: number): string {
  return `${Math.round(value)}%`
}

export function formatDuration(seconds: number): string {
  const mins = Math.floor(seconds / 60)
  const secs = seconds % 60
  return `${mins}:${secs.toString().padStart(2, '0')}`
}

export function formatRelativeTime(date: Date): string {
  const now = new Date()
  const diffMs = now.getTime() - date.getTime()
  const diffMins = Math.floor(diffMs / 60000)
  const diffHours = Math.floor(diffMs / 3600000)
  const diffDays = Math.floor(diffMs / 86400000)

  if (diffMins < 1) return 'ahora'
  if (diffMins < 60) return `hace ${diffMins}m`
  if (diffHours < 24) return `hace ${diffHours}h`
  if (diffDays < 7) return `hace ${diffDays}d`
  
  return date.toLocaleDateString('es-PE', { 
    day: 'numeric', 
    month: 'short' 
  })
}

export function getScoreColor(score: number): string {
  if (score >= 70) return 'score-high'
  if (score >= 40) return 'score-medium'
  return 'score-low'
}

export function getScoreLabel(score: number): string {
  if (score >= 70) return 'Alto'
  if (score >= 40) return 'Medio'
  return 'Bajo'
}

export function getProbabilidadColor(prob: number): string {
  if (prob >= 60) return 'text-success'
  if (prob >= 35) return 'text-warning'
  return 'text-destructive'
}
</file>

<file path="src/pages/modulos/index.ts">
export * from './ModulosOverview'
export * from './ContactoDirecto'
export * from './CompromisoPago'
export * from './AbandonoLlamadas'
</file>

<file path="src/pages/index.ts">
export * from './Dashboard'
export { default as Llamadas } from './Llamadas';
export { default as DetalleLlamada } from './detalleLlamada';
export * from './Agentes'
export * from './Chat'
export * from './Alertas'
export * from './modulos'
</file>

<file path="src/services/chatService.ts">
// ============================================
// NODUS - Chat Service
// Comunicacion con Saturn Studio Webhook
// ============================================

// URL del webhook de Saturn - configurar en .env
const WEBHOOK_URL = import.meta.env.VITE_SATURN_WEBHOOK_URL || ''

// ---------- Types ----------

export interface ChatMessage {
  role: 'user' | 'assistant'
  content: string
  timestamp: string
  data?: ChatResponseData
}

export interface ChatRequest {
  message: string
  conversation_id: string
  user_id?: string
  history: ChatMessage[]
  context?: {
    current_page?: string
    selected_agent_id?: string | null
    date_range?: {
      from: string
      to: string
    }
  }
}

export interface ChatResponseData {
  type: 'table' | 'metrics' | 'chart' | 'agent_card'
  title?: string
  columns?: string[]
  rows?: (string | number)[][]
  items?: Array<{
    label: string
    value: string | number
    change?: string
    trend?: 'up' | 'down' | 'stable'
  }>
  labels?: string[]
  datasets?: Array<{
    label: string
    data: number[]
  }>
}

export interface ChatResponse {
  success: boolean
  response: {
    message: string
    type: 'text' | 'data' | 'metrics' | 'chart' | 'error'
    data?: ChatResponseData
    suggestions?: string[]
  }
  conversation_id: string
  timestamp: string
  error?: {
    code: string
    message: string
  }
}

// ---------- Response Normalizer ----------

/**
 * Normaliza diferentes formatos de respuesta de Saturn
 * Saturn puede enviar:
 * 1. Formato directo: { message, suggestions }
 * 2. Formato wrapped: { success, response: { message, suggestions } }
 * 3. Con output: { output: { message, suggestions } }
 */
function normalizeResponse(data: unknown, conversationId: string): ChatResponse {
  const timestamp = new Date().toISOString()
  
  // Si es null o undefined
  if (!data) {
    return {
      success: false,
      response: {
        message: 'No se recibio respuesta del servidor.',
        type: 'error'
      },
      conversation_id: conversationId,
      timestamp
    }
  }

  const obj = data as Record<string, unknown>

  // Formato 1: Respuesta ya normalizada { success, response }
  if (obj.success !== undefined && obj.response) {
    return data as ChatResponse
  }

  // Formato 2: Saturn output wrapper { output: { message, suggestions } }
  if (obj.output && typeof obj.output === 'object') {
    const output = obj.output as Record<string, unknown>
    return {
      success: true,
      response: {
        message: String(output.message || ''),
        type: 'text',
        suggestions: Array.isArray(output.suggestions) ? output.suggestions : undefined
      },
      conversation_id: conversationId,
      timestamp
    }
  }

  // Formato 3: Respuesta directa del LLM { message, suggestions }
  if (obj.message && typeof obj.message === 'string') {
    return {
      success: true,
      response: {
        message: obj.message,
        type: obj.data ? 'data' : 'text',
        data: obj.data as ChatResponseData | undefined,
        suggestions: Array.isArray(obj.suggestions) ? obj.suggestions : undefined
      },
      conversation_id: conversationId,
      timestamp
    }
  }

  // Formato 4: String directo (el LLM devolvio solo texto)
  if (typeof data === 'string') {
    // Intentar parsear como JSON
    try {
      const parsed = JSON.parse(data)
      return normalizeResponse(parsed, conversationId)
    } catch {
      // Es texto plano
      return {
        success: true,
        response: {
          message: data,
          type: 'text'
        },
        conversation_id: conversationId,
        timestamp
      }
    }
  }

  // Formato desconocido - intentar extraer algo util
  console.warn('Formato de respuesta desconocido:', data)
  return {
    success: true,
    response: {
      message: JSON.stringify(data),
      type: 'text'
    },
    conversation_id: conversationId,
    timestamp
  }
}

// ---------- Service ----------

/**
 * Verifica si el servicio de chat esta configurado
 */
export function isChatConfigured(): boolean {
  return !!WEBHOOK_URL && !WEBHOOK_URL.includes('placeholder')
}

/**
 * Envia un mensaje al agente conversacional via webhook
 */
export async function sendChatMessage(request: ChatRequest): Promise<ChatResponse> {
  // Si no hay webhook configurado, usar respuesta mock
  if (!isChatConfigured()) {
    return getMockResponse(request.message)
  }

  try {
    const controller = new AbortController()
    const timeoutId = setTimeout(() => controller.abort(), 30000) // 30s timeout

    const response = await fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        ...request,
        timestamp: new Date().toISOString()
      }),
      signal: controller.signal
    })

    clearTimeout(timeoutId)

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`)
    }

    const data = await response.json()
    
    // Normalizar respuesta - Saturn puede enviar diferentes formatos
    return normalizeResponse(data, request.conversation_id)

  } catch (error) {
    if ((error as Error).name === 'AbortError') {
      return {
        success: false,
        response: {
          message: 'La consulta tardo demasiado. Por favor intenta de nuevo.',
          type: 'error'
        },
        conversation_id: request.conversation_id,
        timestamp: new Date().toISOString(),
        error: {
          code: 'TIMEOUT',
          message: 'Request timed out'
        }
      }
    }

    console.error('Chat service error:', error)
    return {
      success: false,
      response: {
        message: 'Hubo un problema al conectar con el asistente. Verifica tu conexion.',
        type: 'error'
      },
      conversation_id: request.conversation_id,
      timestamp: new Date().toISOString(),
      error: {
        code: 'CONNECTION_ERROR',
        message: (error as Error).message
      }
    }
  }
}

// ---------- Mock Responses (cuando no hay webhook) ----------

function getMockResponse(message: string): ChatResponse {
  const lowerMessage = message.toLowerCase()
  
  // Respuestas mock basadas en keywords
  if (lowerMessage.includes('maria') || lowerMessage.includes('lopez')) {
    return {
      success: true,
      response: {
        message: 'Maria Lopez tiene un **score promedio de 82** esta semana, con **12 llamadas** analizadas.\n\n**Metricas destacadas:**\n- Ranking: #1 en Equipo Norte\n- Tasa de validacion: 100%\n- Probabilidad cumplimiento: 75.6%\n\nExcelente rendimiento!',
        type: 'text',
        suggestions: [
          'Ver detalle del coaching de Maria',
          'Comparar con otros agentes',
          'Ver sus mejores llamadas'
        ]
      },
      conversation_id: 'mock',
      timestamp: new Date().toISOString()
    }
  }

  if (lowerMessage.includes('alerta') || lowerMessage.includes('critica')) {
    return {
      success: true,
      response: {
        message: 'Actualmente hay **3 alertas activas**:',
        type: 'data',
        data: {
          type: 'table',
          title: 'Alertas Activas',
          columns: ['Severidad', 'Descripcion', 'Estado'],
          rows: [
            ['Critica', 'Score bajo en llamada de Jose Perez', 'Nueva'],
            ['Alta', 'Tasa de validacion cayo 15%', 'Nueva'],
            ['Media', 'Maria no logra validacion en 68%', 'En revision']
          ]
        },
        suggestions: [
          'Ver detalle de la alerta critica',
          'Quien es Jose Perez?',
          'Resolver la primera alerta'
        ]
      },
      conversation_id: 'mock',
      timestamp: new Date().toISOString()
    }
  }

  if (lowerMessage.includes('score') || lowerMessage.includes('metrica')) {
    return {
      success: true,
      response: {
        message: 'Aqui estan las metricas principales de hoy:',
        type: 'metrics',
        data: {
          type: 'metrics',
          items: [
            { label: 'Score Promedio', value: '72', change: '+5', trend: 'up' },
            { label: 'Llamadas Hoy', value: '127', change: '+12', trend: 'up' },
            { label: 'Validacion', value: '52%', change: '-3', trend: 'down' },
            { label: 'Alertas', value: '3', change: '0', trend: 'stable' }
          ]
        },
        suggestions: [
          'Por que bajo la validacion?',
          'Quien tiene mejor score?',
          'Tendencia de la semana'
        ]
      },
      conversation_id: 'mock',
      timestamp: new Date().toISOString()
    }
  }

  if (lowerMessage.includes('agente') || lowerMessage.includes('equipo') || lowerMessage.includes('mejor')) {
    return {
      success: true,
      response: {
        message: 'Top 5 agentes por score esta semana:',
        type: 'data',
        data: {
          type: 'table',
          title: 'Ranking de Agentes',
          columns: ['#', 'Agente', 'Score', 'Llamadas', 'Validacion'],
          rows: [
            ['1', 'Carlos Ramirez', '89', '145', '78%'],
            ['2', 'Luis Torres', '82', '132', '71%'],
            ['3', 'Maria Lopez', '82', '12', '100%'],
            ['4', 'Ana Martinez', '78', '128', '65%'],
            ['5', 'Jose Perez', '58', '98', '38%']
          ]
        },
        suggestions: [
          'Como puedo ayudar a Jose Perez?',
          'Ver coaching de Carlos',
          'Comparar Equipo Norte vs Sur'
        ]
      },
      conversation_id: 'mock',
      timestamp: new Date().toISOString()
    }
  }

  // Respuesta generica
  return {
    success: true,
    response: {
      message: 'Entiendo tu consulta. Puedo ayudarte con:\n\n- **Metricas**: Score, validacion, llamadas\n- **Agentes**: Rendimiento individual o de equipo\n- **Alertas**: Estado actual y detalles\n- **Coaching**: Reportes y planes de mejora\n- **Tendencias**: Analisis temporal\n\nPuedes ser mas especifico?',
      type: 'text',
      suggestions: [
        'Como esta Maria Lopez?',
        'Hay alertas criticas?',
        'Cual es el score promedio?',
        'Quien necesita coaching?'
      ]
    },
    conversation_id: 'mock',
    timestamp: new Date().toISOString()
  }
}

// ---------- Helper ----------

/**
 * Genera un ID unico para conversaciones
 */
export function generateConversationId(): string {
  return `conv-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`
}
</file>

<file path="src/stores/chatStore.ts">
// ============================================
// NODUS - Chat Store (Zustand)
// Estado del chat conversacional
// ============================================

import { create } from 'zustand'
import { persist } from 'zustand/middleware'
import { 
  sendChatMessage, 
  generateConversationId,
  isChatConfigured,
  type ChatMessage,
  type ChatResponseData
} from '@/services/chatService'

// ---------- Types ----------

interface StoredMessage {
  id: string
  role: 'user' | 'assistant'
  content: string
  timestamp: string
  data?: ChatResponseData
  suggestions?: string[]
  isError?: boolean
}

interface ChatState {
  // Estado
  messages: StoredMessage[]
  conversationId: string
  isLoading: boolean
  isConnected: boolean
  error: string | null
  
  // Acciones
  sendMessage: (content: string) => Promise<void>
  addSuggestionClick: (suggestion: string) => Promise<void>
  clearChat: () => void
  setError: (error: string | null) => void
}

// ---------- Initial Message ----------

const getWelcomeMessage = (): StoredMessage => ({
  id: 'welcome',
  role: 'assistant',
  content: 'Hola! Soy el asistente de NODUS. Puedo ayudarte a analizar datos de tu equipo de cobranza, revisar metricas, consultar alertas y mas. Que te gustaria saber?',
  timestamp: new Date().toISOString(),
  suggestions: [
    'Como esta Maria Lopez?',
    'Hay alertas criticas?',
    'Cual es el score promedio?',
    'Quien necesita coaching?'
  ]
})

// ---------- Store ----------

export const useChatStore = create<ChatState>()(
  persist(
    (set, get) => ({
      // Estado inicial
      messages: [getWelcomeMessage()],
      conversationId: generateConversationId(),
      isLoading: false,
      isConnected: isChatConfigured(),
      error: null,

      // Enviar mensaje
      sendMessage: async (content: string) => {
        const { messages, conversationId, isLoading } = get()
        
        if (isLoading || !content.trim()) return

        // Agregar mensaje del usuario
        const userMessage: StoredMessage = {
          id: `user-${Date.now()}`,
          role: 'user',
          content: content.trim(),
          timestamp: new Date().toISOString()
        }

        set({ 
          messages: [...messages, userMessage],
          isLoading: true,
          error: null
        })

        try {
          // Preparar historial para el webhook
          const history: ChatMessage[] = messages
            .filter(m => m.id !== 'welcome')
            .map(m => ({
              role: m.role,
              content: m.content,
              timestamp: m.timestamp,
              data: m.data
            }))

          // Enviar al webhook
          const response = await sendChatMessage({
            message: content.trim(),
            conversation_id: conversationId,
            history,
            context: {
              current_page: window.location.pathname,
              date_range: {
                from: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                to: new Date().toISOString().split('T')[0]
              }
            }
          })

          // Crear mensaje de respuesta
          const assistantMessage: StoredMessage = {
            id: `assistant-${Date.now()}`,
            role: 'assistant',
            content: response.response.message,
            timestamp: response.timestamp || new Date().toISOString(),
            data: response.response.data,
            suggestions: response.response.suggestions,
            isError: response.response.type === 'error'
          }

          set(state => ({
            messages: [...state.messages, assistantMessage],
            isLoading: false
          }))

        } catch (error) {
          console.error('Error sending message:', error)
          
          const errorMessage: StoredMessage = {
            id: `error-${Date.now()}`,
            role: 'assistant',
            content: 'Lo siento, hubo un problema al procesar tu mensaje. Por favor intenta de nuevo.',
            timestamp: new Date().toISOString(),
            isError: true,
            suggestions: ['Intentar de nuevo', 'Limpiar chat']
          }

          set(state => ({
            messages: [...state.messages, errorMessage],
            isLoading: false,
            error: (error as Error).message
          }))
        }
      },

      // Click en sugerencia
      addSuggestionClick: async (suggestion: string) => {
        await get().sendMessage(suggestion)
      },

      // Limpiar chat
      clearChat: () => {
        set({
          messages: [getWelcomeMessage()],
          conversationId: generateConversationId(),
          error: null
        })
      },

      // Set error
      setError: (error: string | null) => {
        set({ error })
      }
    }),
    {
      name: 'nodus-chat-storage',
      partialize: (state) => ({
        messages: state.messages.slice(-50), // Guardar ultimos 50 mensajes
        conversationId: state.conversationId
      })
    }
  )
)

// ---------- Selectors ----------

export const useMessages = () => useChatStore(state => state.messages)
export const useIsLoading = () => useChatStore(state => state.isLoading)
export const useIsConnected = () => useChatStore(state => state.isConnected)
</file>

<file path="src/types/database.ts">
// ============================================
// NODUS - Database Types (Supabase)
// Tipos generados del schema de Supabase
// ============================================

export type Json =
  | string
  | number
  | boolean
  | null
  | { [key: string]: Json | undefined }
  | Json[]

// Enums
export type EstadoProcesamiento = 'pendiente' | 'procesando' | 'transcrito' | 'analizado' | 'error'
export type NivelCumplimiento = 'baja' | 'media' | 'alta'
export type SeveridadAlerta = 'critica' | 'alta' | 'media' | 'baja'
export type EstadoAlerta = 'nueva' | 'en_revision' | 'resuelta' | 'falso_positivo'
export type EstadoAgente = 'activo' | 'inactivo' | 'vacaciones'
export type TipoAlerta = 'individual' | 'sistemica' | 'patron'

export interface Database {
  public: {
    Tables: {
      agentes: {
        Row: {
          agente_id: string
          nombre: string
          email: string | null
          avatar_url: string | null
          codigo_externo: string | null
          fecha_ingreso: string | null
          estado: EstadoAgente
          equipo: string | null
          supervisor_id: string | null
          metadata: Json
          created_at: string
          updated_at: string
        }
        Insert: {
          agente_id?: string
          nombre: string
          email?: string | null
          avatar_url?: string | null
          codigo_externo?: string | null
          fecha_ingreso?: string | null
          estado?: EstadoAgente
          equipo?: string | null
          supervisor_id?: string | null
          metadata?: Json
          created_at?: string
          updated_at?: string
        }
        Update: {
          agente_id?: string
          nombre?: string
          email?: string | null
          avatar_url?: string | null
          codigo_externo?: string | null
          fecha_ingreso?: string | null
          estado?: EstadoAgente
          equipo?: string | null
          supervisor_id?: string | null
          metadata?: Json
          created_at?: string
          updated_at?: string
        }
      }
      registro_llamadas: {
        Row: {
          registro_id: string
          audio_url: string
          audio_id_externo: string | null
          timestamp_inicio: string
          timestamp_fin: string
          duracion_segundos: number | null
          timestamp_fecha: string | null
          agente_id: string
          cliente_ref: string
          campana: string | null
          tipo_deuda: string | null
          monto_deuda: number | null
          dias_mora: number | null
          estado: EstadoProcesamiento
          error_mensaje: string | null
          transcripcion_id: string | null
          analisis_id: string | null
          metadata_externa: Json
          created_at: string
          updated_at: string
        }
        Insert: {
          registro_id?: string
          audio_url: string
          audio_id_externo?: string | null
          timestamp_inicio: string
          timestamp_fin: string
          duracion_segundos?: number | null
          timestamp_fecha?: string | null
          agente_id: string
          cliente_ref: string
          campana?: string | null
          tipo_deuda?: string | null
          monto_deuda?: number | null
          dias_mora?: number | null
          estado?: EstadoProcesamiento
          error_mensaje?: string | null
          transcripcion_id?: string | null
          analisis_id?: string | null
          metadata_externa?: Json
          created_at?: string
          updated_at?: string
        }
        Update: {
          registro_id?: string
          audio_url?: string
          audio_id_externo?: string | null
          timestamp_inicio?: string
          timestamp_fin?: string
          duracion_segundos?: number | null
          timestamp_fecha?: string | null
          agente_id?: string
          cliente_ref?: string
          campana?: string | null
          tipo_deuda?: string | null
          monto_deuda?: number | null
          dias_mora?: number | null
          estado?: EstadoProcesamiento
          error_mensaje?: string | null
          transcripcion_id?: string | null
          analisis_id?: string | null
          metadata_externa?: Json
          created_at?: string
          updated_at?: string
        }
      }
      transcripciones: {
        Row: {
          transcripcion_id: string
          registro_id: string
          transcripcion_completa: string
          segmentos: Json
          entidades: Json
          metricas_conversacion: Json
          calidad_audio: Json
          modelo_transcripcion: string | null
          modelo_emociones: string | null
          modelo_entidades: string | null
          tiempo_procesamiento_ms: number | null
          created_at: string
        }
        Insert: {
          transcripcion_id?: string
          registro_id: string
          transcripcion_completa: string
          segmentos?: Json
          entidades?: Json
          metricas_conversacion?: Json
          calidad_audio?: Json
          modelo_transcripcion?: string | null
          modelo_emociones?: string | null
          modelo_entidades?: string | null
          tiempo_procesamiento_ms?: number | null
          created_at?: string
        }
        Update: {
          transcripcion_id?: string
          registro_id?: string
          transcripcion_completa?: string
          segmentos?: Json
          entidades?: Json
          metricas_conversacion?: Json
          calidad_audio?: Json
          modelo_transcripcion?: string | null
          modelo_emociones?: string | null
          modelo_entidades?: string | null
          tiempo_procesamiento_ms?: number | null
          created_at?: string
        }
      }
      analisis_llamadas: {
        Row: {
          analisis_id: string
          registro_id: string
          transcripcion_id: string
          agente_id: string
          score_total: number
          score_contacto_directo: number | null
          score_compromiso_pago: number | null
          modulo_contacto_directo: Json
          modulo_compromiso_pago: Json
          modulo_abandono: Json
          probabilidad_cumplimiento: number
          nivel_cumplimiento: NivelCumplimiento
          factores_prediccion: Json
          alertas: Json
          recomendaciones: Json
          modelo_usado: string | null
          version_prompt: string | null
          confianza_analisis: number | null
          tiempo_procesamiento_ms: number | null
          fecha_llamada: string
          created_at: string
        }
        Insert: {
          analisis_id?: string
          registro_id: string
          transcripcion_id: string
          agente_id: string
          score_total: number
          score_contacto_directo?: number | null
          score_compromiso_pago?: number | null
          modulo_contacto_directo?: Json
          modulo_compromiso_pago?: Json
          modulo_abandono?: Json
          probabilidad_cumplimiento: number
          nivel_cumplimiento: NivelCumplimiento
          factores_prediccion?: Json
          alertas?: Json
          recomendaciones?: Json
          modelo_usado?: string | null
          version_prompt?: string | null
          confianza_analisis?: number | null
          tiempo_procesamiento_ms?: number | null
          fecha_llamada: string
          created_at?: string
        }
        Update: {
          analisis_id?: string
          registro_id?: string
          transcripcion_id?: string
          agente_id?: string
          score_total?: number
          score_contacto_directo?: number | null
          score_compromiso_pago?: number | null
          modulo_contacto_directo?: Json
          modulo_compromiso_pago?: Json
          modulo_abandono?: Json
          probabilidad_cumplimiento?: number
          nivel_cumplimiento?: NivelCumplimiento
          factores_prediccion?: Json
          alertas?: Json
          recomendaciones?: Json
          modelo_usado?: string | null
          version_prompt?: string | null
          confianza_analisis?: number | null
          tiempo_procesamiento_ms?: number | null
          fecha_llamada?: string
          created_at?: string
        }
      }
      alertas_anomalias: {
        Row: {
          alerta_id: string
          tipo: TipoAlerta
          severidad: SeveridadAlerta
          categoria: string | null
          codigo: string | null
          descripcion: string
          causa_probable: string | null
          datos_soporte: Json
          impacto_estimado: Json
          accion_recomendada: Json
          registro_id: string | null
          agentes_relacionados: string[] | null
          estado: EstadoAlerta
          notificacion_enviada: boolean
          resuelto_por: string | null
          fecha_resolucion: string | null
          notas_resolucion: string | null
          created_at: string
          updated_at: string
        }
        Insert: {
          alerta_id?: string
          tipo: TipoAlerta
          severidad: SeveridadAlerta
          categoria?: string | null
          codigo?: string | null
          descripcion: string
          causa_probable?: string | null
          datos_soporte?: Json
          impacto_estimado?: Json
          accion_recomendada?: Json
          registro_id?: string | null
          agentes_relacionados?: string[] | null
          estado?: EstadoAlerta
          notificacion_enviada?: boolean
          resuelto_por?: string | null
          fecha_resolucion?: string | null
          notas_resolucion?: string | null
          created_at?: string
          updated_at?: string
        }
        Update: {
          alerta_id?: string
          tipo?: TipoAlerta
          severidad?: SeveridadAlerta
          categoria?: string | null
          codigo?: string | null
          descripcion?: string
          causa_probable?: string | null
          datos_soporte?: Json
          impacto_estimado?: Json
          accion_recomendada?: Json
          registro_id?: string | null
          agentes_relacionados?: string[] | null
          estado?: EstadoAlerta
          notificacion_enviada?: boolean
          resuelto_por?: string | null
          fecha_resolucion?: string | null
          notas_resolucion?: string | null
          created_at?: string
          updated_at?: string
        }
      }
      coaching_reports: {
        Row: {
          reporte_id: string
          agente_id: string
          fecha_reporte: string
          periodo_inicio: string
          periodo_fin: string
          total_llamadas_analizadas: number
          metricas_periodo: Json
          comparativa_equipo: Json
          fortalezas: Json
          gap_critico: Json | null
          patrones: Json
          plan_mejora: Json
          progreso_vs_anterior: Json
          generado_por: string
          modelo_usado: string | null
          created_at: string
        }
        Insert: {
          reporte_id?: string
          agente_id: string
          fecha_reporte: string
          periodo_inicio: string
          periodo_fin: string
          total_llamadas_analizadas?: number
          metricas_periodo?: Json
          comparativa_equipo?: Json
          fortalezas?: Json
          gap_critico?: Json | null
          patrones?: Json
          plan_mejora?: Json
          progreso_vs_anterior?: Json
          generado_por?: string
          modelo_usado?: string | null
          created_at?: string
        }
        Update: {
          reporte_id?: string
          agente_id?: string
          fecha_reporte?: string
          periodo_inicio?: string
          periodo_fin?: string
          total_llamadas_analizadas?: number
          metricas_periodo?: Json
          comparativa_equipo?: Json
          fortalezas?: Json
          gap_critico?: Json | null
          patrones?: Json
          plan_mejora?: Json
          progreso_vs_anterior?: Json
          generado_por?: string
          modelo_usado?: string | null
          created_at?: string
        }
      }
      metricas_agregadas: {
        Row: {
          metrica_id: string
          fecha: string
          agente_id: string | null
          equipo: string | null
          campana: string | null
          total_llamadas: number
          duracion_total_segundos: number
          duracion_promedio_segundos: number
          score_promedio: number | null
          score_min: number | null
          score_max: number | null
          desviacion_estandar: number | null
          probabilidad_cumplimiento_promedio: number | null
          tasa_validacion: number | null
          llamadas_score_alto: number
          llamadas_score_medio: number
          llamadas_score_bajo: number
          llamadas_con_abandono: number
          tasa_abandono: number | null
          alertas_criticas: number
          alertas_altas: number
          alertas_medias: number
          created_at: string
          updated_at: string
        }
        Insert: {
          metrica_id?: string
          fecha: string
          agente_id?: string | null
          equipo?: string | null
          campana?: string | null
          total_llamadas?: number
          duracion_total_segundos?: number
          duracion_promedio_segundos?: number
          score_promedio?: number | null
          score_min?: number | null
          score_max?: number | null
          desviacion_estandar?: number | null
          probabilidad_cumplimiento_promedio?: number | null
          tasa_validacion?: number | null
          llamadas_score_alto?: number
          llamadas_score_medio?: number
          llamadas_score_bajo?: number
          llamadas_con_abandono?: number
          tasa_abandono?: number | null
          alertas_criticas?: number
          alertas_altas?: number
          alertas_medias?: number
          created_at?: string
          updated_at?: string
        }
        Update: {
          metrica_id?: string
          fecha?: string
          agente_id?: string | null
          equipo?: string | null
          campana?: string | null
          total_llamadas?: number
          duracion_total_segundos?: number
          duracion_promedio_segundos?: number
          score_promedio?: number | null
          score_min?: number | null
          score_max?: number | null
          desviacion_estandar?: number | null
          probabilidad_cumplimiento_promedio?: number | null
          tasa_validacion?: number | null
          llamadas_score_alto?: number
          llamadas_score_medio?: number
          llamadas_score_bajo?: number
          llamadas_con_abandono?: number
          tasa_abandono?: number | null
          alertas_criticas?: number
          alertas_altas?: number
          alertas_medias?: number
          created_at?: string
          updated_at?: string
        }
      }
    }
    Views: {
      vista_resumen_agentes: {
        Row: {
          agente_id: string
          nombre: string
          equipo: string | null
          estado: EstadoAgente
          llamadas_semana: number | null
          score_semana: number | null
          prob_cumplimiento_semana: number | null
          tasa_validacion_ultimo_reporte: number | null
        }
      }
    }
    Functions: {
      obtener_datos_coaching: {
        Args: { p_agente_id: string; p_periodo_dias?: number }
        Returns: Json
      }
      obtener_agentes_para_coaching: {
        Args: { p_periodo_dias?: number; p_min_llamadas?: number }
        Returns: {
          agente_id: string
          nombre: string
          equipo: string | null
          total_llamadas: number
          score_promedio: number
          tiene_reporte_anterior: boolean
        }[]
      }
      ejecutar_detector: {
        Args: { p_periodo_horas?: number; p_umbral_score?: number }
        Returns: {
          tipo: TipoAlerta
          severidad: SeveridadAlerta
          codigo: string
          descripcion: string
          agente_id: string | null
          agente_nombre: string | null
          equipo: string | null
          datos: Json
          accion_requerida: string
          es_nueva: boolean
        }[]
      }
    }
  }
}

// Helper types
export type Tables<T extends keyof Database['public']['Tables']> = Database['public']['Tables'][T]['Row']
export type InsertTables<T extends keyof Database['public']['Tables']> = Database['public']['Tables'][T]['Insert']
export type UpdateTables<T extends keyof Database['public']['Tables']> = Database['public']['Tables'][T]['Update']
export type Views<T extends keyof Database['public']['Views']> = Database['public']['Views'][T]['Row']

// Alias types
export type Agente = Tables<'agentes'>
export type RegistroLlamada = Tables<'registro_llamadas'>
export type Transcripcion = Tables<'transcripciones'>
export type AnalisisLlamada = Tables<'analisis_llamadas'>
export type AlertaAnomalia = Tables<'alertas_anomalias'>
export type CoachingReport = Tables<'coaching_reports'>
export type MetricaAgregada = Tables<'metricas_agregadas'>
export type ResumenAgente = Views<'vista_resumen_agentes'>
</file>

<file path="src/types/index.ts">
// ============================================
// NODUS - Type Definitions
// Sistema de An√°lisis Inteligente de Cobranza
// ============================================

// ---------- Enums ----------

export type EstadoLlamada = 'pendiente' | 'transcrito' | 'analizado' | 'error'
export type NivelCumplimiento = 'baja' | 'media' | 'alta'
export type Severidad = 'critica' | 'alta' | 'media' | 'baja'
export type EstadoAlerta = 'nueva' | 'en_revision' | 'resuelta' | 'falso_positivo'
export type Speaker = 'agente' | 'cliente'
export type Emocion = 'neutral' | 'positivo' | 'negativo'

// ---------- Llamadas ----------

export interface Llamada {
  llamada_id: string
  audio_url: string
  audio_format?: string
  duracion_segundos: number
  timestamp_inicio: string
  timestamp_fin: string
  agente_id: string
  agente_nombre?: string
  cliente_id: string
  deuda_id?: string
  campana?: string
  tipo_deuda?: string
  estado: EstadoLlamada
  created_at: string
  updated_at: string
}

// ---------- Transcripciones ----------

export interface Segmento {
  speaker: Speaker
  timestamp_inicio: number
  timestamp_fin?: number
  texto: string
  emocion: Emocion
  velocidad_habla?: number
}

export interface EntidadMonto {
  valor: number
  moneda: string
  contexto: string
}

export interface EntidadFecha {
  fecha: string
  contexto: string
}

export interface EntidadesDetectadas {
  montos: EntidadMonto[]
  fechas: EntidadFecha[]
  metodos_pago: string[]
}

export interface Transcripcion {
  transcripcion_id: string
  llamada_id: string
  transcripcion_completa: string
  segmentos: Segmento[]
  entidades: EntidadesDetectadas
  analisis_conversacion?: {
    interrupciones: number
    silencios: number
    palabras_clave: string[]
  }
  metricas_audio?: {
    calidad: number
    ruido: number
    inaudibles: number
  }
  created_at: string
}

// ---------- An√°lisis ----------

export interface DesgloseItem {
  presente: boolean
  puntos: number
  evidencia?: string
}

export interface ModuloContactoDirecto {
  score: number
  desglose: {
    monto_mencionado: DesgloseItem
    fecha_vencimiento: DesgloseItem
    consecuencias_impago: DesgloseItem
    alternativas_pago: DesgloseItem
    manejo_objeciones: DesgloseItem & {
      objeciones_detectadas?: number
      calidad?: number
    }
  }
}

export interface ModuloCompromisoPago {
  score: number
  desglose: {
    oferta_clara: DesgloseItem
    alternativas_pago: DesgloseItem
    fecha_especifica: DesgloseItem
    validacion_cliente: DesgloseItem & {
      tipo?: 'explicita' | 'implicita' | 'ausente'
      frase_exacta?: string
    }
  }
}

export interface ModuloAbandono {
  hubo_abandono: boolean
  momento?: number
  razon?: string
  patron?: string
}

export interface PrediccionCumplimiento {
  probabilidad: number
  nivel: NivelCumplimiento
  factores_positivos: string[]
  factores_negativos: string[]
  razonamiento: string
}

export interface Alerta {
  tipo: 'advertencia' | 'critica' | 'info'
  codigo: string
  mensaje: string
}

export interface Recomendacion {
  prioridad: 'alta' | 'media' | 'baja'
  destinatario: 'supervisor' | 'agente' | 'ti'
  accion: string
}

export interface AnalisisLlamada {
  analisis_id: string
  llamada_id: string
  transcripcion_id: string
  score_total: number
  score_contacto_directo: number
  score_compromiso_pago: number
  modulo_contacto_directo: ModuloContactoDirecto
  modulo_compromiso_pago: ModuloCompromisoPago
  modulo_abandono: ModuloAbandono
  prediccion_cumplimiento: PrediccionCumplimiento
  alertas: Alerta[]
  recomendaciones: Recomendacion[]
  modelo_usado?: string
  version_prompt?: string
  confianza_analisis?: number
  created_at: string
}

// ---------- Agentes ----------

export interface Agente {
  agente_id: string
  nombre: string
  email?: string
  fecha_ingreso?: string
  estado: 'activo' | 'inactivo' | 'vacaciones'
  equipo?: string
  supervisor_id?: string
  avatar_url?: string
  created_at: string
}

export interface MetricasAgente {
  total_llamadas: number
  score_promedio: number
  tasa_validacion: number
  probabilidad_cumplimiento_promedio: number
  tendencia: 'mejorando' | 'estable' | 'decayendo'
  ranking?: number
  percentil?: number
}

// ---------- Coaching ----------

export interface Fortaleza {
  area: string
  descripcion: string
  evidencia: string
}

export interface GapCritico {
  area: string
  descripcion: string
  impacto: string
  ejemplos_llamadas: string[]
}

export interface AccionMejora {
  accion: string
  como: string
  prioridad: 'alta' | 'media' | 'baja'
}

export interface LlamadaParaRevisar {
  llamada_id: string
  razon: string
  que_observar: string
}

export interface PlanMejora {
  objetivo_semana: string
  acciones: AccionMejora[]
  llamadas_para_revisar: LlamadaParaRevisar[]
}

export interface CoachingReport {
  reporte_id: string
  agente_id: string
  nombre_agente: string
  fecha_reporte: string
  periodo_inicio: string
  periodo_fin: string
  total_llamadas_analizadas: number
  metricas_periodo: MetricasAgente
  comparativa_equipo?: {
    score_equipo: number
    validacion_equipo: number
  }
  fortalezas: Fortaleza[]
  gap_critico: GapCritico
  plan_mejora: PlanMejora
  created_at: string
}

// ---------- Alertas/Anomal√≠as ----------

export interface AlertaAnomalia {
  alerta_id: string
  tipo: 'individual' | 'sistemica' | 'patron'
  severidad: Severidad
  categoria?: string
  descripcion: string
  datos_soporte?: Record<string, unknown>
  causa_probable?: string
  impacto_estimado?: {
    llamadas_afectadas: number
    perdida_oportunidades?: number
  }
  accion_recomendada?: {
    urgencia: 'inmediata' | 'hoy' | 'esta_semana'
    destinatario: string
    accion: string
  }
  llamadas_relacionadas?: string[]
  agentes_relacionados?: string[]
  estado: EstadoAlerta
  notificacion_enviada: boolean
  created_at: string
}

// ---------- Chat ----------

export interface ChatMessage {
  message_id: string
  role: 'user' | 'assistant'
  content: string
  timestamp: string
  visualizaciones?: ChatVisualizacion[]
  acciones_sugeridas?: ChatAccion[]
  preguntas_relacionadas?: string[]
}

export interface ChatVisualizacion {
  tipo: 'chart' | 'table' | 'metric'
  data: Record<string, unknown>
}

export interface ChatAccion {
  tipo: string
  label: string
  accion: string
  parametros?: Record<string, unknown>
}

// ---------- Dashboard ----------

export interface DashboardMetrics {
  total_llamadas: number
  llamadas_hoy: number
  score_promedio: number
  cambio_score: number
  tasa_validacion: number
  cambio_validacion: number
  probabilidad_promedio: number
  cambio_probabilidad: number
  alertas_activas: number
  monto_comprometido: number
}

export interface TendenciaDia {
  fecha: string
  llamadas: number
  score: number
  validacion: number
}

// ---------- Estrategia ----------

export interface HallazgoEstrategico {
  titulo: string
  categoria: 'temporal' | 'script' | 'agente' | 'cliente'
  descripcion: string
  hipotesis?: string
  recomendacion: string
  impacto_proyectado: {
    metrica: string
    mejora_esperada: number
    confianza: 'alta' | 'media' | 'baja'
  }
}

export interface ReporteEstrategia {
  fecha_reporte: string
  periodo: {
    inicio: string
    fin: string
    dias: number
  }
  resumen_ejecutivo: {
    total_llamadas: number
    score_promedio: number
    cambio_vs_anterior: number
    logros: string[]
    preocupaciones: string[]
  }
  hallazgos_estrategicos: HallazgoEstrategico[]
  analisis_temporal: {
    mejor_dia: string
    peor_dia: string
    mejor_hora: string
  }
  top_performers: Array<{
    agente: string
    score: number
    patron_clave: string
  }>
}
</file>

<file path="src/App.tsx">
import { Routes, Route } from 'react-router-dom'
import { MainLayout } from '@/components/layout/MainLayout'
import { 
  Dashboard, 
  Llamadas, 
  DetalleLlamada, 
  Agentes, 
  Chat, 
  Alertas,
  ModulosOverview,
  ContactoDirecto,
  CompromisoPago,
  AbandonoLlamadas
} from '@/pages'
import { TooltipProvider } from '@/components/ui/tooltip'

function App() {
  return (
    <TooltipProvider>
      <Routes>
        <Route element={<MainLayout />}>
          <Route path="/" element={<Dashboard />} />
          <Route path="/llamadas" element={<Llamadas />} />
          <Route path="/llamadas/:id" element={<DetalleLlamada />} />
          <Route path="/agentes" element={<Agentes />} />
          <Route path="/agentes/:id" element={<Agentes />} />
          {/* Modulos de Analisis */}
          <Route path="/modulos" element={<ModulosOverview />} />
          <Route path="/modulos/contacto" element={<ContactoDirecto />} />
          <Route path="/modulos/compromiso" element={<CompromisoPago />} />
          <Route path="/modulos/abandono" element={<AbandonoLlamadas />} />
          {/* Otros */}
          <Route path="/coaching" element={<Dashboard />} />
          <Route path="/alertas" element={<Alertas />} />
          <Route path="/estrategia" element={<Dashboard />} />
          <Route path="/chat" element={<Chat />} />
          <Route path="/settings" element={<Dashboard />} />
        </Route>
      </Routes>
    </TooltipProvider>
  )
}

export default App
</file>

<file path="src/index.css">
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  :root {
    /* NODUS Light Theme - Clean & Minimal */
    --background: 0 0% 100%;
    --foreground: 222 47% 11%;

    --card: 0 0% 100%;
    --card-foreground: 222 47% 11%;

    --popover: 0 0% 100%;
    --popover-foreground: 222 47% 11%;

    --primary: 173 80% 40%;              /* Teal accent */
    --primary-foreground: 0 0% 100%;

    --secondary: 220 14% 96%;
    --secondary-foreground: 222 47% 11%;

    --muted: 220 14% 96%;
    --muted-foreground: 220 9% 46%;

    --accent: 220 14% 96%;
    --accent-foreground: 222 47% 11%;

    --destructive: 0 84% 60%;
    --destructive-foreground: 0 0% 100%;

    --success: 160 84% 39%;
    --success-foreground: 0 0% 100%;

    --warning: 38 92% 50%;
    --warning-foreground: 0 0% 100%;

    --border: 220 13% 91%;
    --input: 220 13% 91%;
    --ring: 173 80% 40%;

    --radius: 0.5rem;
    
    /* Chart colors */
    --chart-1: 173 80% 40%;
    --chart-2: 340 75% 55%;
    --chart-3: 262 83% 58%;
    --chart-4: 160 84% 39%;
    --chart-5: 38 92% 50%;
  }

  .dark {
    --background: 222 47% 11%;
    --foreground: 210 20% 98%;
    --card: 222 47% 13%;
    --card-foreground: 210 20% 98%;
    --popover: 222 47% 13%;
    --popover-foreground: 210 20% 98%;
    --primary: 173 80% 40%;
    --primary-foreground: 0 0% 100%;
    --secondary: 222 47% 16%;
    --secondary-foreground: 210 20% 98%;
    --muted: 222 47% 16%;
    --muted-foreground: 215 20% 65%;
    --accent: 222 47% 16%;
    --accent-foreground: 210 20% 98%;
    --destructive: 0 84% 60%;
    --destructive-foreground: 0 0% 100%;
    --success: 160 84% 39%;
    --success-foreground: 0 0% 100%;
    --warning: 38 92% 50%;
    --warning-foreground: 0 0% 100%;
    --border: 222 47% 18%;
    --input: 222 47% 18%;
    --ring: 173 80% 40%;
  }
}

@layer base {
  * {
    @apply border-border;
  }

  html {
    @apply antialiased;
    font-feature-settings: "cv02", "cv03", "cv04", "cv11";
  }

  body {
    @apply bg-background text-foreground;
    font-family: 'Plus Jakarta Sans', system-ui, sans-serif;
  }

  /* Clean scrollbar */
  ::-webkit-scrollbar {
    width: 6px;
    height: 6px;
  }

  ::-webkit-scrollbar-track {
    @apply bg-transparent;
  }

  ::-webkit-scrollbar-thumb {
    @apply bg-border rounded-full;
  }

  ::-webkit-scrollbar-thumb:hover {
    @apply bg-muted-foreground/30;
  }

  /* Selection */
  ::selection {
    @apply bg-primary/20 text-foreground;
  }
}

@layer components {
  /* Clean card style */
  .card-clean {
    @apply bg-card border border-border rounded-xl;
  }

  /* Subtle hover effect */
  .hover-lift {
    @apply transition-all duration-200;
  }

  .hover-lift:hover {
    @apply shadow-md -translate-y-0.5;
  }

  /* Score indicator colors */
  .score-high {
    @apply text-success;
  }

  .score-medium {
    @apply text-warning;
  }

  .score-low {
    @apply text-destructive;
  }

  /* Data/metric text style */
  .metric {
    @apply font-semibold tracking-tight;
  }

  /* Skeleton loading */
  .skeleton {
    @apply animate-pulse bg-muted rounded;
  }

  /* Badge styles for status */
  .status-active {
    @apply bg-success/10 text-success border-success/20;
  }

  .status-inactive {
    @apply bg-muted text-muted-foreground;
  }

  .status-pending {
    @apply bg-warning/10 text-warning border-warning/20;
  }

  /* Mini sparkline container */
  .sparkline {
    @apply h-8 w-20;
  }
}

@layer utilities {
  /* Hide scrollbar but keep functionality */
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }

  /* Focus ring */
  .focus-ring {
    @apply focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background;
  }
}
</file>

<file path="src/main.tsx">
import React from 'react'
import ReactDOM from 'react-dom/client'
import { BrowserRouter } from 'react-router-dom'
import App from './App'
import './index.css'

ReactDOM.createRoot(document.getElementById('root')!).render(
  //<React.StrictMode>
    <BrowserRouter>
      <App />
    </BrowserRouter>
  //</React.StrictMode>,
)
</file>

<file path="src/vite-env.d.ts">
/// <reference types="vite/client" />
</file>

<file path="supabase/functions/coach_functions.sql">
-- ============================================================================
-- FUNCIONES DEL AGENTE COACH
-- Calculo de metricas, comparativas y datos para LLM
-- ============================================================================

-- ----------------------------------------------------------------------------
-- 1. FUNCION: Obtener agentes activos para coaching
-- Retorna agentes con al menos 7 dias de antiguedad
-- ----------------------------------------------------------------------------

CREATE OR REPLACE FUNCTION obtener_agentes_coaching(
    p_dias_minimo INTEGER DEFAULT 7
)
RETURNS TABLE (
    agente_id UUID,
    nombre TEXT,
    email TEXT,
    equipo TEXT,
    supervisor_id UUID,
    fecha_ingreso DATE,
    dias_activo INTEGER
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        a.agente_id,
        a.nombre::TEXT,
        a.email::TEXT,
        a.equipo::TEXT,
        a.supervisor_id,
        a.fecha_ingreso,
        EXTRACT(DAY FROM NOW() - a.fecha_ingreso)::INTEGER as dias_activo
    FROM agentes a
    WHERE a.estado = 'activo'
      AND a.fecha_ingreso < NOW() - (p_dias_minimo || ' days')::INTERVAL;
END;
$$ LANGUAGE plpgsql;


-- ----------------------------------------------------------------------------
-- 2. FUNCION: Obtener metricas de un agente para el periodo
-- Calcula todas las metricas necesarias para coaching
-- ----------------------------------------------------------------------------

CREATE OR REPLACE FUNCTION obtener_metricas_agente(
    p_agente_id UUID,
    p_dias INTEGER DEFAULT 7,
    p_limite_llamadas INTEGER DEFAULT 25
)
RETURNS TABLE (
    total_llamadas BIGINT,
    score_promedio NUMERIC,
    score_min INTEGER,
    score_max INTEGER,
    score_contacto_promedio NUMERIC,
    score_compromiso_promedio NUMERIC,
    tasa_validacion_explicita NUMERIC,
    tasa_abandono NUMERIC,
    prob_cumplimiento_promedio NUMERIC,
    llamadas_excelentes BIGINT,
    llamadas_buenas BIGINT,
    llamadas_regulares BIGINT,
    llamadas_bajas BIGINT,
    fecha_inicio DATE,
    fecha_fin DATE
) AS $$
BEGIN
    RETURN QUERY
    WITH analisis_periodo AS (
        SELECT 
            al.score_total,
            al.score_contacto_directo,
            al.score_compromiso_pago,
            al.probabilidad_cumplimiento,
            al.modulo_compromiso_pago->'desglose'->'validacion_cliente'->>'tipo' as validacion_tipo,
            al.modulo_abandono->>'hubo_abandono' as hubo_abandono,
            al.created_at::DATE as fecha
        FROM analisis_llamadas al
        WHERE al.agente_id = p_agente_id
          AND al.created_at >= NOW() - (p_dias || ' days')::INTERVAL
        ORDER BY al.created_at DESC
        LIMIT p_limite_llamadas
    )
    SELECT 
        COUNT(*)::BIGINT,
        ROUND(AVG(score_total), 1),
        MIN(score_total),
        MAX(score_total),
        ROUND(AVG(score_contacto_directo), 1),
        ROUND(AVG(score_compromiso_pago), 1),
        ROUND(COUNT(*) FILTER (WHERE validacion_tipo = 'explicita')::NUMERIC / NULLIF(COUNT(*), 0), 2),
        ROUND(COUNT(*) FILTER (WHERE hubo_abandono = 'true')::NUMERIC / NULLIF(COUNT(*), 0), 2),
        ROUND(AVG(probabilidad_cumplimiento), 1),
        COUNT(*) FILTER (WHERE score_total >= 80)::BIGINT,
        COUNT(*) FILTER (WHERE score_total >= 60 AND score_total < 80)::BIGINT,
        COUNT(*) FILTER (WHERE score_total >= 40 AND score_total < 60)::BIGINT,
        COUNT(*) FILTER (WHERE score_total < 40)::BIGINT,
        MIN(fecha),
        MAX(fecha)
    FROM analisis_periodo;
END;
$$ LANGUAGE plpgsql;


-- ----------------------------------------------------------------------------
-- 3. FUNCION: Obtener benchmark del equipo
-- Metricas promedio del equipo para comparacion
-- ----------------------------------------------------------------------------

CREATE OR REPLACE FUNCTION obtener_benchmark_equipo(
    p_equipo TEXT,
    p_dias INTEGER DEFAULT 7
)
RETURNS TABLE (
    total_agentes BIGINT,
    total_llamadas BIGINT,
    score_promedio NUMERIC,
    score_top NUMERIC,
    tasa_validacion_promedio NUMERIC,
    prob_cumplimiento_promedio NUMERIC,
    tasa_abandono_promedio NUMERIC
) AS $$
BEGIN
    RETURN QUERY
    WITH metricas_por_agente AS (
        SELECT 
            al.agente_id,
            AVG(al.score_total) as score,
            COUNT(*) as llamadas,
            COUNT(*) FILTER (
                WHERE al.modulo_compromiso_pago->'desglose'->'validacion_cliente'->>'tipo' = 'explicita'
            )::NUMERIC / NULLIF(COUNT(*), 0) as tasa_val,
            AVG(al.probabilidad_cumplimiento) as prob,
            COUNT(*) FILTER (WHERE al.modulo_abandono->>'hubo_abandono' = 'true')::NUMERIC / NULLIF(COUNT(*), 0) as abandono
        FROM analisis_llamadas al
        JOIN agentes a ON al.agente_id = a.agente_id
        WHERE a.equipo = p_equipo
          AND al.created_at >= NOW() - (p_dias || ' days')::INTERVAL
        GROUP BY al.agente_id
        HAVING COUNT(*) >= 3
    )
    SELECT 
        COUNT(DISTINCT agente_id)::BIGINT,
        SUM(llamadas)::BIGINT,
        ROUND(AVG(score), 1),
        ROUND(MAX(score), 1),
        ROUND(AVG(tasa_val), 2),
        ROUND(AVG(prob), 1),
        ROUND(AVG(abandono), 2)
    FROM metricas_por_agente;
END;
$$ LANGUAGE plpgsql;


-- ----------------------------------------------------------------------------
-- 4. FUNCION: Obtener ranking del agente en su equipo
-- ----------------------------------------------------------------------------

CREATE OR REPLACE FUNCTION obtener_ranking_agente(
    p_agente_id UUID,
    p_equipo TEXT,
    p_dias INTEGER DEFAULT 7
)
RETURNS TABLE (
    ranking INTEGER,
    total_agentes INTEGER,
    percentil INTEGER,
    score_agente NUMERIC,
    score_mejor NUMERIC,
    score_promedio_equipo NUMERIC,
    diferencia_vs_mejor NUMERIC,
    diferencia_vs_promedio NUMERIC
) AS $$
BEGIN
    RETURN QUERY
    WITH scores_equipo AS (
        SELECT 
            al.agente_id,
            AVG(al.score_total) as score_promedio
        FROM analisis_llamadas al
        JOIN agentes a ON al.agente_id = a.agente_id
        WHERE a.equipo = p_equipo
          AND al.created_at >= NOW() - (p_dias || ' days')::INTERVAL
        GROUP BY al.agente_id
        HAVING COUNT(*) >= 3
    ),
    ranking_equipo AS (
        SELECT 
            se.agente_id,
            se.score_promedio,
            ROW_NUMBER() OVER (ORDER BY se.score_promedio DESC)::INTEGER as pos,
            COUNT(*) OVER ()::INTEGER as total
        FROM scores_equipo se
    ),
    stats AS (
        SELECT 
            MAX(score_promedio) as max_score,
            AVG(score_promedio) as avg_score
        FROM ranking_equipo
    )
    SELECT 
        COALESCE(r.pos, 0)::INTEGER,
        COALESCE(r.total, 0)::INTEGER,
        COALESCE(ROUND((1 - r.pos::NUMERIC / NULLIF(r.total, 0)) * 100)::INTEGER, 0),
        ROUND(r.score_promedio, 1),
        ROUND(s.max_score, 1),
        ROUND(s.avg_score, 1),
        ROUND(r.score_promedio - s.max_score, 1),
        ROUND(r.score_promedio - s.avg_score, 1)
    FROM ranking_equipo r
    CROSS JOIN stats s
    WHERE r.agente_id = p_agente_id;
END;
$$ LANGUAGE plpgsql;


-- ----------------------------------------------------------------------------
-- 5. FUNCION: Obtener reporte anterior
-- Ultimo coaching report del agente
-- ----------------------------------------------------------------------------

CREATE OR REPLACE FUNCTION obtener_reporte_anterior(
    p_agente_id UUID
)
RETURNS TABLE (
    reporte_id UUID,
    fecha_reporte DATE,
    score_anterior NUMERIC,
    tasa_validacion_anterior NUMERIC,
    objetivo_cumplido BOOLEAN,
    objetivo_semana TEXT,
    gap_area TEXT
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        cr.reporte_id,
        cr.fecha_reporte,
        (cr.metricas_periodo->>'score_promedio')::NUMERIC,
        (cr.metricas_periodo->>'tasa_validacion')::NUMERIC,
        (cr.progreso_vs_anterior->>'objetivo_anterior_cumplido')::BOOLEAN,
        cr.plan_mejora->>'objetivo_semana',
        cr.gap_critico->>'area'
    FROM coaching_reports cr
    WHERE cr.agente_id = p_agente_id
    ORDER BY cr.fecha_reporte DESC
    LIMIT 1;
END;
$$ LANGUAGE plpgsql;


-- ----------------------------------------------------------------------------
-- 6. FUNCION: Obtener alertas del periodo
-- Alertas del agente en los ultimos N dias
-- ----------------------------------------------------------------------------

CREATE OR REPLACE FUNCTION obtener_alertas_agente(
    p_agente_id UUID,
    p_dias INTEGER DEFAULT 7
)
RETURNS TABLE (
    codigo TEXT,
    severidad TEXT,
    descripcion TEXT,
    fecha DATE,
    estado TEXT
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        aa.codigo::TEXT,
        aa.severidad::TEXT,
        aa.descripcion::TEXT,
        aa.created_at::DATE,
        aa.estado::TEXT
    FROM alertas_anomalias aa
    WHERE p_agente_id = ANY(aa.agentes_relacionados)
      AND aa.created_at >= NOW() - (p_dias || ' days')::INTERVAL
    ORDER BY aa.created_at DESC;
END;
$$ LANGUAGE plpgsql;


-- ----------------------------------------------------------------------------
-- 7. FUNCION: Obtener muestra de llamadas (mejores y peores)
-- Para analisis del LLM
-- ----------------------------------------------------------------------------

CREATE OR REPLACE FUNCTION obtener_muestra_llamadas(
    p_agente_id UUID,
    p_dias INTEGER DEFAULT 7,
    p_cantidad INTEGER DEFAULT 3
)
RETURNS TABLE (
    tipo TEXT,
    analisis_id UUID,
    score_total INTEGER,
    score_contacto INTEGER,
    score_compromiso INTEGER,
    validacion_tipo TEXT,
    hubo_abandono BOOLEAN,
    prob_cumplimiento INTEGER,
    fecha DATE
) AS $$
BEGIN
    -- Mejores llamadas
    RETURN QUERY
    SELECT 
        'mejor'::TEXT,
        al.analisis_id,
        al.score_total,
        al.score_contacto_directo,
        al.score_compromiso_pago,
        al.modulo_compromiso_pago->'desglose'->'validacion_cliente'->>'tipo',
        (al.modulo_abandono->>'hubo_abandono')::BOOLEAN,
        al.probabilidad_cumplimiento,
        al.created_at::DATE
    FROM analisis_llamadas al
    WHERE al.agente_id = p_agente_id
      AND al.created_at >= NOW() - (p_dias || ' days')::INTERVAL
    ORDER BY al.score_total DESC
    LIMIT p_cantidad;
    
    -- Peores llamadas
    RETURN QUERY
    SELECT 
        'peor'::TEXT,
        al.analisis_id,
        al.score_total,
        al.score_contacto_directo,
        al.score_compromiso_pago,
        al.modulo_compromiso_pago->'desglose'->'validacion_cliente'->>'tipo',
        (al.modulo_abandono->>'hubo_abandono')::BOOLEAN,
        al.probabilidad_cumplimiento,
        al.created_at::DATE
    FROM analisis_llamadas al
    WHERE al.agente_id = p_agente_id
      AND al.created_at >= NOW() - (p_dias || ' days')::INTERVAL
    ORDER BY al.score_total ASC
    LIMIT p_cantidad;
END;
$$ LANGUAGE plpgsql;


-- ----------------------------------------------------------------------------
-- 8. FUNCION PRINCIPAL: Obtener datos completos para coaching
-- Combina todas las metricas en un solo JSON
-- ----------------------------------------------------------------------------

CREATE OR REPLACE FUNCTION obtener_datos_coaching(
    p_agente_id UUID,
    p_dias INTEGER DEFAULT 7
)
RETURNS JSONB AS $$
DECLARE
    v_agente RECORD;
    v_metricas RECORD;
    v_benchmark RECORD;
    v_ranking RECORD;
    v_anterior RECORD;
    v_alertas JSONB;
    v_muestra JSONB;
    v_resultado JSONB;
BEGIN
    -- 1. Datos del agente
    SELECT 
        a.agente_id,
        a.nombre,
        a.email,
        a.equipo,
        a.fecha_ingreso,
        EXTRACT(DAY FROM NOW() - a.fecha_ingreso)::INTEGER as dias_activo
    INTO v_agente
    FROM agentes a
    WHERE a.agente_id = p_agente_id;
    
    IF v_agente IS NULL THEN
        RETURN jsonb_build_object('error', 'Agente no encontrado');
    END IF;
    
    -- 2. Metricas del periodo
    SELECT * INTO v_metricas 
    FROM obtener_metricas_agente(p_agente_id, p_dias);
    
    IF v_metricas.total_llamadas < 5 THEN
        RETURN jsonb_build_object(
            'error', 'Insuficientes llamadas',
            'total_llamadas', v_metricas.total_llamadas,
            'minimo_requerido', 5
        );
    END IF;
    
    -- 3. Benchmark del equipo
    SELECT * INTO v_benchmark 
    FROM obtener_benchmark_equipo(v_agente.equipo, p_dias);
    
    -- 4. Ranking
    SELECT * INTO v_ranking
    FROM obtener_ranking_agente(p_agente_id, v_agente.equipo, p_dias);
    
    -- 5. Reporte anterior
    SELECT * INTO v_anterior
    FROM obtener_reporte_anterior(p_agente_id);
    
    -- 6. Alertas
    SELECT COALESCE(jsonb_agg(jsonb_build_object(
        'codigo', codigo,
        'severidad', severidad,
        'descripcion', descripcion,
        'fecha', fecha,
        'estado', estado
    )), '[]'::JSONB)
    INTO v_alertas
    FROM obtener_alertas_agente(p_agente_id, p_dias);
    
    -- 7. Muestra de llamadas
    SELECT COALESCE(jsonb_agg(jsonb_build_object(
        'tipo', tipo,
        'analisis_id', analisis_id,
        'score_total', score_total,
        'score_contacto', score_contacto,
        'score_compromiso', score_compromiso,
        'validacion_tipo', validacion_tipo,
        'hubo_abandono', hubo_abandono,
        'prob_cumplimiento', prob_cumplimiento,
        'fecha', fecha
    )), '[]'::JSONB)
    INTO v_muestra
    FROM obtener_muestra_llamadas(p_agente_id, p_dias, 3);
    
    -- Construir resultado
    v_resultado := jsonb_build_object(
        'agente', jsonb_build_object(
            'agente_id', v_agente.agente_id,
            'nombre', v_agente.nombre,
            'email', v_agente.email,
            'equipo', v_agente.equipo,
            'fecha_ingreso', v_agente.fecha_ingreso,
            'dias_activo', v_agente.dias_activo
        ),
        'metricas', jsonb_build_object(
            'periodo_dias', p_dias,
            'fecha_inicio', v_metricas.fecha_inicio,
            'fecha_fin', v_metricas.fecha_fin,
            'total_llamadas', v_metricas.total_llamadas,
            'score_promedio', v_metricas.score_promedio,
            'score_min', v_metricas.score_min,
            'score_max', v_metricas.score_max,
            'score_contacto_promedio', v_metricas.score_contacto_promedio,
            'score_compromiso_promedio', v_metricas.score_compromiso_promedio,
            'tasa_validacion_explicita', v_metricas.tasa_validacion_explicita,
            'tasa_abandono', v_metricas.tasa_abandono,
            'prob_cumplimiento_promedio', v_metricas.prob_cumplimiento_promedio,
            'distribucion', jsonb_build_object(
                'excelente_80_100', v_metricas.llamadas_excelentes,
                'bueno_60_79', v_metricas.llamadas_buenas,
                'regular_40_59', v_metricas.llamadas_regulares,
                'bajo_0_39', v_metricas.llamadas_bajas
            )
        ),
        'benchmark_equipo', jsonb_build_object(
            'equipo', v_agente.equipo,
            'total_agentes', v_benchmark.total_agentes,
            'total_llamadas', v_benchmark.total_llamadas,
            'score_promedio', v_benchmark.score_promedio,
            'score_top', v_benchmark.score_top,
            'tasa_validacion_promedio', v_benchmark.tasa_validacion_promedio,
            'prob_cumplimiento_promedio', v_benchmark.prob_cumplimiento_promedio,
            'tasa_abandono_promedio', v_benchmark.tasa_abandono_promedio
        ),
        'ranking', jsonb_build_object(
            'posicion', v_ranking.ranking,
            'total_agentes', v_ranking.total_agentes,
            'percentil', v_ranking.percentil,
            'score_agente', v_ranking.score_agente,
            'score_mejor', v_ranking.score_mejor,
            'score_promedio_equipo', v_ranking.score_promedio_equipo,
            'diferencia_vs_mejor', v_ranking.diferencia_vs_mejor,
            'diferencia_vs_promedio', v_ranking.diferencia_vs_promedio
        ),
        'reporte_anterior', CASE 
            WHEN v_anterior.reporte_id IS NOT NULL THEN jsonb_build_object(
                'reporte_id', v_anterior.reporte_id,
                'fecha', v_anterior.fecha_reporte,
                'score_anterior', v_anterior.score_anterior,
                'tasa_validacion_anterior', v_anterior.tasa_validacion_anterior,
                'objetivo_cumplido', v_anterior.objetivo_cumplido,
                'objetivo_semana', v_anterior.objetivo_semana,
                'gap_area', v_anterior.gap_area
            )
            ELSE NULL
        END,
        'tendencia', CASE 
            WHEN v_anterior.score_anterior IS NOT NULL THEN jsonb_build_object(
                'score_cambio', ROUND(v_metricas.score_promedio - v_anterior.score_anterior, 1),
                'direccion', CASE 
                    WHEN v_metricas.score_promedio - v_anterior.score_anterior > 3 THEN 'mejorando'
                    WHEN v_metricas.score_promedio - v_anterior.score_anterior < -3 THEN 'empeorando'
                    ELSE 'estable'
                END
            )
            ELSE jsonb_build_object('score_cambio', 0, 'direccion', 'sin_datos')
        END,
        'alertas', v_alertas,
        'muestra_llamadas', v_muestra
    );
    
    RETURN v_resultado;
END;
$$ LANGUAGE plpgsql;


-- ----------------------------------------------------------------------------
-- 9. FUNCION: Obtener datos de todos los agentes para coaching
-- Para procesamiento batch
-- ----------------------------------------------------------------------------

CREATE OR REPLACE FUNCTION obtener_agentes_para_coaching(
    p_dias INTEGER DEFAULT 7,
    p_minimo_llamadas INTEGER DEFAULT 5
)
RETURNS TABLE (
    agente_id UUID,
    nombre TEXT,
    equipo TEXT,
    total_llamadas BIGINT,
    score_promedio NUMERIC,
    tiene_reporte_anterior BOOLEAN
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        a.agente_id,
        a.nombre::TEXT,
        a.equipo::TEXT,
        COUNT(al.analisis_id)::BIGINT as total_llamadas,
        ROUND(AVG(al.score_total), 1) as score_promedio,
        EXISTS(SELECT 1 FROM coaching_reports cr WHERE cr.agente_id = a.agente_id) as tiene_reporte_anterior
    FROM agentes a
    LEFT JOIN analisis_llamadas al ON a.agente_id = al.agente_id
        AND al.created_at >= NOW() - (p_dias || ' days')::INTERVAL
    WHERE a.estado = 'activo'
      AND a.fecha_ingreso < NOW() - INTERVAL '7 days'
    GROUP BY a.agente_id, a.nombre, a.equipo
    HAVING COUNT(al.analisis_id) >= p_minimo_llamadas
    ORDER BY a.equipo, a.nombre;
END;
$$ LANGUAGE plpgsql;


-- ----------------------------------------------------------------------------
-- VISTAS UTILES
-- ----------------------------------------------------------------------------

-- Vista: Resumen de agentes listos para coaching
DROP VIEW IF EXISTS v_agentes_coaching;
CREATE VIEW v_agentes_coaching AS
SELECT * FROM obtener_agentes_para_coaching(7, 5);


-- ============================================================================
-- EJEMPLOS DE USO
-- ============================================================================

-- Obtener agentes listos para coaching:
-- SELECT * FROM obtener_agentes_para_coaching(7, 5);

-- Obtener metricas de un agente:
-- SELECT * FROM obtener_metricas_agente('11111111-1111-1111-1111-111111111111', 7);

-- Obtener benchmark del equipo:
-- SELECT * FROM obtener_benchmark_equipo('Equipo Norte', 7);

-- Obtener ranking del agente:
-- SELECT * FROM obtener_ranking_agente('11111111-1111-1111-1111-111111111111', 'Equipo Norte', 7);

-- Obtener reporte anterior:
-- SELECT * FROM obtener_reporte_anterior('11111111-1111-1111-1111-111111111111');

-- Obtener alertas del agente:
-- SELECT * FROM obtener_alertas_agente('44444444-4444-4444-4444-444444444444', 7);

-- Obtener muestra de llamadas:
-- SELECT * FROM obtener_muestra_llamadas('11111111-1111-1111-1111-111111111111', 7, 3);

-- FUNCION PRINCIPAL - Obtener todo para el LLM:
-- SELECT obtener_datos_coaching('11111111-1111-1111-1111-111111111111', 7);

-- Vista rapida:
-- SELECT * FROM v_agentes_coaching;
</file>

<file path="supabase/functions/detector_functions.sql">
-- ============================================================================
-- FUNCIONES DEL AGENTE DETECTOR
-- Evaluacion de reglas por agente y sistemicas
-- ============================================================================

-- ----------------------------------------------------------------------------
-- 1. FUNCION: Evaluar alertas de un agente especifico (por ID)
-- Recibe: UUID del agente
-- Retorna: tabla con alertas detectadas
-- ----------------------------------------------------------------------------

CREATE OR REPLACE FUNCTION evaluar_alertas_agente(
    p_agente_id UUID,
    p_periodo_horas INTEGER DEFAULT 24
)
RETURNS TABLE (
    tipo TEXT,
    severidad TEXT,
    codigo TEXT,
    descripcion TEXT,
    agente_id UUID,
    agente_nombre TEXT,
    equipo TEXT,
    datos JSONB,
    accion_requerida TEXT
) AS $$
DECLARE
    v_agente_nombre TEXT;
    v_equipo TEXT;
    v_total_llamadas INTEGER;
    v_score_promedio NUMERIC;
    v_abandonos INTEGER;
    v_validaciones INTEGER;
    v_llamadas_criticas INTEGER;
    v_prob_promedio NUMERIC;
    v_tasa_abandono NUMERIC;
    v_tasa_validacion NUMERIC;
    v_score_ayer NUMERIC;
    v_caida_porcentaje NUMERIC;
BEGIN
    -- Obtener datos del agente
    SELECT a.nombre, a.equipo
    INTO v_agente_nombre, v_equipo
    FROM agentes a
    WHERE a.agente_id = p_agente_id;
    
    -- Si no existe el agente, retornar vacio
    IF v_agente_nombre IS NULL THEN
        RETURN;
    END IF;
    
    -- Calcular metricas del periodo
    SELECT 
        COUNT(*),
        AVG(score_total),
        COUNT(*) FILTER (WHERE modulo_abandono->>'hubo_abandono' = 'true'),
        COUNT(*) FILTER (
            WHERE modulo_compromiso_pago->'desglose'->'validacion_cliente'->>'tipo' = 'explicita'
        ),
        COUNT(*) FILTER (WHERE score_total < 40),
        AVG(probabilidad_cumplimiento)
    INTO 
        v_total_llamadas,
        v_score_promedio,
        v_abandonos,
        v_validaciones,
        v_llamadas_criticas,
        v_prob_promedio
    FROM analisis_llamadas al
    WHERE al.agente_id = p_agente_id
      AND al.created_at >= NOW() - (p_periodo_horas || ' hours')::INTERVAL;
    
    -- Si no hay suficientes llamadas, retornar vacio
    IF v_total_llamadas < 3 THEN
        RETURN;
    END IF;
    
    -- Calcular tasas
    v_tasa_abandono := v_abandonos::NUMERIC / v_total_llamadas;
    v_tasa_validacion := v_validaciones::NUMERIC / v_total_llamadas;
    
    -- Obtener score del dia anterior para comparar
    SELECT AVG(al.score_total)
    INTO v_score_ayer
    FROM analisis_llamadas al
    WHERE al.agente_id = p_agente_id
      AND al.created_at >= NOW() - ((p_periodo_horas * 2) || ' hours')::INTERVAL
      AND al.created_at < NOW() - (p_periodo_horas || ' hours')::INTERVAL;
    
    -- Calcular caida porcentual
    IF v_score_ayer IS NOT NULL AND v_score_ayer > 0 THEN
        v_caida_porcentaje := ((v_score_ayer - v_score_promedio) / v_score_ayer) * 100;
    ELSE
        v_caida_porcentaje := 0;
    END IF;
    
    -- ========================================================================
    -- EVALUAR REGLAS
    -- ========================================================================
    
    -- REGLA 1: AGENTE_SCORE_CRITICO (score < 40)
    IF v_score_promedio < 40 THEN
        RETURN QUERY SELECT
            'individual'::TEXT,
            'critica'::TEXT,
            'AGENTE_SCORE_CRITICO'::TEXT,
            format('Score promedio critico (%s) en ultimas %s horas', 
                   ROUND(v_score_promedio), p_periodo_horas),
            p_agente_id,
            v_agente_nombre,
            v_equipo,
            jsonb_build_object(
                'score_promedio', ROUND(v_score_promedio),
                'total_llamadas', v_total_llamadas,
                'llamadas_criticas', v_llamadas_criticas,
                'umbral', 40
            ),
            'Intervencion inmediata - coaching urgente'::TEXT;
    
    -- REGLA 2: AGENTE_SCORE_BAJO (score 40-55)
    ELSIF v_score_promedio < 55 THEN
        RETURN QUERY SELECT
            'individual'::TEXT,
            'alta'::TEXT,
            'AGENTE_SCORE_BAJO'::TEXT,
            format('Score promedio bajo (%s) en ultimas %s horas', 
                   ROUND(v_score_promedio), p_periodo_horas),
            p_agente_id,
            v_agente_nombre,
            v_equipo,
            jsonb_build_object(
                'score_promedio', ROUND(v_score_promedio),
                'total_llamadas', v_total_llamadas,
                'umbral', 55
            ),
            'Incluir en revision de coaching prioritaria'::TEXT;
    END IF;
    
    -- REGLA 3: AGENTE_ABANDONO_ALTO (> 20%)
    IF v_tasa_abandono > 0.20 AND v_total_llamadas >= 5 THEN
        RETURN QUERY SELECT
            'individual'::TEXT,
            'alta'::TEXT,
            'AGENTE_ABANDONO_ALTO'::TEXT,
            format('Tasa de abandono alta (%s%%) en ultimas %s horas', 
                   ROUND(v_tasa_abandono * 100), p_periodo_horas),
            p_agente_id,
            v_agente_nombre,
            v_equipo,
            jsonb_build_object(
                'tasa_abandono', ROUND(v_tasa_abandono, 2),
                'abandonos', v_abandonos,
                'total_llamadas', v_total_llamadas,
                'umbral', 0.20
            ),
            'Revisar grabaciones y dar feedback sobre rapport'::TEXT;
    END IF;
    
    -- REGLA 4: AGENTE_SIN_VALIDACION (< 15%)
    IF v_tasa_validacion < 0.15 AND v_total_llamadas >= 5 THEN
        RETURN QUERY SELECT
            'individual'::TEXT,
            'alta'::TEXT,
            'AGENTE_SIN_VALIDACION'::TEXT,
            format('Tasa de validacion explicita muy baja (%s%%) en ultimas %s horas', 
                   ROUND(v_tasa_validacion * 100), p_periodo_horas),
            p_agente_id,
            v_agente_nombre,
            v_equipo,
            jsonb_build_object(
                'tasa_validacion', ROUND(v_tasa_validacion, 2),
                'validaciones', v_validaciones,
                'total_llamadas', v_total_llamadas,
                'umbral', 0.15
            ),
            'Reforzar tecnicas de cierre y validacion'::TEXT;
    END IF;
    
    -- REGLA 5: AGENTE_CAIDA_SCORE (> 15% caida)
    IF v_caida_porcentaje > 15 THEN
        RETURN QUERY SELECT
            'individual'::TEXT,
            'media'::TEXT,
            'AGENTE_CAIDA_SCORE'::TEXT,
            format('Caida de score del %s%% vs dia anterior', 
                   ROUND(v_caida_porcentaje)),
            p_agente_id,
            v_agente_nombre,
            v_equipo,
            jsonb_build_object(
                'score_hoy', ROUND(v_score_promedio),
                'score_ayer', ROUND(v_score_ayer),
                'caida_porcentaje', ROUND(v_caida_porcentaje, 1)
            ),
            'Investigar causa de la caida'::TEXT;
    END IF;
    
    -- REGLA 6: PATRON_LLAMADAS_CRITICAS (>= 5 llamadas con score < 40)
    IF v_llamadas_criticas >= 5 THEN
        RETURN QUERY SELECT
            'patron'::TEXT,
            'alta'::TEXT,
            'PATRON_LLAMADAS_CRITICAS'::TEXT,
            format('%s llamadas con score critico (<40) en %s horas', 
                   v_llamadas_criticas, p_periodo_horas),
            p_agente_id,
            v_agente_nombre,
            v_equipo,
            jsonb_build_object(
                'llamadas_criticas', v_llamadas_criticas,
                'total_llamadas', v_total_llamadas,
                'porcentaje', ROUND((v_llamadas_criticas::NUMERIC / v_total_llamadas) * 100)
            ),
            'Revision urgente de casos criticos'::TEXT;
    END IF;
    
    -- REGLA 7: AGENTE_PROBABILIDAD_BAJA (< 30%)
    IF v_prob_promedio < 30 AND v_total_llamadas >= 5 THEN
        RETURN QUERY SELECT
            'individual'::TEXT,
            'media'::TEXT,
            'AGENTE_PROBABILIDAD_BAJA'::TEXT,
            format('Probabilidad de cumplimiento promedio muy baja (%s%%)', 
                   ROUND(v_prob_promedio)),
            p_agente_id,
            v_agente_nombre,
            v_equipo,
            jsonb_build_object(
                'probabilidad_promedio', ROUND(v_prob_promedio),
                'total_llamadas', v_total_llamadas,
                'umbral', 30
            ),
            'Evaluar calidad de compromisos obtenidos'::TEXT;
    END IF;
    
END;
$$ LANGUAGE plpgsql;


-- ----------------------------------------------------------------------------
-- 2. FUNCION: Evaluar alertas por nombre del agente
-- Wrapper que busca el ID por nombre
-- ----------------------------------------------------------------------------

CREATE OR REPLACE FUNCTION evaluar_alertas_agente_por_nombre(
    p_agente_nombre TEXT,
    p_periodo_horas INTEGER DEFAULT 24
)
RETURNS TABLE (
    tipo TEXT,
    severidad TEXT,
    codigo TEXT,
    descripcion TEXT,
    agente_id UUID,
    agente_nombre TEXT,
    equipo TEXT,
    datos JSONB,
    accion_requerida TEXT
) AS $$
DECLARE
    v_agente_id UUID;
BEGIN
    -- Buscar agente por nombre
    SELECT a.agente_id INTO v_agente_id
    FROM agentes a
    WHERE a.nombre ILIKE p_agente_nombre
    LIMIT 1;
    
    IF v_agente_id IS NULL THEN
        RETURN;
    END IF;
    
    RETURN QUERY SELECT * FROM evaluar_alertas_agente(v_agente_id, p_periodo_horas);
END;
$$ LANGUAGE plpgsql;


-- ----------------------------------------------------------------------------
-- 3. FUNCION: Evaluar alertas de TODOS los agentes
-- Retorna: tabla con alertas de todos los agentes activos
-- ----------------------------------------------------------------------------

CREATE OR REPLACE FUNCTION evaluar_alertas_todos_agentes(
    p_periodo_horas INTEGER DEFAULT 24
)
RETURNS TABLE (
    tipo TEXT,
    severidad TEXT,
    codigo TEXT,
    descripcion TEXT,
    agente_id UUID,
    agente_nombre TEXT,
    equipo TEXT,
    datos JSONB,
    accion_requerida TEXT
) AS $$
DECLARE
    v_agente RECORD;
BEGIN
    -- Obtener lista de agentes con llamadas en el periodo
    FOR v_agente IN
        SELECT DISTINCT al.agente_id
        FROM analisis_llamadas al
        WHERE al.created_at >= NOW() - (p_periodo_horas || ' hours')::INTERVAL
          AND al.agente_id IS NOT NULL
    LOOP
        -- Evaluar alertas para cada agente
        RETURN QUERY 
        SELECT * FROM evaluar_alertas_agente(v_agente.agente_id, p_periodo_horas);
    END LOOP;
END;
$$ LANGUAGE plpgsql;


-- ----------------------------------------------------------------------------
-- 4. FUNCION: Evaluar alertas sistemicas
-- Retorna: tabla con alertas a nivel sistema
-- ----------------------------------------------------------------------------

CREATE OR REPLACE FUNCTION evaluar_alertas_sistemicas(
    p_periodo_horas INTEGER DEFAULT 24
)
RETURNS TABLE (
    tipo TEXT,
    severidad TEXT,
    codigo TEXT,
    descripcion TEXT,
    agente_id UUID,
    agente_nombre TEXT,
    equipo TEXT,
    datos JSONB,
    accion_requerida TEXT
) AS $$
DECLARE
    v_total_llamadas INTEGER;
    v_score_promedio NUMERIC;
    v_abandonos INTEGER;
    v_validaciones INTEGER;
    v_llamadas_anterior INTEGER;
    v_score_anterior NUMERIC;
    v_abandonos_anterior INTEGER;
    v_tasa_abandono NUMERIC;
    v_tasa_validacion NUMERIC;
    v_caida_score NUMERIC;
    v_porcentaje_volumen NUMERIC;
BEGIN
    -- Obtener metricas del periodo actual
    SELECT 
        COUNT(*),
        AVG(score_total),
        COUNT(*) FILTER (WHERE modulo_abandono->>'hubo_abandono' = 'true'),
        COUNT(*) FILTER (
            WHERE modulo_compromiso_pago->'desglose'->'validacion_cliente'->>'tipo' = 'explicita'
        )
    INTO 
        v_total_llamadas,
        v_score_promedio,
        v_abandonos,
        v_validaciones
    FROM analisis_llamadas
    WHERE created_at >= NOW() - (p_periodo_horas || ' hours')::INTERVAL;
    
    -- Obtener metricas del periodo anterior (para comparar)
    SELECT 
        COUNT(*),
        AVG(score_total),
        COUNT(*) FILTER (WHERE modulo_abandono->>'hubo_abandono' = 'true')
    INTO 
        v_llamadas_anterior,
        v_score_anterior,
        v_abandonos_anterior
    FROM analisis_llamadas
    WHERE created_at >= NOW() - ((p_periodo_horas * 2) || ' hours')::INTERVAL
      AND created_at < NOW() - (p_periodo_horas || ' hours')::INTERVAL;
    
    -- Si no hay suficientes datos, retornar vacio
    IF v_total_llamadas < 10 THEN
        RETURN;
    END IF;
    
    -- Calcular metricas derivadas
    v_tasa_abandono := v_abandonos::NUMERIC / v_total_llamadas;
    v_tasa_validacion := v_validaciones::NUMERIC / v_total_llamadas;
    
    IF v_score_anterior IS NOT NULL AND v_score_anterior > 0 THEN
        v_caida_score := ((v_score_anterior - v_score_promedio) / v_score_anterior) * 100;
    ELSE
        v_caida_score := 0;
    END IF;
    
    IF v_llamadas_anterior IS NOT NULL AND v_llamadas_anterior > 0 THEN
        v_porcentaje_volumen := (v_total_llamadas::NUMERIC / v_llamadas_anterior) * 100;
    ELSE
        v_porcentaje_volumen := 100;
    END IF;
    
    -- ========================================================================
    -- EVALUAR REGLAS SISTEMICAS
    -- ========================================================================
    
    -- REGLA 1: SISTEMA_TASA_ABANDONO (> 25% global)
    IF v_tasa_abandono > 0.25 THEN
        RETURN QUERY SELECT
            'sistemica'::TEXT,
            'critica'::TEXT,
            'SISTEMA_TASA_ABANDONO'::TEXT,
            format('Tasa de abandono global del %s%% en ultimas %s horas', 
                   ROUND(v_tasa_abandono * 100), p_periodo_horas),
            NULL::UUID,
            NULL::TEXT,
            NULL::TEXT,
            jsonb_build_object(
                'tasa_abandono', ROUND(v_tasa_abandono, 2),
                'abandonos', v_abandonos,
                'total_llamadas', v_total_llamadas,
                'umbral', 0.25
            ),
            'Revision de operaciones - posible problema sistemico'::TEXT;
    END IF;
    
    -- REGLA 2: SISTEMA_CAIDA_SCORES (> 10% caida)
    IF v_caida_score > 10 THEN
        RETURN QUERY SELECT
            'sistemica'::TEXT,
            'alta'::TEXT,
            'SISTEMA_CAIDA_SCORES'::TEXT,
            format('Score promedio global cayo %s%% vs periodo anterior', 
                   ROUND(v_caida_score)),
            NULL::UUID,
            NULL::TEXT,
            NULL::TEXT,
            jsonb_build_object(
                'score_actual', ROUND(v_score_promedio),
                'score_anterior', ROUND(v_score_anterior),
                'caida_porcentaje', ROUND(v_caida_score, 1)
            ),
            'Investigar causa de la caida global'::TEXT;
    END IF;
    
    -- REGLA 3: SISTEMA_VALIDACION_BAJA (< 30% global)
    IF v_tasa_validacion < 0.30 THEN
        RETURN QUERY SELECT
            'sistemica'::TEXT,
            'alta'::TEXT,
            'SISTEMA_VALIDACION_BAJA'::TEXT,
            format('Tasa de validacion explicita global del %s%%', 
                   ROUND(v_tasa_validacion * 100)),
            NULL::UUID,
            NULL::TEXT,
            NULL::TEXT,
            jsonb_build_object(
                'tasa_validacion', ROUND(v_tasa_validacion, 2),
                'validaciones', v_validaciones,
                'total_llamadas', v_total_llamadas,
                'umbral', 0.30
            ),
            'Refuerzo de script de cierre a todos los agentes'::TEXT;
    END IF;
    
    -- REGLA 4: SISTEMA_VOLUMEN_BAJO (< 70% del esperado)
    IF v_porcentaje_volumen < 70 THEN
        RETURN QUERY SELECT
            'sistemica'::TEXT,
            'media'::TEXT,
            'SISTEMA_VOLUMEN_BAJO'::TEXT,
            format('Volumen de llamadas al %s%% vs periodo anterior', 
                   ROUND(v_porcentaje_volumen)),
            NULL::UUID,
            NULL::TEXT,
            NULL::TEXT,
            jsonb_build_object(
                'llamadas_actual', v_total_llamadas,
                'llamadas_anterior', v_llamadas_anterior,
                'porcentaje', ROUND(v_porcentaje_volumen)
            ),
            'Verificar problemas de personal o tecnicos'::TEXT;
    END IF;
    
END;
$$ LANGUAGE plpgsql;


-- ----------------------------------------------------------------------------
-- 5. FUNCION: Ejecutar detector completo
-- Combina alertas de agentes + sistemicas
-- Filtra duplicados y retorna alertas nuevas
-- ----------------------------------------------------------------------------

CREATE OR REPLACE FUNCTION ejecutar_detector(
    p_periodo_horas INTEGER DEFAULT 24,
    p_ventana_dedup_dias INTEGER DEFAULT 3
)
RETURNS TABLE (
    tipo TEXT,
    severidad TEXT,
    codigo TEXT,
    descripcion TEXT,
    agente_id UUID,
    agente_nombre TEXT,
    equipo TEXT,
    datos JSONB,
    accion_requerida TEXT,
    es_nueva BOOLEAN
) AS $$
BEGIN
    RETURN QUERY
    WITH todas_alertas AS (
        -- Alertas de agentes
        SELECT * FROM evaluar_alertas_todos_agentes(p_periodo_horas)
        UNION ALL
        -- Alertas sistemicas
        SELECT * FROM evaluar_alertas_sistemicas(p_periodo_horas)
    ),
    alertas_existentes AS (
        -- Alertas de los ultimos N dias para deduplicacion
        SELECT DISTINCT aa.codigo, aa.agentes_relacionados[1] as ag_id
        FROM alertas_anomalias aa
        WHERE aa.created_at >= NOW() - (p_ventana_dedup_dias || ' days')::INTERVAL
    )
    SELECT 
        ta.tipo,
        ta.severidad,
        ta.codigo,
        ta.descripcion,
        ta.agente_id,
        ta.agente_nombre,
        ta.equipo,
        ta.datos,
        ta.accion_requerida,
        NOT EXISTS (
            SELECT 1 FROM alertas_existentes ae
            WHERE ae.codigo = ta.codigo 
              AND (ae.ag_id = ta.agente_id OR (ae.ag_id IS NULL AND ta.agente_id IS NULL))
        ) AS es_nueva
    FROM todas_alertas ta;
END;
$$ LANGUAGE plpgsql;


-- ----------------------------------------------------------------------------
-- 6. FUNCION: Obtener metricas globales del periodo
-- Para generar el resumen diario
-- ----------------------------------------------------------------------------

CREATE OR REPLACE FUNCTION obtener_metricas_periodo(
    p_periodo_horas INTEGER DEFAULT 24
)
RETURNS TABLE (
    total_llamadas BIGINT,
    score_promedio NUMERIC,
    tasa_abandono NUMERIC,
    tasa_validacion NUMERIC,
    prob_cumplimiento_promedio NUMERIC,
    llamadas_anterior BIGINT,
    score_anterior NUMERIC,
    cambio_llamadas_porcentaje NUMERIC,
    cambio_score NUMERIC
) AS $$
BEGIN
    RETURN QUERY
    WITH actual AS (
        SELECT 
            COUNT(*) as total,
            AVG(score_total) as score,
            COUNT(*) FILTER (WHERE modulo_abandono->>'hubo_abandono' = 'true')::NUMERIC / 
                NULLIF(COUNT(*), 0) as abandono,
            COUNT(*) FILTER (
                WHERE modulo_compromiso_pago->'desglose'->'validacion_cliente'->>'tipo' = 'explicita'
            )::NUMERIC / NULLIF(COUNT(*), 0) as validacion,
            AVG(probabilidad_cumplimiento) as prob
        FROM analisis_llamadas
        WHERE created_at >= NOW() - (p_periodo_horas || ' hours')::INTERVAL
    ),
    anterior AS (
        SELECT 
            COUNT(*) as total,
            AVG(score_total) as score
        FROM analisis_llamadas
        WHERE created_at >= NOW() - ((p_periodo_horas * 2) || ' hours')::INTERVAL
          AND created_at < NOW() - (p_periodo_horas || ' hours')::INTERVAL
    )
    SELECT 
        a.total,
        ROUND(a.score, 1),
        ROUND(a.abandono, 2),
        ROUND(a.validacion, 2),
        ROUND(a.prob, 1),
        ant.total,
        ROUND(ant.score, 1),
        CASE WHEN ant.total > 0 
             THEN ROUND(((a.total::NUMERIC - ant.total) / ant.total) * 100, 1)
             ELSE NULL END,
        ROUND(a.score - COALESCE(ant.score, a.score), 1)
    FROM actual a, anterior ant;
END;
$$ LANGUAGE plpgsql;


-- ----------------------------------------------------------------------------
-- 7. VISTA: Resumen de alertas por agente (ultimas 24h)
-- Para consultas rapidas
-- ----------------------------------------------------------------------------

DROP VIEW IF EXISTS v_alertas_agentes_24h;
CREATE VIEW v_alertas_agentes_24h AS
SELECT * FROM evaluar_alertas_todos_agentes(24);


-- ----------------------------------------------------------------------------
-- 8. VISTA: Resumen de alertas sistemicas (ultimas 24h)
-- ----------------------------------------------------------------------------

DROP VIEW IF EXISTS v_alertas_sistemicas_24h;
CREATE VIEW v_alertas_sistemicas_24h AS
SELECT * FROM evaluar_alertas_sistemicas(24);


-- ============================================================================
-- EJEMPLOS DE USO
-- ============================================================================

-- Evaluar alertas de un agente por ID:
-- SELECT * FROM evaluar_alertas_agente('11111111-1111-1111-1111-111111111111', 24);

-- Evaluar alertas de un agente por nombre:
-- SELECT * FROM evaluar_alertas_agente_por_nombre('Maria Lopez', 24);

-- Evaluar alertas de todos los agentes:
-- SELECT * FROM evaluar_alertas_todos_agentes(24);

-- Evaluar alertas sistemicas:
-- SELECT * FROM evaluar_alertas_sistemicas(24);

-- Ejecutar detector completo con deduplicacion:
-- SELECT * FROM ejecutar_detector(24, 3) WHERE es_nueva = true;

-- Obtener metricas del periodo:
-- SELECT * FROM obtener_metricas_periodo(24);

-- Usar vistas:
-- SELECT * FROM v_alertas_agentes_24h;
-- SELECT * FROM v_alertas_sistemicas_24h;
</file>

<file path="supabase/migrations/001_ajuste_transcripciones.sql">
-- ============================================
-- MIGRACI√ìN: Ajuste de tablas para Agente Transcriptor
-- Fecha: 2026-01-31
-- ============================================

-- ============================================
-- 1. MODIFICAR registro_llamadas
-- Hacer opcionales los campos que no siempre tenemos
-- ============================================

-- timestamp_inicio y timestamp_fin ahora pueden ser NULL (si no tenemos los datos)
ALTER TABLE registro_llamadas 
    ALTER COLUMN timestamp_inicio DROP NOT NULL,
    ALTER COLUMN timestamp_fin DROP NOT NULL;

-- cliente_ref puede ser NULL inicialmente (se llena despu√©s de la transcripci√≥n)
ALTER TABLE registro_llamadas 
    ALTER COLUMN cliente_ref DROP NOT NULL;

-- Agregar campo para nombre del cliente extra√≠do
ALTER TABLE registro_llamadas 
    ADD COLUMN IF NOT EXISTS cliente_nombre VARCHAR(200);

-- Agregar campo para nombre del agente extra√≠do (si no tenemos agente_id)
ALTER TABLE registro_llamadas 
    ADD COLUMN IF NOT EXISTS agente_nombre VARCHAR(200);

-- Agregar campo para empresa acreedora
ALTER TABLE registro_llamadas 
    ADD COLUMN IF NOT EXISTS empresa_acreedora VARCHAR(200);

-- Agregar campo para empresa de cobranza
ALTER TABLE registro_llamadas 
    ADD COLUMN IF NOT EXISTS empresa_cobranza VARCHAR(200);

-- Hacer agente_id opcional (se puede llenar despu√©s si se identifica)
ALTER TABLE registro_llamadas 
    ALTER COLUMN agente_id DROP NOT NULL;

-- ============================================
-- 2. MODIFICAR transcripciones
-- Ajustar estructura a lo que realmente tenemos
-- ============================================

-- Agregar campo para an√°lisis emocional completo (viene de Gemini)
ALTER TABLE transcripciones 
    ADD COLUMN IF NOT EXISTS analisis_emocional JSONB DEFAULT '{
        "agente": {
            "emocion_dominante": "neutral",
            "distribucion": {},
            "intensidad_promedio": 0
        },
        "cliente": {
            "emocion_dominante": "neutral",
            "distribucion": {},
            "intensidad_promedio": 0
        },
        "evolucion_cliente": "estable",
        "momentos_criticos": []
    }';

-- Agregar campo para patrones de script detectados
ALTER TABLE transcripciones 
    ADD COLUMN IF NOT EXISTS patrones_script JSONB DEFAULT '{
        "saludo_correcto": false,
        "identificacion_empresa": false,
        "identificacion_agente": false,
        "verificacion_identidad_cliente": false,
        "explicacion_motivo": false,
        "mencion_monto_deuda": false,
        "presentacion_ofertas": false,
        "mencion_consecuencias": false,
        "intento_cierre": false,
        "despedida_correcta": false,
        "score_script": 0
    }';

-- Agregar campo para resultado preliminar de la llamada
ALTER TABLE transcripciones 
    ADD COLUMN IF NOT EXISTS resultado_preliminar JSONB DEFAULT '{
        "tipo_cierre": "sin_compromiso",
        "compromiso_logrado": false,
        "monto_comprometido": null,
        "fecha_compromiso": null,
        "riesgo_incumplimiento": "medio",
        "requiere_seguimiento": true
    }';

-- Agregar campo para resumen ejecutivo
ALTER TABLE transcripciones 
    ADD COLUMN IF NOT EXISTS resumen_ejecutivo JSONB DEFAULT '{
        "resultado": "pendiente",
        "descripcion": "",
        "puntos_clave": [],
        "recomendaciones": []
    }';

-- Agregar campo para referencias de cr√©ditos extra√≠das
ALTER TABLE transcripciones 
    ADD COLUMN IF NOT EXISTS referencias_creditos JSONB DEFAULT '[]';

-- Agregar campo para informaci√≥n de seguimiento
ALTER TABLE transcripciones 
    ADD COLUMN IF NOT EXISTS seguimiento JSONB DEFAULT '{
        "requiere_seguimiento": false,
        "tipo_seguimiento": null,
        "fecha_sugerida": null,
        "prioridad": "media",
        "notas": ""
    }';

-- Actualizar default de metricas_conversacion para incluir campos que s√≠ tenemos
-- (El ALTER COLUMN ... SET DEFAULT no cambia valores existentes, solo nuevos)

-- ============================================
-- 3. AGREGAR √çNDICES √öTILES
-- ============================================

-- √çndice para buscar por cliente
CREATE INDEX IF NOT EXISTS idx_registro_cliente_nombre ON registro_llamadas(cliente_nombre);

-- √çndice para buscar por agente por nombre
CREATE INDEX IF NOT EXISTS idx_registro_agente_nombre ON registro_llamadas(agente_nombre);

-- √çndice GIN para an√°lisis emocional
CREATE INDEX IF NOT EXISTS idx_transcripciones_emocional ON transcripciones USING GIN (analisis_emocional);

-- √çndice GIN para resultado preliminar
CREATE INDEX IF NOT EXISTS idx_transcripciones_resultado ON transcripciones USING GIN (resultado_preliminar);

-- ============================================
-- 4. COMENTARIOS ACTUALIZADOS
-- ============================================

COMMENT ON COLUMN registro_llamadas.cliente_nombre IS 'Nombre del cliente extra√≠do de la transcripci√≥n';
COMMENT ON COLUMN registro_llamadas.agente_nombre IS 'Nombre del agente extra√≠do de la transcripci√≥n o del archivo';
COMMENT ON COLUMN registro_llamadas.empresa_acreedora IS 'Empresa a la que se le debe (ej: Caja Los Andes)';
COMMENT ON COLUMN registro_llamadas.empresa_cobranza IS 'Empresa que realiza la cobranza (ej: Redsap)';

COMMENT ON COLUMN transcripciones.analisis_emocional IS 'An√°lisis emocional completo de Gemini';
COMMENT ON COLUMN transcripciones.patrones_script IS 'Patrones de script de cobranza detectados';
COMMENT ON COLUMN transcripciones.resultado_preliminar IS 'Resultado preliminar de la llamada (pre-an√°lisis completo)';
COMMENT ON COLUMN transcripciones.resumen_ejecutivo IS 'Resumen ejecutivo de la llamada';
COMMENT ON COLUMN transcripciones.referencias_creditos IS 'Referencias a cr√©ditos/cuentas mencionadas';
COMMENT ON COLUMN transcripciones.seguimiento IS 'Informaci√≥n de seguimiento recomendado';
</file>

<file path="supabase/migrations/002_simplificar_registro_llamadas.sql">
-- ============================================
-- MIGRACI√ìN: Simplificar tabla registro_llamadas
-- Solo mantener las columnas realmente necesarias
-- Fecha: 2026-02-03
-- ============================================

-- ============================================
-- 1. ELIMINAR COLUMNAS NO USADAS
-- ============================================

-- Eliminar columnas de contexto de deuda (no las usamos)
ALTER TABLE registro_llamadas 
    DROP COLUMN IF EXISTS tipo_deuda,
    DROP COLUMN IF EXISTS monto_deuda,
    DROP COLUMN IF EXISTS dias_mora;

-- Eliminar metadata externa (no la usamos)
ALTER TABLE registro_llamadas 
    DROP COLUMN IF EXISTS metadata_externa;

-- ============================================
-- 2. VERIFICAR QUE EXISTEN LAS COLUMNAS NECESARIAS
-- (algunas vienen de la migraci√≥n anterior)
-- ============================================

-- Cliente nombre (de migraci√≥n 001)
ALTER TABLE registro_llamadas 
    ADD COLUMN IF NOT EXISTS cliente_nombre VARCHAR(200);

-- Agente nombre (de migraci√≥n 001)
ALTER TABLE registro_llamadas 
    ADD COLUMN IF NOT EXISTS agente_nombre VARCHAR(200);

-- Empresa acreedora (de migraci√≥n 001)
ALTER TABLE registro_llamadas 
    ADD COLUMN IF NOT EXISTS empresa_acreedora VARCHAR(200);

-- Empresa cobranza (de migraci√≥n 001)
ALTER TABLE registro_llamadas 
    ADD COLUMN IF NOT EXISTS empresa_cobranza VARCHAR(200);

-- ============================================
-- 3. AJUSTAR CONSTRAINTS
-- ============================================

-- Asegurar que los timestamps sean opcionales
ALTER TABLE registro_llamadas 
    ALTER COLUMN timestamp_inicio DROP NOT NULL,
    ALTER COLUMN timestamp_fin DROP NOT NULL;

-- Asegurar que agente_id sea opcional
ALTER TABLE registro_llamadas 
    ALTER COLUMN agente_id DROP NOT NULL;

-- Asegurar que cliente_ref sea opcional
ALTER TABLE registro_llamadas 
    ALTER COLUMN cliente_ref DROP NOT NULL;

-- ============================================
-- 4. ESTRUCTURA FINAL DE LA TABLA
-- ============================================

/*
Despu√©s de esta migraci√≥n, la tabla queda as√≠:

registro_llamadas:
‚îú‚îÄ‚îÄ registro_id          UUID PRIMARY KEY (auto)
‚îú‚îÄ‚îÄ audio_url            TEXT NOT NULL
‚îú‚îÄ‚îÄ audio_id_externo     VARCHAR(100)
‚îú‚îÄ‚îÄ timestamp_inicio     TIMESTAMPTZ (opcional)
‚îú‚îÄ‚îÄ timestamp_fin        TIMESTAMPTZ (opcional)
‚îú‚îÄ‚îÄ duracion_segundos    INTEGER (calculado por trigger)
‚îú‚îÄ‚îÄ timestamp_fecha      DATE (calculado por trigger)
‚îú‚îÄ‚îÄ agente_id            UUID (opcional, FK a agentes)
‚îú‚îÄ‚îÄ agente_nombre        VARCHAR(200) (extra√≠do de transcripci√≥n)
‚îú‚îÄ‚îÄ cliente_ref          VARCHAR(100) (opcional)
‚îú‚îÄ‚îÄ cliente_nombre       VARCHAR(200) (extra√≠do de transcripci√≥n)
‚îú‚îÄ‚îÄ empresa_cobranza     VARCHAR(200) (extra√≠do de transcripci√≥n)
‚îú‚îÄ‚îÄ empresa_acreedora    VARCHAR(200) (extra√≠do de transcripci√≥n)
‚îú‚îÄ‚îÄ campana              VARCHAR(100)
‚îú‚îÄ‚îÄ estado               ENUM (pendiente, procesando, transcrito, analizado, error)
‚îú‚îÄ‚îÄ error_mensaje        TEXT
‚îú‚îÄ‚îÄ transcripcion_id     UUID (FK a transcripciones)
‚îú‚îÄ‚îÄ analisis_id          UUID (FK a analisis_llamadas)
‚îú‚îÄ‚îÄ created_at           TIMESTAMPTZ
‚îî‚îÄ‚îÄ updated_at           TIMESTAMPTZ
*/

-- ============================================
-- 5. ACTUALIZAR COMENTARIOS
-- ============================================

COMMENT ON TABLE registro_llamadas IS 'Registro simplificado de llamadas - solo campos esenciales';
COMMENT ON COLUMN registro_llamadas.audio_url IS 'URL del audio en Google Drive u otro storage';
COMMENT ON COLUMN registro_llamadas.audio_id_externo IS 'ID del archivo en el sistema externo (Drive file ID)';
COMMENT ON COLUMN registro_llamadas.agente_id IS 'FK opcional a tabla agentes (lookup por nombre de archivo si existe)';
COMMENT ON COLUMN registro_llamadas.agente_nombre IS 'Nombre del agente extra√≠do de la transcripci√≥n';
COMMENT ON COLUMN registro_llamadas.cliente_ref IS 'Referencia externa del cliente (opcional)';
COMMENT ON COLUMN registro_llamadas.cliente_nombre IS 'Nombre del cliente extra√≠do de la transcripci√≥n';
COMMENT ON COLUMN registro_llamadas.empresa_cobranza IS 'Empresa que realiza la cobranza (ej: Redsap)';
COMMENT ON COLUMN registro_llamadas.empresa_acreedora IS 'Empresa a la que se le debe (ej: Caja Los Andes)';
COMMENT ON COLUMN registro_llamadas.campana IS 'Campa√±a de cobranza (hardcodeado o del sistema)';
</file>

<file path="supabase/seeds/seed_coach_test.sql">
-- ============================================================================
-- DATOS DUMMY PARA TESTING DEL AGENTE COACH
-- Requiere: ejecutar primero seed_detector_test.sql
-- Fecha actual: 4 de febrero 2026
-- ============================================================================

-- ============================================================================
-- 1. COACHING REPORTS ANTERIORES (hace 7 dias - 28 de enero 2026)
-- Para comparar progreso
-- ============================================================================

INSERT INTO coaching_reports (
    reporte_id,
    agente_id,
    fecha_reporte,
    periodo_inicio,
    periodo_fin,
    total_llamadas_analizadas,
    metricas_periodo,
    comparativa_equipo,
    fortalezas,
    gap_critico,
    plan_mejora,
    progreso_vs_anterior,
    generado_por,
    modelo_usado
) VALUES

-- Maria Lopez (Estrella) - Reporte anterior con score 78 (mejoro a 82)
(
    'd0000001-0000-0000-0000-000000000001',
    '11111111-1111-1111-1111-111111111111',
    '2026-01-28',
    '2026-01-21',
    '2026-01-28',
    15,
    '{
        "score_promedio": 78,
        "score_min": 70,
        "score_max": 85,
        "tasa_validacion": 0.85,
        "probabilidad_cumplimiento_promedio": 72,
        "tasa_abandono": 0.05,
        "duracion_promedio": 280
    }'::JSONB,
    '{
        "score_equipo": 65,
        "validacion_equipo": 0.45,
        "ranking": 1,
        "total_agentes": 6,
        "percentil": 95,
        "diferencia_vs_promedio": 13
    }'::JSONB,
    '[
        {"area": "Validacion de compromisos", "descripcion": "Excelente tasa de validacion explicita", "evidencia": "85% de validaciones explicitas", "impacto": "alto"},
        {"area": "Manejo de objeciones", "descripcion": "Responde con empatia y soluciones", "evidencia": "Score de manejo 88/100", "impacto": "alto"}
    ]'::JSONB,
    '{
        "area": "Consecuencias del impago",
        "descripcion": "Podria reforzar las consecuencias del no pago",
        "impacto": "medio",
        "ejemplos_registros": [],
        "frecuencia": "ocasional"
    }'::JSONB,
    '{
        "objetivo_semana": "Mantener score sobre 80 y mejorar mencion de consecuencias",
        "meta_cuantitativa": "Score >= 80, mencionar consecuencias en 80% de llamadas",
        "acciones": ["Incluir consecuencias en el pitch inicial", "Revisar script de cierre"],
        "registros_para_revisar": [],
        "recursos_sugeridos": ["Video: Tecnicas de urgencia"]
    }'::JSONB,
    '{
        "score_cambio": 3,
        "validacion_cambio": 0.05,
        "objetivo_anterior_cumplido": true,
        "notas": "Cumplio objetivo de mantener score sobre 75"
    }'::JSONB,
    'agente_coach',
    'claude-opus-4-5-20250514'
),

-- Carlos Mendez (Promedio) - Reporte anterior con score 62 (mejoro a 65)
(
    'd0000002-0000-0000-0000-000000000002',
    '22222222-2222-2222-2222-222222222222',
    '2026-01-28',
    '2026-01-21',
    '2026-01-28',
    12,
    '{
        "score_promedio": 62,
        "score_min": 52,
        "score_max": 72,
        "tasa_validacion": 0.35,
        "probabilidad_cumplimiento_promedio": 48,
        "tasa_abandono": 0.12,
        "duracion_promedio": 260
    }'::JSONB,
    '{
        "score_equipo": 65,
        "validacion_equipo": 0.45,
        "ranking": 3,
        "total_agentes": 6,
        "percentil": 50,
        "diferencia_vs_promedio": -3
    }'::JSONB,
    '[
        {"area": "Empatia", "descripcion": "Buen tono de voz y conexion inicial", "evidencia": "Clientes responden positivamente", "impacto": "medio"}
    ]'::JSONB,
    '{
        "area": "Validacion de compromisos",
        "descripcion": "Solo 35% de validaciones explicitas",
        "impacto": "alto",
        "ejemplos_registros": [],
        "frecuencia": "frecuente"
    }'::JSONB,
    '{
        "objetivo_semana": "Aumentar validaciones explicitas a 50%",
        "meta_cuantitativa": "Validacion explicita >= 50%",
        "acciones": ["Usar frase de cierre: Entonces confirmamos que pagara X el dia Y, correcto?"],
        "registros_para_revisar": [],
        "recursos_sugeridos": ["Script: Frases de validacion"]
    }'::JSONB,
    '{
        "score_cambio": 2,
        "validacion_cambio": 0.05,
        "objetivo_anterior_cumplido": false,
        "notas": "No alcanzo objetivo de 50% validacion"
    }'::JSONB,
    'agente_coach',
    'claude-opus-4-5-20250514'
),

-- Pedro Ruiz (En Riesgo) - Reporte anterior con score 55 (empeoro a 48)
(
    'd0000003-0000-0000-0000-000000000003',
    '33333333-3333-3333-3333-333333333333',
    '2026-01-28',
    '2026-01-21',
    '2026-01-28',
    10,
    '{
        "score_promedio": 55,
        "score_min": 42,
        "score_max": 65,
        "tasa_validacion": 0.10,
        "probabilidad_cumplimiento_promedio": 38,
        "tasa_abandono": 0.20,
        "duracion_promedio": 220
    }'::JSONB,
    '{
        "score_equipo": 58,
        "validacion_equipo": 0.38,
        "ranking": 4,
        "total_agentes": 6,
        "percentil": 33,
        "diferencia_vs_promedio": -3
    }'::JSONB,
    '[
        {"area": "Conocimiento de producto", "descripcion": "Conoce bien las ofertas", "evidencia": "Explica claramente las opciones", "impacto": "medio"}
    ]'::JSONB,
    '{
        "area": "Cierre de llamadas",
        "descripcion": "Muchas llamadas terminan sin compromiso",
        "impacto": "critico",
        "ejemplos_registros": [],
        "frecuencia": "muy_frecuente"
    }'::JSONB,
    '{
        "objetivo_semana": "Mejorar score a 60 y reducir abandonos",
        "meta_cuantitativa": "Score >= 60, Abandonos <= 15%",
        "acciones": ["Escuchar activamente", "No interrumpir al cliente", "Usar validacion antes de colgar"],
        "registros_para_revisar": [],
        "recursos_sugeridos": ["Sesion 1:1 con supervisor", "Video: Tecnicas de cierre"]
    }'::JSONB,
    '{
        "score_cambio": -2,
        "validacion_cambio": -0.05,
        "objetivo_anterior_cumplido": false,
        "notas": "Score continua bajando, requiere intervencion"
    }'::JSONB,
    'agente_coach',
    'claude-opus-4-5-20250514'
),

-- Ana Torres (Critico) - Reporte anterior con score 38 (empeoro a 32)
(
    'd0000004-0000-0000-0000-000000000004',
    '44444444-4444-4444-4444-444444444444',
    '2026-01-28',
    '2026-01-21',
    '2026-01-28',
    8,
    '{
        "score_promedio": 38,
        "score_min": 25,
        "score_max": 48,
        "tasa_validacion": 0.05,
        "probabilidad_cumplimiento_promedio": 22,
        "tasa_abandono": 0.35,
        "duracion_promedio": 180
    }'::JSONB,
    '{
        "score_equipo": 58,
        "validacion_equipo": 0.38,
        "ranking": 6,
        "total_agentes": 6,
        "percentil": 5,
        "diferencia_vs_promedio": -20
    }'::JSONB,
    '[]'::JSONB,
    '{
        "area": "Comunicacion general",
        "descripcion": "Dificultades en todos los modulos",
        "impacto": "critico",
        "ejemplos_registros": [],
        "frecuencia": "constante"
    }'::JSONB,
    '{
        "objetivo_semana": "Alcanzar score de 45",
        "meta_cuantitativa": "Score >= 45, Abandonos <= 25%",
        "acciones": ["Sesion intensiva con supervisor", "Shadowing con agente estrella", "Revisar 5 llamadas propias diarias"],
        "registros_para_revisar": [],
        "recursos_sugeridos": ["Entrenamiento basico de cobranza", "Mentoria con Maria Lopez"]
    }'::JSONB,
    '{
        "score_cambio": -4,
        "validacion_cambio": -0.05,
        "objetivo_anterior_cumplido": false,
        "notas": "Situacion critica - requiere plan de mejora inmediato"
    }'::JSONB,
    'agente_coach',
    'claude-opus-4-5-20250514'
),

-- Luis Garcia (Sin Validacion) - Reporte anterior con score 58 (mejoro a 60)
(
    'd0000005-0000-0000-0000-000000000005',
    '55555555-5555-5555-5555-555555555555',
    '2026-01-28',
    '2026-01-21',
    '2026-01-28',
    11,
    '{
        "score_promedio": 58,
        "score_min": 50,
        "score_max": 68,
        "tasa_validacion": 0.08,
        "probabilidad_cumplimiento_promedio": 35,
        "tasa_abandono": 0.08,
        "duracion_promedio": 270
    }'::JSONB,
    '{
        "score_equipo": 62,
        "validacion_equipo": 0.42,
        "ranking": 3,
        "total_agentes": 4,
        "percentil": 25,
        "diferencia_vs_promedio": -4
    }'::JSONB,
    '[
        {"area": "Bajo abandono", "descripcion": "Mantiene al cliente en la llamada", "evidencia": "Solo 8% de abandonos", "impacto": "medio"}
    ]'::JSONB,
    '{
        "area": "Validacion de compromisos",
        "descripcion": "Casi nunca pide confirmacion explicita",
        "impacto": "critico",
        "ejemplos_registros": [],
        "frecuencia": "constante"
    }'::JSONB,
    '{
        "objetivo_semana": "Aumentar validaciones explicitas a 25%",
        "meta_cuantitativa": "Validacion explicita >= 25%",
        "acciones": ["Agregar pregunta de confirmacion al final de cada llamada", "Practicar frases de cierre"],
        "registros_para_revisar": [],
        "recursos_sugeridos": ["Script: 10 formas de validar un compromiso"]
    }'::JSONB,
    '{
        "score_cambio": 1,
        "validacion_cambio": 0.02,
        "objetivo_anterior_cumplido": false,
        "notas": "Mejora leve pero validaciones siguen muy bajas"
    }'::JSONB,
    'agente_coach',
    'claude-opus-4-5-20250514'
);

-- Sofia Vargas (Nueva) no tiene reporte anterior porque tiene solo 2 llamadas

-- ============================================================================
-- 2. ALERTAS PARA LOS AGENTES (usando agentes_relacionados)
-- ============================================================================

-- Alertas para Pedro Ruiz (del periodo anterior)
INSERT INTO alertas_anomalias (
    tipo, severidad, codigo, descripcion, 
    datos_soporte, agentes_relacionados, estado, created_at
) VALUES
(
    'individual', 'alta', 'AGENTE_SCORE_BAJO',
    'Score promedio bajo (55) en ultimas 24 horas',
    '{"score_promedio": 55, "total_llamadas": 10}'::JSONB,
    ARRAY['33333333-3333-3333-3333-333333333333'::UUID],
    'resuelta',
    '2026-01-26 08:00:00-05'
),
(
    'individual', 'alta', 'AGENTE_ABANDONO_ALTO',
    'Tasa de abandono alta (22%) en ultimas 24 horas',
    '{"tasa_abandono": 0.22, "abandonos": 2}'::JSONB,
    ARRAY['33333333-3333-3333-3333-333333333333'::UUID],
    'resuelta',
    '2026-01-27 08:00:00-05'
);

-- Alertas para Ana Torres (del periodo anterior - criticas)
INSERT INTO alertas_anomalias (
    tipo, severidad, codigo, descripcion, 
    datos_soporte, agentes_relacionados, estado, created_at
) VALUES
(
    'individual', 'critica', 'AGENTE_SCORE_CRITICO',
    'Score promedio critico (35) en ultimas 24 horas',
    '{"score_promedio": 35, "total_llamadas": 8}'::JSONB,
    ARRAY['44444444-4444-4444-4444-444444444444'::UUID],
    'en_revision',
    '2026-01-25 08:00:00-05'
),
(
    'individual', 'alta', 'AGENTE_ABANDONO_ALTO',
    'Tasa de abandono alta (35%) en ultimas 24 horas',
    '{"tasa_abandono": 0.35, "abandonos": 3}'::JSONB,
    ARRAY['44444444-4444-4444-4444-444444444444'::UUID],
    'en_revision',
    '2026-01-26 08:00:00-05'
),
(
    'patron', 'alta', 'PATRON_LLAMADAS_CRITICAS',
    '6 llamadas con score critico (<40) en 24 horas',
    '{"llamadas_criticas": 6, "total_llamadas": 8}'::JSONB,
    ARRAY['44444444-4444-4444-4444-444444444444'::UUID],
    'en_revision',
    '2026-01-27 08:00:00-05'
);

-- Alerta para Luis Garcia
INSERT INTO alertas_anomalias (
    tipo, severidad, codigo, descripcion, 
    datos_soporte, agentes_relacionados, estado, created_at
) VALUES
(
    'individual', 'alta', 'AGENTE_SIN_VALIDACION',
    'Tasa de validacion explicita muy baja (8%) en ultimas 24 horas',
    '{"tasa_validacion": 0.08, "validaciones": 1}'::JSONB,
    ARRAY['55555555-5555-5555-5555-555555555555'::UUID],
    'nueva',
    '2026-01-28 08:00:00-05'
);

-- ============================================================================
-- RESUMEN DE DATOS CREADOS
-- ============================================================================
-- 
-- COACHING REPORTS ANTERIORES (5):
-- - Maria Lopez: score 78 -> 82 (mejoro +4)
-- - Carlos Mendez: score 62 -> 65 (mejoro +3)
-- - Pedro Ruiz: score 55 -> 48 (empeoro -7) *EN RIESGO*
-- - Ana Torres: score 38 -> 32 (empeoro -6) *CRITICO*
-- - Luis Garcia: score 58 -> 60 (mejoro +2, pero validacion sigue baja)
-- - Sofia Vargas: sin reporte (nueva)
--
-- ALERTAS HISTORICAS (6):
-- - Pedro Ruiz: 2 alertas resueltas
-- - Ana Torres: 3 alertas en revision
-- - Luis Garcia: 1 alerta nueva
--
-- ============================================================================
</file>

<file path="supabase/seeds/seed_detector_test.sql">
-- ============================================================================
-- DATOS DUMMY PARA TESTING DEL AGENTE DETECTOR
-- Fecha actual: 4 de febrero 2026, 05:16 AM
-- Periodo: Ultimas 48 horas (desde 2 de febrero 2026, 05:16 AM)
-- ============================================================================

-- Limpiar datos existentes (en orden correcto por FKs)
TRUNCATE analisis_llamadas CASCADE;
TRUNCATE transcripciones CASCADE;
TRUNCATE registro_llamadas CASCADE;
TRUNCATE agentes CASCADE;

-- ============================================================================
-- 1. AGENTES (6 agentes con diferentes perfiles)
-- ============================================================================

INSERT INTO agentes (agente_id, nombre, email, equipo, estado, fecha_ingreso) VALUES
-- Agente ESTRELLA: score alto, buena validacion
('11111111-1111-1111-1111-111111111111', 'Maria Lopez', 'maria.lopez@empresa.com', 'Equipo Norte', 'activo', '2023-01-15'),

-- Agente PROMEDIO: score normal
('22222222-2222-2222-2222-222222222222', 'Carlos Mendez', 'carlos.mendez@empresa.com', 'Equipo Norte', 'activo', '2023-06-01'),

-- Agente EN RIESGO: score bajo (40-55)
('33333333-3333-3333-3333-333333333333', 'Pedro Ruiz', 'pedro.ruiz@empresa.com', 'Equipo Sur', 'activo', '2024-02-01'),

-- Agente CRITICO: score muy bajo (<40), alto abandono
('44444444-4444-4444-4444-444444444444', 'Ana Torres', 'ana.torres@empresa.com', 'Equipo Sur', 'activo', '2024-08-01'),

-- Agente SIN VALIDACION: score ok pero sin validaciones explicitas
('55555555-5555-5555-5555-555555555555', 'Luis Garcia', 'luis.garcia@empresa.com', 'Equipo Centro', 'activo', '2023-09-15'),

-- Agente NUEVO: pocas llamadas
('66666666-6666-6666-6666-666666666666', 'Sofia Vargas', 'sofia.vargas@empresa.com', 'Equipo Centro', 'activo', '2026-01-15');

-- ============================================================================
-- 2. REGISTRO DE LLAMADAS + TRANSCRIPCIONES + ANALISIS
-- Distribuidas en las ultimas 48 horas
-- ============================================================================

-- -------------------------------------------------------------------------------
-- MARIA LOPEZ (Estrella) - 12 llamadas, score promedio ~82
-- -------------------------------------------------------------------------------

-- Llamada 1
INSERT INTO registro_llamadas (registro_id, audio_url, audio_id_externo, timestamp_inicio, timestamp_fin, agente_id, cliente_ref, campana, estado)
VALUES ('a0000001-0000-0000-0000-000000000001', 'https://drive.google.com/file/ML001', 'ML001', '2026-02-02 09:15:00-05', '2026-02-02 09:19:30-05', '11111111-1111-1111-1111-111111111111', 'CLI-001', 'CAMPANA_Q1', 'analizado');

INSERT INTO transcripciones (transcripcion_id, registro_id, transcripcion_completa, segmentos, modelo_transcripcion)
VALUES ('b0000001-0000-0000-0000-000000000001', 'a0000001-0000-0000-0000-000000000001', 'Transcripcion Maria Lopez llamada 1...', '[]'::JSONB, 'gemini-2.0-flash');

INSERT INTO analisis_llamadas (analisis_id, registro_id, transcripcion_id, agente_id, score_total, score_contacto_directo, score_compromiso_pago, modulo_contacto_directo, modulo_compromiso_pago, modulo_abandono, probabilidad_cumplimiento, nivel_cumplimiento, fecha_llamada, created_at)
VALUES ('c0000001-0000-0000-0000-000000000001', 'a0000001-0000-0000-0000-000000000001', 'b0000001-0000-0000-0000-000000000001', '11111111-1111-1111-1111-111111111111', 
85, 82, 88,
'{"score": 82, "desglose": {"monto_mencionado": {"presente": true, "puntos": 25, "max": 25}, "validacion_cliente": {"tipo": "explicita", "puntos": 45, "max": 50}}}'::JSONB,
'{"score": 88, "desglose": {"validacion_cliente": {"presente": true, "tipo": "explicita", "puntos": 45, "max": 50}}}'::JSONB,
'{"hubo_abandono": false}'::JSONB,
78, 'alta', '2026-02-02', '2026-02-02 09:25:00-05');

-- Llamadas 2-12 para Maria Lopez (scores altos 75-90)
INSERT INTO registro_llamadas (registro_id, audio_url, audio_id_externo, timestamp_inicio, timestamp_fin, agente_id, cliente_ref, campana, estado) VALUES
('a0000002-0000-0000-0000-000000000001', 'https://drive.google.com/file/ML002', 'ML002', '2026-02-02 10:30:00-05', '2026-02-02 10:35:00-05', '11111111-1111-1111-1111-111111111111', 'CLI-002', 'CAMPANA_Q1', 'analizado'),
('a0000003-0000-0000-0000-000000000001', 'https://drive.google.com/file/ML003', 'ML003', '2026-02-02 11:45:00-05', '2026-02-02 11:50:00-05', '11111111-1111-1111-1111-111111111111', 'CLI-003', 'CAMPANA_Q1', 'analizado'),
('a0000004-0000-0000-0000-000000000001', 'https://drive.google.com/file/ML004', 'ML004', '2026-02-02 14:00:00-05', '2026-02-02 14:06:00-05', '11111111-1111-1111-1111-111111111111', 'CLI-004', 'CAMPANA_Q1', 'analizado'),
('a0000005-0000-0000-0000-000000000001', 'https://drive.google.com/file/ML005', 'ML005', '2026-02-02 15:15:00-05', '2026-02-02 15:20:00-05', '11111111-1111-1111-1111-111111111111', 'CLI-005', 'CAMPANA_Q1', 'analizado'),
('a0000006-0000-0000-0000-000000000001', 'https://drive.google.com/file/ML006', 'ML006', '2026-02-02 16:30:00-05', '2026-02-02 16:35:00-05', '11111111-1111-1111-1111-111111111111', 'CLI-006', 'CAMPANA_Q1', 'analizado'),
('a0000007-0000-0000-0000-000000000001', 'https://drive.google.com/file/ML007', 'ML007', '2026-02-03 09:00:00-05', '2026-02-03 09:05:00-05', '11111111-1111-1111-1111-111111111111', 'CLI-007', 'CAMPANA_Q1', 'analizado'),
('a0000008-0000-0000-0000-000000000001', 'https://drive.google.com/file/ML008', 'ML008', '2026-02-03 10:15:00-05', '2026-02-03 10:20:00-05', '11111111-1111-1111-1111-111111111111', 'CLI-008', 'CAMPANA_Q1', 'analizado'),
('a0000009-0000-0000-0000-000000000001', 'https://drive.google.com/file/ML009', 'ML009', '2026-02-03 11:30:00-05', '2026-02-03 11:36:00-05', '11111111-1111-1111-1111-111111111111', 'CLI-009', 'CAMPANA_Q1', 'analizado'),
('a0000010-0000-0000-0000-000000000001', 'https://drive.google.com/file/ML010', 'ML010', '2026-02-03 14:00:00-05', '2026-02-03 14:05:00-05', '11111111-1111-1111-1111-111111111111', 'CLI-010', 'CAMPANA_Q1', 'analizado'),
('a0000011-0000-0000-0000-000000000001', 'https://drive.google.com/file/ML011', 'ML011', '2026-02-03 15:15:00-05', '2026-02-03 15:21:00-05', '11111111-1111-1111-1111-111111111111', 'CLI-011', 'CAMPANA_Q1', 'analizado'),
('a0000012-0000-0000-0000-000000000001', 'https://drive.google.com/file/ML012', 'ML012', '2026-02-03 16:30:00-05', '2026-02-03 16:35:00-05', '11111111-1111-1111-1111-111111111111', 'CLI-012', 'CAMPANA_Q1', 'analizado');

INSERT INTO transcripciones (transcripcion_id, registro_id, transcripcion_completa, segmentos, modelo_transcripcion) VALUES
('b0000002-0000-0000-0000-000000000001', 'a0000002-0000-0000-0000-000000000001', 'Transcripcion ML002...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000003-0000-0000-0000-000000000001', 'a0000003-0000-0000-0000-000000000001', 'Transcripcion ML003...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000004-0000-0000-0000-000000000001', 'a0000004-0000-0000-0000-000000000001', 'Transcripcion ML004...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000005-0000-0000-0000-000000000001', 'a0000005-0000-0000-0000-000000000001', 'Transcripcion ML005...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000006-0000-0000-0000-000000000001', 'a0000006-0000-0000-0000-000000000001', 'Transcripcion ML006...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000007-0000-0000-0000-000000000001', 'a0000007-0000-0000-0000-000000000001', 'Transcripcion ML007...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000008-0000-0000-0000-000000000001', 'a0000008-0000-0000-0000-000000000001', 'Transcripcion ML008...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000009-0000-0000-0000-000000000001', 'a0000009-0000-0000-0000-000000000001', 'Transcripcion ML009...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000010-0000-0000-0000-000000000001', 'a0000010-0000-0000-0000-000000000001', 'Transcripcion ML010...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000011-0000-0000-0000-000000000001', 'a0000011-0000-0000-0000-000000000001', 'Transcripcion ML011...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000012-0000-0000-0000-000000000001', 'a0000012-0000-0000-0000-000000000001', 'Transcripcion ML012...', '[]'::JSONB, 'gemini-2.0-flash');

INSERT INTO analisis_llamadas (analisis_id, registro_id, transcripcion_id, agente_id, score_total, score_contacto_directo, score_compromiso_pago, modulo_contacto_directo, modulo_compromiso_pago, modulo_abandono, probabilidad_cumplimiento, nivel_cumplimiento, fecha_llamada, created_at) VALUES
('c0000002-0000-0000-0000-000000000001', 'a0000002-0000-0000-0000-000000000001', 'b0000002-0000-0000-0000-000000000001', '11111111-1111-1111-1111-111111111111', 80, 78, 82, '{"score": 78}'::JSONB, '{"score": 82, "desglose": {"validacion_cliente": {"tipo": "explicita"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 72, 'alta', '2026-02-02', '2026-02-02 10:40:00-05'),
('c0000003-0000-0000-0000-000000000001', 'a0000003-0000-0000-0000-000000000001', 'b0000003-0000-0000-0000-000000000001', '11111111-1111-1111-1111-111111111111', 88, 85, 91, '{"score": 85}'::JSONB, '{"score": 91, "desglose": {"validacion_cliente": {"tipo": "explicita"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 85, 'alta', '2026-02-02', '2026-02-02 11:55:00-05'),
('c0000004-0000-0000-0000-000000000001', 'a0000004-0000-0000-0000-000000000001', 'b0000004-0000-0000-0000-000000000001', '11111111-1111-1111-1111-111111111111', 76, 74, 78, '{"score": 74}'::JSONB, '{"score": 78, "desglose": {"validacion_cliente": {"tipo": "explicita"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 68, 'media', '2026-02-02', '2026-02-02 14:10:00-05'),
('c0000005-0000-0000-0000-000000000001', 'a0000005-0000-0000-0000-000000000001', 'b0000005-0000-0000-0000-000000000001', '11111111-1111-1111-1111-111111111111', 82, 80, 84, '{"score": 80}'::JSONB, '{"score": 84, "desglose": {"validacion_cliente": {"tipo": "explicita"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 75, 'alta', '2026-02-02', '2026-02-02 15:25:00-05'),
('c0000006-0000-0000-0000-000000000001', 'a0000006-0000-0000-0000-000000000001', 'b0000006-0000-0000-0000-000000000001', '11111111-1111-1111-1111-111111111111', 90, 88, 92, '{"score": 88}'::JSONB, '{"score": 92, "desglose": {"validacion_cliente": {"tipo": "explicita"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 88, 'alta', '2026-02-02', '2026-02-02 16:40:00-05'),
('c0000007-0000-0000-0000-000000000001', 'a0000007-0000-0000-0000-000000000001', 'b0000007-0000-0000-0000-000000000001', '11111111-1111-1111-1111-111111111111', 78, 76, 80, '{"score": 76}'::JSONB, '{"score": 80, "desglose": {"validacion_cliente": {"tipo": "explicita"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 70, 'media', '2026-02-03', '2026-02-03 09:10:00-05'),
('c0000008-0000-0000-0000-000000000001', 'a0000008-0000-0000-0000-000000000001', 'b0000008-0000-0000-0000-000000000001', '11111111-1111-1111-1111-111111111111', 84, 82, 86, '{"score": 82}'::JSONB, '{"score": 86, "desglose": {"validacion_cliente": {"tipo": "explicita"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 78, 'alta', '2026-02-03', '2026-02-03 10:25:00-05'),
('c0000009-0000-0000-0000-000000000001', 'a0000009-0000-0000-0000-000000000001', 'b0000009-0000-0000-0000-000000000001', '11111111-1111-1111-1111-111111111111', 86, 84, 88, '{"score": 84}'::JSONB, '{"score": 88, "desglose": {"validacion_cliente": {"tipo": "explicita"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 82, 'alta', '2026-02-03', '2026-02-03 11:40:00-05'),
('c0000010-0000-0000-0000-000000000001', 'a0000010-0000-0000-0000-000000000001', 'b0000010-0000-0000-0000-000000000001', '11111111-1111-1111-1111-111111111111', 79, 77, 81, '{"score": 77}'::JSONB, '{"score": 81, "desglose": {"validacion_cliente": {"tipo": "explicita"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 71, 'media', '2026-02-03', '2026-02-03 14:10:00-05'),
('c0000011-0000-0000-0000-000000000001', 'a0000011-0000-0000-0000-000000000001', 'b0000011-0000-0000-0000-000000000001', '11111111-1111-1111-1111-111111111111', 83, 81, 85, '{"score": 81}'::JSONB, '{"score": 85, "desglose": {"validacion_cliente": {"tipo": "explicita"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 76, 'alta', '2026-02-03', '2026-02-03 15:25:00-05'),
('c0000012-0000-0000-0000-000000000001', 'a0000012-0000-0000-0000-000000000001', 'b0000012-0000-0000-0000-000000000001', '11111111-1111-1111-1111-111111111111', 81, 79, 83, '{"score": 79}'::JSONB, '{"score": 83, "desglose": {"validacion_cliente": {"tipo": "explicita"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 74, 'alta', '2026-02-03', '2026-02-03 16:40:00-05');

-- -------------------------------------------------------------------------------
-- CARLOS MENDEZ (Promedio) - 10 llamadas, score promedio ~65
-- -------------------------------------------------------------------------------

INSERT INTO registro_llamadas (registro_id, audio_url, audio_id_externo, timestamp_inicio, timestamp_fin, agente_id, cliente_ref, campana, estado) VALUES
('a0000001-0000-0000-0000-000000000002', 'https://drive.google.com/file/CM001', 'CM001', '2026-02-02 09:30:00-05', '2026-02-02 09:35:00-05', '22222222-2222-2222-2222-222222222222', 'CLI-101', 'CAMPANA_Q1', 'analizado'),
('a0000002-0000-0000-0000-000000000002', 'https://drive.google.com/file/CM002', 'CM002', '2026-02-02 10:45:00-05', '2026-02-02 10:50:00-05', '22222222-2222-2222-2222-222222222222', 'CLI-102', 'CAMPANA_Q1', 'analizado'),
('a0000003-0000-0000-0000-000000000002', 'https://drive.google.com/file/CM003', 'CM003', '2026-02-02 14:15:00-05', '2026-02-02 14:21:00-05', '22222222-2222-2222-2222-222222222222', 'CLI-103', 'CAMPANA_Q1', 'analizado'),
('a0000004-0000-0000-0000-000000000002', 'https://drive.google.com/file/CM004', 'CM004', '2026-02-02 15:30:00-05', '2026-02-02 15:35:00-05', '22222222-2222-2222-2222-222222222222', 'CLI-104', 'CAMPANA_Q1', 'analizado'),
('a0000005-0000-0000-0000-000000000002', 'https://drive.google.com/file/CM005', 'CM005', '2026-02-02 16:45:00-05', '2026-02-02 16:50:00-05', '22222222-2222-2222-2222-222222222222', 'CLI-105', 'CAMPANA_Q1', 'analizado'),
('a0000006-0000-0000-0000-000000000002', 'https://drive.google.com/file/CM006', 'CM006', '2026-02-03 09:15:00-05', '2026-02-03 09:20:00-05', '22222222-2222-2222-2222-222222222222', 'CLI-106', 'CAMPANA_Q1', 'analizado'),
('a0000007-0000-0000-0000-000000000002', 'https://drive.google.com/file/CM007', 'CM007', '2026-02-03 10:30:00-05', '2026-02-03 10:36:00-05', '22222222-2222-2222-2222-222222222222', 'CLI-107', 'CAMPANA_Q1', 'analizado'),
('a0000008-0000-0000-0000-000000000002', 'https://drive.google.com/file/CM008', 'CM008', '2026-02-03 11:45:00-05', '2026-02-03 11:50:00-05', '22222222-2222-2222-2222-222222222222', 'CLI-108', 'CAMPANA_Q1', 'analizado'),
('a0000009-0000-0000-0000-000000000002', 'https://drive.google.com/file/CM009', 'CM009', '2026-02-03 14:15:00-05', '2026-02-03 14:20:00-05', '22222222-2222-2222-2222-222222222222', 'CLI-109', 'CAMPANA_Q1', 'analizado'),
('a0000010-0000-0000-0000-000000000002', 'https://drive.google.com/file/CM010', 'CM010', '2026-02-03 15:30:00-05', '2026-02-03 15:35:00-05', '22222222-2222-2222-2222-222222222222', 'CLI-110', 'CAMPANA_Q1', 'analizado');

INSERT INTO transcripciones (transcripcion_id, registro_id, transcripcion_completa, segmentos, modelo_transcripcion) VALUES
('b0000001-0000-0000-0000-000000000002', 'a0000001-0000-0000-0000-000000000002', 'Transcripcion CM001...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000002-0000-0000-0000-000000000002', 'a0000002-0000-0000-0000-000000000002', 'Transcripcion CM002...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000003-0000-0000-0000-000000000002', 'a0000003-0000-0000-0000-000000000002', 'Transcripcion CM003...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000004-0000-0000-0000-000000000002', 'a0000004-0000-0000-0000-000000000002', 'Transcripcion CM004...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000005-0000-0000-0000-000000000002', 'a0000005-0000-0000-0000-000000000002', 'Transcripcion CM005...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000006-0000-0000-0000-000000000002', 'a0000006-0000-0000-0000-000000000002', 'Transcripcion CM006...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000007-0000-0000-0000-000000000002', 'a0000007-0000-0000-0000-000000000002', 'Transcripcion CM007...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000008-0000-0000-0000-000000000002', 'a0000008-0000-0000-0000-000000000002', 'Transcripcion CM008...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000009-0000-0000-0000-000000000002', 'a0000009-0000-0000-0000-000000000002', 'Transcripcion CM009...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000010-0000-0000-0000-000000000002', 'a0000010-0000-0000-0000-000000000002', 'Transcripcion CM010...', '[]'::JSONB, 'gemini-2.0-flash');

INSERT INTO analisis_llamadas (analisis_id, registro_id, transcripcion_id, agente_id, score_total, score_contacto_directo, score_compromiso_pago, modulo_contacto_directo, modulo_compromiso_pago, modulo_abandono, probabilidad_cumplimiento, nivel_cumplimiento, fecha_llamada, created_at) VALUES
('c0000001-0000-0000-0000-000000000002', 'a0000001-0000-0000-0000-000000000002', 'b0000001-0000-0000-0000-000000000002', '22222222-2222-2222-2222-222222222222', 68, 65, 71, '{"score": 65}'::JSONB, '{"score": 71, "desglose": {"validacion_cliente": {"tipo": "implicita"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 55, 'media', '2026-02-02', '2026-02-02 09:40:00-05'),
('c0000002-0000-0000-0000-000000000002', 'a0000002-0000-0000-0000-000000000002', 'b0000002-0000-0000-0000-000000000002', '22222222-2222-2222-2222-222222222222', 62, 60, 64, '{"score": 60}'::JSONB, '{"score": 64, "desglose": {"validacion_cliente": {"tipo": "explicita"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 48, 'media', '2026-02-02', '2026-02-02 10:55:00-05'),
('c0000003-0000-0000-0000-000000000002', 'a0000003-0000-0000-0000-000000000002', 'b0000003-0000-0000-0000-000000000002', '22222222-2222-2222-2222-222222222222', 70, 68, 72, '{"score": 68}'::JSONB, '{"score": 72, "desglose": {"validacion_cliente": {"tipo": "explicita"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 60, 'media', '2026-02-02', '2026-02-02 14:25:00-05'),
('c0000004-0000-0000-0000-000000000002', 'a0000004-0000-0000-0000-000000000002', 'b0000004-0000-0000-0000-000000000002', '22222222-2222-2222-2222-222222222222', 65, 63, 67, '{"score": 63}'::JSONB, '{"score": 67, "desglose": {"validacion_cliente": {"tipo": "implicita"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 52, 'media', '2026-02-02', '2026-02-02 15:40:00-05'),
('c0000005-0000-0000-0000-000000000002', 'a0000005-0000-0000-0000-000000000002', 'b0000005-0000-0000-0000-000000000002', '22222222-2222-2222-2222-222222222222', 58, 55, 61, '{"score": 55}'::JSONB, '{"score": 61, "desglose": {"validacion_cliente": {"tipo": "ninguna"}}}'::JSONB, '{"hubo_abandono": true}'::JSONB, 40, 'media', '2026-02-02', '2026-02-02 16:55:00-05'),
('c0000006-0000-0000-0000-000000000002', 'a0000006-0000-0000-0000-000000000002', 'b0000006-0000-0000-0000-000000000002', '22222222-2222-2222-2222-222222222222', 72, 70, 74, '{"score": 70}'::JSONB, '{"score": 74, "desglose": {"validacion_cliente": {"tipo": "explicita"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 62, 'media', '2026-02-03', '2026-02-03 09:25:00-05'),
('c0000007-0000-0000-0000-000000000002', 'a0000007-0000-0000-0000-000000000002', 'b0000007-0000-0000-0000-000000000002', '22222222-2222-2222-2222-222222222222', 66, 64, 68, '{"score": 64}'::JSONB, '{"score": 68, "desglose": {"validacion_cliente": {"tipo": "implicita"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 54, 'media', '2026-02-03', '2026-02-03 10:40:00-05'),
('c0000008-0000-0000-0000-000000000002', 'a0000008-0000-0000-0000-000000000002', 'b0000008-0000-0000-0000-000000000002', '22222222-2222-2222-2222-222222222222', 64, 62, 66, '{"score": 62}'::JSONB, '{"score": 66, "desglose": {"validacion_cliente": {"tipo": "ninguna"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 50, 'media', '2026-02-03', '2026-02-03 11:55:00-05'),
('c0000009-0000-0000-0000-000000000002', 'a0000009-0000-0000-0000-000000000002', 'b0000009-0000-0000-0000-000000000002', '22222222-2222-2222-2222-222222222222', 69, 67, 71, '{"score": 67}'::JSONB, '{"score": 71, "desglose": {"validacion_cliente": {"tipo": "explicita"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 58, 'media', '2026-02-03', '2026-02-03 14:25:00-05'),
('c0000010-0000-0000-0000-000000000002', 'a0000010-0000-0000-0000-000000000002', 'b0000010-0000-0000-0000-000000000002', '22222222-2222-2222-2222-222222222222', 61, 59, 63, '{"score": 59}'::JSONB, '{"score": 63, "desglose": {"validacion_cliente": {"tipo": "implicita"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 46, 'media', '2026-02-03', '2026-02-03 15:40:00-05');

-- -------------------------------------------------------------------------------
-- PEDRO RUIZ (En Riesgo) - 10 llamadas, score promedio ~48 (dispara AGENTE_SCORE_BAJO)
-- -------------------------------------------------------------------------------

INSERT INTO registro_llamadas (registro_id, audio_url, audio_id_externo, timestamp_inicio, timestamp_fin, agente_id, cliente_ref, campana, estado) VALUES
('a0000001-0000-0000-0000-000000000003', 'https://drive.google.com/file/PR001', 'PR001', '2026-02-02 09:00:00-05', '2026-02-02 09:04:00-05', '33333333-3333-3333-3333-333333333333', 'CLI-201', 'CAMPANA_Q1', 'analizado'),
('a0000002-0000-0000-0000-000000000003', 'https://drive.google.com/file/PR002', 'PR002', '2026-02-02 10:15:00-05', '2026-02-02 10:19:00-05', '33333333-3333-3333-3333-333333333333', 'CLI-202', 'CAMPANA_Q1', 'analizado'),
('a0000003-0000-0000-0000-000000000003', 'https://drive.google.com/file/PR003', 'PR003', '2026-02-02 11:30:00-05', '2026-02-02 11:35:00-05', '33333333-3333-3333-3333-333333333333', 'CLI-203', 'CAMPANA_Q1', 'analizado'),
('a0000004-0000-0000-0000-000000000003', 'https://drive.google.com/file/PR004', 'PR004', '2026-02-02 14:00:00-05', '2026-02-02 14:04:00-05', '33333333-3333-3333-3333-333333333333', 'CLI-204', 'CAMPANA_Q1', 'analizado'),
('a0000005-0000-0000-0000-000000000003', 'https://drive.google.com/file/PR005', 'PR005', '2026-02-02 15:15:00-05', '2026-02-02 15:20:00-05', '33333333-3333-3333-3333-333333333333', 'CLI-205', 'CAMPANA_Q1', 'analizado'),
('a0000006-0000-0000-0000-000000000003', 'https://drive.google.com/file/PR006', 'PR006', '2026-02-03 09:00:00-05', '2026-02-03 09:05:00-05', '33333333-3333-3333-3333-333333333333', 'CLI-206', 'CAMPANA_Q1', 'analizado'),
('a0000007-0000-0000-0000-000000000003', 'https://drive.google.com/file/PR007', 'PR007', '2026-02-03 10:15:00-05', '2026-02-03 10:19:00-05', '33333333-3333-3333-3333-333333333333', 'CLI-207', 'CAMPANA_Q1', 'analizado'),
('a0000008-0000-0000-0000-000000000003', 'https://drive.google.com/file/PR008', 'PR008', '2026-02-03 11:30:00-05', '2026-02-03 11:34:00-05', '33333333-3333-3333-3333-333333333333', 'CLI-208', 'CAMPANA_Q1', 'analizado'),
('a0000009-0000-0000-0000-000000000003', 'https://drive.google.com/file/PR009', 'PR009', '2026-02-03 14:00:00-05', '2026-02-03 14:05:00-05', '33333333-3333-3333-3333-333333333333', 'CLI-209', 'CAMPANA_Q1', 'analizado'),
('a0000010-0000-0000-0000-000000000003', 'https://drive.google.com/file/PR010', 'PR010', '2026-02-03 15:15:00-05', '2026-02-03 15:19:00-05', '33333333-3333-3333-3333-333333333333', 'CLI-210', 'CAMPANA_Q1', 'analizado');

INSERT INTO transcripciones (transcripcion_id, registro_id, transcripcion_completa, segmentos, modelo_transcripcion) VALUES
('b0000001-0000-0000-0000-000000000003', 'a0000001-0000-0000-0000-000000000003', 'Transcripcion PR001...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000002-0000-0000-0000-000000000003', 'a0000002-0000-0000-0000-000000000003', 'Transcripcion PR002...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000003-0000-0000-0000-000000000003', 'a0000003-0000-0000-0000-000000000003', 'Transcripcion PR003...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000004-0000-0000-0000-000000000003', 'a0000004-0000-0000-0000-000000000003', 'Transcripcion PR004...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000005-0000-0000-0000-000000000003', 'a0000005-0000-0000-0000-000000000003', 'Transcripcion PR005...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000006-0000-0000-0000-000000000003', 'a0000006-0000-0000-0000-000000000003', 'Transcripcion PR006...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000007-0000-0000-0000-000000000003', 'a0000007-0000-0000-0000-000000000003', 'Transcripcion PR007...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000008-0000-0000-0000-000000000003', 'a0000008-0000-0000-0000-000000000003', 'Transcripcion PR008...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000009-0000-0000-0000-000000000003', 'a0000009-0000-0000-0000-000000000003', 'Transcripcion PR009...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000010-0000-0000-0000-000000000003', 'a0000010-0000-0000-0000-000000000003', 'Transcripcion PR010...', '[]'::JSONB, 'gemini-2.0-flash');

INSERT INTO analisis_llamadas (analisis_id, registro_id, transcripcion_id, agente_id, score_total, score_contacto_directo, score_compromiso_pago, modulo_contacto_directo, modulo_compromiso_pago, modulo_abandono, probabilidad_cumplimiento, nivel_cumplimiento, fecha_llamada, created_at) VALUES
('c0000001-0000-0000-0000-000000000003', 'a0000001-0000-0000-0000-000000000003', 'b0000001-0000-0000-0000-000000000003', '33333333-3333-3333-3333-333333333333', 52, 50, 54, '{"score": 50}'::JSONB, '{"score": 54, "desglose": {"validacion_cliente": {"tipo": "ninguna"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 35, 'baja', '2026-02-02', '2026-02-02 09:10:00-05'),
('c0000002-0000-0000-0000-000000000003', 'a0000002-0000-0000-0000-000000000003', 'b0000002-0000-0000-0000-000000000003', '33333333-3333-3333-3333-333333333333', 45, 43, 47, '{"score": 43}'::JSONB, '{"score": 47, "desglose": {"validacion_cliente": {"tipo": "implicita"}}}'::JSONB, '{"hubo_abandono": true}'::JSONB, 28, 'baja', '2026-02-02', '2026-02-02 10:25:00-05'),
('c0000003-0000-0000-0000-000000000003', 'a0000003-0000-0000-0000-000000000003', 'b0000003-0000-0000-0000-000000000003', '33333333-3333-3333-3333-333333333333', 55, 53, 57, '{"score": 53}'::JSONB, '{"score": 57, "desglose": {"validacion_cliente": {"tipo": "ninguna"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 38, 'baja', '2026-02-02', '2026-02-02 11:40:00-05'),
('c0000004-0000-0000-0000-000000000003', 'a0000004-0000-0000-0000-000000000003', 'b0000004-0000-0000-0000-000000000003', '33333333-3333-3333-3333-333333333333', 48, 46, 50, '{"score": 46}'::JSONB, '{"score": 50, "desglose": {"validacion_cliente": {"tipo": "ninguna"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 32, 'baja', '2026-02-02', '2026-02-02 14:10:00-05'),
('c0000005-0000-0000-0000-000000000003', 'a0000005-0000-0000-0000-000000000003', 'b0000005-0000-0000-0000-000000000003', '33333333-3333-3333-3333-333333333333', 42, 40, 44, '{"score": 40}'::JSONB, '{"score": 44, "desglose": {"validacion_cliente": {"tipo": "ninguna"}}}'::JSONB, '{"hubo_abandono": true}'::JSONB, 25, 'baja', '2026-02-02', '2026-02-02 15:25:00-05'),
('c0000006-0000-0000-0000-000000000003', 'a0000006-0000-0000-0000-000000000003', 'b0000006-0000-0000-0000-000000000003', '33333333-3333-3333-3333-333333333333', 50, 48, 52, '{"score": 48}'::JSONB, '{"score": 52, "desglose": {"validacion_cliente": {"tipo": "implicita"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 34, 'baja', '2026-02-03', '2026-02-03 09:10:00-05'),
('c0000007-0000-0000-0000-000000000003', 'a0000007-0000-0000-0000-000000000003', 'b0000007-0000-0000-0000-000000000003', '33333333-3333-3333-3333-333333333333', 46, 44, 48, '{"score": 44}'::JSONB, '{"score": 48, "desglose": {"validacion_cliente": {"tipo": "ninguna"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 30, 'baja', '2026-02-03', '2026-02-03 10:25:00-05'),
('c0000008-0000-0000-0000-000000000003', 'a0000008-0000-0000-0000-000000000003', 'b0000008-0000-0000-0000-000000000003', '33333333-3333-3333-3333-333333333333', 53, 51, 55, '{"score": 51}'::JSONB, '{"score": 55, "desglose": {"validacion_cliente": {"tipo": "ninguna"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 36, 'baja', '2026-02-03', '2026-02-03 11:40:00-05'),
('c0000009-0000-0000-0000-000000000003', 'a0000009-0000-0000-0000-000000000003', 'b0000009-0000-0000-0000-000000000003', '33333333-3333-3333-3333-333333333333', 44, 42, 46, '{"score": 42}'::JSONB, '{"score": 46, "desglose": {"validacion_cliente": {"tipo": "ninguna"}}}'::JSONB, '{"hubo_abandono": true}'::JSONB, 27, 'baja', '2026-02-03', '2026-02-03 14:10:00-05'),
('c0000010-0000-0000-0000-000000000003', 'a0000010-0000-0000-0000-000000000003', 'b0000010-0000-0000-0000-000000000003', '33333333-3333-3333-3333-333333333333', 49, 47, 51, '{"score": 47}'::JSONB, '{"score": 51, "desglose": {"validacion_cliente": {"tipo": "implicita"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 33, 'baja', '2026-02-03', '2026-02-03 15:25:00-05');

-- -------------------------------------------------------------------------------
-- ANA TORRES (Critico) - 10 llamadas, score promedio ~32 (dispara AGENTE_SCORE_CRITICO)
-- Con 4 abandonos (40%) - dispara AGENTE_ABANDONO_ALTO
-- -------------------------------------------------------------------------------

INSERT INTO registro_llamadas (registro_id, audio_url, audio_id_externo, timestamp_inicio, timestamp_fin, agente_id, cliente_ref, campana, estado) VALUES
('a0000001-0000-0000-0000-000000000004', 'https://drive.google.com/file/AT001', 'AT001', '2026-02-02 09:45:00-05', '2026-02-02 09:48:00-05', '44444444-4444-4444-4444-444444444444', 'CLI-301', 'CAMPANA_Q1', 'analizado'),
('a0000002-0000-0000-0000-000000000004', 'https://drive.google.com/file/AT002', 'AT002', '2026-02-02 11:00:00-05', '2026-02-02 11:03:00-05', '44444444-4444-4444-4444-444444444444', 'CLI-302', 'CAMPANA_Q1', 'analizado'),
('a0000003-0000-0000-0000-000000000004', 'https://drive.google.com/file/AT003', 'AT003', '2026-02-02 12:15:00-05', '2026-02-02 12:18:00-05', '44444444-4444-4444-4444-444444444444', 'CLI-303', 'CAMPANA_Q1', 'analizado'),
('a0000004-0000-0000-0000-000000000004', 'https://drive.google.com/file/AT004', 'AT004', '2026-02-02 14:30:00-05', '2026-02-02 14:33:00-05', '44444444-4444-4444-4444-444444444444', 'CLI-304', 'CAMPANA_Q1', 'analizado'),
('a0000005-0000-0000-0000-000000000004', 'https://drive.google.com/file/AT005', 'AT005', '2026-02-02 15:45:00-05', '2026-02-02 15:48:00-05', '44444444-4444-4444-4444-444444444444', 'CLI-305', 'CAMPANA_Q1', 'analizado'),
('a0000006-0000-0000-0000-000000000004', 'https://drive.google.com/file/AT006', 'AT006', '2026-02-03 09:30:00-05', '2026-02-03 09:33:00-05', '44444444-4444-4444-4444-444444444444', 'CLI-306', 'CAMPANA_Q1', 'analizado'),
('a0000007-0000-0000-0000-000000000004', 'https://drive.google.com/file/AT007', 'AT007', '2026-02-03 10:45:00-05', '2026-02-03 10:48:00-05', '44444444-4444-4444-4444-444444444444', 'CLI-307', 'CAMPANA_Q1', 'analizado'),
('a0000008-0000-0000-0000-000000000004', 'https://drive.google.com/file/AT008', 'AT008', '2026-02-03 12:00:00-05', '2026-02-03 12:03:00-05', '44444444-4444-4444-4444-444444444444', 'CLI-308', 'CAMPANA_Q1', 'analizado'),
('a0000009-0000-0000-0000-000000000004', 'https://drive.google.com/file/AT009', 'AT009', '2026-02-03 14:15:00-05', '2026-02-03 14:18:00-05', '44444444-4444-4444-4444-444444444444', 'CLI-309', 'CAMPANA_Q1', 'analizado'),
('a0000010-0000-0000-0000-000000000004', 'https://drive.google.com/file/AT010', 'AT010', '2026-02-03 15:30:00-05', '2026-02-03 15:33:00-05', '44444444-4444-4444-4444-444444444444', 'CLI-310', 'CAMPANA_Q1', 'analizado');

INSERT INTO transcripciones (transcripcion_id, registro_id, transcripcion_completa, segmentos, modelo_transcripcion) VALUES
('b0000001-0000-0000-0000-000000000004', 'a0000001-0000-0000-0000-000000000004', 'Transcripcion AT001...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000002-0000-0000-0000-000000000004', 'a0000002-0000-0000-0000-000000000004', 'Transcripcion AT002...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000003-0000-0000-0000-000000000004', 'a0000003-0000-0000-0000-000000000004', 'Transcripcion AT003...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000004-0000-0000-0000-000000000004', 'a0000004-0000-0000-0000-000000000004', 'Transcripcion AT004...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000005-0000-0000-0000-000000000004', 'a0000005-0000-0000-0000-000000000004', 'Transcripcion AT005...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000006-0000-0000-0000-000000000004', 'a0000006-0000-0000-0000-000000000004', 'Transcripcion AT006...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000007-0000-0000-0000-000000000004', 'a0000007-0000-0000-0000-000000000004', 'Transcripcion AT007...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000008-0000-0000-0000-000000000004', 'a0000008-0000-0000-0000-000000000004', 'Transcripcion AT008...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000009-0000-0000-0000-000000000004', 'a0000009-0000-0000-0000-000000000004', 'Transcripcion AT009...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000010-0000-0000-0000-000000000004', 'a0000010-0000-0000-0000-000000000004', 'Transcripcion AT010...', '[]'::JSONB, 'gemini-2.0-flash');

INSERT INTO analisis_llamadas (analisis_id, registro_id, transcripcion_id, agente_id, score_total, score_contacto_directo, score_compromiso_pago, modulo_contacto_directo, modulo_compromiso_pago, modulo_abandono, probabilidad_cumplimiento, nivel_cumplimiento, fecha_llamada, created_at) VALUES
('c0000001-0000-0000-0000-000000000004', 'a0000001-0000-0000-0000-000000000004', 'b0000001-0000-0000-0000-000000000004', '44444444-4444-4444-4444-444444444444', 35, 33, 37, '{"score": 33}'::JSONB, '{"score": 37, "desglose": {"validacion_cliente": {"tipo": "ninguna"}}}'::JSONB, '{"hubo_abandono": true}'::JSONB, 18, 'baja', '2026-02-02', '2026-02-02 09:55:00-05'),
('c0000002-0000-0000-0000-000000000004', 'a0000002-0000-0000-0000-000000000004', 'b0000002-0000-0000-0000-000000000004', '44444444-4444-4444-4444-444444444444', 28, 26, 30, '{"score": 26}'::JSONB, '{"score": 30, "desglose": {"validacion_cliente": {"tipo": "ninguna"}}}'::JSONB, '{"hubo_abandono": true}'::JSONB, 12, 'baja', '2026-02-02', '2026-02-02 11:10:00-05'),
('c0000003-0000-0000-0000-000000000004', 'a0000003-0000-0000-0000-000000000004', 'b0000003-0000-0000-0000-000000000004', '44444444-4444-4444-4444-444444444444', 38, 36, 40, '{"score": 36}'::JSONB, '{"score": 40, "desglose": {"validacion_cliente": {"tipo": "ninguna"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 22, 'baja', '2026-02-02', '2026-02-02 12:25:00-05'),
('c0000004-0000-0000-0000-000000000004', 'a0000004-0000-0000-0000-000000000004', 'b0000004-0000-0000-0000-000000000004', '44444444-4444-4444-4444-444444444444', 32, 30, 34, '{"score": 30}'::JSONB, '{"score": 34, "desglose": {"validacion_cliente": {"tipo": "ninguna"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 16, 'baja', '2026-02-02', '2026-02-02 14:40:00-05'),
('c0000005-0000-0000-0000-000000000004', 'a0000005-0000-0000-0000-000000000004', 'b0000005-0000-0000-0000-000000000004', '44444444-4444-4444-4444-444444444444', 25, 23, 27, '{"score": 23}'::JSONB, '{"score": 27, "desglose": {"validacion_cliente": {"tipo": "ninguna"}}}'::JSONB, '{"hubo_abandono": true}'::JSONB, 10, 'baja', '2026-02-02', '2026-02-02 15:55:00-05'),
('c0000006-0000-0000-0000-000000000004', 'a0000006-0000-0000-0000-000000000004', 'b0000006-0000-0000-0000-000000000004', '44444444-4444-4444-4444-444444444444', 36, 34, 38, '{"score": 34}'::JSONB, '{"score": 38, "desglose": {"validacion_cliente": {"tipo": "ninguna"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 20, 'baja', '2026-02-03', '2026-02-03 09:40:00-05'),
('c0000007-0000-0000-0000-000000000004', 'a0000007-0000-0000-0000-000000000004', 'b0000007-0000-0000-0000-000000000004', '44444444-4444-4444-4444-444444444444', 30, 28, 32, '{"score": 28}'::JSONB, '{"score": 32, "desglose": {"validacion_cliente": {"tipo": "ninguna"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 14, 'baja', '2026-02-03', '2026-02-03 10:55:00-05'),
('c0000008-0000-0000-0000-000000000004', 'a0000008-0000-0000-0000-000000000004', 'b0000008-0000-0000-0000-000000000004', '44444444-4444-4444-4444-444444444444', 34, 32, 36, '{"score": 32}'::JSONB, '{"score": 36, "desglose": {"validacion_cliente": {"tipo": "ninguna"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 18, 'baja', '2026-02-03', '2026-02-03 12:10:00-05'),
('c0000009-0000-0000-0000-000000000004', 'a0000009-0000-0000-0000-000000000004', 'b0000009-0000-0000-0000-000000000004', '44444444-4444-4444-4444-444444444444', 29, 27, 31, '{"score": 27}'::JSONB, '{"score": 31, "desglose": {"validacion_cliente": {"tipo": "ninguna"}}}'::JSONB, '{"hubo_abandono": true}'::JSONB, 13, 'baja', '2026-02-03', '2026-02-03 14:25:00-05'),
('c0000010-0000-0000-0000-000000000004', 'a0000010-0000-0000-0000-000000000004', 'b0000010-0000-0000-0000-000000000004', '44444444-4444-4444-4444-444444444444', 33, 31, 35, '{"score": 31}'::JSONB, '{"score": 35, "desglose": {"validacion_cliente": {"tipo": "ninguna"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 17, 'baja', '2026-02-03', '2026-02-03 15:40:00-05');

-- -------------------------------------------------------------------------------
-- LUIS GARCIA (Sin Validacion) - 10 llamadas, score ~60 pero SIN validaciones explicitas
-- Solo 1 validacion explicita de 10 (10%) - dispara AGENTE_SIN_VALIDACION
-- -------------------------------------------------------------------------------

INSERT INTO registro_llamadas (registro_id, audio_url, audio_id_externo, timestamp_inicio, timestamp_fin, agente_id, cliente_ref, campana, estado) VALUES
('a0000001-0000-0000-0000-000000000005', 'https://drive.google.com/file/LG001', 'LG001', '2026-02-02 08:30:00-05', '2026-02-02 08:35:00-05', '55555555-5555-5555-5555-555555555555', 'CLI-401', 'CAMPANA_Q1', 'analizado'),
('a0000002-0000-0000-0000-000000000005', 'https://drive.google.com/file/LG002', 'LG002', '2026-02-02 09:45:00-05', '2026-02-02 09:50:00-05', '55555555-5555-5555-5555-555555555555', 'CLI-402', 'CAMPANA_Q1', 'analizado'),
('a0000003-0000-0000-0000-000000000005', 'https://drive.google.com/file/LG003', 'LG003', '2026-02-02 11:00:00-05', '2026-02-02 11:05:00-05', '55555555-5555-5555-5555-555555555555', 'CLI-403', 'CAMPANA_Q1', 'analizado'),
('a0000004-0000-0000-0000-000000000005', 'https://drive.google.com/file/LG004', 'LG004', '2026-02-02 14:15:00-05', '2026-02-02 14:20:00-05', '55555555-5555-5555-5555-555555555555', 'CLI-404', 'CAMPANA_Q1', 'analizado'),
('a0000005-0000-0000-0000-000000000005', 'https://drive.google.com/file/LG005', 'LG005', '2026-02-02 15:30:00-05', '2026-02-02 15:35:00-05', '55555555-5555-5555-5555-555555555555', 'CLI-405', 'CAMPANA_Q1', 'analizado'),
('a0000006-0000-0000-0000-000000000005', 'https://drive.google.com/file/LG006', 'LG006', '2026-02-03 08:30:00-05', '2026-02-03 08:35:00-05', '55555555-5555-5555-5555-555555555555', 'CLI-406', 'CAMPANA_Q1', 'analizado'),
('a0000007-0000-0000-0000-000000000005', 'https://drive.google.com/file/LG007', 'LG007', '2026-02-03 09:45:00-05', '2026-02-03 09:50:00-05', '55555555-5555-5555-5555-555555555555', 'CLI-407', 'CAMPANA_Q1', 'analizado'),
('a0000008-0000-0000-0000-000000000005', 'https://drive.google.com/file/LG008', 'LG008', '2026-02-03 11:00:00-05', '2026-02-03 11:05:00-05', '55555555-5555-5555-5555-555555555555', 'CLI-408', 'CAMPANA_Q1', 'analizado'),
('a0000009-0000-0000-0000-000000000005', 'https://drive.google.com/file/LG009', 'LG009', '2026-02-03 14:15:00-05', '2026-02-03 14:20:00-05', '55555555-5555-5555-5555-555555555555', 'CLI-409', 'CAMPANA_Q1', 'analizado'),
('a0000010-0000-0000-0000-000000000005', 'https://drive.google.com/file/LG010', 'LG010', '2026-02-03 15:30:00-05', '2026-02-03 15:35:00-05', '55555555-5555-5555-5555-555555555555', 'CLI-410', 'CAMPANA_Q1', 'analizado');

INSERT INTO transcripciones (transcripcion_id, registro_id, transcripcion_completa, segmentos, modelo_transcripcion) VALUES
('b0000001-0000-0000-0000-000000000005', 'a0000001-0000-0000-0000-000000000005', 'Transcripcion LG001...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000002-0000-0000-0000-000000000005', 'a0000002-0000-0000-0000-000000000005', 'Transcripcion LG002...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000003-0000-0000-0000-000000000005', 'a0000003-0000-0000-0000-000000000005', 'Transcripcion LG003...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000004-0000-0000-0000-000000000005', 'a0000004-0000-0000-0000-000000000005', 'Transcripcion LG004...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000005-0000-0000-0000-000000000005', 'a0000005-0000-0000-0000-000000000005', 'Transcripcion LG005...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000006-0000-0000-0000-000000000005', 'a0000006-0000-0000-0000-000000000005', 'Transcripcion LG006...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000007-0000-0000-0000-000000000005', 'a0000007-0000-0000-0000-000000000005', 'Transcripcion LG007...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000008-0000-0000-0000-000000000005', 'a0000008-0000-0000-0000-000000000005', 'Transcripcion LG008...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000009-0000-0000-0000-000000000005', 'a0000009-0000-0000-0000-000000000005', 'Transcripcion LG009...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000010-0000-0000-0000-000000000005', 'a0000010-0000-0000-0000-000000000005', 'Transcripcion LG010...', '[]'::JSONB, 'gemini-2.0-flash');

INSERT INTO analisis_llamadas (analisis_id, registro_id, transcripcion_id, agente_id, score_total, score_contacto_directo, score_compromiso_pago, modulo_contacto_directo, modulo_compromiso_pago, modulo_abandono, probabilidad_cumplimiento, nivel_cumplimiento, fecha_llamada, created_at) VALUES
('c0000001-0000-0000-0000-000000000005', 'a0000001-0000-0000-0000-000000000005', 'b0000001-0000-0000-0000-000000000005', '55555555-5555-5555-5555-555555555555', 62, 60, 64, '{"score": 60}'::JSONB, '{"score": 64, "desglose": {"validacion_cliente": {"tipo": "ninguna"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 35, 'baja', '2026-02-02', '2026-02-02 08:40:00-05'),
('c0000002-0000-0000-0000-000000000005', 'a0000002-0000-0000-0000-000000000005', 'b0000002-0000-0000-0000-000000000005', '55555555-5555-5555-5555-555555555555', 58, 56, 60, '{"score": 56}'::JSONB, '{"score": 60, "desglose": {"validacion_cliente": {"tipo": "implicita"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 32, 'baja', '2026-02-02', '2026-02-02 09:55:00-05'),
('c0000003-0000-0000-0000-000000000005', 'a0000003-0000-0000-0000-000000000005', 'b0000003-0000-0000-0000-000000000005', '55555555-5555-5555-5555-555555555555', 65, 63, 67, '{"score": 63}'::JSONB, '{"score": 67, "desglose": {"validacion_cliente": {"tipo": "ninguna"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 40, 'media', '2026-02-02', '2026-02-02 11:10:00-05'),
('c0000004-0000-0000-0000-000000000005', 'a0000004-0000-0000-0000-000000000005', 'b0000004-0000-0000-0000-000000000005', '55555555-5555-5555-5555-555555555555', 60, 58, 62, '{"score": 58}'::JSONB, '{"score": 62, "desglose": {"validacion_cliente": {"tipo": "implicita"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 36, 'baja', '2026-02-02', '2026-02-02 14:25:00-05'),
('c0000005-0000-0000-0000-000000000005', 'a0000005-0000-0000-0000-000000000005', 'b0000005-0000-0000-0000-000000000005', '55555555-5555-5555-5555-555555555555', 55, 53, 57, '{"score": 53}'::JSONB, '{"score": 57, "desglose": {"validacion_cliente": {"tipo": "ninguna"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 30, 'baja', '2026-02-02', '2026-02-02 15:40:00-05'),
('c0000006-0000-0000-0000-000000000005', 'a0000006-0000-0000-0000-000000000005', 'b0000006-0000-0000-0000-000000000005', '55555555-5555-5555-5555-555555555555', 63, 61, 65, '{"score": 61}'::JSONB, '{"score": 65, "desglose": {"validacion_cliente": {"tipo": "explicita"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 42, 'media', '2026-02-03', '2026-02-03 08:40:00-05'),
('c0000007-0000-0000-0000-000000000005', 'a0000007-0000-0000-0000-000000000005', 'b0000007-0000-0000-0000-000000000005', '55555555-5555-5555-5555-555555555555', 59, 57, 61, '{"score": 57}'::JSONB, '{"score": 61, "desglose": {"validacion_cliente": {"tipo": "ninguna"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 34, 'baja', '2026-02-03', '2026-02-03 09:55:00-05'),
('c0000008-0000-0000-0000-000000000005', 'a0000008-0000-0000-0000-000000000005', 'b0000008-0000-0000-0000-000000000005', '55555555-5555-5555-5555-555555555555', 61, 59, 63, '{"score": 59}'::JSONB, '{"score": 63, "desglose": {"validacion_cliente": {"tipo": "implicita"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 38, 'baja', '2026-02-03', '2026-02-03 11:10:00-05'),
('c0000009-0000-0000-0000-000000000005', 'a0000009-0000-0000-0000-000000000005', 'b0000009-0000-0000-0000-000000000005', '55555555-5555-5555-5555-555555555555', 57, 55, 59, '{"score": 55}'::JSONB, '{"score": 59, "desglose": {"validacion_cliente": {"tipo": "ninguna"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 33, 'baja', '2026-02-03', '2026-02-03 14:25:00-05'),
('c0000010-0000-0000-0000-000000000005', 'a0000010-0000-0000-0000-000000000005', 'b0000010-0000-0000-0000-000000000005', '55555555-5555-5555-5555-555555555555', 64, 62, 66, '{"score": 62}'::JSONB, '{"score": 66, "desglose": {"validacion_cliente": {"tipo": "ninguna"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 41, 'media', '2026-02-03', '2026-02-03 15:40:00-05');

-- -------------------------------------------------------------------------------
-- SOFIA VARGAS (Nueva) - Solo 2 llamadas (no suficientes para alertas)
-- -------------------------------------------------------------------------------

INSERT INTO registro_llamadas (registro_id, audio_url, audio_id_externo, timestamp_inicio, timestamp_fin, agente_id, cliente_ref, campana, estado) VALUES
('a0000001-0000-0000-0000-000000000006', 'https://drive.google.com/file/SV001', 'SV001', '2026-02-03 10:00:00-05', '2026-02-03 10:05:00-05', '66666666-6666-6666-6666-666666666666', 'CLI-501', 'CAMPANA_Q1', 'analizado'),
('a0000002-0000-0000-0000-000000000006', 'https://drive.google.com/file/SV002', 'SV002', '2026-02-03 14:30:00-05', '2026-02-03 14:35:00-05', '66666666-6666-6666-6666-666666666666', 'CLI-502', 'CAMPANA_Q1', 'analizado');

INSERT INTO transcripciones (transcripcion_id, registro_id, transcripcion_completa, segmentos, modelo_transcripcion) VALUES
('b0000001-0000-0000-0000-000000000006', 'a0000001-0000-0000-0000-000000000006', 'Transcripcion SV001...', '[]'::JSONB, 'gemini-2.0-flash'),
('b0000002-0000-0000-0000-000000000006', 'a0000002-0000-0000-0000-000000000006', 'Transcripcion SV002...', '[]'::JSONB, 'gemini-2.0-flash');

INSERT INTO analisis_llamadas (analisis_id, registro_id, transcripcion_id, agente_id, score_total, score_contacto_directo, score_compromiso_pago, modulo_contacto_directo, modulo_compromiso_pago, modulo_abandono, probabilidad_cumplimiento, nivel_cumplimiento, fecha_llamada, created_at) VALUES
('c0000001-0000-0000-0000-000000000006', 'a0000001-0000-0000-0000-000000000006', 'b0000001-0000-0000-0000-000000000006', '66666666-6666-6666-6666-666666666666', 70, 68, 72, '{"score": 68}'::JSONB, '{"score": 72, "desglose": {"validacion_cliente": {"tipo": "explicita"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 55, 'media', '2026-02-03', '2026-02-03 10:10:00-05'),
('c0000002-0000-0000-0000-000000000006', 'a0000002-0000-0000-0000-000000000006', 'b0000002-0000-0000-0000-000000000006', '66666666-6666-6666-6666-666666666666', 68, 66, 70, '{"score": 66}'::JSONB, '{"score": 70, "desglose": {"validacion_cliente": {"tipo": "explicita"}}}'::JSONB, '{"hubo_abandono": false}'::JSONB, 52, 'media', '2026-02-03', '2026-02-03 14:40:00-05');

-- ============================================================================
-- RESUMEN DE DATOS CREADOS
-- ============================================================================
-- 
-- AGENTES (6):
-- 1. Maria Lopez    - Estrella (score ~82, 100% validacion)
-- 2. Carlos Mendez  - Promedio (score ~65, 40% validacion, 1 abandono)
-- 3. Pedro Ruiz     - En Riesgo (score ~48, 0% validacion, 3 abandonos)  -> AGENTE_SCORE_BAJO
-- 4. Ana Torres     - Critico (score ~32, 0% validacion, 4 abandonos)    -> AGENTE_SCORE_CRITICO + AGENTE_ABANDONO_ALTO
-- 5. Luis Garcia    - Sin Valid (score ~60, 10% validacion)              -> AGENTE_SIN_VALIDACION
-- 6. Sofia Vargas   - Nueva (solo 2 llamadas, no genera alertas)
--
-- TOTAL LLAMADAS: 54 (ultimas 48 horas)
-- ALERTAS ESPERADAS:
--   - AGENTE_SCORE_CRITICO: Ana Torres (score 32)
--   - AGENTE_SCORE_BAJO: Pedro Ruiz (score 48)
--   - AGENTE_ABANDONO_ALTO: Ana Torres (40%)
--   - AGENTE_SIN_VALIDACION: Luis Garcia (10%), Pedro Ruiz (0%), Ana Torres (0%)
--
-- ============================================================================
</file>

<file path="supabase/seeds/seed_modulos_test.sql">
-- ============================================
-- NODUS - Datos de Prueba para Modulos Dashboard
-- Fecha actual: 4 de febrero de 2026
-- ============================================

-- Limpiar datos anteriores (si existen)
DELETE FROM analisis_llamadas WHERE fecha_llamada >= '2026-01-20';
DELETE FROM transcripciones WHERE created_at >= '2026-01-20';
DELETE FROM registro_llamadas WHERE timestamp_inicio >= '2026-01-20';

-- ============================================
-- Insertar agentes de prueba (si no existen)
-- ============================================

INSERT INTO agentes (agente_id, nombre, email, estado, equipo, fecha_ingreso) VALUES
('a0000001-0000-0000-0000-000000000001', 'Carlos Ramirez', 'carlos.ramirez@empresa.com', 'activo', 'Equipo Norte', '2024-01-15'),
('a0000001-0000-0000-0000-000000000002', 'Maria Gonzalez', 'maria.gonzalez@empresa.com', 'activo', 'Equipo Sur', '2024-03-20'),
('a0000001-0000-0000-0000-000000000003', 'Luis Torres', 'luis.torres@empresa.com', 'activo', 'Equipo Norte', '2024-06-10'),
('a0000001-0000-0000-0000-000000000004', 'Ana Martinez', 'ana.martinez@empresa.com', 'activo', 'Equipo Centro', '2024-08-05'),
('a0000001-0000-0000-0000-000000000005', 'Jose Perez', 'jose.perez@empresa.com', 'activo', 'Equipo Sur', '2024-09-12')
ON CONFLICT (agente_id) DO NOTHING;

-- ============================================
-- Funcion auxiliar para generar datos
-- ============================================

-- Insertar registros de llamadas y analisis para los ultimos 14 dias
-- Cada agente tendra entre 8-15 llamadas

DO $$
DECLARE
    v_agente RECORD;
    v_registro_id UUID;
    v_transcripcion_id UUID;
    v_fecha DATE;
    v_hora TIME;
    v_duracion INTEGER;
    v_score_contacto INTEGER;
    v_score_compromiso INTEGER;
    v_score_total INTEGER;
    v_prob_cumplimiento INTEGER;
    v_tiene_oferta BOOLEAN;
    v_tiene_alternativas BOOLEAN;
    v_tiene_fecha BOOLEAN;
    v_tiene_validacion BOOLEAN;
    v_hubo_abandono BOOLEAN;
    v_momento_abandono INTEGER;
    v_razon_abandono TEXT;
    v_i INTEGER;
    v_num_llamadas INTEGER;
BEGIN
    -- Para cada agente
    FOR v_agente IN SELECT agente_id, nombre FROM agentes WHERE estado = 'activo' LOOP
        
        -- Numero aleatorio de llamadas (8-15)
        v_num_llamadas := 8 + floor(random() * 8)::integer;
        
        -- Para cada llamada
        FOR v_i IN 1..v_num_llamadas LOOP
            -- Fecha aleatoria en los ultimos 14 dias
            v_fecha := CURRENT_DATE - (floor(random() * 14)::integer || ' days')::interval;
            v_hora := (8 + floor(random() * 10))::integer || ':' || (floor(random() * 60))::integer || ':00';
            v_duracion := 120 + floor(random() * 300)::integer;
            
            -- Generar scores basados en el agente (algunos mejores que otros)
            CASE 
                WHEN v_agente.nombre = 'Carlos Ramirez' THEN
                    v_score_contacto := 75 + floor(random() * 15)::integer;
                    v_score_compromiso := 80 + floor(random() * 15)::integer;
                WHEN v_agente.nombre = 'Maria Gonzalez' THEN
                    v_score_contacto := 70 + floor(random() * 15)::integer;
                    v_score_compromiso := 72 + floor(random() * 15)::integer;
                WHEN v_agente.nombre = 'Luis Torres' THEN
                    v_score_contacto := 65 + floor(random() * 15)::integer;
                    v_score_compromiso := 68 + floor(random() * 15)::integer;
                WHEN v_agente.nombre = 'Ana Martinez' THEN
                    v_score_contacto := 58 + floor(random() * 15)::integer;
                    v_score_compromiso := 60 + floor(random() * 15)::integer;
                ELSE
                    v_score_contacto := 50 + floor(random() * 15)::integer;
                    v_score_compromiso := 55 + floor(random() * 15)::integer;
            END CASE;
            
            v_score_total := (v_score_contacto + v_score_compromiso) / 2;
            
            -- Elementos de compromiso (probabilistico basado en score)
            v_tiene_oferta := random() < (v_score_compromiso::numeric / 100);
            v_tiene_alternativas := random() < ((v_score_compromiso - 10)::numeric / 100);
            v_tiene_fecha := random() < ((v_score_compromiso - 20)::numeric / 100);
            v_tiene_validacion := random() < ((v_score_compromiso - 40)::numeric / 100);
            
            -- Probabilidad de cumplimiento basada en elementos
            v_prob_cumplimiento := 5;
            IF v_tiene_oferta THEN v_prob_cumplimiento := v_prob_cumplimiento + 15; END IF;
            IF v_tiene_alternativas THEN v_prob_cumplimiento := v_prob_cumplimiento + 10; END IF;
            IF v_tiene_fecha THEN v_prob_cumplimiento := v_prob_cumplimiento + 15; END IF;
            IF v_tiene_validacion THEN v_prob_cumplimiento := v_prob_cumplimiento + 40; END IF;
            v_prob_cumplimiento := v_prob_cumplimiento + floor(random() * 15)::integer;
            IF v_prob_cumplimiento > 100 THEN v_prob_cumplimiento := 100; END IF;
            
            -- Abandono (mas probable si score bajo)
            v_hubo_abandono := random() < (1 - v_score_total::numeric / 100) * 0.5;
            IF v_hubo_abandono THEN
                v_momento_abandono := 15 + floor(random() * 120)::integer;
                v_razon_abandono := CASE floor(random() * 4)::integer
                    WHEN 0 THEN 'Cliente no interesado'
                    WHEN 1 THEN 'Monto muy alto'
                    WHEN 2 THEN 'Sin opciones de pago'
                    ELSE 'Objeciones no resueltas'
                END;
            ELSE
                v_momento_abandono := NULL;
                v_razon_abandono := NULL;
            END IF;
            
            -- Insertar registro de llamada
            v_registro_id := uuid_generate_v4();
            INSERT INTO registro_llamadas (
                registro_id, audio_url, audio_id_externo,
                timestamp_inicio, timestamp_fin, duracion_segundos, timestamp_fecha,
                agente_id, cliente_ref, campana, estado
            ) VALUES (
                v_registro_id,
                'https://storage.example.com/audio/' || v_registro_id || '.mp3',
                'audio_' || floor(random() * 100000)::integer,
                (v_fecha || ' ' || v_hora)::timestamptz,
                (v_fecha || ' ' || v_hora)::timestamptz + (v_duracion || ' seconds')::interval,
                v_duracion,
                v_fecha,
                v_agente.agente_id,
                'CLI-' || floor(random() * 100000)::integer,
                CASE floor(random() * 3)::integer WHEN 0 THEN 'Cobranza Temprana' WHEN 1 THEN 'Cobranza Media' ELSE 'Cobranza Dificil' END,
                'analizado'
            );
            
            -- Insertar transcripcion
            v_transcripcion_id := uuid_generate_v4();
            INSERT INTO transcripciones (
                transcripcion_id, registro_id, transcripcion_completa, segmentos,
                modelo_transcripcion, modelo_emociones, modelo_entidades
            ) VALUES (
                v_transcripcion_id,
                v_registro_id,
                'Transcripcion de llamada de cobranza...',
                '[]'::jsonb,
                'gemini-2.0-flash',
                'gemini-2.0-flash',
                'claude-sonnet-4'
            );
            
            -- Actualizar registro con transcripcion_id
            UPDATE registro_llamadas SET transcripcion_id = v_transcripcion_id WHERE registro_id = v_registro_id;
            
            -- Insertar analisis
            INSERT INTO analisis_llamadas (
                registro_id, transcripcion_id, agente_id,
                score_total, score_contacto_directo, score_compromiso_pago,
                modulo_contacto_directo,
                modulo_compromiso_pago,
                modulo_abandono,
                probabilidad_cumplimiento, nivel_cumplimiento,
                factores_prediccion, alertas, recomendaciones,
                modelo_usado, version_prompt, confianza_analisis,
                fecha_llamada
            ) VALUES (
                v_registro_id, v_transcripcion_id, v_agente.agente_id,
                v_score_total, v_score_contacto, v_score_compromiso,
                jsonb_build_object(
                    'score', v_score_contacto,
                    'desglose', jsonb_build_object(
                        'monto_mencionado', jsonb_build_object('presente', random() < 0.75, 'puntos', floor(random() * 25)::integer, 'max', 25, 'evidencia', ''),
                        'fecha_vencimiento', jsonb_build_object('presente', random() < 0.70, 'puntos', floor(random() * 15)::integer, 'max', 15, 'evidencia', ''),
                        'consecuencias_impago', jsonb_build_object('presente', random() < 0.60, 'puntos', floor(random() * 20)::integer, 'max', 20, 'evidencia', ''),
                        'alternativas_pago', jsonb_build_object('presente', random() < 0.65, 'puntos', floor(random() * 15)::integer, 'max', 15, 'evidencia', ''),
                        'manejo_objeciones', jsonb_build_object('calidad', floor(random() * 5)::integer, 'puntos', floor(random() * 25)::integer, 'max', 25, 'objeciones_detectadas', floor(random() * 3)::integer)
                    )
                ),
                jsonb_build_object(
                    'score', v_score_compromiso,
                    'desglose', jsonb_build_object(
                        'oferta_clara', jsonb_build_object('presente', v_tiene_oferta, 'puntos', CASE WHEN v_tiene_oferta THEN 15 + floor(random() * 5)::integer ELSE floor(random() * 10)::integer END, 'max', 20),
                        'alternativas_pago', jsonb_build_object('presente', v_tiene_alternativas, 'puntos', CASE WHEN v_tiene_alternativas THEN 7 + floor(random() * 3)::integer ELSE floor(random() * 5)::integer END, 'max', 10),
                        'fecha_especifica', jsonb_build_object('presente', v_tiene_fecha, 'puntos', CASE WHEN v_tiene_fecha THEN 15 + floor(random() * 5)::integer ELSE floor(random() * 10)::integer END, 'max', 20, 'fecha', CASE WHEN v_tiene_fecha THEN (CURRENT_DATE + (floor(random() * 30)::integer || ' days')::interval)::text ELSE NULL END),
                        'validacion_cliente', jsonb_build_object('presente', v_tiene_validacion, 'tipo', CASE WHEN v_tiene_validacion THEN 'explicita' ELSE 'ninguna' END, 'puntos', CASE WHEN v_tiene_validacion THEN 40 + floor(random() * 10)::integer ELSE floor(random() * 20)::integer END, 'max', 50, 'frase_exacta', CASE WHEN v_tiene_validacion THEN 'Si, confirmo el pago' ELSE '' END)
                    )
                ),
                jsonb_build_object(
                    'hubo_abandono', v_hubo_abandono,
                    'momento_segundos', v_momento_abandono,
                    'iniciado_por', CASE WHEN v_hubo_abandono THEN 'cliente' ELSE NULL END,
                    'razon', v_razon_abandono,
                    'senales_previas', '[]'::jsonb
                ),
                v_prob_cumplimiento,
                CASE 
                    WHEN v_prob_cumplimiento >= 70 THEN 'alta'
                    WHEN v_prob_cumplimiento >= 40 THEN 'media'
                    ELSE 'baja'
                END::nivel_cumplimiento,
                jsonb_build_object(
                    'factores_positivos', '[]'::jsonb,
                    'factores_negativos', '[]'::jsonb,
                    'razonamiento', 'Analisis automatico',
                    'historial_cliente_considerado', false
                ),
                '[]'::jsonb,
                '[]'::jsonb,
                'claude-opus-4',
                'v1.0',
                0.85 + (random() * 0.15),
                v_fecha
            );
            
            -- Actualizar registro con analisis_id
            UPDATE registro_llamadas rl 
            SET analisis_id = al.analisis_id 
            FROM analisis_llamadas al 
            WHERE rl.registro_id = al.registro_id AND rl.registro_id = v_registro_id;
            
        END LOOP;
    END LOOP;
END $$;

-- ============================================
-- Verificar datos insertados
-- ============================================

SELECT 'Registros de llamadas insertados:' as info, COUNT(*) as total FROM registro_llamadas WHERE timestamp_fecha >= '2026-01-20';
SELECT 'Analisis insertados:' as info, COUNT(*) as total FROM analisis_llamadas WHERE fecha_llamada >= '2026-01-20';
SELECT 'Por agente:' as info;
SELECT ag.nombre, COUNT(*) as llamadas, ROUND(AVG(al.score_total), 1) as score_promedio
FROM analisis_llamadas al
JOIN agentes ag ON al.agente_id = ag.agente_id
WHERE al.fecha_llamada >= '2026-01-20'
GROUP BY ag.nombre
ORDER BY score_promedio DESC;

-- ============================================
-- Probar vistas
-- ============================================

SELECT 'Vista vista_kpis_principales:' as vista;
SELECT * FROM vista_kpis_principales LIMIT 5;

SELECT 'Vista vista_compromiso_elementos:' as vista;
SELECT * FROM vista_compromiso_elementos;

SELECT 'Vista vista_agente_modulos:' as vista;
SELECT agente_nombre, score_contacto, score_compromiso, tasa_abandono, score_total FROM vista_agente_modulos;
</file>

<file path="supabase/views/modulos_dashboard.sql">
-- ============================================
-- NODUS - Vistas para Dashboard de Modulos
-- Tres Pilares: Contacto Directo, Compromiso, Abandono
-- ============================================

-- ============================================
-- Vista 1: Resumen Global de Modulos por Dia
-- Uso: Pagina Vision General, graficos de tendencia
-- ============================================

CREATE OR REPLACE VIEW vista_modulos_global AS
SELECT
    DATE_TRUNC('day', fecha_llamada)::date as fecha,
    COUNT(*) as total_llamadas,
    
    -- MODULO 1: CONTACTO DIRECTO
    ROUND(AVG(score_contacto_directo), 1) as avg_contacto_directo,
    ROUND(AVG((modulo_contacto_directo->'desglose'->'monto_mencionado'->>'puntos')::numeric), 1) as avg_puntos_monto,
    ROUND(AVG((modulo_contacto_directo->'desglose'->'fecha_vencimiento'->>'puntos')::numeric), 1) as avg_puntos_fecha,
    ROUND(AVG((modulo_contacto_directo->'desglose'->'consecuencias_impago'->>'puntos')::numeric), 1) as avg_puntos_consecuencias,
    ROUND(AVG((modulo_contacto_directo->'desglose'->'alternativas_pago'->>'puntos')::numeric), 1) as avg_puntos_alternativas,
    ROUND(AVG((modulo_contacto_directo->'desglose'->'manejo_objeciones'->>'puntos')::numeric), 1) as avg_puntos_objeciones,
    
    ROUND(100.0 * COUNT(*) FILTER (WHERE (modulo_contacto_directo->'desglose'->'monto_mencionado'->>'presente')::boolean) / NULLIF(COUNT(*), 0), 1) as pct_menciona_monto,
    ROUND(100.0 * COUNT(*) FILTER (WHERE (modulo_contacto_directo->'desglose'->'fecha_vencimiento'->>'presente')::boolean) / NULLIF(COUNT(*), 0), 1) as pct_menciona_fecha,
    ROUND(100.0 * COUNT(*) FILTER (WHERE (modulo_contacto_directo->'desglose'->'consecuencias_impago'->>'presente')::boolean) / NULLIF(COUNT(*), 0), 1) as pct_menciona_consecuencias,
    
    -- MODULO 2: COMPROMISO DE PAGO
    ROUND(AVG(score_compromiso_pago), 1) as avg_compromiso_pago,
    ROUND(AVG((modulo_compromiso_pago->'desglose'->'oferta_clara'->>'puntos')::numeric), 1) as avg_puntos_oferta,
    ROUND(AVG((modulo_compromiso_pago->'desglose'->'alternativas_pago'->>'puntos')::numeric), 1) as avg_puntos_alt_pago,
    ROUND(AVG((modulo_compromiso_pago->'desglose'->'fecha_especifica'->>'puntos')::numeric), 1) as avg_puntos_fecha_esp,
    ROUND(AVG((modulo_compromiso_pago->'desglose'->'validacion_cliente'->>'puntos')::numeric), 1) as avg_puntos_validacion,
    
    ROUND(100.0 * COUNT(*) FILTER (WHERE (modulo_compromiso_pago->'desglose'->'oferta_clara'->>'presente')::boolean) / NULLIF(COUNT(*), 0), 1) as pct_oferta_clara,
    ROUND(100.0 * COUNT(*) FILTER (WHERE (modulo_compromiso_pago->'desglose'->'alternativas_pago'->>'presente')::boolean) / NULLIF(COUNT(*), 0), 1) as pct_alternativas_pago,
    ROUND(100.0 * COUNT(*) FILTER (WHERE (modulo_compromiso_pago->'desglose'->'fecha_especifica'->>'presente')::boolean) / NULLIF(COUNT(*), 0), 1) as pct_fecha_especifica,
    ROUND(100.0 * COUNT(*) FILTER (WHERE (modulo_compromiso_pago->'desglose'->'validacion_cliente'->>'presente')::boolean) / NULLIF(COUNT(*), 0), 1) as pct_validacion_cliente,
    
    -- MODULO 3: ABANDONO
    COUNT(*) FILTER (WHERE (modulo_abandono->>'hubo_abandono')::boolean) as llamadas_con_abandono,
    ROUND(100.0 * COUNT(*) FILTER (WHERE (modulo_abandono->>'hubo_abandono')::boolean) / NULLIF(COUNT(*), 0), 1) as tasa_abandono,
    
    -- RESULTADOS
    ROUND(AVG(score_total), 1) as avg_score_total,
    ROUND(AVG(probabilidad_cumplimiento), 1) as avg_probabilidad

FROM analisis_llamadas
WHERE fecha_llamada >= CURRENT_DATE - INTERVAL '30 days'
GROUP BY DATE_TRUNC('day', fecha_llamada)::date
ORDER BY fecha DESC;

COMMENT ON VIEW vista_modulos_global IS 'Resumen diario de los 3 modulos - ultimos 30 dias';

-- ============================================
-- Vista 2: Impacto por Elementos de Compromiso
-- Uso: Grafico de barras "Sin elementos" hasta "Acuerdo completo"
-- ============================================

CREATE OR REPLACE VIEW vista_compromiso_elementos AS
WITH elementos AS (
    SELECT
        analisis_id,
        fecha_llamada,
        probabilidad_cumplimiento,
        score_compromiso_pago,
        (modulo_compromiso_pago->'desglose'->'oferta_clara'->>'presente')::boolean as tiene_oferta,
        (modulo_compromiso_pago->'desglose'->'alternativas_pago'->>'presente')::boolean as tiene_alternativas,
        (modulo_compromiso_pago->'desglose'->'fecha_especifica'->>'presente')::boolean as tiene_fecha,
        (modulo_compromiso_pago->'desglose'->'validacion_cliente'->>'presente')::boolean as tiene_validacion,
        CASE WHEN (modulo_compromiso_pago->'desglose'->'oferta_clara'->>'presente')::boolean THEN 1 ELSE 0 END +
        CASE WHEN (modulo_compromiso_pago->'desglose'->'alternativas_pago'->>'presente')::boolean THEN 1 ELSE 0 END +
        CASE WHEN (modulo_compromiso_pago->'desglose'->'fecha_especifica'->>'presente')::boolean THEN 1 ELSE 0 END +
        CASE WHEN (modulo_compromiso_pago->'desglose'->'validacion_cliente'->>'presente')::boolean THEN 1 ELSE 0 END as num_elementos
    FROM analisis_llamadas
    WHERE fecha_llamada >= CURRENT_DATE - INTERVAL '30 days'
),
clasificacion AS (
    SELECT
        *,
        CASE num_elementos
            WHEN 0 THEN 'Sin elementos'
            WHEN 1 THEN 'Solo oferta'
            WHEN 2 THEN 'Oferta + alternativas'
            WHEN 3 THEN 'Tres elementos'
            WHEN 4 THEN 'Acuerdo completo'
            ELSE 'Parcial'
        END as categoria,
        num_elementos as orden
    FROM elementos
)
SELECT
    categoria,
    orden,
    COUNT(*) as total_llamadas,
    ROUND(AVG(probabilidad_cumplimiento), 1) as prob_promedio,
    ROUND(AVG(score_compromiso_pago), 1) as score_promedio,
    ROUND(100.0 * COUNT(*) / NULLIF(SUM(COUNT(*)) OVER (), 0), 1) as porcentaje_del_total
FROM clasificacion
GROUP BY categoria, orden
ORDER BY orden;

COMMENT ON VIEW vista_compromiso_elementos IS 'Distribucion de llamadas por cantidad de elementos de compromiso';

-- ============================================
-- Vista 3: Detalle de Abandonos
-- Uso: Donut charts y analisis de patrones
-- ============================================

CREATE OR REPLACE VIEW vista_abandonos_detalle AS
SELECT
    CASE 
        WHEN (modulo_abandono->>'momento_segundos')::int IS NULL THEN 'No registrado'
        WHEN (modulo_abandono->>'momento_segundos')::int <= 30 THEN '0-30 seg'
        WHEN (modulo_abandono->>'momento_segundos')::int <= 60 THEN '31-60 seg'
        WHEN (modulo_abandono->>'momento_segundos')::int <= 120 THEN '1-2 min'
        ELSE '> 2 min'
    END as momento_rango,
    COALESCE(modulo_abandono->>'razon', 'No especificada') as razon,
    COALESCE(modulo_abandono->>'iniciado_por', 'Desconocido') as iniciado_por,
    COUNT(*) as total,
    ROUND(100.0 * COUNT(*) / NULLIF(SUM(COUNT(*)) OVER (), 0), 1) as porcentaje
FROM analisis_llamadas
WHERE 
    fecha_llamada >= CURRENT_DATE - INTERVAL '30 days'
    AND (modulo_abandono->>'hubo_abandono')::boolean = true
GROUP BY 
    momento_rango,
    modulo_abandono->>'razon',
    modulo_abandono->>'iniciado_por'
ORDER BY total DESC;

COMMENT ON VIEW vista_abandonos_detalle IS 'Analisis detallado de abandonos por momento y razon';

-- ============================================
-- Vista 4: Resumen de Abandono por Momento
-- Uso: 3 KPIs principales de abandono
-- ============================================

CREATE OR REPLACE VIEW vista_abandono_kpis AS
WITH totales AS (
    SELECT 
        COUNT(*) as total_llamadas,
        COUNT(*) FILTER (WHERE (modulo_abandono->>'hubo_abandono')::boolean) as total_abandonos
    FROM analisis_llamadas
    WHERE fecha_llamada >= CURRENT_DATE - INTERVAL '30 days'
),
abandonos AS (
    SELECT
        modulo_abandono->>'momento_segundos' as momento,
        modulo_abandono->>'razon' as razon
    FROM analisis_llamadas
    WHERE 
        fecha_llamada >= CURRENT_DATE - INTERVAL '30 days'
        AND (modulo_abandono->>'hubo_abandono')::boolean = true
)
SELECT
    'primeros_30_seg' as kpi,
    COUNT(*) FILTER (WHERE momento::int <= 30) as valor,
    ROUND(100.0 * COUNT(*) FILTER (WHERE momento::int <= 30) / NULLIF((SELECT total_abandonos FROM totales), 0), 1) as porcentaje_abandonos,
    ROUND(100.0 * COUNT(*) FILTER (WHERE momento::int <= 30) / NULLIF((SELECT total_llamadas FROM totales), 0), 1) as porcentaje_total
FROM abandonos
UNION ALL
SELECT
    'al_mencionar_monto' as kpi,
    COUNT(*) FILTER (WHERE razon ILIKE '%monto%') as valor,
    ROUND(100.0 * COUNT(*) FILTER (WHERE razon ILIKE '%monto%') / NULLIF((SELECT total_abandonos FROM totales), 0), 1) as porcentaje_abandonos,
    ROUND(100.0 * COUNT(*) FILTER (WHERE razon ILIKE '%monto%') / NULLIF((SELECT total_llamadas FROM totales), 0), 1) as porcentaje_total
FROM abandonos
UNION ALL
SELECT
    'durante_objeciones' as kpi,
    COUNT(*) FILTER (WHERE razon ILIKE '%objecion%' OR razon ILIKE '%rechazo%') as valor,
    ROUND(100.0 * COUNT(*) FILTER (WHERE razon ILIKE '%objecion%' OR razon ILIKE '%rechazo%') / NULLIF((SELECT total_abandonos FROM totales), 0), 1) as porcentaje_abandonos,
    ROUND(100.0 * COUNT(*) FILTER (WHERE razon ILIKE '%objecion%' OR razon ILIKE '%rechazo%') / NULLIF((SELECT total_llamadas FROM totales), 0), 1) as porcentaje_total
FROM abandonos;

COMMENT ON VIEW vista_abandono_kpis IS 'KPIs principales de abandono para donut charts';

-- ============================================
-- Vista 5: Metricas por Agente (3 Modulos)
-- Uso: Tablas comparativas y rankings
-- ============================================

CREATE OR REPLACE VIEW vista_agente_modulos AS
SELECT
    a.agente_id,
    ag.nombre as agente_nombre,
    ag.equipo,
    ag.estado,
    COUNT(*) as total_llamadas,
    
    -- Modulo 1: Contacto Directo
    ROUND(AVG(a.score_contacto_directo), 1) as score_contacto,
    ROUND(100.0 * COUNT(*) FILTER (WHERE (a.modulo_contacto_directo->'desglose'->'monto_mencionado'->>'presente')::boolean) / NULLIF(COUNT(*), 0), 1) as pct_monto,
    ROUND(100.0 * COUNT(*) FILTER (WHERE (a.modulo_contacto_directo->'desglose'->'fecha_vencimiento'->>'presente')::boolean) / NULLIF(COUNT(*), 0), 1) as pct_fecha,
    ROUND(100.0 * COUNT(*) FILTER (WHERE (a.modulo_contacto_directo->'desglose'->'manejo_objeciones'->>'calidad')::int >= 3) / NULLIF(COUNT(*), 0), 1) as pct_buen_manejo,
    
    -- Modulo 2: Compromiso de Pago
    ROUND(AVG(a.score_compromiso_pago), 1) as score_compromiso,
    ROUND(100.0 * COUNT(*) FILTER (WHERE (a.modulo_compromiso_pago->'desglose'->'oferta_clara'->>'presente')::boolean) / NULLIF(COUNT(*), 0), 1) as pct_oferta,
    ROUND(100.0 * COUNT(*) FILTER (WHERE (a.modulo_compromiso_pago->'desglose'->'validacion_cliente'->>'presente')::boolean) / NULLIF(COUNT(*), 0), 1) as pct_validacion,
    
    -- Modulo 3: Abandono
    COUNT(*) FILTER (WHERE (a.modulo_abandono->>'hubo_abandono')::boolean) as llamadas_con_abandono,
    ROUND(100.0 * COUNT(*) FILTER (WHERE (a.modulo_abandono->>'hubo_abandono')::boolean) / NULLIF(COUNT(*), 0), 1) as tasa_abandono,
    
    -- Resultados
    ROUND(AVG(a.score_total), 1) as score_total,
    ROUND(AVG(a.probabilidad_cumplimiento), 1) as prob_cumplimiento,
    
    -- Rankings
    RANK() OVER (ORDER BY AVG(a.score_total) DESC) as ranking_score,
    RANK() OVER (ORDER BY AVG(a.probabilidad_cumplimiento) DESC) as ranking_prob

FROM analisis_llamadas a
JOIN agentes ag ON a.agente_id = ag.agente_id
WHERE 
    a.fecha_llamada >= CURRENT_DATE - INTERVAL '7 days'
    AND ag.estado = 'activo'
GROUP BY a.agente_id, ag.nombre, ag.equipo, ag.estado
HAVING COUNT(*) >= 3
ORDER BY score_total DESC;

COMMENT ON VIEW vista_agente_modulos IS 'Metricas de los 3 modulos por agente - ultimos 7 dias';

-- ============================================
-- Vista 6: Evolucion Semanal
-- Uso: Grafico de lineas con tendencia
-- ============================================

CREATE OR REPLACE VIEW vista_evolucion_semanal AS
WITH datos_semana AS (
    SELECT
        DATE_TRUNC('week', fecha_llamada)::date as semana,
        COUNT(*) as total_llamadas,
        ROUND(AVG(score_total), 1) as score_total,
        ROUND(AVG(score_contacto_directo), 1) as score_contacto,
        ROUND(AVG(score_compromiso_pago), 1) as score_compromiso,
        ROUND(100.0 * COUNT(*) FILTER (WHERE (modulo_compromiso_pago->'desglose'->'validacion_cliente'->>'presente')::boolean) / NULLIF(COUNT(*), 0), 1) as tasa_validacion,
        ROUND(100.0 * COUNT(*) FILTER (WHERE (modulo_abandono->>'hubo_abandono')::boolean) / NULLIF(COUNT(*), 0), 1) as tasa_abandono,
        ROUND(AVG(probabilidad_cumplimiento), 1) as prob_cumplimiento
    FROM analisis_llamadas
    WHERE fecha_llamada >= CURRENT_DATE - INTERVAL '12 weeks'
    GROUP BY DATE_TRUNC('week', fecha_llamada)::date
)
SELECT
    semana,
    total_llamadas,
    score_total,
    score_contacto,
    score_compromiso,
    tasa_validacion,
    tasa_abandono,
    prob_cumplimiento,
    LAG(score_total) OVER (ORDER BY semana) as score_total_anterior,
    LAG(prob_cumplimiento) OVER (ORDER BY semana) as prob_anterior
FROM datos_semana
ORDER BY semana DESC;

COMMENT ON VIEW vista_evolucion_semanal IS 'Evolucion semanal de metricas - ultimas 12 semanas';

-- ============================================
-- Vista 7: Flujo de Probabilidad (Compromiso)
-- Uso: Diagrama de flechas mostrando acumulacion
-- ============================================

CREATE OR REPLACE VIEW vista_flujo_probabilidad AS
WITH base AS (
    SELECT
        (modulo_compromiso_pago->'desglose'->'oferta_clara'->>'presente')::boolean as oferta,
        (modulo_compromiso_pago->'desglose'->'alternativas_pago'->>'presente')::boolean as alternativas,
        (modulo_compromiso_pago->'desglose'->'fecha_especifica'->>'presente')::boolean as fecha,
        (modulo_compromiso_pago->'desglose'->'validacion_cliente'->>'presente')::boolean as validacion,
        probabilidad_cumplimiento
    FROM analisis_llamadas
    WHERE fecha_llamada >= CURRENT_DATE - INTERVAL '30 days'
)
SELECT 'Inicio' as paso, 0 as orden, 0 as prob_teorica, ROUND(AVG(probabilidad_cumplimiento) FILTER (WHERE NOT oferta), 1) as prob_real, COUNT(*) FILTER (WHERE NOT oferta) as n FROM base
UNION ALL
SELECT 'Oferta clara' as paso, 1 as orden, 20 as prob_teorica, ROUND(AVG(probabilidad_cumplimiento) FILTER (WHERE oferta AND NOT alternativas), 1) as prob_real, COUNT(*) FILTER (WHERE oferta AND NOT alternativas) as n FROM base
UNION ALL
SELECT 'Alternativas' as paso, 2 as orden, 30 as prob_teorica, ROUND(AVG(probabilidad_cumplimiento) FILTER (WHERE oferta AND alternativas AND NOT fecha), 1) as prob_real, COUNT(*) FILTER (WHERE oferta AND alternativas AND NOT fecha) as n FROM base
UNION ALL
SELECT 'Fecha especifica' as paso, 3 as orden, 50 as prob_teorica, ROUND(AVG(probabilidad_cumplimiento) FILTER (WHERE oferta AND alternativas AND fecha AND NOT validacion), 1) as prob_real, COUNT(*) FILTER (WHERE oferta AND alternativas AND fecha AND NOT validacion) as n FROM base
UNION ALL
SELECT 'Validacion cliente' as paso, 4 as orden, 100 as prob_teorica, ROUND(AVG(probabilidad_cumplimiento) FILTER (WHERE oferta AND alternativas AND fecha AND validacion), 1) as prob_real, COUNT(*) FILTER (WHERE oferta AND alternativas AND fecha AND validacion) as n FROM base
ORDER BY orden;

COMMENT ON VIEW vista_flujo_probabilidad IS 'Flujo de probabilidad segun elementos de compromiso';

-- ============================================
-- Vista 8: Detalle de Contacto Directo
-- Uso: Pagina de Contacto Directo - cumplimiento por variable
-- ============================================

CREATE OR REPLACE VIEW vista_contacto_detalle AS
SELECT
    'Monto adeudado' as variable,
    25 as peso_maximo,
    ROUND(AVG((modulo_contacto_directo->'desglose'->'monto_mencionado'->>'puntos')::numeric), 1) as puntos_promedio,
    ROUND(100.0 * COUNT(*) FILTER (WHERE (modulo_contacto_directo->'desglose'->'monto_mencionado'->>'presente')::boolean) / NULLIF(COUNT(*), 0), 1) as pct_cumplimiento,
    COUNT(*) as total_llamadas
FROM analisis_llamadas
WHERE fecha_llamada >= CURRENT_DATE - INTERVAL '30 days'
UNION ALL
SELECT
    'Fecha de vencimiento' as variable,
    15 as peso_maximo,
    ROUND(AVG((modulo_contacto_directo->'desglose'->'fecha_vencimiento'->>'puntos')::numeric), 1) as puntos_promedio,
    ROUND(100.0 * COUNT(*) FILTER (WHERE (modulo_contacto_directo->'desglose'->'fecha_vencimiento'->>'presente')::boolean) / NULLIF(COUNT(*), 0), 1) as pct_cumplimiento,
    COUNT(*) as total_llamadas
FROM analisis_llamadas
WHERE fecha_llamada >= CURRENT_DATE - INTERVAL '30 days'
UNION ALL
SELECT
    'Consecuencias del impago' as variable,
    20 as peso_maximo,
    ROUND(AVG((modulo_contacto_directo->'desglose'->'consecuencias_impago'->>'puntos')::numeric), 1) as puntos_promedio,
    ROUND(100.0 * COUNT(*) FILTER (WHERE (modulo_contacto_directo->'desglose'->'consecuencias_impago'->>'presente')::boolean) / NULLIF(COUNT(*), 0), 1) as pct_cumplimiento,
    COUNT(*) as total_llamadas
FROM analisis_llamadas
WHERE fecha_llamada >= CURRENT_DATE - INTERVAL '30 days'
UNION ALL
SELECT
    'Alternativas de pago' as variable,
    15 as peso_maximo,
    ROUND(AVG((modulo_contacto_directo->'desglose'->'alternativas_pago'->>'puntos')::numeric), 1) as puntos_promedio,
    ROUND(100.0 * COUNT(*) FILTER (WHERE (modulo_contacto_directo->'desglose'->'alternativas_pago'->>'presente')::boolean) / NULLIF(COUNT(*), 0), 1) as pct_cumplimiento,
    COUNT(*) as total_llamadas
FROM analisis_llamadas
WHERE fecha_llamada >= CURRENT_DATE - INTERVAL '30 days'
UNION ALL
SELECT
    'Manejo de objeciones' as variable,
    25 as peso_maximo,
    ROUND(AVG((modulo_contacto_directo->'desglose'->'manejo_objeciones'->>'puntos')::numeric), 1) as puntos_promedio,
    ROUND(100.0 * COUNT(*) FILTER (WHERE (modulo_contacto_directo->'desglose'->'manejo_objeciones'->>'calidad')::int >= 3) / NULLIF(COUNT(*), 0), 1) as pct_cumplimiento,
    COUNT(*) as total_llamadas
FROM analisis_llamadas
WHERE fecha_llamada >= CURRENT_DATE - INTERVAL '30 days';

COMMENT ON VIEW vista_contacto_detalle IS 'Detalle de cumplimiento por variable del modulo Contacto Directo';

-- ============================================
-- Vista 9: KPIs Principales del Dashboard
-- Uso: Cards principales de la pagina Overview
-- ============================================

CREATE OR REPLACE VIEW vista_kpis_principales AS
WITH periodo_actual AS (
    SELECT
        AVG(score_total) as score_total,
        AVG(score_contacto_directo) as score_contacto,
        AVG(score_compromiso_pago) as score_compromiso,
        100.0 * COUNT(*) FILTER (WHERE (modulo_compromiso_pago->'desglose'->'validacion_cliente'->>'presente')::boolean) / NULLIF(COUNT(*), 0) as tasa_validacion,
        100.0 * COUNT(*) FILTER (WHERE (modulo_abandono->>'hubo_abandono')::boolean) / NULLIF(COUNT(*), 0) as tasa_abandono,
        AVG(probabilidad_cumplimiento) as probabilidad,
        COUNT(*) as total_llamadas
    FROM analisis_llamadas
    WHERE fecha_llamada >= CURRENT_DATE - INTERVAL '7 days'
),
periodo_anterior AS (
    SELECT
        AVG(score_total) as score_total,
        AVG(score_contacto_directo) as score_contacto,
        AVG(score_compromiso_pago) as score_compromiso,
        100.0 * COUNT(*) FILTER (WHERE (modulo_compromiso_pago->'desglose'->'validacion_cliente'->>'presente')::boolean) / NULLIF(COUNT(*), 0) as tasa_validacion,
        100.0 * COUNT(*) FILTER (WHERE (modulo_abandono->>'hubo_abandono')::boolean) / NULLIF(COUNT(*), 0) as tasa_abandono,
        AVG(probabilidad_cumplimiento) as probabilidad,
        COUNT(*) as total_llamadas
    FROM analisis_llamadas
    WHERE fecha_llamada >= CURRENT_DATE - INTERVAL '14 days'
      AND fecha_llamada < CURRENT_DATE - INTERVAL '7 days'
)
SELECT
    'score_total' as kpi,
    ROUND(a.score_total, 1) as valor,
    ROUND(p.score_total, 1) as valor_anterior,
    ROUND(a.score_total - COALESCE(p.score_total, 0), 1) as cambio
FROM periodo_actual a, periodo_anterior p
UNION ALL
SELECT
    'score_contacto' as kpi,
    ROUND(a.score_contacto, 1) as valor,
    ROUND(p.score_contacto, 1) as valor_anterior,
    ROUND(a.score_contacto - COALESCE(p.score_contacto, 0), 1) as cambio
FROM periodo_actual a, periodo_anterior p
UNION ALL
SELECT
    'score_compromiso' as kpi,
    ROUND(a.score_compromiso, 1) as valor,
    ROUND(p.score_compromiso, 1) as valor_anterior,
    ROUND(a.score_compromiso - COALESCE(p.score_compromiso, 0), 1) as cambio
FROM periodo_actual a, periodo_anterior p
UNION ALL
SELECT
    'tasa_validacion' as kpi,
    ROUND(a.tasa_validacion, 1) as valor,
    ROUND(p.tasa_validacion, 1) as valor_anterior,
    ROUND(a.tasa_validacion - COALESCE(p.tasa_validacion, 0), 1) as cambio
FROM periodo_actual a, periodo_anterior p
UNION ALL
SELECT
    'tasa_abandono' as kpi,
    ROUND(a.tasa_abandono, 1) as valor,
    ROUND(p.tasa_abandono, 1) as valor_anterior,
    ROUND(a.tasa_abandono - COALESCE(p.tasa_abandono, 0), 1) as cambio
FROM periodo_actual a, periodo_anterior p
UNION ALL
SELECT
    'probabilidad' as kpi,
    ROUND(a.probabilidad, 1) as valor,
    ROUND(p.probabilidad, 1) as valor_anterior,
    ROUND(a.probabilidad - COALESCE(p.probabilidad, 0), 1) as cambio
FROM periodo_actual a, periodo_anterior p
UNION ALL
SELECT
    'total_llamadas' as kpi,
    a.total_llamadas as valor,
    p.total_llamadas as valor_anterior,
    a.total_llamadas - COALESCE(p.total_llamadas, 0) as cambio
FROM periodo_actual a, periodo_anterior p;

COMMENT ON VIEW vista_kpis_principales IS 'KPIs principales con comparativa vs periodo anterior';
</file>

<file path="supabase/functions.sql">
-- ============================================
-- NODUS - Funciones √∫tiles para Supabase
-- ============================================

-- ============================================
-- Funci√≥n: Obtener m√©tricas de dashboard
-- ============================================

CREATE OR REPLACE FUNCTION get_dashboard_metrics(
    fecha_inicio DATE DEFAULT CURRENT_DATE - INTERVAL '7 days',
    fecha_fin DATE DEFAULT CURRENT_DATE
)
RETURNS JSON AS $$
DECLARE
    result JSON;
BEGIN
    SELECT json_build_object(
        'total_llamadas', COUNT(r.registro_id),
        'llamadas_hoy', COUNT(CASE WHEN DATE(r.timestamp_inicio) = CURRENT_DATE THEN 1 END),
        'score_promedio', ROUND(AVG(a.score_total), 2),
        'tasa_validacion', ROUND(
            COUNT(CASE WHEN (a.modulo_compromiso_pago->'desglose'->'validacion_cliente'->>'presente')::boolean = true THEN 1 END)::DECIMAL 
            / NULLIF(COUNT(a.analisis_id), 0), 
            4
        ),
        'probabilidad_promedio', ROUND(AVG(a.probabilidad_cumplimiento), 2),
        'alertas_activas', (
            SELECT COUNT(*) FROM alertas_anomalias 
            WHERE estado IN ('nueva', 'en_revision')
        ),
        'duracion_promedio', ROUND(AVG(r.duracion_segundos))
    ) INTO result
    FROM registro_llamadas r
    LEFT JOIN analisis_llamadas a ON r.registro_id = a.registro_id
    WHERE DATE(r.timestamp_inicio) BETWEEN fecha_inicio AND fecha_fin
      AND r.estado = 'analizado';
    
    RETURN result;
END;
$$ LANGUAGE plpgsql;

COMMENT ON FUNCTION get_dashboard_metrics IS 'Obtiene m√©tricas principales para el dashboard';

-- ============================================
-- Funci√≥n: Obtener m√©tricas de agente
-- ============================================

CREATE OR REPLACE FUNCTION get_agente_metrics(
    p_agente_id UUID,
    fecha_inicio DATE DEFAULT CURRENT_DATE - INTERVAL '30 days',
    fecha_fin DATE DEFAULT CURRENT_DATE
)
RETURNS JSON AS $$
DECLARE
    result JSON;
BEGIN
    SELECT json_build_object(
        'agente_id', p_agente_id,
        'agente_nombre', ag.nombre,
        'equipo', ag.equipo,
        'total_llamadas', COUNT(a.analisis_id),
        'score_promedio', ROUND(AVG(a.score_total), 2),
        'score_min', MIN(a.score_total),
        'score_max', MAX(a.score_total),
        'tasa_validacion', ROUND(
            COUNT(CASE WHEN (a.modulo_compromiso_pago->'desglose'->'validacion_cliente'->>'presente')::boolean = true THEN 1 END)::DECIMAL 
            / NULLIF(COUNT(a.analisis_id), 0) * 100, 
            2
        ),
        'probabilidad_cumplimiento_promedio', ROUND(AVG(a.probabilidad_cumplimiento), 2),
        'llamadas_alto_score', COUNT(CASE WHEN a.score_total >= 70 THEN 1 END),
        'llamadas_medio_score', COUNT(CASE WHEN a.score_total BETWEEN 40 AND 69 THEN 1 END),
        'llamadas_bajo_score', COUNT(CASE WHEN a.score_total < 40 THEN 1 END),
        'duracion_promedio', ROUND(AVG(r.duracion_segundos))
    ) INTO result
    FROM agentes ag
    LEFT JOIN analisis_llamadas a ON ag.agente_id = a.agente_id
    LEFT JOIN registro_llamadas r ON a.registro_id = r.registro_id
    WHERE ag.agente_id = p_agente_id
      AND a.fecha_llamada BETWEEN fecha_inicio AND fecha_fin
    GROUP BY ag.agente_id, ag.nombre, ag.equipo;
    
    RETURN result;
END;
$$ LANGUAGE plpgsql;

COMMENT ON FUNCTION get_agente_metrics IS 'Obtiene m√©tricas detalladas de un agente espec√≠fico';

-- ============================================
-- Funci√≥n: Obtener m√©tricas de equipo
-- ============================================

CREATE OR REPLACE FUNCTION get_equipo_metrics(
    p_equipo VARCHAR(100),
    fecha_inicio DATE DEFAULT CURRENT_DATE - INTERVAL '7 days',
    fecha_fin DATE DEFAULT CURRENT_DATE
)
RETURNS JSON AS $$
DECLARE
    result JSON;
BEGIN
    SELECT json_build_object(
        'equipo', p_equipo,
        'total_agentes', COUNT(DISTINCT ag.agente_id),
        'total_llamadas', COUNT(a.analisis_id),
        'score_promedio_equipo', ROUND(AVG(a.score_total), 2),
        'tasa_validacion_equipo', ROUND(
            COUNT(CASE WHEN (a.modulo_compromiso_pago->'desglose'->'validacion_cliente'->>'presente')::boolean = true THEN 1 END)::DECIMAL 
            / NULLIF(COUNT(a.analisis_id), 0) * 100, 
            2
        ),
        'probabilidad_promedio', ROUND(AVG(a.probabilidad_cumplimiento), 2),
        'mejor_agente', (
            SELECT ag2.nombre
            FROM agentes ag2
            JOIN analisis_llamadas a2 ON ag2.agente_id = a2.agente_id
            WHERE ag2.equipo = p_equipo
              AND a2.fecha_llamada BETWEEN fecha_inicio AND fecha_fin
            GROUP BY ag2.agente_id, ag2.nombre
            ORDER BY AVG(a2.score_total) DESC
            LIMIT 1
        )
    ) INTO result
    FROM agentes ag
    LEFT JOIN analisis_llamadas a ON ag.agente_id = a.agente_id
    WHERE ag.equipo = p_equipo
      AND ag.estado = 'activo'
      AND a.fecha_llamada BETWEEN fecha_inicio AND fecha_fin
    GROUP BY ag.equipo;
    
    RETURN result;
END;
$$ LANGUAGE plpgsql;

COMMENT ON FUNCTION get_equipo_metrics IS 'Obtiene m√©tricas agregadas de un equipo';

-- ============================================
-- Funci√≥n: Tendencias por d√≠a
-- ============================================

CREATE OR REPLACE FUNCTION get_tendencias_diarias(
    fecha_inicio DATE DEFAULT CURRENT_DATE - INTERVAL '7 days',
    fecha_fin DATE DEFAULT CURRENT_DATE
)
RETURNS TABLE (
    fecha DATE,
    total_llamadas BIGINT,
    score_promedio NUMERIC,
    tasa_validacion NUMERIC,
    probabilidad_promedio NUMERIC
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        a.fecha_llamada as fecha,
        COUNT(a.analisis_id) as total_llamadas,
        ROUND(AVG(a.score_total), 2) as score_promedio,
        ROUND(
            COUNT(CASE WHEN (a.modulo_compromiso_pago->'desglose'->'validacion_cliente'->>'presente')::boolean = true THEN 1 END)::DECIMAL 
            / NULLIF(COUNT(a.analisis_id), 0) * 100, 
            2
        ) as tasa_validacion,
        ROUND(AVG(a.probabilidad_cumplimiento), 2) as probabilidad_promedio
    FROM analisis_llamadas a
    WHERE a.fecha_llamada BETWEEN fecha_inicio AND fecha_fin
    GROUP BY a.fecha_llamada
    ORDER BY fecha;
END;
$$ LANGUAGE plpgsql;

COMMENT ON FUNCTION get_tendencias_diarias IS 'Devuelve tendencias diarias para gr√°ficos';

-- ============================================
-- Funci√≥n: Top performers
-- ============================================

CREATE OR REPLACE FUNCTION get_top_performers(
    limite INTEGER DEFAULT 10,
    fecha_inicio DATE DEFAULT CURRENT_DATE - INTERVAL '30 days',
    fecha_fin DATE DEFAULT CURRENT_DATE
)
RETURNS TABLE (
    agente_id UUID,
    nombre VARCHAR,
    equipo VARCHAR,
    score_promedio NUMERIC,
    total_llamadas BIGINT,
    tasa_validacion NUMERIC,
    ranking BIGINT
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        ag.agente_id,
        ag.nombre,
        ag.equipo,
        ROUND(AVG(a.score_total), 2) as score_promedio,
        COUNT(a.analisis_id) as total_llamadas,
        ROUND(
            COUNT(CASE WHEN (a.modulo_compromiso_pago->'desglose'->'validacion_cliente'->>'presente')::boolean = true THEN 1 END)::DECIMAL 
            / NULLIF(COUNT(a.analisis_id), 0) * 100, 
            2
        ) as tasa_validacion,
        RANK() OVER (ORDER BY AVG(a.score_total) DESC) as ranking
    FROM agentes ag
    JOIN analisis_llamadas a ON ag.agente_id = a.agente_id
    WHERE ag.estado = 'activo'
      AND a.fecha_llamada BETWEEN fecha_inicio AND fecha_fin
    GROUP BY ag.agente_id, ag.nombre, ag.equipo
    HAVING COUNT(a.analisis_id) >= 5 -- M√≠nimo 5 llamadas para ranking
    ORDER BY score_promedio DESC
    LIMIT limite;
END;
$$ LANGUAGE plpgsql;

COMMENT ON FUNCTION get_top_performers IS 'Devuelve ranking de mejores agentes';

-- ============================================
-- Funci√≥n: B√∫squeda de registros con filtros
-- ============================================

CREATE OR REPLACE FUNCTION search_registros(
    p_search TEXT DEFAULT NULL,
    p_agente_id UUID DEFAULT NULL,
    p_estado estado_procesamiento DEFAULT NULL,
    p_fecha_desde DATE DEFAULT NULL,
    p_fecha_hasta DATE DEFAULT NULL,
    p_score_min INTEGER DEFAULT NULL,
    p_score_max INTEGER DEFAULT NULL,
    p_limit INTEGER DEFAULT 50,
    p_offset INTEGER DEFAULT 0
)
RETURNS TABLE (
    registro_id UUID,
    agente_nombre VARCHAR,
    cliente_ref VARCHAR,
    duracion_segundos INTEGER,
    timestamp_inicio TIMESTAMPTZ,
    estado estado_procesamiento,
    score_total INTEGER,
    probabilidad_cumplimiento INTEGER,
    tiene_alertas BOOLEAN,
    campana VARCHAR
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        r.registro_id,
        ag.nombre as agente_nombre,
        r.cliente_ref,
        r.duracion_segundos,
        r.timestamp_inicio,
        r.estado,
        a.score_total,
        a.probabilidad_cumplimiento,
        (a.alertas IS NOT NULL AND jsonb_array_length(a.alertas) > 0) as tiene_alertas,
        r.campana
    FROM registro_llamadas r
    LEFT JOIN agentes ag ON r.agente_id = ag.agente_id
    LEFT JOIN analisis_llamadas a ON r.registro_id = a.registro_id
    WHERE 
        (p_search IS NULL OR ag.nombre ILIKE '%' || p_search || '%' OR r.cliente_ref ILIKE '%' || p_search || '%')
        AND (p_agente_id IS NULL OR r.agente_id = p_agente_id)
        AND (p_estado IS NULL OR r.estado = p_estado)
        AND (p_fecha_desde IS NULL OR DATE(r.timestamp_inicio) >= p_fecha_desde)
        AND (p_fecha_hasta IS NULL OR DATE(r.timestamp_inicio) <= p_fecha_hasta)
        AND (p_score_min IS NULL OR a.score_total >= p_score_min)
        AND (p_score_max IS NULL OR a.score_total <= p_score_max)
    ORDER BY r.timestamp_inicio DESC
    LIMIT p_limit
    OFFSET p_offset;
END;
$$ LANGUAGE plpgsql;

COMMENT ON FUNCTION search_registros IS 'B√∫squeda de registros con m√∫ltiples filtros';

-- ============================================
-- Funci√≥n: Obtener √∫ltimos an√°lisis de un agente
-- Para el AGENTE COACH
-- ============================================

CREATE OR REPLACE FUNCTION get_ultimos_analisis_agente(
    p_agente_id UUID,
    p_limite INTEGER DEFAULT 25
)
RETURNS TABLE (
    analisis_id UUID,
    registro_id UUID,
    fecha_llamada DATE,
    score_total INTEGER,
    score_contacto_directo INTEGER,
    score_compromiso_pago INTEGER,
    probabilidad_cumplimiento INTEGER,
    nivel_cumplimiento nivel_cumplimiento,
    tiene_validacion BOOLEAN,
    hubo_abandono BOOLEAN,
    alertas JSONB
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        a.analisis_id,
        a.registro_id,
        a.fecha_llamada,
        a.score_total,
        a.score_contacto_directo,
        a.score_compromiso_pago,
        a.probabilidad_cumplimiento,
        a.nivel_cumplimiento,
        (a.modulo_compromiso_pago->'desglose'->'validacion_cliente'->>'presente')::boolean as tiene_validacion,
        (a.modulo_abandono->>'hubo_abandono')::boolean as hubo_abandono,
        a.alertas
    FROM analisis_llamadas a
    WHERE a.agente_id = p_agente_id
    ORDER BY a.created_at DESC
    LIMIT p_limite;
END;
$$ LANGUAGE plpgsql;

COMMENT ON FUNCTION get_ultimos_analisis_agente IS 'Obtiene √∫ltimos N an√°lisis de un agente - usado por Agente Coach';

-- ============================================
-- Funci√≥n: Obtener alertas activas
-- Para el AGENTE DETECTOR y Dashboard
-- ============================================

CREATE OR REPLACE FUNCTION get_alertas_activas(
    p_severidad severidad_alerta DEFAULT NULL,
    p_tipo tipo_alerta DEFAULT NULL,
    p_limite INTEGER DEFAULT 50
)
RETURNS TABLE (
    alerta_id UUID,
    tipo tipo_alerta,
    severidad severidad_alerta,
    categoria VARCHAR,
    codigo VARCHAR,
    descripcion TEXT,
    agentes_relacionados UUID[],
    registro_id UUID,
    estado estado_alerta,
    created_at TIMESTAMPTZ
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        al.alerta_id,
        al.tipo,
        al.severidad,
        al.categoria,
        al.codigo,
        al.descripcion,
        al.agentes_relacionados,
        al.registro_id,
        al.estado,
        al.created_at
    FROM alertas_anomalias al
    WHERE al.estado IN ('nueva', 'en_revision')
      AND (p_severidad IS NULL OR al.severidad = p_severidad)
      AND (p_tipo IS NULL OR al.tipo = p_tipo)
    ORDER BY 
        CASE al.severidad 
            WHEN 'critica' THEN 1 
            WHEN 'alta' THEN 2 
            WHEN 'media' THEN 3 
            WHEN 'baja' THEN 4 
        END,
        al.created_at DESC
    LIMIT p_limite;
END;
$$ LANGUAGE plpgsql;

COMMENT ON FUNCTION get_alertas_activas IS 'Obtiene alertas activas ordenadas por severidad';

-- ============================================
-- Funci√≥n: Actualizar m√©tricas agregadas
-- Para ejecutar via cron o post-an√°lisis
-- ============================================

CREATE OR REPLACE FUNCTION refresh_metricas_agregadas(
    p_fecha DATE DEFAULT CURRENT_DATE
)
RETURNS VOID AS $$
BEGIN
    -- Eliminar m√©tricas existentes del d√≠a (por agente)
    DELETE FROM metricas_agregadas 
    WHERE fecha = p_fecha AND agente_id IS NOT NULL AND equipo IS NULL AND campana IS NULL;
    
    -- Insertar m√©tricas por agente
    INSERT INTO metricas_agregadas (
        fecha, agente_id, total_llamadas, duracion_promedio_segundos,
        score_promedio, score_min, score_max,
        tasa_validacion, probabilidad_cumplimiento_promedio,
        llamadas_score_alto, llamadas_score_medio, llamadas_score_bajo,
        llamadas_con_abandono
    )
    SELECT 
        p_fecha,
        a.agente_id,
        COUNT(a.analisis_id),
        ROUND(AVG(r.duracion_segundos))::INTEGER,
        ROUND(AVG(a.score_total), 2),
        MIN(a.score_total),
        MAX(a.score_total),
        ROUND(
            COUNT(CASE WHEN (a.modulo_compromiso_pago->'desglose'->'validacion_cliente'->>'presente')::boolean = true THEN 1 END)::DECIMAL 
            / NULLIF(COUNT(a.analisis_id), 0), 
            4
        ),
        ROUND(AVG(a.probabilidad_cumplimiento), 2),
        COUNT(CASE WHEN a.score_total >= 70 THEN 1 END),
        COUNT(CASE WHEN a.score_total BETWEEN 40 AND 69 THEN 1 END),
        COUNT(CASE WHEN a.score_total < 40 THEN 1 END),
        COUNT(CASE WHEN (a.modulo_abandono->>'hubo_abandono')::boolean = true THEN 1 END)
    FROM analisis_llamadas a
    JOIN registro_llamadas r ON a.registro_id = r.registro_id
    WHERE a.fecha_llamada = p_fecha
    GROUP BY a.agente_id;
    
    -- Eliminar m√©tricas globales del d√≠a
    DELETE FROM metricas_agregadas 
    WHERE fecha = p_fecha AND agente_id IS NULL AND equipo IS NULL AND campana IS NULL;
    
    -- Insertar m√©tricas globales
    INSERT INTO metricas_agregadas (
        fecha, total_llamadas, duracion_promedio_segundos,
        score_promedio, score_min, score_max,
        tasa_validacion, probabilidad_cumplimiento_promedio,
        llamadas_score_alto, llamadas_score_medio, llamadas_score_bajo,
        llamadas_con_abandono, alertas_criticas, alertas_altas
    )
    SELECT 
        p_fecha,
        COUNT(a.analisis_id),
        ROUND(AVG(r.duracion_segundos))::INTEGER,
        ROUND(AVG(a.score_total), 2),
        MIN(a.score_total),
        MAX(a.score_total),
        ROUND(
            COUNT(CASE WHEN (a.modulo_compromiso_pago->'desglose'->'validacion_cliente'->>'presente')::boolean = true THEN 1 END)::DECIMAL 
            / NULLIF(COUNT(a.analisis_id), 0), 
            4
        ),
        ROUND(AVG(a.probabilidad_cumplimiento), 2),
        COUNT(CASE WHEN a.score_total >= 70 THEN 1 END),
        COUNT(CASE WHEN a.score_total BETWEEN 40 AND 69 THEN 1 END),
        COUNT(CASE WHEN a.score_total < 40 THEN 1 END),
        COUNT(CASE WHEN (a.modulo_abandono->>'hubo_abandono')::boolean = true THEN 1 END),
        (SELECT COUNT(*) FROM alertas_anomalias WHERE DATE(created_at) = p_fecha AND severidad = 'critica'),
        (SELECT COUNT(*) FROM alertas_anomalias WHERE DATE(created_at) = p_fecha AND severidad = 'alta')
    FROM analisis_llamadas a
    JOIN registro_llamadas r ON a.registro_id = r.registro_id
    WHERE a.fecha_llamada = p_fecha;
END;
$$ LANGUAGE plpgsql;

COMMENT ON FUNCTION refresh_metricas_agregadas IS 'Recalcula m√©tricas agregadas para una fecha - ejecutar via cron diario';

-- ============================================
-- Funci√≥n: Obtener datos para el Agente Conversacional (RAG)
-- ============================================

CREATE OR REPLACE FUNCTION get_contexto_agente_para_chat(
    p_agente_id UUID
)
RETURNS JSON AS $$
DECLARE
    result JSON;
BEGIN
    SELECT json_build_object(
        'agente', (
            SELECT json_build_object(
                'nombre', nombre,
                'equipo', equipo,
                'estado', estado,
                'fecha_ingreso', fecha_ingreso
            )
            FROM agentes WHERE agente_id = p_agente_id
        ),
        'metricas_recientes', (
            SELECT get_agente_metrics(p_agente_id, CURRENT_DATE - INTERVAL '7 days', CURRENT_DATE)
        ),
        'ultimo_coaching', (
            SELECT json_build_object(
                'fecha', fecha_reporte,
                'score_promedio', metricas_periodo->>'score_promedio',
                'tasa_validacion', metricas_periodo->>'tasa_validacion',
                'gap_critico', gap_critico->>'area',
                'objetivo', plan_mejora->>'objetivo_semana'
            )
            FROM coaching_reports
            WHERE agente_id = p_agente_id
            ORDER BY fecha_reporte DESC
            LIMIT 1
        ),
        'alertas_activas', (
            SELECT json_agg(json_build_object(
                'tipo', tipo,
                'severidad', severidad,
                'descripcion', descripcion
            ))
            FROM alertas_anomalias
            WHERE p_agente_id = ANY(agentes_relacionados)
              AND estado IN ('nueva', 'en_revision')
        )
    ) INTO result;
    
    RETURN result;
END;
$$ LANGUAGE plpgsql;

COMMENT ON FUNCTION get_contexto_agente_para_chat IS 'Obtiene contexto completo de un agente para el Agente Conversacional';

-- ============================================
-- FIN DE FUNCIONES
-- ============================================
</file>

<file path="supabase/README.md">
# NODUS - Supabase Database Setup

Este directorio contiene todos los scripts SQL necesarios para configurar la base de datos de NODUS en Supabase (PostgreSQL).

## üìÅ Archivos

- **`schema.sql`**: Schema completo de la base de datos (tablas, √≠ndices, triggers, views)
- **`seeds.sql`**: Datos de prueba para desarrollo
- **`functions.sql`**: Funciones √∫tiles para consultas complejas

## üöÄ Setup R√°pido

### 1. Crear proyecto en Supabase

1. Ve a [supabase.com](https://supabase.com)
2. Crea un nuevo proyecto
3. Espera a que se inicialice (2-3 minutos)
4. Guarda tu **Project URL** y **anon key**

### 2. Ejecutar Schema

En el **SQL Editor** de Supabase:

```sql
-- 1. Ejecutar schema completo
-- Copiar y pegar todo el contenido de schema.sql
```

### 3. Cargar datos de prueba (opcional)

```sql
-- 2. Ejecutar seeds (solo para desarrollo)
-- Copiar y pegar todo el contenido de seeds.sql
```

### 4. Cargar funciones √∫tiles

```sql
-- 3. Ejecutar funciones
-- Copiar y pegar todo el contenido de functions.sql
```

## üìä Estructura de Tablas

| Tabla | Descripci√≥n | Escrita por |
|-------|-------------|-------------|
| `agentes` | Agentes de cobranza | Manual/API externa |
| `registro_llamadas` | Referencia a llamadas (NO audio) | Agente Transcriptor |
| `transcripciones` | Output de AI Studio | Agente Transcriptor |
| `analisis_llamadas` | Scoring y predicci√≥n | Agente Analista |
| `alertas_anomalias` | Alertas detectadas | Agente Detector |
| `coaching_reports` | Reportes diarios | Agente Coach |
| `reportes_estrategia` | An√°lisis semanal | Agente Estratega |
| `metricas_agregadas` | M√©tricas pre-calculadas | Cron/Triggers |

## üîë Variables de Entorno

Agregar a tu `.env.local`:

```env
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://tu-proyecto.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=tu-anon-key
SUPABASE_SERVICE_ROLE_KEY=tu-service-role-key

# API Keys (para backend)
OPENAI_API_KEY=sk-...
ANTHROPIC_API_KEY=sk-ant-...
```

## üìà Funciones √ötiles

### M√©tricas de Dashboard

```sql
SELECT get_dashboard_metrics();
-- o con rango de fechas
SELECT get_dashboard_metrics('2026-01-01', '2026-01-31');
```

### M√©tricas de Agente

```sql
SELECT get_agente_metrics('uuid-del-agente');
```

### Top Performers

```sql
SELECT * FROM get_top_performers(10);
```

### Tendencias Diarias

```sql
SELECT * FROM get_tendencias_diarias();
```

### B√∫squeda de Registros

```sql
SELECT * FROM search_registros(
    'Mar√≠a',           -- b√∫squeda
    NULL,              -- agente_id (opcional)
    'analizado',       -- estado (opcional)
    '2026-01-01',      -- fecha_desde
    '2026-01-31',      -- fecha_hasta
    NULL,              -- score_min (opcional)
    NULL,              -- score_max (opcional)
    50,                -- limit
    0                  -- offset
);
```

### √öltimos an√°lisis de un agente (para Coach)

```sql
SELECT * FROM get_ultimos_analisis_agente('uuid-del-agente', 25);
```

### Alertas activas

```sql
SELECT * FROM get_alertas_activas('critica', NULL, 10);
```

## üîí Row Level Security (RLS)

RLS est√° **deshabilitado** por defecto. Para habilitar seg√∫n tus necesidades:

```sql
-- Habilitar RLS
ALTER TABLE agentes ENABLE ROW LEVEL SECURITY;
ALTER TABLE registro_llamadas ENABLE ROW LEVEL SECURITY;
-- etc.

-- Ejemplo: Permitir a supervisores ver todo
CREATE POLICY "Supervisors can see all data" ON registro_llamadas
    FOR SELECT 
    USING (
        auth.jwt()->>'role' = 'supervisor' 
        OR 
        auth.jwt()->>'role' = 'admin'
    );

-- Ejemplo: Agentes solo ven sus propios registros
CREATE POLICY "Agents see own records" ON registro_llamadas
    FOR SELECT 
    USING (
        agente_id = auth.uid()::UUID
    );

-- Service role para los agentes de Saturn Studio
CREATE POLICY "Service role full access" ON registro_llamadas 
    FOR ALL USING (auth.role() = 'service_role');
```

## üîÑ Migraciones

Para cambios futuros, crea archivos numerados:

```
migrations/
  001_initial_schema.sql
  002_add_campo_x.sql
  003_modify_index_y.sql
```

### Ejemplo de migraci√≥n:

```sql
-- 002_add_campo_x.sql
ALTER TABLE llamadas 
ADD COLUMN prioridad VARCHAR(20) DEFAULT 'normal';

CREATE INDEX idx_llamadas_prioridad ON llamadas(prioridad);
```

## üß™ Testing

### Verificar que todo est√© correcto:

```sql
-- Contar tablas creadas
SELECT COUNT(*) FROM information_schema.tables 
WHERE table_schema = 'public';

-- Verificar datos seed
SELECT COUNT(*) FROM agentes;
SELECT COUNT(*) FROM llamadas;
SELECT COUNT(*) FROM analisis_llamadas;

-- Verificar funciones
SELECT * FROM get_dashboard_metrics();
```

## üìä √çndices Importantes

Los √≠ndices m√°s cr√≠ticos para performance:

```sql
-- B√∫squedas por fecha (muy frecuente)
idx_registro_timestamp
idx_registro_fecha
idx_analisis_fecha

-- B√∫squedas por agente
idx_registro_agente
idx_registro_agente_fecha
idx_analisis_agente_fecha

-- Filtros en dashboard
idx_registro_estado
idx_analisis_score
idx_analisis_probabilidad

-- B√∫squedas en JSON (GIN)
idx_transcripciones_entidades
idx_analisis_alertas

-- Para Agente Coach
idx_analisis_coach (agente_id, created_at DESC)
```

## üîß Mantenimiento

### Refresh m√©tricas agregadas

Ejecutar diariamente (idealmente via cron o trigger post-an√°lisis):

```sql
SELECT refresh_metricas_agregadas(CURRENT_DATE);
```

### Limpiar datos antiguos (opcional)

```sql
-- Eliminar registros de hace m√°s de 2 a√±os
DELETE FROM registro_llamadas 
WHERE timestamp_inicio < NOW() - INTERVAL '2 years';

-- Archivar alertas resueltas antiguas
UPDATE alertas_anomalias 
SET estado = 'falso_positivo' 
WHERE estado = 'resuelta' 
  AND updated_at < NOW() - INTERVAL '6 months';
```

## üìö Recursos

- [Supabase Docs](https://supabase.com/docs)
- [PostgreSQL JSON Functions](https://www.postgresql.org/docs/current/functions-json.html)
- [Row Level Security](https://supabase.com/docs/guides/auth/row-level-security)

## üÜò Troubleshooting

### Error: "relation already exists"

```sql
-- Eliminar tabla existente
DROP TABLE IF EXISTS nombre_tabla CASCADE;
```

### Error en RLS

```sql
-- Verificar pol√≠ticas
SELECT * FROM pg_policies WHERE tablename = 'nombre_tabla';

-- Eliminar todas las pol√≠ticas
DROP POLICY IF EXISTS "policy_name" ON tabla;
```

### Performance lento

```sql
-- Ver queries lentas
SELECT * FROM pg_stat_statements 
ORDER BY total_exec_time DESC 
LIMIT 10;

-- Analizar query espec√≠fica
EXPLAIN ANALYZE SELECT ...;
```

---

¬øDudas? Revisar la documentaci√≥n de Supabase o contactar al equipo.
</file>

<file path="supabase/schema.sql">
-- ============================================
-- NODUS - Database Schema v2 para Supabase
-- Centrado en Agentes de Saturn Studio
-- ============================================

-- Enable UUID extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- ============================================
-- ENUMS
-- ============================================

CREATE TYPE estado_procesamiento AS ENUM ('pendiente', 'procesando', 'transcrito', 'analizado', 'error');
CREATE TYPE nivel_cumplimiento AS ENUM ('baja', 'media', 'alta');
CREATE TYPE severidad_alerta AS ENUM ('critica', 'alta', 'media', 'baja');
CREATE TYPE estado_alerta AS ENUM ('nueva', 'en_revision', 'resuelta', 'falso_positivo');
CREATE TYPE estado_agente AS ENUM ('activo', 'inactivo', 'vacaciones');
CREATE TYPE tipo_alerta AS ENUM ('individual', 'sistemica', 'patron');

-- ============================================
-- TABLE: agentes
-- Gesti√≥n de agentes de cobranza
-- USADO POR: Todos los agentes (lectura), Dashboard
-- ============================================

CREATE TABLE agentes (
    agente_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    
    -- Identificaci√≥n
    nombre VARCHAR(200) NOT NULL,
    email VARCHAR(200) UNIQUE,
    avatar_url TEXT,
    codigo_externo VARCHAR(50), -- ID en sistema externo (CRM)
    
    -- Informaci√≥n laboral
    fecha_ingreso DATE,
    estado estado_agente DEFAULT 'activo',
    equipo VARCHAR(100),
    supervisor_id UUID REFERENCES agentes(agente_id),
    
    -- Metadata adicional
    metadata JSONB DEFAULT '{}',
    
    -- Timestamps
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_agentes_estado ON agentes(estado);
CREATE INDEX idx_agentes_equipo ON agentes(equipo);
CREATE INDEX idx_agentes_codigo_externo ON agentes(codigo_externo);

COMMENT ON TABLE agentes IS 'Agentes de cobranza - tabla central del sistema';

-- ============================================
-- TABLE: registro_llamadas
-- Registro de llamadas procesadas (referencia, NO almacena audio)
-- ESCRITO POR: Agente Transcriptor
-- ACTUALIZADO POR: Agente Analista
-- ============================================

CREATE TABLE registro_llamadas (
    registro_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    
    -- Referencia al audio externo (NO se almacena el audio)
    audio_url TEXT NOT NULL,
    audio_id_externo VARCHAR(100), -- ID en sistema de grabaci√≥n
    
    -- Timestamps de la llamada original
    timestamp_inicio TIMESTAMPTZ NOT NULL,
    timestamp_fin TIMESTAMPTZ NOT NULL,
    duracion_segundos INTEGER, -- Calculado en trigger
    timestamp_fecha DATE, -- Fecha de la llamada (calculado en trigger, para √≠ndices)
    
    -- Relaciones
    agente_id UUID NOT NULL REFERENCES agentes(agente_id),
    cliente_ref VARCHAR(100) NOT NULL, -- Referencia al cliente en sistema externo
    
    -- Contexto de la llamada
    campana VARCHAR(100),
    tipo_deuda VARCHAR(50),
    monto_deuda DECIMAL(12,2),
    dias_mora INTEGER,
    
    -- Estado del procesamiento en NODUS
    estado estado_procesamiento DEFAULT 'pendiente',
    error_mensaje TEXT,
    
    -- Referencias a outputs de agentes
    transcripcion_id UUID,
    analisis_id UUID,
    
    -- Metadata del sistema externo
    metadata_externa JSONB DEFAULT '{}',
    
    -- Timestamps del sistema
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_registro_agente ON registro_llamadas(agente_id);
CREATE INDEX idx_registro_cliente ON registro_llamadas(cliente_ref);
CREATE INDEX idx_registro_timestamp ON registro_llamadas(timestamp_inicio DESC);
CREATE INDEX idx_registro_estado ON registro_llamadas(estado);
CREATE INDEX idx_registro_campana ON registro_llamadas(campana);
CREATE INDEX idx_registro_fecha ON registro_llamadas(timestamp_fecha);
CREATE INDEX idx_registro_agente_fecha ON registro_llamadas(agente_id, timestamp_fecha);

COMMENT ON TABLE registro_llamadas IS 'Registro de llamadas procesadas - NO almacena audio, solo referencias';

-- ============================================
-- TABLE: transcripciones
-- Output del AGENTE TRANSCRIPTOR
-- ESCRITO POR: Agente Transcriptor
-- LE√çDO POR: Agente Analista
-- ============================================

CREATE TABLE transcripciones (
    transcripcion_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    registro_id UUID NOT NULL REFERENCES registro_llamadas(registro_id) ON DELETE CASCADE,
    
    -- Transcripci√≥n completa
    transcripcion_completa TEXT NOT NULL,
    
    -- Segmentos con diarizaci√≥n
    -- Array de: {speaker, timestamp_inicio, timestamp_fin, texto, emocion, velocidad_habla}
    segmentos JSONB NOT NULL DEFAULT '[]',
    
    -- Entidades extra√≠das por LLM
    entidades JSONB DEFAULT '{
        "montos": [],
        "fechas": [],
        "metodos_pago": [],
        "objeciones": [],
        "compromisos": []
    }',
    
    -- M√©tricas conversacionales
    metricas_conversacion JSONB DEFAULT '{
        "palabras_agente": 0,
        "palabras_cliente": 0,
        "ratio_habla": 0,
        "interrupciones": 0,
        "silencios_largos": 0,
        "velocidad_promedio_agente": 0,
        "velocidad_promedio_cliente": 0
    }',
    
    -- Calidad del audio
    calidad_audio JSONB DEFAULT '{
        "score": 0,
        "ruido_fondo": false,
        "cortes": 0,
        "inaudibles": 0
    }',
    
    -- Metadata del procesamiento
    modelo_transcripcion VARCHAR(50),
    modelo_emociones VARCHAR(50),
    modelo_entidades VARCHAR(50),
    tiempo_procesamiento_ms INTEGER,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    
    UNIQUE(registro_id)
);

CREATE INDEX idx_transcripciones_registro ON transcripciones(registro_id);
CREATE INDEX idx_transcripciones_fecha ON transcripciones(created_at DESC);
CREATE INDEX idx_transcripciones_entidades ON transcripciones USING GIN (entidades);

COMMENT ON TABLE transcripciones IS 'Output del Agente Transcriptor - AI Studio';

-- ============================================
-- TABLE: analisis_llamadas
-- Output del AGENTE ANALISTA
-- ESCRITO POR: Agente Analista
-- LE√çDO POR: Agente Detector, Coach, Estratega, Conversacional
-- ============================================

CREATE TABLE analisis_llamadas (
    analisis_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    registro_id UUID NOT NULL REFERENCES registro_llamadas(registro_id) ON DELETE CASCADE,
    transcripcion_id UUID NOT NULL REFERENCES transcripciones(transcripcion_id),
    agente_id UUID NOT NULL REFERENCES agentes(agente_id),
    
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    -- SCORES PRINCIPALES
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    score_total INTEGER NOT NULL CHECK (score_total >= 0 AND score_total <= 100),
    score_contacto_directo INTEGER CHECK (score_contacto_directo >= 0 AND score_contacto_directo <= 100),
    score_compromiso_pago INTEGER CHECK (score_compromiso_pago >= 0 AND score_compromiso_pago <= 100),
    
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    -- M√ìDULO 1: CONTACTO DIRECTO (0-100 pts)
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    modulo_contacto_directo JSONB NOT NULL DEFAULT '{
        "score": 0,
        "desglose": {
            "monto_mencionado": {"presente": false, "puntos": 0, "max": 25, "evidencia": ""},
            "fecha_vencimiento": {"presente": false, "puntos": 0, "max": 15, "evidencia": ""},
            "consecuencias_impago": {"presente": false, "puntos": 0, "max": 20, "evidencia": ""},
            "alternativas_pago": {"presente": false, "puntos": 0, "max": 15, "evidencia": ""},
            "manejo_objeciones": {"calidad": 0, "puntos": 0, "max": 25, "objeciones_detectadas": 0}
        }
    }',
    
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    -- M√ìDULO 2: COMPROMISO DE PAGO (0-100 pts)
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    modulo_compromiso_pago JSONB NOT NULL DEFAULT '{
        "score": 0,
        "desglose": {
            "oferta_clara": {"presente": false, "puntos": 0, "max": 20},
            "alternativas_pago": {"presente": false, "puntos": 0, "max": 10},
            "fecha_especifica": {"presente": false, "puntos": 0, "max": 20, "fecha": null},
            "validacion_cliente": {"presente": false, "tipo": "ninguna", "puntos": 0, "max": 50, "frase_exacta": ""}
        }
    }',
    
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    -- M√ìDULO 3: ABANDONO
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    modulo_abandono JSONB NOT NULL DEFAULT '{
        "hubo_abandono": false,
        "momento_segundos": null,
        "iniciado_por": null,
        "razon": null,
        "senales_previas": []
    }',
    
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    -- PREDICCI√ìN DE CUMPLIMIENTO
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    probabilidad_cumplimiento INTEGER NOT NULL CHECK (probabilidad_cumplimiento >= 0 AND probabilidad_cumplimiento <= 100),
    nivel_cumplimiento nivel_cumplimiento NOT NULL,
    
    factores_prediccion JSONB DEFAULT '{
        "factores_positivos": [],
        "factores_negativos": [],
        "razonamiento": "",
        "historial_cliente_considerado": false
    }',
    
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    -- ALERTAS DETECTADAS (para Agente Detector)
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    alertas JSONB DEFAULT '[]',
    -- Array de: {tipo, codigo, mensaje, severidad}
    
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    -- RECOMENDACIONES GENERADAS
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    recomendaciones JSONB DEFAULT '[]',
    -- Array de: {prioridad, destinatario, accion, cuando}
    
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    -- METADATA DEL AN√ÅLISIS
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    modelo_usado VARCHAR(100),
    version_prompt VARCHAR(20),
    confianza_analisis DECIMAL(3,2) CHECK (confianza_analisis >= 0 AND confianza_analisis <= 1),
    tiempo_procesamiento_ms INTEGER,
    
    -- Timestamp de la llamada (denormalizado para queries r√°pidas)
    fecha_llamada DATE NOT NULL,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    
    UNIQUE(registro_id)
);

-- √çndices optimizados para las queries de los agentes
CREATE INDEX idx_analisis_registro ON analisis_llamadas(registro_id);
CREATE INDEX idx_analisis_agente ON analisis_llamadas(agente_id);
CREATE INDEX idx_analisis_score ON analisis_llamadas(score_total DESC);
CREATE INDEX idx_analisis_probabilidad ON analisis_llamadas(probabilidad_cumplimiento DESC);
CREATE INDEX idx_analisis_nivel ON analisis_llamadas(nivel_cumplimiento);
CREATE INDEX idx_analisis_fecha ON analisis_llamadas(fecha_llamada DESC);
CREATE INDEX idx_analisis_agente_fecha ON analisis_llamadas(agente_id, fecha_llamada DESC);
CREATE INDEX idx_analisis_alertas ON analisis_llamadas USING GIN (alertas);

-- Para el Agente Coach: √∫ltimos 25 an√°lisis por agente
CREATE INDEX idx_analisis_coach ON analisis_llamadas(agente_id, created_at DESC);

COMMENT ON TABLE analisis_llamadas IS 'Output del Agente Analista - Claude Opus';

-- ============================================
-- TABLE: alertas_anomalias
-- Output del AGENTE DETECTOR
-- ESCRITO POR: Agente Detector
-- LE√çDO POR: Dashboard, Agente Estratega
-- ============================================

CREATE TABLE alertas_anomalias (
    alerta_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    
    -- Clasificaci√≥n
    tipo tipo_alerta NOT NULL,
    severidad severidad_alerta NOT NULL,
    categoria VARCHAR(50), -- performance, tendencia, coaching, sistema
    codigo VARCHAR(50), -- SCORE_BAJO, ABANDONO, FALTA_VALIDACION, etc.
    
    -- Descripci√≥n
    descripcion TEXT NOT NULL,
    causa_probable TEXT,
    
    -- Datos de soporte
    datos_soporte JSONB DEFAULT '{}',
    
    -- Impacto estimado
    impacto_estimado JSONB DEFAULT '{
        "llamadas_afectadas": 0,
        "perdida_oportunidades": 0,
        "monto_en_riesgo": 0
    }',
    
    -- Acci√≥n recomendada
    accion_recomendada JSONB DEFAULT '{
        "urgencia": "hoy",
        "destinatario": "",
        "accion": "",
        "deadline": null
    }',
    
    -- Relaciones
    registro_id UUID REFERENCES registro_llamadas(registro_id), -- Si es alerta individual
    agentes_relacionados UUID[], -- Para alertas de patr√≥n
    
    -- Estado de la alerta
    estado estado_alerta DEFAULT 'nueva',
    notificacion_enviada BOOLEAN DEFAULT false,
    
    -- Resoluci√≥n
    resuelto_por UUID REFERENCES agentes(agente_id),
    fecha_resolucion TIMESTAMPTZ,
    notas_resolucion TEXT,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_alertas_severidad ON alertas_anomalias(severidad);
CREATE INDEX idx_alertas_estado ON alertas_anomalias(estado);
CREATE INDEX idx_alertas_tipo ON alertas_anomalias(tipo);
CREATE INDEX idx_alertas_fecha ON alertas_anomalias(created_at DESC);
CREATE INDEX idx_alertas_activas ON alertas_anomalias(severidad, estado) 
    WHERE estado IN ('nueva', 'en_revision');
CREATE INDEX idx_alertas_agentes ON alertas_anomalias USING GIN (agentes_relacionados);

COMMENT ON TABLE alertas_anomalias IS 'Output del Agente Detector';

-- ============================================
-- TABLE: coaching_reports
-- Output del AGENTE COACH
-- ESCRITO POR: Agente Coach (diario)
-- LE√çDO POR: Dashboard, Agente Conversacional
-- ============================================

CREATE TABLE coaching_reports (
    reporte_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    agente_id UUID NOT NULL REFERENCES agentes(agente_id) ON DELETE CASCADE,
    
    -- Per√≠odo analizado
    fecha_reporte DATE NOT NULL,
    periodo_inicio DATE NOT NULL,
    periodo_fin DATE NOT NULL,
    total_llamadas_analizadas INTEGER DEFAULT 0,
    
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    -- M√âTRICAS DEL PER√çODO
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    metricas_periodo JSONB NOT NULL DEFAULT '{
        "score_promedio": 0,
        "score_min": 0,
        "score_max": 0,
        "tasa_validacion": 0,
        "probabilidad_cumplimiento_promedio": 0,
        "tasa_abandono": 0,
        "duracion_promedio": 0
    }',
    
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    -- COMPARATIVA CON EQUIPO
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    comparativa_equipo JSONB DEFAULT '{
        "score_equipo": 0,
        "validacion_equipo": 0,
        "ranking": 0,
        "total_agentes": 0,
        "percentil": 0,
        "diferencia_vs_promedio": 0
    }',
    
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    -- AN√ÅLISIS CUALITATIVO
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    fortalezas JSONB DEFAULT '[]',
    -- Array de: {area, descripcion, evidencia, impacto}
    
    gap_critico JSONB,
    -- {area, descripcion, impacto, ejemplos_registros[], frecuencia}
    
    patrones JSONB DEFAULT '[]',
    -- Array de: {tipo, descripcion, frecuencia, impacto}
    
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    -- PLAN DE MEJORA
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    plan_mejora JSONB DEFAULT '{
        "objetivo_semana": "",
        "meta_cuantitativa": "",
        "acciones": [],
        "registros_para_revisar": [],
        "recursos_sugeridos": []
    }',
    
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    -- SEGUIMIENTO
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    progreso_vs_anterior JSONB DEFAULT '{
        "score_cambio": 0,
        "validacion_cambio": 0,
        "objetivo_anterior_cumplido": null,
        "notas": ""
    }',
    
    -- Metadata
    generado_por VARCHAR(50) DEFAULT 'agente_coach',
    modelo_usado VARCHAR(100),
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    
    UNIQUE(agente_id, fecha_reporte)
);

CREATE INDEX idx_coaching_agente ON coaching_reports(agente_id);
CREATE INDEX idx_coaching_fecha ON coaching_reports(fecha_reporte DESC);
CREATE INDEX idx_coaching_agente_fecha ON coaching_reports(agente_id, fecha_reporte DESC);

COMMENT ON TABLE coaching_reports IS 'Output del Agente Coach - Diario 08:00';

-- ============================================
-- TABLE: reportes_estrategia
-- Output del AGENTE ESTRATEGA
-- ESCRITO POR: Agente Estratega (semanal)
-- LE√çDO POR: Dashboard, Agente Conversacional
-- ============================================

CREATE TABLE reportes_estrategia (
    reporte_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    
    -- Per√≠odo
    fecha_reporte DATE NOT NULL,
    semana_numero INTEGER,
    periodo_inicio DATE NOT NULL,
    periodo_fin DATE NOT NULL,
    
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    -- RESUMEN EJECUTIVO
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    resumen_ejecutivo JSONB NOT NULL DEFAULT '{
        "total_llamadas": 0,
        "total_agentes_activos": 0,
        "score_promedio": 0,
        "cambio_vs_anterior": 0,
        "tasa_validacion": 0,
        "probabilidad_cumplimiento_promedio": 0,
        "monto_comprometido": 0,
        "logros": [],
        "preocupaciones": []
    }',
    
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    -- HALLAZGOS ESTRAT√âGICOS
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    hallazgos_estrategicos JSONB DEFAULT '[]',
    -- Array de: {titulo, categoria, descripcion, hipotesis, recomendacion, impacto_proyectado, confianza}
    
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    -- AN√ÅLISIS TEMPORAL
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    analisis_temporal JSONB DEFAULT '{
        "mejor_dia": "",
        "mejor_dia_score": 0,
        "peor_dia": "",
        "peor_dia_score": 0,
        "mejor_hora": "",
        "mejor_hora_score": 0,
        "tendencias_por_dia": [],
        "tendencias_por_hora": []
    }',
    
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    -- AN√ÅLISIS DE EQUIPO
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    top_performers JSONB DEFAULT '[]',
    -- Array de: {agente_id, nombre, score, patron_clave, recomendacion}
    
    agentes_en_riesgo JSONB DEFAULT '[]',
    -- Array de: {agente_id, nombre, score, gap_principal, accion_urgente}
    
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    -- AN√ÅLISIS DE SCRIPTS/CAMPA√ëAS
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    analisis_campanas JSONB DEFAULT '[]',
    -- Array de: {campana, llamadas, score_promedio, insights, recomendaciones}
    
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    -- RECOMENDACIONES ESTRAT√âGICAS
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    recomendaciones_estrategicas JSONB DEFAULT '[]',
    -- Array de: {prioridad, area, recomendacion, impacto_esperado, recursos_necesarios, deadline}
    
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    -- PROYECCIONES
    -- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    proyecciones JSONB DEFAULT '{
        "score_proyectado_siguiente_semana": 0,
        "cumplimiento_proyectado": 0,
        "riesgos_identificados": [],
        "oportunidades": []
    }',
    
    -- Metadata
    generado_por VARCHAR(50) DEFAULT 'agente_estratega',
    modelo_usado VARCHAR(100),
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    
    UNIQUE(fecha_reporte)
);

CREATE INDEX idx_estrategia_fecha ON reportes_estrategia(fecha_reporte DESC);
CREATE INDEX idx_estrategia_semana ON reportes_estrategia(semana_numero DESC);

COMMENT ON TABLE reportes_estrategia IS 'Output del Agente Estratega - Semanal DOM 22:00';

-- ============================================
-- TABLE: metricas_agregadas
-- M√©tricas pre-calculadas para queries r√°pidas
-- ACTUALIZADO POR: Cron o post-an√°lisis
-- LE√çDO POR: Dashboard, Todos los agentes
-- ============================================

CREATE TABLE metricas_agregadas (
    metrica_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    
    -- Dimensiones
    fecha DATE NOT NULL,
    agente_id UUID REFERENCES agentes(agente_id), -- NULL = m√©tricas globales
    equipo VARCHAR(100),
    campana VARCHAR(100),
    
    -- M√©tricas de volumen
    total_llamadas INTEGER DEFAULT 0,
    duracion_total_segundos INTEGER DEFAULT 0,
    duracion_promedio_segundos INTEGER DEFAULT 0,
    
    -- M√©tricas de score
    score_promedio DECIMAL(5,2),
    score_min INTEGER,
    score_max INTEGER,
    desviacion_estandar DECIMAL(5,2),
    
    -- M√©tricas de cumplimiento
    probabilidad_cumplimiento_promedio DECIMAL(5,2),
    tasa_validacion DECIMAL(5,4),
    
    -- Distribuci√≥n por nivel
    llamadas_score_alto INTEGER DEFAULT 0, -- >= 70
    llamadas_score_medio INTEGER DEFAULT 0, -- 40-69
    llamadas_score_bajo INTEGER DEFAULT 0, -- < 40
    
    -- M√©tricas de abandono
    llamadas_con_abandono INTEGER DEFAULT 0,
    tasa_abandono DECIMAL(5,4),
    
    -- Alertas
    alertas_criticas INTEGER DEFAULT 0,
    alertas_altas INTEGER DEFAULT 0,
    alertas_medias INTEGER DEFAULT 0,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- √çndice √∫nico parcial para evitar duplicados (m√©tricas por agente)
CREATE UNIQUE INDEX idx_metricas_agente_unique ON metricas_agregadas(fecha, agente_id) 
    WHERE agente_id IS NOT NULL AND equipo IS NULL AND campana IS NULL;

-- √çndice √∫nico parcial (m√©tricas por equipo)
CREATE UNIQUE INDEX idx_metricas_equipo_unique ON metricas_agregadas(fecha, equipo) 
    WHERE agente_id IS NULL AND equipo IS NOT NULL AND campana IS NULL;

-- √çndice √∫nico parcial (m√©tricas globales)
CREATE UNIQUE INDEX idx_metricas_global_unique ON metricas_agregadas(fecha) 
    WHERE agente_id IS NULL AND equipo IS NULL AND campana IS NULL;

CREATE INDEX idx_metricas_fecha ON metricas_agregadas(fecha DESC);
CREATE INDEX idx_metricas_agente ON metricas_agregadas(agente_id, fecha DESC);
CREATE INDEX idx_metricas_equipo ON metricas_agregadas(equipo, fecha DESC);

COMMENT ON TABLE metricas_agregadas IS 'M√©tricas pre-calculadas para dashboard r√°pido';

-- ============================================
-- FUNCTIONS
-- ============================================

-- Actualizar updated_at autom√°ticamente
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

-- Funci√≥n para calcular duraci√≥n y fecha
CREATE OR REPLACE FUNCTION calculate_registro_campos()
RETURNS TRIGGER AS $$
BEGIN
    -- Calcular duraci√≥n en segundos
    IF NEW.timestamp_inicio IS NOT NULL AND NEW.timestamp_fin IS NOT NULL THEN
        NEW.duracion_segundos := EXTRACT(EPOCH FROM (NEW.timestamp_fin - NEW.timestamp_inicio))::INTEGER;
    END IF;
    
    -- Calcular fecha (usando UTC para consistencia)
    IF NEW.timestamp_inicio IS NOT NULL THEN
        NEW.timestamp_fecha := (NEW.timestamp_inicio AT TIME ZONE 'UTC')::DATE;
    END IF;
    
    RETURN NEW;
END;
$$ language 'plpgsql';

-- Triggers
CREATE TRIGGER update_agentes_updated_at BEFORE UPDATE ON agentes
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_registro_updated_at BEFORE UPDATE ON registro_llamadas
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER calculate_registro_campos BEFORE INSERT OR UPDATE ON registro_llamadas
    FOR EACH ROW EXECUTE FUNCTION calculate_registro_campos();

CREATE TRIGGER update_alertas_updated_at BEFORE UPDATE ON alertas_anomalias
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- ============================================
-- FOREIGN KEY: Actualizar referencias en registro_llamadas
-- ============================================

ALTER TABLE registro_llamadas 
ADD CONSTRAINT fk_registro_transcripcion 
FOREIGN KEY (transcripcion_id) REFERENCES transcripciones(transcripcion_id);

ALTER TABLE registro_llamadas 
ADD CONSTRAINT fk_registro_analisis 
FOREIGN KEY (analisis_id) REFERENCES analisis_llamadas(analisis_id);

-- ============================================
-- VIEWS
-- ============================================

-- Vista: Resumen de agente (para dashboard)
CREATE OR REPLACE VIEW vista_resumen_agentes AS
SELECT 
    ag.agente_id,
    ag.nombre,
    ag.equipo,
    ag.estado,
    COUNT(a.analisis_id) FILTER (WHERE a.fecha_llamada >= CURRENT_DATE - INTERVAL '7 days') as llamadas_semana,
    ROUND(AVG(a.score_total) FILTER (WHERE a.fecha_llamada >= CURRENT_DATE - INTERVAL '7 days'), 2) as score_semana,
    ROUND(AVG(a.probabilidad_cumplimiento) FILTER (WHERE a.fecha_llamada >= CURRENT_DATE - INTERVAL '7 days'), 2) as prob_cumplimiento_semana,
    (
        SELECT cr.metricas_periodo->>'tasa_validacion'
        FROM coaching_reports cr 
        WHERE cr.agente_id = ag.agente_id 
        ORDER BY cr.fecha_reporte DESC 
        LIMIT 1
    )::DECIMAL as tasa_validacion_ultimo_reporte
FROM agentes ag
LEFT JOIN analisis_llamadas a ON ag.agente_id = a.agente_id
WHERE ag.estado = 'activo'
GROUP BY ag.agente_id, ag.nombre, ag.equipo, ag.estado;

COMMENT ON VIEW vista_resumen_agentes IS 'Resumen r√°pido de agentes para dashboard';

-- ============================================
-- ROW LEVEL SECURITY
-- Deshabilitado por ahora - habilitar seg√∫n necesidad
-- ============================================

-- Para habilitar RLS en el futuro:
-- ALTER TABLE agentes ENABLE ROW LEVEL SECURITY;
-- ALTER TABLE registro_llamadas ENABLE ROW LEVEL SECURITY;
-- etc.

-- ============================================
-- FIN DEL SCHEMA v2
-- ============================================
</file>

<file path="supabase/seeds.sql">
-- ============================================
-- NODUS - Seed Data for Development
-- Datos de prueba para desarrollo
-- ============================================

-- ============================================
-- AGENTES DE PRUEBA
-- ============================================

INSERT INTO agentes (agente_id, nombre, email, estado, equipo, fecha_ingreso, codigo_externo) VALUES
    ('a0000000-0000-0000-0000-000000000001', 'Carlos Ram√≠rez', 'carlos.ramirez@360.com', 'activo', 'Equipo A', '2025-01-15', 'EXT-001'),
    ('a0000000-0000-0000-0000-000000000002', 'Mar√≠a Gonz√°lez', 'maria.gonzalez@360.com', 'activo', 'Equipo A', '2025-02-01', 'EXT-002'),
    ('a0000000-0000-0000-0000-000000000003', 'Jos√© P√©rez', 'jose.perez@360.com', 'activo', 'Equipo B', '2025-02-15', 'EXT-003'),
    ('a0000000-0000-0000-0000-000000000004', 'Ana Mart√≠nez', 'ana.martinez@360.com', 'activo', 'Equipo B', '2025-03-01', 'EXT-004'),
    ('a0000000-0000-0000-0000-000000000005', 'Luis Torres', 'luis.torres@360.com', 'activo', 'Equipo A', '2025-01-20', 'EXT-005'),
    ('a0000000-0000-0000-0000-000000000006', 'Fernando Urbano', 'fernando@360consultores.com', 'activo', 'Administraci√≥n', '2024-01-01', 'EXT-ADMIN')
ON CONFLICT (agente_id) DO NOTHING;

-- Supervisor
UPDATE agentes SET supervisor_id = 'a0000000-0000-0000-0000-000000000006' 
WHERE agente_id IN ('a0000000-0000-0000-0000-000000000001', 'a0000000-0000-0000-0000-000000000002', 'a0000000-0000-0000-0000-000000000005');

-- ============================================
-- REGISTRO DE LLAMADAS DE PRUEBA
-- ============================================

INSERT INTO registro_llamadas (registro_id, audio_url, audio_id_externo, timestamp_inicio, timestamp_fin, agente_id, cliente_ref, campana, tipo_deuda, monto_deuda, dias_mora, estado) VALUES
    ('r0000000-0000-0000-0000-000000000001', 'https://storage.externo.com/audio1.mp3', 'CALL-001', NOW() - INTERVAL '2 hours', NOW() - INTERVAL '2 hours' + INTERVAL '245 seconds', 'a0000000-0000-0000-0000-000000000002', 'CL-45632', 'Recuperaci√≥n Q1', 'Tarjeta de cr√©dito', 1450.00, 45, 'analizado'),
    ('r0000000-0000-0000-0000-000000000002', 'https://storage.externo.com/audio2.mp3', 'CALL-002', NOW() - INTERVAL '3 hours', NOW() - INTERVAL '3 hours' + INTERVAL '312 seconds', 'a0000000-0000-0000-0000-000000000001', 'CL-78901', 'Recuperaci√≥n Q1', 'Pr√©stamo personal', 3200.00, 30, 'analizado'),
    ('r0000000-0000-0000-0000-000000000003', 'https://storage.externo.com/audio3.mp3', 'CALL-003', NOW() - INTERVAL '4 hours', NOW() - INTERVAL '4 hours' + INTERVAL '189 seconds', 'a0000000-0000-0000-0000-000000000003', 'CL-23456', 'Gesti√≥n temprana', 'Tarjeta de cr√©dito', 890.00, 15, 'analizado'),
    ('r0000000-0000-0000-0000-000000000004', 'https://storage.externo.com/audio4.mp3', 'CALL-004', NOW() - INTERVAL '5 hours', NOW() - INTERVAL '5 hours' + INTERVAL '156 seconds', 'a0000000-0000-0000-0000-000000000002', 'CL-34567', 'Recuperaci√≥n Q1', 'Pr√©stamo personal', 5600.00, 60, 'analizado'),
    ('r0000000-0000-0000-0000-000000000005', 'https://storage.externo.com/audio5.mp3', 'CALL-005', NOW() - INTERVAL '6 hours', NOW() - INTERVAL '6 hours' + INTERVAL '278 seconds', 'a0000000-0000-0000-0000-000000000004', 'CL-89012', 'Gesti√≥n temprana', 'Tarjeta de cr√©dito', 2100.00, 20, 'transcrito')
ON CONFLICT (registro_id) DO NOTHING;

-- ============================================
-- TRANSCRIPCIONES DE PRUEBA
-- ============================================

INSERT INTO transcripciones (transcripcion_id, registro_id, transcripcion_completa, segmentos, entidades, metricas_conversacion, modelo_transcripcion, tiempo_procesamiento_ms) VALUES
    ('t0000000-0000-0000-0000-000000000001', 
     'r0000000-0000-0000-0000-000000000001', 
     'Buenos d√≠as, ¬øhablo con el se√±or Garc√≠a? S√≠, soy yo. Le llamo del √°rea de recuperaci√≥n para hablarle sobre su saldo vencido de 1,450 soles en su tarjeta de cr√©dito. El vencimiento fue el 15 de diciembre. Entiendo, ¬øqu√© opciones tengo? Puede pagar por nuestra web, app m√≥vil o en cualquier agencia. Le sugiero regularizar antes del 15 de febrero para evitar intereses adicionales. Ok, entiendo, lo voy a revisar.',
     '[
        {"speaker": "agente", "timestamp_inicio": 0, "timestamp_fin": 3, "texto": "Buenos d√≠as, ¬øhablo con el se√±or Garc√≠a?", "emocion": "neutral", "velocidad_habla": 145},
        {"speaker": "cliente", "timestamp_inicio": 3, "timestamp_fin": 5, "texto": "S√≠, soy yo. ¬øDe d√≥nde me llama?", "emocion": "neutral", "velocidad_habla": 140},
        {"speaker": "agente", "timestamp_inicio": 5, "timestamp_fin": 15, "texto": "Le llamo del √°rea de recuperaci√≥n para hablarle sobre su saldo vencido de 1,450 soles en su tarjeta de cr√©dito. El vencimiento fue el 15 de diciembre.", "emocion": "neutral", "velocidad_habla": 150},
        {"speaker": "cliente", "timestamp_inicio": 15, "timestamp_fin": 18, "texto": "Entiendo, ¬øqu√© opciones tengo?", "emocion": "neutral", "velocidad_habla": 135},
        {"speaker": "agente", "timestamp_inicio": 18, "timestamp_fin": 30, "texto": "Puede pagar por nuestra web, app m√≥vil o en cualquier agencia. Le sugiero regularizar antes del 15 de febrero para evitar intereses adicionales.", "emocion": "positivo", "velocidad_habla": 148},
        {"speaker": "cliente", "timestamp_inicio": 30, "timestamp_fin": 35, "texto": "Ok, entiendo, lo voy a revisar.", "emocion": "neutral", "velocidad_habla": 130}
     ]'::jsonb,
     '{
        "montos": [{"valor": 1450, "moneda": "PEN", "contexto": "deuda_principal"}],
        "fechas": [{"fecha": "2025-12-15", "contexto": "vencimiento"}, {"fecha": "2026-02-15", "contexto": "compromiso_sugerido"}],
        "metodos_pago": ["web", "app", "agencia"],
        "objeciones": [],
        "compromisos": [{"tipo": "implicito", "fecha": "2026-02-15", "monto": 1450}]
     }'::jsonb,
     '{
        "palabras_agente": 65,
        "palabras_cliente": 18,
        "ratio_habla": 0.78,
        "interrupciones": 0,
        "silencios_largos": 0,
        "velocidad_promedio_agente": 148,
        "velocidad_promedio_cliente": 135
     }'::jsonb,
     'whisper-large-v3',
     45000
    ),
    ('t0000000-0000-0000-0000-000000000002', 
     'r0000000-0000-0000-0000-000000000002', 
     'Buenos d√≠as se√±or Rodr√≠guez. Le llamo por su pr√©stamo personal con saldo de 3,200 soles vencido hace 30 d√≠as. Necesitamos regularizar esta situaci√≥n. S√≠, he tenido problemas econ√≥micos. Entiendo su situaci√≥n, ¬øpodr√≠a realizar un pago parcial de al menos 1,000 soles esta semana? S√≠, puedo hacer eso el viernes. Perfecto, ¬øme confirma que pagar√° 1,000 soles este viernes 31? S√≠, confirmo que pagar√© el viernes. Excelente, queda registrado.',
     '[
        {"speaker": "agente", "timestamp_inicio": 0, "timestamp_fin": 12, "texto": "Buenos d√≠as se√±or Rodr√≠guez. Le llamo por su pr√©stamo personal con saldo de 3,200 soles vencido hace 30 d√≠as. Necesitamos regularizar esta situaci√≥n.", "emocion": "neutral", "velocidad_habla": 152},
        {"speaker": "cliente", "timestamp_inicio": 12, "timestamp_fin": 16, "texto": "S√≠, he tenido problemas econ√≥micos.", "emocion": "negativo", "velocidad_habla": 125},
        {"speaker": "agente", "timestamp_inicio": 16, "timestamp_fin": 25, "texto": "Entiendo su situaci√≥n, ¬øpodr√≠a realizar un pago parcial de al menos 1,000 soles esta semana?", "emocion": "positivo", "velocidad_habla": 145},
        {"speaker": "cliente", "timestamp_inicio": 25, "timestamp_fin": 30, "texto": "S√≠, puedo hacer eso el viernes.", "emocion": "neutral", "velocidad_habla": 130},
        {"speaker": "agente", "timestamp_inicio": 30, "timestamp_fin": 38, "texto": "Perfecto, ¬øme confirma que pagar√° 1,000 soles este viernes 31?", "emocion": "neutral", "velocidad_habla": 150},
        {"speaker": "cliente", "timestamp_inicio": 38, "timestamp_fin": 42, "texto": "S√≠, confirmo que pagar√© el viernes.", "emocion": "positivo", "velocidad_habla": 140},
        {"speaker": "agente", "timestamp_inicio": 42, "timestamp_fin": 45, "texto": "Excelente, queda registrado.", "emocion": "positivo", "velocidad_habla": 145}
     ]'::jsonb,
     '{
        "montos": [{"valor": 3200, "moneda": "PEN", "contexto": "deuda_principal"}, {"valor": 1000, "moneda": "PEN", "contexto": "pago_parcial"}],
        "fechas": [{"fecha": "2026-01-31", "contexto": "compromiso_pago"}],
        "metodos_pago": [],
        "objeciones": [{"tipo": "economica", "texto": "problemas econ√≥micos", "manejada": true}],
        "compromisos": [{"tipo": "explicito", "fecha": "2026-01-31", "monto": 1000, "validacion": "S√≠, confirmo que pagar√© el viernes"}]
     }'::jsonb,
     '{
        "palabras_agente": 58,
        "palabras_cliente": 22,
        "ratio_habla": 0.72,
        "interrupciones": 0,
        "silencios_largos": 0,
        "velocidad_promedio_agente": 148,
        "velocidad_promedio_cliente": 132
     }'::jsonb,
     'whisper-large-v3',
     52000
    ),
    ('t0000000-0000-0000-0000-000000000003', 
     'r0000000-0000-0000-0000-000000000003', 
     'Buenas tardes, ¬øse√±ora L√≥pez? S√≠, d√≠game. Le llamo por su tarjeta con saldo de 890 soles. No me interesa, estoy ocupada. Entiendo, solo le tomar√© un minuto. No, no tengo tiempo, adi√≥s.',
     '[
        {"speaker": "agente", "timestamp_inicio": 0, "timestamp_fin": 4, "texto": "Buenas tardes, ¬øse√±ora L√≥pez?", "emocion": "neutral", "velocidad_habla": 140},
        {"speaker": "cliente", "timestamp_inicio": 4, "timestamp_fin": 6, "texto": "S√≠, d√≠game.", "emocion": "neutral", "velocidad_habla": 130},
        {"speaker": "agente", "timestamp_inicio": 6, "timestamp_fin": 12, "texto": "Le llamo por su tarjeta con saldo de 890 soles.", "emocion": "neutral", "velocidad_habla": 145},
        {"speaker": "cliente", "timestamp_inicio": 12, "timestamp_fin": 16, "texto": "No me interesa, estoy ocupada.", "emocion": "negativo", "velocidad_habla": 155},
        {"speaker": "agente", "timestamp_inicio": 16, "timestamp_fin": 20, "texto": "Entiendo, solo le tomar√© un minuto.", "emocion": "neutral", "velocidad_habla": 140},
        {"speaker": "cliente", "timestamp_inicio": 20, "timestamp_fin": 24, "texto": "No, no tengo tiempo, adi√≥s.", "emocion": "negativo", "velocidad_habla": 160}
     ]'::jsonb,
     '{
        "montos": [{"valor": 890, "moneda": "PEN", "contexto": "deuda_principal"}],
        "fechas": [],
        "metodos_pago": [],
        "objeciones": [{"tipo": "tiempo", "texto": "estoy ocupada", "manejada": false}],
        "compromisos": []
     }'::jsonb,
     '{
        "palabras_agente": 22,
        "palabras_cliente": 14,
        "ratio_habla": 0.61,
        "interrupciones": 1,
        "silencios_largos": 0,
        "velocidad_promedio_agente": 142,
        "velocidad_promedio_cliente": 148
     }'::jsonb,
     'whisper-large-v3',
     28000
    )
ON CONFLICT (registro_id) DO NOTHING;

-- Actualizar registro_llamadas con transcripcion_id
UPDATE registro_llamadas SET transcripcion_id = 't0000000-0000-0000-0000-000000000001' WHERE registro_id = 'r0000000-0000-0000-0000-000000000001';
UPDATE registro_llamadas SET transcripcion_id = 't0000000-0000-0000-0000-000000000002' WHERE registro_id = 'r0000000-0000-0000-0000-000000000002';
UPDATE registro_llamadas SET transcripcion_id = 't0000000-0000-0000-0000-000000000003' WHERE registro_id = 'r0000000-0000-0000-0000-000000000003';

-- ============================================
-- AN√ÅLISIS DE PRUEBA
-- ============================================

INSERT INTO analisis_llamadas (
    analisis_id, registro_id, transcripcion_id, agente_id,
    score_total, score_contacto_directo, score_compromiso_pago,
    modulo_contacto_directo, modulo_compromiso_pago, modulo_abandono,
    probabilidad_cumplimiento, nivel_cumplimiento, factores_prediccion,
    alertas, recomendaciones,
    modelo_usado, confianza_analisis, fecha_llamada
) VALUES
    -- Llamada 1: Score medio con alerta de validaci√≥n
    ('an000000-0000-0000-0000-000000000001',
     'r0000000-0000-0000-0000-000000000001',
     't0000000-0000-0000-0000-000000000001',
     'a0000000-0000-0000-0000-000000000002',
     72, 85, 58,
     '{
        "score": 85,
        "desglose": {
            "monto_mencionado": {"presente": true, "puntos": 25, "max": 25, "evidencia": "su saldo vencido de 1,450 soles"},
            "fecha_vencimiento": {"presente": true, "puntos": 15, "max": 15, "evidencia": "vencimiento fue el 15 de diciembre"},
            "consecuencias_impago": {"presente": true, "puntos": 12, "max": 20, "evidencia": "evitar intereses adicionales"},
            "alternativas_pago": {"presente": true, "puntos": 15, "max": 15, "evidencia": "web, app m√≥vil o agencia"},
            "manejo_objeciones": {"calidad": 0.8, "puntos": 18, "max": 25, "objeciones_detectadas": 0}
        }
     }'::jsonb,
     '{
        "score": 58,
        "desglose": {
            "oferta_clara": {"presente": true, "puntos": 20, "max": 20},
            "alternativas_pago": {"presente": true, "puntos": 10, "max": 10},
            "fecha_especifica": {"presente": true, "puntos": 20, "max": 20, "fecha": "2026-02-15"},
            "validacion_cliente": {"presente": false, "tipo": "implicita", "puntos": 8, "max": 50, "frase_exacta": "lo voy a revisar"}
        }
     }'::jsonb,
     '{"hubo_abandono": false}'::jsonb,
     58, 'media',
     '{
        "factores_positivos": ["Fecha espec√≠fica acordada", "Buena explicaci√≥n de alternativas", "Monto claramente comunicado"],
        "factores_negativos": ["Falta validaci√≥n expl√≠cita (-30pts)", "Cliente no confirm√≥ compromiso"],
        "razonamiento": "Aunque hay fecha clara y alternativas bien explicadas, la ausencia de validaci√≥n expl√≠cita reduce significativamente la probabilidad de cumplimiento.",
        "historial_cliente_considerado": false
     }'::jsonb,
     '[{"tipo": "advertencia", "codigo": "FALTA_VALIDACION", "mensaje": "Cliente NO valid√≥ expl√≠citamente el compromiso de pago", "severidad": "alta"}]'::jsonb,
     '[{"prioridad": "alta", "destinatario": "supervisor", "accion": "Llamar en 48hrs para reforzar compromiso con validaci√≥n expl√≠cita", "cuando": "antes de fecha compromiso"}]'::jsonb,
     'claude-opus-4-5-20250514',
     0.89,
     CURRENT_DATE
    ),
    -- Llamada 2: Score alto con validaci√≥n
    ('an000000-0000-0000-0000-000000000002',
     'r0000000-0000-0000-0000-000000000002',
     't0000000-0000-0000-0000-000000000002',
     'a0000000-0000-0000-0000-000000000001',
     89, 92, 86,
     '{
        "score": 92,
        "desglose": {
            "monto_mencionado": {"presente": true, "puntos": 25, "max": 25, "evidencia": "3,200 soles"},
            "fecha_vencimiento": {"presente": true, "puntos": 15, "max": 15, "evidencia": "vencido hace 30 d√≠as"},
            "consecuencias_impago": {"presente": true, "puntos": 18, "max": 20, "evidencia": "necesitamos regularizar"},
            "alternativas_pago": {"presente": true, "puntos": 12, "max": 15, "evidencia": "pago parcial"},
            "manejo_objeciones": {"calidad": 0.92, "puntos": 22, "max": 25, "objeciones_detectadas": 1}
        }
     }'::jsonb,
     '{
        "score": 86,
        "desglose": {
            "oferta_clara": {"presente": true, "puntos": 20, "max": 20},
            "alternativas_pago": {"presente": true, "puntos": 8, "max": 10},
            "fecha_especifica": {"presente": true, "puntos": 20, "max": 20, "fecha": "2026-01-31"},
            "validacion_cliente": {"presente": true, "tipo": "explicita", "puntos": 38, "max": 50, "frase_exacta": "S√≠, confirmo que pagar√© el viernes"}
        }
     }'::jsonb,
     '{"hubo_abandono": false}'::jsonb,
     82, 'alta',
     '{
        "factores_positivos": ["Validaci√≥n EXPL√çCITA obtenida", "Fecha espec√≠fica confirmada", "Monto acordado", "Excelente manejo de objeci√≥n econ√≥mica"],
        "factores_negativos": ["Historial desconocido"],
        "razonamiento": "Alta probabilidad por validaci√≥n expl√≠cita clara. Cliente confirm√≥ verbalmente el compromiso de pago.",
        "historial_cliente_considerado": false
     }'::jsonb,
     '[]'::jsonb,
     '[{"prioridad": "baja", "destinatario": "sistema", "accion": "Enviar recordatorio SMS 1 d√≠a antes", "cuando": "2026-01-30"}]'::jsonb,
     'claude-opus-4-5-20250514',
     0.94,
     CURRENT_DATE
    ),
    -- Llamada 3: Score bajo con abandono
    ('an000000-0000-0000-0000-000000000003',
     'r0000000-0000-0000-0000-000000000003',
     't0000000-0000-0000-0000-000000000003',
     'a0000000-0000-0000-0000-000000000003',
     34, 45, 22,
     '{
        "score": 45,
        "desglose": {
            "monto_mencionado": {"presente": true, "puntos": 25, "max": 25, "evidencia": "890 soles"},
            "fecha_vencimiento": {"presente": false, "puntos": 0, "max": 15, "evidencia": ""},
            "consecuencias_impago": {"presente": false, "puntos": 0, "max": 20, "evidencia": ""},
            "alternativas_pago": {"presente": false, "puntos": 0, "max": 15, "evidencia": ""},
            "manejo_objeciones": {"calidad": 0.3, "puntos": 20, "max": 25, "objeciones_detectadas": 1}
        }
     }'::jsonb,
     '{
        "score": 22,
        "desglose": {
            "oferta_clara": {"presente": false, "puntos": 0, "max": 20},
            "alternativas_pago": {"presente": false, "puntos": 0, "max": 10},
            "fecha_especifica": {"presente": false, "puntos": 0, "max": 20, "fecha": null},
            "validacion_cliente": {"presente": false, "tipo": "ninguna", "puntos": 0, "max": 50, "frase_exacta": ""}
        }
     }'::jsonb,
     '{"hubo_abandono": true, "momento_segundos": 24, "iniciado_por": "cliente", "razon": "Cliente colg√≥ por falta de tiempo", "senales_previas": ["tono negativo", "respuestas cortas"]}'::jsonb,
     12, 'baja',
     '{
        "factores_positivos": [],
        "factores_negativos": ["Abandono de llamada", "Sin compromiso establecido", "Cliente frustrado", "Objeci√≥n no manejada efectivamente"],
        "razonamiento": "Muy baja probabilidad por abandono temprano. Cliente no mostr√≥ inter√©s y el agente no logr√≥ retener la conversaci√≥n.",
        "historial_cliente_considerado": false
     }'::jsonb,
     '[
        {"tipo": "critica", "codigo": "ABANDONO_LLAMADA", "mensaje": "Cliente abandon√≥ la llamada frustrado", "severidad": "critica"},
        {"tipo": "critica", "codigo": "SCORE_BAJO", "mensaje": "Score muy por debajo del umbral (34/100)", "severidad": "alta"}
     ]'::jsonb,
     '[
        {"prioridad": "alta", "destinatario": "supervisor", "accion": "Reasignar cliente a agente senior", "cuando": "hoy"},
        {"prioridad": "alta", "destinatario": "agente", "accion": "Revisar llamada con supervisor para feedback", "cuando": "ma√±ana"}
     ]'::jsonb,
     'claude-opus-4-5-20250514',
     0.91,
     CURRENT_DATE
    )
ON CONFLICT (registro_id) DO NOTHING;

-- Actualizar registro_llamadas con analisis_id
UPDATE registro_llamadas SET analisis_id = 'an000000-0000-0000-0000-000000000001' WHERE registro_id = 'r0000000-0000-0000-0000-000000000001';
UPDATE registro_llamadas SET analisis_id = 'an000000-0000-0000-0000-000000000002' WHERE registro_id = 'r0000000-0000-0000-0000-000000000002';
UPDATE registro_llamadas SET analisis_id = 'an000000-0000-0000-0000-000000000003' WHERE registro_id = 'r0000000-0000-0000-0000-000000000003';

-- ============================================
-- ALERTAS DE PRUEBA
-- ============================================

INSERT INTO alertas_anomalias (
    tipo, severidad, categoria, codigo, descripcion, causa_probable,
    impacto_estimado, accion_recomendada, agentes_relacionados, registro_id, estado
) VALUES
    ('individual', 'critica', 'performance', 'SCORE_BAJO',
     'Score cr√≠tico en llamada de Jos√© P√©rez (34/100). Cliente abandon√≥ frustrado.',
     'Mal manejo de objeciones y falta de t√©cnica de retenci√≥n',
     '{"llamadas_afectadas": 1, "perdida_oportunidades": 1, "monto_en_riesgo": 890}'::jsonb,
     '{"urgencia": "inmediata", "destinatario": "supervisor", "accion": "Revisar llamada y dar feedback al agente", "deadline": null}'::jsonb,
     ARRAY['a0000000-0000-0000-0000-000000000003']::UUID[],
     'r0000000-0000-0000-0000-000000000003',
     'nueva'
    ),
    ('sistemica', 'alta', 'tendencia', 'VALIDACION_BAJA',
     'Tasa de validaci√≥n cay√≥ 15% en las √∫ltimas 4 horas comparado con ayer.',
     'Posible cambio en script o perfil de clientes contactados',
     '{"llamadas_afectadas": 15, "perdida_oportunidades": 8, "monto_en_riesgo": 12500}'::jsonb,
     '{"urgencia": "hoy", "destinatario": "supervisor", "accion": "Revisar las √∫ltimas 10 llamadas sin validaci√≥n", "deadline": null}'::jsonb,
     NULL,
     NULL,
     'nueva'
    ),
    ('patron', 'media', 'coaching', 'GAP_VALIDACION',
     'Mar√≠a Gonz√°lez no logra validaci√≥n expl√≠cita en 68% de sus llamadas esta semana.',
     'Gap en t√©cnica de cierre - no usa preguntas de confirmaci√≥n',
     '{"llamadas_afectadas": 17, "perdida_oportunidades": 6, "monto_en_riesgo": 8500}'::jsonb,
     '{"urgencia": "esta_semana", "destinatario": "supervisor", "accion": "Sesi√≥n de coaching sobre t√©cnica de cierre", "deadline": null}'::jsonb,
     ARRAY['a0000000-0000-0000-0000-000000000002']::UUID[],
     NULL,
     'en_revision'
    );

-- ============================================
-- COACHING REPORT DE PRUEBA
-- ============================================

INSERT INTO coaching_reports (
    agente_id, fecha_reporte, periodo_inicio, periodo_fin, total_llamadas_analizadas,
    metricas_periodo, comparativa_equipo, fortalezas, gap_critico, plan_mejora, progreso_vs_anterior
) VALUES
    ('a0000000-0000-0000-0000-000000000002',
     CURRENT_DATE,
     CURRENT_DATE - INTERVAL '5 days',
     CURRENT_DATE,
     23,
     '{
        "score_promedio": 72,
        "score_min": 58,
        "score_max": 85,
        "tasa_validacion": 0.32,
        "probabilidad_cumplimiento_promedio": 48,
        "tasa_abandono": 0.04,
        "duracion_promedio": 245
     }'::jsonb,
     '{
        "score_equipo": 78,
        "validacion_equipo": 0.61,
        "ranking": 8,
        "total_agentes": 12,
        "percentil": 65,
        "diferencia_vs_promedio": -6
     }'::jsonb,
     '[
        {
            "area": "manejo_objeciones",
            "descripcion": "Excelente t√©cnica de empat√≠a al escuchar problemas del cliente",
            "evidencia": "92% de objeciones bien manejadas en las llamadas analizadas",
            "impacto": "Reduce abandono en 15%"
        },
        {
            "area": "comunicacion_alternativas",
            "descripcion": "Siempre presenta m√∫ltiples opciones de pago",
            "evidencia": "100% de llamadas incluyen alternativas",
            "impacto": "Aumenta flexibilidad percibida"
        }
     ]'::jsonb,
     '{
        "area": "validacion_cliente",
        "descripcion": "En 18 de 25 llamadas (72%) no logra validaci√≥n expl√≠cita del compromiso",
        "impacto": "Reduce cumplimiento real en aproximadamente 35%",
        "ejemplos_registros": ["r0000000-0000-0000-0000-000000000001"],
        "frecuencia": "Casi todas las llamadas"
     }'::jsonb,
     '{
        "objetivo_semana": "Lograr validaci√≥n expl√≠cita en m√°s del 75% de los compromisos",
        "meta_cuantitativa": "Subir tasa de validaci√≥n de 32% a 75%",
        "acciones": [
            {
                "accion": "Role-play de t√©cnica de cierre",
                "como": "15 minutos diarios con supervisor usando el script de confirmaci√≥n",
                "prioridad": "alta",
                "duracion": "15 min/d√≠a"
            },
            {
                "accion": "Revisar 3 llamadas exitosas de Carlos Ram√≠rez",
                "como": "Observar c√≥mo obtiene validaci√≥n de forma natural",
                "prioridad": "media",
                "duracion": "30 min total"
            },
            {
                "accion": "Usar frase est√°ndar de cierre",
                "como": "Al final de cada compromiso preguntar: ¬øMe confirma que realizar√° el pago de X soles el d√≠a Y?",
                "prioridad": "alta",
                "duracion": "En cada llamada"
            }
        ],
        "registros_para_revisar": [
            {
                "registro_id": "r0000000-0000-0000-0000-000000000001",
                "razon": "ejemplo_negativo",
                "que_observar": "Momento donde cliente dice ok pero no valida expl√≠citamente"
            }
        ],
        "recursos_sugeridos": ["Video: T√©cnicas de cierre efectivas", "Documento: Frases de validaci√≥n"]
     }'::jsonb,
     '{
        "score_cambio": 3,
        "validacion_cambio": -5,
        "objetivo_anterior_cumplido": false,
        "notas": "Score mejor√≥ pero validaci√≥n empeor√≥. Foco en t√©cnica de cierre."
     }'::jsonb
    );

-- ============================================
-- M√âTRICAS AGREGADAS DE PRUEBA
-- ============================================

INSERT INTO metricas_agregadas (
    fecha, agente_id, total_llamadas, duracion_promedio_segundos, score_promedio, 
    tasa_validacion, probabilidad_cumplimiento_promedio,
    llamadas_score_alto, llamadas_score_medio, llamadas_score_bajo
) VALUES
    (CURRENT_DATE, 'a0000000-0000-0000-0000-000000000001', 5, 280, 82.5, 0.75, 68.2, 4, 1, 0),
    (CURRENT_DATE, 'a0000000-0000-0000-0000-000000000002', 8, 235, 72.3, 0.32, 45.5, 3, 4, 1),
    (CURRENT_DATE, 'a0000000-0000-0000-0000-000000000003', 3, 165, 45.2, 0.15, 22.8, 0, 1, 2),
    (CURRENT_DATE - INTERVAL '1 day', 'a0000000-0000-0000-0000-000000000001', 6, 295, 78.9, 0.68, 62.1, 3, 3, 0),
    (CURRENT_DATE - INTERVAL '1 day', 'a0000000-0000-0000-0000-000000000002', 7, 250, 69.8, 0.42, 48.3, 2, 4, 1);

-- M√©tricas globales del d√≠a
INSERT INTO metricas_agregadas (
    fecha, total_llamadas, duracion_promedio_segundos, score_promedio,
    tasa_validacion, probabilidad_cumplimiento_promedio,
    llamadas_score_alto, llamadas_score_medio, llamadas_score_bajo,
    alertas_criticas, alertas_altas
) VALUES
    (CURRENT_DATE, 16, 227, 66.7, 0.41, 45.5, 7, 6, 3, 1, 1);

-- ============================================
-- FIN DE SEEDS
-- ============================================

SELECT 'Seed data insertado correctamente' as mensaje;
</file>

<file path=".gitignore">
# Dependencies
node_modules/
.pnp
.pnp.js

# Build output
dist/
build/

# Environment files (contain secrets)
.env
.env.local
.env.development.local
.env.test.local
.env.production.local

# Logs
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*

# Editor directories
.idea/
.vscode/
*.swp
*.swo

# OS files
.DS_Store
Thumbs.db

# Cache
.cache/
.eslintcache
*.tsbuildinfo

# Vite
vite.config.ts.timestamp-*
</file>

<file path="components.json">
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "default",
  "rsc": false,
  "tsx": true,
  "tailwind": {
    "config": "tailwind.config.js",
    "css": "src/index.css",
    "baseColor": "slate",
    "cssVariables": true,
    "prefix": ""
  },
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/hooks"
  },
  "iconLibrary": "lucide"
}
</file>

<file path="index.html">
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="NODUS - Sistema de An√°lisis Inteligente de Llamadas de Cobranza" />
    <title>NODUS | Speech Analytics</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
</file>

<file path="postcss.config.js">
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}
</file>

<file path="README.md">
# NODUS - Sistema de An√°lisis Inteligente de Llamadas de Cobranza

![NODUS](https://img.shields.io/badge/NODUS-Speech_Analytics-00F5D4?style=for-the-badge)

Sistema de an√°lisis inteligente para llamadas de cobranza desarrollado con React, TypeScript, y una arquitectura de agentes de IA.

## üöÄ Inicio R√°pido

```bash
# Instalar dependencias
npm install

# Iniciar servidor de desarrollo
npm run dev

# Build para producci√≥n
npm run build
```

## üõ†Ô∏è Stack Tecnol√≥gico

- **Frontend**: React 18 + TypeScript + Vite
- **UI**: Tailwind CSS + shadcn/ui + Radix UI
- **Animaciones**: Framer Motion
- **Gr√°ficos**: Recharts
- **Routing**: React Router v7
- **State**: Zustand

## üìÅ Estructura del Proyecto

```
src/
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ ui/           # Componentes base (shadcn)
‚îÇ   ‚îú‚îÄ‚îÄ layout/       # Layout y navegaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ charts/       # Componentes de visualizaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ dashboard/    # Componentes del dashboard
‚îÇ   ‚îú‚îÄ‚îÄ llamadas/     # Componentes de llamadas
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ pages/            # P√°ginas de la aplicaci√≥n
‚îú‚îÄ‚îÄ types/            # Definiciones de tipos TypeScript
‚îú‚îÄ‚îÄ data/             # Datos mock para desarrollo
‚îú‚îÄ‚îÄ lib/              # Utilidades
‚îî‚îÄ‚îÄ hooks/            # Custom hooks
```

## üé® Tema y Dise√±o

El sistema utiliza un tema oscuro "Command Center" con:

- **Fondo**: `#06070A` (casi negro con subtono azul)
- **Primario**: `#00F5D4` (cyan el√©ctrico)
- **Secundario**: `#8B5CF6` (p√∫rpura vibrante)
- **Destructivo**: `#FF4757` (coral para alertas)
- **√âxito**: `#10B981` (esmeralda)

### Tipograf√≠a

- **Display/Headers**: General Sans
- **Body**: Plus Jakarta Sans
- **Monospace/Data**: JetBrains Mono

## üìä P√°ginas Principales

1. **Dashboard** (`/`) - Vista general con KPIs, alertas, y tendencias
2. **Llamadas** (`/llamadas`) - Lista y gesti√≥n de llamadas
3. **Detalle Llamada** (`/llamadas/:id`) - An√°lisis completo con audio y transcripci√≥n
4. **Agentes** (`/agentes`) - Ranking y m√©tricas del equipo
5. **Alertas** (`/alertas`) - Centro de anomal√≠as y alertas
6. **Chat** (`/chat`) - Asistente conversacional con IA

## üîå Integraci√≥n con Backend

El frontend est√° dise√±ado para integrarse con:

- **Saturn Studio**: Orquestaci√≥n de agentes de IA
- **AI Studio**: Transcripci√≥n y an√°lisis de emociones
- **Claude API**: An√°lisis contextual y coaching

### Endpoints esperados

```
POST /webhooks/nueva-llamada    # Ingesta de llamadas
GET  /api/v1/analisis/{id}      # Obtener an√°lisis
GET  /api/v1/agentes/{id}/metricas
POST /api/v1/chat/mensaje       # Chat conversacional
```

## üìù Arquitectura de Agentes

El sistema utiliza 6 agentes especializados:

1. **Transcriptor** - Audio ‚Üí Texto estructurado
2. **Analista** - Scoring y predicci√≥n
3. **Coach** - Feedback personalizado
4. **Detector** - Alertas y anomal√≠as
5. **Estratega** - An√°lisis macro
6. **Conversacional** - Chat con RAG

## üß™ Desarrollo

```bash
# Lint
npm run lint

# Preview build
npm run preview
```

## üìÑ Licencia

Propiedad de 360 Consultores & Rocketbot.

---

Desarrollado con ‚ù§Ô∏è para el equipo de cobranzas.
</file>

<file path="tailwind.config.js">
/** @type {import('tailwindcss').Config} */
export default {
  darkMode: ["class"],
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {
      colors: {
        border: "hsl(var(--border))",
        input: "hsl(var(--input))",
        ring: "hsl(var(--ring))",
        background: "hsl(var(--background))",
        foreground: "hsl(var(--foreground))",
        primary: {
          DEFAULT: "hsl(var(--primary))",
          foreground: "hsl(var(--primary-foreground))",
        },
        coral: {
          DEFAULT: "#FF6B6B",
          50: "#FFF0F0",
          100: "#FFE1E1",
          200: "#FFC3C3",
          300: "#FFA5A5",
          400: "#FF8787",
          500: "#FF6B6B",
          600: "#FF3D3D",
          700: "#FF0F0F",
          800: "#E00000",
          900: "#B20000",
        },
        secondary: {
          DEFAULT: "hsl(var(--secondary))",
          foreground: "hsl(var(--secondary-foreground))",
        },
        destructive: {
          DEFAULT: "hsl(var(--destructive))",
          foreground: "hsl(var(--destructive-foreground))",
        },
        success: {
          DEFAULT: "hsl(var(--success))",
          foreground: "hsl(var(--success-foreground))",
        },
        warning: {
          DEFAULT: "hsl(var(--warning))",
          foreground: "hsl(var(--warning-foreground))",
        },
        muted: {
          DEFAULT: "hsl(var(--muted))",
          foreground: "hsl(var(--muted-foreground))",
        },
        accent: {
          DEFAULT: "hsl(var(--accent))",
          foreground: "hsl(var(--accent-foreground))",
        },
        popover: {
          DEFAULT: "hsl(var(--popover))",
          foreground: "hsl(var(--popover-foreground))",
        },
        card: {
          DEFAULT: "hsl(var(--card))",
          foreground: "hsl(var(--card-foreground))",
        },
      },
      borderRadius: {
        lg: "var(--radius)",
        md: "calc(var(--radius) - 2px)",
        sm: "calc(var(--radius) - 4px)",
      },
      fontFamily: {
        sans: ['Plus Jakarta Sans', 'system-ui', 'sans-serif'],
        display: ['General Sans', 'Plus Jakarta Sans', 'system-ui', 'sans-serif'],
        mono: ['JetBrains Mono', 'Fira Code', 'monospace'],
      },
      keyframes: {
        "accordion-down": {
          from: { height: "0" },
          to: { height: "var(--radix-accordion-content-height)" },
        },
        "accordion-up": {
          from: { height: "var(--radix-accordion-content-height)" },
          to: { height: "0" },
        },
        "pulse-glow": {
          "0%, 100%": { 
            boxShadow: "0 0 20px hsl(var(--primary) / 0.3)",
            borderColor: "hsl(var(--primary) / 0.5)"
          },
          "50%": { 
            boxShadow: "0 0 30px hsl(var(--primary) / 0.5)",
            borderColor: "hsl(var(--primary) / 0.8)"
          },
        },
        "slide-up-fade": {
          "0%": { opacity: "0", transform: "translateY(10px)" },
          "100%": { opacity: "1", transform: "translateY(0)" },
        },
        "slide-down-fade": {
          "0%": { opacity: "0", transform: "translateY(-10px)" },
          "100%": { opacity: "1", transform: "translateY(0)" },
        },
        "scale-in": {
          "0%": { opacity: "0", transform: "scale(0.95)" },
          "100%": { opacity: "1", transform: "scale(1)" },
        },
        "shimmer": {
          "0%": { backgroundPosition: "-200% 0" },
          "100%": { backgroundPosition: "200% 0" },
        },
      },
      animation: {
        "accordion-down": "accordion-down 0.2s ease-out",
        "accordion-up": "accordion-up 0.2s ease-out",
        "pulse-glow": "pulse-glow 2s ease-in-out infinite",
        "slide-up-fade": "slide-up-fade 0.4s ease-out",
        "slide-down-fade": "slide-down-fade 0.4s ease-out",
        "scale-in": "scale-in 0.2s ease-out",
        "shimmer": "shimmer 2s linear infinite",
      },
      backgroundImage: {
        'grid-pattern': `url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E")`,
        'gradient-radial': 'radial-gradient(var(--tw-gradient-stops))',
        'glow-conic': 'conic-gradient(from 180deg at 50% 50%, var(--tw-gradient-stops))',
      },
    },
  },
  plugins: [],
}
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "isolatedModules": true,
    "moduleDetection": "force",
    "noEmit": true,
    "jsx": "react-jsx",
    "strict": true,
    "types": [""],
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true,
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["src", "next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude":["node_modules"]
}
</file>

<file path="vite.config.ts">
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import path from 'path'

export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
})
</file>

<file path="src/components/dashboard/ActividadReciente.tsx">
import { Clock, MoreHorizontal } from 'lucide-react'
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card'
import { Avatar, AvatarFallback } from '@/components/ui/avatar'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { formatRelativeTime, formatDuration } from '@/lib/utils'
import type { Llamada, AnalisisLlamada } from '@/types'

interface LlamadaConAnalisis extends Llamada {
  analisis?: AnalisisLlamada
}

interface ActividadRecienteProps {
  llamadas: LlamadaConAnalisis[]
}

export function ActividadReciente({ llamadas }: ActividadRecienteProps) {
  return (
    <Card>
      <CardHeader className="pb-3">
        <CardTitle>Actividad Reciente</CardTitle>
      </CardHeader>
      <CardContent>
        <div className="space-y-4">
          {llamadas.slice(0, 5).map((llamada) => {
            const score = llamada.analisis?.score_total

            return (
              <div
                key={llamada.llamada_id}
                className="flex items-center gap-3 group"
              >
                <Avatar className="h-9 w-9 border">
                  <AvatarFallback className="text-xs bg-secondary">
                    {llamada.agente_nombre?.split(' ').map(n => n[0]).join('') || 'AG'}
                  </AvatarFallback>
                </Avatar>

                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2">
                    <span className="text-sm font-medium truncate">
                      {llamada.agente_nombre || 'Agente'}
                    </span>
                    <span className="text-xs text-muted-foreground">
                      ‚Üí {llamada.cliente_id}
                    </span>
                  </div>
                  <div className="flex items-center gap-2 text-xs text-muted-foreground">
                    <Clock className="w-3 h-3" />
                    <span>{formatDuration(llamada.duracion_segundos)}</span>
                    <span>‚Ä¢</span>
                    <span>{formatRelativeTime(new Date(llamada.timestamp_inicio))}</span>
                  </div>
                </div>

                {llamada.estado === 'analizado' && score !== undefined ? (
                  <Badge 
                    variant={score >= 70 ? 'success' : score >= 40 ? 'warning' : 'destructive'}
                  >
                    {score}
                  </Badge>
                ) : (
                  <Badge variant="secondary">
                    {llamada.estado === 'transcrito' ? 'Procesando' : 'Pendiente'}
                  </Badge>
                )}

                <Button 
                  variant="ghost" 
                  size="icon-sm" 
                  className="opacity-0 group-hover:opacity-100 transition-opacity"
                >
                  <MoreHorizontal className="w-4 h-4" />
                </Button>
              </div>
            )
          })}
        </div>
      </CardContent>
    </Card>
  )
}
</file>

<file path="src/components/dashboard/AlertasActivas.tsx">
import { AlertTriangle, AlertCircle, Info, ChevronRight } from 'lucide-react'
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { cn } from '@/lib/utils'
import type { AlertaAnomalia, Severidad } from '@/types'

interface AlertasActivasProps {
  alertas: AlertaAnomalia[]
  maxItems?: number
}

const severidadConfig: Record<Severidad, { 
  icon: typeof AlertTriangle, 
  badge: 'destructive' | 'warning' | 'secondary' | 'default'
}> = {
  critica: { icon: AlertTriangle, badge: 'destructive' },
  alta: { icon: AlertCircle, badge: 'warning' },
  media: { icon: Info, badge: 'secondary' },
  baja: { icon: Info, badge: 'default' },
}

export function AlertasActivas({ alertas, maxItems = 5 }: AlertasActivasProps) {
  const visibleAlertas = alertas.slice(0, maxItems)
  const hasMore = alertas.length > maxItems

  return (
    <Card>
      <CardHeader className="pb-3">
        <div className="flex items-center justify-between">
          <CardTitle>Alertas Activas</CardTitle>
          <Badge variant="destructive">{alertas.length}</Badge>
        </div>
      </CardHeader>
      <CardContent>
        <div className="space-y-3">
          {visibleAlertas.map((alerta) => {
            const config = severidadConfig[alerta.severidad]
            const Icon = config.icon

            return (
              <div
                key={alerta.alerta_id}
                className={cn(
                  "flex items-start gap-3 p-3 rounded-lg border border-border",
                  "hover:bg-accent/50 transition-colors cursor-pointer"
                )}
              >
                <div className={cn(
                  "w-8 h-8 rounded-lg flex items-center justify-center shrink-0",
                  alerta.severidad === 'critica' && "bg-destructive/10 text-destructive",
                  alerta.severidad === 'alta' && "bg-warning/10 text-warning",
                  alerta.severidad === 'media' && "bg-secondary text-muted-foreground",
                  alerta.severidad === 'baja' && "bg-secondary text-muted-foreground"
                )}>
                  <Icon className="w-4 h-4" />
                </div>
                
                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2 mb-1">
                    <Badge variant={config.badge} className="text-[10px]">
                      {alerta.severidad}
                    </Badge>
                    <span className="text-xs text-muted-foreground">
                      {alerta.tipo}
                    </span>
                  </div>
                  <p className="text-sm line-clamp-2">{alerta.descripcion}</p>
                </div>

                <ChevronRight className="w-4 h-4 text-muted-foreground shrink-0" />
              </div>
            )
          })}
        </div>
        
        {hasMore && (
          <Button variant="ghost" className="w-full mt-3" size="sm">
            Ver todas ({alertas.length})
          </Button>
        )}
      </CardContent>
    </Card>
  )
}
</file>

<file path="src/components/dashboard/TopPerformers.tsx">
import { TrendingUp, TrendingDown, Minus, MoreHorizontal } from 'lucide-react'
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card'
import { Avatar, AvatarFallback } from '@/components/ui/avatar'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { cn } from '@/lib/utils'

interface Performer {
  agente_id: string
  nombre: string
  score: number
  llamadas: number
  validacion: number
  trend: 'up' | 'down' | 'stable'
}

interface TopPerformersProps {
  performers: Performer[]
}

export function TopPerformers({ performers }: TopPerformersProps) {
  return (
    <Card>
      <CardHeader className="pb-3">
        <div className="flex items-center justify-between">
          <CardTitle>Team Members</CardTitle>
          <Button variant="outline" size="sm">Invite</Button>
        </div>
        <p className="text-sm text-muted-foreground">Top performers this week</p>
      </CardHeader>
      <CardContent>
        <div className="space-y-4">
          {performers.slice(0, 5).map((performer) => {
            const TrendIcon = performer.trend === 'up' 
              ? TrendingUp 
              : performer.trend === 'down' 
                ? TrendingDown 
                : Minus

            return (
              <div
                key={performer.agente_id}
                className="flex items-center gap-3 group"
              >
                <Avatar className="h-9 w-9 border">
                  <AvatarFallback className="text-xs bg-primary/10 text-primary">
                    {performer.nombre.split(' ').map(n => n[0]).join('')}
                  </AvatarFallback>
                </Avatar>

                <div className="flex-1 min-w-0">
                  <p className="text-sm font-medium truncate">{performer.nombre}</p>
                  <p className="text-xs text-muted-foreground">
                    {performer.llamadas} llamadas ‚Ä¢ {performer.validacion}% validaci√≥n
                  </p>
                </div>

                <div className="flex items-center gap-2">
                  <TrendIcon className={cn(
                    "w-4 h-4",
                    performer.trend === 'up' && "text-success",
                    performer.trend === 'down' && "text-destructive",
                    performer.trend === 'stable' && "text-muted-foreground"
                  )} />
                  <Badge 
                    variant={performer.score >= 70 ? 'success' : performer.score >= 40 ? 'warning' : 'destructive'}
                    className="min-w-[3rem] justify-center"
                  >
                    {performer.score}
                  </Badge>
                </div>

                <Button 
                  variant="ghost" 
                  size="icon-sm" 
                  className="opacity-0 group-hover:opacity-100 transition-opacity"
                >
                  <MoreHorizontal className="w-4 h-4" />
                </Button>
              </div>
            )
          })}
        </div>
      </CardContent>
    </Card>
  )
}
</file>

<file path="src/components/layout/Header.tsx">
import { Bell, Search, Download, Calendar } from 'lucide-react'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Badge } from '@/components/ui/badge'

interface HeaderProps {
  title: string
  subtitle?: string
}

export function Header({ title: _title }: HeaderProps) {
  return (
    <header className="sticky top-0 z-30 h-14 bg-background border-b border-border">
      <div className="flex items-center justify-between h-full px-6">
        {/* Left: Search */}
        <div className="flex items-center flex-1 max-w-md">
          <div className="relative w-full">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground" />
            <Input 
              placeholder="Search..." 
              className="pl-9 h-9 bg-secondary/50 border-0"
            />
            <kbd className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none hidden sm:inline-flex h-5 select-none items-center gap-1 rounded border bg-muted px-1.5 font-mono text-[10px] text-muted-foreground">
              ‚åòK
            </kbd>
          </div>
        </div>

        {/* Right: Actions */}
        <div className="flex items-center gap-2">
          {/* Notifications */}
          <Button variant="ghost" size="icon" className="relative">
            <Bell className="w-4 h-4" />
            <span className="absolute top-1.5 right-1.5 w-2 h-2 bg-destructive rounded-full" />
          </Button>

          {/* Toggle theme would go here */}
          <div className="w-px h-6 bg-border mx-2" />

          {/* Download */}
          <Button variant="default" size="sm" className="gap-2">
            <Download className="w-4 h-4" />
            Download
          </Button>

          {/* Date picker */}
          <Button variant="outline" size="sm" className="gap-2">
            <Calendar className="w-4 h-4" />
            Pick a date
          </Button>
        </div>
      </div>
    </header>
  )
}

interface PageHeaderProps {
  title: string
  subtitle?: string
  badge?: {
    label: string
    variant?: 'default' | 'secondary' | 'destructive' | 'success' | 'warning'
  }
  actions?: React.ReactNode
}

export function PageHeader({ title, subtitle, badge, actions }: PageHeaderProps) {
  return (
    <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
      <div>
        <div className="flex items-center gap-3">
          <h1 className="text-2xl font-semibold tracking-tight">{title}</h1>
          {badge && (
            <Badge variant={badge.variant}>{badge.label}</Badge>
          )}
        </div>
        {subtitle && (
          <p className="text-muted-foreground text-sm mt-1">{subtitle}</p>
        )}
      </div>
      {actions && (
        <div className="flex items-center gap-2">
          {actions}
        </div>
      )}
    </div>
  )
}
</file>

<file path="src/components/layout/Sidebar.tsx">
import { NavLink, useLocation } from 'react-router-dom'
import { cn } from '@/lib/utils'
import { 
  LayoutDashboard, 
  Phone, 
  Users, 
  Target, 
  AlertTriangle, 
  TrendingUp,
  MessageSquare,
  Settings,
  ChevronDown,
  ChevronsUpDown,
  Layers,
  PhoneCall,
  UserCheck,
  PhoneOff
} from 'lucide-react'
import { Button } from '@/components/ui/button'
import { TooltipProvider } from '@/components/ui/tooltip'
import { Avatar, AvatarFallback } from '@/components/ui/avatar'

const navigation = [
  { 
    section: 'General',
    items: [
      { name: 'Dashboard', href: '/', icon: LayoutDashboard },
      { name: 'Llamadas', href: '/llamadas', icon: Phone },
      { name: 'Agentes', href: '/agentes', icon: Users },
    ]
  },
  {
    section: 'Modulos de Analisis',
    items: [
      { name: 'Vision General', href: '/modulos', icon: Layers },
      { name: 'Contacto Directo', href: '/modulos/contacto', icon: PhoneCall },
      { name: 'Compromiso Pago', href: '/modulos/compromiso', icon: UserCheck },
      { name: 'Abandono', href: '/modulos/abandono', icon: PhoneOff },
    ]
  },
  {
    section: 'Analisis',
    items: [
      { name: 'Coaching', href: '/coaching', icon: Target },
      { name: 'Alertas', href: '/alertas', icon: AlertTriangle, badge: 3 },
      { name: 'Estrategia', href: '/estrategia', icon: TrendingUp },
    ]
  },
  {
    section: 'Otros',
    items: [
      { name: 'Chat IA', href: '/chat', icon: MessageSquare },
      { name: 'Configuracion', href: '/settings', icon: Settings },
    ]
  }
]

export function Sidebar() {
  const location = useLocation()

  return (
    <TooltipProvider delayDuration={0}>
      <aside className="fixed left-0 top-0 z-40 h-screen w-64 bg-card border-r border-border flex flex-col">
        {/* Logo/Brand */}
        <div className="flex items-center gap-3 h-14 px-4 border-b border-border">
          <div className="w-8 h-8 rounded-lg bg-primary flex items-center justify-center">
            <div className="w-3 h-3 rounded-full bg-white" />
          </div>
          <div className="flex-1">
            <h1 className="font-semibold text-sm">NODUS</h1>
            <p className="text-[10px] text-muted-foreground">Speech Analytics</p>
          </div>
          <Button variant="ghost" size="icon-sm" className="text-muted-foreground">
            <ChevronsUpDown className="w-4 h-4" />
          </Button>
        </div>

        {/* Navigation */}
        <nav className="flex-1 overflow-y-auto py-4 px-3">
          {navigation.map((group) => (
            <div key={group.section} className="mb-6">
              <p className="px-3 mb-2 text-xs font-medium text-muted-foreground uppercase tracking-wider">
                {group.section}
              </p>
              <div className="space-y-1">
                {group.items.map((item) => {
                  const isActive = location.pathname === item.href || 
                    (item.href !== '/' && location.pathname.startsWith(item.href))
                  
                  return (
                    <NavLink
                      key={item.name}
                      to={item.href}
                      className={cn(
                        "flex items-center gap-3 px-3 py-2 rounded-lg text-sm transition-colors",
                        isActive 
                          ? "bg-primary/10 text-primary font-medium" 
                          : "text-muted-foreground hover:text-foreground hover:bg-accent"
                      )}
                    >
                      <item.icon className="w-4 h-4" />
                      <span className="flex-1">{item.name}</span>
                      {item.badge && (
                        <span className="flex items-center justify-center w-5 h-5 rounded-full bg-destructive text-destructive-foreground text-[10px] font-medium">
                          {item.badge}
                        </span>
                      )}
                    </NavLink>
                  )
                })}
              </div>
            </div>
          ))}
        </nav>

        {/* User section */}
        <div className="p-3 border-t border-border">
          <div className="flex items-center gap-3 p-2 rounded-lg hover:bg-accent cursor-pointer transition-colors">
            <Avatar className="h-8 w-8">
              <AvatarFallback className="text-xs bg-primary/10 text-primary">FU</AvatarFallback>
            </Avatar>
            <div className="flex-1 min-w-0">
              <p className="text-sm font-medium truncate">Fernando U.</p>
              <p className="text-xs text-muted-foreground truncate">admin@360.com</p>
            </div>
            <ChevronDown className="w-4 h-4 text-muted-foreground" />
          </div>
        </div>
      </aside>
    </TooltipProvider>
  )
}
</file>

<file path="src/components/llamadas/AudioPlayer.tsx">
import { useState, useRef, useEffect } from 'react'
import { Play, Pause, SkipBack, SkipForward, Volume2, VolumeX } from 'lucide-react'
import { Card, CardContent } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { cn, formatDuration } from '@/lib/utils'
import { motion } from 'framer-motion'

interface AudioPlayerProps {
  audioUrl: string
  duration: number
  onTimeUpdate?: (currentTime: number) => void
  className?: string
}

export function AudioPlayer({ audioUrl, duration, onTimeUpdate, className }: AudioPlayerProps) {
  const [isPlaying, setIsPlaying] = useState(false)
  const [currentTime, setCurrentTime] = useState(0)
  const [isMuted, setIsMuted] = useState(false)
  const audioRef = useRef<HTMLAudioElement>(null)
  const progressRef = useRef<HTMLDivElement>(null)

  useEffect(() => {
    const audio = audioRef.current
    if (!audio) return

    const handleTimeUpdate = () => {
      setCurrentTime(audio.currentTime)
      onTimeUpdate?.(audio.currentTime)
    }

    const handleEnded = () => {
      setIsPlaying(false)
      setCurrentTime(0)
    }

    audio.addEventListener('timeupdate', handleTimeUpdate)
    audio.addEventListener('ended', handleEnded)

    return () => {
      audio.removeEventListener('timeupdate', handleTimeUpdate)
      audio.removeEventListener('ended', handleEnded)
    }
  }, [onTimeUpdate])

  const togglePlay = () => {
    const audio = audioRef.current
    if (!audio) return

    if (isPlaying) {
      audio.pause()
    } else {
      audio.play()
    }
    setIsPlaying(!isPlaying)
  }

  const toggleMute = () => {
    const audio = audioRef.current
    if (!audio) return
    audio.muted = !isMuted
    setIsMuted(!isMuted)
  }

  const skip = (seconds: number) => {
    const audio = audioRef.current
    if (!audio) return
    audio.currentTime = Math.max(0, Math.min(audio.currentTime + seconds, duration))
  }

  const handleProgressClick = (e: React.MouseEvent<HTMLDivElement>) => {
    const audio = audioRef.current
    const progress = progressRef.current
    if (!audio || !progress) return

    const rect = progress.getBoundingClientRect()
    const x = e.clientX - rect.left
    const percentage = x / rect.width
    audio.currentTime = percentage * duration
  }

  const progress = (currentTime / duration) * 100

  return (
    <Card className={className}>
      <CardContent className="p-4">
        <audio ref={audioRef} src={audioUrl} preload="metadata" />
        
        {/* Waveform visualization (simplified) */}
        <div 
          ref={progressRef}
          className="relative h-16 mb-4 bg-muted/30 rounded-lg cursor-pointer overflow-hidden group"
          onClick={handleProgressClick}
        >
          {/* Fake waveform bars */}
          <div className="absolute inset-0 flex items-center justify-around px-2">
            {Array.from({ length: 50 }).map((_, i) => {
              const height = 20 + Math.random() * 60
              const isPast = (i / 50) * 100 <= progress
              return (
                <motion.div
                  key={i}
                  className={cn(
                    "w-1 rounded-full transition-colors",
                    isPast ? "bg-primary" : "bg-muted-foreground/30"
                  )}
                  initial={{ height: 0 }}
                  animate={{ height: `${height}%` }}
                  transition={{ delay: i * 0.01, duration: 0.3 }}
                />
              )
            })}
          </div>
          
          {/* Progress overlay */}
          <div 
            className="absolute inset-y-0 left-0 bg-primary/10 pointer-events-none"
            style={{ width: `${progress}%` }}
          />

          {/* Playhead */}
          <div 
            className="absolute top-0 bottom-0 w-0.5 bg-primary shadow-lg shadow-primary/50 transition-all"
            style={{ left: `${progress}%` }}
          />
        </div>

        {/* Controls */}
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            <Button
              variant="ghost"
              size="icon-sm"
              onClick={() => skip(-10)}
            >
              <SkipBack className="w-4 h-4" />
            </Button>
            
            <Button
              variant="default"
              size="icon"
              onClick={togglePlay}
              className="w-12 h-12"
            >
              {isPlaying ? (
                <Pause className="w-5 h-5" />
              ) : (
                <Play className="w-5 h-5 ml-0.5" />
              )}
            </Button>
            
            <Button
              variant="ghost"
              size="icon-sm"
              onClick={() => skip(10)}
            >
              <SkipForward className="w-4 h-4" />
            </Button>
          </div>

          {/* Time */}
          <div className="font-mono text-sm">
            <span className="text-primary">{formatDuration(Math.floor(currentTime))}</span>
            <span className="text-muted-foreground"> / {formatDuration(duration)}</span>
          </div>

          {/* Volume */}
          <Button
            variant="ghost"
            size="icon-sm"
            onClick={toggleMute}
          >
            {isMuted ? (
              <VolumeX className="w-4 h-4" />
            ) : (
              <Volume2 className="w-4 h-4" />
            )}
          </Button>
        </div>
      </CardContent>
    </Card>
  )
}
</file>

<file path="src/components/llamadas/ModuloScore.tsx">
import { Check, X, AlertCircle } from 'lucide-react'
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card'
import { Progress } from '@/components/ui/progress'
import { Badge } from '@/components/ui/badge'
import { cn } from '@/lib/utils'
import { motion } from 'framer-motion'
import type { ModuloAbandono } from '@/types'

interface ModuloScoreProps {
  titulo: string
  icon: React.ReactNode
  score: number
  maxScore?: number
  items: Array<{
    label: string
    presente: boolean
    puntos: number
    maxPuntos: number
    evidencia?: string
    alerta?: boolean
  }>
  delay?: number
}

export function ModuloScore({ 
  titulo, 
  icon, 
  score, 
  maxScore = 100, 
  items,
  delay = 0
}: ModuloScoreProps) {
  const percentage = (score / maxScore) * 100

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ delay }}
    >
      <Card>
        <CardHeader className="pb-3">
          <div className="flex items-center justify-between">
            <CardTitle className="flex items-center gap-2 text-base">
              {icon}
              {titulo}
            </CardTitle>
            <div className={cn(
              "text-2xl font-mono font-bold",
              percentage >= 70 ? "text-success" : 
              percentage >= 40 ? "text-warning" : "text-destructive"
            )}>
              {score}<span className="text-sm text-muted-foreground">/{maxScore}</span>
            </div>
          </div>
          <Progress 
            value={percentage} 
            variant={percentage >= 70 ? 'success' : percentage >= 40 ? 'warning' : 'destructive'}
            className="h-2 mt-2"
          />
        </CardHeader>
        <CardContent className="pt-0">
          <div className="space-y-3">
            {items.map((item, i) => (
              <motion.div
                key={i}
                initial={{ opacity: 0, x: -10 }}
                animate={{ opacity: 1, x: 0 }}
                transition={{ delay: delay + 0.1 + i * 0.05 }}
                className={cn(
                  "flex items-start gap-3 p-2.5 rounded-lg",
                  item.alerta ? "bg-destructive/10 border border-destructive/20" : "bg-muted/30"
                )}
              >
                {/* Check/X icon */}
                <div className={cn(
                  "w-6 h-6 rounded-full flex items-center justify-center shrink-0 mt-0.5",
                  item.presente ? "bg-success/20" : "bg-destructive/20"
                )}>
                  {item.presente ? (
                    <Check className="w-4 h-4 text-success" />
                  ) : (
                    <X className="w-4 h-4 text-destructive" />
                  )}
                </div>

                {/* Content */}
                <div className="flex-1 min-w-0">
                  <div className="flex items-center justify-between gap-2">
                    <span className={cn(
                      "text-sm font-medium",
                      !item.presente && "text-muted-foreground"
                    )}>
                      {item.label}
                    </span>
                    <Badge 
                      variant={item.presente ? "success" : "outline"}
                      className="font-mono text-xs"
                    >
                      {item.puntos}/{item.maxPuntos}
                    </Badge>
                  </div>
                  {item.evidencia && (
                    <p className="text-xs text-muted-foreground mt-1 italic line-clamp-2">
                      "{item.evidencia}"
                    </p>
                  )}
                  {item.alerta && (
                    <div className="flex items-center gap-1.5 mt-1.5 text-destructive">
                      <AlertCircle className="w-3.5 h-3.5" />
                      <span className="text-xs font-medium">Impacto cr√≠tico en cumplimiento</span>
                    </div>
                  )}
                </div>
              </motion.div>
            ))}
          </div>
        </CardContent>
      </Card>
    </motion.div>
  )
}

// Componente para M√≥dulo Abandono
interface ModuloAbandonoProps {
  data: ModuloAbandono
  delay?: number
}

export function ModuloAbandonoCard({ data, delay = 0 }: ModuloAbandonoProps) {
  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ delay }}
    >
      <Card className={cn(
        data.hubo_abandono && "border-destructive/50"
      )}>
        <CardContent className="p-4">
          <div className="flex items-center gap-3">
            <div className={cn(
              "w-10 h-10 rounded-lg flex items-center justify-center",
              data.hubo_abandono ? "bg-destructive/20" : "bg-success/20"
            )}>
              {data.hubo_abandono ? (
                <X className="w-5 h-5 text-destructive" />
              ) : (
                <Check className="w-5 h-5 text-success" />
              )}
            </div>
            <div>
              <p className="font-medium">
                {data.hubo_abandono ? 'Hubo abandono' : 'Sin abandono'}
              </p>
              {data.hubo_abandono && data.razon && (
                <p className="text-sm text-muted-foreground">{data.razon}</p>
              )}
            </div>
            {data.hubo_abandono && data.momento && (
              <Badge variant="destructive" className="ml-auto">
                Min {Math.floor(data.momento / 60)}:{(data.momento % 60).toString().padStart(2, '0')}
              </Badge>
            )}
          </div>
        </CardContent>
      </Card>
    </motion.div>
  )
}
</file>

<file path="src/components/llamadas/PrediccionCard.tsx">
import { TrendingUp, TrendingDown, Target, AlertCircle, CheckCircle } from 'lucide-react'
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { motion } from 'framer-motion'
import { ScoreGauge } from '@/components/charts/ScoreGauge'
import type { PrediccionCumplimiento } from '@/types'

interface PrediccionCardProps {
  prediccion: PrediccionCumplimiento
  delay?: number
}

export function PrediccionCard({ prediccion, delay = 0 }: PrediccionCardProps) {
  const { probabilidad, nivel, factores_positivos, factores_negativos, razonamiento } = prediccion

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ delay }}
    >
      <Card>
        <CardHeader className="pb-2">
          <CardTitle className="flex items-center gap-2 text-base">
            <Target className="w-5 h-5 text-primary" />
            Predicci√≥n de Cumplimiento
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="flex items-center gap-6 mb-4">
            {/* Gauge */}
            <ScoreGauge 
              value={probabilidad} 
              size="lg"
              label="prob."
            />

            {/* Nivel y badge */}
            <div className="flex-1">
              <Badge 
                variant={nivel === 'alta' ? 'success' : nivel === 'media' ? 'warning' : 'destructive'}
                className="text-sm px-3 py-1"
              >
                {nivel.toUpperCase()}
              </Badge>
              <p className="text-sm text-muted-foreground mt-3 leading-relaxed">
                {razonamiento}
              </p>
            </div>
          </div>

          {/* Factores */}
          <div className="grid grid-cols-2 gap-4">
            {/* Positivos */}
            <div className="space-y-2">
              <p className="text-xs font-medium text-success flex items-center gap-1">
                <TrendingUp className="w-3.5 h-3.5" />
                Factores Positivos
              </p>
              {factores_positivos.map((factor, i) => (
                <motion.div
                  key={i}
                  initial={{ opacity: 0, x: -10 }}
                  animate={{ opacity: 1, x: 0 }}
                  transition={{ delay: delay + 0.3 + i * 0.1 }}
                  className="flex items-center gap-2 text-sm"
                >
                  <CheckCircle className="w-4 h-4 text-success shrink-0" />
                  <span className="text-muted-foreground">{factor}</span>
                </motion.div>
              ))}
            </div>

            {/* Negativos */}
            <div className="space-y-2">
              <p className="text-xs font-medium text-destructive flex items-center gap-1">
                <TrendingDown className="w-3.5 h-3.5" />
                Factores Negativos
              </p>
              {factores_negativos.map((factor, i) => (
                <motion.div
                  key={i}
                  initial={{ opacity: 0, x: -10 }}
                  animate={{ opacity: 1, x: 0 }}
                  transition={{ delay: delay + 0.3 + i * 0.1 }}
                  className="flex items-center gap-2 text-sm"
                >
                  <AlertCircle className="w-4 h-4 text-destructive shrink-0" />
                  <span className="text-muted-foreground">{factor}</span>
                </motion.div>
              ))}
            </div>
          </div>
        </CardContent>
      </Card>
    </motion.div>
  )
}
</file>

<file path="src/components/llamadas/TranscripcionViewer.tsx">
import { User, Headphones, Smile, Meh, Frown } from 'lucide-react'
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card'
import { ScrollArea } from '@/components/ui/scroll-area'
import { cn, formatDuration } from '@/lib/utils'
import { motion } from 'framer-motion'
import type { Segmento, Emocion } from '@/types'

interface TranscripcionViewerProps {
  segmentos: Segmento[]
  onTimestampClick?: (timestamp: number) => void
  currentTime?: number
}

const emocionIcons: Record<Emocion, { icon: typeof Smile, color: string }> = {
  positivo: { icon: Smile, color: 'text-success' },
  neutral: { icon: Meh, color: 'text-muted-foreground' },
  negativo: { icon: Frown, color: 'text-destructive' },
}

export function TranscripcionViewer({ 
  segmentos, 
  onTimestampClick,
  currentTime = 0 
}: TranscripcionViewerProps) {
  return (
    <Card>
      <CardHeader className="pb-3">
        <CardTitle className="text-base">Transcripci√≥n</CardTitle>
      </CardHeader>
      <CardContent className="pt-0">
        <ScrollArea className="h-[400px] pr-4">
          <div className="space-y-3">
            {segmentos.map((segmento, index) => {
              const isAgente = segmento.speaker === 'agente'
              const emocionConfig = emocionIcons[segmento.emocion]
              const EmocionIcon = emocionConfig.icon
              const isActive = currentTime >= segmento.timestamp_inicio && 
                              (segmento.timestamp_fin === undefined || currentTime < segmento.timestamp_fin)

              return (
                <motion.div
                  key={index}
                  initial={{ opacity: 0, y: 10 }}
                  animate={{ opacity: 1, y: 0 }}
                  transition={{ delay: index * 0.02 }}
                  className={cn(
                    "group flex gap-3 p-3 rounded-lg transition-all cursor-pointer",
                    "hover:bg-muted/50",
                    isActive && "bg-primary/10 border border-primary/30",
                    isAgente ? "pr-8" : "pl-8"
                  )}
                  onClick={() => onTimestampClick?.(segmento.timestamp_inicio)}
                >
                  {/* Avatar */}
                  <div className={cn(
                    "w-8 h-8 rounded-full flex items-center justify-center shrink-0",
                    isAgente ? "bg-primary/20" : "bg-secondary/20"
                  )}>
                    {isAgente ? (
                      <Headphones className="w-4 h-4 text-primary" />
                    ) : (
                      <User className="w-4 h-4 text-secondary" />
                    )}
                  </div>

                  {/* Content */}
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-2 mb-1">
                      <span className={cn(
                        "text-xs font-semibold uppercase tracking-wide",
                        isAgente ? "text-primary" : "text-secondary"
                      )}>
                        {segmento.speaker}
                      </span>
                      <button
                        className="text-[10px] font-mono text-muted-foreground hover:text-primary transition-colors"
                        onClick={(e) => {
                          e.stopPropagation()
                          onTimestampClick?.(segmento.timestamp_inicio)
                        }}
                      >
                        {formatDuration(Math.floor(segmento.timestamp_inicio))}
                      </button>
                      <EmocionIcon className={cn("w-3.5 h-3.5", emocionConfig.color)} />
                    </div>
                    <p className="text-sm text-foreground leading-relaxed">
                      {segmento.texto}
                    </p>
                  </div>
                </motion.div>
              )
            })}
          </div>
        </ScrollArea>
      </CardContent>
    </Card>
  )
}
</file>

<file path="src/components/modulos/ProbabilidadFlow.tsx">
import { cn } from '@/lib/utils'
import { ChevronRight } from 'lucide-react'

interface FlowStep {
  paso: string
  prob_teorica: number
  prob_real?: number | null
  n?: number
}

interface ProbabilidadFlowProps {
  pasos: FlowStep[]
}

export function ProbabilidadFlow({ pasos }: ProbabilidadFlowProps) {
  return (
    <div className="space-y-3">
      {pasos.map((paso) => {
        const widthPercent = Math.min(100, Math.max(20, paso.prob_teorica))
        
        return (
          <div key={paso.paso} className="flex items-center gap-3">
            {/* Arrow indicator */}
            <div 
              className={cn(
                "relative h-12 rounded-r-full flex items-center justify-between px-4 transition-all",
                "bg-primary text-white"
              )}
              style={{ width: `${widthPercent}%`, minWidth: '140px' }}
            >
              <span className="font-medium text-sm truncate">
                {paso.paso}
              </span>
              <span className="font-bold">
                {paso.prob_teorica}%
              </span>
              
              {/* Arrow point */}
              <div className="absolute right-0 top-1/2 transform translate-x-full -translate-y-1/2">
                <ChevronRight className="w-6 h-6 text-primary" />
              </div>
            </div>
            
            {/* Real probability if available */}
            {paso.prob_real !== null && paso.prob_real !== undefined && (
              <div className="text-xs text-muted-foreground whitespace-nowrap">
                Real: <span className="font-semibold text-foreground">{paso.prob_real}%</span>
                {paso.n !== undefined && (
                  <span className="ml-1">({paso.n} llamadas)</span>
                )}
              </div>
            )}
          </div>
        )
      })}
    </div>
  )
}
</file>

<file path="src/data/mockData.ts">
import type { 
  Llamada, 
  AnalisisLlamada, 
  Agente, 
  AlertaAnomalia,
  Transcripcion,
  DashboardMetrics,
  TendenciaDia
} from '@/types'

// Agentes
export const mockAgentes: Agente[] = [
  { agente_id: '1', nombre: 'Carlos Ram√≠rez', email: 'carlos@360.com', estado: 'activo', equipo: 'Equipo A', created_at: '2025-01-01' },
  { agente_id: '2', nombre: 'Mar√≠a Gonz√°lez', email: 'maria@360.com', estado: 'activo', equipo: 'Equipo A', created_at: '2025-01-01' },
  { agente_id: '3', nombre: 'Jos√© P√©rez', email: 'jose@360.com', estado: 'activo', equipo: 'Equipo B', created_at: '2025-02-15' },
  { agente_id: '4', nombre: 'Ana Mart√≠nez', email: 'ana@360.com', estado: 'activo', equipo: 'Equipo B', created_at: '2025-03-01' },
  { agente_id: '5', nombre: 'Luis Torres', email: 'luis@360.com', estado: 'activo', equipo: 'Equipo A', created_at: '2025-01-15' },
]

// Llamadas
export const mockLlamadas: (Llamada & { agente_nombre: string })[] = [
  {
    llamada_id: 'call-001',
    audio_url: '/audio/call-001.mp3',
    duracion_segundos: 245,
    timestamp_inicio: '2026-01-30T14:23:15Z',
    timestamp_fin: '2026-01-30T14:27:20Z',
    agente_id: '2',
    agente_nombre: 'Mar√≠a Gonz√°lez',
    cliente_id: 'CL-45632',
    campana: 'Recuperaci√≥n Q1',
    tipo_deuda: 'Tarjeta de cr√©dito',
    estado: 'analizado',
    created_at: '2026-01-30T14:23:15Z',
    updated_at: '2026-01-30T14:30:00Z',
  },
  {
    llamada_id: 'call-002',
    audio_url: '/audio/call-002.mp3',
    duracion_segundos: 312,
    timestamp_inicio: '2026-01-30T13:45:00Z',
    timestamp_fin: '2026-01-30T13:50:12Z',
    agente_id: '1',
    agente_nombre: 'Carlos Ram√≠rez',
    cliente_id: 'CL-78901',
    campana: 'Recuperaci√≥n Q1',
    tipo_deuda: 'Pr√©stamo personal',
    estado: 'analizado',
    created_at: '2026-01-30T13:45:00Z',
    updated_at: '2026-01-30T13:55:00Z',
  },
  {
    llamada_id: 'call-003',
    audio_url: '/audio/call-003.mp3',
    duracion_segundos: 189,
    timestamp_inicio: '2026-01-30T12:30:00Z',
    timestamp_fin: '2026-01-30T12:33:09Z',
    agente_id: '3',
    agente_nombre: 'Jos√© P√©rez',
    cliente_id: 'CL-23456',
    campana: 'Gesti√≥n temprana',
    tipo_deuda: 'Tarjeta de cr√©dito',
    estado: 'analizado',
    created_at: '2026-01-30T12:30:00Z',
    updated_at: '2026-01-30T12:40:00Z',
  },
  {
    llamada_id: 'call-004',
    audio_url: '/audio/call-004.mp3',
    duracion_segundos: 156,
    timestamp_inicio: '2026-01-30T11:15:00Z',
    timestamp_fin: '2026-01-30T11:17:36Z',
    agente_id: '2',
    agente_nombre: 'Mar√≠a Gonz√°lez',
    cliente_id: 'CL-34567',
    campana: 'Recuperaci√≥n Q1',
    tipo_deuda: 'Pr√©stamo personal',
    estado: 'analizado',
    created_at: '2026-01-30T11:15:00Z',
    updated_at: '2026-01-30T11:25:00Z',
  },
  {
    llamada_id: 'call-005',
    audio_url: '/audio/call-005.mp3',
    duracion_segundos: 278,
    timestamp_inicio: '2026-01-30T10:00:00Z',
    timestamp_fin: '2026-01-30T10:04:38Z',
    agente_id: '4',
    agente_nombre: 'Ana Mart√≠nez',
    cliente_id: 'CL-89012',
    campana: 'Gesti√≥n temprana',
    tipo_deuda: 'Tarjeta de cr√©dito',
    estado: 'transcrito',
    created_at: '2026-01-30T10:00:00Z',
    updated_at: '2026-01-30T10:10:00Z',
  },
]

// An√°lisis de llamadas
export const mockAnalisis: Record<string, AnalisisLlamada> = {
  'call-001': {
    analisis_id: 'ana-001',
    llamada_id: 'call-001',
    transcripcion_id: 'trans-001',
    score_total: 72,
    score_contacto_directo: 85,
    score_compromiso_pago: 58,
    modulo_contacto_directo: {
      score: 85,
      desglose: {
        monto_mencionado: { presente: true, puntos: 25, evidencia: 'su saldo vencido de 1,450 soles' },
        fecha_vencimiento: { presente: true, puntos: 15, evidencia: 'vencido desde el 15 de enero' },
        consecuencias_impago: { presente: false, puntos: 0 },
        alternativas_pago: { presente: true, puntos: 15, evidencia: 'puede pagar por web, app o en agencia' },
        manejo_objeciones: { presente: true, puntos: 21, objeciones_detectadas: 2, calidad: 0.85 },
      }
    },
    modulo_compromiso_pago: {
      score: 58,
      desglose: {
        oferta_clara: { presente: true, puntos: 20 },
        alternativas_pago: { presente: true, puntos: 10 },
        fecha_especifica: { presente: true, puntos: 20, evidencia: 'el 15 de febrero' },
        validacion_cliente: { presente: false, puntos: 8, tipo: 'implicita', frase_exacta: 'ok, entiendo' },
      }
    },
    modulo_abandono: {
      hubo_abandono: false,
    },
    prediccion_cumplimiento: {
      probabilidad: 58,
      nivel: 'media',
      factores_positivos: ['Fecha espec√≠fica acordada', 'Buena comunicaci√≥n del agente', 'Cliente receptivo'],
      factores_negativos: ['Falta validaci√≥n expl√≠cita (-30pts)', 'Cliente con 2 incumplimientos previos'],
      razonamiento: 'Aunque hay fecha y monto claro, la ausencia de validaci√≥n expl√≠cita reduce el cumplimiento. Hist√≥ricamente, sin validaci√≥n solo 4 de 10 pagan.',
    },
    alertas: [
      { tipo: 'advertencia', codigo: 'FALTA_VALIDACION', mensaje: 'Cliente NO valid√≥ expl√≠citamente el compromiso' },
    ],
    recomendaciones: [
      { prioridad: 'alta', destinatario: 'supervisor', accion: 'Llamar en 48hrs para reforzar compromiso con validaci√≥n expl√≠cita' },
      { prioridad: 'media', destinatario: 'agente', accion: 'Practicar t√©cnica de cierre con validaci√≥n' },
    ],
    modelo_usado: 'claude-opus-4.5',
    version_prompt: '1.2.0',
    confianza_analisis: 0.89,
    created_at: '2026-01-30T14:30:00Z',
  },
  'call-002': {
    analisis_id: 'ana-002',
    llamada_id: 'call-002',
    transcripcion_id: 'trans-002',
    score_total: 89,
    score_contacto_directo: 92,
    score_compromiso_pago: 86,
    modulo_contacto_directo: {
      score: 92,
      desglose: {
        monto_mencionado: { presente: true, puntos: 25, evidencia: 'deuda total de 3,200 soles' },
        fecha_vencimiento: { presente: true, puntos: 15 },
        consecuencias_impago: { presente: true, puntos: 18, evidencia: 'podr√≠a afectar su historial crediticio' },
        alternativas_pago: { presente: true, puntos: 15 },
        manejo_objeciones: { presente: true, puntos: 19, objeciones_detectadas: 1, calidad: 0.95 },
      }
    },
    modulo_compromiso_pago: {
      score: 86,
      desglose: {
        oferta_clara: { presente: true, puntos: 20 },
        alternativas_pago: { presente: true, puntos: 10 },
        fecha_especifica: { presente: true, puntos: 20 },
        validacion_cliente: { presente: true, puntos: 36, tipo: 'explicita', frase_exacta: 'S√≠, confirmo que pagar√© el viernes 2 de febrero' },
      }
    },
    modulo_abandono: {
      hubo_abandono: false,
    },
    prediccion_cumplimiento: {
      probabilidad: 82,
      nivel: 'alta',
      factores_positivos: ['Validaci√≥n expl√≠cita del cliente', 'Excelente manejo de objeciones', 'Fecha espec√≠fica confirmada'],
      factores_negativos: ['Primera deuda del cliente'],
      razonamiento: 'Alta probabilidad de cumplimiento debido a la validaci√≥n expl√≠cita y el compromiso verbal claro del cliente.',
    },
    alertas: [],
    recomendaciones: [
      { prioridad: 'baja', destinatario: 'agente', accion: 'Enviar recordatorio SMS 1 d√≠a antes' },
    ],
    modelo_usado: 'claude-opus-4.5',
    version_prompt: '1.2.0',
    confianza_analisis: 0.94,
    created_at: '2026-01-30T13:55:00Z',
  },
  'call-003': {
    analisis_id: 'ana-003',
    llamada_id: 'call-003',
    transcripcion_id: 'trans-003',
    score_total: 34,
    score_contacto_directo: 45,
    score_compromiso_pago: 22,
    modulo_contacto_directo: {
      score: 45,
      desglose: {
        monto_mencionado: { presente: true, puntos: 25 },
        fecha_vencimiento: { presente: false, puntos: 0 },
        consecuencias_impago: { presente: false, puntos: 0 },
        alternativas_pago: { presente: true, puntos: 12 },
        manejo_objeciones: { presente: false, puntos: 8, objeciones_detectadas: 3, calidad: 0.32 },
      }
    },
    modulo_compromiso_pago: {
      score: 22,
      desglose: {
        oferta_clara: { presente: true, puntos: 14 },
        alternativas_pago: { presente: false, puntos: 0 },
        fecha_especifica: { presente: false, puntos: 0 },
        validacion_cliente: { presente: false, puntos: 8, tipo: 'ausente' },
      }
    },
    modulo_abandono: {
      hubo_abandono: true,
      momento: 156,
      razon: 'Cliente colg√≥ molesto',
      patron: 'abandono_por_frustracion',
    },
    prediccion_cumplimiento: {
      probabilidad: 12,
      nivel: 'baja',
      factores_positivos: [],
      factores_negativos: ['Abandono de llamada', 'Sin compromiso de fecha', 'Cliente frustrado', 'Mal manejo de objeciones'],
      razonamiento: 'Muy baja probabilidad debido al abandono y la falta de compromiso. Se requiere seguimiento urgente con otro enfoque.',
    },
    alertas: [
      { tipo: 'critica', codigo: 'ABANDONO_LLAMADA', mensaje: 'Cliente abandon√≥ la llamada frustrado' },
      { tipo: 'critica', codigo: 'SCORE_BAJO', mensaje: 'Score por debajo del umbral m√≠nimo (34/100)' },
    ],
    recomendaciones: [
      { prioridad: 'alta', destinatario: 'supervisor', accion: 'Reasignar cliente a agente senior' },
      { prioridad: 'alta', destinatario: 'agente', accion: 'Revisar llamada con supervisor para feedback' },
    ],
    modelo_usado: 'claude-opus-4.5',
    version_prompt: '1.2.0',
    confianza_analisis: 0.91,
    created_at: '2026-01-30T12:40:00Z',
  },
  'call-004': {
    analisis_id: 'ana-004',
    llamada_id: 'call-004',
    transcripcion_id: 'trans-004',
    score_total: 65,
    score_contacto_directo: 70,
    score_compromiso_pago: 60,
    modulo_contacto_directo: {
      score: 70,
      desglose: {
        monto_mencionado: { presente: true, puntos: 25 },
        fecha_vencimiento: { presente: true, puntos: 15 },
        consecuencias_impago: { presente: false, puntos: 0 },
        alternativas_pago: { presente: true, puntos: 15 },
        manejo_objeciones: { presente: true, puntos: 15, objeciones_detectadas: 1, calidad: 0.6 },
      }
    },
    modulo_compromiso_pago: {
      score: 60,
      desglose: {
        oferta_clara: { presente: true, puntos: 20 },
        alternativas_pago: { presente: true, puntos: 10 },
        fecha_especifica: { presente: true, puntos: 20 },
        validacion_cliente: { presente: false, puntos: 10, tipo: 'implicita' },
      }
    },
    modulo_abandono: {
      hubo_abandono: false,
    },
    prediccion_cumplimiento: {
      probabilidad: 45,
      nivel: 'media',
      factores_positivos: ['Fecha acordada', 'Alternativas de pago claras'],
      factores_negativos: ['Sin validaci√≥n expl√≠cita', 'Tono del cliente indeciso'],
      razonamiento: 'Probabilidad media. Se recomienda llamada de seguimiento para confirmar compromiso.',
    },
    alertas: [
      { tipo: 'advertencia', codigo: 'FALTA_VALIDACION', mensaje: 'Validaci√≥n del cliente fue impl√≠cita' },
    ],
    recomendaciones: [
      { prioridad: 'media', destinatario: 'supervisor', accion: 'Programar llamada de seguimiento en 24hrs' },
    ],
    modelo_usado: 'claude-opus-4.5',
    version_prompt: '1.2.0',
    confianza_analisis: 0.87,
    created_at: '2026-01-30T11:25:00Z',
  },
}

// Transcripci√≥n de ejemplo
export const mockTranscripcion: Transcripcion = {
  transcripcion_id: 'trans-001',
  llamada_id: 'call-001',
  transcripcion_completa: '...',
  segmentos: [
    { speaker: 'agente', timestamp_inicio: 0, texto: 'Buenos d√≠as, ¬øhablo con el se√±or Garc√≠a?', emocion: 'neutral', velocidad_habla: 142 },
    { speaker: 'cliente', timestamp_inicio: 3, texto: 'S√≠, soy yo. ¬øDe d√≥nde me llama?', emocion: 'neutral', velocidad_habla: 138 },
    { speaker: 'agente', timestamp_inicio: 6, texto: 'Le llamo del √°rea de recuperaci√≥n. Quer√≠a hablarle sobre su saldo vencido de 1,450 soles en su tarjeta de cr√©dito.', emocion: 'neutral', velocidad_habla: 145 },
    { speaker: 'cliente', timestamp_inicio: 15, texto: 'Ah s√≠, es que he tenido algunos problemas este mes.', emocion: 'negativo', velocidad_habla: 130 },
    { speaker: 'agente', timestamp_inicio: 20, texto: 'Entiendo perfectamente, todos podemos pasar por momentos dif√≠ciles. ¬øMe podr√≠a comentar cu√°l es su situaci√≥n actual?', emocion: 'positivo', velocidad_habla: 140 },
    { speaker: 'cliente', timestamp_inicio: 28, texto: 'Bueno, tuve un gasto imprevisto de salud y me qued√© corto este mes.', emocion: 'negativo', velocidad_habla: 125 },
    { speaker: 'agente', timestamp_inicio: 35, texto: 'Lamento escuchar eso. Le cuento que tenemos varias opciones para ayudarle. Puede pagar por web, app o en cualquier agencia bancaria.', emocion: 'positivo', velocidad_habla: 148 },
    { speaker: 'cliente', timestamp_inicio: 45, texto: 'Mmm, ¬øy no hay alg√∫n plan de pagos?', emocion: 'neutral', velocidad_habla: 135 },
    { speaker: 'agente', timestamp_inicio: 50, texto: 'Por supuesto, podemos ofrecerle un fraccionamiento. ¬øPara cu√°ndo podr√≠a comprometerse a realizar un primer pago?', emocion: 'positivo', velocidad_habla: 142 },
    { speaker: 'cliente', timestamp_inicio: 58, texto: 'Creo que para el 15 de febrero podr√≠a tener algo.', emocion: 'neutral', velocidad_habla: 128 },
    { speaker: 'agente', timestamp_inicio: 65, texto: 'Perfecto, entonces quedamos que el 15 de febrero realizar√° un pago. ¬øLe parece bien?', emocion: 'positivo', velocidad_habla: 145 },
    { speaker: 'cliente', timestamp_inicio: 72, texto: 'Ok, entiendo.', emocion: 'neutral', velocidad_habla: 120 },
    { speaker: 'agente', timestamp_inicio: 75, texto: 'Excelente. Le estaremos enviando un recordatorio. ¬øAlgo m√°s en lo que pueda ayudarle?', emocion: 'positivo', velocidad_habla: 150 },
    { speaker: 'cliente', timestamp_inicio: 82, texto: 'No, eso ser√≠a todo. Gracias.', emocion: 'neutral', velocidad_habla: 130 },
    { speaker: 'agente', timestamp_inicio: 86, texto: 'Gracias a usted, que tenga un excelente d√≠a.', emocion: 'positivo', velocidad_habla: 145 },
  ],
  entidades: {
    montos: [{ valor: 1450, moneda: 'PEN', contexto: 'deuda' }],
    fechas: [{ fecha: '2026-02-15', contexto: 'compromiso' }],
    metodos_pago: ['web', 'app', 'agencia'],
  },
  created_at: '2026-01-30T14:28:00Z',
}

// Alertas activas
export const mockAlertas: AlertaAnomalia[] = [
  {
    alerta_id: 'alert-001',
    tipo: 'individual',
    severidad: 'critica',
    descripcion: 'Score cr√≠tico en llamada de Jos√© P√©rez (34/100). Cliente abandon√≥ frustrado.',
    causa_probable: 'Mal manejo de objeciones',
    impacto_estimado: { llamadas_afectadas: 1, perdida_oportunidades: 1 },
    accion_recomendada: { urgencia: 'inmediata', destinatario: 'supervisor', accion: 'Revisar llamada y dar feedback' },
    agentes_relacionados: ['3'],
    estado: 'nueva',
    notificacion_enviada: false,
    created_at: '2026-01-30T12:42:00Z',
  },
  {
    alerta_id: 'alert-002',
    tipo: 'sistemica',
    severidad: 'alta',
    descripcion: 'Tasa de validaci√≥n cay√≥ 15% en las √∫ltimas 4 horas comparado con ayer.',
    causa_probable: 'Posible cambio en script o perfil de clientes',
    accion_recomendada: { urgencia: 'hoy', destinatario: 'supervisor', accion: 'Revisar las √∫ltimas 10 llamadas sin validaci√≥n' },
    estado: 'nueva',
    notificacion_enviada: true,
    created_at: '2026-01-30T14:00:00Z',
  },
  {
    alerta_id: 'alert-003',
    tipo: 'patron',
    severidad: 'media',
    descripcion: 'Mar√≠a Gonz√°lez no logra validaci√≥n en 68% de sus llamadas esta semana.',
    accion_recomendada: { urgencia: 'esta_semana', destinatario: 'supervisor', accion: 'Sesi√≥n de coaching sobre t√©cnica de cierre' },
    agentes_relacionados: ['2'],
    estado: 'en_revision',
    notificacion_enviada: true,
    created_at: '2026-01-30T08:00:00Z',
  },
]

// Dashboard metrics
export const mockDashboardMetrics: DashboardMetrics = {
  total_llamadas: 2847,
  llamadas_hoy: 127,
  score_promedio: 72,
  cambio_score: 5,
  tasa_validacion: 0.52,
  cambio_validacion: -3,
  probabilidad_promedio: 54,
  cambio_probabilidad: 2,
  alertas_activas: 3,
  monto_comprometido: 1250000,
}

// Tendencias
export const mockTendencias: TendenciaDia[] = [
  { fecha: 'Lun', llamadas: 412, score: 68, validacion: 48 },
  { fecha: 'Mar', llamadas: 445, score: 71, validacion: 51 },
  { fecha: 'Mi√©', llamadas: 398, score: 75, validacion: 55 },
  { fecha: 'Jue', llamadas: 467, score: 73, validacion: 53 },
  { fecha: 'Vie', llamadas: 489, score: 72, validacion: 52 },
  { fecha: 'S√°b', llamadas: 312, score: 74, validacion: 54 },
  { fecha: 'Hoy', llamadas: 127, score: 72, validacion: 52 },
]

// Top performers
export const mockTopPerformers = [
  { agente_id: '1', nombre: 'Carlos Ram√≠rez', score: 89, llamadas: 145, validacion: 78, trend: 'up' as const },
  { agente_id: '5', nombre: 'Luis Torres', score: 82, llamadas: 132, validacion: 71, trend: 'stable' as const },
  { agente_id: '4', nombre: 'Ana Mart√≠nez', score: 78, llamadas: 128, validacion: 65, trend: 'up' as const },
  { agente_id: '2', nombre: 'Mar√≠a Gonz√°lez', score: 72, llamadas: 156, validacion: 52, trend: 'down' as const },
  { agente_id: '3', nombre: 'Jos√© P√©rez', score: 58, llamadas: 98, validacion: 38, trend: 'down' as const },
]
</file>

<file path="src/hooks/useRealtime.ts">
// src/hooks/useRealtime.ts
// ============================================
// NODUS - Supabase Realtime Hook (Blindado)
// ============================================

import { useEffect, useRef, useCallback } from 'react'
import { supabase, isSupabaseConfigured } from '@/lib/supabase'
import type { RealtimeChannel, RealtimePostgresChangesPayload } from '@supabase/supabase-js'
import type { AlertaAnomalia, AnalisisLlamada, CoachingReport, RegistroLlamada } from '@/types/database'

// ---------- Interfaces ----------

interface RealtimeCallbacks {
  onNuevaAlerta?: (alerta: AlertaAnomalia) => void
  onAlertaActualizada?: (alerta: AlertaAnomalia) => void
  onNuevoAnalisis?: (analisis: AnalisisLlamada) => void
  onNuevoCoachingReport?: (report: CoachingReport) => void
  onLlamadaActualizada?: (llamada: RegistroLlamada) => void
}

// ---------- Hook Principal (El que usa el Dashboard) ----------

export function useRealtime(callbacks: RealtimeCallbacks) {
  // 1. EL TRUCO MAESTRO: Guardamos los callbacks en una referencia
  // Esto evita que React reinicie la conexi√≥n cada vez que renderiza
  const callbacksRef = useRef(callbacks);

  // Actualizamos la referencia en cada render silenciosamente
  useEffect(() => {
    callbacksRef.current = callbacks;
  });

  useEffect(() => {
    if (!isSupabaseConfigured()) return;

    // Conexi√≥n √∫nica
    const channel = supabase.channel('nodus-global-channel');

    channel
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'alertas_anomalias' }, 
        (payload) => callbacksRef.current.onNuevaAlerta?.(payload.new as AlertaAnomalia)
      )
      .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'alertas_anomalias' }, 
        (payload) => callbacksRef.current.onAlertaActualizada?.(payload.new as AlertaAnomalia)
      )
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'analisis_llamadas' }, 
        (payload) => callbacksRef.current.onNuevoAnalisis?.(payload.new as AnalisisLlamada)
      )
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'coaching_reports' }, 
        (payload) => callbacksRef.current.onNuevoCoachingReport?.(payload.new as CoachingReport)
      )
      .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'registro_llamadas' }, 
        (payload) => callbacksRef.current.onLlamadaActualizada?.(payload.new as RegistroLlamada)
      )
      .subscribe();

    return () => { supabase.removeChannel(channel); };
  }, []); // Array vac√≠o = Solo se ejecuta UNA vez al montar

  return { isConnected: true };
}

// ---------- Hooks Espec√≠ficos (Restaurados y Blindados) ----------

export function useAlertasRealtime(onNueva: (alerta: AlertaAnomalia) => void) {
  const onNuevaRef = useRef(onNueva);
  useEffect(() => { onNuevaRef.current = onNueva; });

  useEffect(() => {
    if (!isSupabaseConfigured()) return;

    const channel = supabase
      .channel('alertas-specific')
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'alertas_anomalias' },
        (payload) => onNuevaRef.current(payload.new as AlertaAnomalia)
      )
      .subscribe();

    return () => { supabase.removeChannel(channel); };
  }, []);
}

export function useAnalisisRealtime(onNuevo: (analisis: AnalisisLlamada) => void) {
  const onNuevoRef = useRef(onNuevo);
  useEffect(() => { onNuevoRef.current = onNuevo; });

  useEffect(() => {
    if (!isSupabaseConfigured()) return;

    const channel = supabase
      .channel('analisis-specific')
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'analisis_llamadas' },
        (payload) => onNuevoRef.current(payload.new as AnalisisLlamada)
      )
      .subscribe();

    return () => { supabase.removeChannel(channel); };
  }, []);
}

// ---------- Hook de Presencia (Usuarios Online) ----------

export function usePresence(userId: string, userName: string) {
  const channelRef = useRef<RealtimeChannel | null>(null);

  useEffect(() => {
    if (!isSupabaseConfigured()) return;

    const channel = supabase.channel('online-users', {
      config: { presence: { key: userId } }
    });

    channel.subscribe(async (status) => {
      if (status === 'SUBSCRIBED') {
        await channel.track({
          user_id: userId,
          user_name: userName,
          online_at: new Date().toISOString()
        });
      }
    });

    channelRef.current = channel;

    return () => {
      if (channelRef.current) supabase.removeChannel(channelRef.current);
    };
  }, [userId, userName]); // Aqu√≠ s√≠ permitimos reconexi√≥n si cambia el usuario

  return { channel: channelRef.current };
}
</file>

<file path="src/pages/modulos/AbandonoLlamadas.tsx">
import { Header } from '@/components/layout/Header'
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { ModuloHeader, DonutMetric } from '@/components/modulos'
import { useAbandonoKPIs, useAbandonosDetalle, useAgentesModulos } from '@/hooks/useModulos'
import { RefreshCw, Clock, MessageSquare, CheckCircle } from 'lucide-react'
import { cn } from '@/lib/utils'

// Mock data
const mockKPIs = [
  { kpi: 'primeros_30_seg', valor: 34, porcentaje_abandonos: 34, porcentaje_total: 6 },
  { kpi: 'al_mencionar_monto', valor: 28, porcentaje_abandonos: 28, porcentaje_total: 5 },
  { kpi: 'durante_objeciones', valor: 22, porcentaje_abandonos: 22, porcentaje_total: 4 }
]

const mockDetalles = [
  { momento_rango: '0-30 seg', razon: 'Cliente no interesado', iniciado_por: 'cliente', total: 45, porcentaje: 34 },
  { momento_rango: '31-60 seg', razon: 'Monto muy alto', iniciado_por: 'cliente', total: 35, porcentaje: 26 },
  { momento_rango: '1-2 min', razon: 'Sin opciones de pago', iniciado_por: 'cliente', total: 25, porcentaje: 19 },
  { momento_rango: '> 2 min', razon: 'Objeciones no resueltas', iniciado_por: 'cliente', total: 28, porcentaje: 21 }
]

const mockAgentes = [
  { agente_nombre: 'Carlos Ramirez', equipo: 'Norte', tasa_abandono: 12, llamadas_con_abandono: 8, total_llamadas: 67, ranking_score: 1 },
  { agente_nombre: 'Maria Gonzalez', equipo: 'Sur', tasa_abandono: 15, llamadas_con_abandono: 12, total_llamadas: 80, ranking_score: 2 },
  { agente_nombre: 'Luis Torres', equipo: 'Norte', tasa_abandono: 18, llamadas_con_abandono: 11, total_llamadas: 61, ranking_score: 3 },
  { agente_nombre: 'Ana Martinez', equipo: 'Centro', tasa_abandono: 24, llamadas_con_abandono: 15, total_llamadas: 63, ranking_score: 4 },
  { agente_nombre: 'Jose Perez', equipo: 'Sur', tasa_abandono: 32, llamadas_con_abandono: 19, total_llamadas: 59, ranking_score: 5 }
]

const patrones = [
  { 
    titulo: 'Recurrencia de Abandonos',
    descripcion: 'El sistema detecta patrones especificos: ciertos agentes experimentan mas cortes? Hay horarios con mayor abandono? Determinados tipos de deuda generan mas desconexiones?',
    icon: Clock
  },
  {
    titulo: 'Mapeo del Script',
    descripcion: 'La IA identifica en que parte especifica de la estructura del script ocurren mas abandonos, permitiendole redisenar secciones problematicas.',
    icon: MessageSquare
  }
]

export function AbandonoLlamadas() {
  const kpis = useAbandonoKPIs()
  const detalles = useAbandonosDetalle()
  const agentes = useAgentesModulos()

  const displayKPIs = (kpis.data && kpis.data.length > 0) ? kpis.data : mockKPIs
  const displayDetalles = (detalles.data && detalles.data.length > 0) ? detalles.data : mockDetalles
  const displayAgentes = (agentes.data && agentes.data.length > 0) ? agentes.data : mockAgentes

  const loading = kpis.loading || detalles.loading || agentes.loading

  const handleRefresh = () => {
    kpis.refetch()
    detalles.refetch()
    agentes.refetch()
  }

  // Procesar KPIs
  const kpiMap = displayKPIs.reduce((acc, k) => {
    acc[k.kpi] = k.porcentaje_abandonos || 0
    return acc
  }, {} as Record<string, number>)

  return (
    <>
      <Header title="Abandono de Llamadas" />
      
      <div className="p-6 space-y-6">
        {/* Module Header */}
        <ModuloHeader
          badge="Modulo 3"
          titulo="Analisis del Abandono de Llamadas: Prevenir la Desconexion"
          subtitulo="Cada llamada cortada representa una oportunidad perdida de recuperacion. Este modulo identifica exactamente donde y por que los deudores abandonan las llamadas."
          color="amber"
        />

        {/* Main KPIs - Donut Charts */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          <Card>
            <CardContent className="p-6 flex flex-col items-center">
              <DonutMetric 
                value={kpiMap.primeros_30_seg || 34}
                label="Abandonan en los primeros 30 segundos"
                size="lg"
                color="red"
              />
              <p className="mt-4 text-xs text-muted-foreground text-center">
                La primera impresion es critica
              </p>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6 flex flex-col items-center">
              <DonutMetric 
                value={kpiMap.al_mencionar_monto || 28}
                label="Cortan al mencionar el monto total"
                size="lg"
                color="amber"
              />
              <p className="mt-4 text-xs text-muted-foreground text-center">
                Requiere mejora en presentacion
              </p>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6 flex flex-col items-center">
              <DonutMetric 
                value={kpiMap.durante_objeciones || 22}
                label="Desconectan durante objeciones"
                size="lg"
                color="coral"
              />
              <p className="mt-4 text-xs text-muted-foreground text-center">
                Capacitacion en manejo de objeciones
              </p>
            </CardContent>
          </Card>
        </div>

        {/* Patterns and Details */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Patterns */}
          <Card>
            <CardHeader>
              <CardTitle className="text-base">Patrones Detectados</CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              {patrones.map((patron, i) => (
                <div key={i} className="flex gap-4 pb-4 border-b last:border-0 last:pb-0">
                  <div className="p-2 rounded-lg bg-amber-500/10 h-fit">
                    <patron.icon className="w-5 h-5 text-amber-600" />
                  </div>
                  <div>
                    <p className="font-medium text-sm mb-1">{patron.titulo}</p>
                    <p className="text-xs text-muted-foreground">{patron.descripcion}</p>
                  </div>
                </div>
              ))}

              {/* Result Box */}
              <div className="bg-emerald-500/10 border border-emerald-500/20 rounded-lg p-4 mt-4">
                <div className="flex items-start gap-2">
                  <CheckCircle className="w-4 h-4 text-emerald-600 mt-0.5" />
                  <p className="text-sm">
                    <strong className="text-emerald-700">Resultado:</strong> Scripts optimizados basados en 
                    datos reales que reducen hasta un 40% las llamadas cortadas prematuramente.
                  </p>
                </div>
              </div>
            </CardContent>
          </Card>

          {/* Detail by Moment */}
          <Card>
            <CardHeader>
              <div className="flex items-center justify-between">
                <div>
                  <CardTitle className="text-base">Detalle por Momento</CardTitle>
                  <CardDescription>Distribucion de abandonos</CardDescription>
                </div>
                <Button 
                  variant="ghost" 
                  size="sm" 
                  onClick={handleRefresh}
                  disabled={loading}
                >
                  <RefreshCw className={cn("h-4 w-4", loading && "animate-spin")} />
                </Button>
              </div>
            </CardHeader>
            <CardContent>
              <div className="space-y-3">
                {displayDetalles.slice(0, 5).map((detalle, index) => (
                  <div key={index} className="flex items-center gap-4">
                    <div className="w-20 text-xs text-muted-foreground">
                      {detalle.momento_rango}
                    </div>
                    <div className="flex-1">
                      <div className="h-6 bg-muted rounded overflow-hidden">
                        <div 
                          className="h-full bg-amber-500 flex items-center justify-end px-2"
                          style={{ width: `${detalle.porcentaje}%` }}
                        >
                          {(detalle.porcentaje || 0) > 20 && (
                            <span className="text-xs font-medium text-white">
                              {detalle.porcentaje}%
                            </span>
                          )}
                        </div>
                      </div>
                    </div>
                    {(detalle.porcentaje || 0) <= 20 && (
                      <span className="text-xs font-medium w-10">
                        {detalle.porcentaje}%
                      </span>
                    )}
                  </div>
                ))}
              </div>

              <div className="mt-4 pt-4 border-t">
                <p className="text-xs text-muted-foreground">
                  <strong>Razon principal:</strong> {displayDetalles[0]?.razon || 'Cliente no interesado'}
                </p>
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Agents Table */}
        <Card>
          <CardHeader>
            <CardTitle className="text-base">Tasa de Abandono por Agente</CardTitle>
            <CardDescription>Ordenado de menor a mayor abandono (mejor a peor)</CardDescription>
          </CardHeader>
          <CardContent>
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead>
                  <tr className="border-b">
                    <th className="text-left py-3 px-4 text-xs font-medium text-muted-foreground">#</th>
                    <th className="text-left py-3 px-4 text-xs font-medium text-muted-foreground">Agente</th>
                    <th className="text-left py-3 px-4 text-xs font-medium text-muted-foreground">Equipo</th>
                    <th className="text-center py-3 px-4 text-xs font-medium text-muted-foreground">Tasa Abandono</th>
                    <th className="text-center py-3 px-4 text-xs font-medium text-muted-foreground">Abandonos</th>
                    <th className="text-center py-3 px-4 text-xs font-medium text-muted-foreground">Total Llamadas</th>
                    <th className="text-center py-3 px-4 text-xs font-medium text-muted-foreground">Estado</th>
                  </tr>
                </thead>
                <tbody>
                  {displayAgentes
                    .sort((a, b) => (a.tasa_abandono || 0) - (b.tasa_abandono || 0))
                    .slice(0, 10)
                    .map((agente, index) => (
                    <tr key={agente.agente_nombre} className="border-b last:border-0 hover:bg-muted/50">
                      <td className="py-3 px-4">
                        <span className={cn(
                          "inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-medium",
                          index === 0 && "bg-emerald-100 text-emerald-700",
                          index === 1 && "bg-emerald-50 text-emerald-600",
                          index === 2 && "bg-slate-100 text-slate-700",
                          index > 2 && "bg-muted text-muted-foreground"
                        )}>
                          {index + 1}
                        </span>
                      </td>
                      <td className="py-3 px-4 font-medium">{agente.agente_nombre}</td>
                      <td className="py-3 px-4 text-sm text-muted-foreground">{agente.equipo}</td>
                      <td className="py-3 px-4 text-center">
                        <Badge 
                          variant="outline" 
                          className={cn(
                            "font-bold",
                            (agente.tasa_abandono || 0) <= 15 ? "border-emerald-500 text-emerald-600" : 
                            (agente.tasa_abandono || 0) <= 25 ? "border-amber-500 text-amber-600" : "border-red-500 text-red-500"
                          )}
                        >
                          {agente.tasa_abandono}%
                        </Badge>
                      </td>
                      <td className="py-3 px-4 text-center text-sm">{(agente as Record<string, unknown>).llamadas_con_abandono as number || '-'}</td>
                      <td className="py-3 px-4 text-center text-sm">{agente.total_llamadas}</td>
                      <td className="py-3 px-4 text-center">
                        {(agente.tasa_abandono || 0) <= 15 ? (
                          <Badge className="bg-emerald-100 text-emerald-700 hover:bg-emerald-100">Excelente</Badge>
                        ) : (agente.tasa_abandono || 0) <= 25 ? (
                          <Badge className="bg-amber-100 text-amber-700 hover:bg-amber-100">Normal</Badge>
                        ) : (
                          <Badge className="bg-red-100 text-red-700 hover:bg-red-100">Requiere atencion</Badge>
                        )}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </CardContent>
        </Card>
      </div>
    </>
  )
}
</file>

<file path="src/pages/modulos/CompromisoPago.tsx">
import { Header } from '@/components/layout/Header'
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { ModuloHeader, PilarCard, ProbabilidadFlow, ImpactoElementosChart } from '@/components/modulos'
import { useCompromisoElementos, useFlujoProbabilidad, useAgentesModulos } from '@/hooks/useModulos'
import { RefreshCw, CheckCircle } from 'lucide-react'
import { cn } from '@/lib/utils'

// Mock data
const mockPilares = [
  { titulo: 'Oferta Clara', descripcion: 'Especificar monto exacto a pagar y origen detallado de la deuda.', peso: '20%', score: 72 },
  { titulo: 'Alternativas de Pago', descripcion: 'Ofrecer multiples canales: sucursales, web, transferencia.', peso: '10%', score: 68 },
  { titulo: 'Fecha Especifica', descripcion: 'Establecer fecha concreta de pago para crear urgencia.', peso: '20%', score: 75 },
  { titulo: 'Validacion del Cliente', descripcion: 'El deudor debe confirmar explicitamente las condiciones.', peso: '50%', score: 52 }
]

const mockFlujo = [
  { paso: 'Inicio', orden: 0, prob_teorica: 0, prob_real: 5, n: 45 },
  { paso: 'Oferta clara', orden: 1, prob_teorica: 20, prob_real: 22, n: 120 },
  { paso: 'Alternativas', orden: 2, prob_teorica: 30, prob_real: 35, n: 150 },
  { paso: 'Fecha especifica', orden: 3, prob_teorica: 50, prob_real: 48, n: 100 },
  { paso: 'Validacion cliente', orden: 4, prob_teorica: 100, prob_real: 92, n: 85 }
]

const mockElementos = [
  { categoria: 'Sin elementos', orden: 0, total_llamadas: 45, prob_promedio: 8, porcentaje_del_total: 9 },
  { categoria: 'Solo oferta', orden: 1, total_llamadas: 120, prob_promedio: 22, porcentaje_del_total: 24 },
  { categoria: 'Oferta + alternativas', orden: 2, total_llamadas: 150, prob_promedio: 38, porcentaje_del_total: 30 },
  { categoria: 'Tres elementos', orden: 3, total_llamadas: 100, prob_promedio: 55, porcentaje_del_total: 20 },
  { categoria: 'Acuerdo completo', orden: 4, total_llamadas: 85, prob_promedio: 92, porcentaje_del_total: 17 }
]

const mockAgentes = [
  { agente_nombre: 'Carlos Ramirez', equipo: 'Norte', score_compromiso: 88, pct_oferta: 95, pct_validacion: 78, ranking_score: 1 },
  { agente_nombre: 'Maria Gonzalez', equipo: 'Sur', score_compromiso: 82, pct_oferta: 90, pct_validacion: 65, ranking_score: 2 },
  { agente_nombre: 'Luis Torres', equipo: 'Norte', score_compromiso: 75, pct_oferta: 85, pct_validacion: 55, ranking_score: 3 },
  { agente_nombre: 'Ana Martinez', equipo: 'Centro', score_compromiso: 68, pct_oferta: 78, pct_validacion: 42, ranking_score: 4 },
  { agente_nombre: 'Jose Perez', equipo: 'Sur', score_compromiso: 62, pct_oferta: 70, pct_validacion: 35, ranking_score: 5 }
]

export function CompromisoPago() {
  const elementos = useCompromisoElementos()
  const flujo = useFlujoProbabilidad()
  const agentes = useAgentesModulos()

  const displayElementos = (elementos.data && elementos.data.length > 0) ? elementos.data : mockElementos
  const displayFlujo = (flujo.data && flujo.data.length > 0) ? flujo.data : mockFlujo
  const displayAgentes = (agentes.data && agentes.data.length > 0) ? agentes.data : mockAgentes

  const loading = elementos.loading || flujo.loading || agentes.loading

  const handleRefresh = () => {
    elementos.refetch()
    flujo.refetch()
    agentes.refetch()
  }

  return (
    <>
      <Header title="Compromiso de Pago" />
      
      <div className="p-6 space-y-6">
        {/* Module Header */}
        <ModuloHeader
          badge="Modulo 2"
          titulo="Calidad del Compromiso: Convirtiendo Conversaciones en Resultados"
          subtitulo="Lograr que el deudor acepte un compromiso de pago es el objetivo final de cada llamada. Este modulo analiza la efectividad con la que sus agentes presentan ofertas, explican opciones y cierran acuerdos."
          color="coral"
        />

        {/* 4 Pilares */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          {mockPilares.map((pilar, index) => (
            <PilarCard
              key={pilar.titulo}
              titulo={pilar.titulo}
              descripcion={pilar.descripcion}
              score={pilar.score}
              peso={pilar.peso}
              color={index === 3 ? 'coral' : 'primary'}
            />
          ))}
        </div>

        {/* Key Insight */}
        <Card className="border-red-300 bg-red-50">
          <CardContent className="p-4">
            <div className="flex items-start gap-3">
              <CheckCircle className="w-5 h-5 text-red-500 mt-0.5" />
              <p className="text-sm">
                <strong>Dato clave:</strong> La validacion del cliente representa el 50% del exito total, 
                subrayando la importancia critica de obtener una confirmacion explicita durante la llamada.
              </p>
            </div>
          </CardContent>
        </Card>

        {/* Flow and Chart */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Probability Flow */}
          <Card>
            <CardHeader>
              <div className="flex items-center justify-between">
                <div>
                  <CardTitle className="text-base">Flujo de Probabilidad</CardTitle>
                  <CardDescription>Como se construye la probabilidad de cumplimiento</CardDescription>
                </div>
                <Button 
                  variant="ghost" 
                  size="sm" 
                  onClick={handleRefresh}
                  disabled={loading}
                >
                  <RefreshCw className={cn("h-4 w-4", loading && "animate-spin")} />
                </Button>
              </div>
            </CardHeader>
            <CardContent>
              <ProbabilidadFlow pasos={displayFlujo} />
              
              <div className="mt-4 pt-4 border-t">
                <p className="text-xs text-muted-foreground">
                  Este diagrama ilustra como la presencia o ausencia de cada elemento impacta 
                  directamente en la probabilidad final de que el cliente concrete el pago.
                </p>
              </div>
            </CardContent>
          </Card>

          {/* Impact Chart */}
          <ImpactoElementosChart 
            data={displayElementos}
            titulo="Impacto Medible en el Desempeno"
          />
        </div>

        {/* Insights */}
        <Card>
          <CardHeader>
            <CardTitle className="text-base">Transforme Datos en Accion</CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-sm text-muted-foreground mb-4">
              Nuestra herramienta de speech analytics identifica automaticamente la presencia 
              o ausencia de estos elementos en cada conversacion, permitiendo:
            </p>
            <ul className="space-y-2 text-sm">
              <li className="flex items-start gap-2">
                <CheckCircle className="w-4 h-4 text-emerald-500 mt-0.5" />
                <span>Retroalimentacion inmediata a ejecutivos sobre calidad de acuerdos</span>
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle className="w-4 h-4 text-emerald-500 mt-0.5" />
                <span>Identificacion de brechas de capacitacion especificas</span>
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle className="w-4 h-4 text-emerald-500 mt-0.5" />
                <span>Prediccion temprana de cumplimiento de compromisos</span>
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle className="w-4 h-4 text-emerald-500 mt-0.5" />
                <span>Optimizacion continua de scripts y protocolos</span>
              </li>
            </ul>
          </CardContent>
        </Card>

        {/* Agents Table */}
        <Card>
          <CardHeader>
            <CardTitle className="text-base">Ranking de Agentes - Compromiso de Pago</CardTitle>
            <CardDescription>Ordenado por score de compromiso</CardDescription>
          </CardHeader>
          <CardContent>
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead>
                  <tr className="border-b">
                    <th className="text-left py-3 px-4 text-xs font-medium text-muted-foreground">#</th>
                    <th className="text-left py-3 px-4 text-xs font-medium text-muted-foreground">Agente</th>
                    <th className="text-left py-3 px-4 text-xs font-medium text-muted-foreground">Equipo</th>
                    <th className="text-center py-3 px-4 text-xs font-medium text-muted-foreground">Score</th>
                    <th className="text-center py-3 px-4 text-xs font-medium text-muted-foreground">% Oferta Clara</th>
                    <th className="text-center py-3 px-4 text-xs font-medium text-muted-foreground">% Validacion</th>
                  </tr>
                </thead>
                <tbody>
                  {displayAgentes
                    .sort((a, b) => (b.score_compromiso || 0) - (a.score_compromiso || 0))
                    .slice(0, 10)
                    .map((agente, index) => (
                    <tr key={agente.agente_nombre} className="border-b last:border-0 hover:bg-muted/50">
                      <td className="py-3 px-4">
                        <span className={cn(
                          "inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-medium",
                          index === 0 && "bg-amber-100 text-amber-700",
                          index === 1 && "bg-slate-100 text-slate-700",
                          index === 2 && "bg-orange-100 text-orange-700",
                          index > 2 && "bg-muted text-muted-foreground"
                        )}>
                          {index + 1}
                        </span>
                      </td>
                      <td className="py-3 px-4 font-medium">{agente.agente_nombre}</td>
                      <td className="py-3 px-4 text-sm text-muted-foreground">{agente.equipo}</td>
                      <td className="py-3 px-4 text-center">
                        <Badge 
                          variant="outline" 
                          className={cn(
                            "font-bold",
                            (agente.score_compromiso || 0) >= 75 ? "border-emerald-500 text-emerald-600" : 
                            (agente.score_compromiso || 0) >= 60 ? "border-amber-500 text-amber-600" : "border-red-500 text-red-500"
                          )}
                        >
                          {agente.score_compromiso}
                        </Badge>
                      </td>
                      <td className="py-3 px-4 text-center text-sm">{(agente as Record<string, unknown>).pct_oferta as number || '-'}%</td>
                      <td className="py-3 px-4 text-center">
                        <span className={cn(
                          "font-semibold",
                          (agente.pct_validacion || 0) >= 60 ? "text-emerald-600" : 
                          (agente.pct_validacion || 0) >= 40 ? "text-amber-600" : "text-red-500"
                        )}>
                          {agente.pct_validacion || '-'}%
                        </span>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </CardContent>
        </Card>
      </div>
    </>
  )
}
</file>

<file path="src/pages/modulos/ContactoDirecto.tsx">
import { Header } from '@/components/layout/Header'
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { ModuloHeader, CumplimientoBar } from '@/components/modulos'
import { useContactoDetalle, useAgentesModulos } from '@/hooks/useModulos'
import { RefreshCw, Info, TrendingUp, TrendingDown, Minus } from 'lucide-react'
import { cn } from '@/lib/utils'

// Mock data
const mockContacto = [
  { variable: 'Monto adeudado', peso_maximo: 25, puntos_promedio: 18, pct_cumplimiento: 72 },
  { variable: 'Fecha de vencimiento', peso_maximo: 15, puntos_promedio: 11, pct_cumplimiento: 73 },
  { variable: 'Consecuencias del impago', peso_maximo: 20, puntos_promedio: 12, pct_cumplimiento: 60 },
  { variable: 'Alternativas de pago', peso_maximo: 15, puntos_promedio: 10, pct_cumplimiento: 67 },
  { variable: 'Manejo de objeciones', peso_maximo: 25, puntos_promedio: 17, pct_cumplimiento: 68 }
]

const mockAgentes = [
  { agente_nombre: 'Carlos Ramirez', equipo: 'Norte', score_contacto: 85, pct_monto: 92, pct_fecha: 88, pct_buen_manejo: 80, ranking_score: 1 },
  { agente_nombre: 'Maria Gonzalez', equipo: 'Sur', score_contacto: 78, pct_monto: 85, pct_fecha: 80, pct_buen_manejo: 72, ranking_score: 2 },
  { agente_nombre: 'Luis Torres', equipo: 'Norte', score_contacto: 72, pct_monto: 78, pct_fecha: 75, pct_buen_manejo: 65, ranking_score: 3 },
  { agente_nombre: 'Ana Martinez', equipo: 'Centro', score_contacto: 65, pct_monto: 70, pct_fecha: 68, pct_buen_manejo: 58, ranking_score: 4 },
  { agente_nombre: 'Jose Perez', equipo: 'Sur', score_contacto: 58, pct_monto: 62, pct_fecha: 55, pct_buen_manejo: 48, ranking_score: 5 }
]

const variablesInfo = [
  {
    nombre: 'Claridad en la entrega de informacion',
    descripcion: 'Evalua si el agente comunica de forma precisa el monto adeudado, fechas de vencimiento y consecuencias del impago'
  },
  {
    nombre: 'Presentacion de alternativas de pago',
    descripcion: 'Verifica que se ofrezcan todas las opciones disponibles y se expliquen claramente'
  },
  {
    nombre: 'Manejo de objeciones',
    descripcion: 'Analiza tecnicas de respuesta, empatia demostrada y efectividad en la resolucion de dudas'
  }
]

export function ContactoDirecto() {
  const contacto = useContactoDetalle()
  const agentes = useAgentesModulos()

  const displayContacto = (contacto.data && contacto.data.length > 0) ? contacto.data : mockContacto
  const displayAgentes = (agentes.data && agentes.data.length > 0) ? agentes.data : mockAgentes

  const loading = contacto.loading || agentes.loading

  const handleRefresh = () => {
    contacto.refetch()
    agentes.refetch()
  }

  // Calcular score total del modulo
  const scoreTotal = Math.round(
    displayContacto.reduce((acc, v) => acc + (v.puntos_promedio || 0), 0)
  )

  return (
    <>
      <Header title="Contacto Directo" />
      
      <div className="p-6 space-y-6">
        {/* Module Header */}
        <ModuloHeader
          badge="Modulo 1"
          titulo="Analisis del Contacto Directo: La Primera Impresion es Definitiva"
          subtitulo="El primer contacto con el deudor determina el exito de toda la gestion. Nuestro modulo de analisis utiliza IA para evaluar sistematicamente cada conversacion."
          color="primary"
        />

        {/* Intro Card */}
        <Card>
          <CardContent className="p-6">
            <div className="flex items-start gap-4">
              <Info className="w-5 h-5 text-primary mt-0.5" />
              <div>
                <p className="text-sm text-muted-foreground mb-4">
                  Los resultados se traducen en reportes detallados con recomendaciones especificas para cada agente, 
                  mejorando continuamente la calidad del contacto inicial.
                </p>
                <div className="bg-primary/5 border border-primary/20 rounded-lg p-4">
                  <p className="text-sm">
                    <strong className="text-primary">Beneficio clave:</strong> Identifique en segundos que agentes 
                    requieren capacitacion adicional y en que aspectos especificos, optimizando su inversion en formacion.
                  </p>
                </div>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Variables Section */}
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Variables Info */}
          <Card className="lg:col-span-1">
            <CardHeader>
              <CardTitle className="text-base">Variables Analizadas</CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              {variablesInfo.map((v, i) => (
                <div key={i} className="pb-4 border-b last:border-0 last:pb-0">
                  <p className="font-medium text-sm mb-1">{v.nombre}</p>
                  <p className="text-xs text-muted-foreground">{v.descripcion}</p>
                </div>
              ))}
            </CardContent>
          </Card>

          {/* Cumplimiento Bars */}
          <Card className="lg:col-span-2">
            <CardHeader>
              <div className="flex items-center justify-between">
                <div>
                  <CardTitle className="text-base">Cumplimiento por Variable</CardTitle>
                  <CardDescription>Ultimos 30 dias</CardDescription>
                </div>
                <Button 
                  variant="ghost" 
                  size="sm" 
                  onClick={handleRefresh}
                  disabled={loading}
                >
                  <RefreshCw className={cn("h-4 w-4", loading && "animate-spin")} />
                </Button>
              </div>
            </CardHeader>
            <CardContent className="space-y-5">
              {displayContacto.map((item, index) => (
                <CumplimientoBar
                  key={item.variable}
                  variable={item.variable}
                  porcentaje={item.pct_cumplimiento || 0}
                  puntos={item.puntos_promedio || 0}
                  pesoMaximo={item.peso_maximo}
                  color={index % 2 === 0 ? 'primary' : 'coral'}
                />
              ))}

              {/* Total Score */}
              <div className="pt-4 border-t">
                <div className="flex items-center justify-between">
                  <span className="font-semibold">Score Total del Modulo</span>
                  <span className="text-2xl font-bold text-primary">{scoreTotal}/100</span>
                </div>
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Agents Ranking */}
        <Card>
          <CardHeader>
            <CardTitle className="text-base">Ranking de Agentes - Contacto Directo</CardTitle>
            <CardDescription>Ordenado por score de contacto directo</CardDescription>
          </CardHeader>
          <CardContent>
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead>
                  <tr className="border-b">
                    <th className="text-left py-3 px-4 text-xs font-medium text-muted-foreground">#</th>
                    <th className="text-left py-3 px-4 text-xs font-medium text-muted-foreground">Agente</th>
                    <th className="text-left py-3 px-4 text-xs font-medium text-muted-foreground">Equipo</th>
                    <th className="text-center py-3 px-4 text-xs font-medium text-muted-foreground">Score</th>
                    <th className="text-center py-3 px-4 text-xs font-medium text-muted-foreground">% Monto</th>
                    <th className="text-center py-3 px-4 text-xs font-medium text-muted-foreground">% Fecha</th>
                    <th className="text-center py-3 px-4 text-xs font-medium text-muted-foreground">% Objeciones</th>
                    <th className="text-center py-3 px-4 text-xs font-medium text-muted-foreground">Tendencia</th>
                  </tr>
                </thead>
                <tbody>
                  {displayAgentes
                    .sort((a, b) => (b.score_contacto || 0) - (a.score_contacto || 0))
                    .slice(0, 10)
                    .map((agente, index) => (
                    <tr key={agente.agente_nombre} className="border-b last:border-0 hover:bg-muted/50">
                      <td className="py-3 px-4">
                        <span className={cn(
                          "inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-medium",
                          index === 0 && "bg-amber-100 text-amber-700",
                          index === 1 && "bg-slate-100 text-slate-700",
                          index === 2 && "bg-orange-100 text-orange-700",
                          index > 2 && "bg-muted text-muted-foreground"
                        )}>
                          {index + 1}
                        </span>
                      </td>
                      <td className="py-3 px-4 font-medium">{agente.agente_nombre}</td>
                      <td className="py-3 px-4 text-sm text-muted-foreground">{agente.equipo}</td>
                      <td className="py-3 px-4 text-center">
                        <Badge 
                          variant="outline" 
                          className={cn(
                            "font-bold",
                            (agente.score_contacto || 0) >= 75 ? "border-emerald-500 text-emerald-600" : 
                            (agente.score_contacto || 0) >= 60 ? "border-amber-500 text-amber-600" : "border-red-500 text-red-500"
                          )}
                        >
                          {agente.score_contacto}
                        </Badge>
                      </td>
                      <td className="py-3 px-4 text-center text-sm">{(agente as Record<string, unknown>).pct_monto as number || '-'}%</td>
                      <td className="py-3 px-4 text-center text-sm">{(agente as Record<string, unknown>).pct_fecha as number || '-'}%</td>
                      <td className="py-3 px-4 text-center text-sm">{(agente as Record<string, unknown>).pct_buen_manejo as number || '-'}%</td>
                      <td className="py-3 px-4 text-center">
                        {index < 2 ? (
                          <TrendingUp className="w-4 h-4 text-emerald-500 mx-auto" />
                        ) : index > 3 ? (
                          <TrendingDown className="w-4 h-4 text-red-500 mx-auto" />
                        ) : (
                          <Minus className="w-4 h-4 text-muted-foreground mx-auto" />
                        )}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </CardContent>
        </Card>
      </div>
    </>
  )
}
</file>

<file path="src/pages/modulos/ModulosOverview.tsx">
import { Header } from '@/components/layout/Header'
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { ImpactoElementosChart } from '@/components/modulos'
import { TrendChart } from '@/components/charts/TrendChart'
import { useModulosOverview } from '@/hooks/useModulos'
import { RefreshCw, ArrowRight, Phone, UserCheck, PhoneOff } from 'lucide-react'
import { Link } from 'react-router-dom'
import { cn } from '@/lib/utils'

// Mock data como fallback
const mockKPIs = {
  score_total: { valor: 72, cambio: 5 },
  score_contacto: { valor: 68, cambio: 3 },
  score_compromiso: { valor: 75, cambio: 7 },
  tasa_validacion: { valor: 52, cambio: -3 },
  tasa_abandono: { valor: 18, cambio: -2 },
  probabilidad: { valor: 54, cambio: 4 }
}

const mockEvolucion = [
  { semana: 'Sem 1', score_total: 65, score_contacto: 60, score_compromiso: 70, prob_cumplimiento: 48 },
  { semana: 'Sem 2', score_total: 68, score_contacto: 63, score_compromiso: 72, prob_cumplimiento: 50 },
  { semana: 'Sem 3', score_total: 70, score_contacto: 66, score_compromiso: 73, prob_cumplimiento: 52 },
  { semana: 'Sem 4', score_total: 72, score_contacto: 68, score_compromiso: 75, prob_cumplimiento: 54 }
]

const mockAgentes = [
  { agente_nombre: 'Carlos Ramirez', equipo: 'Norte', score_contacto: 85, score_compromiso: 88, tasa_abandono: 12, score_total: 86, ranking_score: 1 },
  { agente_nombre: 'Maria Gonzalez', equipo: 'Sur', score_contacto: 78, score_compromiso: 82, tasa_abandono: 15, score_total: 80, ranking_score: 2 },
  { agente_nombre: 'Luis Torres', equipo: 'Norte', score_contacto: 75, score_compromiso: 78, tasa_abandono: 18, score_total: 76, ranking_score: 3 },
  { agente_nombre: 'Ana Martinez', equipo: 'Centro', score_contacto: 70, score_compromiso: 72, tasa_abandono: 22, score_total: 71, ranking_score: 4 },
  { agente_nombre: 'Jose Perez', equipo: 'Sur', score_contacto: 62, score_compromiso: 65, tasa_abandono: 28, score_total: 63, ranking_score: 5 }
]

const mockElementos = [
  { categoria: 'Sin elementos', orden: 0, total_llamadas: 45, prob_promedio: 8, porcentaje_del_total: 9 },
  { categoria: 'Solo oferta', orden: 1, total_llamadas: 120, prob_promedio: 22, porcentaje_del_total: 24 },
  { categoria: 'Oferta + alternativas', orden: 2, total_llamadas: 150, prob_promedio: 38, porcentaje_del_total: 30 },
  { categoria: 'Tres elementos', orden: 3, total_llamadas: 100, prob_promedio: 55, porcentaje_del_total: 20 },
  { categoria: 'Acuerdo completo', orden: 4, total_llamadas: 85, prob_promedio: 92, porcentaje_del_total: 17 }
]

export function ModulosOverview() {
  const { kpis, evolucion, agentes, elementos, loading, refetch } = useModulosOverview()

  // Procesar KPIs
  const kpiMap = (kpis || []).reduce((acc, k) => {
    acc[k.kpi] = { valor: k.valor, cambio: k.cambio }
    return acc
  }, {} as Record<string, { valor: number | null; cambio: number | null }>)

  const displayKPIs = {
    score_total: kpiMap.score_total || mockKPIs.score_total,
    score_contacto: kpiMap.score_contacto || mockKPIs.score_contacto,
    score_compromiso: kpiMap.score_compromiso || mockKPIs.score_compromiso,
    tasa_validacion: kpiMap.tasa_validacion || mockKPIs.tasa_validacion,
    tasa_abandono: kpiMap.tasa_abandono || mockKPIs.tasa_abandono,
    probabilidad: kpiMap.probabilidad || mockKPIs.probabilidad
  }

  const displayEvolucion = (evolucion && evolucion.length > 0) ? evolucion : mockEvolucion
  const displayAgentes = (agentes && agentes.length > 0) ? agentes : mockAgentes
  const displayElementos = (elementos && elementos.length > 0) ? elementos : mockElementos

  // Chart data
  const chartData = displayEvolucion.map(e => ({
    name: typeof e.semana === 'string' ? e.semana.slice(0, 10) : e.semana,
    value: e.score_total || 0,
    value2: e.prob_cumplimiento || 0
  }))

  return (
    <>
      <Header title="Modulos de Analisis" />
      
      <div className="p-6 space-y-6">
        {/* Hero Header */}
        <div className="bg-gradient-to-r from-primary to-primary/80 rounded-xl p-6 text-white">
          <Badge variant="outline" className="bg-white/20 text-white border-white/30 mb-3">
            Vision General
          </Badge>
          <h1 className="text-2xl md:text-3xl font-bold mb-2">
            Tres Pilares para la Excelencia en Cobranza
          </h1>
          <p className="text-white/80 text-sm md:text-base max-w-3xl">
            Nuestra plataforma de Speech Analytics esta disenada especificamente para el sector financiero, 
            ofreciendo tres modulos complementarios que analizan cada aspecto critico de la gestion de cobranza.
          </p>
          
          <div className="flex items-center gap-4 mt-4">
            <Button 
              variant="secondary" 
              size="sm" 
              onClick={refetch}
              disabled={loading}
              className="gap-2"
            >
              <RefreshCw className={cn("h-4 w-4", loading && "animate-spin")} />
              Actualizar
            </Button>
          </div>
        </div>

        {/* 3 Pilares Cards */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <Link to="/modulos/contacto" className="block">
            <Card className="h-full hover:shadow-md transition-shadow cursor-pointer group">
              <CardContent className="p-6">
                <div className="flex items-start justify-between mb-4">
                  <div className="p-2 rounded-lg bg-primary/10">
                    <Phone className="w-5 h-5 text-primary" />
                  </div>
                  <ArrowRight className="w-4 h-4 text-muted-foreground group-hover:text-primary transition-colors" />
                </div>
                <h3 className="text-lg font-semibold text-primary mb-1">Contacto Directo</h3>
                <p className="text-sm text-muted-foreground mb-4">
                  Evalua la calidad de la comunicacion inicial, claridad informativa y efectividad en el manejo de objeciones.
                </p>
                <div className="flex items-end justify-between">
                  <div>
                    <p className="text-3xl font-bold">{displayKPIs.score_contacto.valor}</p>
                    <p className="text-xs text-muted-foreground">Score promedio</p>
                  </div>
                  <Badge variant={displayKPIs.score_contacto.cambio && displayKPIs.score_contacto.cambio > 0 ? "default" : "destructive"}>
                    {displayKPIs.score_contacto.cambio && displayKPIs.score_contacto.cambio > 0 ? '+' : ''}{displayKPIs.score_contacto.cambio}%
                  </Badge>
                </div>
              </CardContent>
            </Card>
          </Link>

          <Link to="/modulos/compromiso" className="block">
            <Card className="h-full hover:shadow-md transition-shadow cursor-pointer group">
              <CardContent className="p-6">
                <div className="flex items-start justify-between mb-4">
                  <div className="p-2 rounded-lg bg-coral/10">
                    <UserCheck className="w-5 h-5 text-coral" />
                  </div>
                  <ArrowRight className="w-4 h-4 text-muted-foreground group-hover:text-coral transition-colors" />
                </div>
                <h3 className="text-lg font-semibold text-coral mb-1">Compromiso de Pago</h3>
                <p className="text-sm text-muted-foreground mb-4">
                  Analiza la presentacion de ofertas, opciones de pago disponibles y la respuesta del deudor ante propuestas.
                </p>
                <div className="flex items-end justify-between">
                  <div>
                    <p className="text-3xl font-bold">{displayKPIs.score_compromiso.valor}</p>
                    <p className="text-xs text-muted-foreground">Score promedio</p>
                  </div>
                  <Badge variant={displayKPIs.score_compromiso.cambio && displayKPIs.score_compromiso.cambio > 0 ? "default" : "destructive"}>
                    {displayKPIs.score_compromiso.cambio && displayKPIs.score_compromiso.cambio > 0 ? '+' : ''}{displayKPIs.score_compromiso.cambio}%
                  </Badge>
                </div>
              </CardContent>
            </Card>
          </Link>

          <Link to="/modulos/abandono" className="block">
            <Card className="h-full hover:shadow-md transition-shadow cursor-pointer group">
              <CardContent className="p-6">
                <div className="flex items-start justify-between mb-4">
                  <div className="p-2 rounded-lg bg-amber-500/10">
                    <PhoneOff className="w-5 h-5 text-amber-600" />
                  </div>
                  <ArrowRight className="w-4 h-4 text-muted-foreground group-hover:text-amber-600 transition-colors" />
                </div>
                <h3 className="text-lg font-semibold text-amber-600 mb-1">Abandono de Llamadas</h3>
                <p className="text-sm text-muted-foreground mb-4">
                  Identifica patrones de desconexion, puntos criticos del script y recurrencia para reducir perdidas.
                </p>
                <div className="flex items-end justify-between">
                  <div>
                    <p className="text-3xl font-bold">{displayKPIs.tasa_abandono.valor}%</p>
                    <p className="text-xs text-muted-foreground">Tasa de abandono</p>
                  </div>
                  <Badge variant={displayKPIs.tasa_abandono.cambio && displayKPIs.tasa_abandono.cambio < 0 ? "default" : "destructive"}>
                    {displayKPIs.tasa_abandono.cambio && displayKPIs.tasa_abandono.cambio > 0 ? '+' : ''}{displayKPIs.tasa_abandono.cambio}%
                  </Badge>
                </div>
              </CardContent>
            </Card>
          </Link>
        </div>

        {/* Charts Row */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Evolution Chart */}
          <Card>
            <CardHeader>
              <CardTitle>Evolucion Semanal</CardTitle>
              <CardDescription>Score total y probabilidad de cumplimiento</CardDescription>
            </CardHeader>
            <CardContent>
              <TrendChart 
                data={chartData}
                dataKey="value"
                dataKey2="value2"
                color="primary"
                color2="coral"
                height={280}
                showGrid
                showAxis
              />
            </CardContent>
          </Card>

          {/* Impact by Elements */}
          <ImpactoElementosChart 
            data={displayElementos}
            titulo="Impacto de Elementos en la Probabilidad"
          />
        </div>

        {/* Agents Table */}
        <Card>
          <CardHeader>
            <div className="flex items-center justify-between">
              <div>
                <CardTitle>Ranking de Agentes por Modulo</CardTitle>
                <CardDescription>Ultimos 7 dias</CardDescription>
              </div>
              <Link to="/agentes">
                <Button variant="outline" size="sm">
                  Ver todos
                  <ArrowRight className="w-4 h-4 ml-2" />
                </Button>
              </Link>
            </div>
          </CardHeader>
          <CardContent>
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead>
                  <tr className="border-b">
                    <th className="text-left py-3 px-4 text-xs font-medium text-muted-foreground">#</th>
                    <th className="text-left py-3 px-4 text-xs font-medium text-muted-foreground">Agente</th>
                    <th className="text-left py-3 px-4 text-xs font-medium text-muted-foreground">Equipo</th>
                    <th className="text-center py-3 px-4 text-xs font-medium text-muted-foreground">Contacto</th>
                    <th className="text-center py-3 px-4 text-xs font-medium text-muted-foreground">Compromiso</th>
                    <th className="text-center py-3 px-4 text-xs font-medium text-muted-foreground">Abandono</th>
                    <th className="text-center py-3 px-4 text-xs font-medium text-muted-foreground">Score Total</th>
                  </tr>
                </thead>
                <tbody>
                  {displayAgentes.slice(0, 5).map((agente, index) => (
                    <tr key={agente.agente_nombre} className="border-b last:border-0 hover:bg-muted/50">
                      <td className="py-3 px-4">
                        <span className={cn(
                          "inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-medium",
                          index === 0 && "bg-amber-100 text-amber-700",
                          index === 1 && "bg-slate-100 text-slate-700",
                          index === 2 && "bg-orange-100 text-orange-700",
                          index > 2 && "bg-muted text-muted-foreground"
                        )}>
                          {agente.ranking_score || index + 1}
                        </span>
                      </td>
                      <td className="py-3 px-4 font-medium">{agente.agente_nombre}</td>
                      <td className="py-3 px-4 text-sm text-muted-foreground">{agente.equipo}</td>
                      <td className="py-3 px-4 text-center">
                        <span className={cn(
                          "font-semibold",
                          (agente.score_contacto || 0) >= 75 ? "text-emerald-600" : 
                          (agente.score_contacto || 0) >= 60 ? "text-amber-600" : "text-red-500"
                        )}>
                          {agente.score_contacto}
                        </span>
                      </td>
                      <td className="py-3 px-4 text-center">
                        <span className={cn(
                          "font-semibold",
                          (agente.score_compromiso || 0) >= 75 ? "text-emerald-600" : 
                          (agente.score_compromiso || 0) >= 60 ? "text-amber-600" : "text-red-500"
                        )}>
                          {agente.score_compromiso}
                        </span>
                      </td>
                      <td className="py-3 px-4 text-center">
                        <span className={cn(
                          "font-semibold",
                          (agente.tasa_abandono || 0) <= 15 ? "text-emerald-600" : 
                          (agente.tasa_abandono || 0) <= 25 ? "text-amber-600" : "text-red-500"
                        )}>
                          {agente.tasa_abandono}%
                        </span>
                      </td>
                      <td className="py-3 px-4 text-center">
                        <Badge variant="outline" className="font-bold">
                          {agente.score_total}
                        </Badge>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </CardContent>
        </Card>
      </div>
    </>
  )
}
</file>

<file path="src/pages/Agentes.tsx">
import { useState } from 'react'
import { Search, Plus, SlidersHorizontal, MoreHorizontal, ChevronLeft, ChevronRight, UserPlus, Mail, RefreshCw, Wifi, WifiOff } from 'lucide-react'
import { Header } from '@/components/layout/Header'
import { Input } from '@/components/ui/input'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'
import { Card, CardContent } from '@/components/ui/card'
import { Avatar, AvatarFallback } from '@/components/ui/avatar'
import { cn } from '@/lib/utils'
import { useAgentes, useResumenAgentes } from '@/hooks/useSupabase'
import { isSupabaseConfigured } from '@/lib/supabase'
import { MetricCard } from '@/components/dashboard'

// Mock data fallback
import { mockAgentes, mockTopPerformers } from '@/data/mockData'

export function Agentes() {
  const [searchQuery, setSearchQuery] = useState('')
  const { data: agentesDB, loading: loadingAgentes, refetch: refetchAgentes } = useAgentes()
  const { data: resumenDB, loading: loadingResumen, refetch: refetchResumen } = useResumenAgentes()

  const loading = loadingAgentes || loadingResumen

  const refetch = () => {
    refetchAgentes()
    refetchResumen()
  }

  // Combinar datos de agentes con resumen
  const agentesConMetricas = (agentesDB && agentesDB.length > 0)
    ? agentesDB.map(agente => {
        const resumen = resumenDB?.find(r => r.agente_id === agente.agente_id)
        return {
          agente_id: agente.agente_id,
          nombre: agente.nombre,
          email: agente.email || '',
          estado: agente.estado,
          equipo: agente.equipo || '',
          score: resumen?.score_semana ?? 0,
          llamadas: resumen?.llamadas_semana ?? 0,
          validacion: (resumen?.tasa_validacion_ultimo_reporte ?? 0) * 100,
          trend: 'stable' as const,
        }
      })
    : mockAgentes.map(agente => {
        const metricas = mockTopPerformers.find(p => p.agente_id === agente.agente_id)
        return {
          agente_id: agente.agente_id,
          nombre: agente.nombre,
          email: agente.email || '',
          estado: agente.estado,
          equipo: agente.equipo || '',
          score: metricas?.score ?? 0,
          llamadas: metricas?.llamadas ?? 0,
          validacion: metricas?.validacion ?? 0,
          trend: metricas?.trend ?? 'stable' as const,
        }
      })

  const filteredAgentes = agentesConMetricas.filter(agente =>
    agente.nombre.toLowerCase().includes(searchQuery.toLowerCase())
  )

  const totalAgentes = agentesConMetricas.length
  const agentesActivos = agentesConMetricas.filter(a => a.estado === 'activo').length
  const scorePromedio = agentesConMetricas.length > 0
    ? Math.round(agentesConMetricas.reduce((acc, a) => acc + a.score, 0) / agentesConMetricas.length)
    : 0

  const isConnected = isSupabaseConfigured()

  return (
    <>
      <Header title="Agentes" />
      
      <div className="p-6 space-y-6">
        {/* Breadcrumb */}
        <div className="flex items-center gap-2 text-sm text-muted-foreground">
          <span>Home</span>
          <span>-</span>
          <span className="text-foreground">Agentes</span>
        </div>

        <div className="flex items-center justify-between">
          <div className="flex items-center gap-4">
            <h1 className="text-2xl font-semibold">Equipo de Agentes</h1>
            {/* Status indicator */}
            <div className="flex items-center gap-2 text-xs">
              {isConnected ? (
                <>
                  <Wifi className="h-3.5 w-3.5 text-emerald-500" />
                  <span className="text-muted-foreground">Conectado</span>
                </>
              ) : (
                <>
                  <WifiOff className="h-3.5 w-3.5 text-muted-foreground" />
                  <span className="text-muted-foreground">Modo demo</span>
                </>
              )}
            </div>
          </div>
          <div className="flex gap-2">
            <Button 
              variant="outline" 
              size="sm"
              onClick={refetch}
              disabled={loading}
              className="gap-2"
            >
              <RefreshCw className={`w-4 h-4 ${loading ? 'animate-spin' : ''}`} />
              Actualizar
            </Button>
            <Button variant="outline" className="gap-2">
              <Mail className="w-4 h-4" />
              Invitar
            </Button>
            <Button className="gap-2">
              <UserPlus className="w-4 h-4" />
              Agregar Agente
            </Button>
          </div>
        </div>

        {/* Stats */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
          <MetricCard
            title="Total Agentes"
            value={totalAgentes.toString()}
            change="Equipo completo"
          />
          <MetricCard
            title="Agentes Activos"
            value={agentesActivos.toString()}
            change={`${Math.round((agentesActivos / totalAgentes) * 100)}% del equipo`}
          />
          <MetricCard
            title="Score Promedio"
            value={scorePromedio.toString()}
            change="Ultima semana"
          />
          <MetricCard
            title="Llamadas Totales"
            value={agentesConMetricas.reduce((acc, a) => acc + a.llamadas, 0).toString()}
            change="Ultima semana"
          />
        </div>

        {/* Filters */}
        <div className="flex items-center gap-4">
          <div className="relative flex-1 max-w-sm">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground" />
            <Input 
              placeholder="Buscar agente..." 
              className="pl-9"
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
            />
          </div>
          
          <Button variant="outline" size="sm" className="gap-2">
            <Plus className="w-4 h-4" />
            Estado
          </Button>
          <Button variant="outline" size="sm" className="gap-2">
            <Plus className="w-4 h-4" />
            Equipo
          </Button>

          <div className="ml-auto">
            <Button variant="outline" size="sm" className="gap-2">
              <SlidersHorizontal className="w-4 h-4" />
              Vista
            </Button>
          </div>
        </div>

        {/* Table */}
        <Card>
          <CardContent className="p-0">
            <table className="w-full">
              <thead>
                <tr className="border-b border-border">
                  <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground w-12">
                    <input type="checkbox" className="rounded border-border" />
                  </th>
                  <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground">
                    Nombre
                  </th>
                  <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground">
                    Email
                  </th>
                  <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground">
                    Llamadas
                  </th>
                  <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground">
                    Score
                  </th>
                  <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground">
                    Validacion
                  </th>
                  <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground">
                    Estado
                  </th>
                  <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground">
                    Equipo
                  </th>
                  <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground w-[50px]">
                  </th>
                </tr>
              </thead>
              <tbody>
                {loading && filteredAgentes.length === 0 ? (
                  <tr>
                    <td colSpan={9} className="p-8 text-center text-muted-foreground">
                      Cargando agentes...
                    </td>
                  </tr>
                ) : filteredAgentes.length === 0 ? (
                  <tr>
                    <td colSpan={9} className="p-8 text-center text-muted-foreground">
                      No se encontraron agentes
                    </td>
                  </tr>
                ) : (
                  filteredAgentes.map((agente) => (
                    <tr key={agente.agente_id} className="border-b border-border hover:bg-accent/50 transition-colors">
                      <td className="p-4">
                        <input type="checkbox" className="rounded border-border" />
                      </td>
                      <td className="p-4">
                        <div className="flex items-center gap-3">
                          <Avatar className="h-8 w-8">
                            <AvatarFallback className="text-xs bg-primary/10 text-primary">
                              {agente.nombre.split(' ').map(n => n[0]).join('')}
                            </AvatarFallback>
                          </Avatar>
                          <span className="font-medium">{agente.nombre}</span>
                        </div>
                      </td>
                      <td className="p-4 text-muted-foreground">
                        {agente.email || '-'}
                      </td>
                      <td className="p-4">
                        {agente.llamadas}
                      </td>
                      <td className="p-4">
                        <span className={cn(
                          "font-semibold",
                          agente.score >= 70 ? "text-success" :
                          agente.score >= 40 ? "text-warning" : "text-destructive"
                        )}>
                          {agente.score}
                        </span>
                      </td>
                      <td className="p-4">
                        <span className={cn(
                          "font-medium",
                          agente.validacion >= 60 ? "text-success" :
                          agente.validacion >= 40 ? "text-warning" : "text-destructive"
                        )}>
                          {agente.validacion.toFixed(0)}%
                        </span>
                      </td>
                      <td className="p-4">
                        <Badge 
                          variant={agente.estado === 'activo' ? 'success' : 'secondary'}
                        >
                          {agente.estado === 'activo' ? 'Activo' : 'Inactivo'}
                        </Badge>
                      </td>
                      <td className="p-4">
                        <span className="text-sm">{agente.equipo || '-'}</span>
                      </td>
                      <td className="p-4">
                        <Button variant="ghost" size="icon-sm">
                          <MoreHorizontal className="w-4 h-4" />
                        </Button>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>

            {/* Pagination */}
            <div className="flex items-center justify-between px-4 py-3 border-t border-border">
              <p className="text-sm text-muted-foreground">
                {filteredAgentes.length} agentes
              </p>
              <div className="flex items-center gap-6">
                <div className="flex items-center gap-2">
                  <span className="text-sm">Filas por pagina</span>
                  <select className="h-8 rounded-md border border-input bg-background px-2 text-sm">
                    <option>10</option>
                    <option>20</option>
                    <option>50</option>
                  </select>
                </div>
                <span className="text-sm">Pagina 1 de 1</span>
                <div className="flex gap-1">
                  <Button variant="outline" size="icon-sm" disabled>
                    <ChevronLeft className="w-4 h-4" />
                  </Button>
                  <Button variant="outline" size="icon-sm" disabled>
                    <ChevronRight className="w-4 h-4" />
                  </Button>
                </div>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>
    </>
  )
}
</file>

<file path="src/pages/Alertas.tsx">
import { useState, useCallback, useEffect } from 'react'
import { AlertTriangle, AlertCircle, Info, Plus, SlidersHorizontal, MoreHorizontal, ChevronLeft, ChevronRight, RefreshCw, Wifi, WifiOff, Bell } from 'lucide-react'
import { Header } from '@/components/layout/Header'
import { Card, CardContent } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'
import { Input } from '@/components/ui/input'
import { cn, formatRelativeTime } from '@/lib/utils'
import { useAlertas as useAlertasQuery } from '@/hooks/useSupabase'
import { useAlertasRealtime } from '@/hooks/useRealtime'
import { isSupabaseConfigured } from '@/lib/supabase'
import type { Severidad, EstadoAlerta } from '@/types'
import type { AlertaAnomalia } from '@/types/database'

// Mock data fallback
import { mockAlertas } from '@/data/mockData'

const severidadConfig: Record<Severidad, { 
  icon: typeof AlertTriangle, 
  badge: 'destructive' | 'warning' | 'secondary' | 'default'
}> = {
  critica: { icon: AlertTriangle, badge: 'destructive' },
  alta: { icon: AlertCircle, badge: 'warning' },
  media: { icon: Info, badge: 'secondary' },
  baja: { icon: Info, badge: 'default' },
}

export function Alertas() {
  const [searchQuery, setSearchQuery] = useState('')
  const [localAlertas, setLocalAlertas] = useState<AlertaAnomalia[]>([])
  const { data: alertasDB, loading, error, refetch } = useAlertasQuery(true)

  // Sync DB data to local state
  useEffect(() => {
    if (alertasDB && alertasDB.length > 0) {
      setLocalAlertas(alertasDB)
    }
  }, [alertasDB])

  // Realtime: escuchar nuevas alertas
  const handleNuevaAlerta = useCallback((alerta: AlertaAnomalia) => {
    setLocalAlertas(prev => [alerta, ...prev])
  }, [])

  useAlertasRealtime(handleNuevaAlerta)

  // Usar datos de Supabase o mock
  const alertas = localAlertas.length > 0 
    ? localAlertas.map(a => ({
        alerta_id: a.alerta_id,
        tipo: a.tipo as 'individual' | 'sistemica' | 'patron',
        severidad: a.severidad as Severidad,
        descripcion: a.descripcion,
        causa_probable: a.causa_probable || undefined,
        impacto_estimado: a.impacto_estimado as any,
        accion_recomendada: a.accion_recomendada as any,
        agentes_relacionados: a.agentes_relacionados || undefined,
        estado: a.estado as EstadoAlerta,
        notificacion_enviada: a.notificacion_enviada,
        created_at: a.created_at
      }))
    : mockAlertas

  const filteredAlertas = alertas.filter(alerta =>
    alerta.descripcion.toLowerCase().includes(searchQuery.toLowerCase())
  )

  // Conteo por severidad
  const countBySeveridad = (sev: Severidad) => 
    alertas.filter(a => a.severidad === sev).length

  const isConnected = isSupabaseConfigured()

  return (
    <>
      <Header title="Alertas" />
      
      <div className="p-6 space-y-6">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-4">
            <div>
              <h1 className="text-2xl font-semibold">Alertas</h1>
              <p className="text-muted-foreground text-sm">Monitoreo de anomalias del sistema</p>
            </div>
            {/* Status indicator */}
            <div className="flex items-center gap-2 text-xs">
              {isConnected ? (
                <>
                  <Wifi className="h-3.5 w-3.5 text-emerald-500" />
                  <span className="text-muted-foreground">En vivo</span>
                </>
              ) : (
                <>
                  <WifiOff className="h-3.5 w-3.5 text-muted-foreground" />
                  <span className="text-muted-foreground">Modo demo</span>
                </>
              )}
            </div>
          </div>
          <div className="flex gap-2">
            <Button 
              variant="outline" 
              size="sm"
              onClick={refetch}
              disabled={loading}
              className="gap-2"
            >
              <RefreshCw className={`w-4 h-4 ${loading ? 'animate-spin' : ''}`} />
              Actualizar
            </Button>
            <Button>
              <Bell className="w-4 h-4 mr-2" />
              Configurar Alertas
            </Button>
          </div>
        </div>

        {/* Stats */}
        <div className="grid grid-cols-4 gap-4">
          {(['critica', 'alta', 'media', 'baja'] as Severidad[]).map((sev) => {
            const config = severidadConfig[sev]
            const Icon = config.icon
            const count = countBySeveridad(sev)
            
            return (
              <Card key={sev}>
                <CardContent className="p-4">
                  <div className="flex items-center gap-3">
                    <div className={cn(
                      "w-10 h-10 rounded-lg flex items-center justify-center",
                      sev === 'critica' && "bg-destructive/10 text-destructive",
                      sev === 'alta' && "bg-warning/10 text-warning",
                      sev === 'media' && "bg-secondary text-muted-foreground",
                      sev === 'baja' && "bg-secondary text-muted-foreground"
                    )}>
                      <Icon className="w-5 h-5" />
                    </div>
                    <div>
                      <p className="text-2xl font-semibold">{count}</p>
                      <p className="text-xs text-muted-foreground capitalize">{sev}</p>
                    </div>
                  </div>
                </CardContent>
              </Card>
            )
          })}
        </div>

        {/* Filters */}
        <div className="flex items-center gap-4">
          <Input 
            placeholder="Buscar alertas..." 
            className="max-w-sm"
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
          />
          
          <Button variant="outline" size="sm" className="gap-2">
            <Plus className="w-4 h-4" />
            Severidad
          </Button>
          <Button variant="outline" size="sm" className="gap-2">
            <Plus className="w-4 h-4" />
            Estado
          </Button>

          <div className="ml-auto">
            <Button variant="outline" size="sm" className="gap-2">
              <SlidersHorizontal className="w-4 h-4" />
              Vista
            </Button>
          </div>
        </div>

        {/* Error message */}
        {error && (
          <div className="p-4 bg-destructive/10 text-destructive rounded-lg text-sm">
            Error al cargar alertas: {error.message}
          </div>
        )}

        {/* Table */}
        <Card>
          <CardContent className="p-0">
            <table className="w-full">
              <thead>
                <tr className="border-b border-border">
                  <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground w-12">
                    <input type="checkbox" className="rounded border-border" />
                  </th>
                  <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground">
                    Alerta
                  </th>
                  <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground">
                    Descripcion
                  </th>
                  <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground">
                    Severidad
                  </th>
                  <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground">
                    Estado
                  </th>
                  <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground">
                    Creada
                  </th>
                  <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground w-[50px]">
                  </th>
                </tr>
              </thead>
              <tbody>
                {loading && filteredAlertas.length === 0 ? (
                  <tr>
                    <td colSpan={7} className="p-8 text-center text-muted-foreground">
                      Cargando alertas...
                    </td>
                  </tr>
                ) : filteredAlertas.length === 0 ? (
                  <tr>
                    <td colSpan={7} className="p-8 text-center text-muted-foreground">
                      No hay alertas activas
                    </td>
                  </tr>
                ) : (
                  filteredAlertas.map((alerta) => {
                    const config = severidadConfig[alerta.severidad]
                    const Icon = config.icon

                    return (
                      <tr key={alerta.alerta_id} className="border-b border-border hover:bg-accent/50 transition-colors">
                        <td className="p-4">
                          <input type="checkbox" className="rounded border-border" />
                        </td>
                        <td className="p-4">
                          <div className="flex items-center gap-3">
                            <div className={cn(
                              "w-8 h-8 rounded-lg flex items-center justify-center",
                              alerta.severidad === 'critica' && "bg-destructive/10 text-destructive",
                              alerta.severidad === 'alta' && "bg-warning/10 text-warning",
                              alerta.severidad === 'media' && "bg-secondary text-muted-foreground",
                              alerta.severidad === 'baja' && "bg-secondary text-muted-foreground"
                            )}>
                              <Icon className="w-4 h-4" />
                            </div>
                            <span className="font-medium text-primary">
                              {alerta.alerta_id.toUpperCase().slice(0, 10)}
                            </span>
                          </div>
                        </td>
                        <td className="p-4 max-w-md">
                          <p className="text-sm truncate">{alerta.descripcion}</p>
                        </td>
                        <td className="p-4">
                          <Badge variant={config.badge}>
                            {alerta.severidad}
                          </Badge>
                        </td>
                        <td className="p-4">
                          <Badge variant={alerta.estado === 'nueva' ? 'default' : 'secondary'}>
                            {alerta.estado}
                          </Badge>
                        </td>
                        <td className="p-4 text-sm text-muted-foreground">
                          {formatRelativeTime(new Date(alerta.created_at))}
                        </td>
                        <td className="p-4">
                          <Button variant="ghost" size="icon-sm">
                            <MoreHorizontal className="w-4 h-4" />
                          </Button>
                        </td>
                      </tr>
                    )
                  })
                )}
              </tbody>
            </table>

            {/* Pagination */}
            <div className="flex items-center justify-between px-4 py-3 border-t border-border">
              <p className="text-sm text-muted-foreground">
                {filteredAlertas.length} alertas
              </p>
              <div className="flex items-center gap-6">
                <span className="text-sm">Pagina 1 de 1</span>
                <div className="flex gap-1">
                  <Button variant="outline" size="icon-sm" disabled>
                    <ChevronLeft className="w-4 h-4" />
                  </Button>
                  <Button variant="outline" size="icon-sm" disabled>
                    <ChevronRight className="w-4 h-4" />
                  </Button>
                </div>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>
    </>
  )
}
</file>

<file path="src/pages/Chat.tsx">
import { useRef, useEffect } from 'react'
import { Send, Sparkles, User, Bot, Loader2, Trash2, Wifi, WifiOff } from 'lucide-react'
import { Header } from '@/components/layout/Header'
import { Card } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Badge } from '@/components/ui/badge'
import { ScrollArea } from '@/components/ui/scroll-area'
import { cn } from '@/lib/utils'
import { useChatStore } from '@/stores/chatStore'
import { isChatConfigured, type ChatResponseData } from '@/services/chatService'

// ---------- Sub-components ----------

function TypingIndicator() {
  return (
    <div className="flex gap-3">
      <div className="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center">
        <Bot className="w-4 h-4 text-primary" />
      </div>
      <div className="bg-secondary rounded-xl px-4 py-3 flex items-center gap-1">
        <div className="w-2 h-2 bg-muted-foreground/60 rounded-full animate-bounce" style={{ animationDelay: '0ms' }} />
        <div className="w-2 h-2 bg-muted-foreground/60 rounded-full animate-bounce" style={{ animationDelay: '150ms' }} />
        <div className="w-2 h-2 bg-muted-foreground/60 rounded-full animate-bounce" style={{ animationDelay: '300ms' }} />
      </div>
    </div>
  )
}

function DataTable({ data }: { data: ChatResponseData }) {
  if (data.type !== 'table' || !data.columns || !data.rows) return null

  return (
    <div className="mt-3 rounded-lg border border-border overflow-hidden">
      {data.title && (
        <div className="px-3 py-2 bg-secondary/50 border-b border-border">
          <span className="text-xs font-medium">{data.title}</span>
        </div>
      )}
      <div className="overflow-x-auto">
        <table className="w-full text-xs">
          <thead>
            <tr className="border-b border-border bg-secondary/30">
              {data.columns.map((col, i) => (
                <th key={i} className="px-3 py-2 text-left font-medium text-muted-foreground">
                  {col}
                </th>
              ))}
            </tr>
          </thead>
          <tbody>
            {data.rows.map((row, i) => (
              <tr key={i} className="border-b border-border last:border-0">
                {row.map((cell, j) => (
                  <td key={j} className="px-3 py-2">
                    {cell}
                  </td>
                ))}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  )
}

function MetricsCards({ data }: { data: ChatResponseData }) {
  if (data.type !== 'metrics' || !data.items) return null

  return (
    <div className="grid grid-cols-2 gap-2 mt-3">
      {data.items.map((item, i) => (
        <div key={i} className="rounded-lg border border-border p-3 bg-background">
          <p className="text-xs text-muted-foreground">{item.label}</p>
          <div className="flex items-baseline gap-2 mt-1">
            <span className="text-lg font-semibold">{item.value}</span>
            {item.change && (
              <span className={cn(
                "text-xs",
                item.trend === 'up' && "text-success",
                item.trend === 'down' && "text-destructive",
                item.trend === 'stable' && "text-muted-foreground"
              )}>
                {item.change}
              </span>
            )}
          </div>
        </div>
      ))}
    </div>
  )
}

function MessageContent({ content }: { content: string }) {
  // Simple markdown-like parsing for **bold**
  const parts = content.split(/(\*\*.*?\*\*)/g)
  
  return (
    <div className="text-sm whitespace-pre-wrap">
      {parts.map((part, i) => {
        if (part.startsWith('**') && part.endsWith('**')) {
          return <strong key={i}>{part.slice(2, -2)}</strong>
        }
        return part
      })}
    </div>
  )
}

// ---------- Main Component ----------

export function Chat() {
  const { 
    messages, 
    isLoading, 
    sendMessage, 
    addSuggestionClick, 
    clearChat 
  } = useChatStore()
  
  const scrollRef = useRef<HTMLDivElement>(null)
  const inputRef = useRef<HTMLInputElement>(null)
  
  const isConnected = isChatConfigured()

  // Auto-scroll on new messages
  useEffect(() => {
    if (scrollRef.current) {
      scrollRef.current.scrollTop = scrollRef.current.scrollHeight
    }
  }, [messages, isLoading])

  // Focus input on load
  useEffect(() => {
    inputRef.current?.focus()
  }, [])

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault()
    const input = inputRef.current
    if (input && input.value.trim()) {
      sendMessage(input.value)
      input.value = ''
    }
  }

  const handleSuggestionClick = (suggestion: string) => {
    if (suggestion === 'Limpiar chat' || suggestion === 'Intentar de nuevo') {
      if (suggestion === 'Limpiar chat') {
        clearChat()
      } else {
        // Get last user message and retry
        const lastUserMsg = [...messages].reverse().find(m => m.role === 'user')
        if (lastUserMsg) {
          sendMessage(lastUserMsg.content)
        }
      }
      return
    }
    addSuggestionClick(suggestion)
  }

  return (
    <>
      <Header title="Chat" />
      
      <div className="p-6 h-[calc(100vh-3.5rem)]">
        <Card className="h-full flex flex-col">
          {/* Header */}
          <div className="p-4 border-b border-border flex items-center gap-3">
            <div className="w-9 h-9 rounded-full bg-primary/10 flex items-center justify-center">
              <Sparkles className="w-4 h-4 text-primary" />
            </div>
            <div>
              <h3 className="font-medium text-sm">Asistente NODUS</h3>
              <p className="text-xs text-muted-foreground">
                {isConnected ? 'Conectado a Saturn Studio' : 'Modo demo'}
              </p>
            </div>
            <div className="ml-auto flex items-center gap-2">
              {isConnected ? (
                <Badge variant="success" className="gap-1">
                  <Wifi className="w-3 h-3" />
                  Online
                </Badge>
              ) : (
                <Badge variant="secondary" className="gap-1">
                  <WifiOff className="w-3 h-3" />
                  Demo
                </Badge>
              )}
              <Button 
                variant="ghost" 
                size="icon-sm" 
                onClick={clearChat}
                title="Limpiar chat"
              >
                <Trash2 className="w-4 h-4" />
              </Button>
            </div>
          </div>

          {/* Messages */}
          <ScrollArea className="flex-1 p-4" ref={scrollRef}>
            <div className="space-y-4 max-w-3xl mx-auto">
              {messages.map((message) => (
                <div
                  key={message.id}
                  className={cn(
                    "flex gap-3",
                    message.role === 'user' && "flex-row-reverse"
                  )}
                >
                  {/* Avatar */}
                  <div className={cn(
                    "w-8 h-8 rounded-full flex items-center justify-center shrink-0",
                    message.role === 'user' ? "bg-secondary" : "bg-primary/10"
                  )}>
                    {message.role === 'user' ? (
                      <User className="w-4 h-4" />
                    ) : (
                      <Bot className="w-4 h-4 text-primary" />
                    )}
                  </div>

                  {/* Message bubble */}
                  <div className={cn(
                    "max-w-[80%] rounded-xl px-4 py-3",
                    message.role === 'user' 
                      ? "bg-primary text-primary-foreground" 
                      : message.isError 
                        ? "bg-destructive/10 border border-destructive/20"
                        : "bg-secondary"
                  )}>
                    <MessageContent content={message.content} />

                    {/* Data visualizations */}
                    {message.data && message.data.type === 'table' && (
                      <DataTable data={message.data} />
                    )}
                    {message.data && message.data.type === 'metrics' && (
                      <MetricsCards data={message.data} />
                    )}

                    {/* Suggestions */}
                    {message.suggestions && message.suggestions.length > 0 && (
                      <div className="flex flex-wrap gap-2 mt-3">
                        {message.suggestions.map((suggestion, i) => (
                          <Button
                            key={i}
                            variant="outline"
                            size="sm"
                            className="text-xs h-7 bg-background"
                            onClick={() => handleSuggestionClick(suggestion)}
                            disabled={isLoading}
                          >
                            {suggestion}
                          </Button>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              ))}

              {/* Typing indicator */}
              {isLoading && <TypingIndicator />}
            </div>
          </ScrollArea>

          {/* Input */}
          <div className="p-4 border-t border-border">
            <form onSubmit={handleSubmit} className="flex gap-2 max-w-3xl mx-auto">
              <Input
                ref={inputRef}
                placeholder="Escribe tu pregunta..."
                disabled={isLoading}
                className="flex-1"
              />
              <Button type="submit" disabled={isLoading}>
                {isLoading ? (
                  <Loader2 className="w-4 h-4 animate-spin" />
                ) : (
                  <Send className="w-4 h-4" />
                )}
              </Button>
            </form>
            <p className="text-xs text-muted-foreground text-center mt-2">
              Pregunta sobre metricas, agentes, alertas o reportes de coaching
            </p>
          </div>
        </Card>
      </div>
    </>
  )
}
</file>

<file path="src/pages/Llamadas.tsx">
import { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import GestorLlamadas from '../components/llamadas/gestorLlamadas'; 

export default function Llamadas() {
  return (
    <div className="h-full w-full bg-gray-50 min-h-screen">
      
      {/* Encabezado Simple */}
      <div className="bg-white border-b border-gray-200 px-8 py-4 mb-6">
        <h1 className="text-2xl font-bold text-gray-800">Auditor√≠a de Llamadas</h1>
        <p className="text-sm text-gray-500">Sube grabaciones y revisa el an√°lisis de los Agentes IA</p>
      </div>

      {/* AQU√ç EST√Å LA MAGIA: Tu componente se renderiza aqu√≠ */}
      <div className="px-4">
        <GestorLlamadas />
      </div>

    </div>
  );
}
</file>

<file path="package.json">
{
  "name": "nodus",
  "private": true,
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc -b && vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "@radix-ui/react-avatar": "^1.1.2",
    "@radix-ui/react-dialog": "^1.1.4",
    "@radix-ui/react-dropdown-menu": "^2.1.4",
    "@radix-ui/react-popover": "^1.1.4",
    "@radix-ui/react-progress": "^1.1.1",
    "@radix-ui/react-scroll-area": "^1.2.2",
    "@radix-ui/react-select": "^2.1.4",
    "@radix-ui/react-separator": "^1.1.1",
    "@radix-ui/react-slot": "^1.1.1",
    "@radix-ui/react-tabs": "^1.1.2",
    "@radix-ui/react-tooltip": "^1.1.6",
    "@supabase/supabase-js": "^2.47.10",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "framer-motion": "^11.15.0",
    "lucide-react": "^0.468.0",
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "react-router-dom": "^7.1.1",
    "recharts": "^2.15.0",
    "repomix": "^1.11.1",
    "tailwind-merge": "^2.6.0",
    "zustand": "^5.0.2"
  },
  "devDependencies": {
    "@eslint/js": "^9.17.0",
    "@types/node": "^22.19.11",
    "@types/react": "^18.3.18",
    "@types/react-dom": "^18.3.5",
    "@vitejs/plugin-react": "^4.3.4",
    "autoprefixer": "^10.4.20",
    "eslint": "^9.17.0",
    "eslint-plugin-react-hooks": "^5.0.0",
    "eslint-plugin-react-refresh": "^0.4.16",
    "globals": "^15.14.0",
    "postcss": "^8.4.49",
    "tailwindcss": "^3.4.17",
    "typescript": "~5.6.2",
    "typescript-eslint": "^8.18.2",
    "vite": "^6.0.5"
  }
}
</file>

<file path="src/pages/Dashboard.tsx">
import { Phone, TrendingUp, Target, Wifi, WifiOff, RefreshCw } from 'lucide-react'
import { Header } from '@/components/layout/Header'
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card'
import { Tabs, TabsList, TabsTrigger } from '@/components/ui/tabs'
import { Button } from '@/components/ui/button'
import { KPICard, MetricCard, AlertasActivas, ActividadReciente, TopPerformers } from '@/components/dashboard'
import { TrendChart } from '@/components/charts/TrendChart'
import { formatNumber, formatCurrency, formatPercentage } from '@/lib/utils'
import { useDashboard } from '@/hooks/useDashboard'
import type { AlertaAnomalia } from '@/types'

// Mock data como fallback
import { mockAlertas, mockLlamadas, mockAnalisis } from '@/data/mockData'

export function Dashboard() {
  const {
    metrics,
    alertas,
    llamadasRecientes,
    topPerformers,
    tendencias,
    loading,
    realtimeConnected,
    refresh
  } = useDashboard()

  // Usar datos reales o mock como fallback
  const displayMetrics = metrics || {
    total_llamadas: 2847,
    llamadas_hoy: 127,
    score_promedio: 72,
    cambio_score: 5,
    tasa_validacion: 0.52,
    cambio_validacion: -3,
    probabilidad_promedio: 54,
    cambio_probabilidad: 2,
    alertas_activas: 3,
    monto_comprometido: 1250000
  }

  const displayAlertas = alertas.length > 0 ? alertas.map(a => ({
    alerta_id: a.alerta_id,
    tipo: a.tipo,
    severidad: a.severidad,
    descripcion: a.descripcion,
    causa_probable: a.causa_probable || '',
    impacto_estimado: {
      llamadas_afectadas: (a.impacto_estimado as Record<string, number>)?.llamadas_afectadas || 0,
      perdida_oportunidades: (a.impacto_estimado as Record<string, number>)?.perdida_oportunidades || 0
    },
    accion_recomendada: {
      urgencia: ((a.accion_recomendada as Record<string, string>)?.urgencia || 'hoy') as 'inmediata' | 'hoy' | 'esta_semana',
      destinatario: (a.accion_recomendada as Record<string, string>)?.destinatario || '',
      accion: (a.accion_recomendada as Record<string, string>)?.accion || ''
    },
    agentes_relacionados: a.agentes_relacionados || [],
    estado: a.estado,
    notificacion_enviada: a.notificacion_enviada || false,
    created_at: a.created_at
  })) as AlertaAnomalia[] : mockAlertas

  const displayLlamadas = llamadasRecientes.length > 0 ? llamadasRecientes.map(l => ({
    llamada_id: l.registro_id,
    audio_url: l.audio_url,
    duracion_segundos: l.duracion_segundos || 0,
    timestamp_inicio: l.timestamp_inicio,
    timestamp_fin: l.timestamp_fin,
    agente_id: l.agente_id,
    agente_nombre: l.agente_nombre || 'Agente',
    cliente_id: l.cliente_ref,
    campana: l.campana || '',
    tipo_deuda: l.tipo_deuda || '',
    estado: l.estado as 'pendiente' | 'transcrito' | 'analizado' | 'error',
    created_at: l.created_at,
    updated_at: l.updated_at,
    analisis: l.analisis ? {
      analisis_id: l.analisis.analisis_id,
      llamada_id: l.registro_id,
      transcripcion_id: l.analisis.transcripcion_id,
      score_total: l.analisis.score_total,
      score_contacto_directo: l.analisis.score_contacto_directo || 0,
      score_compromiso_pago: l.analisis.score_compromiso_pago || 0,
      modulo_contacto_directo: l.analisis.modulo_contacto_directo as any,
      modulo_compromiso_pago: l.analisis.modulo_compromiso_pago as any,
      modulo_abandono: l.analisis.modulo_abandono as any,
      prediccion_cumplimiento: {
        probabilidad: l.analisis.probabilidad_cumplimiento,
        nivel: l.analisis.nivel_cumplimiento,
        factores_positivos: [],
        factores_negativos: [],
        razonamiento: ''
      },
      alertas: [],
      recomendaciones: [],
      created_at: l.analisis.created_at
    } : undefined
  })) : mockLlamadas.map(l => ({
    ...l,
    analisis: mockAnalisis[l.llamada_id]
  }))

  const displayTopPerformers = topPerformers.length > 0 ? topPerformers : [
    { agente_id: '1', nombre: 'Carlos Ramirez', score: 89, llamadas: 145, validacion: 78, trend: 'up' as const },
    { agente_id: '5', nombre: 'Luis Torres', score: 82, llamadas: 132, validacion: 71, trend: 'stable' as const },
    { agente_id: '4', nombre: 'Ana Martinez', score: 78, llamadas: 128, validacion: 65, trend: 'up' as const },
    { agente_id: '2', nombre: 'Maria Gonzalez', score: 72, llamadas: 156, validacion: 52, trend: 'down' as const },
    { agente_id: '3', nombre: 'Jose Perez', score: 58, llamadas: 98, validacion: 38, trend: 'down' as const }
  ]

  // Sparkline data
  const sparkline1 = [30, 40, 35, 50, 49, 60, 70]
  const sparkline2 = [50, 40, 60, 45, 70, 55, 80]
  const sparkline3 = [20, 30, 25, 40, 35, 45, 50]

  // Chart data
  const chartData = tendencias.length > 0 
    ? tendencias.map(t => ({
        name: t.fecha,
        value: t.score,
        value2: t.validacion
      }))
    : [
        { name: 'Lun', value: 68, value2: 48 },
        { name: 'Mar', value: 71, value2: 51 },
        { name: 'Mie', value: 75, value2: 55 },
        { name: 'Jue', value: 73, value2: 53 },
        { name: 'Vie', value: 72, value2: 52 },
        { name: 'Sab', value: 74, value2: 54 },
        { name: 'Hoy', value: 72, value2: 52 }
      ]

  return (
    <>
      <Header title="Dashboard" />
      
      <div className="p-6 space-y-6">
        {/* Page title with tabs and realtime status */}
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-4">
            <h1 className="text-2xl font-semibold">Dashboard</h1>
            {/* Realtime indicator */}
            <div className="flex items-center gap-2 text-xs">
              {realtimeConnected ? (
                <>
                  <Wifi className="h-3.5 w-3.5 text-emerald-500" />
                  <span className="text-muted-foreground">En vivo</span>
                </>
              ) : (
                <>
                  <WifiOff className="h-3.5 w-3.5 text-muted-foreground" />
                  <span className="text-muted-foreground">Offline</span>
                </>
              )}
            </div>
          </div>
          <div className="flex items-center gap-4">
            <Button 
              variant="ghost" 
              size="sm" 
              onClick={refresh}
              disabled={loading}
              className="gap-2"
            >
              <RefreshCw className={`h-4 w-4 ${loading ? 'animate-spin' : ''}`} />
              Actualizar
            </Button>
            <Tabs defaultValue="overview">
              <TabsList>
                <TabsTrigger value="overview">Overview</TabsTrigger>
                <TabsTrigger value="analytics">Analytics</TabsTrigger>
                <TabsTrigger value="reports">Reports</TabsTrigger>
                <TabsTrigger value="notifications">Notifications</TabsTrigger>
              </TabsList>
            </Tabs>
          </div>
        </div>

        {/* KPIs Row */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <KPICard
            title="Llamadas Hoy"
            value={formatNumber(displayMetrics.llamadas_hoy)}
            change={15.54}
            changeLabel="vs ayer"
            icon={Phone}
            sparklineData={sparkline1}
          />
          <KPICard
            title="Score Promedio"
            value={displayMetrics.score_promedio}
            change={displayMetrics.cambio_score}
            changeLabel="vs semana anterior"
            icon={TrendingUp}
            sparklineData={sparkline2}
          />
          <KPICard
            title="Tasa Validacion"
            value={formatPercentage(displayMetrics.tasa_validacion * 100)}
            change={displayMetrics.cambio_validacion}
            changeLabel="vs semana anterior"
            icon={Target}
            sparklineData={sparkline3}
          />
          <MetricCard
            title="Monto Comprometido"
            value={formatCurrency(displayMetrics.monto_comprometido)}
            change="+20.1% from last month"
            sparklineData={[40, 35, 50, 45, 60, 55, 70, 65, 80]}
          />
        </div>

        {/* Charts Row */}
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Main chart */}
          <Card className="lg:col-span-2">
            <CardHeader>
              <CardTitle>Tendencia Semanal</CardTitle>
              <CardDescription>Score promedio y tasa de validacion</CardDescription>
            </CardHeader>
            <CardContent>
              <TrendChart 
                data={chartData}
                dataKey="value"
                dataKey2="value2"
                color="primary"
                color2="coral"
                height={280}
                showGrid
                showAxis
              />
            </CardContent>
          </Card>

          {/* Side metrics */}
          <div className="space-y-4">
            <MetricCard
              title="Total Llamadas"
              value={formatNumber(displayMetrics.total_llamadas)}
              change={`+${displayMetrics.llamadas_hoy} hoy`}
              sparklineData={[20, 40, 35, 50, 49, 60, 70, 91, 80, 70, 90, 100]}
            />
            <AlertasActivas alertas={displayAlertas} maxItems={3} />
          </div>
        </div>

        {/* Bottom Row */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <ActividadReciente llamadas={displayLlamadas} />
          <TopPerformers performers={displayTopPerformers} />
        </div>
      </div>
    </>
  )
}
</file>

<file path="src/hooks/useSupabase.ts">
// ============================================
// NODUS - Supabase Queries Hook
// ============================================

import { useState, useEffect, useCallback } from 'react'
import { supabase, isSupabaseConfigured } from '@/lib/supabase'
import type { 
  Agente, 
  RegistroLlamada, 
  AnalisisLlamada, 
  AlertaAnomalia,
  CoachingReport,
  ResumenAgente
} from '@/types/database'

// ---------- Types ----------

interface QueryState<T> {
  data: T | null
  loading: boolean
  error: Error | null
}

interface LlamadaConAnalisis extends RegistroLlamada {
  agente?: Agente
  analisis?: AnalisisLlamada
}

interface DashboardMetrics {
  total_llamadas: number
  llamadas_hoy: number
  score_promedio: number
  cambio_score: number
  tasa_validacion: number
  cambio_validacion: number
  probabilidad_promedio: number
  cambio_probabilidad: number
  alertas_activas: number
  monto_comprometido: number
}

// ---------- Generic Query Hook ----------

function useQuery<T>(
  queryFn: () => Promise<T>,
  deps: unknown[] = []
): QueryState<T> & { refetch: () => Promise<void> } {
  const [state, setState] = useState<QueryState<T>>({
    data: null,
    loading: true,
    error: null
  })

  const fetch = useCallback(async () => {
    if (!isSupabaseConfigured()) {
      setState({ data: null, loading: false, error: null })
      return
    }

    setState(prev => ({ ...prev, loading: true, error: null }))
    try {
      const data = await queryFn()
      setState({ data, loading: false, error: null })
    } catch (error) {
      setState({ data: null, loading: false, error: error as Error })
    }
  }, [queryFn])

  useEffect(() => {
    fetch()
  }, deps)

  return { ...state, refetch: fetch }
}

// ---------- Agentes ----------

export function useAgentes() {
  return useQuery<Agente[]>(async () => {
    const { data, error } = await supabase
      .from('agentes')
      .select('*')
      .eq('estado', 'activo')
      .order('nombre')

    if (error) throw error
    return data || []
  }, [])
}

export function useAgente(agenteId: string | undefined) {
  return useQuery<Agente | null>(async () => {
    if (!agenteId) return null

    const { data, error } = await supabase
      .from('agentes')
      .select('*')
      .eq('agente_id', agenteId)
      .single()

    if (error) throw error
    return data
  }, [agenteId])
}

export function useResumenAgentes() {
  return useQuery<ResumenAgente[]>(async () => {
    const { data, error } = await supabase
      .from('vista_resumen_agentes')
      .select('*')
      .order('score_semana', { ascending: false, nullsFirst: false })

    if (error) throw error
    return data || []
  }, [])
}

// ---------- Llamadas ----------

export function useLlamadas(limit = 50) {
  return useQuery<LlamadaConAnalisis[]>(async () => {
    const { data, error } = await supabase
      .from('registro_llamadas')
      .select(`
        *,
        agente:agentes!agente_id(nombre, email, equipo),
        analisis:analisis_llamadas!registro_id(*)
      `)
      .order('timestamp_inicio', { ascending: false })
      .limit(limit)

    if (error) throw error
    
    type RawData = RegistroLlamada & { agente: unknown; analisis: unknown[] }
    return ((data || []) as RawData[]).map((item) => ({
      ...item,
      agente: item.agente as Agente | undefined,
      analisis: (item.analisis as AnalisisLlamada[])?.[0]
    })) as LlamadaConAnalisis[]
  }, [limit])
}

export function useLlamada(registroId: string | undefined) {
  return useQuery<LlamadaConAnalisis | null>(async () => {
    if (!registroId) return null

    const { data, error } = await supabase
      .from('registro_llamadas')
      .select(`
        *,
        agente:agentes!agente_id(*),
        analisis:analisis_llamadas!registro_id(*),
        transcripcion:transcripciones!registro_id(*)
      `)
      .eq('registro_id', registroId)
      .single()

    if (error) throw error
    return data as unknown as LlamadaConAnalisis
  }, [registroId])
}

export function useLlamadasPorAgente(agenteId: string | undefined, limit = 25) {
  return useQuery<LlamadaConAnalisis[]>(async () => {
    if (!agenteId) return []

    const { data, error } = await supabase
      .from('registro_llamadas')
      .select(`
        *,
        analisis:analisis_llamadas!registro_id(*)
      `)
      .eq('agente_id', agenteId)
      .order('timestamp_inicio', { ascending: false })
      .limit(limit)

    if (error) throw error
    
    type RawData = RegistroLlamada & { analisis: unknown[] }
    return ((data || []) as RawData[]).map((item) => ({
      ...item,
      analisis: (item.analisis as AnalisisLlamada[])?.[0]
    })) as LlamadaConAnalisis[]
  }, [agenteId, limit])
}

// ---------- Alertas ----------

export function useAlertas(soloActivas = true) {
  return useQuery<AlertaAnomalia[]>(async () => {
    let query = supabase
      .from('alertas_anomalias')
      .select('*')
      .order('created_at', { ascending: false })

    if (soloActivas) {
      query = query.in('estado', ['nueva', 'en_revision'])
    }

    const { data, error } = await query.limit(100)

    if (error) throw error
    return data || []
  }, [soloActivas])
}

export function useAlertasCount() {
  return useQuery<{ total: number; criticas: number; altas: number }>(async () => {
    const { data, error } = await supabase
      .from('alertas_anomalias')
      .select('severidad')
      .in('estado', ['nueva', 'en_revision'])

    if (error) throw error

    const alertas = data || []
    return {
      total: alertas.length,
      criticas: alertas.filter((a: { severidad: string }) => a.severidad === 'critica').length,
      altas: alertas.filter((a: { severidad: string }) => a.severidad === 'alta').length
    }
  }, [])
}

// ---------- Coaching Reports ----------

export function useCoachingReports(agenteId?: string) {
  return useQuery<CoachingReport[]>(async () => {
    let query = supabase
      .from('coaching_reports')
      .select('*')
      .order('fecha_reporte', { ascending: false })

    if (agenteId) {
      query = query.eq('agente_id', agenteId)
    }

    const { data, error } = await query.limit(50)

    if (error) throw error
    return data || []
  }, [agenteId])
}

export function useUltimoCoachingReport(agenteId: string | undefined) {
  return useQuery<CoachingReport | null>(async () => {
    if (!agenteId) return null

    const { data, error } = await supabase
      .from('coaching_reports')
      .select('*')
      .eq('agente_id', agenteId)
      .order('fecha_reporte', { ascending: false })
      .limit(1)
      .single()

    if (error && error.code !== 'PGRST116') throw error
    return data || null
  }, [agenteId])
}

// ---------- Dashboard Metrics ----------

export function useDashboardMetrics() {
  return useQuery<DashboardMetrics>(async () => {
    const today = new Date().toISOString().split('T')[0]
    const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]

    // Total llamadas
    const { count: totalLlamadas } = await supabase
      .from('registro_llamadas')
      .select('*', { count: 'exact', head: true })

    // Llamadas hoy
    const { count: llamadasHoy } = await supabase
      .from('registro_llamadas')
      .select('*', { count: 'exact', head: true })
      .gte('timestamp_fecha', today)

    // Metricas de analisis (ultima semana)
    const { data: analisis } = await supabase
      .from('analisis_llamadas')
      .select('score_total, probabilidad_cumplimiento, modulo_compromiso_pago')
      .gte('fecha_llamada', weekAgo)

    // Alertas activas
    const { count: alertasActivas } = await supabase
      .from('alertas_anomalias')
      .select('*', { count: 'exact', head: true })
      .in('estado', ['nueva', 'en_revision'])

    // Calcular promedios
    const scores = analisis?.map((a: { score_total: number }) => a.score_total) || []
    const probs = analisis?.map((a: { probabilidad_cumplimiento: number }) => a.probabilidad_cumplimiento) || []
    
    const scorePromedio = scores.length > 0 
      ? Math.round(scores.reduce((a: number, b: number) => a + b, 0) / scores.length) 
      : 0

    const probPromedio = probs.length > 0
      ? Math.round(probs.reduce((a: number, b: number) => a + b, 0) / probs.length)
      : 0

    // Calcular tasa de validacion
    interface AnalisisWithModulo {
      modulo_compromiso_pago?: { desglose?: { validacion_cliente?: { tipo?: string } } }
    }
    const validaciones = analisis?.filter((a: AnalisisWithModulo) => {
      const modulo = a.modulo_compromiso_pago
      return modulo?.desglose?.validacion_cliente?.tipo === 'explicita'
    }) || []
    
    const tasaValidacion = analisis && analisis.length > 0
      ? validaciones.length / analisis.length
      : 0

    return {
      total_llamadas: totalLlamadas || 0,
      llamadas_hoy: llamadasHoy || 0,
      score_promedio: scorePromedio,
      cambio_score: 0, // TODO: calcular vs periodo anterior
      tasa_validacion: tasaValidacion,
      cambio_validacion: 0,
      probabilidad_promedio: probPromedio,
      cambio_probabilidad: 0,
      alertas_activas: alertasActivas || 0,
      monto_comprometido: 0 // TODO: sumar de transcripciones.entidades.montos
    }
  }, [])
}

// ---------- Tendencias ----------

export function useTendencias(dias = 7) {
  return useQuery<Array<{ fecha: string; llamadas: number; score: number; validacion: number }>>(async () => {
    const desde = new Date(Date.now() - dias * 24 * 60 * 60 * 1000).toISOString().split('T')[0]

    const { data, error } = await supabase
      .from('metricas_agregadas')
      .select('fecha, total_llamadas, score_promedio, tasa_validacion')
      .is('agente_id', null)
      .is('equipo', null)
      .gte('fecha', desde)
      .order('fecha')

    if (error) throw error

    return (data || []).map((m: { fecha: string; total_llamadas: number; score_promedio: number | null; tasa_validacion: number | null }) => ({
      fecha: new Date(m.fecha).toLocaleDateString('es', { weekday: 'short' }),
      llamadas: m.total_llamadas,
      score: m.score_promedio || 0,
      validacion: (m.tasa_validacion || 0) * 100
    }))
  }, [dias])
}

// ---------- Top Performers ----------

export function useTopPerformers(limit = 5) {
  return useQuery<Array<{
    agente_id: string
    nombre: string
    score: number
    llamadas: number
    validacion: number
    trend: 'up' | 'down' | 'stable'
  }>>(async () => {
    const { data, error } = await supabase
      .from('vista_resumen_agentes')
      .select('*')
      .not('score_semana', 'is', null)
      .order('score_semana', { ascending: false })
      .limit(limit)

    if (error) throw error

    return (data || []).map((a: ResumenAgente) => ({
      agente_id: a.agente_id,
      nombre: a.nombre,
      score: a.score_semana || 0,
      llamadas: a.llamadas_semana || 0,
      validacion: (a.tasa_validacion_ultimo_reporte || 0) * 100,
      trend: 'stable' as const // TODO: calcular tendencia
    }))
  }, [limit])
}
</file>

<file path="src/stores/dashboardStore.ts">
// ============================================
// NODUS - Dashboard Store (Zustand)
// Estado global con soporte para Realtime
// ============================================

import { create } from 'zustand'
import { supabase, isSupabaseConfigured } from '@/lib/supabase'
import type { 
  AlertaAnomalia, 
  AnalisisLlamada, 
  Agente,
  RegistroLlamada,
  ResumenAgente
} from '@/types/database'

// ---------- Types ----------

interface DashboardMetrics {
  total_llamadas: number
  llamadas_hoy: number
  score_promedio: number
  cambio_score: number
  tasa_validacion: number
  cambio_validacion: number
  probabilidad_promedio: number
  cambio_probabilidad: number
  alertas_activas: number
  monto_comprometido: number
}

interface Tendencia {
  fecha: string
  llamadas: number
  score: number
  validacion: number
}

interface TopPerformer {
  agente_id: string
  nombre: string
  score: number
  llamadas: number
  validacion: number
  trend: 'up' | 'down' | 'stable'
}

interface LlamadaConAnalisis extends RegistroLlamada {
  agente_nombre?: string
  analisis?: AnalisisLlamada
}

interface Notification {
  id: string
  type: 'alerta' | 'analisis' | 'coaching' | 'info'
  title: string
  message: string
  timestamp: string
  read: boolean
  data?: unknown
}

interface DashboardState {
  // Data
  metrics: DashboardMetrics | null
  alertas: AlertaAnomalia[]
  llamadasRecientes: LlamadaConAnalisis[]
  topPerformers: TopPerformer[]
  tendencias: Tendencia[]
  agentes: Agente[]
  resumenAgentes: ResumenAgente[]
  notifications: Notification[]
  
  // Status
  loading: boolean
  error: string | null
  realtimeConnected: boolean
  lastUpdate: string | null
  
  // Actions
  fetchDashboardData: () => Promise<void>
  fetchAlertas: () => Promise<void>
  fetchLlamadas: (limit?: number) => Promise<void>
  fetchAgentes: () => Promise<void>
  
  // Realtime handlers
  addAlerta: (alerta: AlertaAnomalia) => void
  updateAlerta: (alerta: AlertaAnomalia) => void
  addAnalisis: (analisis: AnalisisLlamada) => void
  updateLlamada: (llamada: RegistroLlamada) => void
  
  // Notifications
  addNotification: (notification: Omit<Notification, 'id' | 'timestamp' | 'read'>) => void
  markNotificationRead: (id: string) => void
  clearNotifications: () => void
  
  // Status
  setRealtimeConnected: (connected: boolean) => void
  setError: (error: string | null) => void
}

// ---------- Mock Data (fallback) ----------

const mockMetrics: DashboardMetrics = {
  total_llamadas: 2847,
  llamadas_hoy: 127,
  score_promedio: 72,
  cambio_score: 5,
  tasa_validacion: 0.52,
  cambio_validacion: -3,
  probabilidad_promedio: 54,
  cambio_probabilidad: 2,
  alertas_activas: 3,
  monto_comprometido: 1250000
}

const mockTendencias: Tendencia[] = [
  { fecha: 'Lun', llamadas: 412, score: 68, validacion: 48 },
  { fecha: 'Mar', llamadas: 445, score: 71, validacion: 51 },
  { fecha: 'Mie', llamadas: 398, score: 75, validacion: 55 },
  { fecha: 'Jue', llamadas: 467, score: 73, validacion: 53 },
  { fecha: 'Vie', llamadas: 489, score: 72, validacion: 52 },
  { fecha: 'Sab', llamadas: 312, score: 74, validacion: 54 },
  { fecha: 'Hoy', llamadas: 127, score: 72, validacion: 52 }
]

const mockTopPerformers: TopPerformer[] = [
  { agente_id: '1', nombre: 'Carlos Ramirez', score: 89, llamadas: 145, validacion: 78, trend: 'up' },
  { agente_id: '5', nombre: 'Luis Torres', score: 82, llamadas: 132, validacion: 71, trend: 'stable' },
  { agente_id: '4', nombre: 'Ana Martinez', score: 78, llamadas: 128, validacion: 65, trend: 'up' },
  { agente_id: '2', nombre: 'Maria Gonzalez', score: 72, llamadas: 156, validacion: 52, trend: 'down' },
  { agente_id: '3', nombre: 'Jose Perez', score: 58, llamadas: 98, validacion: 38, trend: 'down' }
]

// ---------- Store ----------

export const useDashboardStore = create<DashboardState>((set, get) => ({
  // Initial state
  metrics: null,
  alertas: [],
  llamadasRecientes: [],
  topPerformers: [],
  tendencias: [],
  agentes: [],
  resumenAgentes: [],
  notifications: [],
  loading: false,
  error: null,
  realtimeConnected: false,
  lastUpdate: null,

  // Fetch dashboard data
  fetchDashboardData: async () => {
    set({ loading: true, error: null })

    if (!isSupabaseConfigured()) {
      // Use mock data
      set({
        metrics: mockMetrics,
        tendencias: mockTendencias,
        topPerformers: mockTopPerformers,
        loading: false,
        lastUpdate: new Date().toISOString()
      })
      return
    }

    try {
      const today = new Date().toISOString().split('T')[0]
      const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]

      // Fetch metrics in parallel
      const [
        { count: totalLlamadas },
        { count: llamadasHoy },
        { data: analisis },
        { count: alertasActivas }
      ] = await Promise.all([
        supabase.from('registro_llamadas').select('*', { count: 'exact', head: true }),
        supabase.from('registro_llamadas').select('*', { count: 'exact', head: true }).gte('timestamp_fecha', today),
        supabase.from('analisis_llamadas').select('score_total, probabilidad_cumplimiento').gte('fecha_llamada', weekAgo),
        supabase.from('alertas_anomalias').select('*', { count: 'exact', head: true }).in('estado', ['nueva', 'en_revision'])
      ])

      const scores = analisis?.map((a: { score_total: number }) => a.score_total) || []
      const probs = analisis?.map((a: { probabilidad_cumplimiento: number }) => a.probabilidad_cumplimiento) || []

      const metrics: DashboardMetrics = {
        total_llamadas: totalLlamadas || 0,
        llamadas_hoy: llamadasHoy || 0,
        score_promedio: scores.length > 0 ? Math.round(scores.reduce((a: number, b: number) => a + b, 0) / scores.length) : 0,
        cambio_score: 0,
        tasa_validacion: 0.52, // TODO: calculate
        cambio_validacion: 0,
        probabilidad_promedio: probs.length > 0 ? Math.round(probs.reduce((a: number, b: number) => a + b, 0) / probs.length) : 0,
        cambio_probabilidad: 0,
        alertas_activas: alertasActivas || 0,
        monto_comprometido: 0
      }

      // Fetch tendencias
      const { data: metricasData } = await supabase
        .from('metricas_agregadas')
        .select('fecha, total_llamadas, score_promedio, tasa_validacion')
        .is('agente_id', null)
        .is('equipo', null)
        .gte('fecha', weekAgo)
        .order('fecha')

      const tendencias = (metricasData || mockTendencias.map(t => ({
        fecha: t.fecha,
        total_llamadas: t.llamadas,
        score_promedio: t.score,
        tasa_validacion: t.validacion / 100
      }))).map((m: { fecha: string; total_llamadas: number; score_promedio: number | null; tasa_validacion: number | null }) => ({
        fecha: typeof m.fecha === 'string' && m.fecha.includes('-') 
          ? new Date(m.fecha).toLocaleDateString('es', { weekday: 'short' })
          : m.fecha,
        llamadas: m.total_llamadas || 0,
        score: m.score_promedio || 0,
        validacion: (m.tasa_validacion || 0) * 100
      }))

      // Fetch top performers
      const { data: resumen } = await supabase
        .from('vista_resumen_agentes')
        .select('*')
        .not('score_semana', 'is', null)
        .order('score_semana', { ascending: false })
        .limit(5)

      const topPerformers = (resumen || []).map((a: { agente_id: string; nombre: string; score_semana: number | null; llamadas_semana: number | null; tasa_validacion_ultimo_reporte: number | null }) => ({
        agente_id: a.agente_id,
        nombre: a.nombre,
        score: a.score_semana || 0,
        llamadas: a.llamadas_semana || 0,
        validacion: (a.tasa_validacion_ultimo_reporte || 0) * 100,
        trend: 'stable' as const
      }))

      set({
        metrics,
        tendencias: tendencias.length > 0 ? tendencias : mockTendencias,
        topPerformers: topPerformers.length > 0 ? topPerformers : mockTopPerformers,
        loading: false,
        lastUpdate: new Date().toISOString()
      })
    } catch (error) {
      console.error('Error fetching dashboard data:', error)
      set({ 
        error: (error as Error).message, 
        loading: false,
        // Fallback to mock data
        metrics: mockMetrics,
        tendencias: mockTendencias,
        topPerformers: mockTopPerformers
      })
    }
  },

  // Fetch alertas
  fetchAlertas: async () => {
    if (!isSupabaseConfigured()) {
      set({ alertas: [] })
      return
    }

    try {
      const { data, error } = await supabase
        .from('alertas_anomalias')
        .select('*')
        .in('estado', ['nueva', 'en_revision'])
        .order('created_at', { ascending: false })
        .limit(100)

      if (error) throw error
      set({ alertas: data || [] })
    } catch (error) {
      console.error('Error fetching alertas:', error)
    }
  },

  // Fetch llamadas
  fetchLlamadas: async (limit = 10) => {
    if (!isSupabaseConfigured()) {
      set({ llamadasRecientes: [] })
      return
    }

    try {
      const { data, error } = await supabase
        .from('registro_llamadas')
        .select(`
          *,
          agente:agentes!agente_id(nombre),
          analisis:analisis_llamadas!registro_id(score_total, probabilidad_cumplimiento)
        `)
        .order('timestamp_inicio', { ascending: false })
        .limit(limit)

      if (error) throw error

      type RawData = RegistroLlamada & { agente: { nombre: string } | null; analisis: AnalisisLlamada[] }
      const llamadas = ((data || []) as RawData[]).map((item) => ({
        ...item,
        agente_nombre: item.agente?.nombre,
        analisis: item.analisis?.[0]
      })) as LlamadaConAnalisis[]

      set({ llamadasRecientes: llamadas })
    } catch (error) {
      console.error('Error fetching llamadas:', error)
    }
  },

  // Fetch agentes
  fetchAgentes: async () => {
    if (!isSupabaseConfigured()) {
      set({ agentes: [], resumenAgentes: [] })
      return
    }

    try {
      const [{ data: agentes }, { data: resumen }] = await Promise.all([
        supabase.from('agentes').select('*').eq('estado', 'activo').order('nombre'),
        supabase.from('vista_resumen_agentes').select('*').order('score_semana', { ascending: false, nullsFirst: false })
      ])

      set({ 
        agentes: agentes || [], 
        resumenAgentes: resumen || [] 
      })
    } catch (error) {
      console.error('Error fetching agentes:', error)
    }
  },

  // Realtime handlers
  addAlerta: (alerta) => {
    set(state => ({
      alertas: [alerta, ...state.alertas],
      metrics: state.metrics ? {
        ...state.metrics,
        alertas_activas: state.metrics.alertas_activas + 1
      } : null
    }))

    // Add notification
    get().addNotification({
      type: 'alerta',
      title: `Nueva alerta ${alerta.severidad}`,
      message: alerta.descripcion,
      data: alerta
    })
  },

  updateAlerta: (alerta) => {
    set(state => ({
      alertas: state.alertas.map(a => 
        a.alerta_id === alerta.alerta_id ? alerta : a
      )
    }))
  },

  addAnalisis: (analisis: AnalisisLlamada) => {
    set(state => ({
      metrics: state.metrics ? {
        ...state.metrics,
        total_llamadas: state.metrics.total_llamadas + 1,
        llamadas_hoy: state.metrics.llamadas_hoy + 1,
        score_promedio: Math.round((state.metrics.score_promedio * state.metrics.total_llamadas + analisis.score_total) / (state.metrics.total_llamadas + 1))
      } : null
    }))
    set(state => ({
      llamadasRecientes: state.llamadasRecientes.map(l => 
        l.registro_id === analisis.registro_id 
          ? { ...l, analisis: analisis, estado: 'analizado' }
          : l
      )
    }))
  },

 updateLlamada: (llamada) => {
    set(state => {
      const existe = state.llamadasRecientes.some(l => l.registro_id === llamada.registro_id);
      if (existe) {
        return {
          llamadasRecientes: state.llamadasRecientes.map(l =>
            l.registro_id === llamada.registro_id ? { ...l, ...llamada } : l
          )
        };
      } else {
        return {
          llamadasRecientes: [llamada, ...state.llamadasRecientes]
        };
      }
    })
  },

  // Notifications
  addNotification: (notification) => {
    const newNotification: Notification = {
      ...notification,
      id: crypto.randomUUID(),
      timestamp: new Date().toISOString(),
      read: false
    }

    set(state => ({
      notifications: [newNotification, ...state.notifications].slice(0, 50)
    }))
  },

  markNotificationRead: (id) => {
    set(state => ({
      notifications: state.notifications.map(n =>
        n.id === id ? { ...n, read: true } : n
      )
    }))
  },

  clearNotifications: () => {
    set({ notifications: [] })
  },

  // Status
  setRealtimeConnected: (connected) => {
    set({ realtimeConnected: connected })
  },

  setError: (error) => {
    set({ error })
  }
}))

// ---------- Selector Hooks ----------

export const useMetrics = () => useDashboardStore(state => state.metrics)
export const useAlertas = () => useDashboardStore(state => state.alertas)
export const useLlamadasRecientes = () => useDashboardStore(state => state.llamadasRecientes)
export const useTopPerformers = () => useDashboardStore(state => state.topPerformers)
export const useTendencias = () => useDashboardStore(state => state.tendencias)
export const useNotifications = () => useDashboardStore(state => state.notifications)
export const useUnreadNotificationsCount = () => useDashboardStore(
  state => state.notifications.filter(n => !n.read).length
)
</file>

</files>
