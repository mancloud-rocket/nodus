This file is a merged representation of a subset of the codebase, containing specifically included files and files not matching ignore patterns, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Only files matching these patterns are included: src/pages/**/*.tsx, src/components/**/*.tsx, src/app/**/*.tsx
- Files matching these patterns are excluded: **/*.css, **/*.test.tsx
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
src/
  components/
    charts/
      MiniBar.tsx
      ScoreGauge.tsx
      TrendChart.tsx
    dashboard/
      ActividadReciente.tsx
      AlertasActivas.tsx
      KPICard.tsx
      TopPerformers.tsx
    layout/
      Header.tsx
      MainLayout.tsx
      Sidebar.tsx
    llamadas/
      AudioPlayer.tsx
      gestorLlamadas.tsx
      LlamadaCard.tsx
      ModuloScore.tsx
      PrediccionCard.tsx
      TranscripcionViewer.tsx
    modulos/
      CumplimientoBar.tsx
      DonutMetric.tsx
      ImpactoElementosChart.tsx
      ModuloHeader.tsx
      PilarCard.tsx
      ProbabilidadFlow.tsx
    ui/
      avatar.tsx
      badge.tsx
      button.tsx
      card.tsx
      input.tsx
      progress.tsx
      scroll-area.tsx
      separator.tsx
      skeleton.tsx
      tabs.tsx
      tooltip.tsx
  pages/
    modulos/
      AbandonoLlamadas.tsx
      CompromisoPago.tsx
      ContactoDirecto.tsx
      ModulosOverview.tsx
    Agentes.tsx
    Alertas.tsx
    Chat.tsx
    Dashboard.tsx
    detalleLlamada.tsx
    Llamadas.tsx
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="src/components/charts/MiniBar.tsx">
import { cn } from '@/lib/utils'
import { motion } from 'framer-motion'

interface MiniBarProps {
  value: number
  max?: number
  color?: 'primary' | 'success' | 'warning' | 'destructive' | 'secondary'
  showValue?: boolean
  size?: 'sm' | 'md'
  label?: string
}

export function MiniBar({ 
  value, 
  max = 100, 
  color = 'primary',
  showValue = true,
  size = 'md',
  label
}: MiniBarProps) {
  const percentage = Math.min((value / max) * 100, 100)

  const colors = {
    primary: 'bg-primary',
    success: 'bg-success',
    warning: 'bg-warning',
    destructive: 'bg-destructive',
    secondary: 'bg-secondary',
  }

  const heights = {
    sm: 'h-1.5',
    md: 'h-2',
  }

  return (
    <div className="w-full">
      {(label || showValue) && (
        <div className="flex items-center justify-between mb-1.5">
          {label && (
            <span className="text-xs text-muted-foreground">{label}</span>
          )}
          {showValue && (
            <span className="text-xs font-mono text-foreground">{value}%</span>
          )}
        </div>
      )}
      <div className={cn("w-full rounded-full bg-muted/50 overflow-hidden", heights[size])}>
        <motion.div 
          className={cn("h-full rounded-full", colors[color])}
          initial={{ width: 0 }}
          animate={{ width: `${percentage}%` }}
          transition={{ duration: 0.8, ease: "easeOut" }}
        />
      </div>
    </div>
  )
}

interface StackedBarProps {
  segments: Array<{
    value: number
    color: 'primary' | 'success' | 'warning' | 'destructive' | 'secondary'
    label?: string
  }>
  total?: number
}

export function StackedBar({ segments, total }: StackedBarProps) {
  const sum = total || segments.reduce((acc, s) => acc + s.value, 0)

  const colors = {
    primary: 'bg-primary',
    success: 'bg-success',
    warning: 'bg-warning',
    destructive: 'bg-destructive',
    secondary: 'bg-secondary',
  }

  return (
    <div className="w-full">
      <div className="h-2 rounded-full bg-muted/50 overflow-hidden flex">
        {segments.map((segment, i) => {
          const percentage = (segment.value / sum) * 100
          return (
            <motion.div
              key={i}
              className={cn("h-full first:rounded-l-full last:rounded-r-full", colors[segment.color])}
              initial={{ width: 0 }}
              animate={{ width: `${percentage}%` }}
              transition={{ duration: 0.8, ease: "easeOut", delay: i * 0.1 }}
            />
          )
        })}
      </div>
      {segments.some(s => s.label) && (
        <div className="flex items-center gap-4 mt-2">
          {segments.map((segment, i) => (
            <div key={i} className="flex items-center gap-1.5">
              <div className={cn("w-2 h-2 rounded-full", colors[segment.color])} />
              <span className="text-xs text-muted-foreground">{segment.label}</span>
            </div>
          ))}
        </div>
      )}
    </div>
  )
}
</file>

<file path="src/components/charts/ScoreGauge.tsx">
import { cn } from '@/lib/utils'

interface ScoreGaugeProps {
  value: number
  max?: number
  size?: 'sm' | 'md' | 'lg'
  label?: string
  showValue?: boolean
}

export function ScoreGauge({ 
  value, 
  max = 100, 
  size = 'md', 
  label,
  showValue = true,
}: ScoreGaugeProps) {
  const percentage = (value / max) * 100
  const circumference = 2 * Math.PI * 45
  const strokeDashoffset = circumference - (percentage / 100) * circumference

  const sizes = {
    sm: { wrapper: 'w-16 h-16', text: 'text-lg', label: 'text-[10px]' },
    md: { wrapper: 'w-24 h-24', text: 'text-2xl', label: 'text-xs' },
    lg: { wrapper: 'w-32 h-32', text: 'text-4xl', label: 'text-sm' },
  }

  const getColor = () => {
    if (percentage >= 70) return { stroke: 'stroke-success', text: 'text-success' }
    if (percentage >= 40) return { stroke: 'stroke-warning', text: 'text-warning' }
    return { stroke: 'stroke-destructive', text: 'text-destructive' }
  }

  const colors = getColor()

  return (
    <div className={cn("relative flex items-center justify-center", sizes[size].wrapper)}>
      <svg className="w-full h-full -rotate-90" viewBox="0 0 100 100">
        <circle
          cx="50"
          cy="50"
          r="45"
          fill="none"
          stroke="currentColor"
          strokeWidth="8"
          className="text-secondary"
        />
        <circle
          cx="50"
          cy="50"
          r="45"
          fill="none"
          strokeWidth="8"
          strokeLinecap="round"
          className={colors.stroke}
          style={{
            strokeDasharray: circumference,
            strokeDashoffset,
            transition: 'stroke-dashoffset 0.5s ease-out',
          }}
        />
      </svg>
      
      <div className="absolute inset-0 flex flex-col items-center justify-center">
        {showValue && (
          <span className={cn("font-semibold", sizes[size].text, colors.text)}>
            {value}
          </span>
        )}
        {label && (
          <span className={cn("text-muted-foreground", sizes[size].label)}>
            {label}
          </span>
        )}
      </div>
    </div>
  )
}
</file>

<file path="src/components/charts/TrendChart.tsx">
import { 
  ResponsiveContainer, 
  AreaChart, 
  Area, 
  XAxis, 
  YAxis, 
  CartesianGrid, 
  Tooltip,
  TooltipProps
} from 'recharts'

interface DataPoint {
  name: string
  value: number
  value2?: number
  [key: string]: string | number | undefined
}

interface TrendChartProps {
  data: DataPoint[]
  dataKey?: string
  dataKey2?: string
  color?: 'primary' | 'success' | 'warning' | 'destructive' | 'coral'
  color2?: 'primary' | 'success' | 'warning' | 'destructive' | 'coral'
  height?: number
  showGrid?: boolean
  showAxis?: boolean
}

const colorMap = {
  primary: { stroke: 'hsl(173, 80%, 40%)', fill: 'hsl(173, 80%, 40%)' },
  success: { stroke: 'hsl(160, 84%, 39%)', fill: 'hsl(160, 84%, 39%)' },
  warning: { stroke: 'hsl(38, 92%, 50%)', fill: 'hsl(38, 92%, 50%)' },
  destructive: { stroke: 'hsl(0, 84%, 60%)', fill: 'hsl(0, 84%, 60%)' },
  coral: { stroke: 'hsl(340, 75%, 55%)', fill: 'hsl(340, 75%, 55%)' },
}

function CustomTooltip({ active, payload, label }: TooltipProps<number, string>) {
  if (active && payload && payload.length) {
    return (
      <div className="bg-popover border border-border rounded-lg shadow-lg px-3 py-2">
        <p className="text-xs text-muted-foreground mb-1">{label}</p>
        {payload.map((entry, index) => (
          <p key={index} className="text-sm font-medium" style={{ color: entry.color }}>
            {entry.value}
          </p>
        ))}
      </div>
    )
  }
  return null
}

export function TrendChart({ 
  data, 
  dataKey = 'value',
  dataKey2,
  color = 'primary',
  color2 = 'coral',
  height = 200,
  showGrid = false,
  showAxis = true,
}: TrendChartProps) {
  const colors = colorMap[color]
  const colors2 = colorMap[color2]

  return (
    <ResponsiveContainer width="100%" height={height}>
      <AreaChart data={data} margin={{ top: 5, right: 5, left: 0, bottom: 5 }}>
        <defs>
          <linearGradient id={`gradient-${color}`} x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stopColor={colors.fill} stopOpacity={0.2} />
            <stop offset="100%" stopColor={colors.fill} stopOpacity={0} />
          </linearGradient>
          {dataKey2 && (
            <linearGradient id={`gradient-${color2}`} x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stopColor={colors2.fill} stopOpacity={0.2} />
              <stop offset="100%" stopColor={colors2.fill} stopOpacity={0} />
            </linearGradient>
          )}
        </defs>
        
        {showGrid && (
          <CartesianGrid 
            strokeDasharray="3 3" 
            stroke="hsl(var(--border))" 
            vertical={false}
          />
        )}
        
        {showAxis && (
          <>
            <XAxis 
              dataKey="name" 
              axisLine={false}
              tickLine={false}
              tick={{ fill: 'hsl(var(--muted-foreground))', fontSize: 11 }}
              dy={10}
            />
            <YAxis 
              axisLine={false}
              tickLine={false}
              tick={{ fill: 'hsl(var(--muted-foreground))', fontSize: 11 }}
              dx={-10}
              width={35}
            />
          </>
        )}
        
        <Tooltip content={<CustomTooltip />} />
        
        <Area
          type="monotone"
          dataKey={dataKey}
          stroke={colors.stroke}
          strokeWidth={2}
          fill={`url(#gradient-${color})`}
        />

        {dataKey2 && (
          <Area
            type="monotone"
            dataKey={dataKey2}
            stroke={colors2.stroke}
            strokeWidth={2}
            fill={`url(#gradient-${color2})`}
          />
        )}
      </AreaChart>
    </ResponsiveContainer>
  )
}
</file>

<file path="src/components/dashboard/KPICard.tsx">
import { cn } from '@/lib/utils'
import { Card, CardContent } from '@/components/ui/card'
import { TrendingUp, TrendingDown, Info, LucideIcon } from 'lucide-react'
import {
  Tooltip,
  TooltipContent,
  TooltipTrigger,
} from '@/components/ui/tooltip'

interface KPICardProps {
  title: string
  value: string | number
  change?: number
  changeLabel?: string
  icon?: LucideIcon
  sparklineData?: number[]
}

function MiniSparkline({ data }: { data: number[] }) {
  const max = Math.max(...data)
  const min = Math.min(...data)
  const range = max - min || 1
  
  const points = data.map((value, index) => {
    const x = (index / (data.length - 1)) * 100
    const y = 100 - ((value - min) / range) * 100
    return `${x},${y}`
  }).join(' ')

  return (
    <svg className="w-20 h-8" viewBox="0 0 100 100" preserveAspectRatio="none">
      <polyline
        fill="none"
        stroke="currentColor"
        strokeWidth="3"
        strokeLinecap="round"
        strokeLinejoin="round"
        points={points}
        className="text-primary"
      />
    </svg>
  )
}

export function KPICard({ 
  title, 
  value, 
  change, 
  changeLabel = 'Since Last week',
  icon: Icon,
  sparklineData
}: KPICardProps) {
  const isPositive = change && change > 0
  const isNegative = change && change < 0

  return (
    <Card>
      <CardContent className="p-5">
        <div className="flex items-start justify-between mb-3">
          <div className="flex items-center gap-2 text-sm text-muted-foreground">
            {Icon && <Icon className="w-4 h-4" />}
            <span>{title}</span>
          </div>
          <Tooltip>
            <TooltipTrigger>
              <Info className="w-4 h-4 text-muted-foreground/50" />
            </TooltipTrigger>
            <TooltipContent>
              <p>More information about {title}</p>
            </TooltipContent>
          </Tooltip>
        </div>

        <div className="flex items-end justify-between">
          <div>
            <p className="text-3xl font-semibold tracking-tight">{value}</p>
            {changeLabel && (
              <p className="text-xs text-muted-foreground mt-1">{changeLabel}</p>
            )}
          </div>
          
          {sparklineData ? (
            <MiniSparkline data={sparklineData} />
          ) : null}
        </div>

        {change !== undefined && (
          <div className="flex items-center gap-2 mt-3 pt-3 border-t border-border">
            <span className="text-sm text-muted-foreground">Details</span>
            <div className={cn(
              "flex items-center gap-1 ml-auto text-sm font-medium",
              isPositive && "text-success",
              isNegative && "text-destructive"
            )}>
              {isPositive && <TrendingUp className="w-4 h-4" />}
              {isNegative && <TrendingDown className="w-4 h-4" />}
              {Math.abs(change)}%
            </div>
          </div>
        )}
      </CardContent>
    </Card>
  )
}

// Variante m√°s compacta para m√©tricas secundarias
interface MetricCardProps {
  title: string
  value: string | number
  change?: string
  sparklineData?: number[]
  className?: string
}

export function MetricCard({ title, value, change, sparklineData, className }: MetricCardProps) {
  return (
    <Card className={className}>
      <CardContent className="p-5">
        <p className="text-sm text-muted-foreground mb-1">{title}</p>
        <div className="flex items-end justify-between">
          <div>
            <p className="text-2xl font-semibold">{value}</p>
            {change && (
              <p className="text-xs text-muted-foreground mt-0.5">{change}</p>
            )}
          </div>
          {sparklineData && <MiniSparkline data={sparklineData} />}
        </div>
      </CardContent>
    </Card>
  )
}
</file>

<file path="src/components/layout/MainLayout.tsx">
import { Outlet } from 'react-router-dom'
import { Sidebar } from './Sidebar'

export function MainLayout() {
  return (
    <div className="min-h-screen bg-secondary/30">
      <Sidebar />
      
      {/* Main content */}
      <main className="ml-64">
        <Outlet />
      </main>
    </div>
  )
}
</file>

<file path="src/components/llamadas/LlamadaCard.tsx">
import { Clock, AlertTriangle, ChevronRight } from 'lucide-react'
import { Card, CardContent } from '@/components/ui/card'
import { Avatar, AvatarFallback } from '@/components/ui/avatar'
import { Badge } from '@/components/ui/badge'
import { Progress } from '@/components/ui/progress'
import { cn, formatDuration, formatRelativeTime } from '@/lib/utils'
import type { Llamada, AnalisisLlamada } from '@/types'
import { Link } from 'react-router-dom'

interface LlamadaCardProps {
  llamada: Llamada
  analisis?: AnalisisLlamada
  index?: number
}

export function LlamadaCard({ llamada, analisis }: LlamadaCardProps) {
  const score = analisis?.score_total
  const probabilidad = analisis?.prediccion_cumplimiento.probabilidad
  const alertas = analisis?.alertas || []
  const tieneAlertaCritica = alertas.some(a => a.tipo === 'critica')

  return (
    <Link to={`/llamadas/${llamada.llamada_id}`}>
      <Card className={cn(
        "group cursor-pointer transition-all hover:shadow-md",
        tieneAlertaCritica && "border-destructive/50"
      )}>
        <CardContent className="p-4">
          <div className="flex items-center gap-4">
            <div className="relative">
              <Avatar className="h-10 w-10">
                <AvatarFallback className="text-xs bg-primary/10 text-primary">
                  {llamada.agente_nombre?.split(' ').map(n => n[0]).join('') || 'AG'}
                </AvatarFallback>
              </Avatar>
              {tieneAlertaCritica && (
                <div className="absolute -top-1 -right-1 w-4 h-4 bg-destructive rounded-full flex items-center justify-center">
                  <AlertTriangle className="w-2.5 h-2.5 text-white" />
                </div>
              )}
            </div>

            <div className="flex-1 min-w-0">
              <div className="flex items-center gap-2 mb-0.5">
                <span className="font-medium text-sm">{llamada.agente_nombre || 'Agente'}</span>
                <span className="text-muted-foreground text-sm">‚Üí</span>
                <span className="text-sm text-muted-foreground truncate">
                  {llamada.cliente_id}
                </span>
              </div>
              <div className="flex items-center gap-3 text-xs text-muted-foreground">
                <span className="flex items-center gap-1">
                  <Clock className="w-3 h-3" />
                  {formatDuration(llamada.duracion_segundos)}
                </span>
                <span>{formatRelativeTime(new Date(llamada.timestamp_inicio))}</span>
              </div>
            </div>

            {analisis ? (
              <div className="flex items-center gap-4">
                <div className="text-right">
                  <p className="text-xs text-muted-foreground">Score</p>
                  <p className={cn(
                    "text-lg font-semibold",
                    score && score >= 70 ? "text-success" : 
                    score && score >= 40 ? "text-warning" : "text-destructive"
                  )}>
                    {score}
                  </p>
                </div>

                <div className="w-20">
                  <p className="text-xs text-muted-foreground mb-1">Prob.</p>
                  <Progress 
                    value={probabilidad} 
                    variant={
                      probabilidad && probabilidad >= 60 ? 'success' : 
                      probabilidad && probabilidad >= 35 ? 'warning' : 'destructive'
                    }
                    className="h-1.5"
                  />
                  <p className="text-xs text-right mt-0.5">{probabilidad}%</p>
                </div>
              </div>
            ) : (
              <Badge variant="secondary">
                {llamada.estado === 'transcrito' ? 'Procesando' : 'Pendiente'}
              </Badge>
            )}

            <ChevronRight className="w-4 h-4 text-muted-foreground group-hover:text-foreground transition-colors" />
          </div>
        </CardContent>
      </Card>
    </Link>
  )
}
</file>

<file path="src/components/modulos/CumplimientoBar.tsx">
import { cn } from '@/lib/utils'

interface CumplimientoBarProps {
  variable: string
  porcentaje: number
  puntos?: number
  pesoMaximo?: number
  color?: 'primary' | 'coral' | 'amber' | 'emerald'
}

export function CumplimientoBar({ 
  variable, 
  porcentaje, 
  puntos,
  pesoMaximo,
  color = 'primary'
}: CumplimientoBarProps) {
  // Determinar color de fondo basado en prop
  const bgColor = {
    primary: 'bg-emerald-500',
    coral: 'bg-coral-500',
    amber: 'bg-amber-500',
    emerald: 'bg-emerald-500'
  }[color]

  return (
    <div className="space-y-1.5">
      <div className="flex items-center justify-between text-sm">
        <span className="font-medium">{variable}</span>
        <div className="flex items-center gap-2">
          {puntos !== undefined && pesoMaximo !== undefined && (
            <span className="text-xs text-muted-foreground">
              {puntos}/{pesoMaximo} pts
            </span>
          )}
          <span className="font-semibold">{porcentaje}%</span>
        </div>
      </div>
      
      <div className="h-2.5 bg-muted rounded-full overflow-hidden">
        <div 
          className={cn(
            "h-full rounded-full transition-all duration-500",
            bgColor
          )}
          style={{ width: `${Math.max(Math.min(100, porcentaje), 3)}%` }}
        />
      </div>
    </div>
  )
}
</file>

<file path="src/components/modulos/DonutMetric.tsx">
import { cn } from '@/lib/utils'

interface DonutMetricProps {
  value: number
  label: string
  sublabel?: string
  size?: 'sm' | 'md' | 'lg'
  color?: 'primary' | 'coral' | 'amber' | 'emerald' | 'red'
}

const sizeMap = {
  sm: { outer: 80, inner: 60, stroke: 10, text: 'text-lg' },
  md: { outer: 120, inner: 90, stroke: 15, text: 'text-2xl' },
  lg: { outer: 160, inner: 120, stroke: 20, text: 'text-3xl' }
}

const colorMap = {
  primary: '#0088FE',
  coral: '#FF6B6B',
  amber: '#F59E0B',
  emerald: '#10B981',
  red: '#EF4444'
}

export function DonutMetric({ 
  value, 
  label, 
  sublabel,
  size = 'md',
  color = 'primary'
}: DonutMetricProps) {
  const dims = sizeMap[size]
  const radius = (dims.outer - dims.stroke) / 2
  const circumference = 2 * Math.PI * radius
  const strokeDashoffset = circumference - (value / 100) * circumference
  
  return (
    <div className="flex flex-col items-center">
      <div className="relative" style={{ width: dims.outer, height: dims.outer }}>
        <svg 
          className="transform -rotate-90" 
          width={dims.outer} 
          height={dims.outer}
        >
          {/* Background circle */}
          <circle
            cx={dims.outer / 2}
            cy={dims.outer / 2}
            r={radius}
            fill="none"
            stroke="currentColor"
            strokeWidth={dims.stroke}
            className="text-muted/20"
          />
          {/* Progress circle */}
          <circle
            cx={dims.outer / 2}
            cy={dims.outer / 2}
            r={radius}
            fill="none"
            stroke={colorMap[color]}
            strokeWidth={dims.stroke}
            strokeDasharray={circumference}
            strokeDashoffset={strokeDashoffset}
            strokeLinecap="round"
            className="transition-all duration-500"
          />
        </svg>
        
        {/* Center value */}
        <div className="absolute inset-0 flex items-center justify-center">
          <span className={cn("font-bold", dims.text)}>
            {value}%
          </span>
        </div>
      </div>
      
      <p className="mt-2 text-sm font-medium text-center">{label}</p>
      {sublabel && (
        <p className="text-xs text-muted-foreground text-center">{sublabel}</p>
      )}
    </div>
  )
}
</file>

<file path="src/components/modulos/ImpactoElementosChart.tsx">
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { cn } from '@/lib/utils'

interface ElementoData {
  categoria: string
  total_llamadas: number
  prob_promedio: number | null
  porcentaje_del_total: number | null
}

interface ImpactoElementosChartProps {
  data: ElementoData[]
  titulo?: string
}

export function ImpactoElementosChart({ data, titulo = "Impacto por Elementos" }: ImpactoElementosChartProps) {
  // Encontrar el maximo para escalar las barras (minimo 100)
  const maxProb = Math.max(...data.map(d => d.prob_promedio || 0), 100)
  
  return (
    <Card>
      <CardHeader>
        <CardTitle className="text-base">{titulo}</CardTitle>
      </CardHeader>
      <CardContent>
        <div className="space-y-4">
          {data.map((item, index) => {
            const prob = item.prob_promedio || 0
            const barWidth = (prob / maxProb) * 100
            const isLast = index === data.length - 1
            
            return (
              <div key={item.categoria} className="space-y-1">
                {/* Labels row */}
                <div className="flex items-center justify-between">
                  <span className="text-xs text-muted-foreground">
                    {item.categoria}
                  </span>
                  <span className="text-xs font-medium text-muted-foreground">
                    {item.total_llamadas} llamadas
                  </span>
                </div>
                
                {/* Bar row with percentage always visible */}
                <div className="flex items-center gap-3">
                  <div className="flex-1 h-8 bg-muted rounded overflow-hidden">
                    <div 
                      className={cn(
                        "h-full rounded transition-all duration-500",
                        isLast ? "bg-emerald-500" : "bg-emerald-400"
                      )}
                      style={{ width: `${Math.max(barWidth, 8)}%` }}
                    />
                  </div>
                  {/* Percentage always outside and visible */}
                  <span className={cn(
                    "text-sm font-bold min-w-[50px] text-right",
                    isLast ? "text-emerald-600" : "text-emerald-500"
                  )}>
                    {prob.toFixed(1)}%
                  </span>
                </div>
              </div>
            )
          })}
        </div>
        
        {/* Legend */}
        <div className="mt-4 pt-4 border-t">
          <p className="text-xs text-muted-foreground">
            Probabilidad promedio de cumplimiento segun elementos de compromiso presentes
          </p>
        </div>
      </CardContent>
    </Card>
  )
}
</file>

<file path="src/components/modulos/ModuloHeader.tsx">
import { Badge } from '@/components/ui/badge'
import { cn } from '@/lib/utils'

interface ModuloHeaderProps {
  badge: string
  titulo: string
  subtitulo?: string
  color?: 'primary' | 'coral' | 'amber' | 'emerald'
}

export function ModuloHeader({ badge, titulo, subtitulo, color = 'primary' }: ModuloHeaderProps) {
  // Gradientes con colores hardcodeados para evitar problemas con Tailwind
  const gradientStyles = {
    primary: 'bg-gradient-to-r from-[#0088FE] to-[#0066CC]',
    coral: 'bg-gradient-to-r from-[#FF6B6B] to-[#FF4757]',
    amber: 'bg-gradient-to-r from-[#F59E0B] to-[#D97706]',
    emerald: 'bg-gradient-to-r from-[#10B981] to-[#059669]'
  }

  return (
    <div className={cn(
      "rounded-xl p-6 mb-6",
      gradientStyles[color]
    )}>
      <Badge variant="outline" className="bg-white/20 text-white border-white/30 mb-3">
        {badge}
      </Badge>
      <h1 className="text-2xl md:text-3xl font-bold text-white mb-2">
        {titulo}
      </h1>
      {subtitulo && (
        <p className="text-white/80 text-sm md:text-base max-w-3xl">
          {subtitulo}
        </p>
      )}
    </div>
  )
}
</file>

<file path="src/components/modulos/PilarCard.tsx">
import { Card, CardContent } from '@/components/ui/card'
import { cn } from '@/lib/utils'
import { TrendingUp, TrendingDown, Minus } from 'lucide-react'

interface PilarCardProps {
  titulo: string
  descripcion: string
  score: number
  peso?: string
  cambio?: number
  color?: 'primary' | 'coral' | 'amber' | 'emerald'
  size?: 'default' | 'large'
}

const colorMap = {
  primary: {
    bg: 'bg-blue-500/10',
    text: 'text-blue-600',
    border: 'border-blue-500/20'
  },
  coral: {
    bg: 'bg-red-500/10',
    text: 'text-red-500',
    border: 'border-red-500/20'
  },
  amber: {
    bg: 'bg-amber-500/10',
    text: 'text-amber-600',
    border: 'border-amber-500/20'
  },
  emerald: {
    bg: 'bg-emerald-500/10',
    text: 'text-emerald-600',
    border: 'border-emerald-500/20'
  }
}

export function PilarCard({ 
  titulo, 
  descripcion, 
  score, 
  peso,
  cambio,
  color = 'primary',
  size = 'default'
}: PilarCardProps) {
  const colors = colorMap[color]
  
  return (
    <Card className={cn(
      "relative overflow-hidden transition-all hover:shadow-md",
      size === 'large' && "p-2"
    )}>
      <CardContent className={cn("p-4", size === 'large' && "p-6")}>
        {peso && (
          <div className={cn(
            "absolute top-3 right-3 px-2 py-1 rounded-full text-xs font-semibold",
            colors.bg,
            colors.text
          )}>
            {peso}
          </div>
        )}
        
        <h3 className={cn(
          "font-semibold mb-1",
          colors.text,
          size === 'large' ? "text-lg" : "text-sm"
        )}>
          {titulo}
        </h3>
        
        <p className={cn(
          "text-muted-foreground mb-4 line-clamp-2",
          size === 'large' ? "text-sm" : "text-xs"
        )}>
          {descripcion}
        </p>
        
        <div className="flex items-end justify-between">
          <div>
            <p className={cn(
              "font-bold",
              size === 'large' ? "text-3xl" : "text-2xl"
            )}>
              {score}
              <span className="text-sm font-normal text-muted-foreground ml-1">pts</span>
            </p>
          </div>
          
          {cambio !== undefined && (
            <div className={cn(
              "flex items-center gap-1 text-xs",
              cambio > 0 ? "text-emerald-600" : cambio < 0 ? "text-red-500" : "text-muted-foreground"
            )}>
              {cambio > 0 ? (
                <TrendingUp className="w-3 h-3" />
              ) : cambio < 0 ? (
                <TrendingDown className="w-3 h-3" />
              ) : (
                <Minus className="w-3 h-3" />
              )}
              <span>{cambio > 0 ? '+' : ''}{cambio}%</span>
            </div>
          )}
        </div>
      </CardContent>
    </Card>
  )
}
</file>

<file path="src/components/ui/avatar.tsx">
import * as React from "react"
import * as AvatarPrimitive from "@radix-ui/react-avatar"
import { cn } from "@/lib/utils"

const Avatar = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Root
    ref={ref}
    className={cn(
      "relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",
      className
    )}
    {...props}
  />
))
Avatar.displayName = AvatarPrimitive.Root.displayName

const AvatarImage = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Image>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Image
    ref={ref}
    className={cn("aspect-square h-full w-full", className)}
    {...props}
  />
))
AvatarImage.displayName = AvatarPrimitive.Image.displayName

const AvatarFallback = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Fallback>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Fallback
    ref={ref}
    className={cn(
      "flex h-full w-full items-center justify-center rounded-full bg-muted",
      className
    )}
    {...props}
  />
))
AvatarFallback.displayName = AvatarPrimitive.Fallback.displayName

export { Avatar, AvatarImage, AvatarFallback }
</file>

<file path="src/components/ui/badge.tsx">
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"
import { cn } from "@/lib/utils"

const badgeVariants = cva(
  "inline-flex items-center rounded-md border px-2 py-0.5 text-xs font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary/10 text-primary",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground",
        destructive:
          "border-transparent bg-destructive/10 text-destructive",
        success:
          "border-transparent bg-success/10 text-success",
        warning:
          "border-transparent bg-warning/10 text-warning",
        outline:
          "border-border text-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

export interface BadgeProps
  extends React.HTMLAttributes<HTMLDivElement>,
    VariantProps<typeof badgeVariants> {}

function Badge({ className, variant, ...props }: BadgeProps) {
  return (
    <div className={cn(badgeVariants({ variant }), className)} {...props} />
  )
}

export { Badge, badgeVariants }
</file>

<file path="src/components/ui/button.tsx">
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"
import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-lg text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
  {
    variants: {
      variant: {
        default:
          "bg-primary text-primary-foreground hover:bg-primary/90",
        destructive:
          "bg-destructive text-destructive-foreground hover:bg-destructive/90",
        outline:
          "border border-input bg-background hover:bg-accent hover:text-accent-foreground",
        secondary:
          "bg-secondary text-secondary-foreground hover:bg-secondary/80",
        ghost:
          "hover:bg-accent hover:text-accent-foreground",
        link:
          "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-9 px-4 py-2",
        sm: "h-8 rounded-md px-3 text-xs",
        lg: "h-10 rounded-lg px-6",
        icon: "h-9 w-9",
        "icon-sm": "h-8 w-8",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  asChild?: boolean
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, asChild = false, ...props }, ref) => {
    const Comp = asChild ? Slot : "button"
    return (
      <Comp
        className={cn(buttonVariants({ variant, size, className }))}
        ref={ref}
        {...props}
      />
    )
  }
)
Button.displayName = "Button"

export { Button, buttonVariants }
</file>

<file path="src/components/ui/card.tsx">
import * as React from "react"
import { cn } from "@/lib/utils"

const Card = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "rounded-xl border border-border bg-card text-card-foreground shadow-sm",
      className
    )}
    {...props}
  />
))
Card.displayName = "Card"

const CardHeader = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex flex-col space-y-1.5 p-6", className)}
    {...props}
  />
))
CardHeader.displayName = "CardHeader"

const CardTitle = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "text-base font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
CardTitle.displayName = "CardTitle"

const CardDescription = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
CardDescription.displayName = "CardDescription"

const CardContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
))
CardContent.displayName = "CardContent"

const CardFooter = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex items-center p-6 pt-0", className)}
    {...props}
  />
))
CardFooter.displayName = "CardFooter"

export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }
</file>

<file path="src/components/ui/input.tsx">
import * as React from "react"
import { cn } from "@/lib/utils"

const Input = React.forwardRef<HTMLInputElement, React.ComponentProps<"input">>(
  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        className={cn(
          "flex h-10 w-full rounded-lg border border-border bg-input px-4 py-2 text-sm text-foreground transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:border-primary disabled:cursor-not-allowed disabled:opacity-50",
          className
        )}
        ref={ref}
        {...props}
      />
    )
  }
)
Input.displayName = "Input"

export { Input }
</file>

<file path="src/components/ui/progress.tsx">
import * as React from "react"
import * as ProgressPrimitive from "@radix-ui/react-progress"
import { cn } from "@/lib/utils"

interface ProgressProps extends React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root> {
  variant?: 'default' | 'success' | 'warning' | 'destructive'
}

const Progress = React.forwardRef<
  React.ElementRef<typeof ProgressPrimitive.Root>,
  ProgressProps
>(({ className, value, variant = 'default', ...props }, ref) => {
  const indicatorVariants = {
    default: "bg-primary",
    success: "bg-success",
    warning: "bg-warning",
    destructive: "bg-destructive",
  }

  return (
    <ProgressPrimitive.Root
      ref={ref}
      className={cn(
        "relative h-2 w-full overflow-hidden rounded-full bg-secondary",
        className
      )}
      {...props}
    >
      <ProgressPrimitive.Indicator
        className={cn(
          "h-full w-full flex-1 transition-all duration-300",
          indicatorVariants[variant]
        )}
        style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
      />
    </ProgressPrimitive.Root>
  )
})
Progress.displayName = ProgressPrimitive.Root.displayName

export { Progress }
</file>

<file path="src/components/ui/scroll-area.tsx">
import * as React from "react"
import * as ScrollAreaPrimitive from "@radix-ui/react-scroll-area"
import { cn } from "@/lib/utils"

const ScrollArea = React.forwardRef<
  React.ElementRef<typeof ScrollAreaPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>
>(({ className, children, ...props }, ref) => (
  <ScrollAreaPrimitive.Root
    ref={ref}
    className={cn("relative overflow-hidden", className)}
    {...props}
  >
    <ScrollAreaPrimitive.Viewport className="h-full w-full rounded-[inherit]">
      {children}
    </ScrollAreaPrimitive.Viewport>
    <ScrollBar />
    <ScrollAreaPrimitive.Corner />
  </ScrollAreaPrimitive.Root>
))
ScrollArea.displayName = ScrollAreaPrimitive.Root.displayName

const ScrollBar = React.forwardRef<
  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,
  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>
>(({ className, orientation = "vertical", ...props }, ref) => (
  <ScrollAreaPrimitive.ScrollAreaScrollbar
    ref={ref}
    orientation={orientation}
    className={cn(
      "flex touch-none select-none transition-colors",
      orientation === "vertical" &&
        "h-full w-2 border-l border-l-transparent p-[1px]",
      orientation === "horizontal" &&
        "h-2 flex-col border-t border-t-transparent p-[1px]",
      className
    )}
    {...props}
  >
    <ScrollAreaPrimitive.ScrollAreaThumb className="relative flex-1 rounded-full bg-border hover:bg-muted-foreground/30" />
  </ScrollAreaPrimitive.ScrollAreaScrollbar>
))
ScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName

export { ScrollArea, ScrollBar }
</file>

<file path="src/components/ui/separator.tsx">
import * as React from "react"
import * as SeparatorPrimitive from "@radix-ui/react-separator"
import { cn } from "@/lib/utils"

const Separator = React.forwardRef<
  React.ElementRef<typeof SeparatorPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>
>(
  (
    { className, orientation = "horizontal", decorative = true, ...props },
    ref
  ) => (
    <SeparatorPrimitive.Root
      ref={ref}
      decorative={decorative}
      orientation={orientation}
      className={cn(
        "shrink-0 bg-border",
        orientation === "horizontal" ? "h-[1px] w-full" : "h-full w-[1px]",
        className
      )}
      {...props}
    />
  )
)
Separator.displayName = SeparatorPrimitive.Root.displayName

export { Separator }
</file>

<file path="src/components/ui/skeleton.tsx">
import { cn } from "@/lib/utils"

function Skeleton({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) {
  return (
    <div
      className={cn("shimmer rounded-md", className)}
      {...props}
    />
  )
}

export { Skeleton }
</file>

<file path="src/components/ui/tabs.tsx">
import * as React from "react"
import * as TabsPrimitive from "@radix-ui/react-tabs"
import { cn } from "@/lib/utils"

const Tabs = TabsPrimitive.Root

const TabsList = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.List
    ref={ref}
    className={cn(
      "inline-flex h-11 items-center justify-center rounded-lg bg-muted p-1 text-muted-foreground",
      className
    )}
    {...props}
  />
))
TabsList.displayName = TabsPrimitive.List.displayName

const TabsTrigger = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Trigger
    ref={ref}
    className={cn(
      "inline-flex items-center justify-center whitespace-nowrap rounded-md px-4 py-2 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-card data-[state=active]:text-foreground data-[state=active]:shadow-sm data-[state=active]:border data-[state=active]:border-border",
      className
    )}
    {...props}
  />
))
TabsTrigger.displayName = TabsPrimitive.Trigger.displayName

const TabsContent = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Content
    ref={ref}
    className={cn(
      "mt-4 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
      className
    )}
    {...props}
  />
))
TabsContent.displayName = TabsPrimitive.Content.displayName

export { Tabs, TabsList, TabsTrigger, TabsContent }
</file>

<file path="src/components/ui/tooltip.tsx">
import * as React from "react"
import * as TooltipPrimitive from "@radix-ui/react-tooltip"
import { cn } from "@/lib/utils"

const TooltipProvider = TooltipPrimitive.Provider

const Tooltip = TooltipPrimitive.Root

const TooltipTrigger = TooltipPrimitive.Trigger

const TooltipContent = React.forwardRef<
  React.ElementRef<typeof TooltipPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <TooltipPrimitive.Portal>
    <TooltipPrimitive.Content
      ref={ref}
      sideOffset={sideOffset}
      className={cn(
        "z-50 overflow-hidden rounded-lg bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-lg shadow-black/20 border border-border animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props}
    />
  </TooltipPrimitive.Portal>
))
TooltipContent.displayName = TooltipPrimitive.Content.displayName

export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }
</file>

<file path="src/pages/detalleLlamada.tsx">
import React, { useEffect, useState } from 'react';
import { useParams, Link } from 'react-router-dom';
import { llamadasService, Llamada } from '../services/llamadasService';
import { 
  Brain, Lock, CheckCircle, XCircle, Play, Pause, ChevronLeft, 
  User, DollarSign, Calendar, CreditCard, TrendingUp, AlertTriangle, Activity 
} from 'lucide-react'; 

export default function DetalleLlamada() {
  const { id } = useParams<{ id: string }>();
  const [llamada, setLlamada] = useState<Llamada | null>(null);
  const [loading, setLoading] = useState(true);
  const [isPlaying, setIsPlaying] = useState(false);

  useEffect(() => {
    if (!id) return;
    llamadasService.getById(id)
      .then(setLlamada)
      .catch(console.error)
      .finally(() => setLoading(false));
  }, [id]);

  if (loading) return <div className="p-20 text-center text-gray-500">Cargando la magia de Saturn... ü™ê</div>;
  if (!llamada) return <div className="p-20 text-center">No pillamos la llamada, hermano üòî</div>;

  let datos = {} as any;
  
  try {
    if (typeof llamada.analisis_json === 'string') {
      const cleanString = (llamada.analisis_json as any).replace(/```json\n?/g, '').replace(/```/g, '').trim();
      datos = JSON.parse(cleanString);
    } else {
      datos = llamada.analisis_json || {};
    }
  } catch (error) {
    console.error("Saturn mand√≥ un JSON inv√°lido:", error);
    datos = {}; 
  }

  const hitos = datos.hitos || {};
  const coaching = datos.coaching || {};
  const compromiso = datos.compromiso_pago;
  return (
    <div className="max-w-7xl mx-auto p-6 space-y-8 bg-gray-50 min-h-screen">
      
      {/* 1. HEADER Y DATOS DEL CLIENTE */}
      <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
        <div className="flex items-center space-x-4">
          <Link to="/llamadas" className="p-2 bg-gray-50 rounded-full hover:bg-gray-100 border">
            <ChevronLeft size={20} />
          </Link>
          <div>
            <h1 className="text-2xl font-bold text-gray-800">Auditor√≠a de Llamada</h1>
            <p className="text-gray-500 text-sm flex items-center gap-2 mt-1">
              <User size={14} /> 
              {llamada.nombre_cliente || 'Cliente Desconocido'} | RUT: {llamada.rut_cliente || 'Sin RUT'}
            </p>
          </div>
        </div>
        
        <div className="flex items-center gap-6">
          <div className="text-right">
            <p className="text-xs text-gray-400 font-bold uppercase tracking-wider">Score General</p>
            <p className={`text-3xl font-black ${datos.score_final >= 80 ? 'text-green-500' : 'text-yellow-500'}`}>
              {datos.score_final || 0}%
            </p>
          </div>
          <span className={`px-4 py-2 rounded-full font-bold text-sm border ${
            llamada.estado === 'finalizado' 
              ? 'bg-green-100 text-green-700 border-green-200' 
              : 'bg-yellow-100 text-yellow-700 border-yellow-200'
          }`}>
            {llamada.estado.toUpperCase()}
          </span>
        </div>
      </div>

      {/* ALERTA CR√çTICA (Solo aparece si el agente detect√≥ algo grave) */}
      {datos.error_critico && (
        <div className="bg-red-50 border-l-4 border-red-500 p-4 rounded shadow-sm">
          <div className="flex items-center">
            <AlertTriangle className="text-red-500 mr-3" size={24} />
            <div>
              <h3 className="text-red-800 font-bold">ERROR CR√çTICO DETECTADO</h3>
              <p className="text-red-700">{datos.detalle_error}</p>
            </div>
          </div>
        </div>
      )}

      {/* RESUMEN EJECUTIVO */}
      <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
        <h3 className="text-lg font-bold mb-2 text-gray-800 flex items-center gap-2">
          <Activity size={20} className="text-blue-500" />
          Resumen de Gesti√≥n
        </h3>
        <p className="text-gray-600 leading-relaxed text-sm">
          {datos.resumen_ejecutivo || "Esperando resumen..."}
        </p>
      </div>

      {/* COMPROMISO DE PAGO (Tarjeta Premium) */}
      {compromiso && compromiso.monto > 0 && (
        <div className="bg-gradient-to-r from-emerald-500 to-teal-500 p-6 rounded-2xl shadow-lg text-white flex justify-between items-center transform hover:scale-[1.01] transition-all">
          <div>
            <h4 className="font-bold mb-1 flex items-center gap-2">
              <CheckCircle size={20} /> COMPROMISO DE PAGO ACORDADO
            </h4>
            <p className="text-emerald-100 text-sm">El cliente regularizar√° su deuda pronto.</p>
          </div>
          <div className="text-right flex items-center gap-6">
            <div className="border-r border-emerald-400 pr-6">
              <p className="text-sm font-medium text-emerald-100 uppercase tracking-wide flex items-center justify-end gap-1"><DollarSign size={14}/> Monto</p>
              <p className="text-3xl font-bold">{new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(compromiso.monto)}</p>
            </div>
            <div className="border-r border-emerald-400 pr-6">
              <p className="text-sm font-medium text-emerald-100 uppercase tracking-wide flex items-center justify-end gap-1"><Calendar size={14}/> Fecha</p>
              <p className="text-xl font-bold">{compromiso.fecha}</p>
            </div>
            <div>
              <p className="text-sm font-medium text-emerald-100 uppercase tracking-wide flex items-center justify-end gap-1"><CreditCard size={14}/> Canal</p>
              <p className="text-xl font-bold">{compromiso.metodo}</p>
            </div>
          </div>
        </div>
      )}

      {/* LOS HITOS DEL EXCEL (M√©tricas) */}
      <h3 className="text-xl font-bold text-gray-800 mt-8 mb-4">Evaluaci√≥n de Protocolo</h3>
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        {Object.entries(hitos).map(([nombreHito, data]: any) => (
          <div key={nombreHito} className={`bg-white p-5 rounded-xl shadow-sm border-l-4 ${data.cumple ? 'border-green-500' : 'border-red-500'}`}>
            <div className="flex justify-between items-start mb-2">
              <h4 className="font-bold text-gray-700 capitalize text-sm">{nombreHito}</h4>
              {data.cumple 
                ? <span className="text-green-600 bg-green-50 px-2 py-1 rounded text-xs font-bold flex gap-1"><CheckCircle size={14}/> CUMPLE</span>
                : <span className="text-red-600 bg-red-50 px-2 py-1 rounded text-xs font-bold flex gap-1"><XCircle size={14}/> NO CUMPLE</span>
              }
            </div>
            <p className="text-xs text-gray-500 mt-2">{data.nota || data.note || "Sin observaciones"}</p>
          </div>
        ))}
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 mt-8">
        
        {/* COLUMNA IZQUIERDA: TRANSCRIPCI√ìN (Chat Style) */}
        <div className="lg:col-span-2 space-y-6">
          <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-[600px] flex flex-col">
            <h3 className="text-lg font-bold mb-4 text-gray-800 flex justify-between items-center border-b pb-4">
              Transcripci√≥n Completa
              <button onClick={() => setIsPlaying(!isPlaying)} className="p-2 bg-blue-50 text-blue-600 rounded-full hover:bg-blue-100 transition">
                {isPlaying ? <Pause size={18} /> : <Play size={18} fill="currentColor" />}
              </button>
            </h3>
            <div className="overflow-y-auto flex-1 pr-2 space-y-4 font-mono text-sm">
              {datos.transcripcion ? (
                // Simulamos un chat separando la transcripci√≥n cruda por cambios de hablante
                datos.transcripcion.split(/(?=Ejecutiva:|Cliente:)/g).map((linea: string, i: number) => {
                  const isAgent = linea.startsWith("Ejecutiva:");
                  return (
                    <div key={i} className={`p-4 rounded-xl max-w-[85%] ${isAgent ? 'bg-blue-50 ml-auto border border-blue-100' : 'bg-gray-50 mr-auto border border-gray-200'}`}>
                      <p className={`text-xs font-bold mb-1 uppercase ${isAgent ? 'text-blue-600' : 'text-gray-500'}`}>
                        {isAgent ? 'Ejecutivo' : 'Cliente'}
                      </p>
                      <p className="text-gray-700 leading-relaxed">{linea.replace(/Ejecutiva:|Cliente:/g, '').trim()}</p>
                    </div>
                  );
                })
              ) : (
                <div className="text-center text-gray-400 italic mt-20">Esperando texto del agente... ‚úçÔ∏è</div>
              )}
            </div>
          </div>
        </div>

        {/* COLUMNA DERECHA: COACHING IA (La Venta) */}
        <div className="space-y-6">
          
          <div className="bg-gradient-to-br from-indigo-600 to-purple-700 text-white p-6 rounded-2xl shadow-lg relative overflow-hidden">
            <div className="absolute top-0 right-0 p-4 opacity-20"><Brain size={100} /></div>
            <h2 className="text-xl font-bold flex items-center gap-2 mb-4 relative z-10"><Brain size={24} /> AI Coach Feedback</h2>
            
            <div className="space-y-4 relative z-10">
              <div className="flex gap-4 mb-6">
                <div className="bg-white/10 p-3 rounded-lg flex-1 text-center">
                  <p className="text-xs text-indigo-200 uppercase font-bold">Empat√≠a</p>
                  <p className="text-2xl font-black">{coaching.score_empatia || 0}%</p>
                </div>
                <div className="bg-white/10 p-3 rounded-lg flex-1 text-center">
                  <p className="text-xs text-indigo-200 uppercase font-bold">Cierre</p>
                  <p className="text-2xl font-black">{coaching.score_cierre || 0}%</p>
                </div>
              </div>

              {coaching.tips && coaching.tips.length > 0 ? (
                coaching.tips.map((tip: string, i: number) => (
                  <div key={i} className={`flex items-start gap-3 p-3 rounded-xl text-sm ${i === 0 ? 'bg-white/20 font-bold backdrop-blur-sm shadow-sm' : 'text-indigo-100'}`}>
                    <CheckCircle size={18} className={`mt-0.5 shrink-0 ${i === 0 ? 'text-green-300' : 'text-indigo-300'}`} />
                    <span>{tip}</span>
                  </div>
                ))
              ) : (
                <p className="text-sm italic opacity-70 text-center">Sin sugerencias disponibles para esta llamada.</p>
              )}
            </div>
          </div>

          {/* TARJETA 3: PAYWALL */}
          <div className="bg-white border border-gray-200 rounded-2xl shadow-sm p-6 relative overflow-hidden group">
            <div className="filter blur-sm select-none opacity-50 transition duration-500 group-hover:blur-md">
              <h3 className="font-bold text-gray-800 mb-4 flex gap-2"><TrendingUp/>An√°lisis Emocional Profundo</h3>
              <div className="space-y-3"><div className="h-4 bg-gray-200 rounded w-3/4"></div><div className="h-32 bg-gray-100 rounded w-full mt-4"></div></div>
            </div>
            <div className="absolute inset-0 flex flex-col items-center justify-center bg-white/40 z-10 backdrop-blur-[2px]">
              <div className="bg-gray-900 text-white p-4 rounded-full mb-3 shadow-xl transform group-hover:scale-110 transition"><Lock size={24} /></div>
              <h4 className="font-bold text-gray-900 text-lg">Funci√≥n Premium</h4>
              <p className="text-sm text-gray-700 mb-4 text-center font-medium px-4">Desbloquea el an√°lisis de sentimientos micro-gestuales.</p>
              <button className="px-6 py-2 bg-black text-white font-bold rounded-lg shadow-md hover:bg-gray-800 transition">Mejorar Plan üöÄ</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/components/dashboard/ActividadReciente.tsx">
import { Clock, MoreHorizontal } from 'lucide-react'
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card'
import { Avatar, AvatarFallback } from '@/components/ui/avatar'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { formatRelativeTime, formatDuration } from '@/lib/utils'
import type { Llamada, AnalisisLlamada } from '@/types'

interface LlamadaConAnalisis extends Llamada {
  analisis?: AnalisisLlamada
}

interface ActividadRecienteProps {
  llamadas: LlamadaConAnalisis[]
}

export function ActividadReciente({ llamadas }: ActividadRecienteProps) {
  return (
    <Card>
      <CardHeader className="pb-3">
        <CardTitle>Actividad Reciente</CardTitle>
      </CardHeader>
      <CardContent>
        <div className="space-y-4">
          {llamadas.slice(0, 5).map((llamada) => {
            const score = llamada.analisis?.score_total

            return (
              <div
                key={llamada.llamada_id}
                className="flex items-center gap-3 group"
              >
                <Avatar className="h-9 w-9 border">
                  <AvatarFallback className="text-xs bg-secondary">
                    {llamada.agente_nombre?.split(' ').map(n => n[0]).join('') || 'AG'}
                  </AvatarFallback>
                </Avatar>

                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2">
                    <span className="text-sm font-medium truncate">
                      {llamada.agente_nombre || 'Agente'}
                    </span>
                    <span className="text-xs text-muted-foreground">
                      ‚Üí {llamada.cliente_id}
                    </span>
                  </div>
                  <div className="flex items-center gap-2 text-xs text-muted-foreground">
                    <Clock className="w-3 h-3" />
                    <span>{formatDuration(llamada.duracion_segundos)}</span>
                    <span>‚Ä¢</span>
                    <span>{formatRelativeTime(new Date(llamada.timestamp_inicio))}</span>
                  </div>
                </div>

                {llamada.estado === 'analizado' && score !== undefined ? (
                  <Badge 
                    variant={score >= 70 ? 'success' : score >= 40 ? 'warning' : 'destructive'}
                  >
                    {score}
                  </Badge>
                ) : (
                  <Badge variant="secondary">
                    {llamada.estado === 'transcrito' ? 'Procesando' : 'Pendiente'}
                  </Badge>
                )}

                <Button 
                  variant="ghost" 
                  size="icon-sm" 
                  className="opacity-0 group-hover:opacity-100 transition-opacity"
                >
                  <MoreHorizontal className="w-4 h-4" />
                </Button>
              </div>
            )
          })}
        </div>
      </CardContent>
    </Card>
  )
}
</file>

<file path="src/components/dashboard/AlertasActivas.tsx">
import { AlertTriangle, AlertCircle, Info, ChevronRight } from 'lucide-react'
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { cn } from '@/lib/utils'
import type { AlertaAnomalia, Severidad } from '@/types'

interface AlertasActivasProps {
  alertas: AlertaAnomalia[]
  maxItems?: number
}

const severidadConfig: Record<Severidad, { 
  icon: typeof AlertTriangle, 
  badge: 'destructive' | 'warning' | 'secondary' | 'default'
}> = {
  critica: { icon: AlertTriangle, badge: 'destructive' },
  alta: { icon: AlertCircle, badge: 'warning' },
  media: { icon: Info, badge: 'secondary' },
  baja: { icon: Info, badge: 'default' },
}

export function AlertasActivas({ alertas, maxItems = 5 }: AlertasActivasProps) {
  const visibleAlertas = alertas.slice(0, maxItems)
  const hasMore = alertas.length > maxItems

  return (
    <Card>
      <CardHeader className="pb-3">
        <div className="flex items-center justify-between">
          <CardTitle>Alertas Activas</CardTitle>
          <Badge variant="destructive">{alertas.length}</Badge>
        </div>
      </CardHeader>
      <CardContent>
        <div className="space-y-3">
          {visibleAlertas.map((alerta) => {
            const config = severidadConfig[alerta.severidad]
            const Icon = config.icon

            return (
              <div
                key={alerta.alerta_id}
                className={cn(
                  "flex items-start gap-3 p-3 rounded-lg border border-border",
                  "hover:bg-accent/50 transition-colors cursor-pointer"
                )}
              >
                <div className={cn(
                  "w-8 h-8 rounded-lg flex items-center justify-center shrink-0",
                  alerta.severidad === 'critica' && "bg-destructive/10 text-destructive",
                  alerta.severidad === 'alta' && "bg-warning/10 text-warning",
                  alerta.severidad === 'media' && "bg-secondary text-muted-foreground",
                  alerta.severidad === 'baja' && "bg-secondary text-muted-foreground"
                )}>
                  <Icon className="w-4 h-4" />
                </div>
                
                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2 mb-1">
                    <Badge variant={config.badge} className="text-[10px]">
                      {alerta.severidad}
                    </Badge>
                    <span className="text-xs text-muted-foreground">
                      {alerta.tipo}
                    </span>
                  </div>
                  <p className="text-sm line-clamp-2">{alerta.descripcion}</p>
                </div>

                <ChevronRight className="w-4 h-4 text-muted-foreground shrink-0" />
              </div>
            )
          })}
        </div>
        
        {hasMore && (
          <Button variant="ghost" className="w-full mt-3" size="sm">
            Ver todas ({alertas.length})
          </Button>
        )}
      </CardContent>
    </Card>
  )
}
</file>

<file path="src/components/dashboard/TopPerformers.tsx">
import { TrendingUp, TrendingDown, Minus, MoreHorizontal } from 'lucide-react'
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card'
import { Avatar, AvatarFallback } from '@/components/ui/avatar'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { cn } from '@/lib/utils'

interface Performer {
  agente_id: string
  nombre: string
  score: number
  llamadas: number
  validacion: number
  trend: 'up' | 'down' | 'stable'
}

interface TopPerformersProps {
  performers: Performer[]
}

export function TopPerformers({ performers }: TopPerformersProps) {
  return (
    <Card>
      <CardHeader className="pb-3">
        <div className="flex items-center justify-between">
          <CardTitle>Team Members</CardTitle>
          <Button variant="outline" size="sm">Invite</Button>
        </div>
        <p className="text-sm text-muted-foreground">Top performers this week</p>
      </CardHeader>
      <CardContent>
        <div className="space-y-4">
          {performers.slice(0, 5).map((performer) => {
            const TrendIcon = performer.trend === 'up' 
              ? TrendingUp 
              : performer.trend === 'down' 
                ? TrendingDown 
                : Minus

            return (
              <div
                key={performer.agente_id}
                className="flex items-center gap-3 group"
              >
                <Avatar className="h-9 w-9 border">
                  <AvatarFallback className="text-xs bg-primary/10 text-primary">
                    {performer.nombre.split(' ').map(n => n[0]).join('')}
                  </AvatarFallback>
                </Avatar>

                <div className="flex-1 min-w-0">
                  <p className="text-sm font-medium truncate">{performer.nombre}</p>
                  <p className="text-xs text-muted-foreground">
                    {performer.llamadas} llamadas ‚Ä¢ {performer.validacion}% validaci√≥n
                  </p>
                </div>

                <div className="flex items-center gap-2">
                  <TrendIcon className={cn(
                    "w-4 h-4",
                    performer.trend === 'up' && "text-success",
                    performer.trend === 'down' && "text-destructive",
                    performer.trend === 'stable' && "text-muted-foreground"
                  )} />
                  <Badge 
                    variant={performer.score >= 70 ? 'success' : performer.score >= 40 ? 'warning' : 'destructive'}
                    className="min-w-[3rem] justify-center"
                  >
                    {performer.score}
                  </Badge>
                </div>

                <Button 
                  variant="ghost" 
                  size="icon-sm" 
                  className="opacity-0 group-hover:opacity-100 transition-opacity"
                >
                  <MoreHorizontal className="w-4 h-4" />
                </Button>
              </div>
            )
          })}
        </div>
      </CardContent>
    </Card>
  )
}
</file>

<file path="src/components/layout/Header.tsx">
import { Bell, Search, Download, Calendar } from 'lucide-react'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Badge } from '@/components/ui/badge'

interface HeaderProps {
  title: string
  subtitle?: string
}

export function Header({ title: _title }: HeaderProps) {
  return (
    <header className="sticky top-0 z-30 h-14 bg-background border-b border-border">
      <div className="flex items-center justify-between h-full px-6">
        {/* Left: Search */}
        <div className="flex items-center flex-1 max-w-md">
          <div className="relative w-full">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground" />
            <Input 
              placeholder="Search..." 
              className="pl-9 h-9 bg-secondary/50 border-0"
            />
            <kbd className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none hidden sm:inline-flex h-5 select-none items-center gap-1 rounded border bg-muted px-1.5 font-mono text-[10px] text-muted-foreground">
              ‚åòK
            </kbd>
          </div>
        </div>

        {/* Right: Actions */}
        <div className="flex items-center gap-2">
          {/* Notifications */}
          <Button variant="ghost" size="icon" className="relative">
            <Bell className="w-4 h-4" />
            <span className="absolute top-1.5 right-1.5 w-2 h-2 bg-destructive rounded-full" />
          </Button>

          {/* Toggle theme would go here */}
          <div className="w-px h-6 bg-border mx-2" />

          {/* Download */}
          <Button variant="default" size="sm" className="gap-2">
            <Download className="w-4 h-4" />
            Download
          </Button>

          {/* Date picker */}
          <Button variant="outline" size="sm" className="gap-2">
            <Calendar className="w-4 h-4" />
            Pick a date
          </Button>
        </div>
      </div>
    </header>
  )
}

interface PageHeaderProps {
  title: string
  subtitle?: string
  badge?: {
    label: string
    variant?: 'default' | 'secondary' | 'destructive' | 'success' | 'warning'
  }
  actions?: React.ReactNode
}

export function PageHeader({ title, subtitle, badge, actions }: PageHeaderProps) {
  return (
    <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
      <div>
        <div className="flex items-center gap-3">
          <h1 className="text-2xl font-semibold tracking-tight">{title}</h1>
          {badge && (
            <Badge variant={badge.variant}>{badge.label}</Badge>
          )}
        </div>
        {subtitle && (
          <p className="text-muted-foreground text-sm mt-1">{subtitle}</p>
        )}
      </div>
      {actions && (
        <div className="flex items-center gap-2">
          {actions}
        </div>
      )}
    </div>
  )
}
</file>

<file path="src/components/layout/Sidebar.tsx">
import { NavLink, useLocation } from 'react-router-dom'
import { cn } from '@/lib/utils'
import { 
  LayoutDashboard, 
  Phone, 
  Users, 
  Target, 
  AlertTriangle, 
  TrendingUp,
  MessageSquare,
  Settings,
  ChevronDown,
  ChevronsUpDown,
  Layers,
  PhoneCall,
  UserCheck,
  PhoneOff
} from 'lucide-react'
import { Button } from '@/components/ui/button'
import { TooltipProvider } from '@/components/ui/tooltip'
import { Avatar, AvatarFallback } from '@/components/ui/avatar'

const navigation = [
  { 
    section: 'General',
    items: [
      { name: 'Dashboard', href: '/', icon: LayoutDashboard },
      { name: 'Llamadas', href: '/llamadas', icon: Phone },
      { name: 'Agentes', href: '/agentes', icon: Users },
    ]
  },
  {
    section: 'Modulos de Analisis',
    items: [
      { name: 'Vision General', href: '/modulos', icon: Layers },
      { name: 'Contacto Directo', href: '/modulos/contacto', icon: PhoneCall },
      { name: 'Compromiso Pago', href: '/modulos/compromiso', icon: UserCheck },
      { name: 'Abandono', href: '/modulos/abandono', icon: PhoneOff },
    ]
  },
  {
    section: 'Analisis',
    items: [
      { name: 'Coaching', href: '/coaching', icon: Target },
      { name: 'Alertas', href: '/alertas', icon: AlertTriangle, badge: 3 },
      { name: 'Estrategia', href: '/estrategia', icon: TrendingUp },
    ]
  },
  {
    section: 'Otros',
    items: [
      { name: 'Chat IA', href: '/chat', icon: MessageSquare },
      { name: 'Configuracion', href: '/settings', icon: Settings },
    ]
  }
]

export function Sidebar() {
  const location = useLocation()

  return (
    <TooltipProvider delayDuration={0}>
      <aside className="fixed left-0 top-0 z-40 h-screen w-64 bg-card border-r border-border flex flex-col">
        {/* Logo/Brand */}
        <div className="flex items-center gap-3 h-14 px-4 border-b border-border">
          <div className="w-8 h-8 rounded-lg bg-primary flex items-center justify-center">
            <div className="w-3 h-3 rounded-full bg-white" />
          </div>
          <div className="flex-1">
            <h1 className="font-semibold text-sm">NODUS</h1>
            <p className="text-[10px] text-muted-foreground">Speech Analytics</p>
          </div>
          <Button variant="ghost" size="icon-sm" className="text-muted-foreground">
            <ChevronsUpDown className="w-4 h-4" />
          </Button>
        </div>

        {/* Navigation */}
        <nav className="flex-1 overflow-y-auto py-4 px-3">
          {navigation.map((group) => (
            <div key={group.section} className="mb-6">
              <p className="px-3 mb-2 text-xs font-medium text-muted-foreground uppercase tracking-wider">
                {group.section}
              </p>
              <div className="space-y-1">
                {group.items.map((item) => {
                  const isActive = location.pathname === item.href || 
                    (item.href !== '/' && location.pathname.startsWith(item.href))
                  
                  return (
                    <NavLink
                      key={item.name}
                      to={item.href}
                      className={cn(
                        "flex items-center gap-3 px-3 py-2 rounded-lg text-sm transition-colors",
                        isActive 
                          ? "bg-primary/10 text-primary font-medium" 
                          : "text-muted-foreground hover:text-foreground hover:bg-accent"
                      )}
                    >
                      <item.icon className="w-4 h-4" />
                      <span className="flex-1">{item.name}</span>
                      {item.badge && (
                        <span className="flex items-center justify-center w-5 h-5 rounded-full bg-destructive text-destructive-foreground text-[10px] font-medium">
                          {item.badge}
                        </span>
                      )}
                    </NavLink>
                  )
                })}
              </div>
            </div>
          ))}
        </nav>

        {/* User section */}
        <div className="p-3 border-t border-border">
          <div className="flex items-center gap-3 p-2 rounded-lg hover:bg-accent cursor-pointer transition-colors">
            <Avatar className="h-8 w-8">
              <AvatarFallback className="text-xs bg-primary/10 text-primary">FU</AvatarFallback>
            </Avatar>
            <div className="flex-1 min-w-0">
              <p className="text-sm font-medium truncate">Fernando U.</p>
              <p className="text-xs text-muted-foreground truncate">admin@360.com</p>
            </div>
            <ChevronDown className="w-4 h-4 text-muted-foreground" />
          </div>
        </div>
      </aside>
    </TooltipProvider>
  )
}
</file>

<file path="src/components/llamadas/AudioPlayer.tsx">
import { useState, useRef, useEffect } from 'react'
import { Play, Pause, SkipBack, SkipForward, Volume2, VolumeX } from 'lucide-react'
import { Card, CardContent } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { cn, formatDuration } from '@/lib/utils'
import { motion } from 'framer-motion'

interface AudioPlayerProps {
  audioUrl: string
  duration: number
  onTimeUpdate?: (currentTime: number) => void
  className?: string
}

export function AudioPlayer({ audioUrl, duration, onTimeUpdate, className }: AudioPlayerProps) {
  const [isPlaying, setIsPlaying] = useState(false)
  const [currentTime, setCurrentTime] = useState(0)
  const [isMuted, setIsMuted] = useState(false)
  const audioRef = useRef<HTMLAudioElement>(null)
  const progressRef = useRef<HTMLDivElement>(null)

  useEffect(() => {
    const audio = audioRef.current
    if (!audio) return

    const handleTimeUpdate = () => {
      setCurrentTime(audio.currentTime)
      onTimeUpdate?.(audio.currentTime)
    }

    const handleEnded = () => {
      setIsPlaying(false)
      setCurrentTime(0)
    }

    audio.addEventListener('timeupdate', handleTimeUpdate)
    audio.addEventListener('ended', handleEnded)

    return () => {
      audio.removeEventListener('timeupdate', handleTimeUpdate)
      audio.removeEventListener('ended', handleEnded)
    }
  }, [onTimeUpdate])

  const togglePlay = () => {
    const audio = audioRef.current
    if (!audio) return

    if (isPlaying) {
      audio.pause()
    } else {
      audio.play()
    }
    setIsPlaying(!isPlaying)
  }

  const toggleMute = () => {
    const audio = audioRef.current
    if (!audio) return
    audio.muted = !isMuted
    setIsMuted(!isMuted)
  }

  const skip = (seconds: number) => {
    const audio = audioRef.current
    if (!audio) return
    audio.currentTime = Math.max(0, Math.min(audio.currentTime + seconds, duration))
  }

  const handleProgressClick = (e: React.MouseEvent<HTMLDivElement>) => {
    const audio = audioRef.current
    const progress = progressRef.current
    if (!audio || !progress) return

    const rect = progress.getBoundingClientRect()
    const x = e.clientX - rect.left
    const percentage = x / rect.width
    audio.currentTime = percentage * duration
  }

  const progress = (currentTime / duration) * 100

  return (
    <Card className={className}>
      <CardContent className="p-4">
        <audio ref={audioRef} src={audioUrl} preload="metadata" />
        
        {/* Waveform visualization (simplified) */}
        <div 
          ref={progressRef}
          className="relative h-16 mb-4 bg-muted/30 rounded-lg cursor-pointer overflow-hidden group"
          onClick={handleProgressClick}
        >
          {/* Fake waveform bars */}
          <div className="absolute inset-0 flex items-center justify-around px-2">
            {Array.from({ length: 50 }).map((_, i) => {
              const height = 20 + Math.random() * 60
              const isPast = (i / 50) * 100 <= progress
              return (
                <motion.div
                  key={i}
                  className={cn(
                    "w-1 rounded-full transition-colors",
                    isPast ? "bg-primary" : "bg-muted-foreground/30"
                  )}
                  initial={{ height: 0 }}
                  animate={{ height: `${height}%` }}
                  transition={{ delay: i * 0.01, duration: 0.3 }}
                />
              )
            })}
          </div>
          
          {/* Progress overlay */}
          <div 
            className="absolute inset-y-0 left-0 bg-primary/10 pointer-events-none"
            style={{ width: `${progress}%` }}
          />

          {/* Playhead */}
          <div 
            className="absolute top-0 bottom-0 w-0.5 bg-primary shadow-lg shadow-primary/50 transition-all"
            style={{ left: `${progress}%` }}
          />
        </div>

        {/* Controls */}
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            <Button
              variant="ghost"
              size="icon-sm"
              onClick={() => skip(-10)}
            >
              <SkipBack className="w-4 h-4" />
            </Button>
            
            <Button
              variant="default"
              size="icon"
              onClick={togglePlay}
              className="w-12 h-12"
            >
              {isPlaying ? (
                <Pause className="w-5 h-5" />
              ) : (
                <Play className="w-5 h-5 ml-0.5" />
              )}
            </Button>
            
            <Button
              variant="ghost"
              size="icon-sm"
              onClick={() => skip(10)}
            >
              <SkipForward className="w-4 h-4" />
            </Button>
          </div>

          {/* Time */}
          <div className="font-mono text-sm">
            <span className="text-primary">{formatDuration(Math.floor(currentTime))}</span>
            <span className="text-muted-foreground"> / {formatDuration(duration)}</span>
          </div>

          {/* Volume */}
          <Button
            variant="ghost"
            size="icon-sm"
            onClick={toggleMute}
          >
            {isMuted ? (
              <VolumeX className="w-4 h-4" />
            ) : (
              <Volume2 className="w-4 h-4" />
            )}
          </Button>
        </div>
      </CardContent>
    </Card>
  )
}
</file>

<file path="src/components/llamadas/gestorLlamadas.tsx">
"use client";
import { useState, useEffect } from 'react';
import { supabase } from '../../lib/supabase';
import { useNavigate } from 'react-router-dom';
import { llamadasService, type Llamada } from '../../services/llamadasService';
import { Upload, FileAudio, CheckCircle, Clock, X, RefreshCw, AlertTriangle, Play, FileText, Activity, Trash2 } from 'lucide-react';

// --- 2. SUB-COMPONENTES ---

const UploadZone = ({ onUpload, isUploading }: { onUpload: (file: File, rut: string, nombre: string) => void, isUploading: boolean }) => {
  const [rut, setRut] = useState('');
  const [nombre, setNombre] = useState('');

  const handleFileChange = (e: any) => {
    const archivo = e.target.files[0];
    if (!archivo) return;
    
    if (!rut.trim() || !nombre.trim()) {
      alert("‚ö†Ô∏è Por favor ingresa el RUT y Nombre del cliente antes de subir la auditor√≠a.");
      e.target.value = ''; // Resetea el input
      return;
    }
    
    onUpload(archivo, rut, nombre);
    // Limpiamos despu√©s de subir
    setRut('');
    setNombre('');
  };

  return (
    <div className="bg-white p-8 rounded-2xl shadow-sm border border-gray-200 mb-8 text-center transition-all">
      <h2 className="text-2xl font-bold text-gray-800 mb-2">Nodus Audio Intelligence</h2>
      <p className="text-gray-500 mb-6">Sube una llamada de audio para an√°lisis</p>
      
      {/* Inputs del Cliente */}
      <div className="flex flex-col md:flex-row gap-4 justify-center max-w-2xl mx-auto mb-6">
        <input 
          type="text" 
          placeholder="RUT Cliente (ej: 12345678-9)" 
          value={rut}
          onChange={(e) => setRut(e.target.value)}
          className="border border-gray-300 rounded-lg px-4 py-2 flex-1 focus:ring-2 focus:ring-blue-500"
          disabled={isUploading}
        />
        <input 
          type="text" 
          placeholder="Nombre del Cliente" 
          value={nombre}
          onChange={(e) => setNombre(e.target.value)}
          className="border border-gray-300 rounded-lg px-4 py-2 flex-1 focus:ring-2 focus:ring-blue-500"
          disabled={isUploading}
        />
      </div>

      {/* Bot√≥n de Subida */}
      <div className="relative inline-block">
          <input 
            type="file" 
            accept="audio/*" 
            onChange={handleFileChange} 
            className="hidden" 
            id="subir-audio" 
            disabled={isUploading}
          />
          <label 
            htmlFor="subir-audio" 
            className={`flex items-center gap-3 px-8 py-4 rounded-full font-medium cursor-pointer transition-all 
              ${isUploading || !rut || !nombre
                ? 'bg-gray-200 text-gray-500 cursor-not-allowed' 
                : 'bg-black text-white hover:bg-gray-800 shadow-lg hover:shadow-xl transform active:scale-95'}`}
          >
            {isUploading ? <RefreshCw className="animate-spin" /> : <Upload size={20} />}
            {isUploading ? "Procesando en Saturn..." : "Iniciar Auditor√≠a"}
          </label>
      </div>
    </div>
  );
};

const StatusBadge = ({ estado }: { estado: string }) => {
  const styles = {
    finalizado: 'bg-green-100 text-green-700 border-green-200',
    pendiente: 'bg-gray-100 text-gray-600 border-gray-200',
    error: 'bg-red-100 text-red-600 border-red-200',
    default: 'bg-blue-50 text-blue-600 border-blue-200 animate-pulse'
  };
  // @ts-ignore
  const currentStyle = styles[estado] || styles.default;
  
  return (
    <span className={`px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider flex items-center gap-2 border ${currentStyle}`}>
      {estado === 'finalizado' ? <CheckCircle size={14}/> : <Clock size={14}/>}
      {estado}
    </span>
  );
};

const LlamadaCard = ({ llamada, onClick, onDelete }: { 
  llamada: Llamada, 
  onClick: () => void, 
  onDelete: (id: string) => void 
}) => (
  <div 
    onClick={onClick}
    className="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex items-center justify-between hover:border-blue-400 cursor-pointer transition-all group relative"
  >
    <div className="flex items-center gap-4">
      <div className={`p-3 rounded-full transition-colors ${llamada.estado === 'finalizado' ? 'bg-green-50 text-green-600' : 'bg-gray-100 text-gray-500'}`}>
        <FileAudio size={24} />
      </div>
      <div>
        <h3 className="font-semibold text-gray-800 group-hover:text-blue-600 transition-colors">
          {llamada.nombre_archivo || 'Audio sin nombre'}
        </h3>
        <p className="text-xs text-gray-400 font-mono">
          {new Date(llamada.created_at).toLocaleString()}
        </p>
      </div>
    </div>

    <div className="flex items-center gap-6">
      <StatusBadge estado={llamada.estado} />
      
      <button 
        onClick={(e) => {
          e.stopPropagation();
          // USAMOS registro_id AQUI TAMBIEN
          if(confirm('¬øEliminar registro?')) onDelete(llamada.registro_id);
        }}
        className="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-full transition-all"
        title="Eliminar registro"
      >
        <Trash2 size={18} />
      </button>

      <div className="text-right min-w-[60px]">
        {llamada.puntaje_calidad && (
          <span className="text-xl font-bold text-gray-900">{llamada.puntaje_calidad}</span>
        )}
      </div>
    </div>
  </div>
);

const DetalleModal = ({ llamada, onClose }: { llamada: Llamada, onClose: () => void }) => {
  if (!llamada) return null;
  const isProcessing = llamada.estado !== 'finalizado' && llamada.estado !== 'error';

  return (
    <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 animate-in fade-in duration-200" onClick={onClose}>
      <div className="bg-white w-full max-w-3xl rounded-2xl shadow-2xl overflow-hidden max-h-[90vh] flex flex-col" onClick={e => e.stopPropagation()}>
        <div className="p-6 border-b border-gray-100 flex justify-between items-start bg-gray-50">
          <div>
            <h3 className="text-xl font-bold text-gray-900 line-clamp-1">{llamada.nombre_archivo}</h3>
            <div className="mt-2 flex gap-2">
               <StatusBadge estado={llamada.estado} />
               {/* USAMOS registro_id AQUI */}
               <span className="text-xs text-gray-400 flex items-center">ID: {llamada.registro_id.slice(0,8)}...</span>
            </div>
          </div>
          <button onClick={onClose} className="p-2 hover:bg-gray-200 text-gray-500 rounded-full transition">
            <X size={20} />
          </button>
        </div>

        <div className="p-0 overflow-y-auto flex-1">
          {isProcessing ? (
            <div className="flex flex-col items-center justify-center py-20 px-6 text-center space-y-6">
              <RefreshCw className="w-20 h-20 text-blue-600 animate-spin" />
              <h4 className="text-2xl font-bold text-gray-800">Analizando Llamada...</h4>
            </div>
          ) : (
            <div className="p-8 space-y-8">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                 {/* ... resto de tu UI ... */}
                 <div className="p-4 bg-gray-50 rounded border">
                    <p className="text-sm font-bold">Resumen</p>
                    <p>{llamada.resumen_ejecutivo || "Sin resumen"}</p>
                 </div>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

// --- 3. COMPONENTE PRINCIPAL ---

export default function GestorLlamadas() {
  const [llamadas, setLlamadas] = useState<Llamada[]>([]);
  const [subiendo, setSubiendo] = useState(false);
  
  // 1. INICIALIZAMOS EL HOOK DE NAVEGACI√ìN
  const navigate = useNavigate(); 

  useEffect(() => {
    cargarDatos();
    
    // Configuraci√≥n de Realtime (Mantener igual)
    const channel = supabase
      .channel('gestor-llamadas-realtime')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'registro_llamadas' }, () => {
        cargarDatos();
      })
      .subscribe();

    return () => { supabase.removeChannel(channel); };
  }, []);

  const cargarDatos = async () => {
    try {
      const data = await llamadasService.getAll();
      // @ts-ignore
      if (data) setLlamadas(data);
    } catch (error) {
      console.error("Error cargando llamadas:", error);
    }
  };

  const handleUpload = async (archivo: File, rut: string, nombre: string) => {
    setSubiendo(true);
    try {
      // Le pasamos los nuevos datos al servicio
      await llamadasService.uploadAndCreate(archivo, rut, nombre); 
      await cargarDatos();
    } catch (error) {
      alert("Error al subir: " + error);
    } finally {
      setSubiendo(false);
    }
  };

  const handleDelete = async (id: string) => {
    if (!confirm('¬øEst√°s seguro de eliminar este registro?')) return;
    try {
      await llamadasService.deleteLlamada(id); // Aseg√∫rate de tener este m√©todo en el service, o usa supabase directo
      cargarDatos();
    } catch (error) {
      alert("Error al borrar");
    }
  };

  return (
    <div className="max-w-5xl mx-auto p-6 animate-in fade-in duration-500">
      
      {/* ZONA DE CARGA */}
      <UploadZone onUpload={handleUpload} isUploading={subiendo} />

      <div className="space-y-4">
        <div className="flex justify-between items-end mb-4 px-2">
          <h3 className="text-xl font-bold text-gray-800">Historial de Auditor√≠as</h3>
          <span className="text-sm text-gray-400">{llamadas.length} registros</span>
        </div>
        
        {/* LISTA DE LLAMADAS */}
        <div className="grid gap-3">
          {llamadas.map((llamada) => (
            <LlamadaCard 
              key={llamada.registro_id} 
              llamada={llamada} 
              
              // 2. CAMBIO CLAVE: AHORA NAVEGAMOS A LA P√ÅGINA DE DETALLE
              onClick={() => navigate(`/llamadas/${llamada.registro_id}`)}
              
              onDelete={handleDelete}
            />
          ))}
        </div>
      </div>

      {/* 3. ELIMINAMOS EL MODAL (Ya no se usa) */}
    </div>
  );
}
</file>

<file path="src/components/llamadas/ModuloScore.tsx">
import { Check, X, AlertCircle } from 'lucide-react'
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card'
import { Progress } from '@/components/ui/progress'
import { Badge } from '@/components/ui/badge'
import { cn } from '@/lib/utils'
import { motion } from 'framer-motion'
import type { ModuloAbandono } from '@/types'

interface ModuloScoreProps {
  titulo: string
  icon: React.ReactNode
  score: number
  maxScore?: number
  items: Array<{
    label: string
    presente: boolean
    puntos: number
    maxPuntos: number
    evidencia?: string
    alerta?: boolean
  }>
  delay?: number
}

export function ModuloScore({ 
  titulo, 
  icon, 
  score, 
  maxScore = 100, 
  items,
  delay = 0
}: ModuloScoreProps) {
  const percentage = (score / maxScore) * 100

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ delay }}
    >
      <Card>
        <CardHeader className="pb-3">
          <div className="flex items-center justify-between">
            <CardTitle className="flex items-center gap-2 text-base">
              {icon}
              {titulo}
            </CardTitle>
            <div className={cn(
              "text-2xl font-mono font-bold",
              percentage >= 70 ? "text-success" : 
              percentage >= 40 ? "text-warning" : "text-destructive"
            )}>
              {score}<span className="text-sm text-muted-foreground">/{maxScore}</span>
            </div>
          </div>
          <Progress 
            value={percentage} 
            variant={percentage >= 70 ? 'success' : percentage >= 40 ? 'warning' : 'destructive'}
            className="h-2 mt-2"
          />
        </CardHeader>
        <CardContent className="pt-0">
          <div className="space-y-3">
            {items.map((item, i) => (
              <motion.div
                key={i}
                initial={{ opacity: 0, x: -10 }}
                animate={{ opacity: 1, x: 0 }}
                transition={{ delay: delay + 0.1 + i * 0.05 }}
                className={cn(
                  "flex items-start gap-3 p-2.5 rounded-lg",
                  item.alerta ? "bg-destructive/10 border border-destructive/20" : "bg-muted/30"
                )}
              >
                {/* Check/X icon */}
                <div className={cn(
                  "w-6 h-6 rounded-full flex items-center justify-center shrink-0 mt-0.5",
                  item.presente ? "bg-success/20" : "bg-destructive/20"
                )}>
                  {item.presente ? (
                    <Check className="w-4 h-4 text-success" />
                  ) : (
                    <X className="w-4 h-4 text-destructive" />
                  )}
                </div>

                {/* Content */}
                <div className="flex-1 min-w-0">
                  <div className="flex items-center justify-between gap-2">
                    <span className={cn(
                      "text-sm font-medium",
                      !item.presente && "text-muted-foreground"
                    )}>
                      {item.label}
                    </span>
                    <Badge 
                      variant={item.presente ? "success" : "outline"}
                      className="font-mono text-xs"
                    >
                      {item.puntos}/{item.maxPuntos}
                    </Badge>
                  </div>
                  {item.evidencia && (
                    <p className="text-xs text-muted-foreground mt-1 italic line-clamp-2">
                      "{item.evidencia}"
                    </p>
                  )}
                  {item.alerta && (
                    <div className="flex items-center gap-1.5 mt-1.5 text-destructive">
                      <AlertCircle className="w-3.5 h-3.5" />
                      <span className="text-xs font-medium">Impacto cr√≠tico en cumplimiento</span>
                    </div>
                  )}
                </div>
              </motion.div>
            ))}
          </div>
        </CardContent>
      </Card>
    </motion.div>
  )
}

// Componente para M√≥dulo Abandono
interface ModuloAbandonoProps {
  data: ModuloAbandono
  delay?: number
}

export function ModuloAbandonoCard({ data, delay = 0 }: ModuloAbandonoProps) {
  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ delay }}
    >
      <Card className={cn(
        data.hubo_abandono && "border-destructive/50"
      )}>
        <CardContent className="p-4">
          <div className="flex items-center gap-3">
            <div className={cn(
              "w-10 h-10 rounded-lg flex items-center justify-center",
              data.hubo_abandono ? "bg-destructive/20" : "bg-success/20"
            )}>
              {data.hubo_abandono ? (
                <X className="w-5 h-5 text-destructive" />
              ) : (
                <Check className="w-5 h-5 text-success" />
              )}
            </div>
            <div>
              <p className="font-medium">
                {data.hubo_abandono ? 'Hubo abandono' : 'Sin abandono'}
              </p>
              {data.hubo_abandono && data.razon && (
                <p className="text-sm text-muted-foreground">{data.razon}</p>
              )}
            </div>
            {data.hubo_abandono && data.momento && (
              <Badge variant="destructive" className="ml-auto">
                Min {Math.floor(data.momento / 60)}:{(data.momento % 60).toString().padStart(2, '0')}
              </Badge>
            )}
          </div>
        </CardContent>
      </Card>
    </motion.div>
  )
}
</file>

<file path="src/components/llamadas/PrediccionCard.tsx">
import { TrendingUp, TrendingDown, Target, AlertCircle, CheckCircle } from 'lucide-react'
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { motion } from 'framer-motion'
import { ScoreGauge } from '@/components/charts/ScoreGauge'
import type { PrediccionCumplimiento } from '@/types'

interface PrediccionCardProps {
  prediccion: PrediccionCumplimiento
  delay?: number
}

export function PrediccionCard({ prediccion, delay = 0 }: PrediccionCardProps) {
  const { probabilidad, nivel, factores_positivos, factores_negativos, razonamiento } = prediccion

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ delay }}
    >
      <Card>
        <CardHeader className="pb-2">
          <CardTitle className="flex items-center gap-2 text-base">
            <Target className="w-5 h-5 text-primary" />
            Predicci√≥n de Cumplimiento
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="flex items-center gap-6 mb-4">
            {/* Gauge */}
            <ScoreGauge 
              value={probabilidad} 
              size="lg"
              label="prob."
            />

            {/* Nivel y badge */}
            <div className="flex-1">
              <Badge 
                variant={nivel === 'alta' ? 'success' : nivel === 'media' ? 'warning' : 'destructive'}
                className="text-sm px-3 py-1"
              >
                {nivel.toUpperCase()}
              </Badge>
              <p className="text-sm text-muted-foreground mt-3 leading-relaxed">
                {razonamiento}
              </p>
            </div>
          </div>

          {/* Factores */}
          <div className="grid grid-cols-2 gap-4">
            {/* Positivos */}
            <div className="space-y-2">
              <p className="text-xs font-medium text-success flex items-center gap-1">
                <TrendingUp className="w-3.5 h-3.5" />
                Factores Positivos
              </p>
              {factores_positivos.map((factor, i) => (
                <motion.div
                  key={i}
                  initial={{ opacity: 0, x: -10 }}
                  animate={{ opacity: 1, x: 0 }}
                  transition={{ delay: delay + 0.3 + i * 0.1 }}
                  className="flex items-center gap-2 text-sm"
                >
                  <CheckCircle className="w-4 h-4 text-success shrink-0" />
                  <span className="text-muted-foreground">{factor}</span>
                </motion.div>
              ))}
            </div>

            {/* Negativos */}
            <div className="space-y-2">
              <p className="text-xs font-medium text-destructive flex items-center gap-1">
                <TrendingDown className="w-3.5 h-3.5" />
                Factores Negativos
              </p>
              {factores_negativos.map((factor, i) => (
                <motion.div
                  key={i}
                  initial={{ opacity: 0, x: -10 }}
                  animate={{ opacity: 1, x: 0 }}
                  transition={{ delay: delay + 0.3 + i * 0.1 }}
                  className="flex items-center gap-2 text-sm"
                >
                  <AlertCircle className="w-4 h-4 text-destructive shrink-0" />
                  <span className="text-muted-foreground">{factor}</span>
                </motion.div>
              ))}
            </div>
          </div>
        </CardContent>
      </Card>
    </motion.div>
  )
}
</file>

<file path="src/components/llamadas/TranscripcionViewer.tsx">
import { User, Headphones, Smile, Meh, Frown } from 'lucide-react'
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card'
import { ScrollArea } from '@/components/ui/scroll-area'
import { cn, formatDuration } from '@/lib/utils'
import { motion } from 'framer-motion'
import type { Segmento, Emocion } from '@/types'

interface TranscripcionViewerProps {
  segmentos: Segmento[]
  onTimestampClick?: (timestamp: number) => void
  currentTime?: number
}

const emocionIcons: Record<Emocion, { icon: typeof Smile, color: string }> = {
  positivo: { icon: Smile, color: 'text-success' },
  neutral: { icon: Meh, color: 'text-muted-foreground' },
  negativo: { icon: Frown, color: 'text-destructive' },
}

export function TranscripcionViewer({ 
  segmentos, 
  onTimestampClick,
  currentTime = 0 
}: TranscripcionViewerProps) {
  return (
    <Card>
      <CardHeader className="pb-3">
        <CardTitle className="text-base">Transcripci√≥n</CardTitle>
      </CardHeader>
      <CardContent className="pt-0">
        <ScrollArea className="h-[400px] pr-4">
          <div className="space-y-3">
            {segmentos.map((segmento, index) => {
              const isAgente = segmento.speaker === 'agente'
              const emocionConfig = emocionIcons[segmento.emocion]
              const EmocionIcon = emocionConfig.icon
              const isActive = currentTime >= segmento.timestamp_inicio && 
                              (segmento.timestamp_fin === undefined || currentTime < segmento.timestamp_fin)

              return (
                <motion.div
                  key={index}
                  initial={{ opacity: 0, y: 10 }}
                  animate={{ opacity: 1, y: 0 }}
                  transition={{ delay: index * 0.02 }}
                  className={cn(
                    "group flex gap-3 p-3 rounded-lg transition-all cursor-pointer",
                    "hover:bg-muted/50",
                    isActive && "bg-primary/10 border border-primary/30",
                    isAgente ? "pr-8" : "pl-8"
                  )}
                  onClick={() => onTimestampClick?.(segmento.timestamp_inicio)}
                >
                  {/* Avatar */}
                  <div className={cn(
                    "w-8 h-8 rounded-full flex items-center justify-center shrink-0",
                    isAgente ? "bg-primary/20" : "bg-secondary/20"
                  )}>
                    {isAgente ? (
                      <Headphones className="w-4 h-4 text-primary" />
                    ) : (
                      <User className="w-4 h-4 text-secondary" />
                    )}
                  </div>

                  {/* Content */}
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-2 mb-1">
                      <span className={cn(
                        "text-xs font-semibold uppercase tracking-wide",
                        isAgente ? "text-primary" : "text-secondary"
                      )}>
                        {segmento.speaker}
                      </span>
                      <button
                        className="text-[10px] font-mono text-muted-foreground hover:text-primary transition-colors"
                        onClick={(e) => {
                          e.stopPropagation()
                          onTimestampClick?.(segmento.timestamp_inicio)
                        }}
                      >
                        {formatDuration(Math.floor(segmento.timestamp_inicio))}
                      </button>
                      <EmocionIcon className={cn("w-3.5 h-3.5", emocionConfig.color)} />
                    </div>
                    <p className="text-sm text-foreground leading-relaxed">
                      {segmento.texto}
                    </p>
                  </div>
                </motion.div>
              )
            })}
          </div>
        </ScrollArea>
      </CardContent>
    </Card>
  )
}
</file>

<file path="src/components/modulos/ProbabilidadFlow.tsx">
import { cn } from '@/lib/utils'
import { ChevronRight } from 'lucide-react'

interface FlowStep {
  paso: string
  prob_teorica: number
  prob_real?: number | null
  n?: number
}

interface ProbabilidadFlowProps {
  pasos: FlowStep[]
}

export function ProbabilidadFlow({ pasos }: ProbabilidadFlowProps) {
  return (
    <div className="space-y-3">
      {pasos.map((paso) => {
        const widthPercent = Math.min(100, Math.max(20, paso.prob_teorica))
        
        return (
          <div key={paso.paso} className="flex items-center gap-3">
            {/* Arrow indicator */}
            <div 
              className={cn(
                "relative h-12 rounded-r-full flex items-center justify-between px-4 transition-all",
                "bg-primary text-white"
              )}
              style={{ width: `${widthPercent}%`, minWidth: '140px' }}
            >
              <span className="font-medium text-sm truncate">
                {paso.paso}
              </span>
              <span className="font-bold">
                {paso.prob_teorica}%
              </span>
              
              {/* Arrow point */}
              <div className="absolute right-0 top-1/2 transform translate-x-full -translate-y-1/2">
                <ChevronRight className="w-6 h-6 text-primary" />
              </div>
            </div>
            
            {/* Real probability if available */}
            {paso.prob_real !== null && paso.prob_real !== undefined && (
              <div className="text-xs text-muted-foreground whitespace-nowrap">
                Real: <span className="font-semibold text-foreground">{paso.prob_real}%</span>
                {paso.n !== undefined && (
                  <span className="ml-1">({paso.n} llamadas)</span>
                )}
              </div>
            )}
          </div>
        )
      })}
    </div>
  )
}
</file>

<file path="src/pages/modulos/AbandonoLlamadas.tsx">
import { Header } from '@/components/layout/Header'
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { ModuloHeader, DonutMetric } from '@/components/modulos'
import { useAbandonoKPIs, useAbandonosDetalle, useAgentesModulos } from '@/hooks/useModulos'
import { RefreshCw, Clock, MessageSquare, CheckCircle } from 'lucide-react'
import { cn } from '@/lib/utils'

// Mock data
const mockKPIs = [
  { kpi: 'primeros_30_seg', valor: 34, porcentaje_abandonos: 34, porcentaje_total: 6 },
  { kpi: 'al_mencionar_monto', valor: 28, porcentaje_abandonos: 28, porcentaje_total: 5 },
  { kpi: 'durante_objeciones', valor: 22, porcentaje_abandonos: 22, porcentaje_total: 4 }
]

const mockDetalles = [
  { momento_rango: '0-30 seg', razon: 'Cliente no interesado', iniciado_por: 'cliente', total: 45, porcentaje: 34 },
  { momento_rango: '31-60 seg', razon: 'Monto muy alto', iniciado_por: 'cliente', total: 35, porcentaje: 26 },
  { momento_rango: '1-2 min', razon: 'Sin opciones de pago', iniciado_por: 'cliente', total: 25, porcentaje: 19 },
  { momento_rango: '> 2 min', razon: 'Objeciones no resueltas', iniciado_por: 'cliente', total: 28, porcentaje: 21 }
]

const mockAgentes = [
  { agente_nombre: 'Carlos Ramirez', equipo: 'Norte', tasa_abandono: 12, llamadas_con_abandono: 8, total_llamadas: 67, ranking_score: 1 },
  { agente_nombre: 'Maria Gonzalez', equipo: 'Sur', tasa_abandono: 15, llamadas_con_abandono: 12, total_llamadas: 80, ranking_score: 2 },
  { agente_nombre: 'Luis Torres', equipo: 'Norte', tasa_abandono: 18, llamadas_con_abandono: 11, total_llamadas: 61, ranking_score: 3 },
  { agente_nombre: 'Ana Martinez', equipo: 'Centro', tasa_abandono: 24, llamadas_con_abandono: 15, total_llamadas: 63, ranking_score: 4 },
  { agente_nombre: 'Jose Perez', equipo: 'Sur', tasa_abandono: 32, llamadas_con_abandono: 19, total_llamadas: 59, ranking_score: 5 }
]

const patrones = [
  { 
    titulo: 'Recurrencia de Abandonos',
    descripcion: 'El sistema detecta patrones especificos: ciertos agentes experimentan mas cortes? Hay horarios con mayor abandono? Determinados tipos de deuda generan mas desconexiones?',
    icon: Clock
  },
  {
    titulo: 'Mapeo del Script',
    descripcion: 'La IA identifica en que parte especifica de la estructura del script ocurren mas abandonos, permitiendole redisenar secciones problematicas.',
    icon: MessageSquare
  }
]

export function AbandonoLlamadas() {
  const kpis = useAbandonoKPIs()
  const detalles = useAbandonosDetalle()
  const agentes = useAgentesModulos()

  const displayKPIs = (kpis.data && kpis.data.length > 0) ? kpis.data : mockKPIs
  const displayDetalles = (detalles.data && detalles.data.length > 0) ? detalles.data : mockDetalles
  const displayAgentes = (agentes.data && agentes.data.length > 0) ? agentes.data : mockAgentes

  const loading = kpis.loading || detalles.loading || agentes.loading

  const handleRefresh = () => {
    kpis.refetch()
    detalles.refetch()
    agentes.refetch()
  }

  // Procesar KPIs
  const kpiMap = displayKPIs.reduce((acc, k) => {
    acc[k.kpi] = k.porcentaje_abandonos || 0
    return acc
  }, {} as Record<string, number>)

  return (
    <>
      <Header title="Abandono de Llamadas" />
      
      <div className="p-6 space-y-6">
        {/* Module Header */}
        <ModuloHeader
          badge="Modulo 3"
          titulo="Analisis del Abandono de Llamadas: Prevenir la Desconexion"
          subtitulo="Cada llamada cortada representa una oportunidad perdida de recuperacion. Este modulo identifica exactamente donde y por que los deudores abandonan las llamadas."
          color="amber"
        />

        {/* Main KPIs - Donut Charts */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          <Card>
            <CardContent className="p-6 flex flex-col items-center">
              <DonutMetric 
                value={kpiMap.primeros_30_seg || 34}
                label="Abandonan en los primeros 30 segundos"
                size="lg"
                color="red"
              />
              <p className="mt-4 text-xs text-muted-foreground text-center">
                La primera impresion es critica
              </p>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6 flex flex-col items-center">
              <DonutMetric 
                value={kpiMap.al_mencionar_monto || 28}
                label="Cortan al mencionar el monto total"
                size="lg"
                color="amber"
              />
              <p className="mt-4 text-xs text-muted-foreground text-center">
                Requiere mejora en presentacion
              </p>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6 flex flex-col items-center">
              <DonutMetric 
                value={kpiMap.durante_objeciones || 22}
                label="Desconectan durante objeciones"
                size="lg"
                color="coral"
              />
              <p className="mt-4 text-xs text-muted-foreground text-center">
                Capacitacion en manejo de objeciones
              </p>
            </CardContent>
          </Card>
        </div>

        {/* Patterns and Details */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Patterns */}
          <Card>
            <CardHeader>
              <CardTitle className="text-base">Patrones Detectados</CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              {patrones.map((patron, i) => (
                <div key={i} className="flex gap-4 pb-4 border-b last:border-0 last:pb-0">
                  <div className="p-2 rounded-lg bg-amber-500/10 h-fit">
                    <patron.icon className="w-5 h-5 text-amber-600" />
                  </div>
                  <div>
                    <p className="font-medium text-sm mb-1">{patron.titulo}</p>
                    <p className="text-xs text-muted-foreground">{patron.descripcion}</p>
                  </div>
                </div>
              ))}

              {/* Result Box */}
              <div className="bg-emerald-500/10 border border-emerald-500/20 rounded-lg p-4 mt-4">
                <div className="flex items-start gap-2">
                  <CheckCircle className="w-4 h-4 text-emerald-600 mt-0.5" />
                  <p className="text-sm">
                    <strong className="text-emerald-700">Resultado:</strong> Scripts optimizados basados en 
                    datos reales que reducen hasta un 40% las llamadas cortadas prematuramente.
                  </p>
                </div>
              </div>
            </CardContent>
          </Card>

          {/* Detail by Moment */}
          <Card>
            <CardHeader>
              <div className="flex items-center justify-between">
                <div>
                  <CardTitle className="text-base">Detalle por Momento</CardTitle>
                  <CardDescription>Distribucion de abandonos</CardDescription>
                </div>
                <Button 
                  variant="ghost" 
                  size="sm" 
                  onClick={handleRefresh}
                  disabled={loading}
                >
                  <RefreshCw className={cn("h-4 w-4", loading && "animate-spin")} />
                </Button>
              </div>
            </CardHeader>
            <CardContent>
              <div className="space-y-3">
                {displayDetalles.slice(0, 5).map((detalle, index) => (
                  <div key={index} className="flex items-center gap-4">
                    <div className="w-20 text-xs text-muted-foreground">
                      {detalle.momento_rango}
                    </div>
                    <div className="flex-1">
                      <div className="h-6 bg-muted rounded overflow-hidden">
                        <div 
                          className="h-full bg-amber-500 flex items-center justify-end px-2"
                          style={{ width: `${detalle.porcentaje}%` }}
                        >
                          {(detalle.porcentaje || 0) > 20 && (
                            <span className="text-xs font-medium text-white">
                              {detalle.porcentaje}%
                            </span>
                          )}
                        </div>
                      </div>
                    </div>
                    {(detalle.porcentaje || 0) <= 20 && (
                      <span className="text-xs font-medium w-10">
                        {detalle.porcentaje}%
                      </span>
                    )}
                  </div>
                ))}
              </div>

              <div className="mt-4 pt-4 border-t">
                <p className="text-xs text-muted-foreground">
                  <strong>Razon principal:</strong> {displayDetalles[0]?.razon || 'Cliente no interesado'}
                </p>
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Agents Table */}
        <Card>
          <CardHeader>
            <CardTitle className="text-base">Tasa de Abandono por Agente</CardTitle>
            <CardDescription>Ordenado de menor a mayor abandono (mejor a peor)</CardDescription>
          </CardHeader>
          <CardContent>
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead>
                  <tr className="border-b">
                    <th className="text-left py-3 px-4 text-xs font-medium text-muted-foreground">#</th>
                    <th className="text-left py-3 px-4 text-xs font-medium text-muted-foreground">Agente</th>
                    <th className="text-left py-3 px-4 text-xs font-medium text-muted-foreground">Equipo</th>
                    <th className="text-center py-3 px-4 text-xs font-medium text-muted-foreground">Tasa Abandono</th>
                    <th className="text-center py-3 px-4 text-xs font-medium text-muted-foreground">Abandonos</th>
                    <th className="text-center py-3 px-4 text-xs font-medium text-muted-foreground">Total Llamadas</th>
                    <th className="text-center py-3 px-4 text-xs font-medium text-muted-foreground">Estado</th>
                  </tr>
                </thead>
                <tbody>
                  {displayAgentes
                    .sort((a, b) => (a.tasa_abandono || 0) - (b.tasa_abandono || 0))
                    .slice(0, 10)
                    .map((agente, index) => (
                    <tr key={agente.agente_nombre} className="border-b last:border-0 hover:bg-muted/50">
                      <td className="py-3 px-4">
                        <span className={cn(
                          "inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-medium",
                          index === 0 && "bg-emerald-100 text-emerald-700",
                          index === 1 && "bg-emerald-50 text-emerald-600",
                          index === 2 && "bg-slate-100 text-slate-700",
                          index > 2 && "bg-muted text-muted-foreground"
                        )}>
                          {index + 1}
                        </span>
                      </td>
                      <td className="py-3 px-4 font-medium">{agente.agente_nombre}</td>
                      <td className="py-3 px-4 text-sm text-muted-foreground">{agente.equipo}</td>
                      <td className="py-3 px-4 text-center">
                        <Badge 
                          variant="outline" 
                          className={cn(
                            "font-bold",
                            (agente.tasa_abandono || 0) <= 15 ? "border-emerald-500 text-emerald-600" : 
                            (agente.tasa_abandono || 0) <= 25 ? "border-amber-500 text-amber-600" : "border-red-500 text-red-500"
                          )}
                        >
                          {agente.tasa_abandono}%
                        </Badge>
                      </td>
                      <td className="py-3 px-4 text-center text-sm">{(agente as Record<string, unknown>).llamadas_con_abandono as number || '-'}</td>
                      <td className="py-3 px-4 text-center text-sm">{agente.total_llamadas}</td>
                      <td className="py-3 px-4 text-center">
                        {(agente.tasa_abandono || 0) <= 15 ? (
                          <Badge className="bg-emerald-100 text-emerald-700 hover:bg-emerald-100">Excelente</Badge>
                        ) : (agente.tasa_abandono || 0) <= 25 ? (
                          <Badge className="bg-amber-100 text-amber-700 hover:bg-amber-100">Normal</Badge>
                        ) : (
                          <Badge className="bg-red-100 text-red-700 hover:bg-red-100">Requiere atencion</Badge>
                        )}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </CardContent>
        </Card>
      </div>
    </>
  )
}
</file>

<file path="src/pages/modulos/CompromisoPago.tsx">
import { Header } from '@/components/layout/Header'
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { ModuloHeader, PilarCard, ProbabilidadFlow, ImpactoElementosChart } from '@/components/modulos'
import { useCompromisoElementos, useFlujoProbabilidad, useAgentesModulos } from '@/hooks/useModulos'
import { RefreshCw, CheckCircle } from 'lucide-react'
import { cn } from '@/lib/utils'

// Mock data
const mockPilares = [
  { titulo: 'Oferta Clara', descripcion: 'Especificar monto exacto a pagar y origen detallado de la deuda.', peso: '20%', score: 72 },
  { titulo: 'Alternativas de Pago', descripcion: 'Ofrecer multiples canales: sucursales, web, transferencia.', peso: '10%', score: 68 },
  { titulo: 'Fecha Especifica', descripcion: 'Establecer fecha concreta de pago para crear urgencia.', peso: '20%', score: 75 },
  { titulo: 'Validacion del Cliente', descripcion: 'El deudor debe confirmar explicitamente las condiciones.', peso: '50%', score: 52 }
]

const mockFlujo = [
  { paso: 'Inicio', orden: 0, prob_teorica: 0, prob_real: 5, n: 45 },
  { paso: 'Oferta clara', orden: 1, prob_teorica: 20, prob_real: 22, n: 120 },
  { paso: 'Alternativas', orden: 2, prob_teorica: 30, prob_real: 35, n: 150 },
  { paso: 'Fecha especifica', orden: 3, prob_teorica: 50, prob_real: 48, n: 100 },
  { paso: 'Validacion cliente', orden: 4, prob_teorica: 100, prob_real: 92, n: 85 }
]

const mockElementos = [
  { categoria: 'Sin elementos', orden: 0, total_llamadas: 45, prob_promedio: 8, porcentaje_del_total: 9 },
  { categoria: 'Solo oferta', orden: 1, total_llamadas: 120, prob_promedio: 22, porcentaje_del_total: 24 },
  { categoria: 'Oferta + alternativas', orden: 2, total_llamadas: 150, prob_promedio: 38, porcentaje_del_total: 30 },
  { categoria: 'Tres elementos', orden: 3, total_llamadas: 100, prob_promedio: 55, porcentaje_del_total: 20 },
  { categoria: 'Acuerdo completo', orden: 4, total_llamadas: 85, prob_promedio: 92, porcentaje_del_total: 17 }
]

const mockAgentes = [
  { agente_nombre: 'Carlos Ramirez', equipo: 'Norte', score_compromiso: 88, pct_oferta: 95, pct_validacion: 78, ranking_score: 1 },
  { agente_nombre: 'Maria Gonzalez', equipo: 'Sur', score_compromiso: 82, pct_oferta: 90, pct_validacion: 65, ranking_score: 2 },
  { agente_nombre: 'Luis Torres', equipo: 'Norte', score_compromiso: 75, pct_oferta: 85, pct_validacion: 55, ranking_score: 3 },
  { agente_nombre: 'Ana Martinez', equipo: 'Centro', score_compromiso: 68, pct_oferta: 78, pct_validacion: 42, ranking_score: 4 },
  { agente_nombre: 'Jose Perez', equipo: 'Sur', score_compromiso: 62, pct_oferta: 70, pct_validacion: 35, ranking_score: 5 }
]

export function CompromisoPago() {
  const elementos = useCompromisoElementos()
  const flujo = useFlujoProbabilidad()
  const agentes = useAgentesModulos()

  const displayElementos = (elementos.data && elementos.data.length > 0) ? elementos.data : mockElementos
  const displayFlujo = (flujo.data && flujo.data.length > 0) ? flujo.data : mockFlujo
  const displayAgentes = (agentes.data && agentes.data.length > 0) ? agentes.data : mockAgentes

  const loading = elementos.loading || flujo.loading || agentes.loading

  const handleRefresh = () => {
    elementos.refetch()
    flujo.refetch()
    agentes.refetch()
  }

  return (
    <>
      <Header title="Compromiso de Pago" />
      
      <div className="p-6 space-y-6">
        {/* Module Header */}
        <ModuloHeader
          badge="Modulo 2"
          titulo="Calidad del Compromiso: Convirtiendo Conversaciones en Resultados"
          subtitulo="Lograr que el deudor acepte un compromiso de pago es el objetivo final de cada llamada. Este modulo analiza la efectividad con la que sus agentes presentan ofertas, explican opciones y cierran acuerdos."
          color="coral"
        />

        {/* 4 Pilares */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          {mockPilares.map((pilar, index) => (
            <PilarCard
              key={pilar.titulo}
              titulo={pilar.titulo}
              descripcion={pilar.descripcion}
              score={pilar.score}
              peso={pilar.peso}
              color={index === 3 ? 'coral' : 'primary'}
            />
          ))}
        </div>

        {/* Key Insight */}
        <Card className="border-red-300 bg-red-50">
          <CardContent className="p-4">
            <div className="flex items-start gap-3">
              <CheckCircle className="w-5 h-5 text-red-500 mt-0.5" />
              <p className="text-sm">
                <strong>Dato clave:</strong> La validacion del cliente representa el 50% del exito total, 
                subrayando la importancia critica de obtener una confirmacion explicita durante la llamada.
              </p>
            </div>
          </CardContent>
        </Card>

        {/* Flow and Chart */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Probability Flow */}
          <Card>
            <CardHeader>
              <div className="flex items-center justify-between">
                <div>
                  <CardTitle className="text-base">Flujo de Probabilidad</CardTitle>
                  <CardDescription>Como se construye la probabilidad de cumplimiento</CardDescription>
                </div>
                <Button 
                  variant="ghost" 
                  size="sm" 
                  onClick={handleRefresh}
                  disabled={loading}
                >
                  <RefreshCw className={cn("h-4 w-4", loading && "animate-spin")} />
                </Button>
              </div>
            </CardHeader>
            <CardContent>
              <ProbabilidadFlow pasos={displayFlujo} />
              
              <div className="mt-4 pt-4 border-t">
                <p className="text-xs text-muted-foreground">
                  Este diagrama ilustra como la presencia o ausencia de cada elemento impacta 
                  directamente en la probabilidad final de que el cliente concrete el pago.
                </p>
              </div>
            </CardContent>
          </Card>

          {/* Impact Chart */}
          <ImpactoElementosChart 
            data={displayElementos}
            titulo="Impacto Medible en el Desempeno"
          />
        </div>

        {/* Insights */}
        <Card>
          <CardHeader>
            <CardTitle className="text-base">Transforme Datos en Accion</CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-sm text-muted-foreground mb-4">
              Nuestra herramienta de speech analytics identifica automaticamente la presencia 
              o ausencia de estos elementos en cada conversacion, permitiendo:
            </p>
            <ul className="space-y-2 text-sm">
              <li className="flex items-start gap-2">
                <CheckCircle className="w-4 h-4 text-emerald-500 mt-0.5" />
                <span>Retroalimentacion inmediata a ejecutivos sobre calidad de acuerdos</span>
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle className="w-4 h-4 text-emerald-500 mt-0.5" />
                <span>Identificacion de brechas de capacitacion especificas</span>
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle className="w-4 h-4 text-emerald-500 mt-0.5" />
                <span>Prediccion temprana de cumplimiento de compromisos</span>
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle className="w-4 h-4 text-emerald-500 mt-0.5" />
                <span>Optimizacion continua de scripts y protocolos</span>
              </li>
            </ul>
          </CardContent>
        </Card>

        {/* Agents Table */}
        <Card>
          <CardHeader>
            <CardTitle className="text-base">Ranking de Agentes - Compromiso de Pago</CardTitle>
            <CardDescription>Ordenado por score de compromiso</CardDescription>
          </CardHeader>
          <CardContent>
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead>
                  <tr className="border-b">
                    <th className="text-left py-3 px-4 text-xs font-medium text-muted-foreground">#</th>
                    <th className="text-left py-3 px-4 text-xs font-medium text-muted-foreground">Agente</th>
                    <th className="text-left py-3 px-4 text-xs font-medium text-muted-foreground">Equipo</th>
                    <th className="text-center py-3 px-4 text-xs font-medium text-muted-foreground">Score</th>
                    <th className="text-center py-3 px-4 text-xs font-medium text-muted-foreground">% Oferta Clara</th>
                    <th className="text-center py-3 px-4 text-xs font-medium text-muted-foreground">% Validacion</th>
                  </tr>
                </thead>
                <tbody>
                  {displayAgentes
                    .sort((a, b) => (b.score_compromiso || 0) - (a.score_compromiso || 0))
                    .slice(0, 10)
                    .map((agente, index) => (
                    <tr key={agente.agente_nombre} className="border-b last:border-0 hover:bg-muted/50">
                      <td className="py-3 px-4">
                        <span className={cn(
                          "inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-medium",
                          index === 0 && "bg-amber-100 text-amber-700",
                          index === 1 && "bg-slate-100 text-slate-700",
                          index === 2 && "bg-orange-100 text-orange-700",
                          index > 2 && "bg-muted text-muted-foreground"
                        )}>
                          {index + 1}
                        </span>
                      </td>
                      <td className="py-3 px-4 font-medium">{agente.agente_nombre}</td>
                      <td className="py-3 px-4 text-sm text-muted-foreground">{agente.equipo}</td>
                      <td className="py-3 px-4 text-center">
                        <Badge 
                          variant="outline" 
                          className={cn(
                            "font-bold",
                            (agente.score_compromiso || 0) >= 75 ? "border-emerald-500 text-emerald-600" : 
                            (agente.score_compromiso || 0) >= 60 ? "border-amber-500 text-amber-600" : "border-red-500 text-red-500"
                          )}
                        >
                          {agente.score_compromiso}
                        </Badge>
                      </td>
                      <td className="py-3 px-4 text-center text-sm">{(agente as Record<string, unknown>).pct_oferta as number || '-'}%</td>
                      <td className="py-3 px-4 text-center">
                        <span className={cn(
                          "font-semibold",
                          (agente.pct_validacion || 0) >= 60 ? "text-emerald-600" : 
                          (agente.pct_validacion || 0) >= 40 ? "text-amber-600" : "text-red-500"
                        )}>
                          {agente.pct_validacion || '-'}%
                        </span>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </CardContent>
        </Card>
      </div>
    </>
  )
}
</file>

<file path="src/pages/modulos/ContactoDirecto.tsx">
import { Header } from '@/components/layout/Header'
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { ModuloHeader, CumplimientoBar } from '@/components/modulos'
import { useContactoDetalle, useAgentesModulos } from '@/hooks/useModulos'
import { RefreshCw, Info, TrendingUp, TrendingDown, Minus } from 'lucide-react'
import { cn } from '@/lib/utils'

// Mock data
const mockContacto = [
  { variable: 'Monto adeudado', peso_maximo: 25, puntos_promedio: 18, pct_cumplimiento: 72 },
  { variable: 'Fecha de vencimiento', peso_maximo: 15, puntos_promedio: 11, pct_cumplimiento: 73 },
  { variable: 'Consecuencias del impago', peso_maximo: 20, puntos_promedio: 12, pct_cumplimiento: 60 },
  { variable: 'Alternativas de pago', peso_maximo: 15, puntos_promedio: 10, pct_cumplimiento: 67 },
  { variable: 'Manejo de objeciones', peso_maximo: 25, puntos_promedio: 17, pct_cumplimiento: 68 }
]

const mockAgentes = [
  { agente_nombre: 'Carlos Ramirez', equipo: 'Norte', score_contacto: 85, pct_monto: 92, pct_fecha: 88, pct_buen_manejo: 80, ranking_score: 1 },
  { agente_nombre: 'Maria Gonzalez', equipo: 'Sur', score_contacto: 78, pct_monto: 85, pct_fecha: 80, pct_buen_manejo: 72, ranking_score: 2 },
  { agente_nombre: 'Luis Torres', equipo: 'Norte', score_contacto: 72, pct_monto: 78, pct_fecha: 75, pct_buen_manejo: 65, ranking_score: 3 },
  { agente_nombre: 'Ana Martinez', equipo: 'Centro', score_contacto: 65, pct_monto: 70, pct_fecha: 68, pct_buen_manejo: 58, ranking_score: 4 },
  { agente_nombre: 'Jose Perez', equipo: 'Sur', score_contacto: 58, pct_monto: 62, pct_fecha: 55, pct_buen_manejo: 48, ranking_score: 5 }
]

const variablesInfo = [
  {
    nombre: 'Claridad en la entrega de informacion',
    descripcion: 'Evalua si el agente comunica de forma precisa el monto adeudado, fechas de vencimiento y consecuencias del impago'
  },
  {
    nombre: 'Presentacion de alternativas de pago',
    descripcion: 'Verifica que se ofrezcan todas las opciones disponibles y se expliquen claramente'
  },
  {
    nombre: 'Manejo de objeciones',
    descripcion: 'Analiza tecnicas de respuesta, empatia demostrada y efectividad en la resolucion de dudas'
  }
]

export function ContactoDirecto() {
  const contacto = useContactoDetalle()
  const agentes = useAgentesModulos()

  const displayContacto = (contacto.data && contacto.data.length > 0) ? contacto.data : mockContacto
  const displayAgentes = (agentes.data && agentes.data.length > 0) ? agentes.data : mockAgentes

  const loading = contacto.loading || agentes.loading

  const handleRefresh = () => {
    contacto.refetch()
    agentes.refetch()
  }

  // Calcular score total del modulo
  const scoreTotal = Math.round(
    displayContacto.reduce((acc, v) => acc + (v.puntos_promedio || 0), 0)
  )

  return (
    <>
      <Header title="Contacto Directo" />
      
      <div className="p-6 space-y-6">
        {/* Module Header */}
        <ModuloHeader
          badge="Modulo 1"
          titulo="Analisis del Contacto Directo: La Primera Impresion es Definitiva"
          subtitulo="El primer contacto con el deudor determina el exito de toda la gestion. Nuestro modulo de analisis utiliza IA para evaluar sistematicamente cada conversacion."
          color="primary"
        />

        {/* Intro Card */}
        <Card>
          <CardContent className="p-6">
            <div className="flex items-start gap-4">
              <Info className="w-5 h-5 text-primary mt-0.5" />
              <div>
                <p className="text-sm text-muted-foreground mb-4">
                  Los resultados se traducen en reportes detallados con recomendaciones especificas para cada agente, 
                  mejorando continuamente la calidad del contacto inicial.
                </p>
                <div className="bg-primary/5 border border-primary/20 rounded-lg p-4">
                  <p className="text-sm">
                    <strong className="text-primary">Beneficio clave:</strong> Identifique en segundos que agentes 
                    requieren capacitacion adicional y en que aspectos especificos, optimizando su inversion en formacion.
                  </p>
                </div>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Variables Section */}
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Variables Info */}
          <Card className="lg:col-span-1">
            <CardHeader>
              <CardTitle className="text-base">Variables Analizadas</CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              {variablesInfo.map((v, i) => (
                <div key={i} className="pb-4 border-b last:border-0 last:pb-0">
                  <p className="font-medium text-sm mb-1">{v.nombre}</p>
                  <p className="text-xs text-muted-foreground">{v.descripcion}</p>
                </div>
              ))}
            </CardContent>
          </Card>

          {/* Cumplimiento Bars */}
          <Card className="lg:col-span-2">
            <CardHeader>
              <div className="flex items-center justify-between">
                <div>
                  <CardTitle className="text-base">Cumplimiento por Variable</CardTitle>
                  <CardDescription>Ultimos 30 dias</CardDescription>
                </div>
                <Button 
                  variant="ghost" 
                  size="sm" 
                  onClick={handleRefresh}
                  disabled={loading}
                >
                  <RefreshCw className={cn("h-4 w-4", loading && "animate-spin")} />
                </Button>
              </div>
            </CardHeader>
            <CardContent className="space-y-5">
              {displayContacto.map((item, index) => (
                <CumplimientoBar
                  key={item.variable}
                  variable={item.variable}
                  porcentaje={item.pct_cumplimiento || 0}
                  puntos={item.puntos_promedio || 0}
                  pesoMaximo={item.peso_maximo}
                  color={index % 2 === 0 ? 'primary' : 'coral'}
                />
              ))}

              {/* Total Score */}
              <div className="pt-4 border-t">
                <div className="flex items-center justify-between">
                  <span className="font-semibold">Score Total del Modulo</span>
                  <span className="text-2xl font-bold text-primary">{scoreTotal}/100</span>
                </div>
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Agents Ranking */}
        <Card>
          <CardHeader>
            <CardTitle className="text-base">Ranking de Agentes - Contacto Directo</CardTitle>
            <CardDescription>Ordenado por score de contacto directo</CardDescription>
          </CardHeader>
          <CardContent>
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead>
                  <tr className="border-b">
                    <th className="text-left py-3 px-4 text-xs font-medium text-muted-foreground">#</th>
                    <th className="text-left py-3 px-4 text-xs font-medium text-muted-foreground">Agente</th>
                    <th className="text-left py-3 px-4 text-xs font-medium text-muted-foreground">Equipo</th>
                    <th className="text-center py-3 px-4 text-xs font-medium text-muted-foreground">Score</th>
                    <th className="text-center py-3 px-4 text-xs font-medium text-muted-foreground">% Monto</th>
                    <th className="text-center py-3 px-4 text-xs font-medium text-muted-foreground">% Fecha</th>
                    <th className="text-center py-3 px-4 text-xs font-medium text-muted-foreground">% Objeciones</th>
                    <th className="text-center py-3 px-4 text-xs font-medium text-muted-foreground">Tendencia</th>
                  </tr>
                </thead>
                <tbody>
                  {displayAgentes
                    .sort((a, b) => (b.score_contacto || 0) - (a.score_contacto || 0))
                    .slice(0, 10)
                    .map((agente, index) => (
                    <tr key={agente.agente_nombre} className="border-b last:border-0 hover:bg-muted/50">
                      <td className="py-3 px-4">
                        <span className={cn(
                          "inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-medium",
                          index === 0 && "bg-amber-100 text-amber-700",
                          index === 1 && "bg-slate-100 text-slate-700",
                          index === 2 && "bg-orange-100 text-orange-700",
                          index > 2 && "bg-muted text-muted-foreground"
                        )}>
                          {index + 1}
                        </span>
                      </td>
                      <td className="py-3 px-4 font-medium">{agente.agente_nombre}</td>
                      <td className="py-3 px-4 text-sm text-muted-foreground">{agente.equipo}</td>
                      <td className="py-3 px-4 text-center">
                        <Badge 
                          variant="outline" 
                          className={cn(
                            "font-bold",
                            (agente.score_contacto || 0) >= 75 ? "border-emerald-500 text-emerald-600" : 
                            (agente.score_contacto || 0) >= 60 ? "border-amber-500 text-amber-600" : "border-red-500 text-red-500"
                          )}
                        >
                          {agente.score_contacto}
                        </Badge>
                      </td>
                      <td className="py-3 px-4 text-center text-sm">{(agente as Record<string, unknown>).pct_monto as number || '-'}%</td>
                      <td className="py-3 px-4 text-center text-sm">{(agente as Record<string, unknown>).pct_fecha as number || '-'}%</td>
                      <td className="py-3 px-4 text-center text-sm">{(agente as Record<string, unknown>).pct_buen_manejo as number || '-'}%</td>
                      <td className="py-3 px-4 text-center">
                        {index < 2 ? (
                          <TrendingUp className="w-4 h-4 text-emerald-500 mx-auto" />
                        ) : index > 3 ? (
                          <TrendingDown className="w-4 h-4 text-red-500 mx-auto" />
                        ) : (
                          <Minus className="w-4 h-4 text-muted-foreground mx-auto" />
                        )}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </CardContent>
        </Card>
      </div>
    </>
  )
}
</file>

<file path="src/pages/modulos/ModulosOverview.tsx">
import { Header } from '@/components/layout/Header'
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { ImpactoElementosChart } from '@/components/modulos'
import { TrendChart } from '@/components/charts/TrendChart'
import { useModulosOverview } from '@/hooks/useModulos'
import { RefreshCw, ArrowRight, Phone, UserCheck, PhoneOff } from 'lucide-react'
import { Link } from 'react-router-dom'
import { cn } from '@/lib/utils'

// Mock data como fallback
const mockKPIs = {
  score_total: { valor: 72, cambio: 5 },
  score_contacto: { valor: 68, cambio: 3 },
  score_compromiso: { valor: 75, cambio: 7 },
  tasa_validacion: { valor: 52, cambio: -3 },
  tasa_abandono: { valor: 18, cambio: -2 },
  probabilidad: { valor: 54, cambio: 4 }
}

const mockEvolucion = [
  { semana: 'Sem 1', score_total: 65, score_contacto: 60, score_compromiso: 70, prob_cumplimiento: 48 },
  { semana: 'Sem 2', score_total: 68, score_contacto: 63, score_compromiso: 72, prob_cumplimiento: 50 },
  { semana: 'Sem 3', score_total: 70, score_contacto: 66, score_compromiso: 73, prob_cumplimiento: 52 },
  { semana: 'Sem 4', score_total: 72, score_contacto: 68, score_compromiso: 75, prob_cumplimiento: 54 }
]

const mockAgentes = [
  { agente_nombre: 'Carlos Ramirez', equipo: 'Norte', score_contacto: 85, score_compromiso: 88, tasa_abandono: 12, score_total: 86, ranking_score: 1 },
  { agente_nombre: 'Maria Gonzalez', equipo: 'Sur', score_contacto: 78, score_compromiso: 82, tasa_abandono: 15, score_total: 80, ranking_score: 2 },
  { agente_nombre: 'Luis Torres', equipo: 'Norte', score_contacto: 75, score_compromiso: 78, tasa_abandono: 18, score_total: 76, ranking_score: 3 },
  { agente_nombre: 'Ana Martinez', equipo: 'Centro', score_contacto: 70, score_compromiso: 72, tasa_abandono: 22, score_total: 71, ranking_score: 4 },
  { agente_nombre: 'Jose Perez', equipo: 'Sur', score_contacto: 62, score_compromiso: 65, tasa_abandono: 28, score_total: 63, ranking_score: 5 }
]

const mockElementos = [
  { categoria: 'Sin elementos', orden: 0, total_llamadas: 45, prob_promedio: 8, porcentaje_del_total: 9 },
  { categoria: 'Solo oferta', orden: 1, total_llamadas: 120, prob_promedio: 22, porcentaje_del_total: 24 },
  { categoria: 'Oferta + alternativas', orden: 2, total_llamadas: 150, prob_promedio: 38, porcentaje_del_total: 30 },
  { categoria: 'Tres elementos', orden: 3, total_llamadas: 100, prob_promedio: 55, porcentaje_del_total: 20 },
  { categoria: 'Acuerdo completo', orden: 4, total_llamadas: 85, prob_promedio: 92, porcentaje_del_total: 17 }
]

export function ModulosOverview() {
  const { kpis, evolucion, agentes, elementos, loading, refetch } = useModulosOverview()

  // Procesar KPIs
  const kpiMap = (kpis || []).reduce((acc, k) => {
    acc[k.kpi] = { valor: k.valor, cambio: k.cambio }
    return acc
  }, {} as Record<string, { valor: number | null; cambio: number | null }>)

  const displayKPIs = {
    score_total: kpiMap.score_total || mockKPIs.score_total,
    score_contacto: kpiMap.score_contacto || mockKPIs.score_contacto,
    score_compromiso: kpiMap.score_compromiso || mockKPIs.score_compromiso,
    tasa_validacion: kpiMap.tasa_validacion || mockKPIs.tasa_validacion,
    tasa_abandono: kpiMap.tasa_abandono || mockKPIs.tasa_abandono,
    probabilidad: kpiMap.probabilidad || mockKPIs.probabilidad
  }

  const displayEvolucion = (evolucion && evolucion.length > 0) ? evolucion : mockEvolucion
  const displayAgentes = (agentes && agentes.length > 0) ? agentes : mockAgentes
  const displayElementos = (elementos && elementos.length > 0) ? elementos : mockElementos

  // Chart data
  const chartData = displayEvolucion.map(e => ({
    name: typeof e.semana === 'string' ? e.semana.slice(0, 10) : e.semana,
    value: e.score_total || 0,
    value2: e.prob_cumplimiento || 0
  }))

  return (
    <>
      <Header title="Modulos de Analisis" />
      
      <div className="p-6 space-y-6">
        {/* Hero Header */}
        <div className="bg-gradient-to-r from-primary to-primary/80 rounded-xl p-6 text-white">
          <Badge variant="outline" className="bg-white/20 text-white border-white/30 mb-3">
            Vision General
          </Badge>
          <h1 className="text-2xl md:text-3xl font-bold mb-2">
            Tres Pilares para la Excelencia en Cobranza
          </h1>
          <p className="text-white/80 text-sm md:text-base max-w-3xl">
            Nuestra plataforma de Speech Analytics esta disenada especificamente para el sector financiero, 
            ofreciendo tres modulos complementarios que analizan cada aspecto critico de la gestion de cobranza.
          </p>
          
          <div className="flex items-center gap-4 mt-4">
            <Button 
              variant="secondary" 
              size="sm" 
              onClick={refetch}
              disabled={loading}
              className="gap-2"
            >
              <RefreshCw className={cn("h-4 w-4", loading && "animate-spin")} />
              Actualizar
            </Button>
          </div>
        </div>

        {/* 3 Pilares Cards */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <Link to="/modulos/contacto" className="block">
            <Card className="h-full hover:shadow-md transition-shadow cursor-pointer group">
              <CardContent className="p-6">
                <div className="flex items-start justify-between mb-4">
                  <div className="p-2 rounded-lg bg-primary/10">
                    <Phone className="w-5 h-5 text-primary" />
                  </div>
                  <ArrowRight className="w-4 h-4 text-muted-foreground group-hover:text-primary transition-colors" />
                </div>
                <h3 className="text-lg font-semibold text-primary mb-1">Contacto Directo</h3>
                <p className="text-sm text-muted-foreground mb-4">
                  Evalua la calidad de la comunicacion inicial, claridad informativa y efectividad en el manejo de objeciones.
                </p>
                <div className="flex items-end justify-between">
                  <div>
                    <p className="text-3xl font-bold">{displayKPIs.score_contacto.valor}</p>
                    <p className="text-xs text-muted-foreground">Score promedio</p>
                  </div>
                  <Badge variant={displayKPIs.score_contacto.cambio && displayKPIs.score_contacto.cambio > 0 ? "default" : "destructive"}>
                    {displayKPIs.score_contacto.cambio && displayKPIs.score_contacto.cambio > 0 ? '+' : ''}{displayKPIs.score_contacto.cambio}%
                  </Badge>
                </div>
              </CardContent>
            </Card>
          </Link>

          <Link to="/modulos/compromiso" className="block">
            <Card className="h-full hover:shadow-md transition-shadow cursor-pointer group">
              <CardContent className="p-6">
                <div className="flex items-start justify-between mb-4">
                  <div className="p-2 rounded-lg bg-coral/10">
                    <UserCheck className="w-5 h-5 text-coral" />
                  </div>
                  <ArrowRight className="w-4 h-4 text-muted-foreground group-hover:text-coral transition-colors" />
                </div>
                <h3 className="text-lg font-semibold text-coral mb-1">Compromiso de Pago</h3>
                <p className="text-sm text-muted-foreground mb-4">
                  Analiza la presentacion de ofertas, opciones de pago disponibles y la respuesta del deudor ante propuestas.
                </p>
                <div className="flex items-end justify-between">
                  <div>
                    <p className="text-3xl font-bold">{displayKPIs.score_compromiso.valor}</p>
                    <p className="text-xs text-muted-foreground">Score promedio</p>
                  </div>
                  <Badge variant={displayKPIs.score_compromiso.cambio && displayKPIs.score_compromiso.cambio > 0 ? "default" : "destructive"}>
                    {displayKPIs.score_compromiso.cambio && displayKPIs.score_compromiso.cambio > 0 ? '+' : ''}{displayKPIs.score_compromiso.cambio}%
                  </Badge>
                </div>
              </CardContent>
            </Card>
          </Link>

          <Link to="/modulos/abandono" className="block">
            <Card className="h-full hover:shadow-md transition-shadow cursor-pointer group">
              <CardContent className="p-6">
                <div className="flex items-start justify-between mb-4">
                  <div className="p-2 rounded-lg bg-amber-500/10">
                    <PhoneOff className="w-5 h-5 text-amber-600" />
                  </div>
                  <ArrowRight className="w-4 h-4 text-muted-foreground group-hover:text-amber-600 transition-colors" />
                </div>
                <h3 className="text-lg font-semibold text-amber-600 mb-1">Abandono de Llamadas</h3>
                <p className="text-sm text-muted-foreground mb-4">
                  Identifica patrones de desconexion, puntos criticos del script y recurrencia para reducir perdidas.
                </p>
                <div className="flex items-end justify-between">
                  <div>
                    <p className="text-3xl font-bold">{displayKPIs.tasa_abandono.valor}%</p>
                    <p className="text-xs text-muted-foreground">Tasa de abandono</p>
                  </div>
                  <Badge variant={displayKPIs.tasa_abandono.cambio && displayKPIs.tasa_abandono.cambio < 0 ? "default" : "destructive"}>
                    {displayKPIs.tasa_abandono.cambio && displayKPIs.tasa_abandono.cambio > 0 ? '+' : ''}{displayKPIs.tasa_abandono.cambio}%
                  </Badge>
                </div>
              </CardContent>
            </Card>
          </Link>
        </div>

        {/* Charts Row */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Evolution Chart */}
          <Card>
            <CardHeader>
              <CardTitle>Evolucion Semanal</CardTitle>
              <CardDescription>Score total y probabilidad de cumplimiento</CardDescription>
            </CardHeader>
            <CardContent>
              <TrendChart 
                data={chartData}
                dataKey="value"
                dataKey2="value2"
                color="primary"
                color2="coral"
                height={280}
                showGrid
                showAxis
              />
            </CardContent>
          </Card>

          {/* Impact by Elements */}
          <ImpactoElementosChart 
            data={displayElementos}
            titulo="Impacto de Elementos en la Probabilidad"
          />
        </div>

        {/* Agents Table */}
        <Card>
          <CardHeader>
            <div className="flex items-center justify-between">
              <div>
                <CardTitle>Ranking de Agentes por Modulo</CardTitle>
                <CardDescription>Ultimos 7 dias</CardDescription>
              </div>
              <Link to="/agentes">
                <Button variant="outline" size="sm">
                  Ver todos
                  <ArrowRight className="w-4 h-4 ml-2" />
                </Button>
              </Link>
            </div>
          </CardHeader>
          <CardContent>
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead>
                  <tr className="border-b">
                    <th className="text-left py-3 px-4 text-xs font-medium text-muted-foreground">#</th>
                    <th className="text-left py-3 px-4 text-xs font-medium text-muted-foreground">Agente</th>
                    <th className="text-left py-3 px-4 text-xs font-medium text-muted-foreground">Equipo</th>
                    <th className="text-center py-3 px-4 text-xs font-medium text-muted-foreground">Contacto</th>
                    <th className="text-center py-3 px-4 text-xs font-medium text-muted-foreground">Compromiso</th>
                    <th className="text-center py-3 px-4 text-xs font-medium text-muted-foreground">Abandono</th>
                    <th className="text-center py-3 px-4 text-xs font-medium text-muted-foreground">Score Total</th>
                  </tr>
                </thead>
                <tbody>
                  {displayAgentes.slice(0, 5).map((agente, index) => (
                    <tr key={agente.agente_nombre} className="border-b last:border-0 hover:bg-muted/50">
                      <td className="py-3 px-4">
                        <span className={cn(
                          "inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-medium",
                          index === 0 && "bg-amber-100 text-amber-700",
                          index === 1 && "bg-slate-100 text-slate-700",
                          index === 2 && "bg-orange-100 text-orange-700",
                          index > 2 && "bg-muted text-muted-foreground"
                        )}>
                          {agente.ranking_score || index + 1}
                        </span>
                      </td>
                      <td className="py-3 px-4 font-medium">{agente.agente_nombre}</td>
                      <td className="py-3 px-4 text-sm text-muted-foreground">{agente.equipo}</td>
                      <td className="py-3 px-4 text-center">
                        <span className={cn(
                          "font-semibold",
                          (agente.score_contacto || 0) >= 75 ? "text-emerald-600" : 
                          (agente.score_contacto || 0) >= 60 ? "text-amber-600" : "text-red-500"
                        )}>
                          {agente.score_contacto}
                        </span>
                      </td>
                      <td className="py-3 px-4 text-center">
                        <span className={cn(
                          "font-semibold",
                          (agente.score_compromiso || 0) >= 75 ? "text-emerald-600" : 
                          (agente.score_compromiso || 0) >= 60 ? "text-amber-600" : "text-red-500"
                        )}>
                          {agente.score_compromiso}
                        </span>
                      </td>
                      <td className="py-3 px-4 text-center">
                        <span className={cn(
                          "font-semibold",
                          (agente.tasa_abandono || 0) <= 15 ? "text-emerald-600" : 
                          (agente.tasa_abandono || 0) <= 25 ? "text-amber-600" : "text-red-500"
                        )}>
                          {agente.tasa_abandono}%
                        </span>
                      </td>
                      <td className="py-3 px-4 text-center">
                        <Badge variant="outline" className="font-bold">
                          {agente.score_total}
                        </Badge>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </CardContent>
        </Card>
      </div>
    </>
  )
}
</file>

<file path="src/pages/Agentes.tsx">
import { useState } from 'react'
import { Search, Plus, SlidersHorizontal, MoreHorizontal, ChevronLeft, ChevronRight, UserPlus, Mail, RefreshCw, Wifi, WifiOff } from 'lucide-react'
import { Header } from '@/components/layout/Header'
import { Input } from '@/components/ui/input'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'
import { Card, CardContent } from '@/components/ui/card'
import { Avatar, AvatarFallback } from '@/components/ui/avatar'
import { cn } from '@/lib/utils'
import { useAgentes, useResumenAgentes } from '@/hooks/useSupabase'
import { isSupabaseConfigured } from '@/lib/supabase'
import { MetricCard } from '@/components/dashboard'

// Mock data fallback
import { mockAgentes, mockTopPerformers } from '@/data/mockData'

export function Agentes() {
  const [searchQuery, setSearchQuery] = useState('')
  const { data: agentesDB, loading: loadingAgentes, refetch: refetchAgentes } = useAgentes()
  const { data: resumenDB, loading: loadingResumen, refetch: refetchResumen } = useResumenAgentes()

  const loading = loadingAgentes || loadingResumen

  const refetch = () => {
    refetchAgentes()
    refetchResumen()
  }

  // Combinar datos de agentes con resumen
  const agentesConMetricas = (agentesDB && agentesDB.length > 0)
    ? agentesDB.map(agente => {
        const resumen = resumenDB?.find(r => r.agente_id === agente.agente_id)
        return {
          agente_id: agente.agente_id,
          nombre: agente.nombre,
          email: agente.email || '',
          estado: agente.estado,
          equipo: agente.equipo || '',
          score: resumen?.score_semana ?? 0,
          llamadas: resumen?.llamadas_semana ?? 0,
          validacion: (resumen?.tasa_validacion_ultimo_reporte ?? 0) * 100,
          trend: 'stable' as const,
        }
      })
    : mockAgentes.map(agente => {
        const metricas = mockTopPerformers.find(p => p.agente_id === agente.agente_id)
        return {
          agente_id: agente.agente_id,
          nombre: agente.nombre,
          email: agente.email || '',
          estado: agente.estado,
          equipo: agente.equipo || '',
          score: metricas?.score ?? 0,
          llamadas: metricas?.llamadas ?? 0,
          validacion: metricas?.validacion ?? 0,
          trend: metricas?.trend ?? 'stable' as const,
        }
      })

  const filteredAgentes = agentesConMetricas.filter(agente =>
    agente.nombre.toLowerCase().includes(searchQuery.toLowerCase())
  )

  const totalAgentes = agentesConMetricas.length
  const agentesActivos = agentesConMetricas.filter(a => a.estado === 'activo').length
  const scorePromedio = agentesConMetricas.length > 0
    ? Math.round(agentesConMetricas.reduce((acc, a) => acc + a.score, 0) / agentesConMetricas.length)
    : 0

  const isConnected = isSupabaseConfigured()

  return (
    <>
      <Header title="Agentes" />
      
      <div className="p-6 space-y-6">
        {/* Breadcrumb */}
        <div className="flex items-center gap-2 text-sm text-muted-foreground">
          <span>Home</span>
          <span>-</span>
          <span className="text-foreground">Agentes</span>
        </div>

        <div className="flex items-center justify-between">
          <div className="flex items-center gap-4">
            <h1 className="text-2xl font-semibold">Equipo de Agentes</h1>
            {/* Status indicator */}
            <div className="flex items-center gap-2 text-xs">
              {isConnected ? (
                <>
                  <Wifi className="h-3.5 w-3.5 text-emerald-500" />
                  <span className="text-muted-foreground">Conectado</span>
                </>
              ) : (
                <>
                  <WifiOff className="h-3.5 w-3.5 text-muted-foreground" />
                  <span className="text-muted-foreground">Modo demo</span>
                </>
              )}
            </div>
          </div>
          <div className="flex gap-2">
            <Button 
              variant="outline" 
              size="sm"
              onClick={refetch}
              disabled={loading}
              className="gap-2"
            >
              <RefreshCw className={`w-4 h-4 ${loading ? 'animate-spin' : ''}`} />
              Actualizar
            </Button>
            <Button variant="outline" className="gap-2">
              <Mail className="w-4 h-4" />
              Invitar
            </Button>
            <Button className="gap-2">
              <UserPlus className="w-4 h-4" />
              Agregar Agente
            </Button>
          </div>
        </div>

        {/* Stats */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
          <MetricCard
            title="Total Agentes"
            value={totalAgentes.toString()}
            change="Equipo completo"
          />
          <MetricCard
            title="Agentes Activos"
            value={agentesActivos.toString()}
            change={`${Math.round((agentesActivos / totalAgentes) * 100)}% del equipo`}
          />
          <MetricCard
            title="Score Promedio"
            value={scorePromedio.toString()}
            change="Ultima semana"
          />
          <MetricCard
            title="Llamadas Totales"
            value={agentesConMetricas.reduce((acc, a) => acc + a.llamadas, 0).toString()}
            change="Ultima semana"
          />
        </div>

        {/* Filters */}
        <div className="flex items-center gap-4">
          <div className="relative flex-1 max-w-sm">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground" />
            <Input 
              placeholder="Buscar agente..." 
              className="pl-9"
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
            />
          </div>
          
          <Button variant="outline" size="sm" className="gap-2">
            <Plus className="w-4 h-4" />
            Estado
          </Button>
          <Button variant="outline" size="sm" className="gap-2">
            <Plus className="w-4 h-4" />
            Equipo
          </Button>

          <div className="ml-auto">
            <Button variant="outline" size="sm" className="gap-2">
              <SlidersHorizontal className="w-4 h-4" />
              Vista
            </Button>
          </div>
        </div>

        {/* Table */}
        <Card>
          <CardContent className="p-0">
            <table className="w-full">
              <thead>
                <tr className="border-b border-border">
                  <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground w-12">
                    <input type="checkbox" className="rounded border-border" />
                  </th>
                  <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground">
                    Nombre
                  </th>
                  <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground">
                    Email
                  </th>
                  <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground">
                    Llamadas
                  </th>
                  <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground">
                    Score
                  </th>
                  <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground">
                    Validacion
                  </th>
                  <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground">
                    Estado
                  </th>
                  <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground">
                    Equipo
                  </th>
                  <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground w-[50px]">
                  </th>
                </tr>
              </thead>
              <tbody>
                {loading && filteredAgentes.length === 0 ? (
                  <tr>
                    <td colSpan={9} className="p-8 text-center text-muted-foreground">
                      Cargando agentes...
                    </td>
                  </tr>
                ) : filteredAgentes.length === 0 ? (
                  <tr>
                    <td colSpan={9} className="p-8 text-center text-muted-foreground">
                      No se encontraron agentes
                    </td>
                  </tr>
                ) : (
                  filteredAgentes.map((agente) => (
                    <tr key={agente.agente_id} className="border-b border-border hover:bg-accent/50 transition-colors">
                      <td className="p-4">
                        <input type="checkbox" className="rounded border-border" />
                      </td>
                      <td className="p-4">
                        <div className="flex items-center gap-3">
                          <Avatar className="h-8 w-8">
                            <AvatarFallback className="text-xs bg-primary/10 text-primary">
                              {agente.nombre.split(' ').map(n => n[0]).join('')}
                            </AvatarFallback>
                          </Avatar>
                          <span className="font-medium">{agente.nombre}</span>
                        </div>
                      </td>
                      <td className="p-4 text-muted-foreground">
                        {agente.email || '-'}
                      </td>
                      <td className="p-4">
                        {agente.llamadas}
                      </td>
                      <td className="p-4">
                        <span className={cn(
                          "font-semibold",
                          agente.score >= 70 ? "text-success" :
                          agente.score >= 40 ? "text-warning" : "text-destructive"
                        )}>
                          {agente.score}
                        </span>
                      </td>
                      <td className="p-4">
                        <span className={cn(
                          "font-medium",
                          agente.validacion >= 60 ? "text-success" :
                          agente.validacion >= 40 ? "text-warning" : "text-destructive"
                        )}>
                          {agente.validacion.toFixed(0)}%
                        </span>
                      </td>
                      <td className="p-4">
                        <Badge 
                          variant={agente.estado === 'activo' ? 'success' : 'secondary'}
                        >
                          {agente.estado === 'activo' ? 'Activo' : 'Inactivo'}
                        </Badge>
                      </td>
                      <td className="p-4">
                        <span className="text-sm">{agente.equipo || '-'}</span>
                      </td>
                      <td className="p-4">
                        <Button variant="ghost" size="icon-sm">
                          <MoreHorizontal className="w-4 h-4" />
                        </Button>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>

            {/* Pagination */}
            <div className="flex items-center justify-between px-4 py-3 border-t border-border">
              <p className="text-sm text-muted-foreground">
                {filteredAgentes.length} agentes
              </p>
              <div className="flex items-center gap-6">
                <div className="flex items-center gap-2">
                  <span className="text-sm">Filas por pagina</span>
                  <select className="h-8 rounded-md border border-input bg-background px-2 text-sm">
                    <option>10</option>
                    <option>20</option>
                    <option>50</option>
                  </select>
                </div>
                <span className="text-sm">Pagina 1 de 1</span>
                <div className="flex gap-1">
                  <Button variant="outline" size="icon-sm" disabled>
                    <ChevronLeft className="w-4 h-4" />
                  </Button>
                  <Button variant="outline" size="icon-sm" disabled>
                    <ChevronRight className="w-4 h-4" />
                  </Button>
                </div>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>
    </>
  )
}
</file>

<file path="src/pages/Alertas.tsx">
import { useState, useCallback, useEffect } from 'react'
import { AlertTriangle, AlertCircle, Info, Plus, SlidersHorizontal, MoreHorizontal, ChevronLeft, ChevronRight, RefreshCw, Wifi, WifiOff, Bell } from 'lucide-react'
import { Header } from '@/components/layout/Header'
import { Card, CardContent } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'
import { Input } from '@/components/ui/input'
import { cn, formatRelativeTime } from '@/lib/utils'
import { useAlertas as useAlertasQuery } from '@/hooks/useSupabase'
import { useAlertasRealtime } from '@/hooks/useRealtime'
import { isSupabaseConfigured } from '@/lib/supabase'
import type { Severidad, EstadoAlerta } from '@/types'
import type { AlertaAnomalia } from '@/types/database'

// Mock data fallback
import { mockAlertas } from '@/data/mockData'

const severidadConfig: Record<Severidad, { 
  icon: typeof AlertTriangle, 
  badge: 'destructive' | 'warning' | 'secondary' | 'default'
}> = {
  critica: { icon: AlertTriangle, badge: 'destructive' },
  alta: { icon: AlertCircle, badge: 'warning' },
  media: { icon: Info, badge: 'secondary' },
  baja: { icon: Info, badge: 'default' },
}

export function Alertas() {
  const [searchQuery, setSearchQuery] = useState('')
  const [localAlertas, setLocalAlertas] = useState<AlertaAnomalia[]>([])
  const { data: alertasDB, loading, error, refetch } = useAlertasQuery(true)

  // Sync DB data to local state
  useEffect(() => {
    if (alertasDB && alertasDB.length > 0) {
      setLocalAlertas(alertasDB)
    }
  }, [alertasDB])

  // Realtime: escuchar nuevas alertas
  const handleNuevaAlerta = useCallback((alerta: AlertaAnomalia) => {
    setLocalAlertas(prev => [alerta, ...prev])
  }, [])

  useAlertasRealtime(handleNuevaAlerta)

  // Usar datos de Supabase o mock
  const alertas = localAlertas.length > 0 
    ? localAlertas.map(a => ({
        alerta_id: a.alerta_id,
        tipo: a.tipo as 'individual' | 'sistemica' | 'patron',
        severidad: a.severidad as Severidad,
        descripcion: a.descripcion,
        causa_probable: a.causa_probable || undefined,
        impacto_estimado: a.impacto_estimado as any,
        accion_recomendada: a.accion_recomendada as any,
        agentes_relacionados: a.agentes_relacionados || undefined,
        estado: a.estado as EstadoAlerta,
        notificacion_enviada: a.notificacion_enviada,
        created_at: a.created_at
      }))
    : mockAlertas

  const filteredAlertas = alertas.filter(alerta =>
    alerta.descripcion.toLowerCase().includes(searchQuery.toLowerCase())
  )

  // Conteo por severidad
  const countBySeveridad = (sev: Severidad) => 
    alertas.filter(a => a.severidad === sev).length

  const isConnected = isSupabaseConfigured()

  return (
    <>
      <Header title="Alertas" />
      
      <div className="p-6 space-y-6">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-4">
            <div>
              <h1 className="text-2xl font-semibold">Alertas</h1>
              <p className="text-muted-foreground text-sm">Monitoreo de anomalias del sistema</p>
            </div>
            {/* Status indicator */}
            <div className="flex items-center gap-2 text-xs">
              {isConnected ? (
                <>
                  <Wifi className="h-3.5 w-3.5 text-emerald-500" />
                  <span className="text-muted-foreground">En vivo</span>
                </>
              ) : (
                <>
                  <WifiOff className="h-3.5 w-3.5 text-muted-foreground" />
                  <span className="text-muted-foreground">Modo demo</span>
                </>
              )}
            </div>
          </div>
          <div className="flex gap-2">
            <Button 
              variant="outline" 
              size="sm"
              onClick={refetch}
              disabled={loading}
              className="gap-2"
            >
              <RefreshCw className={`w-4 h-4 ${loading ? 'animate-spin' : ''}`} />
              Actualizar
            </Button>
            <Button>
              <Bell className="w-4 h-4 mr-2" />
              Configurar Alertas
            </Button>
          </div>
        </div>

        {/* Stats */}
        <div className="grid grid-cols-4 gap-4">
          {(['critica', 'alta', 'media', 'baja'] as Severidad[]).map((sev) => {
            const config = severidadConfig[sev]
            const Icon = config.icon
            const count = countBySeveridad(sev)
            
            return (
              <Card key={sev}>
                <CardContent className="p-4">
                  <div className="flex items-center gap-3">
                    <div className={cn(
                      "w-10 h-10 rounded-lg flex items-center justify-center",
                      sev === 'critica' && "bg-destructive/10 text-destructive",
                      sev === 'alta' && "bg-warning/10 text-warning",
                      sev === 'media' && "bg-secondary text-muted-foreground",
                      sev === 'baja' && "bg-secondary text-muted-foreground"
                    )}>
                      <Icon className="w-5 h-5" />
                    </div>
                    <div>
                      <p className="text-2xl font-semibold">{count}</p>
                      <p className="text-xs text-muted-foreground capitalize">{sev}</p>
                    </div>
                  </div>
                </CardContent>
              </Card>
            )
          })}
        </div>

        {/* Filters */}
        <div className="flex items-center gap-4">
          <Input 
            placeholder="Buscar alertas..." 
            className="max-w-sm"
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
          />
          
          <Button variant="outline" size="sm" className="gap-2">
            <Plus className="w-4 h-4" />
            Severidad
          </Button>
          <Button variant="outline" size="sm" className="gap-2">
            <Plus className="w-4 h-4" />
            Estado
          </Button>

          <div className="ml-auto">
            <Button variant="outline" size="sm" className="gap-2">
              <SlidersHorizontal className="w-4 h-4" />
              Vista
            </Button>
          </div>
        </div>

        {/* Error message */}
        {error && (
          <div className="p-4 bg-destructive/10 text-destructive rounded-lg text-sm">
            Error al cargar alertas: {error.message}
          </div>
        )}

        {/* Table */}
        <Card>
          <CardContent className="p-0">
            <table className="w-full">
              <thead>
                <tr className="border-b border-border">
                  <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground w-12">
                    <input type="checkbox" className="rounded border-border" />
                  </th>
                  <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground">
                    Alerta
                  </th>
                  <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground">
                    Descripcion
                  </th>
                  <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground">
                    Severidad
                  </th>
                  <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground">
                    Estado
                  </th>
                  <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground">
                    Creada
                  </th>
                  <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground w-[50px]">
                  </th>
                </tr>
              </thead>
              <tbody>
                {loading && filteredAlertas.length === 0 ? (
                  <tr>
                    <td colSpan={7} className="p-8 text-center text-muted-foreground">
                      Cargando alertas...
                    </td>
                  </tr>
                ) : filteredAlertas.length === 0 ? (
                  <tr>
                    <td colSpan={7} className="p-8 text-center text-muted-foreground">
                      No hay alertas activas
                    </td>
                  </tr>
                ) : (
                  filteredAlertas.map((alerta) => {
                    const config = severidadConfig[alerta.severidad]
                    const Icon = config.icon

                    return (
                      <tr key={alerta.alerta_id} className="border-b border-border hover:bg-accent/50 transition-colors">
                        <td className="p-4">
                          <input type="checkbox" className="rounded border-border" />
                        </td>
                        <td className="p-4">
                          <div className="flex items-center gap-3">
                            <div className={cn(
                              "w-8 h-8 rounded-lg flex items-center justify-center",
                              alerta.severidad === 'critica' && "bg-destructive/10 text-destructive",
                              alerta.severidad === 'alta' && "bg-warning/10 text-warning",
                              alerta.severidad === 'media' && "bg-secondary text-muted-foreground",
                              alerta.severidad === 'baja' && "bg-secondary text-muted-foreground"
                            )}>
                              <Icon className="w-4 h-4" />
                            </div>
                            <span className="font-medium text-primary">
                              {alerta.alerta_id.toUpperCase().slice(0, 10)}
                            </span>
                          </div>
                        </td>
                        <td className="p-4 max-w-md">
                          <p className="text-sm truncate">{alerta.descripcion}</p>
                        </td>
                        <td className="p-4">
                          <Badge variant={config.badge}>
                            {alerta.severidad}
                          </Badge>
                        </td>
                        <td className="p-4">
                          <Badge variant={alerta.estado === 'nueva' ? 'default' : 'secondary'}>
                            {alerta.estado}
                          </Badge>
                        </td>
                        <td className="p-4 text-sm text-muted-foreground">
                          {formatRelativeTime(new Date(alerta.created_at))}
                        </td>
                        <td className="p-4">
                          <Button variant="ghost" size="icon-sm">
                            <MoreHorizontal className="w-4 h-4" />
                          </Button>
                        </td>
                      </tr>
                    )
                  })
                )}
              </tbody>
            </table>

            {/* Pagination */}
            <div className="flex items-center justify-between px-4 py-3 border-t border-border">
              <p className="text-sm text-muted-foreground">
                {filteredAlertas.length} alertas
              </p>
              <div className="flex items-center gap-6">
                <span className="text-sm">Pagina 1 de 1</span>
                <div className="flex gap-1">
                  <Button variant="outline" size="icon-sm" disabled>
                    <ChevronLeft className="w-4 h-4" />
                  </Button>
                  <Button variant="outline" size="icon-sm" disabled>
                    <ChevronRight className="w-4 h-4" />
                  </Button>
                </div>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>
    </>
  )
}
</file>

<file path="src/pages/Chat.tsx">
import { useRef, useEffect } from 'react'
import { Send, Sparkles, User, Bot, Loader2, Trash2, Wifi, WifiOff } from 'lucide-react'
import { Header } from '@/components/layout/Header'
import { Card } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Badge } from '@/components/ui/badge'
import { ScrollArea } from '@/components/ui/scroll-area'
import { cn } from '@/lib/utils'
import { useChatStore } from '@/stores/chatStore'
import { isChatConfigured, type ChatResponseData } from '@/services/chatService'

// ---------- Sub-components ----------

function TypingIndicator() {
  return (
    <div className="flex gap-3">
      <div className="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center">
        <Bot className="w-4 h-4 text-primary" />
      </div>
      <div className="bg-secondary rounded-xl px-4 py-3 flex items-center gap-1">
        <div className="w-2 h-2 bg-muted-foreground/60 rounded-full animate-bounce" style={{ animationDelay: '0ms' }} />
        <div className="w-2 h-2 bg-muted-foreground/60 rounded-full animate-bounce" style={{ animationDelay: '150ms' }} />
        <div className="w-2 h-2 bg-muted-foreground/60 rounded-full animate-bounce" style={{ animationDelay: '300ms' }} />
      </div>
    </div>
  )
}

function DataTable({ data }: { data: ChatResponseData }) {
  if (data.type !== 'table' || !data.columns || !data.rows) return null

  return (
    <div className="mt-3 rounded-lg border border-border overflow-hidden">
      {data.title && (
        <div className="px-3 py-2 bg-secondary/50 border-b border-border">
          <span className="text-xs font-medium">{data.title}</span>
        </div>
      )}
      <div className="overflow-x-auto">
        <table className="w-full text-xs">
          <thead>
            <tr className="border-b border-border bg-secondary/30">
              {data.columns.map((col, i) => (
                <th key={i} className="px-3 py-2 text-left font-medium text-muted-foreground">
                  {col}
                </th>
              ))}
            </tr>
          </thead>
          <tbody>
            {data.rows.map((row, i) => (
              <tr key={i} className="border-b border-border last:border-0">
                {row.map((cell, j) => (
                  <td key={j} className="px-3 py-2">
                    {cell}
                  </td>
                ))}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  )
}

function MetricsCards({ data }: { data: ChatResponseData }) {
  if (data.type !== 'metrics' || !data.items) return null

  return (
    <div className="grid grid-cols-2 gap-2 mt-3">
      {data.items.map((item, i) => (
        <div key={i} className="rounded-lg border border-border p-3 bg-background">
          <p className="text-xs text-muted-foreground">{item.label}</p>
          <div className="flex items-baseline gap-2 mt-1">
            <span className="text-lg font-semibold">{item.value}</span>
            {item.change && (
              <span className={cn(
                "text-xs",
                item.trend === 'up' && "text-success",
                item.trend === 'down' && "text-destructive",
                item.trend === 'stable' && "text-muted-foreground"
              )}>
                {item.change}
              </span>
            )}
          </div>
        </div>
      ))}
    </div>
  )
}

function MessageContent({ content }: { content: string }) {
  // Simple markdown-like parsing for **bold**
  const parts = content.split(/(\*\*.*?\*\*)/g)
  
  return (
    <div className="text-sm whitespace-pre-wrap">
      {parts.map((part, i) => {
        if (part.startsWith('**') && part.endsWith('**')) {
          return <strong key={i}>{part.slice(2, -2)}</strong>
        }
        return part
      })}
    </div>
  )
}

// ---------- Main Component ----------

export function Chat() {
  const { 
    messages, 
    isLoading, 
    sendMessage, 
    addSuggestionClick, 
    clearChat 
  } = useChatStore()
  
  const scrollRef = useRef<HTMLDivElement>(null)
  const inputRef = useRef<HTMLInputElement>(null)
  
  const isConnected = isChatConfigured()

  // Auto-scroll on new messages
  useEffect(() => {
    if (scrollRef.current) {
      scrollRef.current.scrollTop = scrollRef.current.scrollHeight
    }
  }, [messages, isLoading])

  // Focus input on load
  useEffect(() => {
    inputRef.current?.focus()
  }, [])

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault()
    const input = inputRef.current
    if (input && input.value.trim()) {
      sendMessage(input.value)
      input.value = ''
    }
  }

  const handleSuggestionClick = (suggestion: string) => {
    if (suggestion === 'Limpiar chat' || suggestion === 'Intentar de nuevo') {
      if (suggestion === 'Limpiar chat') {
        clearChat()
      } else {
        // Get last user message and retry
        const lastUserMsg = [...messages].reverse().find(m => m.role === 'user')
        if (lastUserMsg) {
          sendMessage(lastUserMsg.content)
        }
      }
      return
    }
    addSuggestionClick(suggestion)
  }

  return (
    <>
      <Header title="Chat" />
      
      <div className="p-6 h-[calc(100vh-3.5rem)]">
        <Card className="h-full flex flex-col">
          {/* Header */}
          <div className="p-4 border-b border-border flex items-center gap-3">
            <div className="w-9 h-9 rounded-full bg-primary/10 flex items-center justify-center">
              <Sparkles className="w-4 h-4 text-primary" />
            </div>
            <div>
              <h3 className="font-medium text-sm">Asistente NODUS</h3>
              <p className="text-xs text-muted-foreground">
                {isConnected ? 'Conectado a Saturn Studio' : 'Modo demo'}
              </p>
            </div>
            <div className="ml-auto flex items-center gap-2">
              {isConnected ? (
                <Badge variant="success" className="gap-1">
                  <Wifi className="w-3 h-3" />
                  Online
                </Badge>
              ) : (
                <Badge variant="secondary" className="gap-1">
                  <WifiOff className="w-3 h-3" />
                  Demo
                </Badge>
              )}
              <Button 
                variant="ghost" 
                size="icon-sm" 
                onClick={clearChat}
                title="Limpiar chat"
              >
                <Trash2 className="w-4 h-4" />
              </Button>
            </div>
          </div>

          {/* Messages */}
          <ScrollArea className="flex-1 p-4" ref={scrollRef}>
            <div className="space-y-4 max-w-3xl mx-auto">
              {messages.map((message) => (
                <div
                  key={message.id}
                  className={cn(
                    "flex gap-3",
                    message.role === 'user' && "flex-row-reverse"
                  )}
                >
                  {/* Avatar */}
                  <div className={cn(
                    "w-8 h-8 rounded-full flex items-center justify-center shrink-0",
                    message.role === 'user' ? "bg-secondary" : "bg-primary/10"
                  )}>
                    {message.role === 'user' ? (
                      <User className="w-4 h-4" />
                    ) : (
                      <Bot className="w-4 h-4 text-primary" />
                    )}
                  </div>

                  {/* Message bubble */}
                  <div className={cn(
                    "max-w-[80%] rounded-xl px-4 py-3",
                    message.role === 'user' 
                      ? "bg-primary text-primary-foreground" 
                      : message.isError 
                        ? "bg-destructive/10 border border-destructive/20"
                        : "bg-secondary"
                  )}>
                    <MessageContent content={message.content} />

                    {/* Data visualizations */}
                    {message.data && message.data.type === 'table' && (
                      <DataTable data={message.data} />
                    )}
                    {message.data && message.data.type === 'metrics' && (
                      <MetricsCards data={message.data} />
                    )}

                    {/* Suggestions */}
                    {message.suggestions && message.suggestions.length > 0 && (
                      <div className="flex flex-wrap gap-2 mt-3">
                        {message.suggestions.map((suggestion, i) => (
                          <Button
                            key={i}
                            variant="outline"
                            size="sm"
                            className="text-xs h-7 bg-background"
                            onClick={() => handleSuggestionClick(suggestion)}
                            disabled={isLoading}
                          >
                            {suggestion}
                          </Button>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              ))}

              {/* Typing indicator */}
              {isLoading && <TypingIndicator />}
            </div>
          </ScrollArea>

          {/* Input */}
          <div className="p-4 border-t border-border">
            <form onSubmit={handleSubmit} className="flex gap-2 max-w-3xl mx-auto">
              <Input
                ref={inputRef}
                placeholder="Escribe tu pregunta..."
                disabled={isLoading}
                className="flex-1"
              />
              <Button type="submit" disabled={isLoading}>
                {isLoading ? (
                  <Loader2 className="w-4 h-4 animate-spin" />
                ) : (
                  <Send className="w-4 h-4" />
                )}
              </Button>
            </form>
            <p className="text-xs text-muted-foreground text-center mt-2">
              Pregunta sobre metricas, agentes, alertas o reportes de coaching
            </p>
          </div>
        </Card>
      </div>
    </>
  )
}
</file>

<file path="src/pages/Dashboard.tsx">
import { Phone, TrendingUp, Target, Wifi, WifiOff, RefreshCw } from 'lucide-react'
import { Header } from '@/components/layout/Header'
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card'
import { Tabs, TabsList, TabsTrigger } from '@/components/ui/tabs'
import { Button } from '@/components/ui/button'
import { KPICard, MetricCard, AlertasActivas, ActividadReciente, TopPerformers } from '@/components/dashboard'
import { TrendChart } from '@/components/charts/TrendChart'
import { formatNumber, formatCurrency, formatPercentage } from '@/lib/utils'
import { useDashboard } from '@/hooks/useDashboard'
import type { AlertaAnomalia } from '@/types'

// Mock data como fallback
import { mockAlertas, mockLlamadas, mockAnalisis } from '@/data/mockData'

export function Dashboard() {
  const {
    metrics,
    alertas,
    llamadasRecientes,
    topPerformers,
    tendencias,
    loading,
    realtimeConnected,
    refresh
  } = useDashboard()

  // Usar datos reales o mock como fallback
  const displayMetrics = metrics || {
    total_llamadas: 2847,
    llamadas_hoy: 127,
    score_promedio: 72,
    cambio_score: 5,
    tasa_validacion: 0.52,
    cambio_validacion: -3,
    probabilidad_promedio: 54,
    cambio_probabilidad: 2,
    alertas_activas: 3,
    monto_comprometido: 1250000
  }

  const displayAlertas = alertas.length > 0 ? alertas.map(a => ({
    alerta_id: a.alerta_id,
    tipo: a.tipo,
    severidad: a.severidad,
    descripcion: a.descripcion,
    causa_probable: a.causa_probable || '',
    impacto_estimado: {
      llamadas_afectadas: (a.impacto_estimado as Record<string, number>)?.llamadas_afectadas || 0,
      perdida_oportunidades: (a.impacto_estimado as Record<string, number>)?.perdida_oportunidades || 0
    },
    accion_recomendada: {
      urgencia: ((a.accion_recomendada as Record<string, string>)?.urgencia || 'hoy') as 'inmediata' | 'hoy' | 'esta_semana',
      destinatario: (a.accion_recomendada as Record<string, string>)?.destinatario || '',
      accion: (a.accion_recomendada as Record<string, string>)?.accion || ''
    },
    agentes_relacionados: a.agentes_relacionados || [],
    estado: a.estado,
    notificacion_enviada: a.notificacion_enviada || false,
    created_at: a.created_at
  })) as AlertaAnomalia[] : mockAlertas

  const displayLlamadas = llamadasRecientes.length > 0 ? llamadasRecientes.map(l => ({
    llamada_id: l.registro_id,
    audio_url: l.audio_url,
    duracion_segundos: l.duracion_segundos || 0,
    timestamp_inicio: l.timestamp_inicio,
    timestamp_fin: l.timestamp_fin,
    agente_id: l.agente_id,
    agente_nombre: l.agente_nombre || 'Agente',
    cliente_id: l.cliente_ref,
    campana: l.campana || '',
    tipo_deuda: l.tipo_deuda || '',
    estado: l.estado as 'pendiente' | 'transcrito' | 'analizado' | 'error',
    created_at: l.created_at,
    updated_at: l.updated_at,
    analisis: l.analisis ? {
      analisis_id: l.analisis.analisis_id,
      llamada_id: l.registro_id,
      transcripcion_id: l.analisis.transcripcion_id,
      score_total: l.analisis.score_total,
      score_contacto_directo: l.analisis.score_contacto_directo || 0,
      score_compromiso_pago: l.analisis.score_compromiso_pago || 0,
      modulo_contacto_directo: l.analisis.modulo_contacto_directo as any,
      modulo_compromiso_pago: l.analisis.modulo_compromiso_pago as any,
      modulo_abandono: l.analisis.modulo_abandono as any,
      prediccion_cumplimiento: {
        probabilidad: l.analisis.probabilidad_cumplimiento,
        nivel: l.analisis.nivel_cumplimiento,
        factores_positivos: [],
        factores_negativos: [],
        razonamiento: ''
      },
      alertas: [],
      recomendaciones: [],
      created_at: l.analisis.created_at
    } : undefined
  })) : mockLlamadas.map(l => ({
    ...l,
    analisis: mockAnalisis[l.llamada_id]
  }))

  const displayTopPerformers = topPerformers.length > 0 ? topPerformers : [
    { agente_id: '1', nombre: 'Carlos Ramirez', score: 89, llamadas: 145, validacion: 78, trend: 'up' as const },
    { agente_id: '5', nombre: 'Luis Torres', score: 82, llamadas: 132, validacion: 71, trend: 'stable' as const },
    { agente_id: '4', nombre: 'Ana Martinez', score: 78, llamadas: 128, validacion: 65, trend: 'up' as const },
    { agente_id: '2', nombre: 'Maria Gonzalez', score: 72, llamadas: 156, validacion: 52, trend: 'down' as const },
    { agente_id: '3', nombre: 'Jose Perez', score: 58, llamadas: 98, validacion: 38, trend: 'down' as const }
  ]

  // Sparkline data
  const sparkline1 = [30, 40, 35, 50, 49, 60, 70]
  const sparkline2 = [50, 40, 60, 45, 70, 55, 80]
  const sparkline3 = [20, 30, 25, 40, 35, 45, 50]

  // Chart data
  const chartData = tendencias.length > 0 
    ? tendencias.map(t => ({
        name: t.fecha,
        value: t.score,
        value2: t.validacion
      }))
    : [
        { name: 'Lun', value: 68, value2: 48 },
        { name: 'Mar', value: 71, value2: 51 },
        { name: 'Mie', value: 75, value2: 55 },
        { name: 'Jue', value: 73, value2: 53 },
        { name: 'Vie', value: 72, value2: 52 },
        { name: 'Sab', value: 74, value2: 54 },
        { name: 'Hoy', value: 72, value2: 52 }
      ]

  return (
    <>
      <Header title="Dashboard" />
      
      <div className="p-6 space-y-6">
        {/* Page title with tabs and realtime status */}
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-4">
            <h1 className="text-2xl font-semibold">Dashboard</h1>
            {/* Realtime indicator */}
            <div className="flex items-center gap-2 text-xs">
              {realtimeConnected ? (
                <>
                  <Wifi className="h-3.5 w-3.5 text-emerald-500" />
                  <span className="text-muted-foreground">En vivo</span>
                </>
              ) : (
                <>
                  <WifiOff className="h-3.5 w-3.5 text-muted-foreground" />
                  <span className="text-muted-foreground">Offline</span>
                </>
              )}
            </div>
          </div>
          <div className="flex items-center gap-4">
            <Button 
              variant="ghost" 
              size="sm" 
              onClick={refresh}
              disabled={loading}
              className="gap-2"
            >
              <RefreshCw className={`h-4 w-4 ${loading ? 'animate-spin' : ''}`} />
              Actualizar
            </Button>
            <Tabs defaultValue="overview">
              <TabsList>
                <TabsTrigger value="overview">Overview</TabsTrigger>
                <TabsTrigger value="analytics">Analytics</TabsTrigger>
                <TabsTrigger value="reports">Reports</TabsTrigger>
                <TabsTrigger value="notifications">Notifications</TabsTrigger>
              </TabsList>
            </Tabs>
          </div>
        </div>

        {/* KPIs Row */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <KPICard
            title="Llamadas Hoy"
            value={formatNumber(displayMetrics.llamadas_hoy)}
            change={15.54}
            changeLabel="vs ayer"
            icon={Phone}
            sparklineData={sparkline1}
          />
          <KPICard
            title="Score Promedio"
            value={displayMetrics.score_promedio}
            change={displayMetrics.cambio_score}
            changeLabel="vs semana anterior"
            icon={TrendingUp}
            sparklineData={sparkline2}
          />
          <KPICard
            title="Tasa Validacion"
            value={formatPercentage(displayMetrics.tasa_validacion * 100)}
            change={displayMetrics.cambio_validacion}
            changeLabel="vs semana anterior"
            icon={Target}
            sparklineData={sparkline3}
          />
          <MetricCard
            title="Monto Comprometido"
            value={formatCurrency(displayMetrics.monto_comprometido)}
            change="+20.1% from last month"
            sparklineData={[40, 35, 50, 45, 60, 55, 70, 65, 80]}
          />
        </div>

        {/* Charts Row */}
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Main chart */}
          <Card className="lg:col-span-2">
            <CardHeader>
              <CardTitle>Tendencia Semanal</CardTitle>
              <CardDescription>Score promedio y tasa de validacion</CardDescription>
            </CardHeader>
            <CardContent>
              <TrendChart 
                data={chartData}
                dataKey="value"
                dataKey2="value2"
                color="primary"
                color2="coral"
                height={280}
                showGrid
                showAxis
              />
            </CardContent>
          </Card>

          {/* Side metrics */}
          <div className="space-y-4">
            <MetricCard
              title="Total Llamadas"
              value={formatNumber(displayMetrics.total_llamadas)}
              change={`+${displayMetrics.llamadas_hoy} hoy`}
              sparklineData={[20, 40, 35, 50, 49, 60, 70, 91, 80, 70, 90, 100]}
            />
            <AlertasActivas alertas={displayAlertas} maxItems={3} />
          </div>
        </div>

        {/* Bottom Row */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <ActividadReciente llamadas={displayLlamadas} />
          <TopPerformers performers={displayTopPerformers} />
        </div>
      </div>
    </>
  )
}
</file>

<file path="src/pages/Llamadas.tsx">
import { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import GestorLlamadas from '../components/llamadas/gestorLlamadas'; 

export default function Llamadas() {
  return (
    <div className="h-full w-full bg-gray-50 min-h-screen">
      
      {/* Encabezado Simple */}
      <div className="bg-white border-b border-gray-200 px-8 py-4 mb-6">
        <h1 className="text-2xl font-bold text-gray-800">Auditor√≠a de Llamadas</h1>
        <p className="text-sm text-gray-500">Sube grabaciones y revisa el an√°lisis de los Agentes IA</p>
      </div>

      {/* AQU√ç EST√Å LA MAGIA: Tu componente se renderiza aqu√≠ */}
      <div className="px-4">
        <GestorLlamadas />
      </div>

    </div>
  );
}
</file>

</files>
